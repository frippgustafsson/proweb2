<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for Windows (x86-64) 2016.2 (Build 736U)" ts="2017-01-30 10:59:46">
<Class name="EF.contextDataFrontend">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.contextDataFrontend.CLS/EV.6
;vc; Component: CLS.EF.contextDataFrontend
;vc;  Location: LargeDev
;vc; Date/Time: 16-Jan-17 15:41
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.contextDataFrontend.CLS/EV.6</td><td>CLS.EF.contextDataFrontend</td><td>LargeDev</td><td style='white-space: nowrap;'>16-Jan-17 15:41</td><td>FredG</td></tr></table>
]]></Description>
<Super>EF.contextData</Super>
<TimeChanged>64301,48236.923237</TimeChanged>
<TimeCreated>63755,56082.660879</TimeCreated>

<Property name="loggedInPersonID">
<Description>
if website is private, this will be set to the cod.objPerson.ID of that logged in person</Description>
<Type>%Integer</Type>
</Property>

<Property name="backendPersonID">
<Type>%Integer</Type>
</Property>

<Property name="prowebMode">
<Type>%String</Type>
<Parameter name="VALUELIST" value=",edit,preview"/>
</Property>

<Property name="isTestMode">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="eventWebsiteLanguage">
<Type>setup.eventWebsiteLanguage</Type>
</Property>

<Property name="attendeeCategoryID">
<Type>%Integer</Type>
</Property>

<Method name="createFromFrontendCSPSession">
<ClassMethod>1</ClassMethod>
<ReturnType>EF.contextDataFrontend</ReturnType>
<Implementation><![CDATA[
	#dim sessionID as %String = %session.SessionId
	
	set contextData = ..%New()

	set eventID = %request.Get("eventID")	
	if 'eventID {
		set eventID = ##class(shared.pageMethodsFrontend).getEventID()	
	}
	if 'eventID {
		throw ##class(shared.exceptions.generalException).%New("eventID is missing from %request, make sure it is included in the URL parameters.")	
	}
	set contextData.eventID = eventID
	set %session.Data("eventsforce","frontend","xEventID") = eventID
	
	Do contextData.setControllerID()
	
	set contextData.languageID = $G(%session.Data("eventsforce","frontend","xPrefLangID"))
	if contextData.languageID = "" {
		 set contextData.languageID=$G(%session.Data("eventsforce","frontend","xLangID"))
	} 
	if contextData.languageID = "" {
		 set contextData.languageID = ##class(shared.objLanguage).getDefaultLangIDForEvent(eventID)
	} 
	
	set contextData.sessionID = %session.SessionId
	set contextData.prowebMode = %session.Get("mode")
	
	do contextData.populatePersonDataFromSession()
	
	set eventDetails = ##class(setup.eventConfiguration).createForEventID(contextData.eventID)
	set objLanguage = ##class(shared.objLanguage).%OpenId(contextData.languageID)
	set contextData.eventWebsiteLanguage = ##class(setup.eventWebsiteLanguage).createNew(eventDetails, objLanguage)
	
	return contextData
]]></Implementation>
</Method>

<Method name="populatePersonDataFromSession">
<Implementation><![CDATA[
	set ..backendPersonID = $Get(%session.Data("eventsforce","backend","xPersonID"))
	do ..populateLoggedInPersonID()
	do ..setAuditPersonIDfromBackend()
	if '..auditPersonID {
		do ..setAuditPersonIDfromFrontend()
	}
	do ..populateAttendeeCategoryID()
]]></Implementation>
</Method>

<Method name="populateLoggedInPersonID">
<Implementation><![CDATA[	set ..loggedInPersonID = ##class(EF.security.websiteAccessHandler).getAuthenticatedWebsitePersonID(..eventID)
]]></Implementation>
</Method>

<Method name="populateAttendeeCategoryID">
<Implementation><![CDATA[
	if ..loggedInPersonID {
		// this will be used to restrict the categories of sessions in the daily agenda before registration
		set ..attendeeCategoryID = ##class(links.lnkPersonEventCategory).getPreSelectedAttendeeCategoryID(..eventID, ..loggedInPersonID)
	}
]]></Implementation>
</Method>

<Method name="isMockSession">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ..sessionID = "mockSession"
]]></Implementation>
</Method>

<Method name="setAuditPersonIDfromFrontend">
</Method>
</Class>


<Class name="EF.contextDataRegistration">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.contextDataRegistration.CLS/EV.10
;vc; Component: CLS.EF.contextDataRegistration
;vc;  Location: LargeDev
;vc; Date/Time: 26-Jan-17 14:07
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.contextDataRegistration.CLS/EV.10</td><td>CLS.EF.contextDataRegistration</td><td>LargeDev</td><td style='white-space: nowrap;'>26-Jan-17 14:07</td><td>FredG</td></tr></table>
]]></Description>
<Super>EF.contextDataFrontend</Super>
<TimeChanged>64309,52160.588667</TimeChanged>
<TimeCreated>63755,56082.660879</TimeCreated>

<Property name="tempPurchaseID">
<Type>%Integer</Type>
</Property>

<Property name="isAmendment">
<Type>%Boolean</Type>
<InitialExpression>"0"</InitialExpression>
</Property>

<Property name="currencyID">
<Type>%Integer</Type>
</Property>

<Property name="tempPersonID">
<Type>%Integer</Type>
</Property>

<Property name="tempBookerID">
<Description>
only used in group bookings</Description>
<Type>%Integer</Type>
</Property>

<Property name="loggedInPersonID">
<Description>
if website is private, this will be set to the cod.objPerson.ID of that logged in person</Description>
<Type>%Integer</Type>
</Property>

<Property name="isBackendBooking">
<Type>%Boolean</Type>
<InitialExpression>"0"</InitialExpression>
</Property>

<Property name="pricingHorologUTC">
<Type>%Integer</Type>
</Property>

<Property name="context">
<Type>%String</Type>
<InitialExpression>"registration"</InitialExpression>
</Property>

<Property name="backendPersonID">
<Type>%Integer</Type>
</Property>

<Property name="isBackendSuperUser">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Method name="createFromFrontendCSPSession">
<ClassMethod>1</ClassMethod>
<ReturnType>EF.contextDataRegistration</ReturnType>
<Implementation><![CDATA[
	#dim contextData as EF.contextDataRegistration
	
	set contextData = ##super()
	do contextData.populateTempPurchaseDataFromSession()
		
	return contextData
]]></Implementation>
</Method>

<Method name="populatePersonDataFromSession">
<Implementation><![CDATA[
	set ..tempPersonID=$Get(%session.Data("eventsforce","frontend","currentPersonID"))
	set ..tempBookerID = ##class(eCom.tempPerson).getBookerIDfromTempPurchaseID(..tempPurchaseID)
	set ..isBackendSuperUser=##class(eCom.tempPurchase).isBackendSuperUser(..sessionID)
	do ##super()
]]></Implementation>
</Method>

<Method name="populateTempPurchaseDataFromSession">
<Implementation><![CDATA[
	set ..isAmendment = +$Get(%session.Data("eventsforce","frontend","amend"))
	set ..currencyID = +##class(eCom.tempPurchase).getCurrencyID(..sessionID)
	set ..tempPurchaseID = ##class(eCom.tempPurchase).getTempPurchaseFromSessionID(..sessionID)
	
	set ..isBackendBooking = ##class(eCom.tempPurchase).isBackendBooking(..sessionID)
	set ..pricingHorologUTC = ##class(eCom.tempPurchase).getPriceHorologUTC(..tempPurchaseID)
]]></Implementation>
</Method>

<Method name="populateLoggedInPersonID">
<Implementation><![CDATA[	set ..loggedInPersonID = ##class(EF.security.websiteAccessHandler).getCurrentRegistrationPersonID(..eventID)
]]></Implementation>
</Method>

<Method name="populateAttendeeCategoryID">
<Implementation><![CDATA[
	set ..attendeeCategoryID=##class(eCom.tempPurchase).getEventCategory(..sessionID,..tempPersonID)
	if ..attendeeCategoryID="" {
		if ..loggedInPersonID {
			// this will be used to restrict the categories of sessions in the daily agenda before registration
			set ..attendeeCategoryID=##class(links.lnkPersonEventCategory).getPreSelectedAttendeeCategoryID(..eventID,..loggedInPersonID)
		} else {
			set ..attendeeCategoryID = ##class(setup.lnkCategoryEvent).getDefault(..eventID)	
		}
	}
]]></Implementation>
</Method>

<Method name="createFromTempPersonID">
<ClassMethod>1</ClassMethod>
<FormalSpec>tempPersonID,langID,isAmendment:%Boolean</FormalSpec>
<ReturnType>EF.contextDataRegistration</ReturnType>
<Implementation><![CDATA[
	
	set contextData = ..%New()
	set tempPerson=##class(eCom.tempPerson).%OpenId(tempPersonID)
	do tempPerson.%Reload()
	
	set contextData.tempPurchaseID=tempPerson.tempPurchase.%Id()
	
	set controllerID=tempPerson.tempPurchase.objController.%Id()
	set contextData.eventID=##class(eCom.objController).getEventID(controllerID)
	set contextData.languageID=langID
	set contextData.tempPersonID=tempPerson.%Id()
	set contextData.sessionID=tempPerson.tempPurchase.sessionID
	set contextData.loggedInPersonID=""
	
	set contextData.attendeeCategoryID=##class(eCom.tempPurchase).getEventCategory(contextData.sessionID,contextData.tempPersonID)
	if contextData.attendeeCategoryID="" {
		if contextData.loggedInPersonID {
			// this will be used to restrict the categories of sessions in the daily agenda before registration
			set contextData.attendeeCategoryID=##class(links.lnkPersonEventCategory).getPreSelectedAttendeeCategoryID(contextData.eventID,contextData.loggedInPersonID)
		} else {
			set contextData.attendeeCategoryID = ##class(setup.lnkCategoryEvent).getDefault(contextData.eventID)	
		}
	}
	set contextData.currencyID=+##class(eCom.tempPurchase).getCurrencyID(contextData.sessionID)
	set contextData.isAmendment=isAmendment
	
	set contextData.isBackendBooking=##class(eCom.tempPurchase).isBackendBooking(contextData.sessionID)
	set contextData.pricingHorologUTC=##class(eCom.tempPurchase).getPriceHorologUTC(contextData.tempPurchaseID)	
	set contextData.prowebMode=""
	
	do contextData.setAuditPersonIDfromFrontend()
	if contextData.auditPersonID = "" {
		do contextData.setAuditPersonIDfromBackend()	
	}
	kill tempPerson
	return contextData
]]></Implementation>
</Method>

<Method name="createMock">
<ClassMethod>1</ClassMethod>
<ReturnType>EF.contextDataRegistration</ReturnType>
<Implementation><![CDATA[
	#dim mockpersonID as %Integer = 1
	#dim mockEventID as %Integer = 1
	
	set contextData = ..%New()
	
	set contextData.eventID=1
	set contextData.languageID=1
	set contextData.tempPersonID=mockpersonID
	set contextData.loggedInPersonID=mockpersonID
	set contextData.attendeeCategoryID=1
	set contextData.currencyID=1
	set contextData.isAmendment=0
	set contextData.tempPurchaseID=1
	set contextData.isBackendBooking=0
	set contextData.pricingHorologUTC=##class(shared.timeFunctions).getCurrentHorologUTC()
	set contextData.prowebMode="preview"
	set contextData.sessionID="mockSession"
	
	set eventDetails = ##class(setup.eventConfiguration).createForEventID(mockEventID)
	set objLanguage = ##class(shared.objLanguage).%OpenId($$$efEnglishLangID)
	set contextData.eventWebsiteLanguage = ##class(setup.eventWebsiteLanguage).createNew(eventDetails, objLanguage)
	 

	return contextData
]]></Implementation>
</Method>

<Method name="isMockSession">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ..sessionID = "mockSession"
]]></Implementation>
</Method>
</Class>


<Class name="EF.contextDataRegistrationMock">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.contextDataRegistration.CLS/EV.4
;vc; Component: CLS.EF.contextDataRegistration
;vc;  Location: SmallDev
;vc; Date/Time: 02-Sep-16 14:23
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.contextDataRegistration.CLS/EV.4</td><td>CLS.EF.contextDataRegistration</td><td>SmallDev</td><td style='white-space: nowrap;'>02-Sep-16 14:23</td><td>JeremyW</td></tr></table>
]]></Description>
<Super>EF.contextDataRegistration</Super>
<TimeChanged>64310,34518.885761</TimeChanged>
<TimeCreated>63755,56082.660879</TimeCreated>

<Property name="isTestMode">
<Type>%Boolean</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="listOfProwebItemsToAdd">
<Type>sc.facade.prowebItem</Type>
<Collection>list</Collection>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<ReturnType>EF.contextDataRegistration</ReturnType>
<Implementation><![CDATA[
	#dim mockTempPersonID as %Integer = 100
	#dim mockBackendUserD as %Integer = 1
	#dim mockEventID as %Integer = 15235
	#dim mockPageID as %Integer = 122589
	
	set contextData = ..%New()
	
	set contextData.componentName = "Main List"
	set contextData.eventID = mockEventID
	set contextData.pageID = mockPageID
	set contextData.languageID=1
	set contextData.tempPersonID = mockTempPersonID
	set contextData.loggedInPersonID = mockBackendUserD
	set contextData.attendeeCategoryID=1
	set contextData.currencyID=1
	set contextData.isAmendment=0
	set contextData.tempPurchaseID=1
	set contextData.isBackendBooking=0
	set contextData.pricingHorologUTC=##class(shared.timeFunctions).getCurrentHorologUTC()
	set contextData.prowebMode="preview"
	set contextData.sessionID="mockSession"
	
	return contextData
]]></Implementation>
</Method>
</Class>


<Class name="EF.mvcHandler.frontend">
<Super>EF.mvcHandler.page</Super>
<TimeChanged>64302,55011.409988</TimeChanged>
<TimeCreated>64292,52936.290297</TimeCreated>

<Method name="outputTemplateSectionHTML">
<FormalSpec>startTag:%String,endTag:%String</FormalSpec>
</Method>
</Class>


<Class name="EF.mvcHandler.frontendProweb">
<Super>EF.mvcHandler.frontend</Super>
<TimeChanged>64308,50295.732611</TimeChanged>
<TimeCreated>64292,52952.708564</TimeCreated>

<Property name="showRegistrationProgressBar">
<InitialExpression>0</InitialExpression>
</Property>

<Property name="isEditMode">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="isTestMode">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="eventWebsiteLanguage">
<Type>setup.eventWebsiteLanguage</Type>
</Property>

<Property name="pageID">
<Type>%Integer</Type>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<ReturnType>EF.pages.base</ReturnType>
<Implementation><![CDATA[
	set page = ..%New()
	
	do page.updatePageID()
	do page.updateEditFlag()
	do page.updateLanguageID()
	
	return page
]]></Implementation>
</Method>

<Method name="loadData">
<Implementation><![CDATA[
	#dim pageController as EF.pageController.proweb.page
	
	if '$IsObject(..contextData) {
			throw ##class(shared.exceptions.generalException).%New("No contextData found in page")
	}
	
	set pageControllerID = ..contextData.request.Get("prowebPageControllerID") 
	merge requestData = ..contextData.request.Data

	if pageControllerID { // when reloading the page after an validation error
		set pageController = ##class(EF.pageController.page).open(pageControllerID, ..contextData)

	} else { // regular loading of a page
		set pageController = ##class(EF.pageController.proweb.page).%New()
		set pageController.contextData = ..contextData
		set pageController.sessionID = ..contextData.sessionID
		set pageController.pageID = ..pageID
		set pageController.page = pageController
		if $Data(%session.Data("eventsforce","backend")) {
			set pageController.securityHandler = ##class(EF.mvcHandler.securityHandlers.frontendProwebWithBackend).createNew(..contextData)
		} else {
			set pageController.securityHandler = ##class(EF.mvcHandler.securityHandlers.frontendProweb).createNew(..contextData)
		}

		set objEvent = ##class(setup.objEvent).%OpenId(..contextData.eventID)
		set pageController.objEvent = objEvent
		
		do pageController.load($this) // this is the main loading point of all data for the page
		set sc = pageController.%Save()
		if 'sc {
			throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
		}
	}
	set ..pageControllerID = pageController.%Id()
	set %session.Data("mvcHandler","pageControllerID") = ..pageControllerID // ####### This can be removed once we refactor objTemplate.writeBit ##############
	set ..controller = pageController
	return pageController
]]></Implementation>
</Method>

<Method name="renderView">
<Implementation><![CDATA[
	if '$IsObject(..contextData) {
		throw ##class(shared.exceptions.generalException).%New("contextData is missing when attempting to render the view")	
	}
	if '$IsObject(..controller.contextData) {
		throw ##class(shared.exceptions.generalException).%New("controller.contextData is missing when attempting to render the view")	
	}
	
	do ..OnPagePageTop()
	do ..outputPageControllerTag()
	do $ClassMethod(..pageClass, "OnPagePageContent") 
	do ..outputEndOfPageJS()
	do ..OnPagePageBottom()
	do ..onEditing()
]]></Implementation>
</Method>

<Method name="onEditing">
<Implementation><![CDATA[
	if ..isEditMode {
		do ##class(eCom.tempPurchase).clearBackendBooking()
		set floatingMenu = ##class(EF.ui.components.frontend.floatingMenu).%New()
		do floatingMenu.outputFloatingMenuHTML()	
	}
]]></Implementation>
</Method>

<Method name="OnPagePageTop">
<Implementation><![CDATA[
	write ##class(shared.pageMethods).outputFrontendHeader()
	Write !,"<head>"
 	
 	do ##class(layout.objTemplate).writeBit("","{{ef_header}}")
	do ##class(cspRealEV.frontend.reg.frontendhttpheader).OnPageCSPROOT() //Do ..Include("frontendHTTPheader.csp")
	do ##class(cspRealEV.frontend.reg.colourscheme).OnPageCSPROOT() //Do ..Include("colourScheme.csp")
	do ..renderCommonJavascript()
	do ..outputMetaTags()
	Write !,"</head>"
	Write !,"<body class=""ef-background-color"">"
	
	if ..isEditMode {
		do ##class(EF.ui.components.frontend.editorControlPanel).outputEditorControlPanel($this)	
	}	
 	
 	do ##class(layout.objTemplate).writeBit("{{ef_header}}","{{ef_banner}}")
 	do ##class(layout.objTemplate).writeBit("{{ef_banner}}","{{ef_main_progress}}")
 	
 	if ..showRegistrationProgressBar {
		Do ..outputProgressBar()
 	}
 	
 	do ##class(layout.objTemplate).writeBit("{{ef_main_progress}}","{{ef_main_header}}")
 	do ..outputPageHeader()
 	do ##class(layout.objTemplate).writeBit("{{ef_main_header}}", "{{ef_main_content}}")
]]></Implementation>
</Method>

<Method name="outputPageHeader">
<Private>1</Private>
<Implementation><![CDATA[
	set efRulesTempParams("prowebcomponentname") = ..getDefaultPageHeader()
 	set efRulesTempParams("componenttype") = "text"
	do ..controller.renderHTMLControlFromTag(.efRulesTempParams)
]]></Implementation>
</Method>

<Method name="getDefaultPageHeader">
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set langID = ##class(sc.xModules.objPage).getLanguageIDFromPageID(..pageID)
	return ##class(translations.objPhraseWebsite).translatePhrase("Header", langID)
]]></Implementation>
</Method>

<Method name="renderCommonJavascript">
<Implementation><![CDATA[
	if ..isEditMode  {
		&html<
			<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
			<script type="text/javascript" src="../../media/javascript/distribution/ef-website-admin.min.js"></script>
		>
	}
]]></Implementation>
</Method>

<Method name="outputMetaTags">
<Implementation><![CDATA[
	 &html<
	 	<meta name="efIsProweb2" content="1">
	 	<meta name="efProwebConfirmDeleteURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/deleteListItem.csp?zz=1")))#">
	    <meta name="efProwebEditBaseURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/editItem.csp")))#">
	    <meta name="efProwebAddQuestionBaseURL" content="#(..encodeForHTMLAttribute(..Link(..getInitialURL("../../backend/proweb/codQuestionDetails.csp"))))#">
	    <meta name="efProwebAddRegPromptCollectionBelowLink" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/regPromptCollectionDetails.csp")))#">
	    <meta name="efProwebAddDividerBaseURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/formDivider.csp")))#">
	    <meta name="efProwebAddTextBlockBaseURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/textDetailsMoxie.csp")))#">
	    <meta name="efProwebAddFileUploadBaseURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/fileUploadDetails.csp")))#">
	    <meta name="efProwebAddYouTubeVideoBaseURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/flashDetails.csp")))#">
	    <meta name="efProwebUpdateLabelTextURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/updateLabelText.csp")))#">
	    <meta name="efProwebQuickEditURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/quickEditAJAX.csp")))#">
	    <meta name="efProwebGetAlternativesURL" content="#(..encodeForHTMLAttribute(..Link("../../frontend/reg/getCoditemAlternativesJSON.csp")))#">
	    
	>
]]></Implementation>
</Method>

<Method name="outputProgressBar">
<Implementation><![CDATA[
	set progressBar = ##class(EF.ui.components.frontend.progressBar).%New("ef-progress-bar")
	do progressBar.render()
]]></Implementation>
</Method>

<Method name="outputEndOfPageJS">
<Implementation><![CDATA[
	write !,"<script language=""javascript"">"
	do ##class(EF.pageController.javascriptMethods).renderEfGetElement(..controller)
	write !,"</script>"
	do ##class(EF.pageController.javascriptMethods).renderJSForElements(..controller)
	do ##class(EF.pageController.javascriptMethods).outputGetElement(..controller)
]]></Implementation>
</Method>

<Method name="OnPagePageBottom">
<Implementation><![CDATA[
	do ##class(layout.objTemplate).writeBit("{{ef_main_buttons}}","{{ef_footer}}")
	do ##class(layout.objTemplate).writeBit("{{ef_footer}}","")
	
	Write !,!,"</body>"
	Write !,"</html>",!
]]></Implementation>
</Method>

<Method name="getInitialURL">
<FormalSpec>targetPage:%String</FormalSpec>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim URL as %String
	 
	set URL = "../../backend/proweb/"_targetPage
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"dataID","NEW")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"orgDataID","ADD")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"displayOrder",0)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"addToTop","true")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"isCOD",1)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"pageID", ..pageID)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"itemNameID","NEW")
	
	return URL
]]></Implementation>
</Method>

<Method name="performSecurityChecks">
<Implementation><![CDATA[
	do ..controller.securityHandler.validateUrlParameters()
	// add stuff about user roles here
	
	set ..isOkToRenderPage = ..controller.securityHandler.isOkToRenderPage
	if '..isOkToRenderPage {
		set ..reasonForRedirect = ..controller.securityHandler.reasonForRedirect	
		set ..redirectPage = ..controller.securityHandler.redirectPage	
	}
]]></Implementation>
</Method>

<Method name="updatePageID">
<Implementation><![CDATA[
	#define getFromRequestFirst 1
	set ..pageID = ##class(shared.pageMethods).getPageID($$$getFromRequestFirst)
	set %session.Data("pageID") = ..pageID
]]></Implementation>
</Method>

<Method name="updateLanguageID">
<Implementation><![CDATA[
	if ..pageID {
		set languageIDFromPage = ##class(sc.xModules.objPage).getLanguageIDFromPageID(..pageID)
		if languageIDFromPage {
			set %session.Data("eventsforce","frontend","xLangID") = languageIDFromPage
			set %session.Data("eventsforce","frontend","xPrefLangID") = languageIDFromPage
		}
	}
]]></Implementation>
</Method>

<Method name="updateEventID">
<Implementation><![CDATA[
	if ..contextData.eventID = "" {
		set ..contextData.eventID = ##class(sc.xModules.objPage).getEventID(..pageID)
		Do ..contextData.setControllerID()	
	}
]]></Implementation>
</Method>

<Method name="updateEditFlag">
<Implementation><![CDATA[
	#dim isEditMode as %Boolean = 0
	
	set requestValue = $ZConvert( %request.Get("mode"), "L")
	set sessionValue = $ZConvert( $Get(%session.Data("mode")), "L")
	
	if (sessionValue = "edit") && (requestValue '= "preview") {
		set isEditMode = 1	
	}
	
	if (requestValue = "edit") {
		set isEditMode = 1	
	}
	
	set ..isEditMode = isEditMode
]]></Implementation>
</Method>
</Class>


<Class name="EF.mvcHandler.frontendProwebRegistration">
<Super>EF.mvcHandler.frontendProweb</Super>
<TimeChanged>64308,51692.465976</TimeChanged>
<TimeCreated>64293,33205.393133</TimeCreated>

<Property name="efFormID">
<Type>%String</Type>
<InitialExpression>"EFFrontendForm"</InitialExpression>
</Property>

<Property name="efFormName">
<Type>%String</Type>
<InitialExpression>"myForm"</InitialExpression>
</Property>

<Property name="efFormAction">
<Type>%String</Type>
<InitialExpression>"pageControllerStandardSave.csp"</InitialExpression>
</Property>

<Method name="renderView">
<Implementation><![CDATA[
	do ..OnPagePageTop()
	do ..outputFormBeginning()
	do ..outputPageControllerTag()
	do $ClassMethod(..pageClass, "OnPagePageContent") 
	do ..outputEndOfPageJS()
	do ..OnPagePageBottom()
	do ..outputFormEnding()
	do ..onEditing()
]]></Implementation>
</Method>

<Method name="outputFormBeginning">
<Implementation><![CDATA[
	&html<
		<form id="#(..efFormID)#" name="#(..efFormName)#" method="POST" action="#(..Link(..efFormAction))#" class="form-inline ef-form" autocomplete="on">
			<input type="hidden" name="pageID" value="#(..pageID)#">
			<input type="hidden" name="eventID" value="#(..contextData.eventID)#">
			<input type="hidden" id="efSubmitButtonIdentifier" name="efSubmitButtonIdentifier" value="">
			<input type="hidden" id="efSaveAndReloadFormOnly" name="efSaveAndReloadFormOnly" value="">
			<input type="hidden" id="efPageNavProceedKey" name="pageNavProceedKey" value="#(..pageNavProceedKey)#">
	>
]]></Implementation>
</Method>

<Method name="outputFormEnding">
<Implementation><![CDATA[	write !,"</form>"
]]></Implementation>
</Method>

<Method name="getDefaultPageHeader">
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set langID = ##class(sc.xModules.objPage).getLanguageIDFromPageID(..pageID)
	return ##class(translations.objPhraseWebsite).translatePhrase("Registration", langID)
]]></Implementation>
</Method>

<Method name="OnPagePageBottom">
<Implementation><![CDATA[
	&html< 
		<div class="row">
			<div class="col-sm-6 ef-button-container-left">
	 >
	set buttonText = ##class(translations.objPhraseWebsite).translatePhrase("Back", ..contextData.languageID)
	set cancelButton = ##class(EF.ui.components.frontend.buttonLink).createNew( buttonText, ..getBackButtonURL() )
	do cancelButton.render()
	
	&html< 
		</div>
		<div class="col-sm-6 ef-button-container-right">
	>
	set buttonText = ##class(translations.objPhraseWebsite).translatePhrase("Proceed", ..contextData.languageID)
	set proceedButton = ##class(EF.ui.components.frontend.buttonSubmit).createNew(buttonText, "")
	do proceedButton.render()
	&html< </div></div> >
	
	do ##super()
]]></Implementation>
</Method>

<Method name="getBackButtonURL">
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set backforward = ##class(setup.objPageNav).goWhere(..pageID, , ..contextData.tempPersonID)
	set URL = $Piece(backforward,"|",1)  // go back
	return URL
]]></Implementation>
</Method>
</Class>


<Class name="EF.mvcHandler.page">
<Super>%RegisteredObject,EF.htmlGenerator</Super>
<TimeChanged>64302,50095.204665</TimeChanged>
<TimeCreated>64293,52286.415864</TimeCreated>

<Property name="pageClass">
<Type>%String</Type>
</Property>

<Property name="contextData">
<Type>EF.contextData</Type>
</Property>

<Property name="controller">
<Type>EF.pageController.page</Type>
</Property>

<Property name="pageControllerID">
<Type>%Integer</Type>
</Property>

<Property name="pageNavProceedKey">
<Type>%String</Type>
</Property>

<Property name="isOkToRenderPage">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="redirectPage">
<Type>%String</Type>
</Property>

<Property name="reasonForRedirect">
<Type>%String</Type>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<ReturnType>EF.pages.base</ReturnType>
<Implementation><![CDATA[	return ..%New()
]]></Implementation>
</Method>

<Method name="loadData">
<Implementation><![CDATA[	// overridden in sub classes
]]></Implementation>
</Method>

<Method name="outputPageControllerTag">
<Implementation><![CDATA[
	&html<
		<input type="hidden" name="prowebPageControllerID" value="#(..pageControllerID)#">
	>
]]></Implementation>
</Method>

<Method name="updatePageID">
<Implementation><![CDATA[	// Overridden in sub-classes
]]></Implementation>
</Method>

<Method name="updateLanguageID">
<Implementation><![CDATA[	// Overridden in sub-classes
]]></Implementation>
</Method>

<Method name="updateEventID">
<Implementation><![CDATA[	// Overridden in sub-classes
]]></Implementation>
</Method>

<Method name="Link">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[link:%String,&query:%String,addQ:%Boolean=0]]></FormalSpec>
<ReturnType>%String</ReturnType>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[	return ##class(%CSP.Page).Link(link, .query, addQ)
]]></Implementation>
</Method>
</Class>


<Class name="EF.mvcHandler.securityHandlers.base">
<Super>%RegisteredObject</Super>
<TimeChanged>64302,59106.618997</TimeChanged>
<TimeCreated>64302,56184.665265</TimeCreated>

<Property name="isOkToRenderPage">
<Type>%Boolean</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="redirectPage">
<Type>%String</Type>
<InitialExpression>"errorLoadingPage.csp"</InitialExpression>
</Property>

<Property name="reasonForRedirect">
<Type>%String</Type>
</Property>

<Property name="contextData">
<Type>EF.contextData</Type>
</Property>
</Class>


<Class name="EF.mvcHandler.securityHandlers.frontendProweb">
<Super>EF.mvcHandler.securityHandlers.base</Super>
<TimeChanged>64302,59291.870316</TimeChanged>
<TimeCreated>64302,56720.653792</TimeCreated>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>contextData:EF.contextData</FormalSpec>
<ReturnType>EF.mvcHandler.securityHandlers.frontendProweb</ReturnType>
<Implementation><![CDATA[
	set securityHandler = ..%New()
	set securityHandler.contextData = contextData
	set securityHandler.isOkToRenderPage = 1
	return securityHandler
]]></Implementation>
</Method>

<Method name="validateUrlParameters">
<Implementation><![CDATA[
	do ..verifyThatEventIdFromUrlMatchesEventIdInSession()		
	if ..isOkToRenderPage=0 quit

	do ..verifyThatPageIdMatchesEventId()
]]></Implementation>
</Method>

<Method name="verifyThatEventIdFromUrlMatchesEventIdInSession">
<Private>1</Private>
<Implementation><![CDATA[
	set eventIdFromUrl = ##class(shared.pageMethods).requestGetEventID()
	set frontendEventIdFromSession = $Get(%session.Data("eventsforce","frontend","xEventID")) 

	if eventIdFromUrl '= frontendEventIdFromSession {
		set ..isOkToRenderPage = 0
		set ..reasonForRedirect = "EventID in the URL doesn't match the eventID in the frontend session"
	}
]]></Implementation>
</Method>

<Method name="verifyThatPageIdMatchesEventId">
<Private>1</Private>
<Implementation><![CDATA[
	set eventIdFromUrl = ##class(shared.pageMethods).requestGetEventID()
	set pageIdFromUrl = ..contextData.request.Get("pageID")
	
	set eventIdFromPageId = ##class(sc.xModules.objPage).getEventID(pageIdFromUrl)
	if eventIdFromUrl '= eventIdFromPageId {
		set ..isOkToRenderPage = 0
		set ..reasonForRedirect = "EventID in the URL doesn't match the eventID of the passed in pageID"
	}
]]></Implementation>
</Method>
</Class>


<Class name="EF.mvcHandler.securityHandlers.frontendProwebWithBackend">
<Super>EF.mvcHandler.securityHandlers.frontendProweb</Super>
<TimeChanged>64302,59300.588435</TimeChanged>
<TimeCreated>64302,56296.393809</TimeCreated>

<Method name="validateUrlParameters">
<Implementation><![CDATA[
	do ..verifyThatEventIdFromUrlMatchesEventIdInBackend()
	if ..isOkToRenderPage=0 quit
	
	do ##super()
]]></Implementation>
</Method>

<Method name="verifyThatEventIdFromUrlMatchesEventIdInBackend">
<Private>1</Private>
<Implementation><![CDATA[
	set eventIdFromUrl = ##class(shared.pageMethods).requestGetEventID()
	set backendEventIdFromSession = $Get(%session.Data("eventsforce","backend","xEventID")) 

	if eventIdFromUrl '= backendEventIdFromSession  {
		set ..isOkToRenderPage = 0
		set ..reasonForRedirect = "EventID in the URL doesn't match eventID in the backend session"
	}
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.containerElement">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.pageController.containerElement.CLS/EV.23
;vc; Component: CLS.EF.pageController.containerElement
;vc;  Location: LargeDev
;vc; Date/Time: 27-Jan-17 09:45
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.pageController.containerElement.CLS/EV.23</td><td>CLS.EF.pageController.containerElement</td><td>LargeDev</td><td style='white-space: nowrap;'>27-Jan-17 09:45</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.pageController.element</Super>
<TimeChanged>64310,51913.663283</TimeChanged>
<TimeCreated>63372,47273.826383</TimeCreated>

<Property name="getContentsMethod">
<Type>%String</Type>
<Transient>1</Transient>
</Property>

<Method name="setAJAXMethod">
<FormalSpec>method</FormalSpec>
<Implementation><![CDATA[
	set ..getContentsMethod=method
	do ..page.allAJAXPageElements.SetAt($this,$this.identifier)
]]></Implementation>
</Method>

<Method name="processGetElement">
<Implementation><![CDATA[	do $method($this.page,..getContentsMethod)
]]></Implementation>
</Method>

<Method name="updateErrorMessage">
<FormalSpec>errorMessage</FormalSpec>
</Method>

<Method name="geGetProcessedElements">
<Description>
This is a list of all the elements that are updated by the processGetContents method </Description>
<ReturnType>%ListOfObjects</ReturnType>
<Implementation><![CDATA[
	set processedElements=##class(%ListOfObjects).%New()
	do processedElements.Insert($this)
	quit processedElements
]]></Implementation>
</Method>

<Method name="addCheckbox">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.checkbox</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.checkbox).addElementToParent($this,identifier,description,value,isReadOnly)

	quit element
]]></Implementation>
</Method>

<Method name="addRadioButtons">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.radioButtons</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.radioButtons).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addRadioGroup">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.containerElements.radioGroup</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.radioGroup).addElementToParent($this,identifier,description)
	quit element
]]></Implementation>
</Method>

<Method name="addRadio">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0,htmlName="",isSelected=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.radio</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.radio).addElementToParent($this,identifier,description,value,isReadOnly)
	if $L(htmlName) set element.uiComponent.htmlName=htmlName
	set element.uiComponent.isSelected=+value
	quit element
]]></Implementation>
</Method>

<Method name="addNumericInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.integerInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.numericInput).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addIntegerInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.integerInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.integerInput).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addTextInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.textInput).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addTextInputRange">
<FormalSpec>identifier:%String,description:%String,value1="",value2="",isReadOnly=0,fromDescription="from",toDescription="to"</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element = ##class(EF.pageController.inputElements.textInputRange).addElementToParent($this, identifier, description, "", isReadOnly)
	set element.uiComponent.containerClasses = "row"
	set textInputElementFrom = ##class(EF.pageController.inputElements.textInput).addElementToParent(element, identifier_"-value1", description_" "_fromDescription_":", value1, isReadOnly)
	set textInputElementTo = ##class(EF.pageController.inputElements.textInput).addElementToParent(element, identifier_"-value2", description_" "_toDescription_":", value2, isReadOnly)
	set textInputElementFrom.uiComponent.containerClasses = textInputElementFrom.uiComponent.containerClasses_" col-sm-6"
	set textInputElementTo.uiComponent.containerClasses = textInputElementTo.uiComponent.containerClasses_" col-sm-6"
	set textInputElementFrom.uiComponent.classes = textInputElementFrom.uiComponent.classes_" ef-backend-input-element-short"
	set textInputElementTo.uiComponent.classes = textInputElementTo.uiComponent.classes_" ef-backend-input-element-short"

	quit element
]]></Implementation>
</Method>

<Method name="addEmailInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.email).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addPasswordInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.password).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addTextArea">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.textArea).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addTextInputWithDisabler">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInputWithDisabler</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.textInputWithDisabler).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addHiddenInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElement).addElementToParent($this,identifier,description,value,isReadOnly)
	set element.uiComponent=##class(EF.ui.components.hiddenInput).%New(identifier)	
	return element
]]></Implementation>
</Method>

<Method name="addDropdown">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.dropdown</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.dropdown).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addSearchableDropdown">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElement</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.searchableDropdown).addElementToParent($this,identifier,description,value,isReadOnly)
	set element.uiComponent=##class(EF.ui.components.backend.searchableDropdown).%New(identifier)
	
	return element
]]></Implementation>
</Method>

<Method name="addToggle">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.radioButtons</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.radioButtons).addElementToParent($this,identifier,description,value,isReadOnly)
	do element.addAlternative(0,"Off")
	do element.addAlternative(1,"On")
	quit element
]]></Implementation>
</Method>

<Method name="addDatePicker">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.datePicker).addElementToParent($this,identifier,description,value,isReadOnly)

	quit element
]]></Implementation>
</Method>

<Method name="addDateRange">
<FormalSpec>identifier:%String,description:%String,value1="",value2="",isReadOnly=0,fromDescription="from",toDescription="to"</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set fromLabel = description_" "_fromDescription
	set toLabel = description_" "_toDescription
	set element = ##class(EF.pageController.inputElements.dateRange).addElementToParent($this, identifier, description, "", isReadOnly)
	set element.uiComponent.validator.fromFieldName = """"_fromLabel_""""
	set element.uiComponent.validator.toFieldName = """"_toLabel_""""
	set element.uiComponent.containerClasses = "row"
	
	set dateElementFrom = ##class(EF.pageController.inputElements.datePicker).addElementToParent(element, identifier_"-value1", fromLabel_":", value1, isReadOnly)
	set dateElementFrom.uiComponent.validator.fieldName = """"_fromLabel_""""
	set dateElementTo = ##class(EF.pageController.inputElements.datePicker).addElementToParent(element, identifier_"-value2", toLabel_":", value2, isReadOnly)
	set dateElementTo.uiComponent.validator.fieldName = """"_toLabel_""""
	
	set dateElementFrom.uiComponent.containerClasses = dateElementFrom.uiComponent.containerClasses_" col-sm-6"
	set dateElementTo.uiComponent.containerClasses = dateElementTo.uiComponent.containerClasses_" col-sm-6"
	set dateElementFrom.uiComponent.classes = dateElementFrom.uiComponent.classes_" ef-backend-input-element-short"
	set dateElementTo.uiComponent.classes = dateElementTo.uiComponent.classes_" ef-backend-input-element-short"
	
	quit element
]]></Implementation>
</Method>

<Method name="addDateTimePicker">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.dateTimePicker).addElementToParent($this,identifier,description,value,isReadOnly)

	quit element
]]></Implementation>
</Method>

<Method name="addTimePicker">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.timePicker).addElementToParent($this,identifier,description,value,isReadOnly)

	quit element
]]></Implementation>
</Method>

<Method name="addTimeRange">
<FormalSpec>identifier:%String,description:%String,value1="",value2="",isReadOnly=0,fromDescription="from",toDescription="to"</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set fromLabel = description_" "_fromDescription
	set toLabel = description_" "_toDescription
	set element = ##class(EF.pageController.inputElements.timeRange).addElementToParent($this, identifier, description, "", isReadOnly)
	set element.uiComponent.containerClasses = "row"
	set element.uiComponent.validator.fromFieldName = """"_fromLabel_""""
	set element.uiComponent.validator.toFieldName = """"_toLabel_""""
	
	set timeElementFrom = ##class(EF.pageController.inputElements.timePicker).addElementToParent(element, identifier_"-value1", fromLabel_":", value1, isReadOnly)
	set timeElementFrom.uiComponent.validator.fieldName = """"_fromLabel_""""
	set timeElementTo = ##class(EF.pageController.inputElements.timePicker).addElementToParent(element, identifier_"-value2", toLabel_":", value2, isReadOnly)
	set timeElementTo.uiComponent.validator.fieldName = """"_toLabel_""""
	
	set timeElementFrom.uiComponent.containerClasses = timeElementFrom.uiComponent.containerClasses_" col-sm-6"
	set timeElementTo.uiComponent.containerClasses = timeElementTo.uiComponent.containerClasses_" col-sm-6"
	set timeElementFrom.uiComponent.classes = timeElementFrom.uiComponent.classes_" ef-backend-input-element-short"
	set timeElementTo.uiComponent.classes = timeElementTo.uiComponent.classes_" ef-backend-input-element-short"

	quit element
]]></Implementation>
</Method>

<Method name="addCheckboxGroup">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.checkboxGroup</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.checkboxGroup).addElementToParent($this,identifier,description)
	
	quit element
]]></Implementation>
</Method>

<Method name="addResponsiveTable">
<FormalSpec>identifier:%String,description:%String=""</FormalSpec>
<ReturnType>EF.pageController.containerElements.panel</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.responsiveTable).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addPanel">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.panel</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.panel).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addPanelChart">
<FormalSpec>identifier:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.panelChart</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.panelChart).addElementToParent($this,identifier,"")
	set element.uiComponent=##class(EF.ui.components.backend.chart.panelChart).%New(identifier)
				

	quit element
]]></Implementation>
</Method>

<Method name="addList">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.list</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.list).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addOpenModalAjaxButton">
<FormalSpec>identifier:%String,description:%String,targetURL:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.button</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.button).addElementToParent($this,identifier,description)
	set element.uiComponent=##class(EF.ui.components.backend.buttonOpenModalAjax).%New(identifier)
	set element.uiComponent.targetURL=targetURL
	set element.uiComponent.label=description
	
	return element
]]></Implementation>
</Method>

<Method name="addModal">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.modal</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.modal).addElementToParent($this,identifier,description)
	
	quit element
]]></Implementation>
</Method>

<Method name="addOpenModalButton">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.openModal</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.openModal).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addCloseModalButton">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.closeModal</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.closeModal).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addOpenInFormModalButton">
<Description>
Creates a button that opens a modal defined by baseUrl and contentClass.
When submitted, the page controller will be validated and updated, but it will not run the save method.</Description>
<FormalSpec><![CDATA[identifier:%String,description:%String,baseUrl:%String,contentClass,&modalRequestData]]></FormalSpec>
<ReturnType>EF.pageController.buttons.openInFormModal</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.openInFormModal).addElementToParent($this,identifier,description)
	do element.setModalContentDefinition(contentClass,baseUrl,.modalRequestData)

	return element
]]></Implementation>
</Method>

<Method name="addTranslateButton">
<Description>
Adds a translation button with warning icon which opens an in-form modal</Description>
<FormalSpec><![CDATA[identifier:%String,description:%String,baseUrl:%String,contentClass:%String,showWarning:%Boolean,title:%String,&modalRequestData]]></FormalSpec>
<ReturnType>EF.pageController.buttons.openInFormModal</ReturnType>
<Implementation><![CDATA[
	set element=..addOpenInFormModalButton(identifier,description,baseUrl,contentClass,.modalRequestData)
	set element.uiComponent.title=title
	do element.uiComponent.addClass("ef-translate-button")
	set warningIcon=##class(EF.ui.components.backend.warningIcon).%New(identifier_"-warning-icon")
	do element.uiComponent.addChild(warningIcon)
	if showWarning {
		do element.uiComponent.addClass("ef-translate-button-show-warning")
	}
	return element
]]></Implementation>
</Method>

<Method name="addModalHeader">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.text</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.textElements.modalHeader).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addButton">
<FormalSpec>identifier:%String,description:%String,contentType:%String="text",buttonType:%String="secondary"</FormalSpec>
<ReturnType>EF.pageController.buttons.button</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.button).addElementToParent($this,identifier,description)
	set element.uiComponent.contentType=contentType
	set element.uiComponent.buttonType=buttonType

	quit element
]]></Implementation>
</Method>

<Method name="addSubmitButton">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.submit</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.submit).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addSubmitModalButton">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.submit</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.submit).addElementToParent($this,identifier,description)
	set element.uiComponent=##class(EF.ui.components.backend.buttonSubmitModal).%New(identifier)
	set element.uiComponent.label=description

	quit element
]]></Implementation>
</Method>

<Method name="addDeleteButton">
<FormalSpec>identifier:%String,description:%String,deleteMethod,objectID,confirmationMessage</FormalSpec>
<ReturnType>EF.pageController.buttons.submit</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.delete).addElementToParent($this,identifier,description)
	set element.deleteMethod=deleteMethod
	set element.objectId=objectID
	set element.uiComponent.confirmationMessage=confirmationMessage

	quit element
]]></Implementation>
</Method>

<Method name="addLinkButton">
<FormalSpec>identifier:%String,description:%String,href:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.button</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.link).addElementToParent($this,identifier,description)
	set element.uiComponent.href=href

	quit element
]]></Implementation>
</Method>

<Method name="addText">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.text</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.text).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addTextAlertInfo">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.text</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.textElements.textAlertInfo).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addInputGroup">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.inputGroup</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.inputGroup).addElementToParent($this,identifier,description)
	
	quit element
]]></Implementation>
</Method>

<Method name="addInputGroupNumber">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.inputGroupNumber</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.inputGroupNumber).addElementToParent($this,identifier,description)
	
	quit element
]]></Implementation>
</Method>

<Method name="addGridRemote">
<FormalSpec>identifier:%String,description=""</FormalSpec>
<ReturnType>EF.pageController.containerElements.gridRemote</ReturnType>
<Implementation><![CDATA[	return ##class(EF.pageController.containerElements.gridRemote).addElementToParent($this,identifier,description)
]]></Implementation>
</Method>

<Method name="addDiv">
<FormalSpec>identifier:%String,description=""</FormalSpec>
<ReturnType>EF.pageController.containerElements.div</ReturnType>
<Implementation><![CDATA[	return ##class(EF.pageController.containerElements.div).addElementToParent($this,identifier,description)
]]></Implementation>
</Method>

<Method name="addSpan">
<FormalSpec>identifier:%String,description=""</FormalSpec>
<ReturnType>EF.pageController.containerElements.span</ReturnType>
<Implementation><![CDATA[	return ##class(EF.pageController.containerElements.span).addElementToParent($this,identifier,description)
]]></Implementation>
</Method>

<Method name="addMultiLingualInput">
<FormalSpec>identifier:%String,label:%String,translatablePhrase:translations.translatablePhrase,translationTitle:%String</FormalSpec>
<Implementation><![CDATA[	return ##class(EF.pageController.inputElements.multiLingualInput).addMultiLingualInput($this, identifier, label, translatablePhrase, translationTitle)
]]></Implementation>
</Method>

<Method name="addTranslatableTextInput">
<FormalSpec><![CDATA[identifier:%String,label:%String,translatablePhrase:translations.translatablePhrase,translationPageName,translationPageClass,&translationPageRequestData]]></FormalSpec>
<Implementation><![CDATA[
	#dim translation As translations.translation
	if translatablePhrase.hasTranslation() {
		set inputGroup=..addInputGroup(identifier_"-group",label)
		set translations=translatablePhrase.getTranslationsOrderedByLanguageName()
		set title=""
		set key=""
		set hasMissingTranslation=0
		for {
			set translation=translations.GetNext(.key)
			if key="" quit
			if title'="" {
				set title=title_$$$CRLF
			}
			set title=title_translation.languageName_": "_translation.translation
			if '$l(translation.translation) set hasMissingTranslation=1
		}
		set eventNameButton=inputGroup.addTextInput(identifier,"",translatablePhrase.getPhrase())
		set span=inputGroup.addSpan(identifier_"-translate-span")
		do span.uiComponent.addClass("input-group-btn")
		set translateButton=span.addTranslateButton(identifier_"-translate-button","Translate...",translationPageName,translationPageClass,hasMissingTranslation,title,.translationPageRequestData)	
		
	} else {
		set eventNameButton=..addTextInput(identifier,label,translatablePhrase.getPhrase())
	}
	return eventNameButton
]]></Implementation>
</Method>

<Method name="updateUIComponent">
<Implementation><![CDATA[
	
	set key=""
	for {
		set child=..elementChildren.GetNext(.key)
		if key="" quit
		do ..uiComponent.addChild(child.uiComponent)
		
 	}
 	do ##super()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>containerElementDefaultData</DefaultData>
<Data name="containerElementDefaultData">
<Subscript>"containerElement"</Subscript>
<Value name="1">
<Value>dynamicGetContentMethod</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.element">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.pageController.element.CLS/EV.13
;vc; Component: CLS.EF.pageController.element
;vc;  Location: LargeDev
;vc; Date/Time: 18-Jan-17 10:46
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.pageController.element.CLS/EV.13</td><td>CLS.EF.pageController.element</td><td>LargeDev</td><td style='white-space: nowrap;'>18-Jan-17 10:46</td><td>FredG</td></tr></table>
]]></Description>
<IncludeCode>EF.common.macros</IncludeCode>
<Super>%Library.Persistent,shared.timeStamp</Super>
<TimeChanged>64310,51919.737377</TimeChanged>
<TimeCreated>63350,63749.535929</TimeCreated>

<Property name="elementParent">
<Type>EF.pageController.element</Type>
</Property>

<Property name="elementChildren">
<Type>EF.pageController.element</Type>
<Collection>list</Collection>
</Property>

<Property name="page">
<Type>EF.pageController.page</Type>
</Property>

<Property name="identifier">
<Description>
The description of the property. Should be unique for each pageInstance</Description>
<Type>%String</Type>
<Required>1</Required>
<Parameter name="MAXLEN" value="250"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="description">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32767"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="isReadOnly">
<Type>%Boolean</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="uiComponent">
<Type>EF.ui.components.base</Type>
<Transient>1</Transient>
</Property>

<Property name="errorMessages">
<Type>%Library.String</Type>
<Collection>list</Collection>
<Parameter name="MAXLEN" value="32767"/>
</Property>

<Property name="objectId">
<Type>%String</Type>
</Property>

<Property name="enableDisableDependencyList">
<Type>EF.ui.components.dependencyList</Type>
<Transient>1</Transient>
</Property>

<Property name="showHideDependencyList">
<Type>EF.ui.components.dependencyList</Type>
<Transient>1</Transient>
</Property>

<Property name="isModalTempData">
<Description>
Anything marked with isModalTempData set will be cleared down when a modal is re-opened</Description>
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Index name="identifierIndex">
<Properties>identifier</Properties>
</Index>

<Method name="%OnNew">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<Private>1</Private>
<ReturnType>%Status</ReturnType>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
	If ($DATA(identifier)) {
		Set ..identifier=identifier
	}
	if $DATA(description) {
		set ..description=description
	}

	do ..createUIComponent()
	do ..initialiseUIComponent(..getDefaultUIComponent())
	
    Quit $$$OK
]]></Implementation>
</Method>

<Method name="delete">
<FormalSpec>removeFromParent=1</FormalSpec>
<Implementation><![CDATA[
	
	set key=""
	do {
    	set childElement=..elementChildren.GetNext(.key)
    	if ($IsObject(childElement)) {
        	do childElement.delete(0)
    	}
 	} While (key '= "")
 	set elementID=..%Id()
 	if (removeFromParent)&&($IsObject(..elementParent)) {
	 	do ..elementParent.%Reload()
		set childKey=..elementParent.elementChildren.FindObjectId(elementID,"")
		if childKey {
			do ..elementParent.elementChildren.RemoveAt(childKey)
			do ..elementParent.%Save()
		}	
 	}
    do ..%DeleteId(elementID)
    
 	quit
]]></Implementation>
</Method>

<Method name="addChild">
<FormalSpec>element:EF.pageController.element</FormalSpec>
<Implementation><![CDATA[
	if ..page.getElementByIdentifier(element.identifier) {
 		throw ##class(shared.exceptions.generalException).%New("Element identifier must be unique for page. Identifier="_element.identifier)
	}
	set element.page=..page
	if ..page.isPageReadOnly {
		set element.isReadOnly=1	
	}
	do ..elementChildren.Insert(element)
	set element.elementParent=$this
	do ..page.allPageElements.SetAt(element,element.identifier)
]]></Implementation>
</Method>

<Method name="updateAllPageElements">
<Implementation><![CDATA[
	do ..page.allPageElements.SetAt($this,..identifier)
	set key=""
	for {
		set child=..elementChildren.GetNext(.key)
		if key="" quit
		do child.updateAllPageElements()	
	}
]]></Implementation>
</Method>

<Method name="reloadUIComponent">
<Implementation><![CDATA[	do ..initialiseUIComponent(..getDefaultUIComponent())
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[	do ..uiComponent.render()
]]></Implementation>
</Method>

<Method name="renderStart">
<Implementation><![CDATA[	do ..uiComponent.renderStart()
]]></Implementation>
</Method>

<Method name="renderEnd">
<Implementation><![CDATA[	do ..uiComponent.renderEnd()
]]></Implementation>
</Method>

<Method name="initialiseUIComponent">
<FormalSpec>uiComponent:EF.ui.components.base</FormalSpec>
<Implementation><![CDATA[	set ..uiComponent=uiComponent
]]></Implementation>
</Method>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.base</ReturnType>
<Implementation><![CDATA[
	set htmlIdentifier="ef_control_"_..identifier
	quit ##class(EF.ui.components.base).%New(htmlIdentifier)
]]></Implementation>
</Method>

<Method name="addElementToParent">
<ClassMethod>1</ClassMethod>
<FormalSpec>parent:EF.pageController.element,identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.element</ReturnType>
<Implementation><![CDATA[
	if parent.page.isReload {
		set element=parent.page.getElementByIdentifier(identifier)
	} else {
		set element=..%New(identifier,description)
		do parent.addChild(element)
	}
	
	if $IsObject(parent.enableDisableDependencyList) {
		set element.enableDisableDependencyList=parent.enableDisableDependencyList	
	}	
	
	quit element
]]></Implementation>
</Method>

<Method name="getAuditDescription">
<Implementation><![CDATA[
	set auditDescription=..description
	if $IsObject(..elementParent) {
		set parentDescription=..elementParent.getAuditDescription()
		if $l(parentDescription) set auditDescription=parentDescription_" - "_auditDescription
	}
	quit auditDescription
]]></Implementation>
</Method>

<Method name="createUIComponent">
</Method>

<Method name="updateUIComponent">
<Implementation><![CDATA[
	if $IsObject(..enableDisableDependencyList) {
		set ..uiComponent.enableDisableDependencyList=..enableDisableDependencyList	
	}
	if $IsObject(..showHideDependencyList) {
		set ..uiComponent.showHideDependencyList=..showHideDependencyList	
	}
	if ..errorMessages.Count() {
		set ..uiComponent.hasError=1
	}
]]></Implementation>
</Method>

<Method name="validateElement">
<Implementation><![CDATA[
	do ..errorMessages.Clear()
	set key=""
	for {
		set elementChild=..elementChildren.GetNext(.key)
		if key="" quit
		do elementChild.validateElement() 
 	}
 	if ..isUpdated() {
	 	do ..validateValue()
 	}
]]></Implementation>
</Method>

<Method name="updateErrorMessages">
<Implementation><![CDATA[
	set key=""
	for {
		set elementChild=..elementChildren.GetNext(.key)
		if key="" quit
		do elementChild.updateErrorMessages()
 	}
 	if $IsObject(..elementParent) {
	 	if ..errorMessages.Count() {
		 	set key=""
		 	for {
			 	set errorMessage=..errorMessages.GetNext(.key)
			 	if key="" quit
			 	do ..elementParent.errorMessages.Insert(errorMessage)
		 	}
		}
 	}
]]></Implementation>
</Method>

<Method name="validateValue">
<Implementation><![CDATA[	quit
]]></Implementation>
</Method>

<Method name="isUpdated">
<Implementation><![CDATA[	quit 0
]]></Implementation>
</Method>

<Method name="updateValueFromRequest">
</Method>

<Method name="getEventID">
<Implementation><![CDATA[	quit ..page.objEvent.%Id()
]]></Implementation>
</Method>

<Method name="setErrorMessage">
<FormalSpec>errorMessage:%String</FormalSpec>
<Implementation><![CDATA[
	
	do ..errorMessages.Insert(..getDescriptionForError(errorMessage))
	set ..page.hasError=1
]]></Implementation>
</Method>

<Method name="getDescriptionForError">
<FormalSpec>errorMessage:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ..getBaseErrorMessage()_errorMessage_"."
]]></Implementation>
</Method>

<Method name="createContextData">
<ReturnType>EF.contextData</ReturnType>
<Implementation><![CDATA[
	set contextData = ##class(EF.contextData).%New()	
	set contextData.eventID=..getEventID()
	
	Do contextData.setControllerID()
	
	set contextData.languageID=$$$efEnglishLangID
	set contextData.auditPersonID=..xCRuserID
	
	set contextData.sessionID=..page.sessionID
	return contextData
]]></Implementation>
</Method>

<Method name="getRequestData">
<FormalSpec>name:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ..page.requestData.GetAt(name)
]]></Implementation>
</Method>

<Method name="clearAllPageControllerData">
<Description>
Should be run if any of the sub-classes are deleted</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	kill ^EF.pageController.elementD,^EF.pageController.elementI
]]></Implementation>
</Method>

<Method name="getBaseErrorMessage">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "The changes can't be saved because "
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^EF.pageController.elementD</DataLocation>
<DefaultData>elementDefaultData</DefaultData>
<IdLocation>^EF.pageController.elementD</IdLocation>
<IndexLocation>^EF.pageController.elementI</IndexLocation>
<StreamLocation>^EF.pageController.elementS</StreamLocation>
<ExtentSize>100000</ExtentSize>
<Data name="elementDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>elementParent</Value>
</Value>
<Value name="3">
<Value>elementChildren</Value>
</Value>
<Value name="4">
<Value>page</Value>
</Value>
<Value name="5">
<Value>identifier</Value>
</Value>
<Value name="6">
<Value>value</Value>
</Value>
<Value name="7">
<Value>description</Value>
</Value>
<Value name="8">
<Value>isReadOnly</Value>
</Value>
<Value name="9">
<Value>errorMessage</Value>
</Value>
<Value name="10">
<Value>errorDisplayElement</Value>
</Value>
<Value name="11">
<Value>xCRstamp</Value>
</Value>
<Value name="12">
<Value>xCRuserID</Value>
</Value>
<Value name="13">
<Value>xMOstamp</Value>
</Value>
<Value name="14">
<Value>xMOuserID</Value>
</Value>
<Value name="15">
<Value>objectID</Value>
</Value>
<Value name="16">
<Value>objectId</Value>
</Value>
<Value name="17">
<Value>dependsOnElement</Value>
</Value>
<Value name="18">
<Value>dependsOnValue</Value>
</Value>
<Value name="19">
<Value>showDependsOnElement</Value>
</Value>
<Value name="20">
<Value>showDependsOnValue</Value>
</Value>
<Value name="21">
<Value>errorMessages</Value>
</Value>
<Value name="22">
<Value>isModalTempData</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.buttonAddGuest">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.pageController.buttons.button.CLS/EV.1
;vc; Component: CLS.EF.pageController.buttons.button
;vc;  Location: LargeDev
;vc; Date/Time: 05-Feb-16 15:28
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.pageController.buttons.button.CLS/EV.1</td><td>CLS.EF.pageController.buttons.button</td><td>LargeDev</td><td style='white-space: nowrap;'>05-Feb-16 15:28</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.pageController.buttonElement,EF.pageController.proweb.prowebBase</Super>
<TimeChanged>64232,38855.957185</TimeChanged>
<TimeCreated>63404,34415.706614</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.backend.button</ReturnType>
<Implementation><![CDATA[	return ##class(EF.ui.components.frontend.buttonAddGuest).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>buttonAddGuestDefaultData</DefaultData>
<Data name="buttonAddGuestDefaultData">
<Subscript>"buttonAddGuest"</Subscript>
<Value name="1">
<Value>prowebItem</Value>
</Value>
<Value name="2">
<Value>prowebID</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.buttonDeleteGuest">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.pageController.buttons.button.CLS/EV.1
;vc; Component: CLS.EF.pageController.buttons.button
;vc;  Location: LargeDev
;vc; Date/Time: 05-Feb-16 15:28
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.pageController.buttons.button.CLS/EV.1</td><td>CLS.EF.pageController.buttons.button</td><td>LargeDev</td><td style='white-space: nowrap;'>05-Feb-16 15:28</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.pageController.buttonElement,EF.pageController.proweb.prowebBase</Super>
<TimeChanged>64239,63460.568345</TimeChanged>
<TimeCreated>63404,34415.706614</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.backend.button</ReturnType>
<Implementation><![CDATA[	return ##class(EF.ui.components.frontend.buttonDeleteGuest).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>buttonDeleteGuestDefaultData</DefaultData>
<Data name="buttonDeleteGuestDefaultData">
<Structure>listnode</Structure>
<Subscript>"buttonDeleteGuest"</Subscript>
<Value name="1">
<Value>prowebItem</Value>
</Value>
<Value name="2">
<Value>prowebID</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.checkbox">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64247,31241.607373</TimeChanged>
<TimeCreated>63372,44893.197087</TimeCreated>

<Property name="price">
<Type>%Numeric</Type>
</Property>

<Property name="capacity">
<Type>%Integer</Type>
</Property>

<Property name="currentBookingLevel">
<Type>%Integer</Type>
</Property>

<Property name="isBookingStopped">
<Type>%Boolean</Type>
</Property>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.backend.checkbox</ReturnType>
<Implementation><![CDATA[
	set uiComponent = ##class(EF.ui.components.frontend.checkbox).%New(..identifier)
	return uiComponent
]]></Implementation>
</Method>

<Method name="updateUIComponent">
<Implementation><![CDATA[
	do ##super()
	set ..uiComponent.price = ..price
	set ..uiComponent.capacity = ..capacity
	set ..uiComponent.currentBookingLevel = ..currentBookingLevel
	set ..uiComponent.isBookingStopped = ..isBookingStopped
	set ..uiComponent.contextData = ..page.contextData
]]></Implementation>
</Method>

<Method name="addDependentList">
<FormalSpec>identifier:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.list</ReturnType>
<Implementation><![CDATA[
	set element = ##class(EF.pageController.containerElements.list).addElementToParent($this, identifier, "")
	set element.enableDisableDependencyList=##class(EF.ui.components.dependencyList).createNew(..identifier, 1)
	quit element
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>checkboxDefaultData</DefaultData>
<Data name="checkboxDefaultData">
<Subscript>"checkbox"</Subscript>
<Value name="1">
<Value>price</Value>
</Value>
<Value name="2">
<Value>capacity</Value>
</Value>
<Value name="3">
<Value>currentBookingLevel</Value>
</Value>
<Value name="4">
<Value>isBookingStopped</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.checkboxGroup">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64247,25070.066295</TimeChanged>
<TimeCreated>64189,53206.554402</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.backend.checkbox</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.checkboxGroup).%New(..identifier)
]]></Implementation>
</Method>

<Method name="isAlternativeInValueString">
<ClassMethod>1</ClassMethod>
<FormalSpec>alternative:%String,valueString:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	for i = 1:1:$Length(valueString,"|") {
		if $ZCVT($ZSTRIP($Piece(valueString,"|",i),"<>W"),"U") = $ZCVT($ZSTRIP(alternative,"<>W"),"U") {
			return 1	
		}	
	}
	return 0
]]></Implementation>
</Method>

<Method name="addProwebCheckbox">
<FormalSpec>parent:EF.pageController.proweb.checkboxGroup,identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.checkbox</ReturnType>
<Implementation><![CDATA[
	set element = ##class(EF.pageController.proweb.checkbox).addElementToParent(parent, identifier,description,value,isReadOnly)
	quit element
]]></Implementation>
</Method>

<Method name="getValueFromRequest">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim child as EF.pageController.proweb.checkbox
	#dim valueString as %String = ""
	
	for index = 1:1:..elementChildren.Count() {
		set child = ..elementChildren.GetAt(index)
		if %request.Get(child.identifier) = 1 {
			set tmpArray(index) = child.description
		}
	}
	set codItemName = ##class(sc.xModules.objCODitem).getCODItemName(..prowebID)
	set eventID = ##class(sc.objData).getEventID(..prowebID)
	
	if ##class(sc.xModules.objCODitem).getType(..prowebID) = "multibox" {
		set valueString = ##class(cod.methods).formatMultiCheckBox(eventID, codItemName, .tmpArray)
		
	} elseif ##class(sc.xModules.objCODitem).getType(..prowebID) = "checkbox" {
		set valueString = "true"	
	}
	return valueString
]]></Implementation>
</Method>

<Method name="setNameForValidationError">
<FormalSpec>name</FormalSpec>
</Method>

<Method name="updateUIComponent">
<Implementation><![CDATA[
	do ##super()
	
	set ..uiComponent.validator.minAltsChecked = ..prowebItem.storage.minAltsChecked
	set ..uiComponent.validator.maxAltsChecked = ..prowebItem.storage.maxAltsChecked
	set ..uiComponent.validator.fieldName = """"_..prowebItem.storage.databaseItemName_""""
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.datePicker">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64202,34967.838153</TimeChanged>
<TimeCreated>63384,38321.657735</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[
	set uiElement=##class(EF.ui.components.frontend.datePicker).%New(..identifier)
	quit uiElement
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.dateRange">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64202,41832.54542</TimeChanged>
<TimeCreated>63384,38321.657735</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[
	set uiElement=##class(EF.ui.components.frontend.dateRange).%New(..identifier)
	quit uiElement
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.divider">
<Super>EF.pageController.proweb.prowebBase</Super>
<TimeChanged>64203,63320.354946</TimeChanged>
<TimeCreated>64183,49747.663252</TimeCreated>

<Parameter name="canBeDependent">
<Type>%Boolean</Type>
<Default>0</Default>
</Parameter>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.base</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.divider).%New(..identifier)
]]></Implementation>
</Method>

<Method name="initialiseUIComponent">
<FormalSpec>uiComponent:EF.ui.components.base</FormalSpec>
<Implementation><![CDATA[	do ##super(uiComponent)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.dropdown">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64237,58616.153112</TimeChanged>
<TimeCreated>64189,53206.554402</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.backend.checkbox</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.dropdown).%New(..identifier)
]]></Implementation>
</Method>

<Method name="addAlternative">
<FormalSpec>alternative,price:%Numeric</FormalSpec>
<ReturnType>EF.ui.components.alternative</ReturnType>
<Implementation><![CDATA[	return ..uiComponent.addDropdownAlternative(alternative, ..page.contextData, price)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.emailInput">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64198,32956.969715</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.emailInput).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.emailInputMulti">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64201,44206.111927</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.emailInputMulti).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.fileUpload">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64209,44648.61035</TimeChanged>
<TimeCreated>64183,49747.663252</TimeCreated>

<Parameter name="canBeDependent">
<Type>%Boolean</Type>
<Default>0</Default>
</Parameter>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.fileUpload).%New(..identifier)
]]></Implementation>
</Method>

<Method name="setNameForValidationError">
</Method>

<Method name="initialiseUIComponent">
<FormalSpec>uiComponent:EF.ui.components.inputBase</FormalSpec>
<Implementation><![CDATA[	do ##super(uiComponent)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.guestPanel">
<Super>EF.pageController.proweb.panel</Super>
<TimeChanged>64310,33647.733122</TimeChanged>
<TimeCreated>63372,47064.603748</TimeCreated>

<Property name="guestNumber">
<Type>%Integer</Type>
</Property>

<Property name="deleteButton">
<Type>EF.pageController.proweb.buttonAddGuest</Type>
</Property>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.container</ReturnType>
<Implementation><![CDATA[
	set panel = ##class(EF.ui.components.frontend.panel).%New(..identifier)
	return panel
]]></Implementation>
</Method>

<Method name="initialiseUIComponent">
<FormalSpec>uiComponent:EF.ui.components.base</FormalSpec>
<Implementation><![CDATA[
	do ##super(uiComponent)
	set ..uiComponent.heading=..description
]]></Implementation>
</Method>

<Method name="createGuestPanel">
<ClassMethod>1</ClassMethod>
<FormalSpec>parent:EF.pageController.proweb.list,prowebID:%Integer,guestNumber:%Integer</FormalSpec>
<ReturnType>EF.pageController.proweb.guestPanel</ReturnType>
<Implementation><![CDATA[
	set guestPanel = ##class(EF.pageController.proweb.guestPanel).addElementToParent(parent, "GuestPanel-"_prowebID_"-"_guestNumber, "Guest")	
	set guestPanel.guestNumber = guestNumber
	set guestPanel.showHideDependencyList = ##class(EF.ui.components.dependencyList).createNew("ef-is-guest-active-"_guestNumber,1)
	
	do parent.listOfControllerIDsSorted.Insert(guestPanel.identifier)
	
	return guestPanel
]]></Implementation>
</Method>

<Method name="renderElements">
<FormalSpec>parentListElement:EF.pageController.containerElements.list=""</FormalSpec>
<Implementation><![CDATA[
	set ..uiComponent.guestNumber = ..guestNumber
	do ..uiComponent.renderStart()
	do ##super()
	
	do ..uiComponent.renderEnd()
]]></Implementation>
</Method>

<Method name="addElementForProwebItem">
<FormalSpec>prowebItem:sc.facade.prowebItem,guestNumber:%Integer</FormalSpec>
<ReturnType>EF.pageController.element</ReturnType>
<Implementation><![CDATA[
	set element = ##super(prowebItem, guestNumber)
	if $IsObject(element.enableDisableDependencyList) {
		set dependencyItem = ##class(EF.ui.components.dependencyItem).createNew("ef-is-guest-active-"_guestNumber,1)
		do element.enableDisableDependencyList.addDependencyItem(dependencyItem)
	} else {
		set dependency = ##class(EF.ui.components.dependencyList).createNew("ef-is-guest-active-"_guestNumber,1)
		set element.enableDisableDependencyList = dependency 	
	}
	return element
]]></Implementation>
</Method>

<Method name="addDeleteGuestButton">
</Method>

<Method name="copyGuestPanelForEachGuest">
<Private>1</Private>
<Implementation><![CDATA[
	#dim key as %Integer = ""
	#dim element as EF.pageController.element
	#dim maxGuests as %Integer = ..page.getEventConfiguration().getMaxGuestsPerAttendee()
	#dim prowebID = $Piece(..identifier,"-",2)
	
	for guestNumber = 2:1:maxGuests {
		set newGuestPanel = ..createGuestPanel(..elementParent,prowebID, guestNumber)	
		set key = ""
		for  {
			set elementID = ..listOfControllerIDsSorted.GetNext(.key)
			if key="" quit
			set element = ..page.getElementByIdentifier(elementID)
			set newController = newGuestPanel.addElementForProwebItem(element.uiComponent.prowebItem, guestNumber)
 
			
			kill newController	
		}
		
		
	}
	
	do ..addGuestTool()
]]></Implementation>
</Method>

<Method name="addGuestTool">
<Implementation><![CDATA[
	#dim prowebID = $Piece(..identifier,"-",2)
	set parent =..elementParent.identifier
	set button = ##class(EF.pageController.proweb.buttonAddGuest).addElementToParent(..elementParent, "ef-guest-tool-"_prowebID, "Add Guest")
	do ..elementParent.listOfControllerIDsSorted.Insert(button.identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>guestPanelDefaultData</DefaultData>
<Data name="guestPanelDefaultData">
<Subscript>"guestPanel"</Subscript>
<Value name="1">
<Value>guestNumber</Value>
</Value>
<Value name="2">
<Value>deleteButton</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.hiddenInput">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64288,56399.467316</TimeChanged>
<TimeCreated>64236,39000.847923</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.hiddenInput</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.hiddenInput).%New(..identifier)
]]></Implementation>
</Method>

<Method name="isOkToRender">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return 1
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.inputElement">
<Super>EF.pageController.inputElement,EF.pageController.proweb.prowebBase</Super>
<TimeChanged>64310,55576.875824</TimeChanged>
<TimeCreated>64189,53012.909524</TimeCreated>

<Property name="guestNumber">
<Type>%Integer</Type>
</Property>

<Property name="isGuest">
<Type>%Boolean</Type>
</Property>

<Method name="validateElement">
<Implementation><![CDATA[
	do ..errorMessages.Clear()
	set key=""
	for {
		set elementChild=..elementChildren.GetNext(.key)
		if key="" quit
		do elementChild.validateElement() 
 	}
 	if $IsObject(..enableDisableDependencyList) {
		if '..enableDisableDependencyList.isActiveFromRequest() {
			return	
		}
	}
	
	do ..validateValue()
]]></Implementation>
</Method>

<Method name="isOkToRender">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set isOkToRender = ##super()
	if isOkToRender {
		if (..prowebItem.storage.isBackendOnly) && (..page.contextData.isBackendBooking = 0) && (..page.contextData.prowebMode '= "edit") {
			set isOkToRender = 0	
		}
	}
	return isOkToRender
]]></Implementation>
</Method>

<Method name="updateUIComponent">
<Implementation><![CDATA[
	do ##super()
	set contextData = ..page.contextData
	
	set ..uiComponent.validator.isMandatory = +..prowebItem.storage.isMandatory
	
	if $Length(..prowebItem.storage.customValidation) {
		if ..prowebItem.storage.customValidation = "#personRegisteredWithSameAnswer" {
			set ..uiComponent.validator = ##class(EF.validator.personRegisteredWithSameAnswer).%New()
			set ..uiComponent.validator.prowebID = ..prowebItem.storage.prowebID
			
		} else {
			set ..uiComponent.validator = ##class(EF.validator.patternMatchValidation).%New()
			set ..uiComponent.validator.pattern = ..prowebItem.storage.customValidation
		}
		
	} elseif $Length(..prowebItem.storage.bespokeValidationMethod) {
		set ..uiComponent.validator = ##class(EF.validator.bespokeValidationMethod).%New()
		set ..uiComponent.validator.bespokeValidationMethod = ..prowebItem.storage.bespokeValidationMethod
		set ..uiComponent.validator.databaseItemName = ..prowebItem.storage.databaseItemName
		set ..uiComponent.validator.tempPersonID = contextData.tempPersonID
	}
	if $Length(..prowebItem.storage.validationErrorMessage) {
		set ..uiComponent.validator.errorMessage = ..prowebItem.storage.validationErrorMessage	
	}
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>inputElementDefaultData1</DefaultData>
<Data name="inputElementDefaultData1">
<Subscript>"inputElement1"</Subscript>
<Value name="1">
<Value>isMandatory</Value>
</Value>
<Value name="2">
<Value>prowebID</Value>
</Value>
<Value name="3">
<Value>guestNumebr</Value>
</Value>
<Value name="4">
<Value>isGuest</Value>
</Value>
<Value name="5">
<Value>guestNumber</Value>
</Value>
<Value name="6">
<Value>prowebItem</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.integerInput">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64201,43333.133276</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.integerInput).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.list">
<Description>
Should have a one-to-one relationship with sc.objList</Description>
<Super>EF.pageController.containerElement</Super>
<TimeChanged>64310,40661.925742</TimeChanged>
<TimeCreated>64231,55587.036042</TimeCreated>

<Property name="prowebListID">
<Description>
refers to sc.xModules.objList</Description>
<Type>%Integer</Type>
</Property>

<Property name="listOfGuestControllerIDs">
<Type>%ListOfDataTypes</Type>
<Transient>1</Transient>
</Property>

<Property name="listOfControllerIDsSorted">
<Type>%ListOfDataTypes</Type>
<Transient>1</Transient>
</Property>

<Property name="positionOfNextNonGuestQuestion">
<Type>%Integer</Type>
</Property>

<Method name="loadProwebListElementsFromDatabase">
<Implementation><![CDATA[
	#dim prowebItem As sc.facade.prowebItem
	#dim guestPanel As EF.pageController.proweb.guestPanel = ""

	if '$isObject(..page) {
		throw ##class(shared.exceptions.generalException).%New("The 'page' property is not set for the list object")	
	}
		
	set rsProwebItems = ##class(%ResultSet).%New("sc.xModules.objList:qGetChildren")
	do rsProwebItems.Execute(..prowebListID)
	while rsProwebItems.Next() {
		set prowebID = rsProwebItems.Get("ID")
		set typeOfElement = rsProwebItems.Get("dataType")
		
		if typeOfElement = "objCODitem" {
			set storage = ##class(sc.facade.prowebItemStorageInputElement).createNew(prowebID, ..page.contextData)
		
		} elseif typeOfElement = "objText" {
			set storage = ##class(sc.facade.prowebItemStorageTextBlock).createNew(prowebID, ..page.contextData)

		} elseif typeOfElement = "objMenuBlock" {
			set storage = ##class(sc.facade.prowebItemStorageMenuBlock).createNew(prowebID, ..page.contextData)

		} elseif typeOfElement = "objFormDivider" {
			set storage = ##class(sc.facade.prowebItemStorageDivider).createNew(prowebID, ..page.contextData)
		
		} elseif typeOfElement = "objFileUpload" {
			set storage = ##class(sc.facade.prowebItemStorageFileUpload).createNew(prowebID, ..page.contextData)
		
		} elseif typeOfElement = "objFlash" {
			set storage = ##class(sc.facade.prowebItemStorageYouTubeVideo).createNew(prowebID, ..page.contextData)
			
		} else {
			throw ##class(shared.exceptions.generalException).%New("Proweb type not implemented: "_typeOfElement)	
		}
		if storage.isOkToLoad(..page.contextData) {			
			set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
			if (prowebItem.storage.%Extends("sc.facade.prowebItemStorageInputElement")) && (prowebItem.storage.isGuest) {
				if '$IsObject(guestPanel) {
					set guestPanel = ##class(EF.pageController.proweb.guestPanel).createGuestPanel($this, prowebItem.storage.prowebID, 1)
				}
				set element = guestPanel.addElementForProwebItem(prowebItem,1)
			} else {
				if $IsObject(guestPanel) {
					do guestPanel.copyGuestPanelForEachGuest()
					set guestPanel = ""
				}
				set element = ..addElementForProwebItem(prowebItem)
			}
			
		}
	}
	if $IsObject(guestPanel) {
		do guestPanel.copyGuestPanelForEachGuest()
	}
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
/*
/// This method overrides the one in element because the parent of a list, which is a page, cannot have the 'page' property set. It would be cyclical.
ClassMethod xxxaddElementToParent(page As EF.pageController.proweb.page, identifier As %String, description As %String) As EF.pageController.element
{
	set element = ..%New(identifier,description)
	set element.elementParent = page
	if page.getElementByIdentifier(element.identifier) {
 		throw ##class(shared.exceptions.generalException).%New("Element identifier must be unique for page, identifier="_element.identifier)
	}
	set element.page = page
	if page.isPageReadOnly {
		set element.isReadOnly=1	
	}
	
	do page.elementChildren.Insert(element)
	
	do page.allPageElements.SetAt(element,element.identifier)
	
	return element
}
*/
]]></Content>
</UDLText>

<Method name="addElementForProwebItem">
<FormalSpec>prowebItem:sc.facade.prowebItem,optionalGuestNumber:%Integer=""</FormalSpec>
<ReturnType>EF.pageController.element</ReturnType>
<Implementation><![CDATA[
	#define isInputElement prowebItem.storage.%Extends("sc.facade.prowebItemStorageInputElement")
	#define isTextBlock prowebItem.storage.%Extends("sc.facade.prowebItemStorageTextBlock")
	#define isPageHeader prowebItem.storage.%Extends("sc.facade.prowebItemStoragePageHeader")
	#define isMenuBlock prowebItem.storage.%Extends("sc.facade.prowebItemStorageMenuBlock")
	#define isDivider prowebItem.storage.%Extends("sc.facade.prowebItemStorageDivider")
	#define isYouTubeVideo prowebItem.storage.%Extends("sc.facade.prowebItemStorageYouTubeVideo")

	#dim elementIdentifier as %String = ..page.getElementIdentifierForProwebItems(prowebItem)
	#dim element as EF.pageController.proweb.prowebBase
	
	if $$$isInputElement { 
		set element = ..getNewElementForQuestion(prowebItem, optionalGuestNumber)	

	} elseif $$$isPageHeader {
		set element = ##class(EF.pageController.proweb.pageHeader).addElementToParent($this, elementIdentifier, prowebItem.storage.text)
	
	} elseif $$$isTextBlock {
		set element = ##class(EF.pageController.proweb.textBlock).addElementToParent($this, elementIdentifier, prowebItem.storage.text)
	
	} elseif $$$isMenuBlock {
		set element = ##class(EF.pageController.proweb.menuBlock).addElementToParent($this, elementIdentifier, prowebItem.storage.listOfMenuItems)
	
	} elseif $$$isDivider {
		set element = ##class(EF.pageController.proweb.divider).addElementToParent($this, elementIdentifier, "")
	
	} elseif $$$isYouTubeVideo {
		set element = ##class(EF.pageController.proweb.youTubeVideo).addElementToParent($this, elementIdentifier, "")
	
	} else {
		throw ##class(shared.exceptions.generalException).%New("proweb item type not implemented yet: "_prowebItem.storage)	
	}

	set element.uiComponent.isProwebEditMode = (..page.contextData.prowebMode = "edit")
	
	set element.uiComponent.prowebItem = prowebItem
	set element.prowebItem = prowebItem
	set element.prowebID = prowebItem.storage.prowebID
	set element.uiComponent.prowebItemID = prowebItem.storage.prowebID
	set element.uiComponent.contextData = ..page.contextData
	
	if (element.#canBeDependent) {
		do ..addDependencyToElement(element, prowebItem, optionalGuestNumber)
	}
	do ..listOfControllerIDsSorted.Insert(element.identifier)
	return element
]]></Implementation>
</Method>

<Method name="renderElements">
<Implementation><![CDATA[
	#dim element as EF.pageController.element
	#dim hasRenderedAtLeastOne as %Boolean = 0
	
	for position = 1:1:..listOfControllerIDsSorted.Count() {
		set elementID = ..listOfControllerIDsSorted.GetAt(position)
		
		set element = ..page.getElementByIdentifier(elementID)
		
		if element.%Extends("EF.pageController.proweb.list") {
			do element.renderElements()	
		} elseif element.isOkToRender() {
			if (hasRenderedAtLeastOne = 0) && (element.uiComponent.%Extends("EF.ui.components.frontend.textInput")) && ('..page.mvcPage.isEditMode){
				set element.uiComponent.hasAutoFocus = 1 	
			}
			set element.uiComponent.nameOfControllerListClass = $ClassName($this)
			do element.render()		
			set hasRenderedAtLeastOne =1
		}
	}
	
	if 'hasRenderedAtLeastOne {
		do ..renderEmptyListHTML()	
	}
]]></Implementation>
</Method>

<Method name="getNewElementForQuestion">
<FormalSpec>prowebItem:sc.facade.prowebItem,optionalGuestNumber:%Integer=""</FormalSpec>
<ReturnType>EF.pageController.proweb.inputElement</ReturnType>
<Implementation><![CDATA[
	#dim value as %String
	#dim elementIdentifier as %String 
	#dim labelText as %String = prowebItem.storage.labelText

	if (prowebItem.storage.isGuest) && (optionalGuestNumber = "") {
		set optionalGuestNumber = 1
	}
	set elementIdentifier = ..page.getElementIdentifierForProwebItems(prowebItem, optionalGuestNumber)
	set value = ..getValueFromEComTemp(prowebItem, optionalGuestNumber)
	
	set pageControllerClassName = $Case(prowebItem.storage.inputType,
											"text":"textInput",
											"emailAddress":"emailInput",
											"time":"timeInput",
											"date":"datePicker",
											"textarea":"textArea",
											"phoneNumber":"phoneNumber",
											"integer":"integerInput",
											"floatingPointNumber":"numericInput",
											"webAddress":"webAddress",
											"multiEmailAddress":"emailInputMulti",
											"checkbox":"checkboxGroup",
											"dateRange":"dateRange",
											"password":"passwordInput",
											"fileUpload":"fileUpload",
											:"exception"
										)
	
	if prowebItem.storage.isHiddenToBooker(..page.contextData) {
		set pageControllerClassName = "privateData" 
	}
	
	if pageControllerClassName '= "exception" {		
		set element = $ClassMethod("EF.pageController.proweb."_pageControllerClassName, "addElementToParent", $this, elementIdentifier, labelText, value, prowebItem.storage.isReadOnly)
		
	} elseif (prowebItem.storage.inputType = "dropdown") ! (prowebItem.storage.inputType = "radiobutton") ! (prowebItem.storage.inputType = "multibox") {
		set element = ..addProwebSelectionElement(prowebItem, optionalGuestNumber)
				
	} else {
		throw ##class(shared.exceptions.generalException).%New("proweb question type is not implemented yet: "_prowebItem.storage.inputType)	
	}

	if prowebItem.storage.inputType = "checkbox" {
		set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_1, labelText, value)
	}		
	if prowebItem.storage.inputType = "dateRange" {
		do ..page.addSecondDatePickerForDateRange(prowebItem, element)
	}
		
	set element.uiComponent.isGuest = prowebItem.storage.isGuest
	if prowebItem.storage.isGuest {
		set element.guestNumber = optionalGuestNumber	
		set element.isGuest = 1
		set element.uiComponent.guestNumber = optionalGuestNumber	
	}
	set element.uiComponent.helpText = prowebItem.storage.helpText	

	return element
]]></Implementation>
</Method>

<Method name="getValueFromEComTemp">
<FormalSpec>prowebItem:sc.facade.prowebItem,optionalGuestNumber:%Integer,getRawData=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim itemName as %String = prowebItem.storage.databaseItemName
	if ..page.isTestMode {
		return prowebItem.storage.testValue
	}
	
	if optionalGuestNumber  {
		if ..page.mvcPage.isEditMode {
			set tempPersonID = "n/a"
		} else {
			set tempPersonID = ..page.getTempPersonIdForGuestNumber(optionalGuestNumber)	
		}
	} else {
		set tempPersonID = ..page.contextData.tempPersonID
	}
	set value = ##class(eCom.tempCodData).get(tempPersonID, itemName, ,getRawData)
	
	if (value = "") && (..page.contextData.tempBookerID) {
		set value = ##class(eCom.tempCodData).getValueToCopyFromBooker(tempPersonID, ..page.contextData.tempBookerID, prowebItem.storage.prowebID)	
	}
		
	if (value = "") && (prowebItem.storage.defaultValue '= "") {
		set value = prowebItem.storage.defaultValue	
	}
	return value
]]></Implementation>
</Method>

<Method name="addProwebSelectionElement">
<FormalSpec>prowebItem:sc.facade.prowebItem,optionalGuestNumber:%Integer=""</FormalSpec>
<Private>1</Private>
<ReturnType>EF.pageController.element</ReturnType>
<Implementation><![CDATA[
	#define getRawData 1
	#dim element as EF.pageController.element
	#dim value as %String
	#dim elementIdentifier as %String = ..page.getElementIdentifierForProwebItems(prowebItem, optionalGuestNumber)
	#dim labelText as %String = prowebItem.storage.labelText
	#dim itemName as %String = prowebItem.storage.databaseItemName
	#dim isReadOnly as %Boolean = prowebItem.storage.isReadOnly
	#dim counter as %Integer = 0
	#dim getRawData as %Boolean = 1
	#dim key as %Integer = ""
	
	if prowebItem.storage.inputType = "dropdown" {
		set value = ..getValueFromEComTemp(prowebItem, optionalGuestNumber)
		set element = ##class(EF.pageController.proweb.dropdown).addElementToParent($this, elementIdentifier, labelText, value, isReadOnly)
		set element.uiComponent.isSearchAsYouType = prowebItem.storage.isSearchAsYouType
		
	} elseif prowebItem.storage.inputType = "radiobutton" {
		set value = ..getValueFromEComTemp(prowebItem, optionalGuestNumber)
		set element = ##class(EF.pageController.proweb.radioGroup).addElementToParent($this, elementIdentifier, labelText, value, isReadOnly)
		
	} elseif prowebItem.storage.inputType = "multibox" {
		set value = ..getValueFromEComTemp(prowebItem, optionalGuestNumber, $$$getRawData)
		set element = ##class(EF.pageController.proweb.checkboxGroup).addElementToParent($this, elementIdentifier, labelText, value)
		set element.uiComponent.columns=1
			
	} else {
		throw ##class(shared.exceptions.generalException).%New("Proweb selection type not implemented"_prowebItem.storage.inputType)
	}
	
	set element.prowebID = prowebItem.storage.prowebID	
	
	for  {
		set alternative = prowebItem.storage.listOfAlternatives.GetNext(.key)
		if key ="" quit

		if prowebItem.storage.inputType = "multibox" {
			set counter = counter + 1
			set isChecked = ##class(EF.pageController.proweb.checkboxGroup).isAlternativeInValueString(alternative.displayText, value)
			set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_counter, alternative.displayText, isChecked)
			set childController.price = ..getPrice(alternative, prowebItem) 
			set childController.capacity = alternative.ABICapacity
			set childController.currentBookingLevel = alternative.ABICurrentBookingLevel
			set childController.isBookingStopped = alternative.ABIIsBookingStopped
		} else {
			set childController = element.addAlternative(alternative, ..getPrice(alternative, prowebItem))	
		} 
	}
	
	if (value = "") && (prowebItem.storage.inputType = "radiobutton" ) && (prowebItem.storage.listOfAlternatives.Count() > 0) {
		set element.value = prowebItem.storage.listOfAlternatives.GetAt(1).value
	}
	return element
]]></Implementation>
</Method>

<Method name="getPrice">
<FormalSpec>alternative:sc.facade.prowebItemStorageInputElementAlternative,prowebItem:sc.facade.prowebItem</FormalSpec>
<ReturnType>%Numeric</ReturnType>
<Implementation><![CDATA[
	#dim price as %Numeric
	#dim currencyID as %Integer = ..page.contextData.currencyID
	#dim eventID as %Integer = ..page.contextData.eventID
	
	if ..page.mvcPage.isEditMode {
		set currencyID = ##class(setup.objEvent).getBaseCurrency(eventID)
	}
	if ..page.isTestMode {
		set price = 0
	} else {
		set price = ##class(sc.xModules.objCODitem).getPrice(alternative.alternativeID, prowebItem.storage.prowebID , eventID, currencyID)
	}
	
	return price
]]></Implementation>
</Method>

<Method name="addDependencyToElement">
<FormalSpec>childElement:EF.pageController.proweb.prowebBase,prowebItem:sc.facade.prowebItem,optionalGuestNumber:%Integer=""</FormalSpec>
<Implementation><![CDATA[
	if '..page.contextData.isTestMode {
		set requiredAnswer = ##class(sc.dependencyMethods).getDependsOnAlternativeDescription(prowebItem.storage.prowebID)
		if (($Length(requiredAnswer)) && (prowebItem.storage.hasInPageDependency(..page.contextData))) {
			set parentProwebID = ##class(sc.dependencyMethods).getDependsOnPrompt(prowebItem.storage.prowebID)
			
			set storage = ##class(sc.facade.prowebItemStorageInputElement).createNew(parentProwebID, ..page.contextData)
			set parentProwebItem = ##class(sc.facade.prowebItem).createNew(storage)
			set guestNumber = ""
			if parentProwebItem.storage.isGuest {
				set guestNumber = optionalGuestNumber	
			}
			set parentElementIdentifier = ..page.getElementIdentifierForProwebItems(parentProwebItem, guestNumber)
			set dependencyList = ##class(EF.ui.components.dependencyList).createNew(parentElementIdentifier, requiredAnswer)	
			set childElement.showHideDependencyList = dependencyList
			set childElement.enableDisableDependencyList = dependencyList
		}
	}
]]></Implementation>
</Method>

<Method name="renderEmptyListHTML">
<Implementation><![CDATA[
	if ..page.mvcPage.isEditMode {
		set allowedElementTypes = ..getAllowedElementTypesForThisListType( $CLASSNAME($this) )
		&HTML<
			<div class="row ef-draggable-div ef-form-row ef-form-row-editable ef-empty-list" 
				data-ui-component-type="emptyList" 
				data-proweb-list-id="#(##class(EF.htmlGenerator).encodeForHTMLAttribute(..prowebListID))#"
				data-proweb-allowed-types="#(##class(EF.htmlGenerator).encodeForHTMLAttribute(allowedElementTypes))#"
			>
			</div>
		>
	}
]]></Implementation>
</Method>

<Method name="getAllowedElementTypesForThisListType">
<ClassMethod>1</ClassMethod>
<FormalSpec>nameOfListClass:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if nameOfListClass = "EF.pageController.proweb.list" {
		return "Text"	
		
	} elseif nameOfListClass = "EF.pageController.proweb.listOfSingleElement" {
		return "Text"	
		
	} elseif (nameOfListClass = "EF.pageController.proweb.listWithQuestionsRegistration") ! (nameOfListClass = "EF.pageController.proweb.guestPanel") {
		return "Question,ABI,QBI,Collection,Divider,Text,File upload,Video"	
	}
	
	throw ##class(shared.exceptions.generalException).%New("List class has no allowed element types defined: "_nameOfListClass)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>listDefaultData</DefaultData>
<Data name="listDefaultData">
<Subscript>"list"</Subscript>
<Value name="1">
<Value>scTagName</Value>
</Value>
<Value name="2">
<Value>componentName</Value>
</Value>
<Value name="3">
<Value>scListID</Value>
</Value>
<Value name="4">
<Value>prowebListID</Value>
</Value>
<Value name="5">
<Value>positionOfNextNonGuestQuestion</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.listOfSingleElement">
<Super>EF.pageController.proweb.list</Super>
<TimeChanged>64233,28880.382469</TimeChanged>
<TimeCreated>64233,28684.712587</TimeCreated>

<Property name="componentName">
<Type>%String</Type>
<Parameter name="MAXLEN" value="255"/>
</Property>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.listWithQuestions">
<Description>
Should have a one-to-one relationship with sc.objList</Description>
<Super>EF.pageController.proweb.list</Super>
<TimeChanged>64233,55899.135565</TimeChanged>
<TimeCreated>64231,55587.036042</TimeCreated>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.listWithQuestionsRegistration">
<Super>EF.pageController.proweb.listWithQuestions</Super>
<TimeChanged>64310,37796.916971</TimeChanged>
<TimeCreated>64233,52209.241492</TimeCreated>

<Method name="loadProwebListElementsFromDatabase">
<Implementation><![CDATA[
	if '$isObject(..page) {
		throw ##class(shared.exceptions.generalException).%New("The 'page' property is missing from the listWithQuestions object")	
	}
	for guestNumber = 1:1:..page.getEventConfiguration().getMaxGuestsPerAttendee() {
		if (..page.mvcPage.isEditMode) {
			if guestNumber = 1 {
				set isActive = 1
			} else {
				set isActive = 0	
			}
		} else {
			if ..page.getTempPersonIdForGuestNumber(guestNumber) {
				set isActive = 1	
			} else {
				set isActive = 0	
			}
		}
		set isGuestActiveElem = ##class(EF.pageController.proweb.hiddenInput).addElementToParent($this,"ef-is-guest-active-"_guestNumber, "",isActive)
		do isGuestActiveElem.uiComponent.addClass("ef-is-guest-active")
		do ..listOfControllerIDsSorted.Insert(isGuestActiveElem.identifier)
	}
	do ##super()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.menuBlock">
<Super>EF.pageController.proweb.prowebBase</Super>
<TimeChanged>64223,57337.284006</TimeChanged>
<TimeCreated>64183,49747.663252</TimeCreated>

<Parameter name="canBeDependent">
<Default>0</Default>
</Parameter>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.base</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.menuBlock).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.numericInput">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64201,43313.656158</TimeChanged>
<TimeCreated>63939,36505.690987</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.numericInput).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.page">
<Super>EF.pageController.page</Super>
<TimeChanged>64310,52773.386154</TimeChanged>
<TimeCreated>64189,51696.559047</TimeCreated>

<Property name="mvcPage">
<Type>EF.mvcHandler.frontendProweb</Type>
</Property>

<Property name="contextData">
<Type>EF.contextDataFrontend</Type>
</Property>

<Property name="securityHandler">
<Type>EF.mvcHandler.securityHandlers.base</Type>
</Property>

<Property name="pageID">
<Type>%Integer</Type>
</Property>

<Property name="isTestMode">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Method name="createMock">
<ClassMethod>1</ClassMethod>
<FormalSpec>contextData:EF.contextData,maxGuests:%Integer=0</FormalSpec>
<ReturnType>EF.pageController.page</ReturnType>
<Implementation><![CDATA[
	set pageController=..%New()

	set pageController.isTestMode = 1
	set pageController.contextData = contextData
	set pageController.eventConfiguration = ##class(setup.eventConfiguration.storageMock).createEventConfiguration()
	set pageController.eventConfiguration.storage.maxGuests = maxGuests
	set pageController.page = pageController // weird but needed for the when inserting the mock items
	do pageController.load()

	return pageController
]]></Implementation>
</Method>

<Method name="load">
<FormalSpec>mvcPage:EF.mvcHandler.frontendProweb=""</FormalSpec>
<Implementation><![CDATA[
	if '$IsObject(..contextData) {
		throw ##class(shared.exceptions.generalException).%New("context data missing")	
	}
	if '$IsObject(..contextData.eventWebsiteLanguage) {
		throw ##class(shared.exceptions.generalException).%New("..contextData.eventWebsiteLanguage missing")	
	}

	set ..mvcPage = mvcPage
	
	if ..isTestMode {
		do ..insertMockProwebItems()	
	
	} else {
		if '..isReload {
			do ..loadIncludePage(..contextData.eventWebsiteLanguage.getBannerPageID() , "banner page")
			do ..loadIncludePage(..contextData.eventWebsiteLanguage.getMenuPageID() , "navigation bar page")
			do ..loadAllProwebListsForPage()
			do ..loadIncludePage(..contextData.eventWebsiteLanguage.getSponsorPageID(), "sponsor page")
			do ..loadIncludePage(..contextData.eventWebsiteLanguage.getFooterPageID(), "footer page")
		}
	}
	do ..updateUIComponents()
]]></Implementation>
</Method>

<Method name="open">
<Description>
opens the pageController without reloading the elements.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageControllerID</FormalSpec>
<ReturnType>EF.pageController.page</ReturnType>
<Implementation><![CDATA[
	if 'pageControllerID {
		throw ##class(shared.exceptions.generalException).%New("No pageControllerID passed in to the open method")	
	}
	set pageController = ##class(EF.pageController.page).%OpenId(pageControllerID)
	if '$IsObject(pageController) {
		throw ##class(shared.exceptions.generalException).%New("Failed to open pageController with ID='"_pageControllerID_"'")
		
	}	
	return pageController
]]></Implementation>
</Method>

<Method name="renderErrorMessages">
<Implementation><![CDATA[
	set elem = ##class(EF.ui.components.backend.textAlertError).%New()
	for i = 1:1:..errorMessages.Count() {
		if $Length(elem.text) {
			set elem.text = elem.text_$C(13,10)	
		}
		set elem.text = elem.text_..errorMessages.GetAt(i)
	}
	do elem.render()
]]></Implementation>
</Method>

<Method name="getEventConfiguration">
<Implementation><![CDATA[
	set ..eventConfiguration=##class(setup.eventConfiguration).createForEventID(..contextData.eventID) 
	return ..eventConfiguration
]]></Implementation>
</Method>

<Method name="loadIncludePage">
<FormalSpec>pageID:%Integer,listName:%String</FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
	if 'pageID {
		throw ##class(shared.exceptions.generalException).%New("Page ID missing when loading include page, listName='"_listName_"'")
	}
	set list =	##class(EF.pageController.proweb.list).addElementToParent($this, listName, "")
	set prowebListID = ##class(sc.xModules.objList).getListIDFromPageIDAndComponentName(pageID, "INDEXLIST")
	
	if 'prowebListID {
		do ..initialiseComponent(pageID, "listOfSingleElement", "INDEXLIST")
	}
	
	set list.prowebListID = prowebListID
	do list.loadProwebListElementsFromDatabase()
]]></Implementation>
</Method>

<Method name="loadAllProwebListsForPage">
<Private>1</Private>
<Implementation><![CDATA[
	set rsComponents = ##class(%ResultSet).%New("sc.objComponent:qComponentsByPageID")
	do rsComponents.Execute( ..pageID )
	while rsComponents.Next() {
		set componentName = rsComponents.Get("description")
		set prowebID = rsComponents.Get("listID")
		set dataType = rsComponents.Get("dataType")
		set className = rsComponents.Get("listType")
		if '$Length(className) {
			set className = ..getDefaultTypeOfList()
		}
		if dataType = "objList" {	
			set listElement = $ClassMethod("EF.pageController.proweb."_className, "addElementToParent", $this, componentName, "")
			set listElement.prowebListID = prowebID 
			do listElement.loadProwebListElementsFromDatabase()

		} elseif dataType = "objText" { // single text items that are directly located in the page
			set listElement = ##class(EF.pageController.proweb.listOfSingleElement).addElementToParent($this, componentName, "")
			set listElement.componentName = componentName 
			if componentName = "header" {
				set storage = ##class(sc.facade.prowebItemStoragePageHeader).createNew(prowebID, ..contextData)
			} else {
				set storage = ##class(sc.facade.prowebItemStorageTextBlock).createNew(prowebID, ..contextData)
			}
			if storage.isOkToLoad(..contextData) {			
				set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
				do listElement.addElementForProwebItem(prowebItem)
			}
		}
	}
]]></Implementation>
</Method>

<Method name="getDefaultTypeOfList">
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// we may need logic here for defaulting to reg questions in old events but only on the reg pages
	return "list"
]]></Implementation>
</Method>

<Method name="insertMockProwebItems">
<Private>1</Private>
<Implementation><![CDATA[
	#dim key as %Integer = ""
	#dim componentName as %String = "unit test"
	#dim guestPanel As EF.pageController.proweb.guestPanel
	#dim fakeProwebID as %Integer = 999
	#dim guestNumber as %Integer
	
	set listElement = ##class(EF.pageController.proweb.listWithQuestionsRegistration).addElementToParent($this, componentName , "")
	set listElement.prowebListID = -1

	if ..eventConfiguration.storage.maxGuests > 0 {
		for guestNumber = 1:1:..eventConfiguration.storage.maxGuests {
			set guestPanel = ##class(EF.pageController.proweb.guestPanel).addElementToParent(listElement, "GuestPanel-"_fakeProwebID_"-"_guestNumber, "Guest")	
			set guestPanel.guestNumber = guestNumber
			set guestPanel.showHideDependencyList = ##class(EF.ui.components.dependencyList).createNew("ef-is-guest-active-"_guestNumber,1)
			do listElement.listOfControllerIDsSorted.Insert(guestPanel.identifier)
			set parent = guestPanel
			do ..addMockElements(parent, guestNumber)
		}		
	} else {
		set parent = listElement	
		do ..addMockElements(parent)
	}
]]></Implementation>
</Method>

<Method name="addMockElements">
<FormalSpec>parent:EF.pageController.element,guestNumber:%Integer=0</FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
	for  {
		set prowebItem = ..contextData.listOfProwebItemsToAdd.GetNext(.key)	
		if key = "" quit

		if parent.%Extends("EF.pageController.proweb.guestPanel") {
			do parent.addElementForProwebItem(prowebItem, guestNumber)
		} else {
			do parent.addElementForProwebItem(prowebItem) 
		}
	}
]]></Implementation>
</Method>

<Method name="validate">
<Implementation><![CDATA[	// ###### do we need to do anything here? #########
]]></Implementation>
</Method>

<Method name="saveData">
<Implementation><![CDATA[	// ###### do we need to do anything here? #########
]]></Implementation>
</Method>

<Method name="getTempPersonIdForGuestNumber">
<FormalSpec>optionalGuestNumber:%Integer</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	#dim counter as %Integer = 0
	#define fakeTempPersonID -1

	if ..isTestMode {
		return $$$fakeTempPersonID
	}
	
	set rsTemps = ##class(%ResultSet).%New()
	do rsTemps.Prepare("SELECT ID FROM eCom.tempPerson WHERE (tempPurchase = ?) AND (isGuest = 1) AND (active = 1) ORDER BY ID")
	do rsTemps.Execute(..contextData.tempPurchaseID)
	while rsTemps.Next() {
		set counter = counter + 1	
		if counter = optionalGuestNumber {
			return rsTemps.Get("ID")
		}
	}
	return ""
]]></Implementation>
</Method>

<Method name="createNewTempPersonForGuest">
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	#define notBooker 0
	#define notDelegate 0
	#define isGuest 1
	
	set tempPersonGuestID = ##class(eCom.tempPerson).add(%session.%Id(), $$$notBooker, $$$notDelegate, $$$isGuest, ..contextData.tempPersonID) // ######### remove %session
	if 'tempPersonGuestID {
		throw ##class(shared.exceptions.generalException).%New("Failed to create a new tempPerson for guest")
	}
	return tempPersonGuestID
]]></Implementation>
</Method>

<Method name="deleteTempGuest">
<FormalSpec>tempPersonID</FormalSpec>
<Implementation><![CDATA[	do ##class(eCom.tempPerson).deleteGuest(tempPersonID)
]]></Implementation>
</Method>

<Method name="addSecondDatePickerForDateRange">
<FormalSpec>prowebItem:sc.facade.prowebItem,element:EF.pageController.proweb.dateRange</FormalSpec>
<ReturnType>EF.pageController.element</ReturnType>
<Implementation><![CDATA[
	#dim isReadOnly as %Boolean = 0
	#dim itemName as %String = prowebItem.storage.databaseItemName
	#dim value as %String 
	#dim elementIdentifier as %String = ..getElementIdentifierForProwebItems(prowebItem)

	set childControllerStart = ##class(EF.pageController.proweb.datePicker).addElementToParent(element, elementIdentifier_"-startDate", "", isReadOnly)	
	set childControllerStart.uiComponent.contextData = ..contextData
	set childControllerStart.prowebItem = prowebItem
	set childControllerStart.uiComponent.prowebItem = prowebItem
	set childControllerStart.value = $Piece(##class(eCom.tempCodData).get(..contextData.tempPersonID, itemName), "|", 1)
	
	set earliestAllowedStartDate = $Piece(##class(cod.lnkItemNameEventDateRange).getMinTimeStamp(..contextData.eventID, prowebItem.storage.databaseItemID), " ", 1)
	set earliestAllowedStartDate = ##class(shared.dateFunctions).multiDate(earliestAllowedStartDate, 25 )
	do childControllerStart.uiComponent.addAttribute("efdaterangestartmin", earliestAllowedStartDate)
	do childControllerStart.uiComponent.addAttribute("efdaterangeendid", elementIdentifier_"-endDate")
				
	set childControllerEnd = ##class(EF.pageController.proweb.datePicker).addElementToParent(element, elementIdentifier_"-endDate", "", isReadOnly)		
	set childControllerEnd.uiComponent.contextData = ..contextData
	set childControllerEnd.prowebItem = prowebItem
	set childControllerEnd.uiComponent.prowebItem = prowebItem
	set childControllerEnd.value = $Piece(##class(eCom.tempCodData).get(..contextData.tempPersonID, itemName), "|", 2)

	set latestAllowedEndDate = $Piece(##class(cod.lnkItemNameEventDateRange).getMaxTimeStamp(..contextData.eventID, prowebItem.storage.databaseItemID), " ", 1)
	set latestAllowedEndDate = ##class(shared.dateFunctions).multiDate(latestAllowedEndDate, 25 )
	do childControllerEnd.uiComponent.addAttribute("efdaterangeendmax", latestAllowedEndDate)
	do childControllerEnd.uiComponent.addAttribute("efdaterangestartid", elementIdentifier_"-startDate")	

	return element
]]></Implementation>
</Method>

<Method name="getElementIdentifierForProwebItems">
<FormalSpec>prowebItem:sc.facade.prowebItem,optionalGuestNumber:%Integer=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	try {
		set identifier = prowebItem.storage.databaseItemName
	} catch {
		set identifier = "proweb-"_prowebItem.storage.prowebID
	}
	if optionalGuestNumber {
		set identifier = identifier_"-"_optionalGuestNumber		
	}
	return identifier
]]></Implementation>
</Method>

<Method name="renderHTMLControlFromTag">
<FormalSpec><![CDATA[&attrs]]></FormalSpec>
<Implementation><![CDATA[
	#dim componentName as %String = attrs("prowebcomponentname")
	#dim componentType as %String = attrs("componenttype")
	
	if '..pageID {
		throw ##class(shared.exceptions.generalException).%New("pageID was missing when attempting to render Proweb tag")
	}
	
	if ..hasError {
		do ..renderErrorMessages()
	}
	do ..renderComponent(componentName,componentType)
]]></Implementation>
</Method>

<Method name="renderComponent">
<Description>
also an entry point from unit tests</Description>
<FormalSpec>componentName:%String,componentType:%String=""</FormalSpec>
<Implementation><![CDATA[
	set parentListElement = ..getElementByIdentifier(componentName) 
	if $IsObject(parentListElement) {
		do parentListElement.renderElements()
	} else {
		// This is done on the very first page load becuase the database have no knowledge of what proweb tags (i.e. components) that are in the page
		do ..initialiseComponent(..pageID, componentType, componentName)	
	}
]]></Implementation>
</Method>

<Method name="initialiseComponent">
<FormalSpec>pageID:%Integer="",componentType:%String="",componentName:%String=""</FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
	if '..isTestMode  { 
		if ('pageID) ! (componentType = "") ! (componentName = "") {
			throw ##class(shared.exceptions.generalException).%New("Parameter(s) missing when attempting to initisalise a component of type: '"_componentType_"' - name: '"_componentName_"' - pageID: "_pageID)	
		}

		if componentType = "text" {
			set prowebID = ##class(sc.xModules.objText).add(pageID, componentName)
		} else {
			set prowebID = ##class(sc.xModules.objList).add(pageID)	
		}
		if 'prowebID {
			throw ##class(shared.exceptions.generalException).%New("Failed to create new proweb object of type: "_componentType)	
		}
		set templateID = ##class(sc.pageMethods).getTemplateIDfromPageID(pageID)

		set componentID = ##class(sc.objComponent).add(componentName, templateID, prowebID, componentType)
		if 'componentID {
			throw ##class(shared.exceptions.generalException).%New("Failed to create new objComponent")
		}
		
		// refresh the page to make the new list visible
		&html<
  			<script language="javascript">		
  				location.reload(true);	
  			</script>		  			
  		>		  		
	}
]]></Implementation>
</Method>

<Method name="reorderProwebElements">
<FormalSpec>orderedElementIds:%String</FormalSpec>
<Implementation><![CDATA[
	#dim key as %Integer = ""
	#dim element as EF.pageController.element
	#dim prowebItemID as %Integer
	
	set displayOrder = 0
	for index = 1:1:$Length(orderedElementIds,"|") {
		set prowebItemID = $Piece(orderedElementIds,"|",index)
		if $Length(prowebItemID) {
			set displayOrder = displayOrder + 1
			set prowebItems(prowebItemID) = displayOrder
		}
	}
	
	for {
		set element = ..allPageElements.GetNext(.key)
		if key = "" quit
		if element.%Extends("EF.pageController.proweb.prowebBase") {
			if element.prowebItem.storage.prowebID {
				try {
					if $Data(prowebItems(element.prowebItem.storage.prowebID)) {
						set prowebElement = ##class(sc.objData).%OpenId(element.prowebID)
						set oldDisplayOrder = prowebElement.displayOrder
						set newDisplayOrder = prowebItems(element.prowebID)
						set prowebElement.displayOrder = prowebItems(element.prowebID)
						do prowebElement.%Save()
						
						if (oldDisplayOrder '= newDisplayOrder) {
							set eventID = prowebElement.objEvent.%Id()
							set pageID = ##class(sc.xModules.objCODitem).getPageIDforQuestion(prowebElement.%Id())
							set pageName = ##class(sc.xModules.objPage).getDescription(pageID)
							set prowebItemDescription = ##class(sc.xModules.objCODitem).getCODItemName(prowebElement.%Id())
							if (prowebElement.%Id() && pageID) {
								do ##class(setup.objEventAudit).add(..contextData.auditPersonID, eventID, "Reg Page '"_pageName_"' ("_pageID_"), Changed '"_prowebItemDescription_"' Registration Question Order: "_newDisplayOrder_" (New Value) - "_oldDisplayOrder_" (Old Value)")
							}
						}
					}
				} catch error {
					throw ##class(shared.exceptions.generalException).%New("Failed to get the prowebID of element: "_element)	
				}
			} else {
				write !,"element without prowebID:",element	
			}
		}
	}
]]></Implementation>
</Method>

<Method name="copyAllDataToEComTemp">
<Implementation><![CDATA[
	#dim key as %Integer = ""
	#dim element as EF.pageController.proweb.inputElement
	#dim prowebItemID as %Integer
	#dim prowbItemName as %String
	#dim tempPersonID as %Integer
	
	for {
		set element=..allPageElements.GetNext(.key)
		if key="" quit
		
		if element.%IsA("EF.pageController.proweb.inputElement") {
			set prowebItemID = element.prowebID
			set prowbItemName = ##class(sc.xModules.objCODitem).getCODItemName(prowebItemID)
			
			if element.isGuest {
				set isActive = ..getValueByIdentifier("ef-is-guest-active-"_element.guestNumber)
				set tempPersonID = ..getTempPersonIdForGuestNumber(element.guestNumber)
				if (isActive) && ('tempPersonID) {
					set tempPersonID=..createNewTempPersonForGuest()	
				}
				if ('isActive) &&(tempPersonID) {
					do ..deleteTempGuest(tempPersonID)	
				}
			} else {
				set tempPersonID = ..contextData.tempPersonID	
			}
			
			if ( element.%IsA("EF.pageController.proweb.checkbox") ) && ( element.elementParent.elementChildren.Count() > 1 ) { 
				// multi checkboxes only. skip individual checkboxes. they are saved as multi checkboxes rather than individual.
				continue
			} elseif ( element.%IsA("EF.pageController.proweb.checkboxGroup") ) && ( element.elementChildren.Count() > 1 ) {
				for i = 1:1:element.elementChildren.Count() {
					if element.elementChildren.GetAt(i).value = 1 {
						set multiCheckboxData(prowbItemName, $I(multiCheckboxData(prowbItemName))) = element.elementChildren.GetAt(i).description
					}
				}
			} elseif ( element.%IsA("EF.pageController.proweb.dateRange") )  { // date range
				set startDate = element.elementChildren.GetAt(1).value
				set endDate = element.elementChildren.GetAt(2).value
				do ##class(eCom.tempCodData).set(tempPersonID, prowbItemName, startDate_"|"_endDate )			
			} elseif ( element.%IsA("EF.pageController.proweb.datePicker") && element.elementParent.elementChildren.Count() = 2 ) {
				// skip individual date range date pickers. they have been saved already.
				continue
			} else {
				do ##class(eCom.tempCodData).set(tempPersonID, prowbItemName, element.value)	
			}
		}
	}
	do ..copyAndFormatMultiCheckboxData(tempPersonID, .multiCheckboxData)
]]></Implementation>
</Method>

<Method name="copyAndFormatMultiCheckboxData">
<FormalSpec><![CDATA[tempPersonID:%Integer,&multiCheckboxData]]></FormalSpec>
<Implementation><![CDATA[
	set prowbItemName = ""
	for {  
		set prowbItemName = $Order(multiCheckboxData(prowbItemName))
		if prowbItemName = "" quit
		kill tmpArray
		merge tmpArray=multiCheckboxData(prowbItemName)
		
		set value = ##class(cod.methods).formatMultiCheckBox(..contextData.eventID, prowbItemName, .tmpArray)
		do ##class(eCom.tempCodData).set(tempPersonID, prowbItemName, value, ..pageID, ..contextData.eventID)
	}
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>pageDefaultData1</DefaultData>
<Data name="pageDefaultData1">
<Subscript>"page1"</Subscript>
<Value name="1">
<Value>floatingMenuCounter</Value>
</Value>
<Value name="2">
<Value>prowebComponentName</Value>
</Value>
<Value name="3">
<Value>contextData</Value>
</Value>
<Value name="4">
<Value>prowebPageID</Value>
</Value>
<Value name="5">
<Value>mvcPage</Value>
</Value>
<Value name="6">
<Value>pageID</Value>
</Value>
<Value name="7">
<Value>isTestMode</Value>
</Value>
<Value name="8">
<Value>securityHandler</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.pageHeader">
<Super>EF.pageController.proweb.textBlock</Super>
<TimeChanged>64264,58769.911576</TimeChanged>
<TimeCreated>64264,58677.694749</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.base</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.pageHeader).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.panel">
<Super>EF.pageController.proweb.list</Super>
<TimeChanged>64233,57523.763651</TimeChanged>
<TimeCreated>63372,47064.603748</TimeCreated>

<Property name="isOpeningOrClosing">
<Type>%String</Type>
</Property>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.container</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.panel).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>panelDefaultData</DefaultData>
<Data name="panelDefaultData">
<Subscript>"panel"</Subscript>
<Value name="1">
<Value>isOpeningOrClosing</Value>
</Value>
<Value name="2">
<Value>contextData</Value>
</Value>
<Value name="3">
<Value>prowebID</Value>
</Value>
<Value name="4">
<Value>prowebItem</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.passwordInput">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64217,39528.320164</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.passwordInput).%New(..identifier)
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	if $Length(..value) {
		set ..value = "********"
	}
	do ##super()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.phoneNumber">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64232,41994.153962</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.phoneNumber).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.privateData">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64217,38879.722364</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.privateData).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.prowebBase">
<Super>EF.pageController.element</Super>
<TimeChanged>64216,58260.92232</TimeChanged>
<TimeCreated>64183,49747.663252</TimeCreated>

<Parameter name="canBeDependent">
<Type>%Boolean</Type>
<Default>1</Default>
</Parameter>

<Property name="prowebItem">
<Type>sc.facade.prowebItem</Type>
</Property>

<Property name="prowebID">
<Type>%Integer</Type>
</Property>

<Method name="isOkToRender">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return 1
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>prowebBaseDefaultData</DefaultData>
<Data name="prowebBaseDefaultData">
<Subscript>"prowebBase"</Subscript>
<Value name="1">
<Value>prowebID</Value>
</Value>
<Value name="2">
<Value>prowebItem</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.radioGroup">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64237,58441.085418</TimeChanged>
<TimeCreated>64189,53206.554402</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.backend.checkbox</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.radioGroup).%New(..identifier)
]]></Implementation>
</Method>

<Method name="addAlternative">
<FormalSpec>alternative:sc.facade.prowebItemStorageInputElementAlternative,price:%Numeric</FormalSpec>
<ReturnType>EF.ui.components.alternative</ReturnType>
<Implementation><![CDATA[	return ..uiComponent.addRadioAlternative(alternative, ..page.contextData, price)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.testCases.checkboxGroupTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,56641.938683</TimeChanged>
<TimeCreated>64204,52598.182886</TimeCreated>

<Method name="TestWithMulticheckboxNoneSelected">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set elementIdentifier = "proweb-1"
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "my multi check"
	set storage.inputType = "multibox"
	set storage.labelText = "Please select your options"
	
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 1"
	set alternative.displayText = "option 1"
	do storage.listOfAlternatives.Insert( alternative)
	
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 2"
	set alternative.displayText = "option 2"
	do storage.listOfAlternatives.Insert( alternative)

	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 2"
	set alternative.displayText = "option 2"
	do storage.listOfAlternatives.Insert( alternative)
	

	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
		
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-containeref-label-container-vertical-group""><labelid=""ef-display-label-mymulticheck""class=""control-labelef-control-label""for=""mymulticheck"">Pleaseselectyouroptions</label></div><divclass=""col-sm-8ef-checkbox-container""><div><divclass=""inputs-listef-proweb-input-elementef-checkbox-group""><labelclass=""ef-control-label""><inputtype=""checkbox""value=""1""id=""mymulticheck-1""class=""ef-control-labelef-check-box""name=""mymulticheck-1""title="""">option1&nbsp;</label><br/><labelclass=""ef-control-label""><inputtype=""checkbox""value=""1""id=""mymulticheck-2""class=""ef-control-labelef-check-box""name=""mymulticheck-2""title="""">option2&nbsp;</label><br/><labelclass=""ef-control-label""><inputtype=""checkbox""value=""1""id=""mymulticheck-3""class=""ef-control-labelef-check-box""name=""mymulticheck-3""title="""">option2&nbsp;</label><br/></div></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.datePIckerTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,58846.454125</TimeChanged>
<TimeCreated>64204,52627.550246</TimeCreated>

<Method name="TestDatePicker">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "My date picker"
	set storage.inputType = "date"
	set storage.labelText = "Please enter your DOB"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)
	
	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
		
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent","unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-Mydatepicker""class=""control-labelef-control-label""for=""Mydatepicker"">PleaseenteryourDOB</label></div><divclass=""col-sm-8ef-input-container""><divstyle=""width:40%""class=""ef-inputef-date-pickeref-kendo-form-control""><inputtype=""date""class=""ef-date-pickeref-kendo-form-controlefDatePicker""title=""""id=""Mydatepicker""name=""Mydatepicker""value=""""placeholder=""DD/MM/YYYY""efKendoDateFormat=""dd/MM/yyyy""></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.dateRangeTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,58872.381542</TimeChanged>
<TimeCreated>64204,52642.759507</TimeCreated>

<Method name="TestDateRange">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "My date ranger"
	set storage.inputType = "dateRange"
	set storage.labelText = "Please enter your date span"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)
	
	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)		
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-Mydateranger""class=""control-labelef-control-label""for=""Mydateranger"">Pleaseenteryourdatespan</label></div><divclass=""col-sm-8ef-input-container""><divclass=""ef-input-short""><inputtype=""date""class=""ef-date-pickeref-kendo-form-controlefDateRangeStartefDatePicker""title=""""id=""Mydateranger-startDate""name=""Mydateranger-startDate""value=""""placeholder=""DD/MM/YYYY""efdaterangeendid=""Mydateranger-endDate""efKendoDateFormat=""dd/MM/yyyy""></div><divstyle='float:left;text-align:left;margin-left:15px;margin-right:15px;'>to</div><divclass=""ef-input-short""><inputtype=""date""class=""ef-date-pickeref-kendo-form-controlefDateRangeEndefDatePicker""title=""""id=""Mydateranger-endDate""name=""Mydateranger-endDate""value=""""placeholder=""DD/MM/YYYY""efdaterangestartid=""Mydateranger-startDate""efKendoDateFormat=""dd/MM/yyyy""></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.dropdownTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,58920.134497</TimeChanged>
<TimeCreated>64204,52666.398429</TimeCreated>

<Method name="TestPageWithDropdown">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1

	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "My dropdown"
	set storage.inputType = "dropdown"
	set storage.labelText = "Please choose your weapon"

	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 1"
	set alternative.displayText = "option 1"
	do storage.listOfAlternatives.Insert( alternative)

	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 2"
	set alternative.displayText = "option 2"
	do storage.listOfAlternatives.Insert( alternative)

	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 2"
	set alternative.displayText = "option 2"
	do storage.listOfAlternatives.Insert( alternative)

	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
		
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-Mydropdown""class=""control-labelef-control-label""for=""Mydropdown"">Pleasechooseyourweapon</label></div><divclass=""col-sm-8ef-input-container""><selectclass=""form-controlef-inputef-dropdown-list""name=""Mydropdown""id=""Mydropdown""title=""""><optionvalue=""option1""class="""">option1</option><optionvalue=""option2""class="""">option2</option><optionvalue=""option2""class="""">option2</option></select></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestPageWithDropdownMandatory">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "My dropdown"
	set storage.inputType = "dropdown"
	set storage.labelText = "Please choose your weapon"
	set storage.isMandatory = 1
	
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 1"
	set alternative.displayText = "option 1"
	do storage.listOfAlternatives.Insert( alternative)
	
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 2"
	set alternative.displayText = "option 2"
	do storage.listOfAlternatives.Insert( alternative)

	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 2"
	set alternative.displayText = "option 2"
	do storage.listOfAlternatives.Insert( alternative)
		
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)
	
	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
		
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")	
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-Mydropdown""class=""control-labelef-control-labelef-required-field""for=""Mydropdown"">Pleasechooseyourweapon</label></div><divclass=""col-sm-8ef-input-container""><selectclass=""form-controlef-inputef-dropdown-list""name=""Mydropdown""id=""Mydropdown""title=""""><optionvalue=''selecteddisabled>Chooseone...</option><optionvalue=""option1""class="""">option1</option><optionvalue=""option2""class="""">option2</option><optionvalue=""option2""class="""">option2</option></select></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestPageWithDropdownPreSelected">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "My dropdown"
	set storage.inputType = "dropdown"
	set storage.labelText = "Please choose your weapon"
	set storage.testValue = "option 1"
	
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 1"
	set alternative.displayText = "option 1"
	do storage.listOfAlternatives.Insert( alternative)
	
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 2"
	set alternative.displayText = "option 2"
	do storage.listOfAlternatives.Insert( alternative)

	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).%New()
	set alternative.value = "option 2"
	set alternative.displayText = "option 2"
	do storage.listOfAlternatives.Insert( alternative)
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)
	
	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
		
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")	
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-Mydropdown""class=""control-labelef-control-label""for=""Mydropdown"">Pleasechooseyourweapon</label></div><divclass=""col-sm-8ef-input-container""><selectclass=""form-controlef-inputef-dropdown-list""name=""Mydropdown""id=""Mydropdown""title=""""><optionselected=""""value=""option1""class="""">option1</option><optionvalue=""option2""class="""">option2</option><optionvalue=""option2""class="""">option2</option></select></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.emailInputMultiTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,59163.420373</TimeChanged>
<TimeCreated>64204,52684.401246</TimeCreated>

<Method name="TestMultiEmail">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "email"
	set storage.inputType = "multiEmailAddress"
	set storage.labelText = "Please enter all your email addresses"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent","unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-email""class=""control-labelef-control-label""for=""email"">Pleaseenterallyouremailaddresses</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""email""class=""ef-inputform-controlef-input-text-field""title=""""id=""email""name=""email""value=""""placeholder=""""pattern=""^(([a-zA-Z0-9_\-\.&#39;]+)(\+[a-zA-Z0-9_\-\.&#39;]+){0,1}@(([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,63}|[0-9]{1,3}))(\s*[;,]\s*(([a-zA-Z0-9_\-\.&#39;]+)(\+[a-zA-Z0-9_\-\.&#39;]+){0,1}@(([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,63}|[0-9]{1,3})))*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenterallyouremailaddresses\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.emailInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,61633.556618</TimeChanged>
<TimeCreated>64204,52696.984856</TimeCreated>

<Method name="TestEmail">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "email"
	set storage.inputType = "emailAddress"
	set storage.labelText = "Please enter your email address"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-email""class=""control-labelef-control-label""for=""email"">Pleaseenteryouremailaddress</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""email""class=""ef-inputform-controlef-input-text-field""title=""""id=""email""name=""email""value=""""placeholder=""""pattern=""^(([a-zA-Z0-9_\-\.&#39;]+)(\+[a-zA-Z0-9_\-\.&#39;]+){0,1}@(([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,63}|[0-9]{1,3}))$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryouremailaddress\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.fileUploadInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64266,50628.336907</TimeChanged>
<TimeCreated>64209,55088.607809</TimeCreated>

<Method name="TestFileUpload">
<Implementation><![CDATA[
	/* commented out until we implment the uploader for real
	set eventConfiguration = ##class(setup.eventConfiguration.storageMock).createEventConfiguration()
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	set contextData.prowebMode = "preview"
	
	set storage = ##class(sc.facade.prowebItemStorageFileUploadMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "file"
	set storage.inputType = "fileUpload"
	set storage.labelText = "Please upload your photo"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.pagesFrontend.registration).createNew(contextData,,,eventConfiguration)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-proweb-1""class=""control-labelef-control-label""for=""proweb-1"">Pleaseuploadyourphoto</label></div><divclass=""col-sm-8ef-input-container""><scriptid='fileTemplate_fileUpload'type='text/x-kendo-template'><divclass='ef_frontend_file_upload_progress_container'><divclass='k-progress'></div><divclass='ef_file_wrapper'><spanstyle='width:50%;'class='blackbold12px'>#=name##=ef_uploader_show_file_size(size)#</span><spanstyle='width:50%;float:right;'class='blackbold12px'id='ef-kendo-uploader-processing'></span></div></div></script><scriptlanguage='javascript'>varef=ef||{};ef.fileUploader=ef.fileUploader||{};$(document).ready(function(){varuploaderInput=$(""#fileUpload"");uploaderInput.kendoUpload({complete:onComplete,upload:onUpload,success:onSuccess,error:onError,progress:onProgress,showFileList:true,multiple:false,localization:{select:'Upload…'},async:{},template:kendo.template($('#fileTemplate_fileUpload').html())});functiononSuccess(e){if(e.response.status=='ok'){$('.k-upload-status').remove();$('.k-upload-files').remove();varuploadedFileDiv='<trid=""ef_uploaded_file_'+e.response.fileItem.objectID+'""class=""ef_file_wrapper""><tdclass=""black10px""><atarget=""_blank""href=""'+e.response.fileItem.openURL+'"">'+e.response.fileItem.name+'</a>'+Math.floor(e.response.fileItem.size/1024)+'kB</td><tdclass=""black9px"">'+e.response.fileItem.formattedDate+''+e.response.fileItem.formattedTime+'</td><tdclass=""black9px""><aclass=""noWarn""href=""'+e.response.fileItem.deleteURL+'"">remove</a></td></tr>'$('#fileUpload_1').append(uploadedFileDiv);}else{$('.k-upload-files').remove();alert(e.response.errorMsg)}}functiononError(e){alert('Therewasaproblemuploadingyourfile');$('.k-upload-files').remove();}functiononComplete(e){if(typeofef.fileUploader.onCompleteCallback===""function""){ef.fileUploader.onCompleteCallback()}}functiononUpload(e){if(typeofef.fileUploader.onUploadCallback===""function""){ef.fileUploader.onUploadCallback()}}functiononProgress(e){}});</script><divid=""fileUpload_container""class=""ef_frontend_file_uploaderk-content""><inputtype=""file""name=""fileUpload""id=""fileUpload""title=""Upload""></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
	*/
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.integerInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,61699.894626</TimeChanged>
<TimeCreated>64204,52712.809439</TimeCreated>

<Method name="TestInteger">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "my int"
	set storage.inputType = "integer"
	set storage.labelText = "Please enter your height in cm"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData) // #### change
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController, "renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-myint""class=""control-labelef-control-label""for=""myint"">Pleaseenteryourheightincm</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""number""class=""form-controlef-inputef-input-shortef-input-short""title=""""id=""myint""name=""myint""value=""""placeholder=""""pattern=""^([\+\-]){0,1}\d+$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryourheightincm\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.numericInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,61746.002591</TimeChanged>
<TimeCreated>64204,52723.013439</TimeCreated>

<Method name="TestNumeric">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "my floating point number"
	set storage.inputType = "floatingPointNumber"
	set storage.labelText = "Please enter your height in kilometers"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData) // #### change
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent","unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-myfloatingpointnumber""class=""control-labelef-control-label""for=""myfloatingpointnumber"">Pleaseenteryourheightinkilometers</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""form-controlef-inputef-input-short""title=""""id=""myfloatingpointnumber""name=""myfloatingpointnumber""value=""""placeholder=""""pattern=""^[+-]?((0)|([1-9][0-9]*?))?(\.[0-9]{1,2})?$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryourheightinkilometers\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.pageTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64310,53192.860447</TimeChanged>
<TimeCreated>64189,44993.632692</TimeCreated>

<Method name="TestEditModeHTML">
<Implementation><![CDATA[
	set floatingMenu = ##class(EF.ui.components.frontend.floatingMenu).%New()
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(floatingMenu,"outputFloatingMenuHTML")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divid=""myFloater""class=""form-inlineef-proweb-menu-handle""style=""display:none;""><divclass=""ef-editor-floater-button-group""><buttontype=""button""id=""efProwebEditLink""class=""btnbtn-default""><spanclass=""glyphiconglyphicon-pencil""></span></button><buttontype=""button""id=""efProwebDeleteLink""class=""btnbtn-default""style=""float:left;""><spanclass=""glyphiconglyphicon-trash""></span></button><buttontype=""button""id=""efProwebDropdownLink""class=""btnbtn-defaultdropdown-toggle""data-toggle=""dropdown""><spanclass=""glyphiconglyphicon-plus""></span><spanclass=""caret""></span></button><ulclass=""dropdown-menu""role=""menu""><li><aclass=""ef-proweb-dropdown-link""id=""efProwebInsertQuestionBelowLink""tabindex=""-1""href=""#"">Question</a></li><li><aclass=""ef-proweb-dropdown-link""id=""efProwebInsertABIBelowLink""tabindex=""-1""href=""#"">ABI</a></li><li><aclass=""ef-proweb-dropdown-link""id=""efProwebInsertQBIBelowLink""tabindex=""-1""href=""#"">QBI</a></li><li><aclass=""ef-proweb-dropdown-link""id=""efProwebInsertTextBlockBelowLink""href=""#"">Text</a></li><li><aclass=""ef-proweb-dropdown-link""id=""efProwebInsertDividerBelowLink""href=""#"">Divider</a></li><li><aclass=""ef-proweb-dropdown-link""id=""efProwebInsertRegPromptCollectionBelowLink""tabindex=""-1""href=""#"">Collection</a></li><li><aclass=""ef-proweb-dropdown-link""id=""efProwebInsertFileUploadBelowLink""href=""#"">Fileupload</a></li><li><aclass=""ef-proweb-dropdown-link""id=""efProwebInsertYouTubeVideoBelowLink""href=""#"">Video</a></li></ul></div></div><divclass=""ef-Quick-Edit-Panel""style=""display:none;padding:5px;""><divid=""topButtonsQuickEdit""><buttontype=""button""id=""quickEditSave""class=""glyphiconglyphicon-ok""></button><buttontype=""button""id=""quickEditClose""class=""glyphiconglyphicon-remove""></button><divstyle=""float:right;""><buttontype=""button""id=""quickEditAdvanced"">Advanced…</button></div></div><divid=""quickEditPanelMain"">[EDITPANEL]</div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestGuestPromptsPanel">
<Implementation><![CDATA[
	#dim storage as sc.facade.prowebItemStorageInputElementMock
	#dim contextData as EF.contextDataRegistrationMock
	#dim pageController as EF.pageController.proweb.page
	#define maxGuests 2
	
	;set eventConfiguration = ##class(setup.eventConfiguration.storageMock).createEventConfiguration()
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	;set eventConfiguration.storage.maxGuests = 2
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "Firstname"
	set storage.inputType = "text"
	set storage.labelText = "Attendee First Name"
	set storage.isMandatory = 1
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "2"
	set storage.databaseItemName = "Lastname"
	set storage.inputType = "text"
	set storage.labelText = "Attendee Last Name"
	set storage.isMandatory = 1
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData, $$$maxGuests)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent","unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""ef-panelef-draggable-div""data-show-hide-dependency-list=""{&quot;logic&quot;:&quot;and&quot;,&quot;dependencies&quot;:[{&quot;parentName&quot;:&quot;ef-is-guest-active-1&quot;,&quot;parentId&quot;:&quot;ef-is-guest-active-1&quot;,&quot;operator&quot;:&quot;eq&quot;,&quot;value&quot;:&quot;1&quot;}]}""><divclass=""ef-panel-heading""id="""">Guest<divclass=""ef-delete-guest-button""data-ef-guest-number=""1""><spanclass=""glyphiconglyphicon-trash""/></div></div><divclass=""ef-panel-bodyef-proweb-reorderable-guest""><divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-Firstname-1""class=""control-labelef-control-labelef-required-field""for=""Firstname-1"">AttendeeFirstName</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-field""title=""""id=""Firstname-1""name=""Firstname-1""value=""""placeholder=""""data-enable-disable-dependency-list=""{&quot;logic&quot;:&quot;and&quot;,&quot;dependencies&quot;:[{&quot;parentName&quot;:&quot;ef-is-guest-active-1&quot;,&quot;parentId&quot;:&quot;ef-is-guest-active-1&quot;,&quot;operator&quot;:&quot;eq&quot;,&quot;value&quot;:&quot;1&quot;}]}""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;AttendeeFirstName\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div><divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-Lastname-1""class=""control-labelef-control-labelef-required-field""for=""Lastname-1"">AttendeeLastName</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-field""title=""""id=""Lastname-1""name=""Lastname-1""value=""""placeholder=""""data-enable-disable-dependency-list=""{&quot;logic&quot;:&quot;and&quot;,&quot;dependencies&quot;:[{&quot;parentName&quot;:&quot;ef-is-guest-active-1&quot;,&quot;parentId&quot;:&quot;ef-is-guest-active-1&quot;,&quot;operator&quot;:&quot;eq&quot;,&quot;value&quot;:&quot;1&quot;}]}""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;AttendeeLastName\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""0></div></div></div></div></div><divclass=""ef-panelef-draggable-div""data-show-hide-dependency-list=""{&quot;logic&quot;:&quot;and&quot;,&quot;dependencies&quot;:[{&quot;parentName&quot;:&quot;ef-is-guest-active-2&quot;,&quot;parentId&quot;:&quot;ef-is-guest-active-2&quot;,&quot;operator&quot;:&quot;eq&quot;,&quot;value&quot;:&quot;1&quot;}]}""><divclass=""ef-panel-heading""id="""">Guest<divclass=""ef-delete-guest-button""data-ef-guest-number=""2""><spanclass=""glyphiconglyphicon-trash""/></div></div><divclass=""ef-panel-bodyef-proweb-reorderable-guest""><divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-Firstname-2""class=""control-labelef-control-labelef-required-field""for=""Firstname-2"">AttendeeFirstName</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-field""title=""""id=""Firstname-2""name=""Firstname-2""value=""""placeholder=""""data-enable-disable-dependency-list=""{&quot;logic&quot;:&quot;and&quot;,&quot;dependencies&quot;:[{&quot;parentName&quot;:&quot;ef-is-guest-active-2&quot;,&quot;parentId&quot;:&quot;ef-is-guest-active-2&quot;,&quot;operator&quot;:&quot;eq&quot;,&quot;value&quot;:&quot;1&quot;}]}""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;AttendeeFirstName\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div><divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-Lastname-2""class=""control-labelef-control-labelef-required-field""for=""Lastname-2"">AttendeeLastName</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-field""title=""""id=""Lastname-2""name=""Lastname-2""value=""""placeholder=""""data-enable-disable-dependency-list=""{&quot;logic&quot;:&quot;and&quot;,&quot;dependencies&quot;:[{&quot;parentName&quot;:&quot;ef-is-guest-active-2&quot;,&quot;parentId&quot;:&quot;ef-is-guest-active-2&quot;,&quot;operator&quot;:&quot;eq&quot;,&quot;value&quot;:&quot;1&quot;}]}""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;AttendeeLastName\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""0></div></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.passwordInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,61808.836257</TimeChanged>
<TimeCreated>64208,51641.871984</TimeCreated>

<Method name="TestPasswordInput">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "Password"
	set storage.inputType = "password"
	set storage.labelText = "Please enter your password"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData) // #### change
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent","unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-Password""class=""control-labelef-control-label""for=""Password"">Pleaseenteryourpassword</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""password""class=""ef-inputform-controlef-input-text-field""title=""""id=""Password""name=""Password""value=""""placeholder=""""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.phoneNumberTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,61894.308212</TimeChanged>
<TimeCreated>64204,52750.117876</TimeCreated>

<Method name="TestPhoneNumber">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "phoneNumber"
	set storage.inputType = "phoneNumber"
	set storage.labelText = "Please enter your phone number"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData) // #### change
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent","unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-phoneNumber""class=""control-labelef-control-label""for=""phoneNumber"">Pleaseenteryourphonenumber</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""tel""class=""ef-inputform-controlef-input-text-fieldef-input-short""title=""""id=""phoneNumber""name=""phoneNumber""value=""""placeholder=""""pattern=""^(?!(.*-(\s)*-.*))(?!(.*\.(\s)*\..*))(?=.*[\d\)](\s)*$)(?=.*(\d)+.*)(\+(\d){1,3}){0,1}(?=\s*([\d\(]).*)(([\d\s\-\.])|(\(([\d\-\.\s])+\)))*(\s)*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryourphonenumber\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.radioButtonsTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,62059.38508</TimeChanged>
<TimeCreated>64204,52760.35415</TimeCreated>

<Method name="TestRadioButtonsABI">
<Implementation><![CDATA[
	#dim eventConfiguration as setup.eventConfiguration.storageDatabase
	#dim contextData as EF.contextDataRegistrationMock
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.currencyID = 1
	set elementIdentifier = "proweb-1"
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "MYRADIO"
	set storage.inputType = "radiobutton"
	set storage.labelText = "Please select your option"
	
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternativeMock).createMock("option 1", "option 1",1,666)
	do storage.listOfAlternatives.Insert( alternative)
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternativeMock).createMock("option 2", "option 2")
	do storage.listOfAlternatives.Insert( alternative)
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternativeMock).createMock("option 3", "option 3")
	do storage.listOfAlternatives.Insert( alternative)
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
			
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-containeref-label-container-vertical-group""><labelid=""ef-display-label-MYRADIO""class=""control-labelef-control-label""for=""MYRADIO"">Pleaseselectyouroption</label></div><divclass=""col-sm-8ef-input-containeref-radio-group""><divclass=""ef-input""><divclass=""ef-radio-button""><labelclass=""ef-control-labelactive""class=""ef-radio-button""id=""MYRADIO_1-label""><inputtype=""radio""checkedclass=""ef-radio-button""value=""option1""name=""MYRADIO""id=""MYRADIO_1"">&nbsp;option1&nbsp;&nbsp;</label></div><divclass=""ef-radio-button""><labelclass=""ef-control-label""class=""ef-radio-button""id=""MYRADIO_2-label""><inputtype=""radio""class=""ef-radio-button""value=""option2""name=""MYRADIO""id=""MYRADIO_2"">&nbsp;option2</label></div><divclass=""ef-radio-button""><labelclass=""ef-control-label""class=""ef-radio-button""id=""MYRADIO_3-label""><inputtype=""radio""class=""ef-radio-button""value=""option3""name=""MYRADIO""id=""MYRADIO_3"">&nbsp;option3</label></div></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestWithRadioButtons">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set elementIdentifier = "proweb-1"
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "MYRADIO"
	set storage.inputType = "radiobutton"
	set storage.labelText = "Please select your option"
	
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternativeMock).createMock("option 1", "option 1")
	do storage.listOfAlternatives.Insert( alternative)
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternativeMock).createMock("option 2", "option 2")
	do storage.listOfAlternatives.Insert( alternative)
	set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternativeMock).createMock("option 3", "option 3")
	do storage.listOfAlternatives.Insert( alternative)
	

	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
			
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-containeref-label-container-vertical-group""><labelid=""ef-display-label-MYRADIO""class=""control-labelef-control-label""for=""MYRADIO"">Pleaseselectyouroption</label></div><divclass=""col-sm-8ef-input-containeref-radio-group""><divclass=""ef-input""><divclass=""ef-radio-button""><labelclass=""ef-control-labelactive""class=""ef-radio-button""id=""MYRADIO_1-label""><inputtype=""radio""checkedclass=""ef-radio-button""value=""option1""name=""MYRADIO""id=""MYRADIO_1"">&nbsp;option1</label></div><divclass=""ef-radio-button""><labelclass=""ef-control-label""class=""ef-radio-button""id=""MYRADIO_2-label""><inputtype=""radio""class=""ef-radio-button""value=""option2""name=""MYRADIO""id=""MYRADIO_2"">&nbsp;option2</label></div><divclass=""ef-radio-button""><labelclass=""ef-control-label""class=""ef-radio-button""id=""MYRADIO_3-label""><inputtype=""radio""class=""ef-radio-button""value=""option3""name=""MYRADIO""id=""MYRADIO_3"">&nbsp;option3</label></div></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.textAreaTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,62154.222185</TimeChanged>
<TimeCreated>64204,52770.974784</TimeCreated>

<Method name="TestTextArea">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "mytext"
	set storage.inputType = "textarea"
	set storage.labelText = "Please enter your essay"
	set storage.testValue = "LOREM IPSUM"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-mytext""class=""control-labelef-control-label""for=""mytext"">Pleaseenteryouressay</label></div><divclass=""col-sm-8ef-input-container""><textareatype=""text""class=""ef-inputform-controlef-input-text-area""title=""""id=""mytext""name=""mytext""rows=""""placeholder="""">LOREMIPSUM</textArea></div></div></div>"
					 
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.textBlockTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,62202.89866</TimeChanged>
<TimeCreated>64204,52784.358512</TimeCreated>

<Method name="TestBasicPageWithTextBlock">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageTextBlockMock).createNew()
	set storage.prowebID = "1"
	set storage.text = "LOREM IPSUM"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""col-sm-12""><divclass=""ef-text-block"">LOREMIPSUM</div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.textInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64310,55680.591549</TimeChanged>
<TimeCreated>64204,52795.592181</TimeCreated>

<Method name="TestbasicInputField">
<Implementation><![CDATA[
	;set eventConfiguration = ##class(setup.eventConfiguration.storageMock).createEventConfiguration() // ### change
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	//set contextData.prowebMode = "preview" // #### change
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "name"
	set storage.inputType = "text"
	set storage.labelText = "Please enter your name"
	
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData) // #### change
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-name""class=""control-labelef-control-label""for=""name"">Pleaseenteryourname</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-field""title=""""id=""name""name=""name""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryourname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestAriaLabel">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "name"
	set storage.inputType = "text"
	set storage.labelText = ""
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-field""title=""""id=""name""name=""name""value=""""placeholder=""""aria-label=""name""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestBackendOnlyFieldAsBackendBooking">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 1
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "name"
	set storage.inputType = "text"
	set storage.labelText = "Please enter your name"
	set storage.isMandatory = 1
	set storage.isBackendOnly = 1
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-name""class=""control-labelef-control-labelef-required-field""for=""name"">Pleaseenteryourname</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-fieldef-admin-only""title=""""id=""name""name=""name""value=""""placeholder=""(Adminportalonly)""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryourname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestBasicPageWithMandatoryTextField">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "name"
	set storage.inputType = "text"
	set storage.labelText = "Please enter your name"
	set storage.isMandatory = 1
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-name""class=""control-labelef-control-labelef-required-field""for=""name"">Pleaseenteryourname</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-field""title=""""id=""name""name=""name""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryourname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestBackendOnlyFieldAsFrontendBooking">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 0
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "name"
	set storage.inputType = "text"
	set storage.labelText = "Please enter your name"
	set storage.isMandatory = 1
	set storage.isBackendOnly = 1
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = ""
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestBackendOnlyFieldInEditMode">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set contextData.isBackendBooking = 0
	set contextData.prowebMode = "edit"

	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "name"
	set storage.inputType = "text"
	set storage.labelText = "Please enter your name"
	set storage.isBackendOnly = 1
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-draggable-divef-form-rowef-form-row-editable""id=""ef-field-proweb-1""data-proweb-id=""1""data-proweb-list-id=""""data-ui-component-type=""textInput""data-proweb-allowed-types=""Question,ABI,QBI,Collection,Divider,Text,Fileupload,Video""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-name""class=""control-labelef-control-label""for=""name"">Pleaseenteryourname</label><divclass=""ef-proweb-direct-label-edit""style=""display:none;""id=""ef-edit-label-input-name""data-proweb-id=""1""><inputclass=""ef-control-label""id=""quick-edit-name""type=""text""value=""Pleaseenteryourname""></div></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-fieldef-admin-only""title=""""id=""name""name=""name""value=""""placeholder=""(Adminportalonly)""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryourname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestDefaultvalue">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()

	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "name"
	set storage.inputType = "text"
	set storage.labelText = "Please enter your name"
	set storage.defaultValue = "Elvis, of course!"
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-name""class=""control-labelef-control-label""for=""name"">Pleaseenteryourname</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-field""title=""""id=""name""name=""name""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryourname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestHelpText">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "name"
	set storage.inputType = "text"
	set storage.labelText = "Please enter your name"
	set storage.helpText = "Help me!"
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-name""class=""control-labelef-control-label""for=""name"">Pleaseenteryourname</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-field""title=""""id=""name""name=""name""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryourname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0><spanclass=""glyphiconglyphicon-question-signef-help-icon""title=""Helpme!""></span></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestReadOnlyField">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()

	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "name"
	set storage.inputType = "text"
	set storage.labelText = "Please enter your name"
	set storage.isReadOnly = 1
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-name""class=""control-labelef-control-label""for=""name"">Pleaseenteryourname</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""text""class=""ef-inputform-controlef-input-text-field""disabled='disabled'title=""""id=""name""name=""name""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Pleaseenteryourname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.timeInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,62284.186726</TimeChanged>
<TimeCreated>64204,52806.787409</TimeCreated>

<Method name="TestTime">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()

	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "name"
	set storage.inputType = "time"
	set storage.labelText = "Please enter your time"

	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)

	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-name""class=""control-labelef-control-label""for=""name"">Pleaseenteryourtime</label></div><divclass=""col-sm-8ef-input-container""><divstyle=""width:40%""class=""ef-time-pickeref_proweb_form_field_container_type_timeef-kendo-form-control""><inputtype=""text""class=""ef-time-pickeref_proweb_form_field_container_type_timeef-kendo-form-controlefTimePicker""title=""""id=""name""name=""name""value=""""placeholder=""HH:MM24hour""autofocus=""autofocus""efKendoTimeFormat=""24""efKendoTimeInterval=15style=""width:100%;""></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.webAddressTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,62332.86746</TimeChanged>
<TimeCreated>64204,51604.334511</TimeCreated>

<Method name="TestWebAddress">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()

	set storage = ##class(sc.facade.prowebItemStorageInputElementMock).createNew()
	set storage.prowebID = "1"
	set storage.databaseItemName = "url"
	set storage.inputType = "webAddress"
	set storage.labelText = "Please enter your URL"

	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""form-group""><divclass=""col-sm-4ef-label-container""><labelid=""ef-display-label-url""class=""control-labelef-control-label""for=""url"">PleaseenteryourURL</label></div><divclass=""col-sm-8ef-input-container""><inputtype=""url""class=""ef-inputform-controlef-input-text-field""title=""""id=""url""name=""url""value=""""placeholder=""""pattern=""^(?:https?:\/\/)?(?:\S+(?::\S*)?@)?(?:(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/.*)?$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;PleaseenteryourURL\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""autofocus=""autofocus""0></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.youTubeVideoTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64309,62357.594268</TimeChanged>
<TimeCreated>64208,59801.380137</TimeCreated>

<Method name="TestYouTubeVideo">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()

	set storage = ##class(sc.facade.prowebItemStorageYouTubeVideoMock).createNew()
	set storage.prowebID = "1"
	
	set prowebItem = ##class(sc.facade.prowebItem).createNew(storage)
	do contextData.listOfProwebItemsToAdd.Insert(prowebItem)

	set pageController = ##class(EF.pageController.proweb.page).createMock(contextData)
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(pageController,"renderComponent", "unit test")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass=""rowef-form-row""><divclass=""col-sm-12""><divclass=""ef-video""><objectclassid=""clsid:D27CDB6E-AE6D-11cf-96B8-444553540000""codebase=""//download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=5,0,0,0""width=800height=600><paramname=movievalue=""https://www.youtube.com/watch?feature=player_embedded&v=sJ363mnyHEk""><paramname=qualityvalue=high><paramname=wmodevalue=transparent><paramname=""LOOP""value=""1""><paramname=""menu""value=""false""><embedsrc=""//www.youtube.com/v/sJ363mnyHEk?fs=1&amp;hl=en_GB""wmode=transparentquality=highpluginspage=""//www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash""type=""application/x-shockwave-flash""loop=""true""width=600height=360></embed></object></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.textArea">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64232,42435.73754</TimeChanged>
<TimeCreated>63403,57168.063256</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.textArea).%New(..identifier)
]]></Implementation>
</Method>

<Method name="updateValue">
<FormalSpec>value</FormalSpec>
<Implementation><![CDATA[	set ..value=$ZSTRIP(value,"<>W")
]]></Implementation>
</Method>

<Method name="updateUIComponent">
<Implementation><![CDATA[
	do ##super()
	
	set maxChars = ..prowebItem.storage.maxCharacters
	set maxWords = ..prowebItem.storage.maxWords
	
	if (maxWords) {
		set ..uiComponent.validator.maxLength = maxWords
		set ..uiComponent.validator.countType = "words"
	} elseif (maxChars) {
		set ..uiComponent.validator.maxLength = maxChars
		set ..uiComponent.validator.countType = "characters"
	}
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.textBlock">
<Super>EF.pageController.proweb.prowebBase</Super>
<TimeChanged>64264,58744.678496</TimeChanged>
<TimeCreated>64183,49747.663252</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.base</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.textBlock).%New(..identifier)
]]></Implementation>
</Method>

<Method name="initialiseUIComponent">
<FormalSpec>uiComponent:EF.ui.components.frontend.textBlock</FormalSpec>
<Implementation><![CDATA[
	do ##super(uiComponent)
	set ..uiComponent.text=..description
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.textInput">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64232,42377.018545</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.textInput).%New(..identifier)
]]></Implementation>
</Method>

<Method name="updateValue">
<FormalSpec>value</FormalSpec>
<Implementation><![CDATA[	set ..value=$ZSTRIP(value,"<>W")
]]></Implementation>
</Method>

<Method name="updateUIComponent">
<Implementation><![CDATA[
	do ##super()
	
	set maxChars = ..prowebItem.storage.maxCharacters
	set maxWords = ..prowebItem.storage.maxWords
	
	if (maxWords) {
		set ..uiComponent.validator.maxLength = maxWords
		set ..uiComponent.validator.countType = "words"
	} elseif (maxChars) {
		set ..uiComponent.validator.maxLength = maxChars
		set ..uiComponent.validator.countType = "characters"
	}
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.timeInput">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64198,33582.083553</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.timeInput).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.webAddress">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64198,62804.621561</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.webAddress).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.youTubeVideo">
<Super>EF.pageController.proweb.prowebBase</Super>
<TimeChanged>64208,58565.902899</TimeChanged>
<TimeCreated>64183,49747.663252</TimeCreated>

<Parameter name="canBeDependent">
<Type>%Boolean</Type>
<Default>0</Default>
</Parameter>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.base</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.youTubeVideo).%New(..identifier)
]]></Implementation>
</Method>

<Method name="initialiseUIComponent">
<FormalSpec>uiComponent:EF.ui.components.base</FormalSpec>
<Implementation><![CDATA[	do ##super(uiComponent)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>youTubeVideoDefaultData</DefaultData>
<Data name="youTubeVideoDefaultData">
<Subscript>"youTubeVideo"</Subscript>
<Value name="1">
<Value>youTubeVideoURL</Value>
</Value>
<Value name="2">
<Value>width</Value>
</Value>
<Value name="3">
<Value>height</Value>
</Value>
<Value name="4">
<Value>isLooped</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pages.base">
<Super>%CSP.Page,EF.htmlGenerator</Super>
<TimeChanged>64310,57964.851482</TimeChanged>
<TimeCreated>64292,52804.615476</TimeCreated>

<Parameter name="contextDataClass">
<Type>%String</Type>
</Parameter>

<Parameter name="mvcHandlerClass">
<Type>%String</Type>
</Parameter>

<Parameter name="pageNavProceedKey">
<Type>%String</Type>
</Parameter>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	#dim %zMvcHandler as EF.mvcHandler.page // This is a percent variable to make it available to the OnPageCSPROOT too
	
	// create an instance of a page manually because %CSP.Page dosn't
	// the instance is stored in a percent variable so that it can be accessed from anywhere during the page loading/rendering process 
	set %zMvcHandler = $ClassMethod(..#mvcHandlerClass, "createNew")
	
	if '$IsObject(%zMvcHandler) {
		throw ##class(shared.exceptions.generalException).%New("Failed to create %zMvcHandler object")
	}
	
	set %zMvcHandler.pageClass = $ClassName()
	
	// the order of the lines below is extremely important
	set %zMvcHandler.contextData = ..getContextData()

	do %zMvcHandler.updateEventID()
	
	if '$IsObject(%zMvcHandler.contextData) {
			throw ##class(shared.exceptions.generalException).%New("Failed to create contextData in page")
	}

	set %zMvcHandler.contextData.request = %request
	set %zMvcHandler.pageNavProceedKey = ..#pageNavProceedKey
	
	// load all the data and populate the security handler
	do %zMvcHandler.loadData()

	do %zMvcHandler.performSecurityChecks()
	if '%zMvcHandler.isOkToRenderPage {
		set %response.Redirect = %zMvcHandler.redirectPage_"?reasonForRedirect="_..encodeURLParameter(%zMvcHandler.reasonForRedirect)
		return 0	
	}
	
	return %zMvcHandler.isOkToRenderPage
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	if $IsObject(%zMvcHandler) {
		do %zMvcHandler.renderView()
	} else {
		throw ##class(shared.exceptions.generalException).%New("No %zMvcHandler object present in OnPageCSPROOT")
	}
]]></Implementation>
</Method>

<Method name="getContextData">
<ClassMethod>1</ClassMethod>
<ReturnType>EF.contextData</ReturnType>
<Implementation><![CDATA[	return $ClassMethod(..#contextDataClass, "createFromFrontendCSPSession")
]]></Implementation>
</Method>
</Class>


<Class name="EF.pages.frontend.base">
<Description><![CDATA[
Common page that all frontend pages could/should inherit from.
<!-- ;vc;
;vc;    Object: EF.pages.frontend.base.CLS/EV.13
;vc; Component: CLS.EF.pages.frontend.base
;vc;  Location: LargeDev
;vc; Date/Time: 10-Jan-17 12:23
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.pages.frontend.base.CLS/EV.13</td><td>CLS.EF.pages.frontend.base</td><td>LargeDev</td><td style='white-space: nowrap;'>10-Jan-17 12:23</td><td>AdrianM2</td></tr></table>
]]></Description>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>shared.pCSPmanage</Super>
<TimeChanged>64293,40135</TimeChanged>
<TimeCreated>63635,40114.778424</TimeCreated>

<Parameter name="showRegistrationProgressBar">
<Default>0</Default>
</Parameter>

<Parameter name="hasRegistrationQuestions">
<Default>0</Default>
</Parameter>

<Parameter name="efUsePageController">
<Type>%Boolean</Type>
<Default>1</Default>
</Parameter>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	
	Do ..OnPageCSPROOT()
	
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set sessionID = %session.SessionId
	do ..OnPagePageTop()
	do ..OnPagePageContent()
	do ..OnPagePageBottom()
]]></Implementation>
</Method>

<Method name="OnPagePageTop">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	w ##class(shared.pageMethods).outputFrontendHeader()
	Write !,"<head>"
	Write !
 	do ##class(layout.objTemplate).writeBit("","{{ef_header}}")
	Write !
	Do ..Include("frontendHTTPheader.csp")
	Write !
	Do ..Include("colourScheme.csp")
	do ..renderCommonCSS()
	do ..OnPagePageHeaderCSS()
	do ..renderCommonJavascript()
	do ..outputMetaTags()
	Write !,!,"</head>"
	Write !,"<body class=""bodyBackground"">"
	Write !,!,!,!
	set app=##class(sc.objData).applicationPath()
	if ..#hasRegistrationQuestions {
		set isCOD = 1
	}
	do ##class(cspRealEV.system.proweb.templatestart).OnPageCSPROOT()
	
 	do ##class(layout.objTemplate).writeBit("{{ef_header}}","{{ef_banner}}")
 	do ##class(layout.objTemplate).writeBit("{{ef_banner}}","{{ef_main_progress}}")
 	if ..#showRegistrationProgressBar {
		if ($G(%session.Data("mode"))="preview")!($G(%session.Data("inSitePageEditing"))) {
			if '%request.Get("hideButtons") {
				Do ..Include("progress.csp")
			}
		}
 	}
 	do ##class(layout.objTemplate).writeBit("{{ef_main_progress}}","{{ef_main_header}}")
]]></Implementation>
</Method>

<Method name="OnPagePageHeaderCSS">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="outputMetaTags">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="renderCommonCSS">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="renderCommonJavascript">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="OnPagePageBottom">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	do ##class(layout.objTemplate).writeBit("{{ef_main_buttons}}","{{ef_footer}}")
	do ##class(layout.objTemplate).writeBit("{{ef_footer}}","")
	Do ..Include("editingFooter.csp")
	set app=##class(sc.objData).applicationPath()
	do ##class(cspRealEV.system.proweb.templatestop).OnPageCSPROOT()
	Write !,!,"</body>"
	Write !,"</html>",!
]]></Implementation>
</Method>

<Method name="OnPagePageContent">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="outputProwebListRows">
<Description>
this is for version 1 of proweb</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>componentName,pageID,isHTMLTable:%Boolean,paramIsRepeatedList:%Boolean=0</FormalSpec>
<Implementation><![CDATA[
	set beforeItem=##class(sc.xModules.objPage).getBeforeItem(pageID)
	new pageURL,app
	// Clear previously set component 
	KILL %session.Data("beforeRow")
	KILL %session.Data("afterRow")
	KILL %session.Data("beforeItem")
	KILL %session.Data("afterItem")
	KILL %session.Data("componentName")
	// retrieve the passed component name
	set %session.Data("beforeRow")=""
	set %session.Data("afterRow")=""
	if isHTMLTable {
		set %session.Data("beforeItem")=(beforeItem)
		set %session.Data("afterItem")="</TD></TR>"
	} else {
		set %session.Data("beforeItem")=""
		set %session.Data("afterItem")="" 	
	}
	set %session.Data("componentName")=componentName
	set isRepeatedList=paramIsRepeatedList
	set app=##class(sc.objData).applicationPath()
	set pageURL=app_"/system/proweb/tagFree.csp"
	do ##class(cspRealEV.system.proweb.tagfree).OnPageCSPROOT()
]]></Implementation>
</Method>

<Method name="outputProwebList">
<ClassMethod>1</ClassMethod>
<FormalSpec>componentName,pageID</FormalSpec>
<Implementation><![CDATA[
	&html<<table border=0 cellpadding=0 cellspacing=0 class="black10px" width="100%">>
	do ..outputProwebListRows(componentName,pageID,1)
	&html<</table>>
]]></Implementation>
</Method>

<Method name="isPageBeingEditedOrPreviewed">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ##class(shared.pageMethodsFrontend).isPageBeingEditedOrPreviewed()
]]></Implementation>
</Method>

<Method name="usePageController">
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ..#efUsePageController
]]></Implementation>
</Method>

<Method name="getPageDataClassName">
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "EF.pageController.pagesFrontend."_$Piece($Piece(..#CSPFILE, "\", *), ".", 1)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pages.frontend.baseProweb">
<ProcedureBlock>0</ProcedureBlock>
<Super>EF.pages.frontend.base</Super>
<TimeChanged>64294,46019.231858</TimeChanged>
<TimeCreated>64191,31442.531402</TimeCreated>

<Parameter name="ENCODED">
<Default>1</Default>
</Parameter>

<Parameter name="PRIVATE">
<Default>0</Default>
</Parameter>

<Parameter name="efPageGenerationNumber">
<Type>%Integer</Type>
<Default>4</Default>
</Parameter>

<Parameter name="efUsePageController">
<Type>%Boolean</Type>
<Default>1</Default>
</Parameter>

<Parameter name="efFormName">
<Type>%String</Type>
<Default>myForm</Default>
</Parameter>

<Parameter name="efFormID">
<Type>%String</Type>
<Default>EFFrontendForm</Default>
</Parameter>

<Parameter name="efServerStorageSaveLevel">
<Type>%String</Type>
<Default>event</Default>
</Parameter>

<Parameter name="efRenderMainModal">
<Type>%Boolean</Type>
<Default>1</Default>
</Parameter>

<Parameter name="efFormAction">
<Type>%String</Type>
<Default>pageControllerStandardSave.csp</Default>
</Parameter>

<Parameter name="pageNavProceedKey">
<Type>%String</Type>
</Parameter>

<Parameter name="contextDataClass">
<Type>%String</Type>
</Parameter>

<Property name="pageControllerID">
<Type>%String</Type>
</Property>

<Method name="initPageController">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	#dim pageController as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistration).createFromFrontendCSPSession()
	if ..usePageController() {
		set pageControllerID=%request.Get("prowebPageControllerID")
		
		merge requestData=%request.Data
		if pageControllerID { // when reloading the page after an validation error
			do ..beforePageControllerReload(pageControllerID)
			set pageController=##class(EF.pageController.page).open(pageControllerID,contextData)
			set contextData.pageID = pageController.prowebPageID

		} else { // regular loading of a page
			set contextData.pageID = %request.Get("pageID")
			set pageController=$CLASSMETHOD(..getPageDataClassName(),"createNew",contextData,.requestData)
			set pageController.isReadOnly = 0
			set pageController.prowebPageID = %request.Get("pageID")
			set sc = pageController.%Save()
			if 'sc {
				throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
			}
		}
		set pageControllerID=pageController.%Id()
	}
]]></Implementation>
</Method>

<Method name="OnPagePageTop">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	write ##class(shared.pageMethods).outputFrontendHeader()
	Write !,"<head>"
 	
 	do ##class(layout.objTemplate).writeBit("","{{ef_header}}")
	Do ..Include("frontendHTTPheader.csp")
	Do ..Include("colourScheme.csp")
	do ..renderCommonCSS()
	do ..OnPagePageHeaderCSS()
	do ..renderCommonJavascript()
	do ..outputMetaTags()
	Write !,"</head>"
	Write !,"<body class=""ef-background-color"">"
	
	if ##class(shared.pageMethods).getEditMode() = "edit" {
		do ##class(EF.ui.components.frontend.editorControlPanel).outputEditorControlPanel()	
	}	
 	
 	do ##class(layout.objTemplate).writeBit("{{ef_header}}","{{ef_banner}}")
 	
 	do ##class(layout.objTemplate).writeBit("{{ef_banner}}","{{ef_main_progress}}")
 	if ..#showRegistrationProgressBar {
		Do ..outputProgressBar()
 	}
 	do ##class(layout.objTemplate).writeBit("{{ef_main_progress}}","{{ef_main_header}}")
 	do ..outputPageHeader()
 	do ##class(layout.objTemplate).writeBit("{{ef_main_header}}", "{{ef_main_content}}")
]]></Implementation>
</Method>

<Method name="outputPageHeader">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set efRulesTempParams("prowebcomponentname")="header"
 	set efRulesTempParams("componenttype")="text"
	do pageController.renderHTMLControlFromTag(.efRulesTempParams)
]]></Implementation>
</Method>

<Method name="OnPagePageBottom">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	do ##class(layout.objTemplate).writeBit("{{ef_main_buttons}}","{{ef_footer}}")
	do ##class(layout.objTemplate).writeBit("{{ef_footer}}","")
	
	Write !,!,"</body>"
	Write !,"</html>",!
]]></Implementation>
</Method>

<Method name="beforePageControllerReload">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageControllerID</FormalSpec>
</Method>

<Method name="renderCommonCSS">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="outputMetaTags">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	 &html<
	 	<meta name="efProwebConfirmDeleteURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/deleteListItem.csp?zz=1")))#">
	    <meta name="efProwebEditBaseURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/editItem.csp")))#">
	    <meta name="efProwebAddQuestionBaseURL" content="#(..encodeForHTMLAttribute(..Link(..getInitialURL("../../backend/proweb/codQuestionDetails.csp"))))#">
	    <meta name="efProwebAddRegPromptCollectionBelowLink" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/regPromptCollectionDetails.csp")))#">
	    <meta name="efProwebAddDividerBaseURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/formDivider.csp")))#">
	    <meta name="efProwebAddTextBlockBaseURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/textDetailsMoxie.csp")))#">
	    <meta name="efProwebAddFileUploadBaseURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/fileUploadDetails.csp")))#">
	    <meta name="efProwebAddYouTubeVideoBaseURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/flashDetails.csp")))#">
	    <meta name="efProwebUpdateLabelTextURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/updateLabelText.csp")))#">
	    <meta name="efProwebQuickEditURL" content="#(..encodeForHTMLAttribute(..Link("../../backend/proweb/quickEditAJAX.csp")))#">
	    <meta name="efProwebGetAlternativesURL" content="#(..encodeForHTMLAttribute(..Link("../../frontend/reg/getCoditemAlternativesJSON.csp")))#">
	    
	>
]]></Implementation>
</Method>

<Method name="getInitialURL">
<ClassMethod>1</ClassMethod>
<FormalSpec>targetPage:%String</FormalSpec>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim URL as %String
	#dim contextData as EF.contextDataRegistration = ##class(EF.contextDataRegistration).createFromFrontendCSPSession()
	 
	set URL = "../../backend/proweb/"_targetPage
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"dataID","NEW")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"orgDataID","ADD")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"displayOrder",0)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"addToTop","true")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"isCOD",1)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"pageID",contextData.pageID)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"itemNameID","NEW")
	
	return URL
]]></Implementation>
</Method>

<Method name="renderCommonJavascript">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	if ##class(shared.pageMethods).getEditMode() = "edit"  {
		&html<
			<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
			<script type="text/javascript" src="../../media/javascript/distribution/ef-website-admin.min.js"></script>
		>
	}
]]></Implementation>
</Method>

<Method name="outputFormBeginning">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		<form id="#(..#efFormID)#" name="#(..getFormName())#" method="POST" action="#(..Link(..getFormAction()))#" class="form-inline ef-form" autocomplete="on">
			<input type="hidden" name="pageID" value="#(contextData.pageID)#">
			<input type="hidden" id="efSubmitButtonIdentifier" name="efSubmitButtonIdentifier" value="">
			<input type="hidden" id="efDeleteButtonIdentifier" name="efDeleteButtonIdentifier" value="">
			<input type="hidden" id="efSaveAndReloadFormOnly" name="efSaveAndReloadFormOnly" value="">
			<input type="hidden" id="efPageNavproceedKey" name="pageNavproceedKey" value="#(..#pageNavProceedKey)#">
	>
]]></Implementation>
</Method>

<Method name="outputPageControllerTag">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		<input type="hidden" name="prowebPageControllerID" value="#(pageControllerID)#">
	>
]]></Implementation>
</Method>

<Method name="outputProgressBar">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set progressBar = ##class(EF.ui.components.frontend.progressBar).%New("ef-progress-bar")
	do progressBar.render()
]]></Implementation>
</Method>

<Method name="outputFormEnding">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	write !,"</form>"
]]></Implementation>
</Method>

<Method name="outputEndOfPageJS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	write !,"<script language=""javascript"">"
	do ##class(EF.pageController.javascriptMethods).renderEfGetElement(pageController)
	write !,"</script>"
	do ##class(EF.pageController.javascriptMethods).renderJSForElements(pageController)
	do ##class(EF.pageController.javascriptMethods).outputGetElement(pageController)
]]></Implementation>
</Method>

<Method name="outputButtons">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="getBackButtonURL">
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	new URL,backforward
	set backforward=##class(setup.objPageNav).goWhere(contextData.pageID, , contextData.tempPersonID)
	set URL = $Piece(backforward,"|",1)  // go back
	return URL
]]></Implementation>
</Method>

<Method name="verifyValidPage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Library.Boolean</ReturnType>
<Implementation><![CDATA[	return 1
]]></Implementation>
</Method>

<Method name="getFormName">
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ..#efFormName
]]></Implementation>
</Method>

<Method name="getFormID">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	return ..#efFormID
]]></Implementation>
</Method>

<Method name="getFormAction">
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ..#efFormAction
]]></Implementation>
</Method>
</Class>


<Class name="EF.pages.frontend.registrationProcessProweb">
<Super>EF.pages.frontend.baseProweb</Super>
<TimeChanged>64299,53074.00354</TimeChanged>
<TimeCreated>64258,38909.998566</TimeCreated>

<Parameter name="showRegistrationProgressBar">
<Default>1</Default>
</Parameter>

<Method name="verifyValidPage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Library.Boolean</ReturnType>
<Implementation><![CDATA[
	if (##class(eCom.tempPurchase).isThereAValidTempPurchaseInSession(%session.SessionId)) ! (%session.Get("mode")="edit") {
		return 1
	} else {
		set hdate=+$ZTS,htime=$P($ZTS,",",2)  
		set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)))="Redirected to 'registerNew.csp' from 'EF.pages.frontend.registrationProcessProweb' due to invalid tempPurchase"
	 	set %response.Redirect="registerNew.csp"
	 	quit 0
 	}
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.attribute">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.ui.components.attribute.CLS/EV.3
;vc; Component: CLS.EF.ui.components.attribute
;vc;  Location: LargeDev
;vc; Date/Time: 31-Oct-16 12:06
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.ui.components.attribute.CLS/EV.3</td><td>CLS.EF.ui.components.attribute</td><td>LargeDev</td><td style='white-space: nowrap;'>31-Oct-16 12:06</td><td>FredG</td></tr></table>
]]></Description>
<Super>%RegisteredObject,EF.htmlGenerator</Super>
<TimeChanged>64203,38149</TimeChanged>
<TimeCreated>63771,55871.797567</TimeCreated>

<Property name="name">
<Type>%String</Type>
<Parameter name="MAXLEN" value="3641144"/>
</Property>

<Property name="value">
<Type>%String</Type>
<Parameter name="MAXLEN" value="3641144"/>
</Property>

<Method name="addAttributeToList">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&listOfAttributes:%ListOfObjects,name:%String,value:%String]]></FormalSpec>
<Implementation><![CDATA[
	set attribute=##class(EF.ui.components.attribute).%New()
	set attribute.name=name
	set attribute.value=value
	do listOfAttributes.Insert(attribute)
]]></Implementation>
</Method>

<Method name="getAttributesAsHTML">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&listOfAttributes:%ListOfObjects]]></FormalSpec>
<Implementation><![CDATA[
	set extraAttributes=""
	for i=1:1:listOfAttributes.Count() {
		set attribute=listOfAttributes.GetAt(i)
		if ($l(attribute.name))&&($l(attribute.value)) {
			set extraAttributes=extraAttributes_" "_..encodeForHTMLAttribute(attribute.name)_"="""_..encodeForHTMLAttribute(attribute.value)_""""
		}
	}
	return extraAttributes
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.backend.panel">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.ui.components.backend.panel.CLS/EV.7
;vc; Component: CLS.EF.ui.components.backend.panel
;vc;  Location: LargeDev
;vc; Date/Time: 01-Dec-16 17:16
;vc;      User: MindaugasL
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.ui.components.backend.panel.CLS/EV.7</td><td>CLS.EF.ui.components.backend.panel</td><td>LargeDev</td><td style='white-space: nowrap;'>01-Dec-16 17:16</td><td>MindaugasL</td></tr></table>
]]></Description>
<Super>EF.ui.components.container</Super>
<TimeChanged>64253,62184.978882</TimeChanged>
<TimeCreated>63361,62973.538498</TimeCreated>

<Property name="heading">
<Type>%String</Type>
<Parameter name="MAXLEN" value="3641144"/>
</Property>

<Property name="errorMessage">
<Type>%String</Type>
<Parameter name="MAXLEN" value="3641144"/>
</Property>

<Method name="renderStart">
<Implementation><![CDATA[
	set classes = "ef-admin-settings-panel "_..classes
	if $l(..errorMessage) {
		set classes=classes_" ef-panel-with-error"
	}
	&HTML<
		<div class="#(classes)#" id="#(..encodeHTMLAttribute(..htmlID))#">
            <div class="panel-heading">#(..encodeHTMLContent(..heading))#</div>
            	#[do ..renderErrorMessage()]#
	>
]]></Implementation>
</Method>

<Method name="renderEnd">
<Implementation><![CDATA[
	&HTML<
        </div>
	>
]]></Implementation>
</Method>

<Method name="renderErrorMessage">
<Implementation><![CDATA[
	if $l(..errorMessage) {
		&html<
			<div class="ef-panel-message-area">
				<div class="alert alert-danger ">#(..rawHTML(..errorMessage))#
	            </div>
	        </div>
		>
	}
]]></Implementation>
</Method>

<Method name="addErrorMessage">
<FormalSpec>errorMessage</FormalSpec>
<Implementation><![CDATA[
	if $l(..errorMessage) {
		set ..errorMessage=..errorMessage_..rawHTML("<br>")	
	}
	set ..errorMessage=..errorMessage_..encodeHTMLContent(errorMessage)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>panelDefaultData</DefaultData>
<Data name="panelDefaultData">
<Subscript>"panel"</Subscript>
<Value name="1">
<Value>heading</Value>
</Value>
<Value name="2">
<Value>errorMessage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.alternativeABI">
<Super>EF.ui.components.alternative</Super>
<TimeChanged>64247,31000.698454</TimeChanged>
<TimeCreated>64237,29515.209186</TimeCreated>

<Property name="price">
<Type>%Numeric</Type>
</Property>

<Property name="capacity">
<Type>%Integer</Type>
</Property>

<Property name="currentBookingLevel">
<Type>%Integer</Type>
</Property>

<Property name="isBookingStopped">
<Type>%Boolean</Type>
</Property>

<Property name="contextData">
<Type>EF.contextDataRegistration</Type>
</Property>

<Method name="getFormattedPriceString">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim priceString as %String = ""
	if '##class(setup.objEventSetting).getParameter("bookingings","suppress prices in reg pages", ..contextData.eventID) {  // ## don't fix the typo without running upgrade code! ###
		if ..price {
			set classes = "ef-price"
			if ..isFull() {
				set classes = classes_" ef-capacity-full"
			}
			set priceString = "<span class="""_classes_""">"_..encodeHTMLContent(##class(eCom.objPrice).formatAmount(..price, ..contextData.currencyID))_"</span>"
		}
	}
	return priceString
]]></Implementation>
</Method>

<Method name="getFormattedCapacityString">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim capacityString as %String = ""
	
	if (..contextData.isBackendBooking) && (..capacity) {
		set capacityString = "<span class=""ef-capacity"">"_..encodeHTMLContent(..currentBookingLevel_"/"_..capacity)_"</span>"
	}
	
	return capacityString
]]></Implementation>
</Method>

<Method name="isFull">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	if (+..currentBookingLevel < +..capacity) ! (+..capacity = 0) {
		return 0
	} else {
		return 1
	}
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>alternativeABIDefaultData</DefaultData>
<Data name="alternativeABIDefaultData">
<Subscript>"alternativeABI"</Subscript>
<Value name="1">
<Value>price</Value>
</Value>
<Value name="2">
<Value>capacity</Value>
</Value>
<Value name="3">
<Value>currentBookingLevel</Value>
</Value>
<Value name="4">
<Value>contextData</Value>
</Value>
<Value name="5">
<Value>isBookingStopped</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.alternativeABIDropdown">
<Super>EF.ui.components.frontend.alternativeABI</Super>
<TimeChanged>64237,32425.955818</TimeChanged>
<TimeCreated>64237,30883.269244</TimeCreated>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.alternativeABIRadio">
<Super>EF.ui.components.radio,EF.ui.components.frontend.alternativeABI</Super>
<TimeChanged>64252,62907.682444</TimeChanged>
<TimeCreated>64236,41273.459766</TimeCreated>

<Method name="getOptionLabel">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    &html<
    	&nbsp;#(..encodeHTMLContent(..label))#
    	&nbsp;
    	#(..getFormattedPriceString() )#
    	&nbsp;
    	#(..getFormattedCapacityString() )#
    	</label>
    >
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>alternativeABIRadioDefaultData</DefaultData>
<Data name="alternativeABIRadioDefaultData">
<Subscript>"alternativeABIRadio"</Subscript>
<Value name="1">
<Value>price</Value>
</Value>
<Value name="2">
<Value>capacity</Value>
</Value>
<Value name="3">
<Value>currentBookingLevel</Value>
</Value>
<Value name="4">
<Value>contextData</Value>
</Value>
<Value name="5">
<Value>isBookingStopped</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.buttonAddGuest">
<Super>EF.ui.components.buttonBase,EF.ui.components.frontend.prowebBase</Super>
<TimeChanged>64299,53548.739003</TimeChanged>
<TimeCreated>64183,40678.260093</TimeCreated>

<Property name="maximumNumberOfGuests">
<Type>%Integer</Type>
</Property>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "btn btn-secondary ef-add-guest-button ef-push-button ef-push-button-secondary"
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	set outerDiv = ##class(EF.ui.components.div).%New()
	set outerDiv.classes = "row ef-proweb-form-row"
	do outerDiv.renderStart()
	set labelDiv = ##class(EF.ui.components.div).%New()
	set labelDiv.classes = "col-sm-4 ef-proweb-label-container"
	do labelDiv.render()
	set buttonDiv = ##class(EF.ui.components.div).%New()
	set buttonDiv.classes = "col-sm-8"
	do buttonDiv.renderStart()
	do ##super()
	
	do buttonDiv.renderEnd()
	do outerDiv.renderEnd()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>buttonAddGuestDefaultData</DefaultData>
<Data name="buttonAddGuestDefaultData">
<Subscript>"buttonAddGuest"</Subscript>
<Value name="1">
<Value>label</Value>
</Value>
<Value name="2">
<Value>title</Value>
</Value>
<Value name="3">
<Value>isProwebEditMode</Value>
</Value>
<Value name="4">
<Value>prowebItemID</Value>
</Value>
<Value name="5">
<Value>prowebItem</Value>
</Value>
<Value name="6">
<Value>contextData</Value>
</Value>
<Value name="7">
<Value>maximumNumberOfGuests</Value>
</Value>
<Value name="8">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="9">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.buttonDeleteGuest">
<Super>EF.ui.components.buttonBase,EF.ui.components.frontend.prowebBase</Super>
<TimeChanged>64299,53548.808332</TimeChanged>
<TimeCreated>64183,40678.260093</TimeCreated>

<Property name="guestNumber">
<Type>%Integer</Type>
</Property>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "ef_frontend_button ef-delete-guest-button btn btn-secondary ef-push-button ef-push-button-secondary"
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	set outerDiv = ##class(EF.ui.components.div).%New()
	set outerDiv.classes = "row"
	do outerDiv.renderStart()
	set labelDiv = ##class(EF.ui.components.div).%New()
	set labelDiv.classes = "col-sm-4 ef-proweb-label-container"
	do labelDiv.render()
	set buttonDiv = ##class(EF.ui.components.div).%New()
	set buttonDiv.classes = "col-sm-8"
	do buttonDiv.renderStart()
	do ..addAttribute("data-ef-guest-number",..guestNumber)
	do ##super()
	
	do buttonDiv.renderEnd()
	do outerDiv.renderEnd()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>buttonDeleteGuestDefaultData</DefaultData>
<Data name="buttonDeleteGuestDefaultData">
<Subscript>"buttonDeleteGuest"</Subscript>
<Value name="1">
<Value>isProwebEditMode</Value>
</Value>
<Value name="2">
<Value>prowebItemID</Value>
</Value>
<Value name="3">
<Value>prowebItem</Value>
</Value>
<Value name="4">
<Value>contextData</Value>
</Value>
<Value name="5">
<Value>maximumNumberOfGuests</Value>
</Value>
<Value name="6">
<Value>guestNumber</Value>
</Value>
<Value name="7">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="8">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.buttonLink">
<Super>EF.ui.components.buttonBase</Super>
<TimeChanged>64246,32943.28674</TimeChanged>
<TimeCreated>64239,51952.661539</TimeCreated>

<Property name="href">
<Type>%String</Type>
<Parameter name="MAXLEN" value="1000000"/>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>label:%String,href:%String,title:%String="",isDisabled:%Boolean=0</FormalSpec>
<ReturnType>EF.ui.components.frontend.buttonLink</ReturnType>
<Implementation><![CDATA[
	if $Length(label) = 0 {
		throw ##class(shared.exceptions.generalException).%New("No label text passed in to createNewButton")	
	}
	if $Length(href) = 0 {
		throw ##class(shared.exceptions.generalException).%New("No HREF passed in to createNewButton")	
	}
	set button = ..%New("ef-button-"_label)
	set button.label = label
	set button.type = "button"
	set button.href = href
	set button.title = title
	set button.isDisabled = isDisabled
	set button.classes = "btn btn-secondary on-click-redirect ef-push-button ef-push-button-secondary"	

	return button
]]></Implementation>
</Method>

<Method name="renderStart">
<Implementation><![CDATA[
	&html<
		<button type="button" id="#(..encodeForHTMLAttribute(..htmlID))#" class="#(..encodeForHTMLAttribute(..classes))#" data-link-url="#(..encodeForHTMLAttribute(..href))#" #(..rawHTML(..getExtraAttributes()))#>
    >
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>buttonLinkDefaultData</DefaultData>
<Data name="buttonLinkDefaultData">
<Subscript>"buttonLink"</Subscript>
<Value name="1">
<Value>URL</Value>
</Value>
<Value name="2">
<Value>href</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.buttonSubmit">
<Super>EF.ui.components.buttonBase</Super>
<TimeChanged>64245,64353.970775</TimeChanged>
<TimeCreated>64239,51952.661539</TimeCreated>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>label:%String,title:%String="",isDisabled:%Boolean=0</FormalSpec>
<ReturnType>EF.ui.components.frontend.buttonSubmit</ReturnType>
<Implementation><![CDATA[
	if $Length(label) = 0 {
		throw ##class(shared.exceptions.generalException).%New("No label textpassed in to createNewButton")	
	}
	
	set button = ..%New("ef-button-"_label)
	set button.label = label
	set button.type = "submit"
	set button.title = title
	set button.isDisabled = isDisabled
	set button.classes = "btn btn-primary ef-push-button ef-push-button-primary"
	
	return button
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.checkbox">
<Super>EF.ui.components.checkbox,EF.ui.components.frontend.inputElement,EF.ui.components.frontend.alternativeABI</Super>
<TimeChanged>64299,53548.912575</TimeChanged>
<TimeCreated>63355,62572.097775</TimeCreated>

<Property name="price">
<Type>%Numeric</Type>
</Property>

<Method name="render">
<Implementation><![CDATA[
	do ..addClass("ef-control-label")
	if (..isFull() ) ! (..isBookingStopped) {
		do ..addClass("ef-capacity-full")
	}
	if $length(..label) {
		&html<
	        <label class="#(..getClasses())#">
		        #[do ..renderCheckbox()]#
		        #(..encodeHTMLContent(..label))#
		        #(..getFormattedPriceString() )#
    			&nbsp;
    			#(..getFormattedCapacityString() )#
		    </label>
		    <br/>
		>
	} else {
		do ..renderCheckbox()	
	}
	do ##super()
]]></Implementation>
</Method>

<Method name="addOnDisableAction">
<FormalSpec>action</FormalSpec>
<Implementation><![CDATA[	do ..addAttribute("data-on-disable-action",action)
]]></Implementation>
</Method>

<Method name="renderCheckbox">
<Implementation><![CDATA[
	do ..addClass("ef-check-box")
	if ('..contextData.isBackendBooking) && ((..isFull() ) ! (..isBookingStopped)) {
		set ..isDisabled = 1
	}
	set disabledString = ""
	if ..isDisabled {
		set disabledString = "disabled=""disabled"""
	}
	set isCheckedString = ""
	if ..value {
		set isCheckedString = "checked"
	}
	&html<
		<input type="checkbox" value="1" id="#(..encodeHTMLAttribute(..htmlID))#" class="#(..encodeForHTMLAttribute(..classes))#" name="#(..encodeHTMLAttribute(..htmlName))#" title="#(..encodeHTMLAttribute(..title))#" #(..rawHTML(isCheckedString))# #(..rawHTML(disabledString))# #(..rawHTML(..getExtraAttributes()))#>

	>
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>checkboxDefaultData</DefaultData>
<Data name="checkboxDefaultData">
<Subscript>"checkbox"</Subscript>
<Value name="1">
<Value>alternatives</Value>
</Value>
<Value name="2">
<Value>isMandatory</Value>
</Value>
<Value name="3">
<Value>contextData</Value>
</Value>
<Value name="4">
<Value>isGuest</Value>
</Value>
<Value name="5">
<Value>helpText</Value>
</Value>
<Value name="6">
<Value>guestNumber</Value>
</Value>
<Value name="7">
<Value>isProwebEditMode</Value>
</Value>
<Value name="8">
<Value>prowebItem</Value>
</Value>
<Value name="9">
<Value>prowebItemID</Value>
</Value>
<Value name="10">
<Value>isBackendOnly</Value>
</Value>
<Value name="11">
<Value>maxWords</Value>
</Value>
<Value name="12">
<Value>maxCharacters</Value>
</Value>
<Value name="13">
<Value>price</Value>
</Value>
<Value name="14">
<Value>capacity</Value>
</Value>
<Value name="15">
<Value>currentBookingLevel</Value>
</Value>
<Value name="16">
<Value>isDefault</Value>
</Value>
<Value name="17">
<Value>isSelected</Value>
</Value>
<Value name="18">
<Value>isBookingStopped</Value>
</Value>
<Value name="19">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="20">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.checkboxGroup">
<Super>EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64253,39628.464312</TimeChanged>
<TimeCreated>63356,56848.077942</TimeCreated>

<Property name="label">
<Type>%String</Type>
<Parameter name="MAXLEN" value="3641144"/>
</Property>

<Property name="checkboxes">
<Type>EF.ui.components.checkbox</Type>
<Collection>list</Collection>
</Property>

<Property name="columns">
<Type>%Integer</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	&html<
		
		<div >
        	#[do ..renderCheckboxes()]#
        </div>
    >
    do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="renderCheckboxes">
<Implementation><![CDATA[
	set ind=""
	for column=1:1:..columns {
		do ..renderColumnStart()
		for row=1:1:..childComponents.Count() {
			set checkbox=..childComponents.GetAt($I(ind))
			if $IsObject(checkbox) {
				if $IsObject(..enableDisableDependencyList) {
					set checkbox.enableDisableDependencyList = ..enableDisableDependencyList
				}
				do ..renderCheckbox(checkbox)
			}
		}
		do ..renderColumnEnd()	
	}
]]></Implementation>
</Method>

<Method name="renderColumnStart">
<Implementation><![CDATA[	&html<<div class="inputs-list ef-proweb-input-element ef-checkbox-group">>
]]></Implementation>
</Method>

<Method name="renderColumnEnd">
<Implementation><![CDATA[	&html<</div>>
]]></Implementation>
</Method>

<Method name="renderCheckbox">
<FormalSpec>checkbox:EF.ui.components.frontend.checkbox</FormalSpec>
<Implementation><![CDATA[	do checkbox.render()
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.checkboxGroup).%New()
]]></Implementation>
</Method>

<Method name="renderLabelCellOpening">
<Implementation><![CDATA[	write "<div class=""col-sm-4 ef-label-container ef-label-container-vertical-group",..encodeForHTMLAttribute(..getDependentClass()),""" ",..rawHTML(..getDependsOnText()),">"
]]></Implementation>
</Method>

<Method name="renderInputElementCellOpening">
<Implementation><![CDATA[	write "<div class=""col-sm-8 ef-checkbox-container"">"
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>checkboxGroupDefaultData</DefaultData>
<Data name="checkboxGroupDefaultData">
<Subscript>"checkboxGroup"</Subscript>
<Value name="1">
<Value>checkboxes</Value>
</Value>
<Value name="2">
<Value>columns</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.datePicker">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.ui.components.backend.datePicker.CLS/EV.3
;vc; Component: CLS.EF.ui.components.backend.datePicker
;vc;  Location: LargeDev
;vc; Date/Time: 02-Feb-16 12:32
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.ui.components.backend.datePicker.CLS/EV.3</td><td>CLS.EF.ui.components.backend.datePicker</td><td>LargeDev</td><td style='white-space: nowrap;'>02-Feb-16 12:32</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.ui.components.textInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64299,53548.977148</TimeChanged>
<TimeCreated>63384,38215.518113</TimeCreated>

<Parameter name="typeAttribute">
<Default>date</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	
	set defaultClasses = ..getDefaultProwebClasses()
	set defaultClasses = defaultClasses_" ef-date-picker ef-kendo-form-control"
	return defaultClasses
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[
	set validator = ##class(EF.validator.dateInput).%New()
	set validator.dateFormat=##class(shared.dateFunctions).getFrontendInputDateFormat(..contextData.eventID)
	return validator
]]></Implementation>
</Method>

<Method name="getProwebExtraAttributes">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ..getExtraAttributes()
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	
	do ..renderRowOpeningAndLabel()
	write !,"<div style=""width: 40%"" class=""",..getDefaultClasses(),""">"
	do ..renderInputElementOnly()
	&html<</div>>
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="renderInputElementOnly">
<Implementation><![CDATA[
	do ..removeClass("ef-input")
	set ..classes = ..classes_"  efDatePicker "
	set kendoDateFormat = ##class(shared.dateFunctions).getKendoDateFormat(..validator.dateFormat)
	set ..placeHolder = ##class(shared.dateFunctions).datePattern(..validator.dateFormat)
	
	&html<
    	    <input type="#(..encodeHTMLAttribute(..#typeAttribute))#" class="#(..encodeHTMLAttribute(..classes))#" #(..rawHTML(..getDisabledString()))# 
    	    title="#(..encodeHTMLAttribute(..title))#" id="#(..encodeHTMLAttribute(..htmlID))#" name="#(..encodeHTMLAttribute(..htmlName))#" 
    	    value="#(..encodeHTMLAttribute(..value))#" placeholder="#(..encodeHTMLAttribute(..placeHolder))#"  #(..rawHTML(..getProwebExtraAttributes()))#
    	    efKendoDateFormat="#(..encodeHTMLAttribute(kendoDateFormat))#">
	>
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>datePickerDefaultData</DefaultData>
<Data name="datePickerDefaultData">
<Subscript>"datePicker"</Subscript>
<Value name="1">
<Value>alternatives</Value>
</Value>
<Value name="2">
<Value>isMandatory</Value>
</Value>
<Value name="3">
<Value>contextData</Value>
</Value>
<Value name="4">
<Value>isGuest</Value>
</Value>
<Value name="5">
<Value>helpText</Value>
</Value>
<Value name="6">
<Value>guestNumber</Value>
</Value>
<Value name="7">
<Value>isProwebEditMode</Value>
</Value>
<Value name="8">
<Value>prowebItem</Value>
</Value>
<Value name="9">
<Value>prowebItemID</Value>
</Value>
<Value name="10">
<Value>isBackendOnly</Value>
</Value>
<Value name="11">
<Value>maxWords</Value>
</Value>
<Value name="12">
<Value>maxCharacters</Value>
</Value>
<Value name="13">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="14">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.dateRange">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.ui.components.backend.datePicker.CLS/EV.3
;vc; Component: CLS.EF.ui.components.backend.datePicker
;vc;  Location: LargeDev
;vc; Date/Time: 02-Feb-16 12:32
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.ui.components.backend.datePicker.CLS/EV.3</td><td>CLS.EF.ui.components.backend.datePicker</td><td>LargeDev</td><td style='white-space: nowrap;'>02-Feb-16 12:32</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.ui.components.textInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64299,53548.976689</TimeChanged>
<TimeCreated>63384,38215.518113</TimeCreated>

<Parameter name="typeAttribute">
<Default>date</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set defaultClasses = ..getDefaultProwebClasses()
	set defaultClasses = defaultClasses_" ef-date-picker ef-kendo-form-control"
	return defaultClasses
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[
	set validator = ##class(EF.validator.dateInput).%New()
	set validator.dateFormat=##class(shared.dateFunctions).getFrontendInputDateFormat(..contextData.eventID)
	return validator
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	set kendoDateFormat = ##class(shared.dateFunctions).getKendoDateFormat(..validator.dateFormat)

	do ..renderColumnStart()
	set startDateComponent = ..childComponents.GetAt(1)
	set startDateComponent.placeHolder = ##class(shared.dateFunctions).datePattern(..validator.dateFormat)
	set startDateComponent.classes = startDateComponent.classes_" efDateRangeStart"
	do startDateComponent.renderInputElementOnly()
	do ..renderColumnEnd()

	write !,"<div style='float: left; text-align: left; margin-left: 15px; margin-right: 15px;'>"
	write !,##class(shared.pCSP).out("to")
	do ..renderColumnEnd()

	do ..renderColumnStart()
	set endDateComponent = ..childComponents.GetAt(2) 
	set endDateComponent.placeHolder = ##class(shared.dateFunctions).datePattern(..validator.dateFormat)
	set endDateComponent.classes = endDateComponent.classes_" efDateRangeEnd"
	do endDateComponent.renderInputElementOnly()
	do ..renderColumnEnd()
	
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="renderColumnStart">
<Implementation><![CDATA[	write !,"<div class=""ef-input-short"">"
]]></Implementation>
</Method>

<Method name="renderColumnEnd">
<Implementation><![CDATA[	write !,"</div>"
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>dateRangeDefaultData</DefaultData>
<Data name="dateRangeDefaultData">
<Subscript>"dateRange"</Subscript>
<Value name="1">
<Value>alternatives</Value>
</Value>
<Value name="2">
<Value>isMandatory</Value>
</Value>
<Value name="3">
<Value>contextData</Value>
</Value>
<Value name="4">
<Value>isGuest</Value>
</Value>
<Value name="5">
<Value>helpText</Value>
</Value>
<Value name="6">
<Value>guestNumber</Value>
</Value>
<Value name="7">
<Value>isProwebEditMode</Value>
</Value>
<Value name="8">
<Value>prowebItem</Value>
</Value>
<Value name="9">
<Value>prowebItemID</Value>
</Value>
<Value name="10">
<Value>isBackendOnly</Value>
</Value>
<Value name="11">
<Value>maxWords</Value>
</Value>
<Value name="12">
<Value>maxCharacters</Value>
</Value>
<Value name="13">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="14">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.divider">
<Super>EF.ui.components.frontend.prowebBase</Super>
<TimeChanged>64246,57302.621687</TimeChanged>
<TimeCreated>64188,59498.911424</TimeCreated>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpening()
		do ..renderCellOpening()
			write "<hr class=""ef-form-divider"">"
		do ..renderCellClosing()
	do ..renderRowClosing()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.dropdown">
<Super>EF.ui.components.listInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64299,53549.102659</TimeChanged>
<TimeCreated>63355,56609.363142</TimeCreated>

<Property name="isPersistent">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="isSearchAsYouType">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Method name="addDropdownAlternative">
<FormalSpec>storageAlternative:sc.facade.prowebItemStorageInputElementAlternative,contextData:EF.contextDataRegistration,price:%Numeric</FormalSpec>
<ReturnType>EF.ui.components.alternative</ReturnType>
<Implementation><![CDATA[
	set htmlID=..htmlID_"_"_(..alternatives.Count()+1)

	if storageAlternative.isABI {
		set alternative = ##class(EF.ui.components.frontend.alternativeABIDropdown).%New(htmlID) 
		set alternative.price = price
		set alternative.capacity = storageAlternative.ABICapacity
		set alternative.currentBookingLevel = storageAlternative.ABICurrentBookingLevel
		set alternative.isBookingStopped = storageAlternative.ABIIsBookingStopped
		set alternative.contextData = contextData
		
	
	} else {
		set alternative = ##class(EF.ui.components.alternative).%New(htmlID)		
	}
	set alternative.label = storageAlternative.displayText
	set alternative.value = storageAlternative.value
	
	do ..alternatives.Insert(alternative)
	// Also add to the validator
	do ..validator.addAllowedValue(alternative.value)
	return alternative
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	if ..hasError do ..addClass("has-error")
	
	set selectClass="form-control "_..getDefaultProwebClasses()_" ef-dropdown-list "
	set searchableDataAttributes = ""
	if ..isSearchAsYouType {
		set selectClass = selectClass_" ef_element_dropdown_searchable select2-hidden-accessible "
		if ..validator.isMandatory {
			set searchableDataAttributes = searchableDataAttributes_" data-placeholder=""Choose one..."""
		} else {
			set searchableDataAttributes = searchableDataAttributes_" data-placeholder="" """
		}
		set searchableDataAttributes = searchableDataAttributes_" data-obj-cod-item-id="_..encodeHTMLAttribute(..prowebItemID)_" data-ef-cod-item-alternatives-url="_..encodeHTMLAttribute(##class(shared.pCSP).Link("getCodItemAlternativesJSON.csp"))
	}
	
	set disabledString=""
	if ..isDisabled {
		set disabledString="disabled=""disabled"""
	}	
	do ..getBackendOnlyStyles()
	
	do ..renderRowOpeningAndLabel()
	&html<		
		<select class="#(..encodeForHTMLAttribute(..classes_" "_selectClass))#" 
		name="#(..encodeHTMLAttribute(..htmlName))#" 
			id="#(..encodeHTMLAttribute(..htmlID))#" 
			title="#(..encodeHTMLAttribute(..title))#" 
			#(..rawHTML(disabledString))# 
			#(..rawHTML(..getExtraAttributes()))# 
			#(..rawHTML(searchableDataAttributes))#
			#(..rawHTML(..getAriaLabelForInputElement() ))# 
		>
    		#[do ..renderPlaceholder()]#
    		#[do ..renderAlternatives()]#
        </select>
    >
    do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="renderAlternative">
<FormalSpec>alternative:EF.ui.components.alternative</FormalSpec>
<Implementation><![CDATA[
	set selectedString=""
	if alternative.isSelected {
		set selectedString="selected="""""	
	}
	if (alternative.%Extends("EF.ui.components.frontend.alternativeABI") ) && ( (alternative.isFull()!(alternative.isBookingStopped) )) {
		if '..contextData.isBackendBooking {
			set alternative.isDisabled = 1
		}
		do alternative.addClass("ef-capacity-full")
	}
	set disabledString=""
	if alternative.isDisabled {
		set disabledString="disabled"	
	}
	
	// Output the markup for the option on one line to keep the HTML short when having loads of alternatives
	&html<<option #(..rawHTML(selectedString))# #(..rawHTML(disabledString))# value="#(..encodeHTMLAttribute(alternative.value))#" #(..rawHTML(alternative.getExtraAttributes()))# class="#(alternative.getClasses())#">#(..encodeHTMLContent(alternative.label))#	#(..getABIInfoEncoded(alternative))#</option>>
]]></Implementation>
</Method>

<Method name="getABIInfoEncoded">
<FormalSpec>alternative:EF.ui.components.alternative</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim ABIString as %String = ""
	
	if alternative.%Extends("EF.ui.components.frontend.alternativeABIDropdown") {
		if $Length(alternative.getFormattedPriceString() ) {
			set ABIString = "("_alternative.getFormattedPriceString()_")"
		}
		set ABIString = ABIString_" "
		if $Length(alternative.getFormattedCapacityString() ) {
			set ABIString = ABIString_"(Capacity: "_alternative.getFormattedCapacityString()_")"
		}
		return ABIString
	}
	return ""
]]></Implementation>
</Method>

<Method name="renderPlaceholder">
<Private>1</Private>
<Implementation><![CDATA[
	if ..validator.isMandatory  {
		if ..isAnyAlternativeSelected() {
			set selectString = ""
		} else {
			set selectString = "selected"	
		}
		write !,"<option value='' ",selectString," disabled>",..encodeHTMLContent(##class(shared.pCSP).out("Choose one...")),"</option>",!	
		
	}
]]></Implementation>
</Method>

<Method name="isAnyAlternativeSelected">
<Private>1</Private>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	for position = 1:1:..alternatives.Count() {
		if ..alternatives.GetAt(position).isSelected {
			return 1
			
		}	
	}	
	return 0
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>dropdownDefaultData</DefaultData>
<Data name="dropdownDefaultData">
<Subscript>"dropdown"</Subscript>
<Value name="1">
<Value>isPersistent</Value>
</Value>
<Value name="2">
<Value>isMandatory</Value>
</Value>
<Value name="3">
<Value>contextData</Value>
</Value>
<Value name="4">
<Value>isGuest</Value>
</Value>
<Value name="5">
<Value>helpText</Value>
</Value>
<Value name="6">
<Value>guestNumber</Value>
</Value>
<Value name="7">
<Value>isProwebEditMode</Value>
</Value>
<Value name="8">
<Value>prowebItem</Value>
</Value>
<Value name="9">
<Value>prowebItemID</Value>
</Value>
<Value name="10">
<Value>isBackendOnly</Value>
</Value>
<Value name="11">
<Value>isSearchAsYouType</Value>
</Value>
<Value name="12">
<Value>maxWords</Value>
</Value>
<Value name="13">
<Value>maxCharacters</Value>
</Value>
<Value name="14">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="15">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.editorControlPanel">
<Super>shared.pCSPmanage</Super>
<TimeChanged>64307,36915.211928</TimeChanged>
<TimeCreated>64203,40625.329831</TimeCreated>

<Method name="outputEditorControlPanel">
<ClassMethod>1</ClassMethod>
<FormalSpec>mvcPage:EF.mvcHandler.frontendProweb</FormalSpec>
<Implementation><![CDATA[
	#dim contextData as EF.contextDataFrontend = ##class(EF.contextDataFrontend).createFromFrontendCSPSession()
	
	set newPageURL = ..Link("../../system/proweb/start.csp?z=1")
	set attendeeCategoryID = contextData.attendeeCategoryID
	if attendeeCategoryID = "" {
		set attendeeCategoryID = ##class(setup.lnkCategoryEvent).getAttendeeCategoryIDFromRegistrationPageID(mvcPage.pageID)	
	}	

	&html<
		<div id="efEditorBackground">
			<div id="efEditorControlPanel" class="container ef-editor-control-panel">
				<div class="ef-editor-panel-heading">
					Website Contents Editor
					<div style="float: right;">
						<button type="button" id="pageProperties" class="glyphicon glyphicon-pencil" style="color: black;" onClick="window.location.assign('#(..encodeForURL(..Link("../../backend/proweb/pageProperties.csp")))#');"></button>

					</div>
				</div>
				<div class="ef-editor-panel-body">
					<div class="row form-horizontal">
						<div class="col-sm-1">
							<label for="selPage" class="control-label">
								Page:
							</label>
						</div>
						<div class="col-sm-2">
							<select name="selPage" id="selPage" class="form-control ef-form-control" onChange="window.location.assign('#(newPageURL)#&pageID=' + this.value);">
								>
								set eventPageList=##class(sc.eventPageList).createNew(contextData.eventID, contextData.languageID)
								do eventPageList.getPageArray(.pageArray)
								set key = ""
								for  {
									set key = $Order(pageArray(key))
									if key = "" quit
									
									set pageID = $Piece(pageArray(key), "|", 1)
									set pageName = $Piece(pageArray(key), "|", 2)
									
									if pageID {
										&html<
											<option value=#(..encodeForHTMLAttribute(pageID))# #( $Select(pageID = mvcPage.pageID:"SELECTED",1:"") )#>
												#(..encodeForHTML(pageName) )#
											</option>
										>
									} else {
										&html<
											<option value="" style="background-color: rgb(100,100,100); color: white;" disabled="disabled">
												#(..encodeForHTML(pageName) )#
											</option>
										>
									}
								}
								&html<
							</select>
						</div>

						<div class="col-sm-1">
							<label for="selLanguage" class="control-label">
								Language:
							</label>
						</div>
						<div class="col-sm-2">
							<select name="selLanguage" id="selPage" class="form-control ef-form-control" onChange="window.location.assign('#(newPageURL)#&pageID=' + this.value);">
								>
								do ##class(shared.objLanguage).getLanguagesForEvent(contextData.eventID, .languageArray)
								set languageID = ""
								for  {
									set languageID = $Order(languageArray(languageID))
									if languageID = "" quit
									
									set targetPageID = ..getEquivalentPageIDForLanguageID(mvcPage.pageID, languageID)
									&html<
										<option value="#(..encodeForHTMLAttribute(targetPageID))#" #( $Select(languageID = contextData.languageID:"SELECTED",1:"") )#>
											#(..encodeForHTML(languageArray(languageID)))#
										</option>
									>
								}
								&html<
							</select>
						</div>

						<div class="col-sm-1">
							<label for="selAttendeeCategory" class="control-label">
								Category:
							</label>
						</div>
						<div class="col-sm-2">
							<select name="selAttendeeCategory" 
								id="selPage" 
								class="form-control ef-form-control" 
								#( $Select(attendeeCategoryID="":"DISABLED",1:"") )#
								onChange="window.location.assign('#(newPageURL)#&pageID=' + this.value);">
							>
								if attendeeCategoryID="" {
									Write !,"<option></option>"	
								}
								
								set eventConfiguration = ##class(setup.eventConfiguration).createForEventID(contextData.eventID)
								set listOfCategoryObjects = eventConfiguration.eventAttendeeCategories.getActiveCategories()
								set key = ""
								for  {
									set attendeeCategory = listOfCategoryObjects.GetNext(.key)
									if key = "" quit	
									set targetPageID = ..getEquivalentPageIDForAttendeeCategoryID(mvcPage.pageID, attendeeCategory.eventCategoryID)
									if targetPageID > 0 {
										&html<
											<option value="#(..encodeForHTMLAttribute(targetPageID))#" #( $Select(attendeeCategory.eventCategoryID = attendeeCategoryID:"SELECTED",1:"") )#>
												#(..encodeForHTML(attendeeCategory.name))#
											</option>
										>
									}
								}
								&html<
							</select>
						</div>

						<div class="col-sm-2">
							<button class="btn btn-secondary">Add Page</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	>
]]></Implementation>
</Method>

<Method name="getEquivalentPageIDForLanguageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>sourcePageID:%Integer,languageID:%Integer</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set page = ##class(sc.xModules.objPage).%OpenId(sourcePageID)
	if '$IsObject(page) {
		throw ##class(shared.exceptions.generalException).%New("Failed to open sourcePageID:"_sourcePageID)	
	}
	
	set rsPages = ##class(%ResultSet).%New("sc.xModules.objPage:qPagesByTemplateEventLanguage")
	do rsPages.Execute(languageID, page.objEvent.%Id(), page.objTemplate.%Id() )
	while rsPages.Next() {
		set targetPageID = rsPages.Get("ID")
		if ##class(setup.lnkCategoryEvent).getAttendeeCategoryIDFromRegistrationPageID(targetPageID) = ##class(setup.lnkCategoryEvent).getAttendeeCategoryIDFromRegistrationPageID(sourcePageID) {
			return targetPageID	
		}	
	}
	return ""
]]></Implementation>
</Method>

<Method name="getEquivalentPageIDForAttendeeCategoryID">
<ClassMethod>1</ClassMethod>
<FormalSpec>sourcePageID:%Integer,attendeeCategoryID:%Integer</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set page = ##class(sc.xModules.objPage).%OpenId(sourcePageID)
	
	set rsPages = ##class(%ResultSet).%New("sc.xModules.objPage:qPagesByTemplateEventLanguage")
	do rsPages.Execute(page.objLanguage.%Id(), page.objEvent.%Id(), page.objTemplate.%Id() )
	while rsPages.Next() {
		set targetPageID = rsPages.Get("ID")
		if ##class(setup.lnkCategoryEvent).getAttendeeCategoryIDFromRegistrationPageID(targetPageID) = attendeeCategoryID {
			return targetPageID	
		}	
	}
	return sourcePageID
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.emailInput">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64205,53559.255246</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>email</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.emailAddress).%New()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.emailInputMulti">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64222,53217.643532</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>email</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.emailAddressMulti).%New()
]]></Implementation>
</Method>

<Method name="getExtraAttributes">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	do ..addAttribute("multiple","multiple")
	return ##super()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.fileUpload">
<Super>EF.ui.components.textInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64299,53549.107569</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set defaultClasses = "form-control ef-proweb-input-element noPrint standardButton ef_frontend_button "
	return defaultClasses
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	set dateForm = ##class(shared.dateFunctions).getFrontendInputDateFormat(..contextData.eventID)
	set timeFormat = 24
	set fileUploader=##class(EF.ui.components.frontend.fileUploadFacade).getFileUploader(..prowebItem.storage.prowebID, 3, 12)
	do fileUploader.render()
	
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>fileUploadDefaultData</DefaultData>
<Data name="fileUploadDefaultData">
<Subscript>"fileUpload"</Subscript>
<Value name="1">
<Value>alternatives</Value>
</Value>
<Value name="2">
<Value>isMandatory</Value>
</Value>
<Value name="3">
<Value>isBackendOnly</Value>
</Value>
<Value name="4">
<Value>contextData</Value>
</Value>
<Value name="5">
<Value>isGuest</Value>
</Value>
<Value name="6">
<Value>helpText</Value>
</Value>
<Value name="7">
<Value>guestNumber</Value>
</Value>
<Value name="8">
<Value>isProwebEditMode</Value>
</Value>
<Value name="9">
<Value>prowebItem</Value>
</Value>
<Value name="10">
<Value>prowebItemID</Value>
</Value>
<Value name="11">
<Value>maxWords</Value>
</Value>
<Value name="12">
<Value>maxCharacters</Value>
</Value>
<Value name="13">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="14">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.fileUploadFacade">
<Super>EF.ui.frontend.controls.uploaderWithFileList</Super>
<TimeChanged>64210,33384.999272</TimeChanged>
<TimeCreated>64209,49036.783857</TimeCreated>

<Method name="getFileUploader">
<ClassMethod>1</ClassMethod>
<FormalSpec>prowebID:%Integer,dateFormat,timeFormat</FormalSpec>
<ReturnType>EF.ui.frontend.controls.uploaderWithFileList</ReturnType>
<Implementation><![CDATA[

	set fileUploader=..%New()
	set fileUploader.uploaderTitle = ##class(shared.pCSP).out("Supporting Files")
	set fileUploader.htmlName = "fileUpload"
	;set fileUploader.objectID = documentID
	;set fileUploader.objectType = "abstract.objFile"
	set fileUploader.fileList = ##class(EF.ui.frontend.controls.fileList).%New()
	set fileUploader.fileList.htmlID = "fileUpload_"_prowebID
	set fileUploader.fileList.fileItems = ""
	
	Return fileUploader
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..renderJS()
	do ..renderHTML()
]]></Implementation>
</Method>

<Method name="renderHTML">
<Implementation><![CDATA[
	// The html bit
	&html<
		
		<div id="#(..encodeForHTMLAttribute(..htmlName))#_container" class="ef_frontend_file_uploader k-content">
			<input type="file" name="#(..encodeForHTMLAttribute(..htmlName))#" id="#(..encodeForHTMLAttribute(..htmlName))#" title="#(..encodeForHTMLAttribute(##class(shared.pCSP).out("Upload")))#">
	 	</div>
	>
]]></Implementation>
</Method>

<Method name="renderJS">
<Implementation><![CDATA[
	do ..renderUploadingTemplate()
    &html<
		<script language='javascript'>
		var ef = ef || {};
		ef.fileUploader = ef.fileUploader || {};
		
	    $(document).ready(function() {
		    
		    var uploaderInput=$("##(..encodeForJavaScript(..htmlName))#");
	        uploaderInput.kendoUpload({
	        	complete : onComplete,
	        	upload: onUpload,
	        	success: onSuccess,
	        	error: onError,
	        	progress: onProgress,
	        	showFileList : true,
	        	multiple : false,
	        	localization : {
		        	select : '#(..encodeForJavaScript(..buttonText))#'
	        	},
			    async: {
			        #(..rawJS(..renderASyncURL()))#
			    },
                template: kendo.template($('#fileTemplate_#(..encodeForJavaScript(..htmlName))#').html())
	        });
	        
	        function onSuccess(e) {
				#(..rawJS(..renderOnSuccessJS()))#
			}
	        function onError(e) {
				#(..rawJS(..renderOnErrorJS()))#
			}
	        function onComplete(e) {
				#(..rawJS(..renderOnCompleteJS()))#
				if (typeof ef.fileUploader.onCompleteCallback === "function") {
					ef.fileUploader.onCompleteCallback()
				}
			}
	        function onUpload(e) {
				#(..rawJS(..renderOnUploadJS()))#
				if (typeof ef.fileUploader.onUploadCallback === "function") {
					ef.fileUploader.onUploadCallback()
				}
			}
			function onProgress(e) {
				#(..rawJS(..renderOnProgressJS()))#	
			}
	    });
		
				
	</script>
	>
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.floatingMenu">
<Super>shared.pCSPmanage</Super>
<TimeChanged>64254,42130.140699</TimeChanged>
<TimeCreated>64203,40625.329831</TimeCreated>

<Method name="outputFloatingMenuHTML">
<Implementation><![CDATA[
	&html<
		<div id="myFloater" class="form-inline ef-proweb-menu-handle" style="display: none;">
	        <div class="ef-editor-floater-button-group" >
		        <button type="button" id="efProwebEditLink" class="btn btn-default">
		        	<span class="glyphicon glyphicon-pencil"></span>
				</button>
		        <button type="button" id="efProwebDeleteLink" class="btn btn-default" style="float: left;">
		        	<span class="glyphicon glyphicon-trash"></span>
				</button>
		        <button type="button" id="efProwebDropdownLink" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
		        	<span class="glyphicon glyphicon-plus"></span>
		        	<span class="caret"></span>
		        </button>
	        	<ul class="dropdown-menu" role="menu">
                  <li><a class="ef-proweb-dropdown-link" id="efProwebInsertQuestionBelowLink" tabindex="-1" href="#">Question</a></li>
                  <li><a class="ef-proweb-dropdown-link" id="efProwebInsertABIBelowLink" tabindex="-1" href="#">ABI</a></li>
                  <li><a class="ef-proweb-dropdown-link" id="efProwebInsertQBIBelowLink" tabindex="-1" href="#">QBI</a></li>
                  <li><a class="ef-proweb-dropdown-link" id="efProwebInsertTextBlockBelowLink" href="#">Text</a></li>
                  <li><a class="ef-proweb-dropdown-link" id="efProwebInsertDividerBelowLink" href="#">Divider</a></li>
                  <li><a class="ef-proweb-dropdown-link" id="efProwebInsertRegPromptCollectionBelowLink" tabindex="-1" href="#">Collection</a></li>
                  <li><a class="ef-proweb-dropdown-link" id="efProwebInsertFileUploadBelowLink" href="#">File upload</a></li>
                  <li><a class="ef-proweb-dropdown-link" id="efProwebInsertYouTubeVideoBelowLink" href="#">Video</a></li>
				</ul>
			</div>			
		</div>
	
	<div class="ef-Quick-Edit-Panel" style="display: none; padding: 5px;">
		<div id="topButtonsQuickEdit">
			<button type="button" id="quickEditSave" class="glyphicon glyphicon-ok"></button>
			<button type="button" id="quickEditClose" class="glyphicon glyphicon-remove"></button>
			<div style="float: right;">
				<button type="button" id="quickEditAdvanced">Advanced…</button>
			</div>
		</div>
		<div id="quickEditPanelMain">
			[EDIT PANEL]
		</div>
	</div>
	>
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.hiddenInput">
<Super>EF.ui.components.hiddenInput,EF.ui.components.frontend.prowebBase</Super>
<TimeChanged>64299,53549.136288</TimeChanged>
<TimeCreated>64288,56191.627065</TimeCreated>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>hiddenInputDefaultData</DefaultData>
<Data name="hiddenInputDefaultData">
<Structure>listnode</Structure>
<Subscript>"hiddenInput"</Subscript>
<Value name="1">
<Value>isProwebEditMode</Value>
</Value>
<Value name="2">
<Value>prowebItemID</Value>
</Value>
<Value name="3">
<Value>prowebItem</Value>
</Value>
<Value name="4">
<Value>contextData</Value>
</Value>
<Value name="5">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="6">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.inputElement">
<Super>EF.ui.components.frontend.prowebBase,EF.ui.components.inputBase</Super>
<TimeChanged>64267,36931.60838</TimeChanged>
<TimeCreated>64183,40678.260093</TimeCreated>

<Property name="alternatives">
<Type>EF.ui.components.alternative</Type>
<Collection>list</Collection>
</Property>

<Property name="isBackendOnly">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="guestNumber">
<Type>%Integer</Type>
</Property>

<Property name="isGuest">
<Type>%Boolean</Type>
</Property>

<Property name="helpText">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="%OnNew">
<FormalSpec>htmlID:%String</FormalSpec>
<Private>1</Private>
<ReturnType>%Status</ReturnType>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
	do ##super(htmlID)
	set ..htmlName=..htmlID
	set ..validator=..getDefaultValidator()
	
    Quit $$$OK
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.singleLineText).%New()
]]></Implementation>
</Method>

<Method name="getDefaultProwebClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "ef-input"
]]></Implementation>
</Method>

<Method name="renderRowOpeningAndLabel">
<Implementation><![CDATA[
	if ..#html5Validation {
		set regex=..validator.getRegex()
		if $length(regex) {
			do ..addAttribute("pattern",regex)
		}
		do ..addAttribute("oninvalid","ef.html5CustomMessages.setMessage(this,"""_..encodeForJavaScript(..validator.getErrorMessage())_""");")
		do ..addAttribute("oninput","ef.html5CustomMessages.clearMessage(this);")	
	}
	
	
	do ..renderRowOpening()
	write !,"<div class=""form-group"">"
	do ..renderLabelCellOpening()
	
	do ..renderLabel()
	do ..renderCellClosing()
	do ..renderInputElementCellOpening()
]]></Implementation>
</Method>

<Method name="renderHelpAndRowClosing">
<Implementation><![CDATA[
	if $Length(..helpText) > 0 {
		&html<
			<span class="glyphicon glyphicon-question-sign ef-help-icon" title="#(..encodeForHTMLAttribute(..helpText))#"></span>
		>
	}
	
	do ..renderInputLengthCounter()
	
	do ..renderCellClosing()
	write !,"</div>"
	do ..renderRowClosing()
]]></Implementation>
</Method>

<Method name="renderInputLengthCounter">
<Implementation><![CDATA[
	set maxWords = ..prowebItem.storage.maxWords
	set maxChars = ..prowebItem.storage.maxCharacters
	if (maxWords || maxChars) {
		&html<<span class="ef-text-length-count-message" data-input-id="#(..encodeHTMLAttribute(..htmlID))#">>
		if (maxWords) {
			&html<
				<span id="current-length-count-#(..encodeHTMLAttribute(..htmlID))#" data-type="words" data-max-length="#(..encodeHTMLAttribute(maxWords))#">0</span> 
				#(..encodeForHTML(##class(shared.pCSP).out("words of {{{VAR01}}}",,maxWords)))#
			>
		} elseif (maxChars) {
	    	&html<
	    		<span id="current-length-count-#(..encodeHTMLAttribute(..htmlID))#" data-type="chars" data-max-length="#(..encodeHTMLAttribute(maxChars))#">0</span> 
	    		#(..encodeForHTML(##class(shared.pCSP).out("characters of {{{VAR01}}}",,maxChars)))#
	    	>
		}
		&html<</span>>
	}
]]></Implementation>
</Method>

<Method name="renderLabel">
<Implementation><![CDATA[
	if $length(..label) {
		
		set labelElement = ##class(EF.ui.components.frontend.inputLabel).%New("ef-display-label-"_..htmlID)
		set labelElement.isMandatory =  ..validator.isMandatory
		set labelElement.for = ..htmlID
		set labelElement.text = ..label
		do labelElement.render()
					
		if ..contextData.prowebMode = "edit" {
			set directEditClasses = "ef-proweb-direct-label-edit"
			if ..validator.isMandatory {
				set directEditClasses = directEditClasses_" ef-required-field"
			}
			&html<
				<div class="#(..encodeForHTMLAttribute(directEditClasses))#" 
					style="display: none;" 
					id="ef-edit-label-input-#(..encodeForHTMLAttribute(..htmlID))#" 
					data-proweb-id="#(..prowebItem.storage.prowebID)#"
				>
				<input class="ef-control-label" id="quick-edit-#(..htmlID)#" type="text" value="#(..encodeForHTMLAttribute(..label))#">
					
				</div>
			>
		}
	}
]]></Implementation>
</Method>

<Method name="getBackendOnlyStyles">
<Implementation><![CDATA[
	if ..prowebItem.storage.isBackendOnly {
		set ..classes = ..classes_" ef-admin-only"	
	}
]]></Implementation>
</Method>

<Method name="getDisabledString">
<Implementation><![CDATA[
	set disabledString=""
	if ..isDisabled {
		set disabledString="disabled='disabled'"
	}
	return disabledString
]]></Implementation>
</Method>

<Method name="getAriaLabelForInputElement">
<Implementation><![CDATA[
	if $Length(..label) {
		return ""
	} else {
		return "aria-label="""_..encodeForHTMLAttribute(..prowebItem.storage.databaseItemName)_""""
	}
]]></Implementation>
</Method>

<Method name="renderLabelCellOpening">
<Implementation><![CDATA[	write "<div class=""col-sm-4 ef-label-container ",..encodeForHTMLAttribute(..getDependentClass()),""" ",..rawHTML(..getDependsOnText()),">"
]]></Implementation>
</Method>

<Method name="renderInputElementCellOpening">
<Implementation><![CDATA[	write "<div class=""col-sm-8 ef-input-container"">"
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>inputElementDefaultData</DefaultData>
<Data name="inputElementDefaultData">
<Subscript>"inputElement"</Subscript>
<Value name="1">
<Value>alternatives</Value>
</Value>
<Value name="2">
<Value>isMandatory</Value>
</Value>
<Value name="3">
<Value>guestNumber</Value>
</Value>
<Value name="4">
<Value>htmlName</Value>
</Value>
<Value name="5">
<Value>helpText</Value>
</Value>
<Value name="6">
<Value>title</Value>
</Value>
<Value name="7">
<Value>isGuest</Value>
</Value>
<Value name="8">
<Value>label</Value>
</Value>
<Value name="9">
<Value>validator</Value>
</Value>
<Value name="10">
<Value>value</Value>
</Value>
<Value name="11">
<Value>isBackendOnly</Value>
</Value>
<Value name="12">
<Value>maxWords</Value>
</Value>
<Value name="13">
<Value>maxCharacters</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.inputLabel">
<Super>EF.ui.components.label</Super>
<TimeChanged>64247,44645.72703</TimeChanged>
<TimeCreated>64231,55311.604253</TimeCreated>

<Method name="renderContents">
<Implementation><![CDATA[	write ..rawHTML(..text)
]]></Implementation>
</Method>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "control-label ef-control-label"
]]></Implementation>
</Method>

<Method name="getClasses">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set classes = ##super()
	if ..isMandatory {
		set classes = classes_" ef-required-field"
	}
	
	return classes
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.integerInput">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64246,55746.593963</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>number</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.integer).%New()
]]></Implementation>
</Method>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Return "form-control "_..getDefaultProwebClasses()_" ef-input-short"
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.label">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.ui.components.frontend.label.CLS/EV.3
;vc; Component: CLS.EF.ui.components.frontend.label
;vc;  Location: LargeDev
;vc; Date/Time: 07-Jul-16 10:45
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.ui.components.frontend.label.CLS/EV.3</td><td>CLS.EF.ui.components.frontend.label</td><td>LargeDev</td><td style='white-space: nowrap;'>07-Jul-16 10:45</td><td>FredG</td></tr></table>
]]></Description>
<Super>EF.ui.components.label</Super>
<TimeChanged>64205,53554.717519</TimeChanged>
<TimeCreated>63489,37931.767392</TimeCreated>

<Property name="isMandatoryMarkerOnLeft">
<Type>%Boolean</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="allowRawHTML">
<Description>
Required because we allow user defined raw html in the question text</Description>
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Method name="createAndRender">
<ClassMethod>1</ClassMethod>
<FormalSpec>htmlID="",text,for="",isMandatory=0,eventID=""</FormalSpec>
<Implementation><![CDATA[
	set label=..%New(htmlID)
	set label.text=text
	set label.for=for
	set label.isMandatory=isMandatory
	if eventID {
		set label.isMandatoryMarkerOnLeft=##class(layout.methods).areMandatoryMarkersOnTheLeftForEventID(eventID)	
	}
	do label.render()
]]></Implementation>
</Method>

<Method name="renderFromEfLabelRule">
<Description>
Expected parameters
text - mandatory
for
ismandatory
eventid</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&params]]></FormalSpec>
<Implementation><![CDATA[	do ..createAndRender(,params("text"),$g(params("for")),+$g(params("ismandatory")),$g(params("eventid")))
]]></Implementation>
</Method>

<Method name="renderContents">
<Implementation><![CDATA[
	if ..isMandatory {
		if ..isMandatoryMarkerOnLeft {
			do ..renderMandatoryMarker()
			w "&nbsp;"
		}
	}
	if ..allowRawHTML {
		write ..rawHTML(..text)
	} else {
		do ##super()
	}
	if ..isMandatory {
		if '..isMandatoryMarkerOnLeft {
			w "&nbsp;"
			do ..renderMandatoryMarker()
		}
	}
]]></Implementation>
</Method>

<Method name="renderMandatoryMarker">
<Implementation><![CDATA[	&html<<span id="#(..encodeHTMLAttribute(..getMandatoryMarkerForHtmlID(..for)))#" class="mandatory">*</span>>
]]></Implementation>
</Method>

<Method name="getMandatoryMarkerForHtmlID">
<ClassMethod>1</ClassMethod>
<FormalSpec>htmlID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "efManMarker-"_htmlID
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>labelDefaultData1</DefaultData>
<Data name="labelDefaultData1">
<Structure>listnode</Structure>
<Subscript>"label1"</Subscript>
<Value name="1">
<Value>isMandatoryMarkerOnLeft</Value>
</Value>
<Value name="2">
<Value>allowRawHTML</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.menuBlock">
<Super>EF.ui.components.frontend.prowebBase</Super>
<TimeChanged>64308,55170.970459</TimeChanged>
<TimeCreated>64183,38661.128484</TimeCreated>

<Method name="render">
<Implementation><![CDATA[
	#dim menuItem as sc.facade.prowebItemStorageMenuBlockItem

	do ..renderRowOpening()
		do ..renderCellOpening()
			&html<
				<div class="ef-menu-block #(..rawHTML(..getProwebExtraAttributes()))#">
					<div class="dropdown visible-xs-block">
						<button class="btn btn-primary dropdown-toggle ef-push-button ef-push-button-primary ef-menu-block-button" data-toggle="dropdown" type="button">Menu <span class="caret"></span></button>
						<ul class="dropdown-menu ef-menu-block-ul-xs">
							#[do ..outputListItems()]#
						</ul>
					</div>
					<div class="ef-nav-horizontal hidden-xs" role="nav">	
						<ul class="ef-menu-block-ul" >
							#[do ..outputListItems()]#
						</ul>
					</div>
				</div>	
			>
		do ..renderCellClosing()
	do ..renderRowClosing()
]]></Implementation>
</Method>

<Method name="outputListItems">
<Private>1</Private>
<Implementation><![CDATA[
	set menuCount = ..prowebItem.storage.listOfMenuItems.Count()
	for i = 1:1:menuCount {
		set menuItem = ..prowebItem.storage.listOfMenuItems.GetAt(i)
		
		set targetURL = menuItem.linkURL
		if targetURL["?" {
			set targetURL = targetURL_"&"
		} else {
			set targetURL = targetURL_"?"
		}
		set targetURL = targetURL_"eventID="_..contextData.eventID
		
		write !,"<li>"
		write "		<a href=""",..encodeForHTMLAttribute(##class(shared.pCSP).Link(targetURL)),""" target=""",menuItem.linkTarget,""">",..encodeForHTML(menuItem.text),"</a>"
		write !,"</li>"
	}
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>menuBlockDefaultData</DefaultData>
<Data name="menuBlockDefaultData">
<Subscript>"menuBlock"</Subscript>
<Value name="1">
<Value>text</Value>
</Value>
<Value name="2">
<Value>listOfHyperlinks</Value>
</Value>
<Value name="3">
<Value>listOfMenuItems</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.numericInput">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64246,55752.425738</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Description>
this cannot be set to 'number' as Chrome will then require you to define step increment as well</Description>
<Default>text</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[
	set validator = ##class(EF.validator.numeric).%New()
	set validator.precision = 2
	return validator
]]></Implementation>
</Method>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Return "form-control "_..getDefaultProwebClasses()_" ef-input-short"
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.pageHeader">
<Super>EF.ui.components.frontend.textBlock</Super>
<TimeChanged>64264,58652.560641</TimeChanged>
<TimeCreated>64264,58652.092844</TimeCreated>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpening()
		do ..renderCellOpening()
			write "<div class=""ef-page-header"" ",..rawHTML(..getProwebExtraAttributes()),">"
			write ..rawHTML(..text)
			write "</div>"
		do ..renderCellClosing()
	do ..renderRowClosing()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.panel">
<Super>EF.ui.components.frontend.prowebBase,EF.ui.components.panel</Super>
<TimeChanged>64288,54734.719594</TimeChanged>
<TimeCreated>64204,36543.176151</TimeCreated>

<Property name="guestNumber">
<Type>%Integer</Type>
</Property>

<Method name="renderStart">
<Implementation><![CDATA[
	&html<
			<div class="ef-panel ef-draggable-div"   #(..rawHTML(..getExtraAttributes()))#>
	            <div class="ef-panel-heading" id="">#(..encodeForHTML(##class(shared.pCSP).out("Guest")))#
					<div class="ef-delete-guest-button"  data-ef-guest-number="#(..guestNumber)#" >
						<span class="glyphicon glyphicon-trash"/>
					</div>
	            </div>
				<div class="ef-panel-body ef-proweb-reorderable-guest">
	>
]]></Implementation>
</Method>

<Method name="renderEnd">
<Implementation><![CDATA[
	&html<
				</div>
			</div>
	>
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>panelDefaultData</DefaultData>
<Data name="panelDefaultData">
<Subscript>"panel"</Subscript>
<Value name="1">
<Value>heading</Value>
</Value>
<Value name="2">
<Value>errorMessage</Value>
</Value>
<Value name="3">
<Value>isOpeningOrClosing</Value>
</Value>
<Value name="4">
<Value>guestNumber</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.passwordInput">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64208,51182.519457</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>password</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.phoneNumber">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64205,53559.838424</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>tel</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.phoneNumber).%New()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.privateData">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64217,40266.78793</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>textInput</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="render">
<Implementation><![CDATA[
	set ..value = ##class(shared.pCSP).out("Private field")
	set ..isDisabled = 1
	set ..title = ##class(shared.pCSP).out("This field can only be viewed and amended by the person in question")
	do ##super()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.progressBar">
<Super>EF.ui.components.frontend.prowebBase</Super>
<TimeChanged>64266,50391.950273</TimeChanged>
<TimeCreated>64246,45739.42717</TimeCreated>

<Method name="render">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataFrontend).createFromFrontendCSPSession()
	if (contextData.isTestMode) ! (##class(setup.objEventSetting).getParameter("reg pages","hide progress bar",..contextData.eventID) ) {
		quit
	}
	set pageName = "tregistration.csp" 
	set tmpProgress = ##class(setup.objPageNav).getProgress(pageName, contextData.pageID , contextData.sessionID , contextData.eventID, contextData.languageID)
	set value = $Piece(tmpProgress,"|",2)/$Piece(tmpProgress,"|",1)*100\5*5
	
	&html<
		<div class="row">
			<div class="col-sm-4"></div>
			<div class="col-sm-4">
				<div class="progress ef-progress-bar">
					<div class="progress-bar ef-progress-bar-filled" role="progressbar" style="width: #(..encodeForHTMLAttribute(value))#%;" aria-valuenow="#(..encodeForHTMLAttribute(value))#" aria-valuemin="0" aria-valuemax="100">
						<span class="sr-only">#(..encodeForHTML(value))#% Complete</span>
					</div>
				</div>
			</div>
			<div class="col-sm-4"></div>
		</div>
	>
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.prowebBase">
<Super>EF.ui.components.base</Super>
<TimeChanged>64299,47988.084053</TimeChanged>
<TimeCreated>64183,41819.123112</TimeCreated>

<Property name="isProwebEditMode">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
<Required>1</Required>
</Property>

<Property name="prowebItemID">
<Type>%Integer</Type>
</Property>

<Property name="prowebItem">
<Type>sc.facade.prowebItem</Type>
</Property>

<Property name="contextData">
<Type>EF.contextDataFrontend</Type>
</Property>

<Property name="nameOfControllerListClass">
<Type>%String</Type>
</Property>

<Property name="mvcPage">
<Type>EF.mvcHandler.frontendProweb</Type>
</Property>

<Method name="renderRowOpening">
<Implementation><![CDATA[
	if ..isProwebEditMode {
		set uiComponentType = $Piece($CLASSNAME(), ".", *)
		set allowedElementTypes = ##class(EF.pageController.proweb.list).getAllowedElementTypesForThisListType(..nameOfControllerListClass)

		&HTML<
			<div class="row ef-draggable-div ef-form-row ef-form-row-editable" 
			id="ef-field-proweb-#(..prowebItem.storage.prowebID)#" 
			data-proweb-id="#(..prowebItem.storage.prowebID)#" 
			data-proweb-list-id="#(..prowebItem.storage.getListID())#" 
			data-ui-component-type="#(..encodeForHTMLAttribute(uiComponentType))#"
			data-proweb-allowed-types="#(..encodeForHTMLAttribute(allowedElementTypes))#"
			>
			
		>
		
	} else {
		set dataAttributes = ""
		if (..contextData.prowebMode '= "edit") && ($IsObject(..showHideDependencyList)) {
			set dependencyListJSON = ##class(shared.jsonFunctions).getObjectAsJSONString(..showHideDependencyList)
			set dataAttributes = "data-show-hide-dependency-list="""_..encodeForHTMLAttribute(dependencyListJSON)_""" "
		}
		write !,"<div class=""row ef-form-row"" "_..rawHTML(dataAttributes)_">"
	}
]]></Implementation>
</Method>

<Method name="renderCellOpening">
<Implementation><![CDATA[
	&html<
		<div class="col-sm-12 #(..encodeForHTMLAttribute(..getDependentClass()))#" >
	>
]]></Implementation>
</Method>

<Method name="renderCellClosing">
<Implementation><![CDATA[	write "</div>"
]]></Implementation>
</Method>

<Method name="getDependsOnText">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if ..isProwebEditMode {
		return ..rawHTML(..prowebItem.storage.dependencyHoverText)
	} else {
		return ""
	}
]]></Implementation>
</Method>

<Method name="renderRowClosing">
<Implementation><![CDATA[		write "</div>"
]]></Implementation>
</Method>

<Method name="getDependentClass">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if (..showHideDependencyList '= "") && (..contextData.prowebMode = "edit") {	
		return "ef-dependent-field"
	} else {
		return ""
	}
]]></Implementation>
</Method>

<Method name="getProwebExtraAttributes">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set attributes=""
	
	if ($IsObject(..enableDisableDependencyList)) {
		set dependencyListJSON=##class(shared.jsonFunctions).getObjectAsJSONString(..enableDisableDependencyList)
		set attributes="data-enable-disable-dependency-list="""_..encodeForHTMLAttribute(dependencyListJSON)_""" "	
	}
	
	return attributes_##class(EF.ui.components.attribute).getAttributesAsHTML(..extraAttributes)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>prowebBaseDefaultData</DefaultData>
<Data name="prowebBaseDefaultData">
<Subscript>"prowebBase"</Subscript>
<Value name="1">
<Value>isProwebEditMode</Value>
</Value>
<Value name="2">
<Value>prowebItem</Value>
</Value>
<Value name="3">
<Value>contextData</Value>
</Value>
<Value name="4">
<Value>prowebItemStorage</Value>
</Value>
<Value name="5">
<Value>prowebItemID</Value>
</Value>
<Value name="6">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="7">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.radioGroup">
<Super>EF.ui.components.listInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64299,53549.282274</TimeChanged>
<TimeCreated>63356,39686.205586</TimeCreated>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Return ##super()_" btn-group "
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.singleLineText</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.validator.inList).%New()
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	write "<div class=""ef-input"">"
	do ..renderAlternatives()
	write "</div>"
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="renderInputElementCellOpening">
<Implementation><![CDATA[	write "<div class=""col-sm-8 ef-input-container ef-radio-group"">"
]]></Implementation>
</Method>

<Method name="renderCellOpening">
<Implementation><![CDATA[	write "<div class=""ef-radio-button"">"
]]></Implementation>
</Method>

<Method name="renderAlternative">
<FormalSpec>alternative:EF.ui.components.alternative</FormalSpec>
<Implementation><![CDATA[
	if $IsObject(..enableDisableDependencyList) {
		set alternative.enableDisableDependencyList = ..enableDisableDependencyList
	}
	do ..renderCellOpening()
	do alternative.removeClass("ef-btn-default")
	do alternative.addClass("ef-control-label")
	if ( alternative.%Extends("EF.ui.components.frontend.alternativeABI") ) && ( (alternative.isFull()) ! (alternative.isBookingStopped) ) {
		do alternative.addClass("ef-capacity-full")
		if '..contextData.isBackendBooking {
			set alternative.isDisabled = 1
		}
	}
	do alternative.render()
	do ..renderCellClosing()
]]></Implementation>
</Method>

<Method name="addRadioAlternative">
<FormalSpec>storageAlternative:sc.facade.prowebItemStorageInputElementAlternative,contextData:EF.contextDataRegistration,price:%Numeric</FormalSpec>
<ReturnType>EF.ui.components.alternative</ReturnType>
<Implementation><![CDATA[
	set htmlID = ..htmlID_"_"_(..alternatives.Count()+1)
	
	if storageAlternative.isABI {
		set radio = ##class(EF.ui.components.frontend.alternativeABIRadio).%New(htmlID)
		set radio.price = price
		set radio.capacity = storageAlternative.ABICapacity
		set radio.currentBookingLevel = storageAlternative.ABICurrentBookingLevel
		set radio.isBookingStopped = storageAlternative.ABIIsBookingStopped
		set radio.contextData = contextData
		
	} else {
		set radio = ##class(EF.ui.components.radio).%New(htmlID)
	} 
	set radio.label = storageAlternative.displayText

	set radio.value = storageAlternative.value
	
	set radio.htmlName = ..htmlName
	do radio.addClass("ef-btn-default")
	do radio.addAttribute("class","ef-radio-button")
	do ..alternatives.Insert(radio)
	
	// Also add to the validator
	do ..validator.addAllowedValue(storageAlternative.value)
	return radio
]]></Implementation>
</Method>

<Method name="renderLabelCellOpening">
<Implementation><![CDATA[	write "<div class=""col-sm-4 ef-label-container ef-label-container-vertical-group",..encodeForHTMLAttribute(..getDependentClass()),""" ",..rawHTML(..getDependsOnText()),">"
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>radioGroupDefaultData</DefaultData>
<Data name="radioGroupDefaultData">
<Subscript>"radioGroup"</Subscript>
<Value name="1">
<Value>isProwebEditMode</Value>
</Value>
<Value name="2">
<Value>isBackendOnly</Value>
</Value>
<Value name="3">
<Value>guestNumber</Value>
</Value>
<Value name="4">
<Value>contextData</Value>
</Value>
<Value name="5">
<Value>helpText</Value>
</Value>
<Value name="6">
<Value>isGuest</Value>
</Value>
<Value name="7">
<Value>prowebItem</Value>
</Value>
<Value name="8">
<Value>prowebItemID</Value>
</Value>
<Value name="9">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="10">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.textArea">
<Super>EF.ui.components.textInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64299,53549.378579</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set defaultClasses = ..getDefaultProwebClasses()
	set defaultClasses = defaultClasses_" form-control ef-input-text-area"
	return defaultClasses
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..getBackendOnlyStyles()
	if ..prowebItem.storage.isBackendOnly {
		set $this.placeHolder = "(Admin portal only)"
	}
		
	do ..renderRowOpeningAndLabel()
	&html<
    	    <textarea 
    	    	type="text" 
	    	    class="#(..encodeHTMLAttribute(..classes))#" 
	    	    #(..rawHTML(..getDisabledString()))# 
	    	    title="#(..encodeHTMLAttribute(..title))#" 
	    	    id="#(..encodeHTMLAttribute(..htmlID))#" 
	    	    name="#(..encodeHTMLAttribute(..htmlName))#" 
	    	    rows="#(..encodeHTMLAttribute(..prowebItem.storage.fieldHeight))#" 
	    	    placeholder="#(..encodeHTMLAttribute(..placeHolder))#" 
	    	    #(..rawHTML(..getExtraAttributes()))#
	    	    #(..rawHTML(..getAriaLabelForInputElement() ))#
    	   >#(..encodeHTMLContentForTextarea(..value))#</textArea>
    	
	>
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.multiLineText).%New()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>textAreaDefaultData</DefaultData>
<Data name="textAreaDefaultData">
<Subscript>"textArea"</Subscript>
<Value name="1">
<Value>alternatives</Value>
</Value>
<Value name="2">
<Value>isMandatory</Value>
</Value>
<Value name="3">
<Value>contextData</Value>
</Value>
<Value name="4">
<Value>isGuest</Value>
</Value>
<Value name="5">
<Value>helpText</Value>
</Value>
<Value name="6">
<Value>guestNumber</Value>
</Value>
<Value name="7">
<Value>isProwebEditMode</Value>
</Value>
<Value name="8">
<Value>prowebItem</Value>
</Value>
<Value name="9">
<Value>prowebItemID</Value>
</Value>
<Value name="10">
<Value>isBackendOnly</Value>
</Value>
<Value name="11">
<Value>maxWords</Value>
</Value>
<Value name="12">
<Value>maxCharacters</Value>
</Value>
<Value name="13">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="14">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.textBlock">
<Super>EF.ui.components.frontend.prowebBase</Super>
<TimeChanged>64245,49968.976305</TimeChanged>
<TimeCreated>64183,38661.128484</TimeCreated>

<Property name="text">
<Type>%String</Type>
<Parameter name="MAXLEN" value="1000000"/>
</Property>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpening()
		do ..renderCellOpening()
			write "<div class=""ef-text-block"" ",..rawHTML(..getProwebExtraAttributes()),">"
			write ..rawHTML(..text)
			write "</div>"
		do ..renderCellClosing()
	do ..renderRowClosing()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>textBlockDefaultData</DefaultData>
<Data name="textBlockDefaultData">
<Subscript>"textBlock"</Subscript>
<Value name="1">
<Value>text</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.textInput">
<Super>EF.ui.components.textInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64299,53549.414541</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>text</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Property name="hasAutoFocus">
<Type>%Boolean</Type>
</Property>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set defaultClasses = ..getDefaultProwebClasses()
	set defaultClasses = defaultClasses_" form-control ef-input-text-field"
	return defaultClasses
]]></Implementation>
</Method>

<Method name="getProwebExtraAttributes">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if ..hasAutoFocus {
		do ..addAttribute("autofocus","autofocus")
	}
	return ##super()
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..addClassForShortInputFields()

	do ..getBackendOnlyStyles()
	if ..prowebItem.storage.isBackendOnly {
		set $this.placeHolder = "(Admin portal only)"
	}

	do ..renderRowOpeningAndLabel()
	&html<
    	    <input type="#(..encodeHTMLAttribute(..#typeAttribute))#" 
	    	    class="#(..encodeHTMLAttribute(..classes))#" 
	    	    #(..rawHTML(..getDisabledString()))# 
	    	    title="#(..encodeHTMLAttribute(..title))#" 
	    	    id="#(..encodeHTMLAttribute(..htmlID))#" 
	    	    name="#(..encodeHTMLAttribute(..htmlName))#" 
	    	    value="#(..encodeHTMLAttribute(..value))#" 
	    	    placeholder="#(..encodeHTMLAttribute(..placeHolder))#"
	    	    #(..rawHTML(..getAriaLabelForInputElement() ))#  
	    	    #(..rawHTML(..getProwebExtraAttributes()))#
	    	    #(..rawHTML(..prowebItem.storage.caseConversionCommand))#
    	   >
	>
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.singleLineText).%New()
]]></Implementation>
</Method>

<Method name="addClassForShortInputFields">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	#dim shouldTHisFieldBeShort as %Boolean = 0

	if ..prowebItem.storage.inputType = "phoneNumber" {
		set shouldTHisFieldBeShort = 1
	}
	
	if ($this.%Extends("EF.ui.components.frontend.wholeNumber")) ! ($this.%Extends("EF.ui.components.frontend.integerInput")) {
		set shouldTHisFieldBeShort = 1
	}
	
	if $ZCVT(..prowebItem.storage.databaseItemName, "U") = "POSTCODE" {
		set shouldTHisFieldBeShort = 1	
	}
	
	if shouldTHisFieldBeShort {
		do ..addClass("ef-input-short") 
	}
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>textInputDefaultData1</DefaultData>
<Data name="textInputDefaultData1">
<Subscript>"textInput1"</Subscript>
<Value name="1">
<Value>alternatives</Value>
</Value>
<Value name="2">
<Value>isMandatory</Value>
</Value>
<Value name="3">
<Value>contextData</Value>
</Value>
<Value name="4">
<Value>isGuest</Value>
</Value>
<Value name="5">
<Value>helpText</Value>
</Value>
<Value name="6">
<Value>guestNumber</Value>
</Value>
<Value name="7">
<Value>isProwebEditMode</Value>
</Value>
<Value name="8">
<Value>prowebItem</Value>
</Value>
<Value name="9">
<Value>prowebItemID</Value>
</Value>
<Value name="10">
<Value>isBackendOnly</Value>
</Value>
<Value name="11">
<Value>hasAutoFocus</Value>
</Value>
<Value name="12">
<Value>maxWords</Value>
</Value>
<Value name="13">
<Value>maxCharacters</Value>
</Value>
<Value name="14">
<Value>nameOfControllerListClass</Value>
</Value>
<Value name="15">
<Value>mvcPage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.timeInput">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64251,52108.87085</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>text</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set defaultClasses = " ef-time-picker ef_proweb_form_field_container_type_time ef-kendo-form-control"
	return defaultClasses
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[
	set validator = ##class(EF.validator.timeInput).%New()
	
	set timeFormat=##class(setup.objEventSetting).getParameter("system","time format", ..contextData.eventID)	
	if 'timeFormat set timeFormat=24
	set validator.timeFormat = timeFormat
	
	return validator
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..removeClass("ef-input")
	do ..renderRowOpeningAndLabel()
	set ..classes = ..classes_" efTimePicker "
	set timeFormat = ..validator.timeFormat
	set ..placeHolder = ##class(shared.timeFunctions).getFrontendInputTimePattern(timeFormat)
	&html<
    	    <div style="width: 40%" class="#(..getDefaultClasses())#">
	    	    <input type="#(..encodeHTMLAttribute(..#typeAttribute))#" class="#(..encodeHTMLAttribute(..classes))#" #(..rawHTML(..getDisabledString()))# 
	    	    title="#(..encodeHTMLAttribute(..title))#" id="#(..encodeHTMLAttribute(..htmlID))#" name="#(..encodeHTMLAttribute(..htmlName))#" 
	    	    value="#(..encodeHTMLAttribute(..value))#" placeholder="#(..encodeHTMLAttribute(..placeHolder))#"  #(..rawHTML(..getProwebExtraAttributes()))#
	    	    efKendoTimeFormat="#(..encodeHTMLAttribute(timeFormat))#" efKendoTimeInterval=15 style="width: 100%;">
			</div>
			   	
	>
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.webAddress">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64205,53560.130874</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>url</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.webAddress).%New()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.ui.components.frontend.youTubeVideo">
<Super>EF.ui.components.frontend.prowebBase</Super>
<TimeChanged>64246,58251.010312</TimeChanged>
<TimeCreated>64188,59498.911424</TimeCreated>

<Property name="yourTubeVideoURL">
<Type>%String</Type>
</Property>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpening()
		do ..renderCellOpening()
			&html<
				<div class="ef-video">
					<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="//download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=5,0,0,0" width=#(..prowebItem.storage.width)# height=#(..prowebItem.storage.height)#>
						<param name=movie value="#(..prowebItem.storage.youTubeVideoURL)#">
						<param name=quality value=high>
						<param name=wmode value=transparent>
						<param name="LOOP" value="#(..prowebItem.storage.isLooped)#">
						<param name="menu" value="false">
						<embed src="//www.youtube.com/v/sJ363mnyHEk?fs=1&amp;hl=en_GB" wmode=transparent quality=high pluginspage="//www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash" type="application/x-shockwave-flash" loop="true" width=600 height=360>
						</embed>
					</object>			
				</div>
			>
		do ..renderCellClosing()
	do ..renderRowClosing()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>youTubeVideoDefaultData</DefaultData>
<Data name="youTubeVideoDefaultData">
<Subscript>"youTubeVideo"</Subscript>
<Value name="1">
<Value>yourTubeVideoURL</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.ui.components.panel">
<Super>EF.ui.components.container</Super>
<TimeChanged>64205,53541.434064</TimeChanged>
<TimeCreated>63361,62973.538498</TimeCreated>

<Property name="heading">
<Type>%String</Type>
<Parameter name="MAXLEN" value="1000"/>
</Property>

<Property name="errorMessage">
<Type>%String</Type>
<Parameter name="MAXLEN" value="10000"/>
</Property>

<Method name="renderStart">
<Implementation><![CDATA[
	set classes="ef-admin-settings-panel"
	if $l(..errorMessage) {
		set classes=classes_" ef-panel-with-error"
	}
	&HTML<
		<div class="#(classes)#" id="#(..encodeHTMLAttribute(..htmlID))#">
            <div class="panel-heading">#(..encodeHTMLContent(..heading))#</div>
            	#[do ..renderErrorMessage()]#
	>
]]></Implementation>
</Method>

<Method name="renderEnd">
<Implementation><![CDATA[
	&HTML<
        </div>
	>
]]></Implementation>
</Method>

<Method name="renderErrorMessage">
<Implementation><![CDATA[
	if $l(..errorMessage) {
		&html<
			<div class="ef-panel-message-area">
				<div class="alert alert-danger ">#(..rawHTML(..errorMessage))#
	            </div>
	        </div>
		>
	}
]]></Implementation>
</Method>

<Method name="addErrorMessage">
<FormalSpec>errorMessage</FormalSpec>
<Implementation><![CDATA[
	if $l(..errorMessage) {
		set ..errorMessage=..errorMessage_..rawHTML("<br>")	
	}
	set ..errorMessage=..errorMessage_..encodeHTMLContent(errorMessage)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>panelDefaultData</DefaultData>
<Data name="panelDefaultData">
<Structure>listnode</Structure>
<Subscript>"panel"</Subscript>
<Value name="1">
<Value>heading</Value>
</Value>
<Value name="2">
<Value>errorMessage</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.validator.bespokeValidationMethod">
<Super>EF.validator.base</Super>
<TimeChanged>64218,35948.971918</TimeChanged>
<TimeCreated>64218,33344.811935</TimeCreated>

<Property name="bespokeValidationMethod">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Property name="databaseItemName">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Property name="tempPersonID">
<Type>%Integer</Type>
</Property>

<Method name="isInputValid">
<FormalSpec>input</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set className = "customCode.codAnswerValidation."_##class(shared.callOuts).classNameForBespokeCode()
	set methodName = $Piece(..bespokeValidationMethod, "##", 2)
	return $CLASSMETHOD(className, methodName, ..databaseItemName, input, ..tempPersonID)
]]></Implementation>
</Method>
</Class>


<Class name="EF.validator.emailAddressMulti">
<Super>EF.validator.base</Super>
<TimeChanged>64201,61804.004963</TimeChanged>
<TimeCreated>63883,60398.119435</TimeCreated>

<Property name="regex">
<Type>%String</Type>
<InitialExpression>##class(EF.utils.dataValidation).getValidationPatternForDataType("multiEmailAddress")</InitialExpression>
</Property>
</Class>


<Class name="EF.validator.patternMatchValidation">
<Super>EF.validator.base</Super>
<TimeChanged>64218,30662.805666</TimeChanged>
<TimeCreated>64217,58029.013584</TimeCreated>

<Property name="pattern">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Method name="isInputValid">
<FormalSpec>input</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ##class(cod.objItemName).patternMatch(input, ..pattern)
]]></Implementation>
</Method>
</Class>


<Class name="EF.validator.personRegisteredWithSameAnswer">
<Super>EF.validator.base</Super>
<TimeChanged>64218,37610.99879</TimeChanged>
<TimeCreated>64218,37118.837385</TimeCreated>

<Property name="prowebID">
<Type>%Integer</Type>
</Property>

<Method name="isInputValid">
<FormalSpec>input</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set fieldType = ##class(sc.xModules.objCODitem).getType(..prowebID)
	set databaseItemName = ##class(sc.xModules.objCODitem).getCODItemName(..prowebID)
	set eventID = ##class(sc.objData).getEventID(..prowebID)
	
	if fieldType = "time" {
		set input = ##class(shared.timeFunctions).getHorologTime(input)	
		
	} elseif fieldType = "date" {
		set input = ##class(shared.dateFunctions).multiDate(input,1)	
	}
	if ##class(cod.objItemData).findSingleForEvent(databaseItemName, input, eventID) {
		return 1
	} else {
		return 0
	}
]]></Implementation>
</Method>
</Class>


<Class name="EF.validator.phoneNumber">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.validator.integer.CLS/EV.3
;vc; Component: CLS.EF.validator.integer
;vc;  Location: LargeDev
;vc; Date/Time: 07-Mar-16 16:09
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.validator.integer.CLS/EV.3</td><td>CLS.EF.validator.integer</td><td>LargeDev</td><td style='white-space: nowrap;'>07-Mar-16 16:09</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.validator.base</Super>
<TimeChanged>64198,63518.953556</TimeChanged>
<TimeCreated>63364,34365.891052</TimeCreated>

<Method name="getRegex">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ##class(EF.utils.dataValidation).getValidationPatternForDataType("phoneNumber")
]]></Implementation>
</Method>
</Class>


<Class name="EF.validator.phoneNumberTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64197,43397.465718</TimeChanged>
<TimeCreated>63375,58376.236052</TimeCreated>

<Method name="TestisInputValid">
<Implementation><![CDATA[
	set validator=##class(phoneNumber).%New()
	do $$$AssertTrue(validator.isInputValid("02076883233"))
	do $$$AssertTrue(validator.isInputValid("+44 77 40 9444 80"))
	do $$$AssertTrue(validator.isInputValid("+44 (0) 77 40 9444 80"))
	do $$$AssertTrue(validator.isInputValid("0044 (0) 77 40 9444 80"))
	do $$$AssertTrue(validator.isInputValid("12 14 66"))
	do $$$AssertNotTrue(validator.isInputValid("a"))
	do $$$AssertNotTrue(validator.isInputValid("020 76 78 23 12 Ext 777"))
	do $$$AssertNotTrue(validator.isInputValid("020 76 78 23 12 Ext. 777"))
	do $$$AssertTrue(validator.isInputValid("020-76 78 23 12 "))
	do $$$AssertTrue(validator.isInputValid(""))
	set validator.isMandatory=1
	do $$$AssertNotTrue(validator.isInputValid(""))
]]></Implementation>
</Method>

<Method name="TestgetErrorMessage">
<Implementation><![CDATA[	do $$$AssertNotEquals(##class(phoneNumber).%New().getErrorMessage(),"")
]]></Implementation>
</Method>

<Method name="TestGetRegEx">
<Implementation><![CDATA[
	set validator=##class(phoneNumber).%New()
	do $$$AssertEquals(validator.getRegex(),"^(?!(.*-(\s)*-.*))(?!(.*\.(\s)*\..*))(?=.*[\d\)](\s)*$)(?=.*(\d)+.*)(\+(\d){1,3}){0,1}(?=\s*([\d\(]).*)(([\d\s\-\.])|(\(([\d\-\.\s])+\)))*(\s)*$")
]]></Implementation>
</Method>

<Method name="TestgetValidatorObject">
<Implementation><![CDATA[
	try {
		set validator=##class(base).getValidatorObject("phoneNumber")
	} catch {
		set validator=""
	}
	do $$$AssertTrue(($IsObject(validator))&&(validator.%IsA("EF.validator.phoneNumber")))
]]></Implementation>
</Method>
</Class>


<Class name="EF.validator.webAddress">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.validator.integer.CLS/EV.3
;vc; Component: CLS.EF.validator.integer
;vc;  Location: LargeDev
;vc; Date/Time: 07-Mar-16 16:09
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.validator.integer.CLS/EV.3</td><td>CLS.EF.validator.integer</td><td>LargeDev</td><td style='white-space: nowrap;'>07-Mar-16 16:09</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.validator.base</Super>
<TimeChanged>64198,63556.464934</TimeChanged>
<TimeCreated>63364,34365.891052</TimeCreated>

<Method name="getRegex">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ##class(EF.utils.dataValidation).getValidationPatternForDataType("webAddress")
]]></Implementation>
</Method>
</Class>


<Class name="EF.validator.webAddressTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64198,63839.009025</TimeChanged>
<TimeCreated>63375,58376.236052</TimeCreated>

<Method name="TestisInputValid">
<Implementation><![CDATA[
	set validator=##class(webAddress).%New()

	do $$$AssertTrue(validator.isInputValid("http://www.bbc.com"))
	do $$$AssertTrue(validator.isInputValid("http://www.bbc.com/myparam=666"))
	do $$$AssertTrue(validator.isInputValid("http://www.bbc.com/myparam=666&something=else"))

	do $$$AssertTrue(validator.isInputValid("https://www.bbc.com"))
	do $$$AssertTrue(validator.isInputValid("https://www.bbc.com/myparam=666"))
	do $$$AssertTrue(validator.isInputValid("https://www.bbc.com/myparam=666&something=else"))

	do $$$AssertTrue(validator.isInputValid("www.bbc.com/myparam=666&something=else"))
	do $$$AssertTrue(validator.isInputValid("www.bbc.com/myparam=666"))
	do $$$AssertTrue(validator.isInputValid("www.bbc.com/myparam=666&something=else"))

	do $$$AssertNotTrue(validator.isInputValid("fish"))
	do $$$AssertNotTrue(validator.isInputValid("1234123"))
	do $$$AssertTrue(validator.isInputValid("www.bbc.com"))

	do $$$AssertNotTrue(validator.isInputValid("hxtp://www.bbc.com"))
	do $$$AssertNotTrue(validator.isInputValid("xhttp://www.bbc.com/myparam=666"))
	do $$$AssertNotTrue(validator.isInputValid("htxtp://www.bbc.com/myparam=666&something=else"))


	set validator.isMandatory=1
	do $$$AssertNotTrue(validator.isInputValid(""))
]]></Implementation>
</Method>

<Method name="TestgetErrorMessage">
<Implementation><![CDATA[	do $$$AssertNotEquals(##class(webAddress).%New().getErrorMessage(),"")
]]></Implementation>
</Method>

<Method name="TestGetRegEx">
<Implementation><![CDATA[
	set validator=##class(webAddress).%New()
	do $$$AssertEquals(validator.getRegex(),"^(?:https?:\/\/)?(?:\S+(?::\S*)?@)?(?:(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/.*)?$")
]]></Implementation>
</Method>

<Method name="TestgetValidatorObject">
<Implementation><![CDATA[
	try {
		set validator=##class(base).getValidatorObject("webAddress")
	} catch {
		set validator=""
	}
	do $$$AssertTrue(($IsObject(validator))&&(validator.%IsA("EF.validator.webAddress")))
]]></Implementation>
</Method>
</Class>


<CSP name="backEnd/Home/inSiteEditingFrame.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:include page="../../backend/home/backendTop.csp?hideBackendMenu=1&forceIE9mode=1">
<script type="text/javascript" src="../../backend/home/inSiteEditingFrame.js?v=0"></script>
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean"> 
	do ##class(shared.pageMethods).createBackendVariables()
	
	set frontback=..frontBack()   // method is in shared.pCSP

	// clear the entire frontend session as we do not want any leftovers from when testing the event.
	kill %session.Data("eventsforce","frontend")
	kill %session.Data("pageID")
	
	Quit 1
</script>
<style>
	html, body {
		width: 100%;
		height: 100%;
		overflow: hidden;
		padding: 0;
		margin: 0;
	}
</style>
<script language="cache" runat="server">
	set xWorkLangID=##class(shared.pageMethods).getBackendWorkLangID(xLangID)
	if %request.Get("pageID") {
		set pageID = %request.Get("pageID")	
	} else {
		set pageID=##class(setup.pageIDmethods).getEventHomePage(xEventID,xWorkLangID)
	}
	set %session.Data("pageID")=pageID	
	// we need the frontend session set up so that it doesn't try to redirect to the homepage and then use the frontend domain that has been specified 
	// (which could be different to backend domain in the case of eventsforce users).
	do ##class(shared.pageMethods).buildFrontendSessionVariablesFromEventID(xEventID)
	set initialURL=..Link("../../system/proweb/start.csp?mode=edit&inSitePageEditing=1&hideButtons=0&eventID="_..encodeForURL(xEventID))
</script>
<div id="ef_backend_insite_page_editing_top_container"><iframe id="ef_backend_insite_page_editing_top" name=topBit src="../../backend/home/inSitePageEditing.csp?mode=edit&doNotReload=1&selectedMenuID=#(%request.Get("selectedMenuID"))#" scrolling="no"></iframe></div>
<div id="ef_backend_insite_page_editing_spacer"></div>
<div id="ef_backend_insite_page_editing_main_container"><iframe id="ef_backend_insite_page_editing_main" name=mainBit src="#(..encodeForHTMLAttribute(initialURL))#"></iframe></div>
<csp:include page="../../backend/home/backendBottom.csp">
]]></CSP>


<CSP name="backEnd/Home/regPages.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<csp:include page="../../backend/home/backendTop.csp">
<script language="cache" runat="server">
	set xWorkLangID=##class(shared.pageMethods).getWorkLangID()
	
	if ##class(setup.objSystemTypes).isModuleAllowed("Multi Reg Pages Per Category"),%request.Get("addPage")=1	{
		set eventCategoryID=%request.Get("eventCategoryID")
		if eventCategoryID	{
			set description=##class(setup.objEventCategory).getDescription(eventCategoryID)
			// get the translated version
			set newDescription=##class(setup.objEventCategory).getDescription(eventCategoryID,xWorkLangID)
			// Temporarily change xLangID so we can transalate 
			set tmpLangID=xLangID
			set xLangID=xWorkLangID
			set newDescription=##class(setup.objEventCategory).getDescription(eventCategoryID,xWorkLangID)_" "_..out("details")
			set xLangID=tmpLangID
			#define doNotAddRegistrationQuestions 0
			set lnk=##class(setup.lnkCategoryEvent).add(xEventID,description,"","","",xWorkLangID,newDescription,$$$doNotAddRegistrationQuestions)
			&SQL(SELECT pageID,objEventCategory->description,langID INTO :pageID,:catDesc,:langID FROM setup.lnkCategoryEvent WHERE ID = :lnk)
			if +SQLCODE=0 {
				&SQL(UPDATE setup.lnkCategoryEvent SET description=:description WHERE ID=:linkID)
				do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page Setup '"_newDescription_"' ("_pageID_"), Category "_catDesc_", "_$S(langID'=1:"Lang "_##class(shared.objLanguage).getLanguageDesc(langID)_", ",1:"")_" Page Added")
			}
		}
	}
	if ##class(setup.objSystemTypes).isModuleAllowed("Multi Reg Pages Per Category"),%request.Get("deletePage")=1	{
		set linkID=%request.Get("linkID")
		if linkID	{
			&SQL(SELECT description,pageID,objEventCategory->description,langID INTO :tmp,:tmp2,:tmp3,:tmp4 FROM setup.lnkCategoryEvent WHERE ID=:linkID)
			if +SQLCODE=0 {
				set description=tmp,pageID=tmp2,catDesc=tmp3,langID=tmp4
				//Shahadat: We do not need to delete recursively. Deleting the page will do.
				//set ok=##class(sc.objData).deleteRecursively(pageID)
				&SQL(UPDATE sc.objData SET active=0 WHERE ID=:pageID)
				//The following situation should not arise, because a page cannot be deleted if it is linked to. 
				//&SQL(UPDATE setup.lnkCategoryEvent SET pageID=NULL, sameAs=NULL WHERE (pageID=:pageID))
				&SQL(DELETE FROM setup.lnkCategoryEvent WHERE ID=:linkID)
				do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page Setup '"_description_"' ("_pageID_"), Category "_catDesc_", "_$S(langID'=1:"Lang "_##class(shared.objLanguage).getLanguageDesc(langID)_", ",1:"")_" Page Deleted")
			}		
		}
	}

	if %request.Get("move") {
		set linkID=%request.Get("linkID")
		set direction=%request.Get("direction")
		set ok=##class(setup.lnkCategoryEvent).move(linkID,direction)
	}

	// setup parameters needed for frontend use so it pulls in the correct style sheet and images
	set %session.Data("eventsforce","frontend","xEventID")=xEventID

	// v2.7 setup the other parameters esp. the clientDir so that the edit mode does not show the eventsforce logo and gets the correct stylesheets
	set %session.Data("eventsforce","frontend","xLanguage")=##class(shared.objLanguage).getLanguageDesc(xLangID)
	set %session.Data("eventsforce","frontend","xLangID")=xLangID
	set %session.Data("eventsforce","frontend","xPrefLangID")=xWorkLangID
	set %session.Data("eventsforce","frontend","xClientDir")=##class(setup.objSetting).getParameter("paths","clientDirectory")
	set %session.Data("eventsforce","frontend","xClientStyleDir")=##class(setup.objSetting).getParameter("paths","clientStyleDirectory")
	set %session.Data("eventsforce","frontend","xDateFormat")=##class(setup.objEvent).getDateFormat(xEventID)
	
	set showAll=%request.Get("showAll")
	if showAll="true" set showAll=1
</script>
<form method="post" action="regPages2.csp" name="frmONE">
<div class="topsave">
	<input type="image" src="../../media/images/English/Default/backend/save.gif" border="0" alt="Save" title="Save changes" name="butSave" width="65" height="17">
</div>

<script language="cache" runat="server">
	// disable this page if it is an awards event
	set isAwards=##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID)
	set tmp=##class(links.lnkPersonEvent).countAttended(xEventID)
	set numberRegistered=0
	set index=$LENGTH(tmp,"|")
	for i=1:1:index {
		set numberRegistered=numberRegistered+$P(tmp,"|",i)
	}

	set showLangs=0
	if ##class(setup.objSystemTypes).isModuleAllowed("Multi Lingual Frontend")	{
		set count=##class(shared.objLanguage).getOrderedArrayOfLanguagesForEvent(xEventID,.languages)
		if count>1 {
			set showLangs=1
		}
	}
</script>
<style>
.contentarea {width:976px;}
table {margin-left:0px;margin-right:0px;}
</style>

<div class="contentarea">
	<div class="contentbox" style="padding-bottom:0px;">
		<h2 style="margin-bottom:0px;"><tx>Available Registration Pages</tx></h2>
				<div class="gen1_panel_subheader">
					<tx>This page shows you the registration pages that are set up for your event.</tx>
					<br>
					<tx>To edit the page contents, click on Edit. To change the heading for the page, click the hyperlink over the description.</tx>
					<br><br>
				</div>
			<csp:if condition=(showLangs)>
						<table width="100%" cellspacing="0" cellpadding="0" border="0">
							<tr style="background-color:whiteSmoke;">
								<td class="black10px" width="175" style="padding-left:24px;" valign="top"><tx>Select Language</tx>:</td>
								<td>
									<table cellspacing="0" cellpadding="0" border="0">
									<script language="cache" runat="server">
										set noOfEmptyCols = count # 3
										if (noOfEmptyCols '= 0) {
											set noOfEmptyCols = 3 - noOfEmptyCols
										}
									</script>
									<csp:loop counter="x" FROM=1 TO=#(count)#>
										<csp:if condition="(x # 3)=1">
											<tr>
										</csp:if>
										<td width=20><input type="radio" value="#(+languages(x))#" name="radLanguage" #($S(+languages(x)=xWorkLangID:"CHECKED",1:""))# onClick="changeLang(this.value);"></td>
										<td class="black10px" width=100>#($p(languages(x),"|",2))#</td>
										<csp:if condition="(x # 3)=0">
											</tr>
										</csp:if>
									</csp:loop>
									<csp:if condition="noOfEmptyCols '= 0">
										<csp:loop counter="x" FROM=1 TO=#(noOfEmptyCols)#>
											<td>&nbsp;</td><td>&nbsp;</td>
										</csp:loop>
										</tr>
									</csp:if>
									</table>
								</td>
							</tr>
						</table>
			</csp:if>
				<table width="100%" cellspacing="0" cellpadding="0" border="0">
					<tr style="background-color:whiteSmoke;">
						<td class="black10px" width="175" style="padding-left:24px;" height="30">
							<tx>Show Inactive Pages</tx>:
						</td>
						<td>
							<input type="checkbox" name="showAll" #($S(showAll:"checked",1:""))#  value="1" onClick="javascript: document.location='#(..Link(%request.PageName_"?zzz=999"))#&showAll=' + this.checked;">
						</td>
					</tr>
				</table>
	</div>

	<script language="cache" runat="server">
		set eventAllowsGroupBookings=##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)
		set extraBit=""
		if xWorkLangID'=xLangID set extraBit=" - "_##class(shared.objLanguage).getLanguageDesc(xWorkLangID)
		if eventAllowsGroupBookings set bookerPageID=##class(setup.objEventSetting).getParameter("bookings","bookerRegPageID"_extraBit,xEventID)
		
		if 'isAwards {
			
			// Populate the prompts and alternatives listboxes when loading the page
			write !!,"<scri"_"pt language='jav"_"ascri"_"pt'>"
			write !,"var alts = new Array();"
			
			if eventAllowsGroupBookings {
				set pages(bookerPageID)=""
			}
			
			set rsPages=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			set ok=rsPages.Prepare("SELECT pageID,sameAs,sameAs->pageID as linkedToPage FROM setup.lnkCategoryEvent WHERE (objEvent=?) AND (langID=?) AND (active=1)")
			do rsPages.Execute(xEventID,xWorkLangID)
			while rsPages.Next() { 
				if 'rsPages.Get("sameAs") {
					set tmpPageID=rsPages.Get("pageID")
				} else {
					set tmpPageID=rsPages.Get("linkedToPage")
				}
				set pages(tmpPageID)=""
			}
			set tmpPageID=""
			for {
				set tmpPageID=$O(pages(tmpPageID))
				if tmpPageID="" quit
				// now find all the alts for this prompt
				set rsCodItems=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
				set ok2=rsCodItems.Prepare("SELECT ID,objItemName,objItemName->description As codItem,displayOrder FROM sc_xModules.objCODitem WHERE (parent->parent=?) AND (active=1) AND (type IN ('dropdown','radiobutton')) ORDER BY displayOrder")
				do rsCodItems.Execute(tmpPageID)
				while rsCodItems.Next() {
					set tmpItemNameID=rsCodItems.Get("objItemName")
					set prompts(tmpItemNameID)=""
				}
			}
			set tmpItemNameID=""
			for {
				set tmpItemNameID=$o(prompts(tmpItemNameID))
				if tmpItemNameID="" quit
				set altCounter=0
				write !,"alts[",tmpItemNameID,"] = new Array();"
				// now find all the alts for this prompt
				set rs2=##class(cod.objItemAlternatives).getAlternativesForCodItemAsResultSet(tmpItemNameID)
				set altCounter=0
				while rs2.Next() {
					set itemAltID=rs2.Get("ID")
					write !,"  alts[",tmpItemNameID,"][",altCounter,"] = ",..QuoteJS(itemAltID_"|"_rs2.Get("description")),";"
					set altCounter=altCounter+1
				}
			}
			write !!,"</scr"_"ipt>"
		}
		// show warning if the event is live
		&SQL(SELECT status INTO :tmp FROM setup.objEvent WHERE ID = :xEventID)
		if +SQLCODE=0,tmp="live",'$l($G(%session.Data("eventsforce","backend","errmsg"))) {
			write "<scr"_"ipt language='javascri"_"pt'>alert('"_..out("WARNING!")_"\n"_..out("Amending any registration prompt, additional booking item, price or discount after an event has gone live will dramatically affect any currently existing registrations.")_"\n"_..out("It is strongly recommended that you never alter such items after registrations have been made.")_"')</sc"_"ript>"
		}
	
		
		// check for error messages
		if $G(%session.Data("eventsforce","backend","regPages","errMsg"))'="" {
			write !,"<scri"_"pt language='javas"_"cript'>alert('"_%session.Data("eventsforce","backend","regPages","errMsg")_"');</scr"_"ipt>"
			kill %session.Data("eventsforce","backend","regPages","errMsg")
		}
		
		set show=0
		if eventAllowsGroupBookings,'isAwards set show=1
	</script>
	<csp:if condition=(show)>
		<div class="contentbox">
			<systemType:if module="Table Booking">
				<h2><tx>Registration Contact and Table Guests</tx></h2>
			<systemType:else>
				<h2><tx>Registration Contact</tx></h2>
			</systemType:if>
	   		<table width="100%" border="0" cellpadding="0" cellspacing="0">
		   		<tr>
					<td class="black10px" width="24">
						&nbsp;
					</td>
					<td class="black10px" height="40" width="150">
						<tx>Registration Contact Details</tx>
					</td>
					<td class="black10px" height="20">
						<a target="frameEdit" href="../../system/proweb/start.csp?pageID=#(bookerPageID)#&mode=edit&hideButtons=1&version=current&eventID=#(xEventID)#&initialiseSession=1"><img id="ef-backend-registration-pages-edit-page-#(..encodeForHTMLAttribute(bookerPageID))#" src="../../media/images/English/Default/backend/edit.gif" width="45" height="17" alt="" border="0" /></a>
					</td>
				</tr>
			   	<systemType:if module="Table Booking">
					<script language="cache" runat="server">
						set show=##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID)
					</script>
					<csp:if condition=(show)>
					   <tr>
							<td class="black10px">&nbsp;</td>
							<td class="black10px"><tx>Table Guests Page</tx></td>
							<td>
								<script language="cache" runat="server">
									set pageID=##class(setup.objEventSetting).getParameter("bookings","Table Guests PageID"_extraBit,xEventID)
								</script>
								<a target="frameEdit" href="../../system/proweb/start.csp?pageID=#(pageID)#&mode=edit&hideButtons=1&version=current&eventID=#(xEventID)#&initialiseSession=1"><img id="ef-backend-registration-pages-edit-page-#(..encodeForHTMLAttribute(pageID))#"	src="../../media/images/English/Default/backend/edit.gif" width="45" height="17" alt="" border="0" /></a>
							</td>
					   </tr>
				   </csp:if>
				</systemType:if>
	   		</table>
		</div>
	</csp:if>
	<systemType:if module="Awards">
		<script language="cache" runat="server">
			set show=##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID)
		</script>
		<csp:if condition=(show)>
			<div class="contentbox">
				<script language="cache" runat="server">
					set pageID=##class(setup.objEventSetting).getParameter("awards","awardClientPageID",xEventID)
				</script>
				<h2><tx>Awards</tx></h2>
				<table width="100%" border="0" cellpadding="0" cellspacing="0">
			   		<tr>
						<td class="black10px" width="24">
							&nbsp;
						</td>
						<td class="black10px" height="40" width="150">
							<tx>Submitter Details Page</tx>
						</td>
						<td class="black10px" height="20">
							<a target="frameEdit" href="../../system/proweb/start.csp?pageID=#(pageID)#&mode=edit&hideButtons=1&version=current&eventID=#(xEventID)#&initialiseSession=1"><img id="ef-backend-registration-pages-edit-page-#(..encodeForHTMLAttribute(pageID))#" src="../../media/images/English/Default/backend/edit.gif" width="45" height="17" alt="" border="0" /></a>
						</td>
					</tr>
		   		</table>
			</div>
		</csp:if>
	</systemType:if>
	<systemType:if module="Accommodation">
		<script language="cache" runat="server">
			set show=0
			if ##class(setup.objEventSetting).getParameter("bookings","allow accommodation bookings",xEventID) {
				if ##class(setup.objEventSetting).getParameter("bookings","use new accommodation page flow",xEventID) {
					if ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
						set show=1
					}
				}
			}
		</script>
		<csp:if condition=(show)>
			<div class="contentbox">
				<script language="cache" runat="server">
					set pageID=##class(sc.pageMethods).getAccomGuestPageID(xEventID,xWorkLangID)
				</script>
				<h2><tx>Accommodation</tx></h2>
				<table width="100%" border="0" cellpadding="0" cellspacing="0">
			   		<tr>
						<td class="black10px" width="24">
							&nbsp;
						</td>
						<td class="black10px" height="40" width="150">
							<tx>Room Guest Details Page</tx>
						</td>
						<td class="black10px" height="20">
							<a target="frameEdit" href="../../system/proweb/start.csp?pageID=#(pageID)#&mode=edit&hideButtons=1&version=current&eventID=#(xEventID)#&initialiseSession=1"><img id="ef-backend-registration-pages-edit-page-#(..encodeForHTMLAttribute(pageID))#" src="../../media/images/English/Default/backend/edit.gif" width="45" height="17" alt="" border="0" /></a>
						</td>
					</tr>
		   		</table>
			</div>
		</csp:if>
	</systemType:if>
		
	<csp:comment><!--
		first run the query to find just the unique categories that have at least one active page
	--></csp:comment>
	
	<csp:if condition=('isAwards)>
		<script language="cache" runat="server">
			set totalCategories=##class(setup.lnkCategoryEvent).numCategories(xEventID,xWorkLangID,1)
			set moreThanOneCategory=(totalCategories>1)
		</script>
		<csp:query name="rs" classname="setup.lnkAttendeeCategoryDetailsEvent" queryname="qAllActiveCategories" P1=#(xEventID)#>
		<csp:while condition="rs.Next()">
			<script language="cache" runat="server">
				set eventCategoryID=rs.Data("objEventCategory")
			</script>
			<div class="contentbox">
				<h2 style="margin-bottom:0px;">Registration Page(s) for Attendee Category: #(rs.Data("description"))#</h2>
				<systemType:if module="Multi Reg Pages Per Category">
					<div class="gen1_panel_subheader" style="text-align:right;height:26px">
						<a href="regPages.csp?addPage=1&eventCategoryID=#(..encodeForHTMLAttribute(eventCategoryID))#">
							<img height="17px" width="85px" id="ef-backend-registration-pages-add-page-#(..encodeForHTMLAttribute(eventCategoryID))#" style="margin-top: 4px" src="../../media/images/English/Default/backend/addpage.gif"  alt="" border="0" />
						</a>
					</div>
				</systemType:if>
				<csp:comment><!--
					then run the query to find all the pages for the current category   class="tableWithBorder"
				--></csp:comment>
				<csp:if condition=(showAll)>
					<csp:query name="rs2" classname="setup.lnkCategoryEvent" queryname="qAllPagesCategory" P1=#(xEventID)# P2="#(xWorkLangID)#" P3="1" P4="#(eventCategoryID)#">
		   		<csp:else>
					<csp:query name="rs2" classname="setup.lnkCategoryEvent" queryname="qAllActivePagesCategory" P1=#(xEventID)# P2="#(xWorkLangID)#" P3="1" P4="#(eventCategoryID)#">
				</csp:if>
				<table width="100%" border="0" cellpadding="2" cellspacing="0">
			   		<tr class="red">
						<td class="whitebold10px" width="5">
							&nbsp;
						</td>
						<td class="whitebold10px" height="20" width="150">
							<tx>Page Heading</tx>
						</td>
						<td class="whitebold10px" width="10">
							&nbsp;
						</td>
						<systemType:if module="Multi Reg Pages Per Category">
							<td class="whitebold10px" width="100" align="center">
								<tx>Page Order</tx>
							</td>
						</systemType:if>
						<systemType:if module="Backend Only Reg Pages">
							<td class="whitebold10px" width="70" align="center">
								<tx>Backend Only</tx>
							</td>
						</systemType:if>
						<script language="cache" runat="server">
							set show=##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID)
						</script>
						<csp:if condition=(show)>
							<td class="whitebold10px" width="100" align="center">
								<tx>Meeting Manager Page</tx>
							</td>
						</csp:if>
						<td class="whitebold10px" width="70">
							&nbsp;
						</td>
						<td class="whitebold10px" width="70" align="center">
							<tx>Active</tx>
						</td>
						<systemType:if module="Multi Reg Pages Per Category">
							<td class="whitebold10px" width="70">
								&nbsp;
							</td>
						</systemType:if>
						<systemType:if module="Attendee Categories">
							<csp:if condition=(moreThanOneCategory)>
								<td class="whitebold10px" width="160">
									<tx>Use same as page...</tx>
								</td>
							</csp:if>
						</systemType:if>
					</tr>
					<script language="cache" runat="server">
						set row=0,pageCount=0
					</script>
					<csp:while condition="rs2.Next()">
						<script language="cache" runat="server">
							set row=row=0
							set linkID=rs2.Data("ID")
							if 'rs2.Get("sameAs") {
								set pageID=rs2.Data("pageID")
							} else {
								set pageID=rs2.Data("linkedToPage")	
							}
							set description=rs2.Data("description")
							set total=rs2.Data("total")
							set displayOrder=rs2.Data("displayOrder")
							set backendOnly=rs2.Data("backendOnly")
							set active=rs2.Data("active")
							set sameAs=rs2.Data("sameAs")
							set isMeetingMan=rs2.Get("isMeetingMan")
							set dependsOnPromptPageID=rs2.Get("dependsOnPromptPageID")
							set dependsOnPrompt=rs2.Get("dependsOnPrompt")
							set dependsOnPromptID=##class(cod.objItemName).getIDFromDescriptionAndEvent(dependsOnPrompt,xEventID)
							set dependsOnAlternative=rs2.Get("dependsOnAlternative")
							// check if this page is being used by another cateogry (to stop deletions)
							set usedByAnother=0
							if 'sameAs	{
								&SQL(SELECT ID INTO :tmp FROM setup.lnkCategoryEvent WHERE (objEvent=:xEventID) AND (langID=:xWorkLangID) AND (sameAs=:linkID) AND (objEventCategory->active=1) )
								if +SQLCODE=0,tmp set usedByAnother=1
							}
							// if only one page in this category, don't allow deactivate or delete
							set noActiveDelete=0
							if total=1 set noActiveDelete=1
							if active set pageCount=pageCount+1
						</script>
						<tr class='#($S(row=1:"yellow",1:"grey"))#'>
							<td>
								&nbsp;
							</td>
							<td class="black10px" height="20">
								<input type="hidden" name="chkEventCategoryHidden_#(linkID)#" value="1">
								<a href="javascript:changeDesc('#(linkID)#',#(..QuoteJS(description))#);" class="ef_hyperlink">#($S(description'?1." ":description,1:"(no page header)"))#</a>
							</td>
							<td >
								&nbsp;
							</td>
							<systemType:if module="Multi Reg Pages Per Category">
								<td class="black10px" align="center">
									<a href="javascript: move(#(linkID)#,'up');"><img src="../../media/images/English/Default/backend/up.gif" alt="Move Up" title="Move Up" width="15" height="12" border="0"></a><a href="javascript: move(#(linkID)#,'down');"><img src="../../media/images/English/Default/backend/down.gif" alt="Move Down" title="Move Down" border=0></a>
								</td>
							</systemType:if>
							<systemType:if module="Backend Only Reg Pages">
								<td class="black10px" align="center">
									<input type="checkbox" name="chkEventCategoryBackend_#(linkID)#" class="black10px" #($S(backendOnly:"CHECKED",1:""))# value="1">
								</td>
							</systemType:if>
							<script language="cache" runat="server">
								set show=##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID)
							</script>
							<csp:if condition=(show)>
								<td class="black10px" align="center">
								<input type="checkbox" name="chkIsMeetMan_#(linkID)#" class="black10px" value="1" #($S(isMeetingMan:"CHECKED",1:""))# onClick="updateMeetMan(#(linkID)#);">
							</td>
							</csp:if>
							<td class="black10px">
									<csp:if condition=(sameAs)>
									<csp:else>
										<a target="frameEdit" href="../../system/proweb/start.csp?pageID=#(pageID)#&mode=edit&hideButtons=1&version=current&eventID=#(xEventID)#&eventCategoryID=#(eventCategoryID)#&initialiseSession=1"><img id="ef-backend-registration-pages-edit-page-#(..encodeForHTMLAttribute(pageID))#" src="../../media/images/English/Default/backend/edit.gif" width="45" height="17" alt="" border="0" /></a>
									</csp:if>
							</td>
							<td class="black10px" align="center">
								<csp:if condition=(noActiveDelete)>
								  	<img src="../../media/images/English/Default/backend/tick.gif" width="14" height="12" alt="" />
									<input type="hidden" name="chkEventCategoryActive_#(linkID)#" value="1">
								<csp:else>
									<input type="checkbox" name="chkEventCategoryActive_#(linkID)#" class="black10px" #($S(active:"CHECKED",1:""))# value="1">
								</csp:if>
							</td>
							<systemType:if module="Multi Reg Pages Per Category">
								<script language="cache" runat="server">
									set allowDelete=1
									if sameAs set allowDelete=0
									if usedByAnother set allowDelete=0
									if noActiveDelete set allowDelete=0
									if allowDelete {
										&SQL(SELECT pageID INTO :tmp FROM setup.lnkCategoryEvent WHERE ID=:linkID)
										if (+SQLCODE=0) {
											set myPageID=tmp
											// Check if there are deleting it would create any orphans
											// 1. Are there any pages dependent on this?
											&SQL(SELECT ID FROM setup.lnkCategoryEvent WHERE (dependsOnPromptPageID = :myPageID) AND (active=1))
											if +SQLCODE=0 {
												set allowDelete=0
											}
											// 2. Are there any prompts/text blocks dependent on this?
											set query="SELECT ID FROM sc_xModules.objCodItem WHERE (parent->parent=?) AND type IN ('dropdown','radiobutton')"
											set rsPrompts=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
											do rsPrompts.Prepare(query)
											do rsPrompts.Execute(myPageID)
											while rsPrompts.Next(),allowDelete {
												set promptID=rsPrompts.Get("ID")
												&SQL(SELECT ID FROM sc_xModules.objCodItem WHERE dependsOnPrompt = :promptID)
												if +SQLCODE=0 {
													set allowDelete=0
												}
												&SQL(SELECT ID FROM sc_xModules.objText WHERE dependsOnPrompt = :promptID)
									 			if +SQLCODE = 0 { // yes we do
									 				set allowDelete=0
									 			}
											}
											//check recursive dependencies. 											
											if (##class(sc.xModules.objPage).checkDependenciesRecursively(myPageID,eventCategoryID,xEventID)=0){
												set allowDelete=0
											}
																			
										}
									}
								</script>
								<td class="black10px">
								</td>
							</systemType:if>
							<systemType:if module="Attendee Categories">
								<csp:if condition=(moreThanOneCategory)>
									<script language="cache" runat="server">
										set allowReLink=1
										if usedByAnother set allowReLink=0
									</script>
									<csp:if condition=(allowReLink)>
										<td class="black10px">
											<select name="selEventCategoryUseSameAs_#(linkID)#" class="black10px" style="width:150px;">
												<csp:if condition=(sameAs)>
													<option value="CREATE"> - <tx>Unlink Page</tx> - </option>
												<csp:else>
													<option value=""> - <tx>not linked</tx> - </option>
												</csp:if>
												<script name="rs3" language="SQL" P1="#(xEventID)#" P2="#(xWorkLangID)#" P3="#(eventCategoryID)#" P4="#(sameAs)#">
													SELECT COUNT(ID) As total,ID,pageID,description,displayOrder,backendOnly,active,sameAs,sameAs->pageID as linkedToPage,objEventCategory
													FROM setup.lnkCategoryEvent
													WHERE (objEvent=?) AND (langID=?) AND (objEventCategory<>?) AND ((active=1) OR (ID=?)) AND ((sameAs='') OR (sameAs IS NULL))
													ORDER BY displayOrder
												</script>
												<csp:while condition="rs3.Next()">
													<script language="cache" runat="server">
														set show=##class(setup.lnkAttendeeCategoryDetailsEvent).isCategoryActive(xEventID,rs3.Data("objEventCategory"))
													</script>
													<csp:if condition=(show)>
														<option value="#(rs3.Data("ID"))#" #($S(rs3.Data("ID")=sameAs:"SELECTED",1:""))#>#(rs3.Data("description"))#</option>
													</csp:if>
												</csp:while>
											</select>
										</td>
									</csp:if>
								</csp:if>
							</systemType:if>
						</tr>
						<systemType:if module="Dependent Registration Pages">
							<script language="cache" runat="server">
								set show=active
								if pageCount=0 set show=0
								if ##class(setup.objEventSetting).getParameter("basket","basket links to registration pages",xEventID) set show=0
							</script>
							<csp:if condition=(show)>
								<tr class='#($S(row=1:"yellow",1:"grey"))#'>
									<td></td>
									<script language="cache" runat="server">
										set disabled="",title=""
										if 'dependsOnPromptPageID {
											set disabled="DISABLED"
										}
										if numberRegistered {
											set disabled="DISABLED"
											set title=..out("You cannot change page dependencies once people have registered for the event")
										}
									</script>
									<td colspan=6 align="left" class="black10px" title='#(title)#'>
										<csp:if condition=(numberRegistered)>
											<csp:if condition=(dependsOnPromptPageID)>
												<img src="../../media/images/English/Default/backend/tick.gif" width="14" height="12" alt="" />
											<csp:else>
												<img src="../../media/images/English/Default/backend/cross.gif" width="14" height="12" alt="" />
											</csp:if>
										<csp:else>
											<input type="checkbox" name="chkIsDependent_#(linkID)#" class="black10px" #($S(dependsOnPromptPageID:"CHECKED",1:""))# value="1" onClick="toggleDependsSel(#(linkID)#,this.checked);">
										</csp:if>
										<tx>Activate Only if</tx>...&nbsp;
										<select name="selDependsOnQuestion_#(linkID)#" id="selDependsOnQuestion_#(linkID)#" class="black10px" style="width:200px;" #(disabled)# title='#(title)#' onChange="updateAlts(#(linkID)#,this.value);">
											<option></option>
											<csp:if condition=(eventAllowsGroupBookings)>
												<script name="rsCodItems" language="SQL" P1="#(bookerPageID)#">
													SELECT objItemName,objItemName->description As codItem FROM sc_xModules.objCODitem 
													WHERE (parent->parent = ?) AND (active=1) AND (type IN ('dropdown','radiobutton')) 
													ORDER BY displayOrder
												</script>
												<csp:while condition="rsCodItems.Next()" counter="i">
													<script language="cache" runat="server">
														set codItemID=rsCodItems.Get("objItemName")
														set codItem=rsCodItems.Get("codItem")
														set selected="" 
														if dependsOnPromptPageID=bookerPageID,$ZCVT(dependsOnPrompt,"L")=$ZCVT(codItem,"L") set selected="SELECTED"
													</script>
													<csp:if condition=(i=1)>
														<option value="" class="whitebold10px" style="background-color: #CC0033;"><tx>Registration Contact Details</tx></option>
													</csp:if>
													<option value="#(bookerPageID_"|"_codItemID)#" #(selected)#>#(codItem)#</option>
												</csp:while>
											</csp:if>
											<script name="rsPages" language="SQL" P1="#(xEventID)#" P2="#(xWorkLangID)#" P3="#(eventCategoryID)#" P4="#(pageID)#" P5="#(pageID)#">
												SELECT pageID,sameAs,sameAs->pageID as linkedToPage,description
												FROM setup.lnkCategoryEvent 
												WHERE (objEvent= ? ) AND (langID=?) AND (objEventCategory = ?) AND (active=1) AND (pageID <> ?) AND ((sameAs->pageID <> ?) OR (sameAs IS NULL))
												ORDER BY displayOrder
											</script>
											<csp:while condition="rsPages.Next()">
												<script language="cache" runat="server">
													set description=rsPages.Get("description")
													if 'rsPages.Get("sameAs") { 
														set tmpPageID=rsPages.Get("pageID")
													} else {
														set tmpPageID=rsPages.Get("linkedToPage")	
													}
												</script>
												<script name="rsCodItems" language="SQL" P1="#(tmpPageID)#">
													SELECT objItemName,objItemName->description As codItem FROM sc_xModules.objCODitem 
													WHERE (parent->parent = ?) AND (active=1) AND (type IN ('dropdown','radiobutton')) 
													ORDER BY displayOrder
												</script>
												<csp:while condition="rsCodItems.Next()" counter="i">
													<script language="cache" runat="server">
														set codItemID=rsCodItems.Get("objItemName")
														set codItem=rsCodItems.Get("codItem")
														set selected="" 
														if dependsOnPromptPageID=tmpPageID,$ZCVT(dependsOnPrompt,"L")=$ZCVT(codItem,"L") set selected="SELECTED"
													</script>
													<csp:if condition=(i=1)>
														<option value="" class="whitebold10px" style="background-color: #CC0033;">#(description)#</option>
													</csp:if>
													<option value="#(tmpPageID_"|"_codItemID)#" #(selected)#>#(codItem)#</option>
												</csp:while>
											</csp:while>
											
										</select>
										&nbsp;<font size="4"><strong>=</strong></font>&nbsp;
										<select name="selDependsOnAnswer_#(linkID)#" id="selDependsOnAnswer_#(linkID)#" class="black10px" #(disabled)# style="width: 200px;">
											<csp:if condition=($l(dependsOnPrompt))>
												<script language="cache" runat="server">
													set rsAlts=##class(cod.objItemAlternatives).getAlternativesForCodItemAsResultSet(dependsOnPromptID)
												</script>
												<csp:while condition="rsAlts.Next()">
													<option value="#(rsAlts.Get("ID"))#" #($S(rsAlts.Get("description")=dependsOnAlternative:"SELECTED",1:""))#>#(rsAlts.Get("description"))#</option>
												</csp:while>
											<csp:else><csp:comment><!-- Only write empty option tag out if no dependent prompt--></csp:comment>
												<option value=""></option>
											</csp:if>
											<csp:comment><!-- Populated from javascript when doing new--></csp:comment>
										</select>
										&nbsp;
									</td>
								</tr>
							</csp:if>
						</systemType:if>
					</csp:while>
		   		</table>
			</div>
		</csp:while>
	</csp:if>	
</div>

	<input type="hidden" name="MeetManLinkID" value="">
	<input type="hidden" name="newDesc" value="">
	<input type="hidden" name="changeDesc" value="">
	<input type="hidden" name="linkID" value="">
	<systemType:if module="Dependent Registration Pages">
		<csp:if condition=('numberRegistered)>
			<input type="hidden" name="updateDependencies" value="1">
		</csp:if>
	</systemType:if>
</form>
<script language="javascript">
function confirmDelete(linkID) {
	if (confirm('#(..out("Are you absolutely sure that you want to delete this registration page? There is no undo and it could lead to data loss if the event is live."))#') == true) {
		showAll=document.forms[0].showAll.checked
		document.location='#(..Link("regPages.csp?zz=1"))#&deletePage=1&linkID=' + linkID + '&showAll=' + showAll;
	}
}

function changeDesc(linkID,oldName) {
	var description = prompt('Please enter the new page heading',oldName)
	if ((description != null) && (description !=''))  {
		// ficks up foreign chars //escape(description);
		//document.location.href = '#(%request.PageName)#?changeDesc=1&linkID=' + linkID + '&newDesc=' + description;
		document.forms[0].newDesc.value=description;
		document.forms[0].changeDesc.value=1;
		document.forms[0].linkID.value=linkID;
		document.forms[0].submit();
	}
}
function updateMeetMan(linkID) {
	document.forms[0].MeetManLinkID.value=linkID;
	document.forms[0].submit();

}
function toggleDependsSel(linkID,isChecked) {
	selDependsOnAnswer=document.getElementById('selDependsOnAnswer_' + linkID);
	selDependsOnQuestion=document.getElementById('selDependsOnQuestion_' + linkID);
	if (isChecked == true) {
		selDependsOnQuestion.disabled = false;
		selDependsOnAnswer.disabled = false;
	} else {
		selDependsOnQuestion.disabled = true;
		selDependsOnAnswer.disabled = true;
	}
}

function updateAlts(linkID,pagePrompt) {
	var tmp = pagePrompt.split('|');
	var codPromptID=tmp[1];
	selDependsOnAnswer=document.getElementById('selDependsOnAnswer_' + linkID);
	selDependsOnAnswer.options.length=0;
	if (codPromptID != '') {
		// populate the alternatives list box from the javascript array
		
		for (var i = 0; i < (alts[codPromptID].length); i++) {
			var tmp = alts[codPromptID][i].split('|');
			selDependsOnAnswer.options[i] = new Option(tmp[1],tmp[0])
		}	
	}
}

function move(linkID,dir) {
	showAll=document.forms[0].showAll.checked
	document.location = '#(..Link("regPages.csp?zz=1"))#&move=1&direction=' + dir + '&linkID=' + linkID + '&showAll=' + showAll;
}

function changeLang(newLangID) {
	showAll=document.forms[0].showAll.checked
	document.location = '#(..Link(%request.PageName_"?zz=1"))#&xWorkLangID=' + newLangID + '&showAll=' + showAll;
}

</script>
<csp:include page="../../backend/home/backendBottom.csp">
]]></CSP>


<CSP name="backEnd/proweb/codQuestionDetails.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<csp:include page="../../backend/home/backendTop.csp?hideBackendMenu=1&kendoweb=1">


<script language="cache" runat="server">
	set showListText=..out("See List")
	set hideListText=..out("Hide List")
</script> 

<script language="javascript">
	function toggleUsedInEventsListVisibility () {
		var divstyle = new String();
		divstyle = document.getElementById('usedInEventsList').style.display;
		if (divstyle.toLowerCase()=='block' || divstyle == '') {
			document.getElementById('usedInEventsList').style.display = 'none';
			document.getElementById('showHideText').innerHTML = '#(showListText)#';
		} else {
			document.getElementById('usedInEventsList').style.display = 'block';
			document.getElementById('showHideText').innerHTML = '#(hideListText)#';
		}
	}
</script>


<script language="cache" runat="server">
	set itemNameID=%request.Get("itemNameID")
	if itemNameID="" set itemNameID=%session.Get("itemNameID")

	set dataID=%request.Get("dataID")
	
	set pageID=##class(sc.codItemMethods).getPageID(dataID)
	if 'pageID {
		set pageID=%request.Get("pageID")
	}
	if 'pageID {
		throw ##class(shared.exceptions.generalException).%New("No pageID")	
	}
	
	do ##class(sc.methods).updateBackendVariablesFromPageID(pageID)
	
	do ##class(sc.objData).saveDesiredPositionFromRequestToSession(%request, %session)
	set groupID=##class(sc.objData).getParentID(pageID)
	
	// switch to the org data to enable edit when having multi-stage workflow
	// but we can't do it for single workflow because the it will stop adding new ones in EF
	if ##class(sc.objStep).getFinalLevel()>1 {
		if %request.Get("orgDataID") set dataID=%request.Get("orgDataID")
	}

	set templateURL=%request.Get("templateURL")
	if templateURL="" set templateURL=%session.Get("templateURL")
	set %session.Data("templateURL")=templateURL

	set parent=%request.Get("parent")
	if parent="" set parent=%session.Get("parent")
	set %session.Data("parent")=parent

	set isDOC=%request.Get("isDOC")
	if isDOC="" set isDOC=$G(%session.Data("proweb","isDOC"))
	set %session.Data("proweb","isDOC")=isDOC

	set isForm=%request.Get("isForm") // used for proweb only form fills
	if isForm="" set isForm=$G(%session.Data("proweb","isForm"))
	set %session.Data("proweb","isForm")=isForm

	// are we doing an eventsforce style survey
	set isSurvey=0
	set surveyID=""
	set grandParent=##class(sc.objData).getParentID(groupID)
	&SQL(SELECT description INTO :tmp FROM sc_xModules.objGroup WHERE ID = :grandParent)
	if +SQLCODE=0,$ZCVT(tmp,"U")="SURVEYS" 
	{	
		set isSurvey=1
		set surveyID = groupID
	}
 	
	set addToTop=%request.Get("addToTop")
	if addToTop="" set addToTop=%session.Get("addToTop")
	set %session.Data("addToTop")=addToTop

	kill %session.Data("eventsforce","backend","gotoPage")
	set gotoPage=%request.Get("gotoPage")
	set %session.Data("eventsforce","backend","cod question gotoPage")=gotoPage

	set additional=%request.Get("additional")
	if (additional="")&(dataID) {
		set additional=##class(sc.xModules.objCODitem).isABI(dataID)
	}
	set %session.Data("eventsforce","backend","additional")=additional

	// is this a ticketing question?
	set quantityItem=%request.Get("quantityItem")
	if (quantityItem="")&(dataID) {
		// find out if we are dealing with a ticketing type of item or not when editing a prompt
		&SQL(SELECT isQuantityItem INTO :tmp FROM sc_xModules.objCODitem WHERE ID = :dataID)
		if +SQLCODE=0 set quantityItem=tmp
	}
	set %session.Data("eventsforce","backend","quantityItem")=quantityItem
	
	set xWorkLangID=%request.Get("xWorkLangID")
	if xWorkLangID="" set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if xWorkLangID="" set xWorkLangID=$G(xLangID,1)

	set inBookersPage=##class(sc.xModules.objPage).isBookerPage(pageID)
	set isAwardsEntryPage=##class(sc.xModules.objPage).isAwardsEntryPage(pageID)
	set inAbsDocPage=##class(sc.xModules.objPage).isAbstractDocumentPage(pageID)
 	Set inAbsSignupPage=##class(sc.xModules.objPage).isAbstractSignUpPage(pageID)
 	
 	set isAbstractPage=0
 	if (inAbsDocPage||inAbsSignupPage) set isAbstractPage=1

	set eventHotelID=%request.Get("eventHotelID")
	
 	Set isAccomPage=0
 	if ($ZCVT(templateURL,"L")["taccom") set isAccomPage=1
	

 	Set isMeetManPage=0
 	if ($ZCVT(templateURL,"L")["tmeetman") set isMeetManPage=1
 	

	// display the price info?
	set hasPricing=##class(setup.objEventSetting).getParameter("event setup","has pricing",xEventID)

	kill %session.Data("proweb","codGroup")
	set codGroup=%request.Get("codGroup")
	set %session.Data("proweb","codGroup")=codGroup

	if $G(%session.Data("proweb","backend","errMsg"))'="" {
		write "<scri"_"pt language='javas"_"cript'>alert("_..QuoteJS(%session.Data("proweb","backend","errMsg"))_");</scri"_"pt>"
		kill %session.Data("proweb","backend","errMsg")
	}
	set meetingsEnabled=##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID)
	set eventAllowsGroupBookings=##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)
	
	set isAnonymousMode=+##class(setup.objEventSetting).getParameter("system","do not use email",xEventID)
	set allowSingleEventQuestions=##class(cod.methods).areSingleEventQuestionsAllowedForPageID(pageID)
	
	set baseURL="../../backend/proweb/codQuestionDetails.csp?dataID="_..encodeForURL(dataID)_"&pageID="_..encodeForURL(pageID)_"&additional="_..encodeForURL(additional)_"&quantityItem="_..encodeForURL(quantityItem)
	set linkedBaseURL=..Link(baseURL)
	set loadItemURL=baseURL_"&loadItem=true"
	set linkedLoadItemURL=..Link(loadItemURL)
</script>
<script type="text/javascript">

function ajaxFunction(inPhrase)
  {
  var xmlHttp;
  try
    {
    // Firefox, Opera 8.0+, Safari
    xmlHttp=new XMLHttpRequest();
    }
  catch (e)
    {
    // Internet Explorer
    try
      {
      xmlHttp=new ActiveXObject("Msxml2.XMLHTTP");
      }
    catch (e)
      {
      try
        {
        xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");
        }
      catch (e)
        {
        alert('#(..out("Your browser does not support this function."))#');
        return false;
        }
      }
    }
    xmlHttp.onreadystatechange=function()
      {
      if(xmlHttp.readyState==4)
        {
			res=document.getElementById('divR_all');
			res.innerHTML=xmlHttp.responseText;
			res.style.visibility="visible";
        }
      }
    xmlHttp.open("GET","#(..Link("codQuestionLookup.csp?zz=1"))#&eventID=#(xEventID)#&phrase=" + escape(inPhrase),true);
    xmlHttp.send(null);
}

function CheckAndGet(ele,languageID,mode)	{
	res=document.getElementById('divR_all');
	res.style.visibility="visible";
	res.innerHTML='<p class="blackbold10px">Searching...</p>';

	ok = ajaxFunction(ele.value,languageID,mode); // the entered phrase
}
function checkPercent() {
	var txtPromptWidth = document.getElementById('idPromptWidth');
	var txtWidthValue = txtPromptWidth.value;
	var strLength = txtWidthValue.length;
  	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = txtWidthValue.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || txtWidthValue.indexOf(' ') >= 0)		{
				alert ("#(..out("Only numeric value (0-100) is accepted for 'Prompt Width'. \nPlease try again."))#");
				txtPromptWidth.style.background = "yellow";
				return false;
			}
		}
  	}

	if ((strLength > 0) && ((parseFloat(txtWidthValue)>100.0) || (parseFloat(txtWidthValue) <0.0))) {
		alert ("#(..out("Value for the 'Prompt Width' field is limited between 0 to 100. \nPlease try again."))#");
		txtPromptWidth.value = "";
		txtPromptWidth.style.background = "yellow";
		return false;
	}
	return true;
}
function checkSubmit($form) {
	if (!checkName()) return false;
	if (!checkPercent()) return false;
	if (!ef.codQuestionDetails.checkNumericValues()) return false;
	if (!isValidRangeAvailability()) return false;
	
	var alternativesToBeDeleted = $("#txtDeletedAlternatives").val();
	if (alternativesToBeDeleted !== "") {
		$.ajax({
        	type: "POST",
			url: "#(..encodeForJavaScript(##class(shared.pCSP).Link("codItemAlternativesCheckUsageJSON.csp")))#",
			dataType: "json",
			data: {"itemAlternativeIDs" : alternativesToBeDeleted },
			success: function(obj) {
				if (obj.isUsed == 1) {
					ef.admin.confirm("One or more of the alternatives you would like to delete are in use. Are you sure you want to delete them?",
						function(ok){
							if (ok) {
								$form.get(0).submit();
							}
						}
					);

				} else {
					$form.get(0).submit();
				}
			}
		});
		return false;
	}
	return true;
}
function loadItem(itemNameID) {
	document.location = "#(..encodeForJavaScript(linkedLoadItemURL))#" + "&itemNameID=" + encodeURIComponent(itemNameID);
}
</script>
<csp:object name="objCODitem" classname="sc.xModules.objCODitem" objid="#(dataID)#">

<script language="cache" runat="server">
	// Get the itemNameID from the the proweb object if we are editing
	if dataID set itemNameID=objCODitem.objItemName.%Id()
</script>

<csp:object name="objItemName" classname="cod.objItemName" objid="#(itemNameID)#">

<script language="cache" runat="server">
	if xEventID {
		set eventConfiguration=##class(setup.eventConfiguration).createForEventID(xEventID)	
	}
	set (description,prompt,type,fieldWidth,fieldHeight,helpText,mandatory,isDelegate,isGuest,backendOnly,carryOver,requiredAnswer,validationErrorMessage,reportDescription,layout,maxCharacters,maxWords,multiCheckboxMin,multiCheckboxMax,noAmendments,defaultValue,concealed,systemItem)=""
	set reportOn=1
	set readonlyFrontend=0

	// get the data from COD
	if itemNameID {
		set description=objItemName.description
		//get the translated version of description by default when itemNameID<20
		if itemNameID<20 {
			set prompt = ##class(translations.objPhraseWebsite).translatePhrase(description,xWorkLangID,"","","","")
		} else {
			set prompt = description
		}
		
		set type=objItemName.type
		set helpText=objItemName.helpText
		set carryOver=objItemName.carryOver
		set concealed=objItemName.concealed
		set systemItem=objItemName.systemItem
	}

	if quantityItem {
		set fieldWidth=45
	}

	// get the data from proweb
	if dataID {
		set prompt=##class(sc.xModules.objCODitem).getQuestPrompt(dataID,xWorkLangID)
		set reportDescription=objCODitem.reportDescription
		set fieldWidth=objCODitem.fieldWidth
		set fieldHeight=objCODitem.fieldHeight
		set type=objCODitem.type
		set layout=objCODitem.layout
		set helpText=objCODitem.helpText
		set mandatory=objCODitem.mandatory
		set backendOnly=objCODitem.backendOnly
		set isDelegate=objCODitem.isDelegate
		set isGuest=objCODitem.isGuest
		set reportOn=objCODitem.reportOn
		set readonlyFrontend=+objCODitem.readonlyFrontend
		set courseID=objCODitem.courseID
		set requiredAnswer=objCODitem.requiredAnswer
		set validationErrorMessage=objCODitem.validationErrorMessage
		set maxCharacters=objCODitem.maxCharacters
		set maxWords=objCODitem.maxWords
		set multiCheckboxMin=objCODitem.minAltsChecked
		set multiCheckboxMax=objCODitem.maxAltsChecked
		set noAmendments=objCODitem.noAmendments
		set defaultValue=objCODitem.defaultValue
		do objCODitem.%Close()
	}
	set showGuest=0
	set notShowGuestExplanation=""
	if ##class(sc.xModules.objPage).isRegistrationPage(pageID) {
		set showGuest=1
	}
	// if other pages (within same category) have guest prompts, don't allow a guest prompt to be added to this page
	// (unless the item being edited is a guest prompt already
	if (showGuest && ('##class(sc.methods).canPageHaveGuestCODItems(pageID)) && '(isGuest)) {
		set showGuest=0
		set notShowGuestExplanation=..out("Guest prompts may not be used on multiple pages for this attendee category")
	}
	
	set hasAnyDependencies=0
	if $l(##class(sc.xModules.objCODitem).findDependentQuestions(dataID)) set hasAnyDependencies=1
	if $l(##class(sc.xModules.objCODitem).findDependentTextBlocks(dataID)) set hasAnyDependencies=1
	if hasAnyDependencies {
		set showGuest=0
		set notShowGuestExplanation=..out("You cannot change attendee or guest as there are items dependent on this question")
	}
	
	kill allRegPages,allRegPageIDs,allReg
	set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xWorkLangID,1,.allRegPages,.allRegPageIDs,.allReg)
	
	// Check whether there is any data associated with this cod item (for any event)
	set hasDataForAnyEvent=0
	&SQL(SELECT ID
		FROM cod.objItemData
		WHERE objItemName=:itemNameID
		AND (result IS NOT NULL) AND (result <> '')
	)
	if +SQLCODE=0 {
		set hasDataForAnyEvent=1
	}
	
	set canChangeAnswerAppliesTo=0
	
</script>



<form name="myform" method="post" action="codQuestionDetails2.csp" onSubmit="selectAll(); return checkSubmit($(this));">
<div class="topsave_in_popup">
	<script language="cache" runat="server">
		set backPage="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))
		if gotoPage'="" set backPage=gotoPage
		set backPage=backPage_$S(backPage["?":"&",1:"?")_"mode=edit"
	</script>
	<a href="#(backPage)#"><img src="../../media/images/English/Default/backend/cancel.gif" alt="#" width="65" height="17" border="0"></a></td>
	<input type="image" src="../../media/images/English/Default/backend/save.gif" border="0" alt="Save" width="65" height="17">
</div>
<br><br>

<table width="800" border="0" cellspacing="0" cellpadding="0" >
<tr>
         <td>
             <table width="800" border="0" cellspacing="0" cellpadding="0">
                 <tr>
                     <td colspan="3" class="gen1_panel_border" height="1"><img src="../../media/images/english/default/backend/buffer.gif" width="1" height="1"></td>
                 </tr>
                 <tr>
                     <td class="gen1_panel_border" width="1"><img src="../../media/images/english/default/backend/buffer.gif" width="1" height="1"></td>
                     <td>
                         <table width="800" border="0" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" align="left">
                             <tr >
                             	<td class="gen1_panel_header">
								 	<csp:if condition=(additional)>
										<tx>Bookable Item Details</tx>
									<csp:elseif condition=(quantityItem)>
										<tx>Quantity Bookable Item Details</tx>
									<csp:else>
										<tx>Registration Question Details</tx>
									</csp:if>
                             </tr>
							<tr class="gen1_panel_subheader">
								<td height=16></td>
							</tr>	
                             <tr>
                                 <td valign="top" align="left">
					<table width="100%" border="0" cellspacing="0" cellpadding="0">
	 		            <tr>
						<td align="left" valign="top" >
						<csp:if condition=(+itemNameID=0)>
							<table border="0" width="100%" cellspacing="0" cellpadding="0">
								<tr class="gen1_panel_subheader">
									<td width="200" height="30" align="right" nowrap class="black10px" valign="top" style="padding-top: 4px; padding-bottom: 8px;"><tx>Search database items</tx>:&nbsp;&nbsp;</td>
									<td height="30">
										<table width="100%" border="0" cellspacing="0" cellpadding="0">
											<tr>
												<td valign="top" width="45%">
													<systemType:if module="Search existing items">
														<input type="text" id="lookup_phrase" name="lookup_phrase" value=" ---#(..out("Type to Search"))#---" class="black10px" style="width:282px;" onFocus="this.value=''" onkeyup="CheckAndGet(this);">
													</systemType:if>
													<script language="cache" runat="server">
														kill alreadyUsedQuestions
														do ##class(cod.methods).loadUsedQuestions(pageID,surveyID,%session.Get("eventCategoryID"),.alreadyUsedQuestions,.allRegPageIDs)
													</script>
													<ef-select id="selCODitem" name="selCODitem" class="black10px ef-select-on-change-redirect" style="width: 300px;" data-link-url="#(loadItemURL)#" data-redirect-param-name="itemNameID">
														<option selected>---<tx>Select from list</tx>---</option>
														<csp:query name="rs" classname="cod.objItemName" queryname="qItemsRegPages" P1="#(xEventID)#">
														<csp:while condition="rs.Next()">
															<script language="cache" runat="server">
																 set showItem=1
																 set tmpItemID=rs.Get("ID")
																 
																 set highlightItem=0,highlightDesc=""   // so that we show prompts that have been used by highlight what it's used for (so guest prompts can be added)
																 
																 if (isForm)!(isDOC),'isSurvey { // regular page types
																 
																 	// hide prompts already used in this page or in any other pages within the same page
																	if $Data(alreadyUsedQuestions(tmpItemID)) {
																		set showItem=0
																	}
																	
																 } elseif eventHotelID	{  
																 	// alway show if we are in a hotel page
																 	set showItem=0
																	if eventHotelID=rs.Get("eventHotelID") set showItem=1
																	
																 } else { // surveys, abstracts and such peripheral page types
																 	
																 	// exclude all hotel prompts
																 	if rs.Get("eventHotelID") set showItem=0

																	if showItem	{
																		// check all pages if attendee category
																		if 'isSurvey,##class(setup.objSetting).getParameter("system","isEventsForce"),%session.Get("eventCategoryID")	{ // if we have come from regPages.csp
																			if $Data(alreadyUsedQuestions(tmpItemID)) {
																					set showItem=1
																					set highlightItem=1,highlightDesc="Already Used: "
																			}
																			
																		} else {
																			if isSurvey {
																				// surveys
																				if $Data(alreadyUsedQuestions(tmpItemID)) {
																					set showItem=1
																					set highlightItem=1,highlightDesc="Already Used: "
																				}
																				if '##class(cod.methods).isCodTypeAllowedForRegPageType("surveys",rs.Get("type")) set showItem=0
																			} else {
																				// all other types
																				if $Data(alreadyUsedQuestions(tmpItemID)) {
																			 		// we need to allow same item to be added for authors/co-authors
																					// abstracts allowed																					
																					if 'inAbsDocPage {
																						set showItem=0
																					} else {
																						set highlightItem=1,highlightDesc="Already Used: "
																					}
																				}
																			}
																			
																		}
																	}
																	
																	// only show radios and dropdowns when doing ABIs //that are not event spanning. Shahadat 31Dec09
																	if additional {
																		if ("radiobutton,dropdown,multibox"'[rs.Get("type"))!(rs.Get("carryOver")'=0) set showItem=0 // also multicheck - fred ja 2010
																	}

																	// only show text field when doing Quantity booking items //that are not event spanning. Shahadat 31Dec09
																	if quantityItem {
																		if (rs.Get("type")'="text") ! (+rs.Get("carryOver")'=0) set showItem=0
																	}

																}
																
																if 'allowSingleEventQuestions {
																	if rs.Get("isQuestionForSingleEvent") set showItem=0
																}

																if isAwardsEntryPage {
																	if '##class(cod.methods).isCodTypeAllowedForRegPageType("awards",rs.Get("type")) set showItem=0
																}
																if isAbstractPage {
																	if '##class(cod.methods).isCodTypeAllowedForRegPageType("abstracts",rs.Get("type")) set showItem=0
																}
																if isMeetManPage {
																	if '##class(cod.methods).isCodTypeAllowedForRegPageType("meetman",rs.Get("type")) set showItem=0
																}
																if isAccomPage {
																	if '##class(cod.methods).isCodTypeAllowedForRegPageType("accommodation",rs.Get("type")) set showItem=0
																}																
																// exclude the email field IN EF
																if $ZCVT(rs.Data("description"),"L")="email" set showItem=0

																// abstracts signup page needs to have the real email address on there
																if $ZCVT(rs.Data("description"),"L")="email",inAbsSignupPage set showItem=1

																 set tmpDescription=rs.Data("description")

																 if $G(%session.Data("templateURL"))["tAdditionalRegistration.csp" {
																 	 &SQL(SELECT description INTO :pageName FROM sc_xModules.objPage WHERE ID = :pageID)

																	 // filter out the normal prompts  if we are doing additional registration pages
																	 if tmpDescription'[pageName_"|" set showItem=0
																	 
																	 // remove page name if we are doing additional registration pages
																	 if tmpDescription["|" set tmpDescription=$p(tmpDescription,"|",2)
																}
																// v2.7 - highlight already used items rather than hide them so guest prompts can be added and so it's clearer what's going on
																set optionClass=""
																if highlightItem	{
																	set optionClass="redbold10px"
																	set tmpDescription=highlightDesc_tmpDescription
																}

																// v.2.7 hide non-spanning items if we are doing eventsforce style surveys
																if isSurvey {
																	set tmpItemNameID=rs.Data("ID")
																	&SQL(SELECT carryOver INTO :tmp FROM cod.objItemName WHERE ID = :tmpItemNameID)
																	if +SQLCODE=0,+tmp'=1 set showItem=0
																}

																// only show meeting manager items in meeting manager pages
																if codGroup="meetMan" {
																	if rs.Get("codGroup")'="meetMan" {
																		set showItem=0
																	}
																} else {
																	if rs.Get("codGroup")="meetMan" set showItem=0
																}

															</script>
															<csp:if condition=(showItem=1)>
																<option value='#(rs.Data("ID"))#' class="#(optionClass)#">#(tmpDescription)#</option>
															</csp:if>
														</csp:while>
													</ef-select>



	                                               </td>
													<td align="left">&nbsp;<a href="javascript: gotoNewItem();"><img name="butCreateNew" id="butCreateNew" src="../../media/images/English/Default/backend/add.gif" border="0" alt="" width="65" height="17"></a></td>
											</tr>
											<script language="cache" runat="server">
													set newItemLinkURL=..Link(baseURL_"&itemNameID=CREATE"_"&eventHotelID="_..encodeForURL(eventHotelID)_"&codGroup="_..encodeForURL(codGroup))
											</script>
											<script language="javascript">
											function gotoNewItem() {
												var newName= document.forms[0].lookup_phrase.value;
												var nameLength = newName.length;
												if(ef.codQuestionDetails.anyInvalidCharactersInName(newName) && (nameLength>0)){
													alert('Only letters, numbers, underscores and spaces are allowed for the database name. Please try again.');
													document.forms[0].lookup_phrase.focus();
												} else {
													document.location= ef.addParameterToURL("#(..encodeForJavaScript(newItemLinkURL))#","typedText",$("#lookup_phrase").val());
												}
											}
											</script>
										</table>
									</td>
								</tr>
					             <tr>
								 	<td colspan=99>
										<div id="divR_all" class="UnderTextField"></div>
									</td>
								 </tr>
								<tr>
									<td colspan="3" height="30"><img src="../../media/images/English/Default/backend/line.gif" width="600" height="21"></td>
								</tr>
							</table>
						</csp:if>
						<table width="100%" border="0" cellspacing="0" cellpadding="0">
							<tr>
								<td width="13">&nbsp;</td>
								<td class="black10px" align="right" height="15" width="184"><tx>Database name</tx>:&nbsp;*&nbsp;</td>
								<td class="black10px" valign="top">
									<table border=0 cellpadding=0>
										<tr>
											<td class="black10px">
												<input type="text" name="txtDescription" maxlength="44" class="black10px" value="#(description)#" onchange="if (document.forms[0].txtPrompt.value.length <2) {document.forms[0].txtPrompt.value=this.value;}" disabled style="background-color: #eeeeee; width: 285px; padding-left: 4px;">
											</td>
											<script language="cache" runat="server">
												set show=1
												if isAwardsEntryPage set show=0 // Awards entry scree
												if '##class(setup.objSystemTypes).isModuleAllowed("Concealed Data Items - TFI") set show=0
											</script>
											<csp:if condition=(show)>
												<td>&nbsp;&nbsp;
													<script language="cache" runat="server">
														set show=1
														if hasDataForAnyEvent {
															set show=0
															set reason=..out("You cannot change the concealed setting because this item has data")
														}
														if systemItem {
															set show=0
															set reason=..out("You cannot change a system item to have concealed data")
														}
													</script>
													<csp:if condition=(show)>
														<input id="chkConcealed" type="checkbox" name="chkConcealed" value="1" class="black10px" #($S(concealed=1:"checked",1:0))#>
													<csp:else>
														<csp:if condition=(concealed)>
															<img src="../../media/images/English/Default/backend/tick.gif" alt="YES" title="#(reason)#" width="14" height="12" border="0">
														<csp:else>
															<img src="../../media/images/English/Default/backend/cross.gif" alt="NO" title="#(reason)#" width="14" height="12" border="0">
														</csp:if>
														<input type="hidden" name="chkConcealed" value="#(+concealed)#">
													</csp:if>
												</td>
												<td class="black10px">
													<tx>Concealed database item</tx>
												</td>
											<csp:else>
												<csp:comment><!--Keep the setting so that concealed data doesn't show when switched off --></csp:comment>
												<input type="hidden" name="chkConcealed" value="#(+concealed)#">
											</csp:if>
										</tr>
									</table>
                                </td>
                                <td class="black10px" valign="top" colspan="3" width="120" align="left">
                                	<script language="cache" runat="server">
										set show=0
										if ##class(setup.objSystemTypes).isModuleAllowed("Registration prompt collections") set show=1
										set codCollectionDetailsURL = "codQuestionCollectionDetails.csp"
										set codCollectionDetailsURL = ..addParameterToURL(codCollectionDetailsURL, "codID", itemNameID)
										set codCollectionDetailsURL = ..addParameterToURL(codCollectionDetailsURL, "returnURL", baseURL)
										set codCollectionDetailsURL = ..addParameterToURL(codCollectionDetailsURL, "gotoPage", gotoPage)
									</script>
									 <csp:if condition=(show)>
										<csp:if condition=(dataID)>
											<ef-a href="#(codCollectionDetailsURL)#"><img src="../../media/images/English/Default/backend/collections.gif" border="0" alt="Registration question collections" width="85" height="17"></ef-a>
										<csp:else>
											<img src="../../media/images/English/Default/backend/collections.gif" border="0" alt="Registration question collections" style="filter: alpha(opacity=35); opacity: 0.35;"   width="85" height="17" title="Registration question collections is only available after you have saved the question prompt">
										</csp:if>
									 </csp:if>
                                </td>
							</tr>
							<tr>
								<td width="13" height="33">&nbsp;</td>
								<td class="black10px" align="right" valign="top"><tx>Question text</tx>:&nbsp;</td>
								<td class="black10px" colspan="3" style="padding-left: 2px;">
									<textarea name="txtPrompt" class="black10px" style="width: 292px; height: 40px; padding-left: 4px; padding-top: 4px;">#(..encodeHTMLContentForTinyMCETextarea(prompt))#</textarea>
								</td><td valign="top">
									<csp:if condition=((itemNameID="NEW")!(itemNameID="CREATE"))>
										<img src="../../media/images/English/Default/backend/advanced.gif" alt="advanced"  border="0" style="filter: alpha(opacity=35); opacity: 0.35;" title="You must save the database item before you can edit the question text.">
									<csp:else>
										<a href="javascript: popup('question');"><img src="../../media/images/English/Default/backend/advanced.gif" alt="advanced" border="0"></a>
									</csp:if>
								</td>
							</tr>

							<csp:if condition=('isSurvey)>
								<tr>
									<td colspan=1></td>
									<td class="black10px" align="right" style="padding-top: 8px;">
										<tx>Question</tx>:&nbsp;
									</td>
									<script language="cache" runat="server">
										set canChangeQuestionAvailability=1
										set questionAvailability="singleEvent"
										if itemNameID {
											set canChangeQuestionAvailability=0
											if '##class(cod.objItemName).isSingleEventQuestion(itemNameID) set questionAvailability="allEvents"
										} else {
											if 'allowSingleEventQuestions {
												set canChangeQuestionAvailability=0
												set questionAvailability="allEvents"
											}
										}
									</script>
									<td class="black10px" style="padding-top: 8px;">
										<script language="cache" runat="server">
											set isRadioChecked=(questionAvailability="singleEvent")
											
											set isRadioEnabled=0
											if canChangeQuestionAvailability set isRadioEnabled=1
											if isRadioChecked set isRadioEnabled=1
										</script>
										<input type="radio" name="radQuestionAvailability" id="radQuestionAvailabilitySingleEvent" value="singleEvent" #($S(isRadioChecked:"checked",1:""))# #($S(isRadioEnabled:"",1:"disabled"))#>
										<tx>Available to this event only</tx>
									</td>
								</tr>
								<tr>
									<td colspan=2></td>				
									<td class="black10px">
										<script language="cache" runat="server">
											set isRadioChecked=(questionAvailability="allEvents")
											
											set isRadioEnabled=0
											if canChangeQuestionAvailability set isRadioEnabled=1
											if isRadioChecked set isRadioEnabled=1
										</script>
										<input type="radio" name="radQuestionAvailability" id="radQuestionAvailabilityAllEvents" value="allEvents" #($S(isRadioChecked:"checked",1:""))# #($S(isRadioEnabled:"",1:"disabled"))#>
										<tx>Available to all events</tx>
									</td>
								</tr>
								<script language="cache" runat="server">
									set canChangeAnswerAppliesTo=1
									set answerAppliesTo="singleEvent"
									if itemNameID {
										if carryOver set answerAppliesTo="allEvents"
										set canChangeAnswerAppliesTo=0
									} else {
										if isAnonymousMode set canChangeAnswerAppliesTo=0
										if quantityItem set canChangeAnswerAppliesTo=0
										if additional set canChangeAnswerAppliesTo=0
									}
								</script>
								<tr >
									<td colspan=1></td>
									<td class="black10px" align="right" style="padding-top: 8px;">
										<tx>Answers</tx>:&nbsp;
									</td>
									<script language="cache" runat="server">
										set isRadioChecked=(answerAppliesTo="singleEvent")
										
										set isRadioEnabled=0
										if canChangeAnswerAppliesTo set isRadioEnabled=1
										if isRadioChecked set isRadioEnabled=1
									</script>
									<td class="black10px"  style="padding-top: 8px;">
										<input type="radio" name="radAnswerAppliesTo" id="radAnswerAppliesToSingleEvent" value="singleEvent" #($S(isRadioChecked:"checked",1:""))# #($S(isRadioEnabled:"",1:"disabled"))#>
										<tx>Apply to this event only</tx>
									</td>
								</tr>
								<tr>
									<td colspan=2></td>	
									<script language="cache" runat="server">
										set isRadioChecked=(answerAppliesTo="allEvents")
										
										set isRadioEnabled=0
										if canChangeAnswerAppliesTo set isRadioEnabled=1
										if questionAvailability="singleEvent" set isRadioEnabled=0
										if isRadioChecked set isRadioEnabled=1
									</script>			
									<td class="black10px"style="padding-bottom: 8px;">
										<input type="radio" name="radAnswerAppliesTo"  id="radAnswerAppliesToAllEvents" value="allEvents" #($S(isRadioChecked:"checked",1:""))# #($S(isRadioEnabled:"",1:"disabled"))#>
										<tx>Apply to all events</tx>
									</td>
								</tr>							
							</csp:if> 
							<tr>
								<td width="13" height="30">&nbsp;</td>
								<td class="black10px" align="right" height="30" width="184"><tx>Type</tx>:&nbsp;&nbsp;</td>
								<td class="black10px" valign="middle" height="30" colspan="4">

									<select name="selType" id="selDataType" class="black10px" size=1 style="width: 300px;" onChange="disabling(this.value);">
									<script language="cache" runat="server">
										// enforce strict control of the prompt type, must be roughly the same as the cod type
										kill alts
										set altIndex=0
										if itemNameID="CREATE" {
											if 'additional {
												set alts($i(altIndex))="text|"_..out(##class(cod.objItemName).getDataTypeDescription("text"))
												if 'quantityItem	{
													set alts($i(altIndex))="textarea|"_..out(##class(cod.objItemName).getDataTypeDescription("textarea"))
												}
											}
											if 'quantityItem {
												set alts($i(altIndex))="radiobutton|"_..out(##class(cod.objItemName).getDataTypeDescription("radiobutton"))
												set alts($i(altIndex))="dropdown|"_..out(##class(cod.objItemName).getDataTypeDescription("dropdown"))
												set alts($i(altIndex))="multibox|"_..out(##class(cod.objItemName).getDataTypeDescription("multibox")) // add multibox - fred jan 2010
												set multiboxIndex=altIndex //used for ordering checkbox before multibox.
											}
											if 'additional,'quantityItem {
												set alts($i(altIndex))= alts(multiboxIndex)
												set alts(multiboxIndex)="checkbox|"_..out(##class(cod.objItemName).getDataTypeDescription("checkbox"))
												set alts($i(altIndex))="integer|"_..out(##class(cod.objItemName).getDataTypeDescription("integer"))
												set alts($i(altIndex))="floatingPointNumber|"_..out(##class(cod.objItemName).getDataTypeDescription("floatingPointNumber"))
												set alts($i(altIndex))="time|"_..out(##class(cod.objItemName).getDataTypeDescription("time"))
												set alts($i(altIndex))="date|"_..out(##class(cod.objItemName).getDataTypeDescription("date"))
												set alts($i(altIndex))="dateRange|"_..out(##class(cod.objItemName).getDataTypeDescription("dateRange"))
												set alts($i(altIndex))="emailAddress|"_..out(##class(cod.objItemName).getDataTypeDescription("emailAddress"))
												set alts($i(altIndex))="multiEmailAddress|"_..out(##class(cod.objItemName).getDataTypeDescription("multiEmailAddress"))
												set alts($i(altIndex))="phoneNumber|"_..out(##class(cod.objItemName).getDataTypeDescription("phoneNumber"))
												set alts($i(altIndex))="webAddress|"_..out(##class(cod.objItemName).getDataTypeDescription("webAddress"))
												set alts($i(altIndex))="1-5 scale|"_..out(##class(cod.objItemName).getDataTypeDescription("1-5 scale")) // will be converted to radio when saved
											}
										} else {
											// restrict types if it already exists in COD
											if "text,textarea"[type {
												set alts($i(altIndex))="text|"_..out(##class(cod.objItemName).getDataTypeDescription("text"))
												if 'quantityItem {
													set alts($i(altIndex))="textarea|"_..out(##class(cod.objItemName).getDataTypeDescription("textarea"))
												}
											}
											if "radiobutton,dropdown"[type {
												set alts($i(altIndex))="radiobutton|"_..out(##class(cod.objItemName).getDataTypeDescription("radiobutton"))
												set alts($i(altIndex))="dropdown|"_..out(##class(cod.objItemName).getDataTypeDescription("dropdown"))
											}
											if type="checkbox" {
												set alts($i(altIndex))="checkbox|"_..out(##class(cod.objItemName).getDataTypeDescription(type))
											}											
											// Don't allow multi-boxes to be switchable with radios/dropdowns
											if type="multibox" {
												set alts($i(altIndex))="multibox|"_..out(##class(cod.objItemName).getDataTypeDescription(type)) 
											}
											if type="integer" {
												set alts($i(altIndex))="integer|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="floatingPointNumber" {
												set alts($i(altIndex))="floatingPointNumber|"_##class(cod.objItemName).getDataTypeDescription(type)
											}											
											if type="time" {
												set alts($i(altIndex))="time|"_..out(##class(cod.objItemName).getDataTypeDescription(type))
											}
											if type="date" {
												set alts($i(altIndex))="date|"_..out(##class(cod.objItemName).getDataTypeDescription(type))
											}
											if type="dateRange" {
												set alts($i(altIndex))="dateRange|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="emailAddress" {
												set alts($i(altIndex))="emailAddress|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="multiEmailAddress" {
												set alts($i(altIndex))="multiEmailAddress|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="phoneNumber" {
												set alts($i(altIndex))="phoneNumber|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="webAddress" {
												set alts($i(altIndex))="webAddress|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="password" {
												set alts($i(altIndex))="password|"_..out(##class(cod.objItemName).getDataTypeDescription(type))
											}

										}
										set m=""
										for  {
											set m=$O(alts(m))
											if m="" quit
											set show=1
											if isSurvey {
												set show=##class(cod.methods).isCodTypeAllowedForRegPageType("surveys",$P(alts(m),"|",1))	
											} 
											if (isAwardsEntryPage) {
												set show=##class(cod.methods).isCodTypeAllowedForRegPageType("awards",$P(alts(m),"|",1))	
											}
											if (isAbstractPage) {
												set show=##class(cod.methods).isCodTypeAllowedForRegPageType("abstracts",$P(alts(m),"|",1))	
											}
											if isMeetManPage {
												set show=##class(cod.methods).isCodTypeAllowedForRegPageType("meetman",$P(alts(m),"|",1))
											}
											if isAccomPage {
												set show=##class(cod.methods).isCodTypeAllowedForRegPageType("accommodation",$P(alts(m),"|",1))
											}
											
											
											if show {
												write !,"<option value='",$P(alts(m),"|",1),"' "
												if type=$P(alts(m),"|",1) write "SELECTED"
												write ">",$P(alts(m),"|",2),"</option>"
											}
										}
									</script>
									</select>
									<span style="padding-left: 20px;" id="spanSearchAsYouType">
										<script language="cache" runat="server">
											set isChecked=0
											if $IsObject(objCODitem) {
												set isChecked=objCODitem.searchAsYouType
											}
										</script>
										<input type="checkbox" name="chkSearchAsYouType" value=1 #($Select(isChecked:"CHECKED",1:""))# style="vertical-align: sub;">
										Search-as-you-type
									</span>
									<script language="cache" runat="server">
										if '##class(sc.xModules.objPage).isSearchAsYouTypeAllowed(pageID) {
											write !,"<script language='javascript'>$('#spanSearchAsYouType').hide();</scri"_"pt>"	
										}
									</script>
								</td>
							</tr>
							<script language="cache" runat="server">
								set show=0
								if ##class(setup.objSystemTypes).isModuleAllowed("Mandatory Questions") set show=1
								if ##class(setup.objSystemTypes).isModuleAllowed("Backend Only Questions") set show=1
								if ##class(setup.objSystemTypes).isModuleAllowed("Read Only Questions") set show=1
								if ##class(setup.objSystemTypes).isModuleAllowed("Stop Amendments for Questions") set show=1

								set alwaysMandatory=0
								if $ZCVT(description,"L")="firstname" set alwaysMandatory=1
								if $ZCVT(description,"L")="lastname" set alwaysMandatory=1
								set templateName = $ZCVT(%request.Get("templateURL"),"U")
 								if templateName [ "TTABLEGUESTS.CSP" set alwaysMandatory = 0
							</script>
							<csp:if condition=(show)>
								<tr>
									<td width="13" height="30">&nbsp;</td>
									<td class="black10px" align="right" height="30" width="184"></td>
									<td class="black10px" height="30" colspan="4">
										<table border=0 cellpadding=0 cellspacing=0>
											<tr>
												<systemType:if module="Mandatory Questions">
													<td align="left">
														<csp:if condition=(alwaysMandatory)>
															<img src="../../media/images/English/Default/backend/tick.gif" alt="" width="14" height="12" border="0">
														<csp:else>
															<input type="checkbox" name='chkMandatory' value="1" #($S(mandatory=1:"checked",1:0))# style="margin-left:0px;">
														</csp:if>
													</td>
													<td class="black10px">
														<tx>Mandatory</tx>
													</td>
													<td width=20></td>
												</systemType:if>
												<systemType:if module="Backend Only Questions">
													<td>
														<input type="checkbox" name='chkBackendOnly' value="1" class="black10px" #($S(backendOnly=1:"checked",1:0))#>
													</td>
													<td class="black10px">
														<tx>Admin portal only</tx>
													</td>
													<td width=20></td>
												</systemType:if>
												<input type="hidden" name='chkReportOn' value="1">
												<systemType:if module="Read Only Questions">
													<td>
														<input type="checkbox" name='chkReadonlyFrontend' value="1" class="black10px" #($S(readonlyFrontend=1:"checked",1:0))#>
													</td>
													<td class="black10px">
														<tx>Read only</tx>
													</td>
													<td width=20></td>
												</systemType:if>
												<systemType:if module="Stop Amendments for Questions">
													<td>
														<input type="checkbox" name='chkNoAmendments' value="1" class="black10px" #($S(noAmendments=1:"checked",1:0))# title='#(..out("If checked, event website users will not be able to change the value when amending their registration"))#'>
													</td>
													<td class="black10px">
														<tx>Stop amendments</tx>
													</td>
												</systemType:if>
											</tr>
										</table>
									</td>
								</tr>
							</csp:if>
							<csp:if condition=(alwaysMandatory)>
								<input type="hidden" name='chkMandatory' value="1">
							</csp:if>
							<systemType:if module="Min and Max alts on multi checkboxes">
								<tr>
									<td width="13" height="30">&nbsp;</td>
									<td class="black10px" align="right" height="30" width="184"><tx>Multi checkbox options</tx>:</td>
									<td class="black10px" height="30" colspan="4">
										<table border=0 cellpadding=2>
											<tr>
												<td class="black10px" width=133 align="right">
													<tx>Min no. of alternatives:</tx>
												</td>
												<td>
													<input type="text" name="multiCheckboxMin" size=2 class="black10px" value="#(multiCheckboxMin)#">
												</td>
												<td class="black10px" width=133 align="right">
													<tx>Max no. of alternatives:</tx>
												</td>
												<td>
													<input type="text" name="multiCheckboxMax" size=2 class="black10px" value="#(multiCheckboxMax)#">
												</td>
											</tr>
										</table>
									</td>
								</tr>
							</systemType:if>
							<systemType:if module="Alternative Question Name in reports">
								<tr>
									<td width="13" height="33">&nbsp;</td>
									<td class="black10px" align="right" height="33" width="184" >
										<csp:if condition=(isAwardsEntryPage)>
											<tx>Alt. name in search/judges page</tx>:&nbsp;&nbsp;
										<csp:elseif condition=(meetingsEnabled)>
											<tx>Alt. name in search/meeting pages</tx>:&nbsp;&nbsp;
										<csp:else>
											<tx>Alt. name in search</tx>:&nbsp;&nbsp;
										</csp:if>
									</td>
									<td class="black10px" valign="middle" height="33" colspan="3">
										<input type="text" name="reportDescription" value="#(reportDescription)#" style="width: 285px;" class="black10px">
									</td>
								</tr>
							</systemType:if>
							<tr>
								<td width="13">&nbsp;</td>
								<td class="black10px" align="right"><tx>Field width</tx>:&nbsp;</td>
								<td colspan=99>
									<table cellpadding=0 cellspacing=0 border=0>
										<tr>
											<td class="black10px" valign="middle">
												<input type="text" name="txtFieldWidth" size="3" class="black9px" value="#(fieldWidth)#" title="Enter width in pixels">&nbsp;pixels
											</td>
											<td class="black10px" width="65" align="right">
												<tx>Height</tx>:&nbsp;
											</td>
											<td class="black10px" valign="middle">
												<input type="text" name="txtFieldHeight" size="3" class="black9px" value="#(fieldHeight)#" title="Enter the height in number of text rows">&nbsp;lines
											</td>
											<script language="cache" runat="server">
												// phased out for new and copied events as of Feb 2015
												if ##class(setup.objEventSetting).getParameter("legacy","hide 'place on same line' for registration questions",xEventID) {
													set showPlaceOnSameLine=0
												} else {
													set showPlaceOnSameLine=1	
												}
												set checked=""
												if dataID,objCODitem.supressNewLine set checked="CHECKED"

											</script>
											<csp:if condition="showPlaceOnSameLine">
												<td width=40 align="right">
													<input type="checkbox" name="suppressNewLine" value=1 #(checked)#  title="Places this item on the same line as the one next to it (requires that the other item also has this checked).">
												</td>
												<td class="black10px" width=120 >
													<tx>Place on same line</tx>
												</td>
											<csp:else>
													<td width=30>
														<input type="hidden" name="suppressNewLine" value="#($S(checked="CHECKED":1,1:0))#">
													</td>
											</csp:if>
											
											<systemType:if module="Prompt Width">
												<td class="black10px" align="right">
													<tx>Prompt width</tx>:&nbsp;
												</td>
												<td class="black10px" nowrap>
													<script language="cache" runat="server">
														set promptWidth=""
														if dataID set promptWidth=objCODitem.promptWidth
													</script>
													<input type="text" name="promptWidth" id="idPromptWidth" value="#(promptWidth)#" size=3 class="black9px"  title="Controls the width of the text"> %
												</td>
											</systemType:if>
										</tr>
									</table>
								</td>
							</tr>
							<csp:if condition=(('isDOC)&('isForm)&('additional))>

								<tr>
									<td></td>
									<td colspan=2>
										<table border=0 cellpadding=0 cellspacing=0 width="88%">
											<csp:if condition=(showGuest)>
												<tr>
													<td width="120px"></td>
													<td class="black10px" nowrap><tx>Applies to</tx>:&nbsp;</td>
													<td class="black10px">
														<input type="radio" name="radDelegateOrGuest" value="delegate" #($S((isDelegate)!(('isDelegate)&('isGuest)):"checked",1:""))#>
													</td>
													<td class="black10px" align="left">
														<tx>Attendees</tx>
													</td>
													<td rowspan=2 width="320px" valign="top" class="black10px" align="left">
													</td>
												</tr>
												<tr>
													<td colspan=2></td>
													<td class="black10px">
														<input type="radio" name="radDelegateOrGuest" value="guest" #($S(isGuest:"checked",1:""))# #($S(type="multibox":"DISABLED",1:""))#>
													<td class="black10px">
														<tx>Guests</tx>	
													</td>
												</tr>
											<csp:else>
												<script language="cache" runat="server">
													set tmpdelegateOrGuest="delegate"
													if hasAnyDependencies {
														if isGuest set tmpdelegateOrGuest="guest"
													}
												</script>
												<input type="hidden" name="radDelegateOrGuest" value="#(tmpdelegateOrGuest)#">
												<csp:if condition="$L(notShowGuestExplanation)">
													<tr>
														<td width="120px"></td>
														<td class="black10px" nowrap><tx>Applies to</tx>:&nbsp;</td>
														<td class="black10px">
															<input type="radio" name="dummy1" value="" #($S(tmpdelegateOrGuest="delegate":"CHECKED",1:""))# DISABLED>
														</td>
														<td class="black10px" align="left">
															<tx>Attendees</tx>
														</td>
														<td width=50></td>
														<td rowspan=2 valign="top" class="black10px" style="padding-top: 5px; padding-right: 3px;  padding-left: 8px; padding-bottom: 5px;color: 505050; background-color: #fff8dc;" align="left">
															#(notShowGuestExplanation)#
														</td>
													</tr>
													<tr>
														<td colspan=2></td>
														<td class="black10px">
															<input type="radio" name="dummy2" value="" #($S(tmpdelegateOrGuest="guest":"CHECKED",1:""))# DISABLED>
														</td>
														<td class="black10px">
															<tx>Guests</tx>
														</td>
													</tr>
												</csp:if>
											</csp:if>
										</table>
									</td>
								</tr>	
								<tr><td height=10></td></tr>

							<csp:elseif condition=(additional)>
								<input type="radio" name="radDelegateOrGuest" value="delegate" checked style="visibility: hidden;">
								<input type="radio" name="radDelegateOrGuest" value="guest" style="visibility: hidden;">

							<csp:else>
								<input type="radio" name="radDelegateOrGuest" value="delegate" checked style="visibility: hidden;">
								<input type="radio" name="radDelegateOrGuest" value="guest" style="visibility: hidden;">
							</csp:if>

							<csp:include page="dependancyOptionsInclude.csp">

							<tr><td height=10></td></tr>
							<script language="cache" runat="server">
								set isCallout=0
								set tmpTitle=..out("Enter an answer or pattern that must be matched, or a custom validation method starting with '#'")
								if $e(requiredAnswer,1,2)="##" {
									// Validate bespoke callouts
									set callOutMethod=$e(requiredAnswer,3,$l(requiredAnswer))
									if callOutMethod?1A.AN {
										set callOutMethod="customCode.codAnswerValidation."_##class(shared.callOuts).classNameForBespokeCode()_"."_callOutMethod
										if ##class(%MethodDefinition).%OpenId(callOutMethod).ClassMethod {
											set tmpTitle=$TR(##class(%MethodDefinition).%OpenId(callOutMethod).Description,$C(13)," ")
											set isCallout=1
										}
									}
									if 'isCallout {
										set requiredAnswer=""
									}
								}
							</script>
							<tr>
								<td width="13"></td>
								<td class="black10px" align="right"><tx>Custom validation</tx>:&nbsp;</td>
								<td colspan=4>
									<input type="Text" name="requiredAnswer" class="black10px" style="width: 283px;" value="#(..encodeForHTMLAttribute(requiredAnswer))#" title="#(..encodeForHTMLAttribute(tmpTitle))#">
									&nbsp;<csp:if condition=(isCallout)><span class="redbold10px"><tx>Warning: Custom validation is using bespoke validation</tx></span></csp:if>
								</td>
							<tr>
							<tr><td height=10></td></tr>
							<tr>
								<td width="13"></td>
								<td class="black10px" align="right"><tx>Validation error message</tx>:&nbsp;</td>
								<td colspan=4>
									<input type="Text" name="validationErrorMessage" class="black10px" style="width: 283px;" value="#(..encodeForHTMLAttribute(validationErrorMessage))#" >
								</td>
							<tr>
							<tr><td height=10></td></tr>
							<tr>
								<td width="13">&nbsp;</td>
								<td class="black10px" align="right"><tx>Default answer</tx>:&nbsp;</td>
								<td colspan=4>
									<table cellpadding=0 cellspacing=0 border=0>
										<tr>
											<td width=300>
												<script language="cache" runat="server">
												set show=##class(sc.xModules.objPage).isRegistrationPage(pageID)
												if +##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)=0 set show=0
												set isChecked=0
												if $g(objCODitem) set isChecked=+##class(sc.xModules.objCODitem).getCopyValueFromBooker(dataID)
												
											   </script>
													<input type="Text" name="defaultValueText" id="defaultValueText" style="width: 283px;" value="#(..EscapeHTML(defaultValue))#" title="Will be used as the initial value for this question." class="black10px">
													<select name="defaultValueAlt" id="defaultValueAlt" size="1" style="width: 300px;" title="Will be used as the initial value for this question" class="black10px">
														<option value='' #($S(defaultValue="":"SELECTED",1:""))#></option>
														<script language="cache" runat="server">
															set rs=##class(cod.objItemAlternatives).getAlternativesForCodItemAsResultSet(itemNameID)
														</script>
														<csp:while condition="rs.Next()">
															<script language="cache" runat="server">
																set tmpDesc=rs.Get("description")
																set selected=""
																if tmpDesc=defaultValue set selected="SELECTED"
															</script>
															<option value='#(tmpDesc)#' #(selected)#>#(tmpDesc)#</option>
														</csp:while>
													</select>
											</td>
											<csp:if condition=(show)>
												<td>&nbsp;
													<input type="checkbox" name="chkCopyFromBooker" id="chkCopyFromBooker" #($S(isChecked=1:"CHECKED",1:""))# value=1 onClick="ef.codQuestionDetails.updateDefaultField(this.checked);">
												</td>
												<td class="black10px">
													Copy from registration contact
												</td>
											</csp:if>
										</tr>
									</table>
								</td>
							<tr>
							<script language="cache" runat="server">
								set minDateRange=""
								set maxDateRange=""
								if (type="dateRange") {
									set minDateRange=$P(##class(cod.lnkItemNameEventDateRange).getMinTimeStamp(xEventID, itemNameID)," ",1)
									set minDateRange=##class(shared.dateFunctions).multiDate(minDateRange,xUserInputDateFormat,,25)
									set maxDateRange=$P(##class(cod.lnkItemNameEventDateRange).getMaxTimeStamp(xEventID, itemNameID)," ",1)
									set maxDateRange=##class(shared.dateFunctions).multiDate(maxDateRange,xUserInputDateFormat,,25)
								}
								
							</script>
							<csp:if condition=(1)>
								<tr><td height=10></td></tr>
					    		<tr id="dateRangeContainerRow" style="visibility:collapse;">
									<td class="black10px">&nbsp;</td>
									<td class="black10px" align="right"><tx>Available dates</tx>&nbsp;:&nbsp;*&nbsp;</td>
									<td class="black10px">
										<input type="text" class="black10px efDateRangePicker efDateRangeStart" id="dateRangeStart" efDateRangeEndID="dateRangeEnd" name="dateRangeStart" value="#(minDateRange)#" inputDateFormat="#(+$GET(xUserInputDateFormat))#">
										&nbsp;-&nbsp;
										<input type="text" class="black10px efDateRangePicker efDateRangeEnd" id="dateRangeEnd" efDateRangeStartID="dateRangeStart" name="dateRangeEnd" value="#(maxDateRange)#" inputDateFormat="#(+$GET(xUserInputDateFormat))#" title="A date range cannot be longer than 30 days">
										<span class="black9px" id="spanDate1">(#(##class(shared.dateFunctions).getBackendInputDatePattern())#)</span>
									</td>
									 
								</tr>
								<tr id="afterDateRangeContainerRow" style="visibility:collapse;"><td height=10></td></tr>
						</csp:if>
							<systemType:if module="Max Length of Answer">
								<script language="cache" runat="server">
									set show=0
									if (type="text")!(type="textarea")!(type="password") set show=1
								</script>
								<csp:if condition=(show)>
									</tr>
										<td width="13">&nbsp;</td>
										<td class="black10px" align="right"><tx>Max length of answer</tx>:&nbsp;</td>
										<td colspan=99>
											<table border=0 cellpadding=0 cellspacing=0>
												<tr>
													<script language="cache" runat="server">
														set useCharacters=1
														if maxWords set useCharacters=0
													</script>

													<td class="black10px">
														<input type="Text" name="maxCharacters" class="black10px" size="5" value="#(..EscapeHTML($S(useCharacters:maxCharacters,1:maxWords)))#" title="The page cannot be saved if the answer is longer than this number of characters.">&nbsp;&nbsp;
													</td>
													<td class="black10px">
														<input type="radio" name="radCharsOrWords" value="chars" #($S(useCharacters:"CHECKED",1:""))#>&nbsp;<tx>Characters</tx>
														<input type="radio" name="radCharsOrWords" value="words"  #($S('useCharacters:"CHECKED",1:""))#>&nbsp;<tx>Words</tx>
													</td>
												</tr>
											</table>
										</td>
									</tr>
								</csp:if>
							</systemType:if>
						</table>
						<table width="100%" border="0" cellspacing="0" cellpadding="2">
							<script language="cache" runat="server">
								// display a warning if these alternatives are currently being used in another live event
								kill tmpEventsUsing
								set show=0,eventList="--- "_..out("The following events are already using this database item")_" ---"
								if ('##class(cod.objItemName).isSingleEventQuestion(itemNameID))&&(##class(cod.objItemAlternatives).getAlternativesCountForCodItem(itemNameID)) {
									set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")

									do rs.Prepare("SELECT parent->parent AS pageID from sc_xModules.objCODItem WHERE objItemName=:itemNameID AND active=1")
									do rs.Execute()
									while (rs.Next()) {
										Set tmpPageID = rs.Get("pageID")
										set tmpEventID = ##class(sc.methods).getEventIDfromPageID(tmpPageID)
										If ((tmpEventID '= "") && (tmpEventID '= xEventID)) {
											// just use the english language description for event
											&SQL(SELECT description, objEvent->status INTO :tmp, :tmp2 FROM setup.objEventDetails WHERE objEvent = :tmpEventID AND objLanguage=1)
											If +SQLCODE=0 {
												set eventDescr=tmp
												set eventStatus=tmp2
												set show=1
												set tmpEventsUsing(eventStatus,tmpEventID)=eventDescr
											}
										}
									}
								}								
							</script>
							<csp:if condition=(show)>
								<tr>
									<td></td>
									<td colspan=99 align="center" height=30 class="black10px">
										<span class="blackbold10px"><tx>Warning</tx>:&nbsp;</span>
										<tx>Any changes you make to these alternatives will also be reflected in the following events</tx>:
										<a href="javascript: toggleUsedInEventsListVisibility();"><span id="showHideText">#(showListText)#</span></a>
										<br />
										<br />
										<div align="left">
										<div align="left" id="usedInEventsList" class="black10px" style="display:none; width:400px; height:200px; overflow:auto; overflow-x:hidden; border: 1px solid; padding: 5px; background-color: #e0e2d2;">
											<script language="cache" runat="server">
												set statusDisplayOrder(1)="live"
												set statusDisplayOrder(2)="notlive"
												set statusDisplayOrder(3)="archived"
												set statusDisplayOrder(4)="cancelled"
												set statusIndex=""
											</script>
											<csp:while condition=($ORDER(statusDisplayOrder(statusIndex))'="")>
												<script language="cache" runat="server">
												set statusIndex=$ORDER(statusDisplayOrder(statusIndex))
												set eventStatus=$GET(statusDisplayOrder(statusIndex))
												set tmpEventID=""
												</script>
												<csp:if condition="$DATA(tmpEventsUsing(eventStatus)) > 0">
													<span class="whitebold10px" style="display:block; background-color: #CC0033; padding:2px;">#(..out(eventStatus))# <tx>events</tx>:</span>
													<script language="cache" runat="server">
														set rowColor="#e0e2d2"
													</script>
													<csp:while condition=($ORDER(tmpEventsUsing(eventStatus,tmpEventID))'="")>
														<script language="cache" runat="server">
															set tmpEventID=$ORDER(tmpEventsUsing(eventStatus,tmpEventID))
															set rowColor=$SELECT(rowColor="#ffffff":"e0e2d2",1:"#ffffff")
														</script>
														<span style="padding:2px; display:block; background-color: #(rowColor)#;">#(tmpEventID)# - #($GET(tmpEventsUsing(eventStatus,tmpEventID)))#</span>
													</csp:while>
													<br />
													<br />
												</csp:if>
											</csp:while>
										</div>
										</div>
									</td>
								</tr>
							</csp:if>
							<tr>
								<td width="1">&nbsp;</td>
								<td class="black10px" align="right" width="184" valign="top"><tx>Answer alternatives</tx>:&nbsp;</td>
								<td class="black10px" valign="top" colspan="2">
									<table width="100%" border="0" cellspacing="0" cellpadding="0">
										<tr>
											<td valign="top" width="45%">
												<script language="cache" runat="server">
													k hasDependencies
													set rs=##class(cod.objItemAlternatives).getAlternativesForCodItemAsResultSet(itemNameID)
												</script>
												<select name="selAlternative" id="selAlternative"  multiple class="black10px" style="width: 302px; height: 100px;">
													<csp:while condition="rs.Next()">
														<script language="cache" runat="server">
															// Do not allow them to delete questions that have dependent children
															
															set altDesc=rs.Get("description")
															
															set code=rs.Get("code")
															set labelDesc=altDesc
															if $l(code) set altDesc=altDesc_" ("_..out("Code")_": "_code_")"
															set altID=rs.Get("ID")
															
															&SQL(SELECT ID FROM sc_xModules.objCODitem WHERE (dependsOnPrompt = :dataID) AND (dependsOnAlternative = :altID) AND (active=1))
															if +SQLCODE=0 set hasDependencies(altID)="dependent question"
															// Do not allow them to delete questions that have dependent children
															&SQL(SELECT ID FROM sc_xModules.objText WHERE (dependsOnPrompt = :dataID) AND (dependsOnAlternative = :altID) AND (active=1))
															if +SQLCODE=0 set hasDependencies(altID)="dependent text block"
															&SQL(SELECT ID FROM setup.lnkCategoryEvent WHERE (dependsOnPromptPageID = :pageID) AND (%SQLUPPER(dependsOnObjItemName->description) = %SQLUPPER(:description)) AND (dependsOnAlternative = :altDesc) AND (active=1))
															if +SQLCODE=0 set hasDependencies(altID)="dependent page"
														</script>
														<option value='#(altID_"|"_code)#'>#(altDesc)#</option>
													</csp:while>
												</select>
												<script language="cache" runat="server">
													set altID=""
												</script>
												<csp:while condition="$O(hasDependencies(altID))">
													<script language="cache" runat="server">
														set altID=$O(hasDependencies(altID))
													</script>
													<input type="hidden" name="hasDependencies_#(altID)#" value="#(hasDependencies(altID))#">
												</csp:while>
                                              </td>
											<td width="2%" valign="top">&nbsp;</td>
											<td width="53%" valign="top">
                                               <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                   <tr>
                                                     	<td width="20%" height="30">
													   		<img src="../../media/images/English/Default/backend/up.gif" alt="up" title="Move up one step" width="15" height="12" border="0" onClick="move('up');">
													   		<img src="../../media/images/English/Default/backend/top.gif" alt="top" title="Move to top" width="15" height="12" border="0" onClick="move('top');">
														</td>
														<td width="30%" height="30">
															<img src="../../media/images/English/Default/backend/delete.gif" name="butDelete" id="butDelete" alt="Delete selected alternative" width="50" height="17" border="0" onClick="deleteAlternative();">
														</td>
														<td width="50%"></td>
													</tr>
													<tr>
														<td  height="30">
															<img src="../../media/images/English/Default/backend/down.gif" alt="down" title="Move down one step" width="15" height="12" border="0" onClick="move('down');">
															<img src="../../media/images/English/Default/backend/bottom.gif" alt="bottom" title="Move to bottom" width="15" height="12" border="0" onClick="move('bottom');">
														</td>
														<td  height="30">
															<csp:if condition=(additional)>
																<script language="cache" runat="server">
																	set showAdvPage=0
																	if dataID set showAdvPage=1
																</script>
																<csp:if condition=(showAdvPage)>
																	<a href="javascript: editAlt();"><img src="../../media/images/English/Default/backend/advanced.gif" alt="Advanced"  name="butEdit" id="butEdit" height="17" border="0" title="Adds price and capacity to the selected alternative"></a>
																<csp:else>
																	<img src="../../media/images/English/Default/backend/advanced.gif" style="filter: alpha(opacity=35); opacity: 0.35;"  alt="Advanced" height="17" border="0" name="butEdit" id="butEdit" title="Advanced details is only available after you have saved the question.">
																</csp:if>
															<csp:else>
																<a href="javascript: editAlt();"><img src="../../media/images/English/Default/backend/edit.gif" alt="Edit" width="45" height="17" name="butEdit" id="butEdit" border="0"></a>
															</csp:if>
														</td>
														<systemType:if module="alternative codes">
															<td>
																<a href="javascript: editCode();"><img src="../../media/images/English/Default/backend/code.gif" alt="Code" name="butCode" id="butCode" border="0" title="#(..out("Click to add/amend a code"))#"></a>
															</td>
														</systemType:if>
													</tr>
													<tr><td height=5></td></tr>
													<script language="cache" runat="server">
														if layout="" set layout="vertical"
													</script>
													<tr>
														<td></td>
														<td class="black10px" colspan=3>
															<input type="radio" name="radLayout" value="horizontal" #($S(layout="horizontal":"CHECKED",1:""))#>&nbsp;
															<tx>Horizontal</tx></td>
													</tr>
													<tr>
														<td></td>
														<td class="black10px" colspan=3>
															<input type="radio" name="radLayout" value="vertical"  #($S(layout="vertical":"CHECKED",1:""))#>&nbsp;
															<tx>Vertical</tx></td>
													</tr>
                                                 </table>
											</td>
										</tr>
									</table>
								</td>
							</tr>
							<tr>
								<td width="1">&nbsp;</td>
								<td class="black10px" align="right">&nbsp;</td>
								<td class="black10px" valign="top">
									<img src="../../media/images/English/Default/backend/add.gif" alt="" width="65" height="17" name="butAddAlt" id="butAddAlt" border="0" onClick="addAlternative();">
									<script language="cache" runat="server">
										set %session.Data("afterUpload")=baseURL
									</script>
									<csp:if condition=(dataID)>
										<img src="../../media/images/English/Default/backend/import.gif" alt="" width="65" height="17" name="butImport" id="butImport" border="0" title="Import alternatives from CSV file">
									<csp:else>
										<img src="../../media/images/English/Default/backend/import.gif" style="filter: alpha(opacity=35); opacity: 0.35;"  alt="Advanced" height="17" border="0" name="butImport" id="butImport" title="Import is only available after you have saved the question.">
									</csp:if>
								</td>
							</tr>
						</table>
						<systemType:if module="Ticketing">
							<csp:if condition=(quantityItem)>
								<img src="../../media/images/English/Default/backend/line.gif" width="600" height="21">
								<script language="cache" runat="server">
									// retrieve the existing data (if there is any)
									set ticketID="",qCapacity="",qNotification="",qNotificationLevel="",createsAttendees="",qRegistrationStatus=""
									set qShowBookingLevel="",qShowCapacity="",qAttendeeCategoryID="",qMin="",qMax=""
									set (directPrice,priceDescriptorID,currencyID,basketItemID,priceByAttendeeCategory,vatCodeID)=""
									kill arrayPrices
									set useVatCodes=##class(eCom.objVatCode).isVatCodesEnabled()
									set arrayPrices(1)=""
									if $ISOBJECT(objCODitem)	{
										set scID=objCODitem.%Id()
										&SQL(SELECT ID,capacity,notification,notificationLevel,createsAttendees,showCapacity,showBookingLevel,categoryToCreate,minimum,maximum,priceByAttendeeCategory,registrationStatus INTO :tmp,:tmp2,:tmp4,:tmp5,:tmp6,:tmp7,:tmp8,:tmp9,:tmp10,:tmp11,:tmp12,:tmp13 FROM cod.objTicket WHERE scCodItemID=:scID)
										if +SQLCODE=0 set ticketID=tmp,qCapacity=tmp2,qNotification=tmp4,qNotificationLevel=tmp5,createsAttendees=tmp6,qShowCapacity=tmp7,qShowBookingLevel=tmp8,qAttendeeCategoryID=tmp9,qMin=tmp10,qMax=tmp11,priceByAttendeeCategory=tmp12,qRegistrationStatus = tmp13

										if 'priceByAttendeeCategory {
											set basketItemID=##class(cod.objTicket).getBasketItemID(ticketID)
											if basketItemID {
												set objBasketItem=##class(eCom.objBasketItem).%OpenId(basketItemID)
												if objBasketItem.objPriceDescriptor'=""	{
													set priceDescriptorID=objBasketItem.objPriceDescriptor.%Id()
												} else {
													// get direct price without knowing the currrency of it
													set directPrice=##class(eCom.objBasketItem).getPrice(xEventID,basketItemID,,"",2,0)
													// get the found currency
													set currencyID=$p(directPrice,"|",1)
													set directPrice=$p(directPrice,"|",2)
													set directPrice=$FN(directPrice,",",2)
												}
												if objBasketItem.objVatCode'="" {
													set vatCodeID=objBasketItem.objVatCode.%Id()
												}
											}
											set arrayPrices(1)=basketItemID_"|"_priceDescriptorID_"|"_currencyID_"|"_directPrice
											set $p(arrayPrices(1),"|",8)=vatCodeID
										} else {
											set counter=0
											set rs=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
											do rs.Execute(xEventID)
											while rs.Next() {
												set counter=counter+1
												set (priceDescriptorID,currencyID,directPrice,sameAsCategoryID,vatCodeID)=""
												set eventCategoryID=rs.Get("objEventCategory")
												set categoryDescription=rs.Get("description")
												&SQL(SELECT objBasketItem,sameAs->objEventCategory INTO :tmp,:tmp2 FROM links.lnkCategoryItemBasketItem WHERE (objTicket=:ticketID) and (objEventCategory=:eventCategoryID))
												if +SQLCODE=0 {
													set basketItemID=tmp
													set sameAsCategoryID=tmp2
													set objBasketItem=##class(eCom.objBasketItem).%OpenId(basketItemID)
													if objBasketItem.objPriceDescriptor'=""	{
														set priceDescriptorID=objBasketItem.objPriceDescriptor.%Id()
													} else {
														// get direct price without knowing the currrency of it
														set directPrice=##class(eCom.objBasketItem).getPrice(xEventID,basketItemID,,"",2,0)
														// get the found currency
														set currencyID=$p(directPrice,"|",1)
														set directPrice=$p(directPrice,"|",2)
														set directPrice=$FN(directPrice,",",2)
													}
													if objBasketItem.objVatCode'="" {
														set vatCodeID=objBasketItem.objVatCode.%Id()
													}
												}
												set arrayPrices(counter)=basketItemID_"|"_priceDescriptorID_"|"_currencyID_"|"_directPrice_"|"_eventCategoryID_"|"_categoryDescription_"|"_sameAsCategoryID_"|"_vatCodeID
											}
										}
									}
								</script>

								<table width="100%" border="0" cellspacing="0" cellpadding="2">
								  <tr>
								    <td align="right" class="black10px">&nbsp;</td>
								    <td class="blackbold10px" valign="top"><tx>Quantity bookable item details</tx></td>
								  </tr>
								  <tr>
								    <td align="right" class="black10px" colspan="2">&nbsp;</td>
								  </tr>
								  <tr>
								    <td width="50" >&nbsp;</td>
								    <td class="black10px" valign="top">
										<table border=0 cellpadding=0 cellspacing=0>
								        <tr>
								          <td width="290"></td>
								          <td width="70" height="1"></td>
								          <td width="80"></td>
								          <td width="170"></td>
								        </tr>
										<tr>
 											<td class="black10px" align="right" height="25"><tx>Optional booking levels - minimum</tx>:&nbsp;&nbsp;</td>
											<td class="black10px">
												<input type="text" name="txtqMin" value="#(qMin)#" size="5" class="black10px">
											</td>
											<td class="black10px" align="right" valign="middle">  <tx>maximum</tx>:&nbsp;&nbsp;</td>
											<td class="black10px"><input type="text" name="txtqMax" value="#(qMax)#" size="5" class="black10px">
											</td>
										</tr>
										<script language="cache" runat="server">
											set show=inBookersPage
											if ##class(setup.objEventSetting).getParameter("basket","basket links to registration pages",xEventID) set show=0
											//if the event has Accommodation ON, disable the ticketing that creates real attendees. 
											if (##class(setup.objEventSetting).getParameter("bookings","allow accommodation bookings",xEventID)) set show=0
											if ##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID) {
												set show=0	
											}
										</script>
										<csp:if condition=(show)>
									        <tr>
									          <td align="right" class="black10px" >
											  	<tx>Should this question create real attendees?</tx>&nbsp;&nbsp;
											  </td>
									          <td height="25">
											  	<input type="checkbox" name="chkqCreatesAttendees" value="1" onChange="updateAttendeeCategory()" #($S(createsAttendees=1:"checked",1:""))# class="black10px">
									          </td>
									          <td colspan="2">
											  </td>
									        </tr>
										<csp:else>
										  	<input type="hidden" name="chkqCreatesAttendees" value="0">
										</csp:if>
										</table>
									<div id="divTicketingCreateAttendees" style="display:none;">
										<table border=0 cellpadding=0 cellspacing=0>
								        <tr>
								          <td width="290"></td>
								          <td width="60" height="1"></td>
								          <td width="70"></td>
								          <td width="190"></td>
								        </tr>
								        <tr>
								          <td align="right" class="black10px"><tx>Create attendees of this category</tx>:</td>
								          <td height="25">&nbsp;</td>
								          <td colspan="2">
											<csp:if condition=(xEventID)>
												<script language="cache" runat="server">
													// get all the active categories for this event
													set rs=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
													do rs.Execute(xEventID)
												</script>
											  	<select name="selqAttendeeCategory" size="1" class="black10px" style="width:200px;">
												<csp:while condition="rs.Next()">
													<script language="cache" runat="server">
														set eventCategoryID=rs.Data("objEventCategory")
														set selected=""
														if eventCategoryID=qAttendeeCategoryID set selected="SELECTED"
														// set default for new
														if 'qAttendeeCategoryID {
															set defaultCategoryID=##class(setup.lnkCategoryEvent).getDefault(xEventID)
															if 'defaultCategoryID set defaultCategoryID=##class(setup.objEventCategory).getDefaultCategoryID()
															
															if eventCategoryID=defaultCategoryID set selected="SELECTED"
														}
													</script>
													<option value="#(eventCategoryID)#" #(selected)#>#(rs.Data("description"))#</option>
												</csp:while>
									          	</select>
											</csp:if>
										  </td>
								        </tr>
										</table>
										<csp:if condition=(hasPricing)>
											<tx>As this question creates real attendees, pricing is set up in the prices section for the relevent attendee</tx>
										</csp:if>
									</div>
									<div id="divTicketingPricingCapacity" style="display:none;">
										<table border=0 cellpadding=0 cellspacing=0>
										<tr>
											<td width="290"></td>
											<td width="60" height="1"></td>
											<td width="70"></td>
											<td width="190"></td>
										</tr>
										<tr>
											<td class="black10px" align="right">Registrations:&nbsp;&nbsp;</td>
											<td class="black10px">
												<select name="selRegistrationStatus" class="black10px">
													<option value="unlimited" #(..rawHTML($Select(qRegistrationStatus="unlimited":"selected",1:"")))#>Unlimited</option>
													<option value="limited" #(..rawHTML($Select(qRegistrationStatus="limited":"selected",1:"")))#>Limited</option>
													<option value="stopped" #(..rawHTML($Select(qRegistrationStatus="stopped":"selected",1:"")))#>Stopped</option>
												</select>
											</td>
										</tr>
										<tr data-show-hide-dependency-list="#(..encodeForHTMLAttribute("{""logic"":""and"",""dependencies"":[{""parentName"":""selRegistrationStatus"",""operator"":""eq"",""value"":""limited""}]}"))#">
											<td class="black10px" align="right"><tx>Capacity</tx>:&nbsp;&nbsp;</td>
											<td class="black10px">
											<input type="text" name="txtqCapacity" value="#(qCapacity)#" size="5" class="black10px">
											</td>
											<td colspan="2" class="black10px" >&nbsp;</td>
										</tr>
										<csp:comment><!-- Show booking level for QBI's --></csp:comment>
										<tr>
											<td class="black10px" align="right"><tx>Current booking level</tx>:&nbsp;&nbsp;</td>
											<td class="black10px" height="25">
												<script language="cache" runat="server">
													set dataID=%request.Get("dataID")
													if dataID="" set dataID=%session.Get("dataID")
													
													set ticketID=##class(cod.objTicket).getTicketIDfromDataID(dataID)
													if ticketID'="" {
														set eventBookableItemQBI = ##class(setup.eventBookableItemQBI).createNew(eventConfiguration,ticketID)
														do eventBookableItemQBI.load()
														write eventBookableItemQBI.bookingLevel.getCompleted()
													} else {
														write "0"
													}
												</script>
											</td>
											<td colspan="2" class="black10px" >&nbsp;</td>
										</tr>
										<systemType:if module="EMAIL">
											<tr>
												<td class="black10px" align="right" height="25"><tx>Send notification</tx>:&nbsp;&nbsp;</td>
												<td class="black10px">
													<input type="checkbox" name="chkqNotification" value="1" #($S(qNotification=1:"checked",1:""))# class="black10px">
												</td>
												<td class="black10px" align="right" data-show-hide-dependency-list="#(..encodeForHTMLAttribute("{""logic"":""and"",""dependencies"":[{""parentName"":""chkqNotification"",""operator"":""eq"",""value"":""1""}]}"))#"><tx>Level</tx>:&nbsp;&nbsp;</td>
												<td class="black10px" data-show-hide-dependency-list="#(..encodeForHTMLAttribute("{""logic"":""and"",""dependencies"":[{""parentName"":""chkqNotification"",""operator"":""eq"",""value"":""1""}]}"))#">
													<input type="text" name="txtqNotificationLevel" value="#(qNotificationLevel)#" size="4" class="black10px"> %
												</td>
											</tr>
										</systemType:if>
										<tr>
											<td class="black10px" align="right" height="25"><tx>Show number remaining</tx>:&nbsp;&nbsp;</td>
											<td class="black10px">
												<input type="checkbox" id="chkqShowBookingLevel" name="chkqShowBookingLevel" value="1" #($S(qShowBookingLevel=1:"checked",1:""))# class="black10px">
											</td>
										</tr>
										<systemType:if module="Attendee Categories">
											<csp:if condition=(hasPricing)>
												<td class="black10px" align="right" height="25"><tx>Price by attendee category</tx>:&nbsp;&nbsp;</td>
													<td>
														<input type="Checkbox" name="chkPriceByAttendeeCategory" value=1  onclick="toggleAttendeeCategory()" #($S(priceByAttendeeCategory:"CHECKED",1:""))#>
													</td>
												</td>
											</csp:if>
										</systemType:if>
										<tr>
											<td class="black10px" align="right">&nbsp;</td>
											<td class="black10px" >&nbsp; </td>
											<td colspan="2" class="black10px" >&nbsp;</td>
										</tr>
										</table>
										<script language="cache" runat="server">
											set categoryCounter=1
										</script>
										<csp:if condition=(hasPricing)>
										<csp:while condition=($d(arrayPrices(categoryCounter)))>
											<script language="cache" runat="server">
												kill selection
												set data=arrayPrices(categoryCounter)
												set basketItemID=$p(data,"|",1)
												set priceDescriptorID=$p(data,"|",2)
												set currencyID=$p(data,"|",3)
												set directPrice=$p(data,"|",4)
												set eventCategoryID=$p(data,"|",5)
												set eventCategoryDescription=$p(data,"|",6)
												set sameAs=$p(data,"|",7)
												set vatCodeID=$p(data,"|",8)
												if priceByAttendeeCategory {
													set tmp="",allowRelink=1
													for {
														set tmp=$o(arrayPrices(tmp))
														if tmp="" quit
														if tmp'=categoryCounter {
															set selCategoryID=$p(arrayPrices(tmp),"|",5)
															if $p(arrayPrices(tmp),"|",7)=eventCategoryID {
																set allowRelink=0
																quit
															}
															// use tmp to index to preserve order
															if $p(arrayPrices(tmp),"|",7)="" {
																set selection(tmp)=arrayPrices(tmp)
															}
														}
													}
													if 'allowRelink kill selection
												}
												set header="Price and Discount Information"
												if eventCategoryID set header=header_" for "_eventCategoryDescription
												set categoryCounter=categoryCounter+1
												set selIndex=""
											</script>
											<table width="100%" border="0" cellspacing="0" cellpadding="0">
												<tr>
													<td width="106">&nbsp;</td>
													<td class="red" height="15" colspan="2">
														<span class="whitebold10px">&nbsp;&nbsp;&nbsp;
														#(header)#</span>
													</td>
												</tr>
												<tr>
													<td height=10 colspan=3></td>
												</tr>
												<csp:if condition=$d(selection)>
													<tr>
														<td >&nbsp;</td>
														<td class="black10px" width="100"  bgcolor="#efefef" height=25><tx>Use same prices as...</tx></td>
														<td class="black10px" width="130"  bgcolor="#efefef" height=25>
															<select name="selSameAs_#(eventCategoryID)#" onchange="saveSameAs(#(eventCategoryID)#);" class="black10px" style="width:150px;">
																<option value=""> - <tx>not linked</tx> - </option>
																<csp:while condition="$o(selection(selIndex))">
																	<script language="cache" runat="server">
																		set selIndex=$o(selection(selIndex))
																		set selID=$p(selection(selIndex),"|",5)
																		set selDescription=$p(selection(selIndex),"|",6)
																	</script>
																	<option value="#(selID)#" #($S(selID=sameAs:"SELECTED",1:""))#>#(selDescription)#</option>
																</csp:while>
															</select>
														</td>
													</tr>
												</csp:if>
												<csp:if condition=('sameAs)>
													<tr>
														<td >&nbsp;</td>
														<td class="black10px" width="199"  bgcolor="#efefef" height=25>
															<script language="cache" runat="server">
																set priceType="noPrice"
																if directPrice set priceType="direct"
																if priceDescriptorID set priceType="descriptor"
															</script>
															<input type="radio" value="noPrice" name="radPriceType_#(eventCategoryID)#" onClick="updatePricing_#(eventCategoryID)#();" #($S(priceType="noPrice":"CHECKED",1:""))#>
															<span style="vertical-align: 50%;"><tx>No Price</tx></span>
														</td>
														<td width="395" height=25 bgcolor="#efefef" class="black10px"> </td>
													</tr>
													<tr>
														<td>&nbsp;</td>
														<td class="black10px"  width="199"  bgcolor="#efefef" height=25>
															<script language="cache" runat="server">
																set directActive=1
																if ##class(setup.objEventSetting).getParameter("currency","allow currency selection",xEventID) set directActive=0
															</script>
															<input type="radio" value="direct" name="radPriceType_#(eventCategoryID)#" onClick="updatePricing_#(eventCategoryID)#();" #($S(priceType="direct":"CHECKED",1:""))#  #($S(directActive=0:"disabled title='Not available in multi currency mode'",1:""))#>
															<span style="vertical-align: 50%;"><tx>Basic price</tx></span>
														</td>
														<td class="black10px" bgcolor="#efefef" height=25>
															<input type="text" name="txtDirectPrice_#(eventCategoryID)#" value="#(directPrice)#" size="10" class="black9px" style="text-align: right;">
															&nbsp;<span style="vertical-align: 30%;"><tx>Currency</tx>:</span>
															<select name="selCurrency_#(eventCategoryID)#" class="black9px" size=1 style="width: 50px">
																<script language="cache" runat="server">
																	&SQL(SELECT objBaseCurrency,objBaseCurrency->code INTO :currencyID,:currencyCode FROM setup.objEvent WHERE ID=:xEventID)
																</script>
																<option value='#(currencyID)#'>#(currencyCode)#</option>
															</select> &nbsp;<span style="vertical-align: 30%;"><tx>or</tx></span>
														</td>
													</tr>
													<tr>
														<td>&nbsp;</td>
														<td class="black10px" width="199"  bgcolor="#efefef" height=25> <input type="radio" value="descriptor" name="radPriceType_#(eventCategoryID)#" onClick="updatePricing_#(eventCategoryID)#();" #($S(priceType="descriptor":"CHECKED",1:""))#>
															<span style="vertical-align: 50%;"><tx>Price descriptor</tx></span>
														</td>
														<td class="black10px" bgcolor="#efefef">
															<table width="93%" border="0" cellspacing="0" cellpadding="0">
																<tr>
																	<td width="415">
																		<select size="1" name="selPriceDescriptor_#(eventCategoryID)#" class="black10px" style="width: 250px;">
																			<csp:query name="rs" classname="eCom.objPriceDescriptor" queryname="qAllActivePricesDelegate" P1=#(xControllerID)#>
																			<option value=""></option>
																			<csp:while condition="rs.Next()">
																				<script language="cache" runat="server">
																					set descDescription=rs.Get("description")
																					set priceType=rs.Data("priceType")
																					set show=1
																					if (priceType="event")!(priceType="day") set show=0
																					set priceDescriptorID2=rs.Get("ID")
																					set show=1

																					// removed SQL to make it compile outside EF
																					set objPriceDescriptor=##class(eCom.objPriceDescriptor).%OpenId(priceDescriptorID2)
																					if (objPriceDescriptor.priceType="event")!(objPriceDescriptor.priceType="day") set show=0
																					kill objPriceDescriptor

																					// get latest price of price descriptor
																					set descCurrencyID=##class(setup.objEvent).getBaseCurrency(xEventID)
																					set descPrice=##class(eCom.objPriceCurrency).getAmountForDescriptor(priceDescriptorID2,descCurrencyID)
																					if 'descPrice {
																						// Loop thru all currencies if we didn't pass one in, necessary for a multi currency environment
																						set rs2=##class(%ResultSet).%New("eCom.objCurrency:qActiveCurrencies")
																						do rs2.Execute()
																						while (rs2.Next())&('descPrice) {
																							set descPrice=##class(eCom.objPriceCurrency).getAmountForDescriptor(priceDescriptorID2,rs2.Data("ID"))
																							if descPrice set descCurrencyID=rs2.Data("ID")
																						}
																					}
																					set descDescription=descDescription_"  ("_##class(eCom.objPrice).formatAmount(descPrice,descCurrencyID)_")"
																				</script>
																				<csp:if condition=(show)>
																					<option value='#(priceDescriptorID2)#' #($S(priceDescriptorID2=priceDescriptorID:"selected",1:""))#>
																						#(descDescription)#
																					</option>
																				</csp:if>
																			</csp:while>
																		</select>
																	</td>
																	<td width="10" align="right">&nbsp;</td>
																</tr>
															</table>
														</td>
													</tr>
													<tr>
														<td height="10" colspan="2">&nbsp;</td>
													</tr>
													<csp:query name="rs" classname="eCom.objDiscount" queryname="qActiveDiscountsByWhichPrice" P1=#(xLangID)# P2=#(xControllerID)# P3="additionalItem">
													<script language="cache" runat="server">
														new count,descs,IDs,data
														set count=0
														while rs.Next() {
															set count=count+1
															set descs(count)=rs.Get("description")
															set IDs(count)=rs.Get("objDiscount")
															set data(count)=##class(eCom.lnkItemDiscount).exists(basketItemID,rs.Get("objDiscount"))
														}
													</script>
													<tr>
														<td>&nbsp;</td>
														<td class="black10px" align="right" height="25" width="120"><tx>Available discounts</tx>:&nbsp;&nbsp;</td>
														<td height="25" class="black10px">
															<table width="100%" border="0" cellspacing="0" cellpadding="0">
																<tr>
																	<td class="black10px">
																		<csp:if condition="count">
																			<table cellpadding="0" cellspacing="0" border="0" width="250" bgcolor="#efefef">
																				<csp:LOOP COUNTER="x" FROM="1" TO="#(count)#">
																					<tr class="black10px">
																						<td width="25" height="25" align="right">
																							<input type="checkbox" name="chkDiscount_#(IDs(x))#_#(eventCategoryID)#" class="black10px" #($S(data(x):"checked",1:""))#>
																						</td>
																						<td width="100" class="black10px">
																							#(descs(x))#
																						</td>
																						<csp:if condition="x<count">
																							<script language="cache" runat="server">
																								set x=x+1
																							</script>
																							<td width="25" height="25" align="right">
																								<input type="checkbox" name="chkDiscount_#(IDs(x))#_#(eventCategoryID)#" class="black10px" #($S(data(x):"checked",1:""))#>
																							</td>
																							<td width="100">
																								#(descs(x))#
																							</td>
																						<csp:else>
																							<td width="25" height="25" align="right">
																								&nbsp;
																							</td>
																							<td width="100">
																								&nbsp;
																							</td>
																						</csp:if>
																					</tr>
																				</csp:LOOP>
																			</table>
																		<csp:else>
																			<tx>None available</tx>
																		</csp:if>
																	</td>
																	<td width="30" align="right">&nbsp;</td>
																</tr>
															</table>
														</td>
													</tr>
													<csp:if condition=(useVatCodes)>
														<tr>
															<td width="20">&nbsp;</td>
															<td class="black10px" width="100" align="right"><tx>Overriding VAT code</tx>:&nbsp;&nbsp;</td>
															<td class="black10px" colSpan=3 height=35>
																<select name="selVatCode_#(eventCategoryID)#" class="black10px" style="width:250px">
																	<option #($s(vatCodeID="":"selected",1:""))# value="">--<tx>Same as event</tx>--</option>
																	<csp:query name="rs" classname="eCom.objVatCode" queryname="qActiveVatCodes">
																	<csp:while condition="rs.Next()">
																		<script language="cache" runat="server">
																			set tmpVatCodeID=rs.Get("ID")
																			set vatCodeDescription=rs.Get("description")
																			set vatCode=rs.Get("code")
																			set selected=$s(vatCodeID=tmpVatCodeID:"selected",1:"")
																		</script>
																		<option value="#(tmpVatCodeID)#" #(selected)#>#(vatCodeDescription)# (#(vatCode)#)</option>
																	</csp:while>
																</select>
															</td>
														</tr>
													</csp:if>
												</csp:if><csp:comment><!-- not sameAs --></csp:comment>
											</table>
										</csp:while>
										</csp:if>
										<systemType:if module="Profit & Loss">
											<tr>
												<td class="black10px" colspan=99>
													<table border="0" cellspacing="0" cellpadding="0">
														<script language="cache" runat="server">
															set initialCost=""
															set unitCost=""
															set currencyCode=""
															if ticketID {
																&SQL(SELECT basketItemID INTO :basketItemID FROM cod.objTicket WHERE ID=:ticketID)
																if +SQLCODE=0 {
																	&SQL(SELECT initialCost,unitCost INTO :tmp1,:tmp2 FROM eCom.objBasketItem WHERE ID = :basketItemID)
																	if +SQLCODE=0 set initialCost=tmp1,unitCost=tmp2
																}

																set currencyCode=##class(eCom.objCurrency).getCode(##class(setup.objEvent).getBaseCurrency(xEventID))
															}
														</script>
														<tr>
															<td class="black10px" align="right" height="15" width="280" title="The startup cost, e.g. venue booking fee">
																<tx>Initial cost</tx>:&nbsp;&nbsp;
															</td>
															<td width=100 class="black10px" title="The startup cost, e.g. venue booking fee">
																<input type="text" name="initialCost" value="#(initialCost)#" class="black10px" style="width: 50px;">&nbsp;#(currencyCode)#
															</td>
															<td height="25" width="10">&nbsp;</td>
															<td class="black10px" width=75  title="Cost per sold item, e.g. meal cost">
																<tx>Unit cost</tx>:
															</td>
															<td width=100 class="black10px" title="Cost per sold item, e.g. meal cost">
																<input type="text" name="unitCost" value="#(unitCost)#"  class="black10px" style="width: 50px;">&nbsp;#(currencyCode)#
															</td>
														</tr>
													</table>
												</td>
												<td></td>
											</tr>
										</systemType:if>
										</div>
									</td>
								</tr>
								</table>
								<systemType:if module="External Item Codes">
									<script language="cache" runat="server">
										set extItemCodeDesc=##class(setup.objSetting).getParameter("basketItem","extItemCode")
										set extItemCode2Desc=##class(setup.objSetting).getParameter("basketItem","extItemCode2")
										set show=($l(extItemCodeDesc))!($l(extItemCode2Desc))
									</script>
									<csp:if condition=(show)>
										<script language="cache" runat="server">
											set (extItemCode,extItemCode2,basketItemID)=""
											&SQL(SELECT basketItemID INTO :basketItemID FROM cod.objTicket WHERE ID=:ticketID)
											if +SQLCODE=0 {
												&SQL(SELECT extItemCode,extItemCode2 INTO :tmp,:tmp2
													FROM eCom.objBasketItem
													WHERE ID=:basketItemID
												)
												if +SQLCODE=0 set extItemCode=tmp,extItemCode2=tmp2
											}
										</script>
										<img src="../../media/images/English/Default/backend/line.gif" width="600" height="21">
										<table border="0" cellspacing="0" cellpadding="0">
											<csp:if condition=($l(extItemCodeDesc))>
												<tr>
													<td class="black10px" align="right" height="15" width="315">#(extItemCodeDesc)#</td>
													<td height="25" width="10">&nbsp;</td>
			                                   		<td class="black10px" height="30" width="100">
														<input type="text" name="txtExtItemCode" value="#(extItemCode)#" size="30" width="20" class="black10px">
													</td>
												</tr>
											</csp:if>
											<csp:if condition=($l(extItemCode2Desc))>
												<tr>
													<td class="black10px" align="right" height="15" width="315">#(extItemCode2Desc)#</td>
													<td height="25" width="10">&nbsp;</td>
			                                   		<td class="black10px" height="30" width="100">
														<input type="text" name="txtExtItemCode2" value="#(extItemCode2)#" size="30" width="20" class="black10px">
													</td>
												</tr>
											</csp:if>
										</table>
									</csp:if>
								</systemType:if>
							</csp:if>
						</systemType:if>
					</systemType:if>
					<table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-top:8px;">
						<tr>
							<td width="20">&nbsp;</td>
							<td class="black10px" align="right" height="15" width="177" valign="top"><tx>Help text</tx>:&nbsp;&nbsp;</td>
							<td class="black10px" valign="top">
								<textarea name="txtHelpText" style="width: 298px; height: 75px;" class="black10px">#(helpText)#</textarea>
							</td>
						</tr>
					</table>
					<script language="cache" runat="server">
						set show=1
						if $G(xEventID) {
							if 'eventConfiguration.areAttendeeCategoriesAllowed() {
								set show=0
							}
						}
					</script>
					<csp:if condition=(show)>
                        <img src="../../media/images/English/Default/backend/line.gif" width="600" height="21">
							<systemType:if module="Attendee Categories">
								<script language="cache" runat="server">
									set eventID=$G(%session.Data("eventsforce","backend","xEventID"))
									set langID=$G(%session.Data("eventsforce","backend","xLangID"))
								</script>
								<csp:if condition=(eventID)>
								<table width="100%" border="0" cellspacing="0" cellpadding="0">
								<script language="cache" runat="server">
									// get all the active categories for this event
									set rs=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
									do rs.Execute(xEventID)
								</script>
									<csp:while counter="x" condition="rs.Next()">
										<csp:if condition=(x=1)>
											<tr>
												<td width="50">&nbsp;</td>
												<td class="black10px" colspan="4" align="left" nowrap>&nbsp;&nbsp;<tx>Restrict access to these attendee categories</tx>:</td>
												<td width="50">&nbsp;</td>
											</tr>
										</csp:if>
										<csp:if condition=(x#2'=0)>
											<tr>
												<td width="50">&nbsp;</td>
										</csp:if>
										<script language="cache" runat="server">
											set eventCategoryID=rs.Data("objEventCategory")
											set CHECKED=""
											if ##class(links.lnkEventCategoryData).isSet(eventCategoryID,dataID) set CHECKED="CHECKED"
										</script>
										<td align="right" class="black10px">#(##class(shared.stringFunctions).sentenceCase(rs.Data("description")))#</td>
										<td align="left"><input type="checkbox" name="chkEventCategory_#(eventCategoryID)#" #(CHECKED)#></td>
										<csp:if condition=(x#2=0)>
											<td width="50">&nbsp;</td>
											</tr>
										</csp:if>
									</csp:while>
									<csp:if condition=(x#2'=0)>
										<td align="right" class="black10px">&nbsp;</td>
										<td align="left">&nbsp;</td>
									</tr>
									</csp:if>
								</table>
								</csp:if>
							</systemType:if>
                    	</csp:if>
				   </td>
           		</tr>
				<script language="cache" runat="server">
					if (##class(sc.xModules.objPage).isAbstractDocumentPage(pageID)) && (##class(sc.objComponent).getComponentName(parent) = "Document List") {
						set show=1
					} else {
						set show=0
					}
				</script>
				<csp:if condition="show">
					<tr>
	           			<td >
							<table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-top: 10px;">
								<tr>
									<td class="black10px" align="right" width="192">
										Abstracts:&nbsp;&nbsp;
									</td>
				           			<td width="25">
				           				<script language="cache" runat="server">
				           					if ##class(cod.lnkItemNameEvent).getShowToReviewers(itemNameID,xEventID) = 1 {
					           					set isChecked="CHECKED"
				           					} else {
					           					set isChecked=""	
				           					}
				           				</script>
				           				<input type="checkbox" name="chkAbsShowToReviewers" value=1 #(isChecked)#>
				           			</td>
				           			<td class="black10px">
				           				Show to reviewers
				           			</td>
				           		</tr>
							</table>
						</td>
					</tr>
				</csp:if>
			<input type="Hidden" name="gotoPage" value="#(gotoPage)#">
			<input type="hidden" id="txtDeletedAlternatives" name="txtDeletedAlternatives" value="">
			<input type="hidden" name="txtAlternatives" value="">
			<input type="hidden" name="templateURL" value='#(templateURL)#'>
			<input type="hidden" name="addToTop" value='#(addToTop)#'>
			<input type="hidden" name="parent" value='#(parent)#'>
			<input type="hidden" name="itemNameID" value='#(..encodeForHTMLAttribute(itemNameID))#'>
			<script language="cache" runat="server">
				//Put the itemNameID in session. Otherwise alternative import fails.
				set %session.Data("itemNameID")=itemNameID
			</script>
			<input type="hidden" name="dataID" value='#(..encodeForHTMLAttribute(dataID))#'>
			<input type="hidden" name="pageID" value="#(..encodeForHTMLAttribute(pageID))#">
			<input type="hidden" name="additional" value='#(additional)#'>
			<input type="hidden" name="eventHotelID" value='#(eventHotelID)#'>
			<input type="hidden" name="quantityItem" value='#(quantityItem)#'>
			<input type="hidden" name="codGroup" value='#(codGroup)#'>
			
			<input type="hidden" name="gotoCodQuestionCSV" id="gotoCodQuestionCSV" value="0">
			<input type="Hidden" name="updateSameAs" value='nada'>
			<input type="Hidden" name="togglePriceByAttendeeCategory" value='0'>
                                 </td>
                             </tr>
                             <tr><td style="height: 16px;"></td></tr>
                         </table>
                     </td>
                     <td class="gen1_panel_border" width="1"><img src="../../media/images/english/default/backend/buffer.gif" width="1" height="1"></td>
                 </tr>
                 <tr class="gen1_panel_border">
                     <td colspan="3" height="1"><img src="../../media/images/english/default/backend/buffer.gif" width="1" height="1"></td>
                 </tr>
             </table>
         </td>
     </tr>
 </table>

   </form>


<script language='javascript'>
	attendeeCategories=0
</script>
<systemType:if module="Ticketing">
	<systemType:if module="Attendee Categories">
		<csp:if condition=(quantityItem)>
			<script language='javascript'>
				attendeeCategories=1
			</script>
		</csp:if>
	</systemType:if>
</systemType:if>

<script language='javascript'>
var ef = ef|| {};
ef.codQuestionDetails = ef.codQuestionDetails || {};
ef.codQuestionDetails.anyInvalidCharactersInName = function(inName) {
	//check name for any not allowed characters. See #127633311 for details.
	if((inName.match(/[^A-Za-z0-9_\s]/)) && (!(inName.match(/^.*XED:.*$/)))){
		return true;
	}
	return false;
};
ef.codQuestionDetails.checkNumericValues = function() {
	var fieldWidth = document.forms[0].txtFieldWidth.value;
	var strLength = fieldWidth.length;
	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = fieldWidth.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || fieldWidth.indexOf(' ') >= 0 ) {
				alert ('The changes can\'t be saved because "Field width" must be a number.');
				document.forms[0].txtFieldWidth.style.background = "yellow";
				return false;
			}
		}
 	}
	
	var fieldHeight = document.forms[0].txtFieldHeight.value;
	var strLength = fieldHeight.length;
	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = fieldHeight.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || fieldHeight.indexOf(' ') >= 0 ) {
				alert ('The changes can\'t be saved because "Height" must be a number.');
				document.forms[0].txtFieldHeight.style.background = "yellow";
				return false;
			}
		}
 	}
	
	if (typeof document.forms[0].maxCharacters !== 'undefined') {
		var maxCharacters = document.forms[0].maxCharacters.value;
		var strLength = maxCharacters.length;
		if (strLength >0) 	{
			for (i=0;i<strLength; i++)		{
				candidateCharCode = maxCharacters.charCodeAt(i);
				if ( candidateCharCode < 48 || candidateCharCode > 57 || maxCharacters.indexOf(' ') >= 0 ) {
					alert ('The changes can\'t be saved because "Max length of answer" must be a number.');
					document.forms[0].maxCharacters.style.background = "yellow";
					return false;
				}
			}
	 	}
	}
	
	var qMin = document.forms[0].txtqMin.value;
	var strLength = qMin.length;
	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = qMin.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || qMin.indexOf(' ') >= 0 ) {
				alert ('The changes can\'t be saved because "Optional booking levels - minimum" must be a number.');
				document.forms[0].txtqMin.style.background = "yellow";
				return false;
			}
		}
 	}
	
	var qMax = document.forms[0].txtqMax.value;
	var strLength = qMax.length;
	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = qMax.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || qMax.indexOf(' ') >= 0 ) {
				alert ('The changes can\'t be saved because "Optional booking levels - maximum" must be a number.');
				document.forms[0].txtqMax.style.background = "yellow";
				return false;
			}
		}
 	}
	
	var qCapacity = document.forms[0].txtqCapacity.value;
	var strLength = qCapacity.length;
 	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = qCapacity.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || qCapacity.indexOf(' ') >= 0 ) {
				alert ('The changes can\'t be saved because "Capacity" must be a number.');
				document.forms[0].txtqCapacity.style.background = "yellow";
				return false;
			}
		}
 	}
	
	var qNotificationLevel = document.forms[0].txtqNotificationLevel.value;
	if(isNaN(qNotificationLevel) || qNotificationLevel.indexOf(' ') >= 0) {
		alert('The changes can\'t be saved because "Level" must be a number.');
		document.forms[0].txtqNotificationLevel.style.background = "yellow";
		return false;
	}
	
	var strLength = qNotificationLevel.length;
	if ((strLength > 0) && ((parseFloat(qNotificationLevel)>100.0) || (parseFloat(qNotificationLevel) <0.0))) {
		alert ('The changes can\'t be saved because "Level" must be a number between 0 and 100.');
		document.forms[0].txtqNotificationLevel.style.background = "yellow";
		return false;
	}
	
	return true;
};

function checkName() {
	var dataID = document.forms[0].dataID.value;
	var itemNameID = document.forms[0].itemNameID.value;
	var name= document.forms[0].txtDescription.value;
	
	// conflate all consecutive white spaces (prevents database/tag inconsistency 
	if((itemNameID == 'CREATE')&&(name.match(/ {2,}/))) {
		document.forms[0].txtDescription.value = name.replace(/ {2,}/g,' ');	
		name = document.forms[0].txtDescription.value;
	}

	if (name=='') {
		alert('#(..out("Please enter a Database Name for this Question Prompt"))#');
		return false;
	}

	// Stop people from entering special characters for databasename.
	if((itemNameID == 'CREATE') && (ef.codQuestionDetails.anyInvalidCharactersInName(name))){
			alert('Only letters, numbers, underscores and spaces are allowed for the database name. Please try again.');
			document.forms[0].txtDescription.focus();
			return false;
	}

	if ((dataID == 'NEW') && (itemNameID == 'CREATE')) {
		var found=0;
		for (var i = 0 ; i<document.forms[0].selCODitem.options.length; i++) {
			if (document.forms[0].selCODitem.options[i].text.toUpperCase() == name.toUpperCase()) {
				alert('The question you are trying to add is already in the database. Please re-use the existing one.');
				return false;
			}
		}
	}
	return true;
}

function popup(type) {
	var theURL="#(..Link("codQuestionHTML.csp?dataID="_dataID))#"

	// calculate where to open popup window
	var width = 750;
	var height = 450;
	var myLeft = (screen.width) ? (screen.width-width)/2 : 0;
	var myTop = (screen.height) ? (screen.height-height)/2 : 0;
	var left = myLeft;
	var top = myTop;

	myWindow = window.open(theURL,"LekOchLars",'location=no,screenX=' + left + ',screenY=' + top + ',top=' + top + ',left=' + left + ',directories=no,status=no,menubar=no,scrollbars=no,resizable=yes,hotkeys=no,toolbar=no,width=750,height=450');
	myWindow.focus();
}


function selectAll() {
	// build a string of all just before save to make sure all alts are submitted
	var rowCount = document.forms[0].selAlternative.options.length;
	var tmp = '';
	for (var i = 0 ; i<rowCount; i++) {
		tmpAlt = document.forms[0].selAlternative.options[i].value;
		tmpAltID = tmpAlt.split('|')[0];
		tmpAltCode = tmpAlt.split('|')[1];
		tmpValue = document.forms[0].selAlternative.options[i].text;
		
		if (tmpAltCode != '') {
			// remove the code text before saving it
			codeText = ' (#(..out("Code"))#: ' + tmpAltCode + ')';
			tmpValue = tmpValue.split(codeText)[0];
		}
		
		tmp = tmp + tmpAltID + "~" + tmpValue + "~" + tmpAltCode + "|"
	}
	document.forms[0].txtAlternatives.value=tmp;
}


function addAlternative(text) {
	// add alternative
	if (document.forms[0].selAlternative.disabled == false ) {
		var text = prompt('Please enter the new alternative:','');
		if (text != null ) {
			//get rid of all the extra spaces and consequtive multispaces.
			text = text.replace(/^\s*|\s*$/g,'');
			text = text.replace(/\s+/g,' ');

			if ((text.replace(/\s/ig,"")!="")&&(text.toUpperCase()!="&NBSP;")) {
				if (text.indexOf('|')>0) {
					alert(#(..QuoteJS(..out("Your alternative cannot contain a '|'")))#);
					return;
				}
				if (text.indexOf('~')>0) {
					alert(#(..QuoteJS(..out("Your alternative cannot contain a '~'")))#);
					return;
				}
				var itemCount = document.forms[0].selAlternative.options.length;
				document.forms[0].selAlternative.options[itemCount] = new Option(text,'NEW|')
				if (typeof document.forms[0].defaultValueAlt != "undefined") {
					// Add alternative to Pre-select list
					var itemCount = document.forms[0].defaultValueAlt.options.length;
					document.forms[0].defaultValueAlt.options[itemCount] = new Option(text,'NEW|')
				}
			} else {
				alert('#(..out("Invalid Alternative name. Operation cancelled. Please try again!"))#');
			}
		}
	}
}

function deleteAlternative() {
	// can handle multiple deletes
	var rowsToDelete = new Array();
	var counter = 0;
	var error = 0
	for (var j = 0 ; j < document.forms[0].selAlternative.length; j++ ) {
		if (document.forms[0].selAlternative.options[j].selected == true ) {
			counter = counter + 1;
			rowsToDelete[counter] = j;
			altID = document.forms[0].selAlternative.options[j].value.split('|')[0];
			depends='document.forms[0].hasDependencies_' + altID
			if (eval('typeof ' + depends) != "undefined") {
				error = 1;
				errorDesc = 'option cannot be deleted as it has a ' + eval(depends + '.value')
			}
		}
	}
	
	if (error == 1) {
		alert(errorDesc);
	} else {
		for (var j = counter ; j>0 ; j=j-1) {
			var tmp=rowsToDelete[j];
			deleteOne(tmp);
		}
		if (typeof document.forms[0].defaultValueAlt != "undefined") {
			// Copy the alternatives to the default value
			selInd = document.forms[0].defaultValueAlt.selectedIndex;
			selValue = document.forms[0].defaultValueAlt.options[selInd].text;
			document.forms[0].defaultValueAlt.selectedIndex=0;
			for (var i = 0 ; i<document.forms[0].selAlternative.length; i++) {
				alt = document.forms[0].selAlternative.options[i].text;
				document.forms[0].defaultValueAlt.options[i+1].value = alt;
				document.forms[0].defaultValueAlt.options[i+1].text = alt;
				if (alt == selValue) {
					document.forms[0].defaultValueAlt.selectedIndex = i+1;
				}
			}
			// then truncate the options where it was clicked
			document.forms[0].defaultValueAlt.length = document.forms[0].selAlternative.length + 1;
		}
	}
}

function deleteOne(selRow) {
	if (selRow != -1) {

		// store the fact that we have deleted a real alt
		var tmpValue = document.forms[0].selAlternative.options[selRow].value;
		if (tmpValue != 'NEW') {
			tmpValue = tmpValue.split("|")[0];
			if ($.isNumeric(tmpValue)) {
				document.forms[0].txtDeletedAlternatives.value = document.forms[0].txtDeletedAlternatives.value + tmpValue + '|';
			}
		}

		// remove item from the array
		var tmpArrID = new Array();
		var tmpArrText = new Array();

		// first save the lower part
		var itemCount =0;
		for (var i = selRow+1 ; i<document.forms[0].selAlternative.length; i++) {
			itemCount++;
			tmpArrID[itemCount] = document.forms[0].selAlternative.options[i].value;
			tmpArrText[itemCount] = document.forms[0].selAlternative.options[i].text;
		}

		// then truncate the options where it was clicked
		document.forms[0].selAlternative.length=selRow;

		// and then copy back the lower part
		for (var i = 1 ; i<itemCount+1; i++) {
			document.forms[0].selAlternative.length=document.forms[0].selAlternative.length+1;
			var lastItem =document.forms[0].selAlternative.length-1;
			document.forms[0].selAlternative.options[lastItem].value = tmpArrID[i];
			document.forms[0].selAlternative.options[lastItem].text = tmpArrText[i];
		}
	}
}

function moveUp(selRow) {
	if (selRow >0 ) {
		var tmpValue = 	document.forms[0].selAlternative.options[selRow-1].value;
		var tmpName = 	document.forms[0].selAlternative.options[selRow-1].text;
		document.forms[0].selAlternative.options[selRow-1].value = document.forms[0].selAlternative.options[selRow].value
		document.forms[0].selAlternative.options[selRow-1].text = document.forms[0].selAlternative.options[selRow].text
		document.forms[0].selAlternative.options[selRow].value = tmpValue
		document.forms[0].selAlternative.options[selRow].text = tmpName
		document.forms[0].selAlternative.selectedIndex=selRow-1
	}
}

function moveDown(selRow) {
	var rowCount = document.forms[0].selAlternative.options.length;
	if (selRow < (rowCount-1) ) {
		var tmpValue = 	document.forms[0].selAlternative.options[selRow+1].value;
		var tmpName = 	document.forms[0].selAlternative.options[selRow+1].text;
		document.forms[0].selAlternative.options[selRow+1].value = document.forms[0].selAlternative.options[selRow].value
		document.forms[0].selAlternative.options[selRow+1].text = document.forms[0].selAlternative.options[selRow].text
		document.forms[0].selAlternative.options[selRow].value = tmpValue
		document.forms[0].selAlternative.options[selRow].text = tmpName
		document.forms[0].selAlternative.selectedIndex=selRow+1
	}

}

function editCode() {
	if (document.forms[0].selAlternative.disabled == false ) {
		if (document.forms[0].selAlternative.selectedIndex != -1 ) {
			
			altID = document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].value
			altCode = altID.split('|')[1]
			altID = altID.split('|')[0]
			
			var altText = 	document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].text;
			var codeText = '';
			if (altCode != '') {
				// remove the code text before they edit it
				codeText = ' (#(..out("Code"))#: ' + altCode + ')';
				altText = altText.split(codeText)[0];
			}
			var text = prompt('#(..out("Please edit the code for "))#' + altText,altCode);
	
			//get rid of all the extra spaces and consequtive multispaces.
			text = text.replace(/^\s*|\s*$/g,'');  //leading and trailing spaces..delete them all.
			text = text.replace(/\s+/g,' '); //multiple consecutive space in the value. Replace the group with one space.
			
			if (text != '') {
				document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].text = altText + ' (#(..out("Code"))#: ' + text + ')';
				document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].value = altID + '|' + text;
			} else {
				document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].text = altText;
				document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].value = altID + '|';
			}
		} else {
			alert('#(..out("You must select one of the alternatives before editing the code"))#')
		}
	}
}

function editAlt() {
	if (document.forms[0].selAlternative.selectedIndex != -1 ) {
		var tmpValue = 	document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].value.split('|')[0];
		if (parseInt(tmpValue)>0) {
			document.forms[0].gotoPage.value="codAlternativeDetails.csp?dataID=#(..encodeForJavaScript(..encodeForURL(dataID)))#&itemAlternativeID=" + encodeURIComponent(tmpValue) + "&returnURL=#(..encodeForJavaScript(..encodeForURL(gotoPage)))#";
			document.forms[0].submit();
		} else {
			alert('#(..out("This alternative is not saved yet. Please save all alternatives before modifying prices"))#');

		}
	} else {
		alert('#(..out("You must select one of the alternatives before selecting Advanced mode"))#')
	}
}


function move (direction) {
	var selRow = document.forms[0].selAlternative.selectedIndex
	if (direction == 'up') {
		moveUp(selRow)
	}
	if (direction == 'top') {
		for (var i = selRow ; i>0 ; i=i-1) {
			moveUp(i);
		}
	}
	if (direction == 'bottom') {
		var rowCount = document.forms[0].selAlternative.options.length;
		for (var i = selRow + 1 ; i<rowCount ; i=i+1) {
			moveUp(i);
		}
	}
	if (direction == 'down') {
	 moveDown(selRow);
	}
	if (typeof document.forms[0].defaultValueAlt != "undefined") {
		// Copy the alternatives to the default value dropdown
		selInd = document.forms[0].defaultValueAlt.selectedIndex;
		selValue = document.forms[0].defaultValueAlt.options[selInd].text;
		document.forms[0].defaultValueAlt.selectedIndex=0;
		for (var i = 0 ; i<document.forms[0].selAlternative.length; i++) {
			alt = document.forms[0].selAlternative.options[i].text;
			document.forms[0].defaultValueAlt.options[i+1].value = alt;
			document.forms[0].defaultValueAlt.options[i+1].text = alt;
			if (alt == selValue) {
				document.forms[0].defaultValueAlt.selectedIndex = i+1;
			}
		}
		// then truncate the options where it was clicked
		document.forms[0].defaultValueAlt.length = document.forms[0].selAlternative.length + 1;
	}
}

function disableMe(formElem){
	// generic function to check for existence of form element and disable it
	if (typeof document.myform[formElem] != "undefined") {
		// it exists, but is it a set of radio buttons
		if (typeof document.myform[formElem].length != "undefined") {
			// either radio or select
			if ((typeof document.myform[formElem].type != "undefined")&&(document.myform[formElem].type.indexOf('select')!=-1)) {
				// select
				document.myform[formElem].disabled=true;
				document.myform[formElem].style.background="#EEEEEE";
			} else {
				// radio - iterate over the whole array or just one?
				if (arguments.length > 1) { // if specific, the index will be passed as a second argument to the function
					document.myform[formElem][arguments[1]].disabled=true;
				} else {
					for (var i=0;i<document.myform[formElem].length;i++) {
						document.myform[formElem][i].disabled=true;
					}
				}
			}
		} else {
			document.myform[formElem].disabled=true;
			// is it a text field, textarea or password?
			if ((typeof document.myform[formElem].type != "undefined")&&((document.myform[formElem].type.indexOf('text')!=-1)||(document.myform[formElem].type.indexOf('password')!=-1))) {
				document.myform[formElem].style.background="#EEEEEE";
			}
		}

	}
}

ef.codQuestionDetails.toggleDefaultField =  function(mode) {
	if (mode=='none') {
		$('#defaultValueText').show();
		$('#defaultValueText').attr("disabled", "disabled");
		$('#defaultValueAlt').hide();	
	
	} else if (mode=='text')	{
		$('#chkCopyFromBooker').removeAttr("disabled"); 
		$('#defaultValueText').show();
		if ($('#chkCopyFromBooker').is(':checked') == true) {
			$('#defaultValueText').attr("disabled", "disabled"); 
		} else {
			$('#defaultValueText').removeAttr("disabled");
		}
		$('#defaultValueAlt').hide();	
		
	} else if (mode=='alternative') {
		$('#chkCopyFromBooker').removeAttr("disabled"); 
		$('#defaultValueText').hide();
		$('#defaultValueAlt').show();
		if ($('#chkCopyFromBooker').is(':checked') == true) {
			$('#defaultValueAlt').attr("disabled", "disabled"); 
		} else {
			$('#defaultValueAlt').removeAttr("disabled");
		}
	}	
}

ef.codQuestionDetails.updateDefaultField =  function(checkboxValue) {
	if (checkboxValue==true) {
		ef.codQuestionDetails.toggleDefaultField('none');
	} else {
		var fieldType = $('#selDataType').val()
		disabling(fieldType); 
	}
}
function enableMe(formElem){
	// generic function to check for existence of form element and enable it
	if (typeof document.myform[formElem] != "undefined") {
		// it exists, but is it a set of radio buttons
		if (typeof document.myform[formElem].length != "undefined") {
			// either radio or select
			if ((typeof document.myform[formElem].type != "undefined")&&(document.myform[formElem].type.indexOf('select')!=-1)) {
				// select
				document.myform[formElem].disabled=false;
				document.myform[formElem].style.background="#FFFFFF";
			} else {
				// radio - iterate over the whole array or just one?
				if (arguments.length > 1) { // if specific, the index will be passed as a second argument to the function
					document.myform[formElem][arguments[1]].disabled=false;
				} else {
					for (var i=0;i<document.myform[formElem].length;i++) {
						document.myform[formElem][i].disabled=false;
					}
				}
			}
		} else {
			document.myform[formElem].disabled=false;
			// is it a text field, textarea or password?
			if ((typeof document.myform[formElem].type != "undefined")&&((document.myform[formElem].type.indexOf('text')!=-1)||(document.myform[formElem].type.indexOf('password')!=-1))) {
				document.myform[formElem].style.background="#FFFFFF";
			}
		}

	}
}

function applyOpacityStyle(elem) {
	// generic function to apply opacity filter to a passed in DOM element
	var myElem=document.getElementById(elem)

	if (myElem) {
		myElem.style.opacity="0.35";
		myElem.style.filter="alpha(opacity=35)";
	}
}

function removeOpacityStyle(elem) {
	// generic function to apply opacity filter to a passed in DOM element
	var myElem=document.getElementById(elem)

	if (myElem) {
		myElem.style.opacity="1";
		myElem.style.filter="alpha(opacity=100)";
	}
}
function hideDateRangeAvailability() {
    $('#dateRangeContainerRow').css('visibility','collapse');
    $('#afterDateRangeContainerRow').css('visibility','collapse');
    if ('#(dataID)#' == 'NEW') {
		$('#radQuestionAvailabilityAllEvents').attr('disabled',false);
	}
   }
function showDateRangeAvailability() {
   $('#dateRangeContainerRow').css('visibility','visible');	
   $('#afterDateRangeContainerRow').css('visibility','visible');
   $('#radQuestionAvailabilitySingleEvent').attr('checked',true);
   updateAnswerSpanningRadios();
   $('#radQuestionAvailabilityAllEvents').attr('disabled',true);
}

$('#chkConcealed').click(function() {
	if($('#radQuestionAvailabilitySingleEvent').is(':checked')) { 
		$('#radQuestionAvailabilityAllEvents').attr('checked',true);
		$('#radQuestionAvailabilitySingleEvent').attr('disabled',true);
	} else {
		$('#radQuestionAvailabilitySingleEvent').attr('disabled',false);	
	}
});

$('input[name=radQuestionAvailability]').click(function() {
	updateAnswerSpanningRadios();
});

function updateAnswerSpanningRadios() {
   if($('#radQuestionAvailabilitySingleEvent').is(':checked')) { 
   		$("#radAnswerAppliesToSingleEvent").attr('checked',true);
   		$('#radAnswerAppliesToAllEvents').attr('disabled',true);
   } else {
   		if (#(+canChangeAnswerAppliesTo)# == 1) {
   			$('#radAnswerAppliesToAllEvents').attr('disabled',false);
   		}
   }
}

$(document).ready(function () {
	$('.efDateRangePicker').each(function () {
		$(this).kendoDatePicker({
			format: getKendoDateFormat($(this).attr('inputDateFormat'))
		});
		var picker=$(this).data('kendoDatePicker');

		if ($(this).hasClass('efDateRangeStart')) {
			var endEle=$('#'+$(this).attr('efDateRangeEndID'));
			picker.bind('change', function() {
				var temp=new Date(picker.value());
				if (temp.toString()!="Invalid Date") {
					tempMin=new Date(temp.getFullYear(),temp.getMonth(),temp.getDate()+1);
					tempMax=new Date(temp.getFullYear(),temp.getMonth(),temp.getDate()+#(##class(cod.objItemName).#maxDateRangeLength-1)#);
					endElePicker=endEle.data('kendoDatePicker');
					endElePicker.min(tempMin);
					endElePicker.max(tempMax);
				}
			});
		}
	});
});


function isValidRangeAvailability() {
	var maxDateRangeLength=#(##class(cod.objItemName).#maxDateRangeLength)#;
	type=$('#selDataType option:selected').val();
	if (type == "dateRange") {
		var dateRangeStart = new Date($('#dateRangeStart').data('kendoDatePicker').value());
		var dateRangeEnd = new Date($('#dateRangeEnd').data('kendoDatePicker').value());
		if ($('#dateRangeStart').data('kendoDatePicker').value()==null) {
			alert('#(..out("Date range start date is not valid"))#')
			return 0;
		} else if ($('#dateRangeEnd').data('kendoDatePicker').value()==null)
		{
			alert('#(..out("Date range end date is not valid"))#')
			return 0;
		} else if ((dateRangeEnd-dateRangeStart)<0) {
			alert('#(..out("Date range end date must be after the start date"))#')
			return 0;
		} else {
			differenceInDays = Math.floor((dateRangeEnd-dateRangeStart)/(1000*3600*24))+1;
			if ((differenceInDays<1) || (differenceInDays>maxDateRangeLength)) {
				alert('#(..out("Date range must be between 1 and {{{VAR01}}} days.",,##class(cod.objItemName).#maxDateRangeLength))#')
				return 0;
			}
			return 1;	
		}
		
	} else {
		return 1;
	}
}

function disabling(type) {
	var grey = "#EEEEEE"
	if ((type == 'text' ) 
		|| (type =='password') 
		|| (type =='date') 
		|| (type =='dateRange') 
		|| (type =='time') 
		|| (type =='emailAddress') 
		|| (type =='multiEmailAddress') 
		|| (type =='phoneNumber') 
		|| (type =='integer') 
		|| (type =='floatingPointNumber') 
		|| (type =='webAddress')
		) {
		disableMe('txtFieldHeight');
		disableMe('selAlternative');
		disableMe('chkSearchAsYouType');
		enableMe('chkMandatory');
		enableMe('chkConcealed');
		disableMe('multiCheckboxMin');
		disableMe('multiCheckboxMax');
		hideDateRangeAvailability();
		enableMe('txtFieldWidth');
		applyOpacityStyle('butDelete');
		applyOpacityStyle('butEdit');
		applyOpacityStyle('butCode');
		applyOpacityStyle('butAddAlt');
		applyOpacityStyle('butImport');
		if (#(showGuest)# == 1) {
			enableMe('radDelegateOrGuest',1);
		}
		disableMe('radLayout');
		var defaultType='none';
		if (type=='dateRange') {
			showDateRangeAvailability();
		}
		if ((type == 'text' ) || (type =='emailAddress') || (type =='multiEmailAddress')) {
			defaultType='text';
		}
		ef.codQuestionDetails.toggleDefaultField(defaultType);
	}
	if (type == 'dropdown' ) {
		enableMe('txtFieldHeight');
		enableMe('selAlternative');
		enableMe('chkSearchAsYouType');
		enableMe('chkMandatory');
		disableMe('chkConcealed');
		disableMe('multiCheckboxMin');
		disableMe('multiCheckboxMax');
		hideDateRangeAvailability();		
		enableMe('txtFieldWidth');
		removeOpacityStyle('butDelete');
		if ('#(dataID)#' != 'NEW') {
			removeOpacityStyle("butEdit");
			removeOpacityStyle("butCode");
			removeOpacityStyle('butImport');
		} else {
			applyOpacityStyle("butEdit");
			applyOpacityStyle("butCode");
			applyOpacityStyle('butImport');
		}
		removeOpacityStyle('butAddAlt');
		
		if (#(showGuest)# == 1) {
			enableMe('radDelegateOrGuest',1);
		}
		disableMe('radLayout');
		ef.codQuestionDetails.toggleDefaultField('alternative');
	}
	if (type == 'textarea' ) {
		enableMe('txtFieldHeight');
		disableMe('selAlternative');
		disableMe('chkSearchAsYouType');
		enableMe('txtFieldWidth');
		enableMe('chkMandatory');
		enableMe('chkConcealed');
		disableMe('multiCheckboxMin');
		disableMe('multiCheckboxMax');

		applyOpacityStyle('butDelete');
		applyOpacityStyle("butEdit")
		applyOpacityStyle("butCode")

		applyOpacityStyle('butAddAlt');
		applyOpacityStyle('butImport');
		if (#(showGuest)# == 1) {
			enableMe('radDelegateOrGuest',1);
		}
		disableMe('radLayout');
		ef.codQuestionDetails.toggleDefaultField('none');
		hideDateRangeAvailability();		
	}
	if ((type == 'radiobutton' ) || (type == '1-5 scale')) {
		disableMe('txtFieldHeight');
		enableMe('selAlternative');
		disableMe('chkSearchAsYouType');
		disableMe('txtFieldWidth');
		enableMe('chkMandatory');
		disableMe('chkConcealed');
		disableMe('multiCheckboxMin');
		disableMe('multiCheckboxMax');

		removeOpacityStyle('butDelete');

		if ('#(dataID)#' != 'NEW') {
			removeOpacityStyle('butEdit');
			removeOpacityStyle('butCode');
			removeOpacityStyle('butImport');
		} else {
			applyOpacityStyle('butEdit');
			applyOpacityStyle('butCode');
			applyOpacityStyle('butImport');
		}
		removeOpacityStyle('butAddAlt');
		
		if (#(showGuest)# == 1) {
			enableMe('radDelegateOrGuest',1);
		}
		enableMe('radLayout');
		ef.codQuestionDetails.toggleDefaultField('alternative');
		hideDateRangeAvailability();		
	}
	if (type == 'checkbox' ) {
		disableMe('txtFieldHeight');
		disableMe('selAlternative');
		disableMe('chkSearchAsYouType');
		disableMe('txtFieldWidth');
		enableMe('chkMandatory');
		disableMe('multiCheckboxMin');
		disableMe('multiCheckboxMax');
		disableMe('chkConcealed');

		applyOpacityStyle('butDelete');
		applyOpacityStyle('butEdit');
		applyOpacityStyle('butCode');
		applyOpacityStyle('butAddAlt');
		applyOpacityStyle('butImport');
		if (#(showGuest)# == 1) {
			enableMe('radDelegateOrGuest',1);
		}
		disableMe('radLayout');
		ef.codQuestionDetails.toggleDefaultField('none');
		hideDateRangeAvailability();		
	}
	if (type == 'multibox' ) {
		disableMe('txtFieldHeight');
		enableMe('selAlternative');
		disableMe('chkSearchAsYouType');
		disableMe('txtFieldWidth');
		disableMe('chkMandatory');
		enableMe('multiCheckboxMin');
		enableMe('multiCheckboxMax');
		disableMe('chkConcealed');

		removeOpacityStyle('butDelete');
		if ('#(dataID)#' != 'NEW') {
			removeOpacityStyle('butEdit');
			removeOpacityStyle('butCode');
		} else {
			applyOpacityStyle('butEdit');
			applyOpacityStyle('butCode');
		}
		removeOpacityStyle('butAddAlt');
		removeOpacityStyle('butImport');
		if (#(showGuest)# == 1) {
			if (typeof document.myform['radDelegateOrGuest'] != "undefined") {
				document.myform['radDelegateOrGuest'][0].checked=true;
				disableMe('radDelegateOrGuest',1)
			}
		}
		enableMe('radLayout');
		ef.codQuestionDetails.toggleDefaultField('none');
		hideDateRangeAvailability();	
	}
}

function disableOnLoad() {

	var grey = "#EEEEEE"
	if ('#(itemNameID)#' == 'NEW') {
		disableMe('chkMandatory');
		disableMe('chkCarryOver');
		if (#(showGuest)# == 1) {
			disableMe('radDelegateOrGuest');
		}
		disableMe('selType');
		disableMe('chkSearchAsYouType');
		disableMe('txtPrompt');
		disableMe('selDependsOnDataID');
		disableMe('selDependsOnCodAltID');
		disableMe('txtFieldHeight');
		disableMe('txtFieldWidth');
		disableMe('selAlternative');
		ef.codQuestionDetails.toggleDefaultField('none');
		hideDateRangeAvailability();

		if (attendeeCategories==1) {
			disableMe('chkPriceByAttendeeCategory');
		}

		disableMe('txtHelpText');

		removeOpacityStyle('butCreateNew');
		applyOpacityStyle('butDelete');
		applyOpacityStyle('butEdit');
		applyOpacityStyle('butCode');
		applyOpacityStyle('butAddAlt');
		applyOpacityStyle('butImport');

		disableMe('radLayout');
		if (typeof document.myform['lookup_phrase'] != "undefined") {
			document.myform['lookup_phrase'].focus();
		}
	} else if ('#(itemNameID)#' == 'CREATE') {
		disableMe('lookup_phrase');
		disableMe('selCODitem');
		hideDateRangeAvailability();		
		applyOpacityStyle('butCreateNew');
		enableMe('txtDescription');
		applyOpacityStyle('butEdit');
		applyOpacityStyle('butCode');
		if (attendeeCategories==1) {
			disableMe('chkPriceByAttendeeCategory');
		}
		if (typeof document.myform['txtDescription'] != "undefined") {
			document.myform['txtDescription'].value='#(%request.Get("typedText"))#';
			document.myform['txtDescription'].focus();
		}
		if (typeof document.myform['txtPrompt'] != "undefined") {
			document.myform['txtPrompt'].value='#(%request.Get("typedText"))#';
		}
	} else {
		hideDateRangeAvailability();			
		enableMe('chkMandatory');
		enableMe('chkCarryOver');
		if (#(showGuest)# == 1) {
			if (#(type'="multibox")# == 1) {
				enableMe('radDelegateOrGuest');
			}
		}
		if (#(type="dateRange")# == 1) {
			showDateRangeAvailability();
		}
				
		enableMe('selType');
		enableMe('chkSearchAsYouType');
		enableMe('txtPrompt');
		enableMe('selLayout');
		enableMe('selDependsOnDataID');
		enableMe('selDependsOnCodAltID');
		enableMe('txtFieldHeight');
		enableMe('txtFieldWidth');
		enableMe('selAlternative');
		enableMe('txtAddAlternative');
		enableMe('txtHelpText');

		removeOpacityStyle('butDelete');

		if ('#(dataID)#' != 'NEW') {
			removeOpacityStyle('butEdit');
			removeOpacityStyle('butCode');
		} else {
			applyOpacityStyle('butEdit');
			applyOpacityStyle('butCode');
		}
		removeOpacityStyle('butAddAlt');

		if ('#(%request.Get("loadItem"))#' == 'true') {
			if (attendeeCategories==1) {
				disableMe('chkPriceByAttendeeCategory');
			}
		}
		removeOpacityStyle('butImport');
	}
}

function updateAlts(codPromptID,itemAlternativeID) {
	document.forms[0].selDependsOnCodAltID.options.length=0;
	if (codPromptID != '') {
		// populate the alternatives list box from the javascript array

		for (var i = 0; i < (alts[codPromptID].length); i++) {
			var tmp = alts[codPromptID][i].split('|');
			document.forms[0].selDependsOnCodAltID.options[i] = new Option(tmp[1],tmp[0])
		}
	}
}
$(function() {
	$("#butImport").click( function() {
		if ($("#selAlternative").prop('disabled') == false ) {
			$("#gotoCodQuestionCSV").val("1");
			selectAll();
			document.forms[0].submit();
		}
	});
});

function toggleAttendeeCategory() {
	document.forms[0].togglePriceByAttendeeCategory.value='1';
	document.forms[0].submit();
}

function saveSameAs(categoryID) {
	document.forms[0].updateSameAs.value=categoryID;
	document.forms[0].submit();
}

</script>
<csp:if condition=(%request.Get("gotoCodQuestionCSV"))>
	<script language="cache" runat="server">
		set popupURL=..Link("codQuestionCSV.csp?additional="_..encodeForURL(additional)_"&dataID="_..encodeForURL(dataID))
		kill %session.Data("eventsforce","backend","popupURL")
	</script>
	<script language='javascript'>
	// Open a popup if we just pass thru the save after clicking a Import button
	$(function() {
		ef.admin.openPopupWindow("#(..encodeForJavaScript(popupURL))#");
	});
	</script>
</csp:if>
<systemType:if module="Ticketing">
<csp:if condition=(quantityItem)>
	<csp:if condition=(hasPricing)>
	<script language="cache" runat="server">
		// output javascript for enabled and disabling the price controls
		write !,"<SCR"_"IPT LANGUAGE='javasc"_"ript'>"
		for i=1:1 {
			if '$d(arrayPrices(i)) quit
			set eventCategoryID=$p(arrayPrices(i),"|",5)
			write !,"function updatePricing_",eventCategoryID,"() {"
			write !,"if (document.forms[0].radPriceType_",eventCategoryID,"[2].checked == true) {"
			write !,"	if (typeof document.forms[0].txtDirectPrice_",eventCategoryID," != 'undefined') {"
			write !," document.forms[0].txtDirectPrice_",eventCategoryID,".value='';"
			write !," }"
			write !,"	disableMe('txtDirectPrice_",eventCategoryID,"');"
			write !,"	disableMe('selCurrency_",eventCategoryID,"');"
			write !,"	enableMe('selPriceDescriptor_",eventCategoryID,"');"
			write !,"} else if (document.forms[0].radPriceType_",eventCategoryID,"[1].checked == true) {	"
			write !,"	enableMe('txtDirectPrice_",eventCategoryID,"');"
			write !,"	enableMe('selCurrency_",eventCategoryID,"');"
			write !,"	disableMe('selPriceDescriptor_",eventCategoryID,"');"
			write !,"} else if (document.forms[0].radPriceType_",eventCategoryID,"[0].checked == true) {	"
			write !,"	if (typeof document.forms[0].txtDirectPrice_",eventCategoryID," != 'undefined') {"
			write !," document.forms[0].txtDirectPrice_",eventCategoryID,".value='';"
			write !," }"
			write !,"	disableMe('txtDirectPrice_",eventCategoryID,"');"
			write !,"	disableMe('selCurrency_",eventCategoryID,"');"
			write !,"	disableMe('selPriceDescriptor_",eventCategoryID,"');"
			write !,"}	"
			write !,"}"
			write !,"updatePricing_",eventCategoryID,"();"
		}
		write !,"</scri"_"pt>"
	</script>
	</csp:if>
	<script language='javascript'>
		function updateAttendeeCategory()	{
			var createsAttendees=0
			// special as this field can be a hidden field
			if (document.forms[0].chkqCreatesAttendees.type=='checkbox')	{
				if (document.forms[0].chkqCreatesAttendees.checked == true) createsAttendees=1;
			} else {
				if (document.forms[0].chkqCreatesAttendees.value == 1) createsAttendees=1;
			}

			if (createsAttendees)	{
				enableMe('selqAttendeeCategory');
				ob=document.getElementById("divTicketingPricingCapacity");
				ob.style.display='none';
				ob=document.getElementById("divTicketingCreateAttendees");
				ob.style.display='block';
			} else {
				disableMe('selqAttendeeCategory');
				ob=document.getElementById("divTicketingPricingCapacity");
				ob.style.display='block';
				ob=document.getElementById("divTicketingCreateAttendees");
				ob.style.display='none';
			}
		}
		updateAttendeeCategory();
	</script>
</csp:if>
</systemType:if>

<script language='javascript'>

	// disable all field on load new
	disableOnLoad();

	// disable some field depending on type
	if ('#(itemNameID)#' != 'NEW') {
		disabling(document.forms[0].selType.options[document.forms[0].selType.selectedIndex].value);
	}

</script>
<csp:include page="../../backend/home/backendBottom.csp">
]]></CSP>


<CSP name="backEnd/proweb/codQuestionDetails2.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	do ##class(shared.pageMethods).createBackendVariables()
	if xEventID {
		set eventConfiguration=##class(setup.eventConfiguration).createForEventID(xEventID)	
	}

	set dataID=%request.Get("dataID")
	set itemNameID=%request.Get("itemNameID")
	set parent=%request.Get("parent")
	set xWorkLangID = $Get(%session.Data("eventsforce","backend","xWorkLangID"))
	set pageID=%request.Get("pageID")
	
	set isQuantityItem=%request.Get("quantityItem")
	set isAdditionalItem=%request.Get("additional")
	
	set errMsg = ""
	
	do ##class(sc.methods).updateBackendVariablesFromPageID(pageID)
	
	set baseCodQuestionDetailsURL="codQuestionDetails.csp?pageID="_..encodeForURL(pageID)_"&dataID="_..encodeForURL(dataID)_"&quantityItem="_..encodeForURL(isQuantityItem)_"&additional="_..encodeForURL(isAdditionalItem)
	set codQuestionDetailsURL = ..addParameterToURL(baseCodQuestionDetailsURL, "itemNameID", itemNameID)
	set newCodQuestionDetailsURL = ..addParameterToURL(baseCodQuestionDetailsURL, "itemNameID", "NEW")
	set codQuestionDetailsURL = ..addParameterToURL(codQuestionDetailsURL, "gotoPage", %request.Get("gotoPage"))
	set errorURL=codQuestionDetailsURL

	// get the current values, used to compare against for audit trail purposes
	set (dependsOnPromptExisting,dependsOnAlternativeExisting,backendOnlyExisting,requiredAnswerExisting,validationErrorMessageExisting,noAmendmentsExisting,readonlyFrontendExisting)=""
	if dataID	{
		&SQL(SELECT 
			dependsOnPrompt,
			dependsOnAlternative,
			backendOnly,
			requiredAnswer,
			validationErrorMessage,
			noAmendments,
			readonlyFrontend
			INTO 
			:dependsOnPromptExisting,
			:dependsOnAlternativeExisting,
			:backendOnlyExisting,
			:requiredAnswerExisting,
			:validationErrorMessageExisting,
			:noAmendmentsExisting,
			:readonlyFrontendExisting
			FROM sc_xModules.objCODitem WHERE ID = :dataID)
	}
	set mandatory=%request.Get("chkMandatory")
	set concealed=+%request.Get("chkConcealed")	
	
	set questionText=%request.Get("txtPrompt")


	// make any custom created firstname & lastname prompts mandatory, fix the twisted workflow of Organizers (SF CASE #00020967)
	set alwaysMandatory=0
	if $ZCVT(%request.Get("txtDescription"),"L")="firstname" set alwaysMandatory=1
	if $ZCVT(%request.Get("txtDescription"),"L")="lastname" set alwaysMandatory=1
	if (alwaysMandatory) {
		set mandatory=1
	}
								
	set (pageName,languageID)=""
	&SQL(SELECT description,objLanguage INTO :tmp,:tmp2 FROM sc_xModules.objPage WHERE ID = :pageID)
	if +SQLCODE=0 set pageName=tmp,languageID=tmp2

	if isQuantityItem {
		set createsAttendees=+%request.Get("chkqCreatesAttendees"),attendeeCategoryID=%request.Get("selqAttendeeCategory")
		if createsAttendees {
			//check if accommodation is ON, then, do not allow real attendees to be created.
			if (##class(setup.objEventSetting).getParameter("bookings","allow accommodation bookings",xEventID)) {
				set %session.Data("proweb","backend","errMsg")=..out("Real attendees in QBIs cannot be created if the Accommodation module has been activated.")
				set %response.Redirect=errorURL_"&isCOD="_..encodeForURL(%request.Get("isCOD"))_"&quantityItem=1"
				quit 0
			}			

			if ##class(cod.objTicket).anyOtherCreateAttendeeQuestions(xEventID,attendeeCategoryID,dataID,languageID) {
				set %session.Data("proweb","backend","errMsg")="There is already a question that creates attendees for this attendee category."
				set %response.Redirect=errorURL_"&isCOD="_..encodeForURL(%request.Get("isCOD"))_"&quantityItem=1"
				quit 0
			}
			if ##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID) {
				set %session.Data("proweb","backend","errMsg")="Attendees cannot be created for an event with table bookings."
				set %response.Redirect=errorURL_"&isCOD="_..encodeForURL(%request.Get("isCOD"))_"&quantityItem=1"
				quit 0
			}
		}
	}
	
	set addToTop=%request.Get("addToTop")
	set addToTop=$S(addToTop="true":1,1:0)
	set codGroup=%request.Get("codGroup")   
	set eventHotelID=%request.Get("eventHotelID")     
	set (isDelegate,isGuest)=""
	if %request.Get("radDelegateOrGuest")="delegate" set isDelegate=1
	if %request.Get("radDelegateOrGuest")="guest" set isGuest=1
	if %request.Get("radDelegateOrGuest")="both" set isDelegate=1,isGuest=1
	if 'isDelegate,'isGuest {
		// This should never happen, but has. Set isDelegate=1 and log the details
		set isDelegate=1
	}

	// stop them entering only one alternative, can never be right but only if radio (as sometimes needed for drop downs)
	 if %request.Get("selType")="radiobutton",$L(%request.Get("txtAlternatives"),"|")=2 { 
		set %session.Data("proweb","backend","errMsg")=..out("You have only entered one alternative, please add more or consider a different question type")
		set %response.Redirect=errorURL
		quit 0
	}
	
	// check that any deleted alternatives have not been purchased in this event or any other
	set hasBeenPurchased=0
	set delAlts=%request.Get("txtDeletedAlternatives")
	for i=1:1:$L(delAlts,"|") {
		set id=$p(delAlts,"|",i)
		if '##class(cod.objItemAlternatives).canAlternativeBeDeleted(id,.reason) {
			set %session.Data("proweb","backend","errMsg")=reason
			set %response.Redirect=errorURL
			return 0	
		}
	}
	
	// verify the min and max number of checkboxes
	if %request.Get("multiCheckboxMax"),%request.Get("multiCheckboxMin"),%request.Get("multiCheckboxMax")<%request.Get("multiCheckboxMin") {
		set %session.Data("proweb","backend","errMsg")=..out("Maximum number of checked alternatives must be more or the same as the minimum number.")
		set %response.Redirect=errorURL
		quit 0
	}
	
	// if dateRange type, make sure we have both end of Range and the range is no longer than 30 days.
	set minDateRange=""
	set maxDateRange=""
	if (%request.Get("selType")="dateRange") {
		set minDateRange=##class(shared.dateFunctions).multiDate(%request.Get("dateRangeStart"),25,,xUserInputDateFormat)
		set maxDateRange=##class(shared.dateFunctions).multiDate(%request.Get("dateRangeEnd"),25,,xUserInputDateFormat)
		if ('$L(minDateRange)) {
			set %session.Data("proweb","backend","errMsg")=..out("Date range start date is not valid.")
			set %response.Redirect=errorURL
			quit 0			
		} elseif ('$L(maxDateRange)) {
			set %session.Data("proweb","backend","errMsg")=..out("Date range end date is not valid.")
			set %response.Redirect=errorURL
			quit 0				
		} elseif ($SYSTEM.SQL.DATEDIFF("day",minDateRange,maxDateRange)<0) {
			set %session.Data("proweb","backend","errMsg")=..out("Date range end date must be after the start date.")
			set %response.Redirect=errorURL
			quit 0
		} elseif ($SYSTEM.SQL.DATEDIFF("day",minDateRange,maxDateRange)>##class(cod.objItemName).#maxDateRangeLength) {
			set %session.Data("proweb","backend","errMsg")=..out("Date range must be between 1 and {{{VAR01}}} days.",,##class(cod.objItemName).#maxDateRangeLength)
			set %response.Redirect=errorURL
			quit 0
	
		}
	}
	
	
	set requiredAnswer=##class(EF.sanitiser).removeRepeatedWhiteSpace(%request.Get("requiredAnswer"))
	set validationErrorMessage=%request.Get("validationErrorMessage")
	set okToSave=1
	if $e(requiredAnswer,1,2)="##" {
		set okToSave=0
		// Validate bespoke callouts
		set callOutMethod=$e(requiredAnswer,3,$l(requiredAnswer))
		if callOutMethod?1A.AN {
			set callOutMethod="customCode.codAnswerValidation."_##class(shared.callOuts).classNameForBespokeCode()_"."_callOutMethod
			if ##class(%MethodDefinition).%OpenId(callOutMethod).ClassMethod {
				set okToSave=1
			}
		}
		if 'okToSave {
			set %session.Data("proweb","backend","errMsg")=..out("The custom validation specifies an invalid call out method.")
		}	
	}
	if requiredAnswer?1"#"1.AN {
		if requiredAnswer="#personRegisteredWithSameAnswer" {
			if (%request.Get("selType")="multibox") ! (%request.Get("selType")="dateRange") ! (%request.Get("selType")="checkbox") ! (%request.Get("selType")="radiobutton") {
				set %session.Data("proweb","backend","errMsg")="Custom validation #personRegisteredWithSameAnswer has been removed as it cannot be used with this question type"
				set okToSave=0	
			}
		} else {
			set %session.Data("proweb","backend","errMsg")=..out("Invalid custom validation, please enter an answer or pattern that must be matched, or a valid custom validation method starting with '#'")
			set okToSave=0	
		}
	}
	if 'okToSave {
		set %response.Redirect=errorURL
		quit 0
	}	
	set dependsOnPrompt=%request.Get("selDependsOnDataID")
	if dependsOnPrompt {
		set dependencyItem = ##class(sc.dependency).createNew(dependsOnPrompt)
		if (dependencyItem.existsInDependencyChain(dataID)) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because they would create an endless dependency loop."
			set %response.Redirect = errorURL
			quit 0
		}
		if isDelegate {
			set isDependentParentForGuests=##class(sc.methods).isGuestItem(dependsOnPrompt)
			if isDependentParentForGuests {
				set %session.Data("proweb","backend","errMsg")=..out("You cannot make an attendee prompt dependent on a guest prompt")
				set %response.Redirect=errorURL
				quit 0
			}
		}
	}
	set defaultValue=""
	if $Length(%request.Get("txtAlternatives")) {
		set defaultValue=%request.Get("defaultValueAlt")	
	} else {
		set defaultValue=%request.Get("defaultValueText")
	}
	set copyValueFromBooker=%request.Get("chkCopyFromBooker")
	if copyValueFromBooker set defaultValue=""
	
	if $l(defaultValue) {
		set isDefaultValid=$CASE($ZCVT(%request.Get("selType"),"L"),
			"emailaddress":##class(EF.utils.dataValidation).isValidEmailAddress(defaultValue),
			"multiemailaddress":##class(EF.utils.dataValidation).isValidMultiEmailAddress(defaultValue),
			:1
		)
		if 'isDefaultValid {
			set %session.Data("proweb","backend","errMsg")=..out("Please enter a valid default value.")
			set %response.Redirect=errorURL
			quit 0
		}
	}
		
	// create new proweb item
	set carryOver=$S(%request.Get("radAnswerAppliesTo")="allEvents":1,1:0)
			
	set isQuestionForSingleEvent=$S(%request.Get("radQuestionAvailability")="singleEvent":1,1:0)
	
	if carryOver&&isQuestionForSingleEvent {
		set %session.Data("proweb","backend","errMsg")=..out("You cannot have a single event question with answers that apply to all events")
		set %response.Redirect=errorURL
		quit 0
	}
	
	// if %session.Data("proweb","isSurvey") is set, we are entering a survey question. So, just change the codGroup to 'Survey';
	if $G(%session.Data("proweb","isSurvey"))=1 set codGroup = "Survey"
	
	set reportDescription=%request.Get("reportDescription")		
	
	set email=##class(cod.objItemData).get($G(%session.Data("eventsforce","backend","xPersonID")),"email")
	if dataID="NEW" {
		if isAdditionalItem {
			kill allRegPageIDs
			kill alreadyUsedQuestions
			set ok = ##class(setup.lnkCategoryEvent).getAllRegPages(xEventID, xWorkLangID, 1,, .allRegPageIDs)
			if ok {
				do ##class(cod.methods).loadUsedQuestions(pageID,,, .alreadyUsedQuestions, .allRegPageIDs)
				if $Data(alreadyUsedQuestions(itemNameID)) {
					set errMsg = "The changes can't be saved because the additional bookable item already exists on this registration page."
				}
			}
	 	}
	 	if (itemNameID '= "CREATE") && ('##class(cod.objItemName).%ExistsId(itemNameID)) {
			set errMsg = "The changes can't be saved because the database item is not valid."
		}
		if $Length(errMsg) {
			set %session.Data("proweb", "backend", "errMsg") = errMsg
			kill %session.Data("itemNameID")
 			set %response.Redirect = newCodQuestionDetailsURL
 			return 0	
		}
		if itemNameID="CREATE" {
			// new data and new cod
			// create new cod item
			if codGroup="" set codGroup="Additional"   // optional pass in value now. 
			set description=%request.Get("txtDescription")
			
			if $G(%session.Data("templateURL"))["tAdditionalRegistration.csp"  {
				// add the page name to the cod prompt if we are doing additional registration pages
				 &SQL(SELECT description INTO :pageName FROM sc_xModules.objPage WHERE ID = :pageID)				
				 set description=pageName_"|"_description
			}
			if codGroup'="Hotel" set eventHotelID=""  //  only allow the eventHotel link to be created if we're creating a hotel prompt
			if eventHotelID set description="HOTEL_"_eventHotelID_"_"_description
			
			// password field should be stored as a text field in the COD, it's only a display issue. 
			set tmpType=%request.Get("selType")
			if tmpType="password" set tmpType="text"
			if tmpType="1-5 scale" set tmpType="radiobutton"
			
			set errMsg=""
			// ensure that the database name is free from invalid characters.
			if ##class(cod.objItemName).anyInvalidCharactersInName(description) {
				set errMsg="Only letters, numbers, underscores and spaces are allowed for the database name. Please try again."
			}
			if '$L(errMsg) {
				// make sure it doesn't exist already
				if isQuestionForSingleEvent {
					if '##class(cod.objItemName).isNameValidForNewSingleEventQuestion(description,xEventID,.tmpMsg) {
						set errMsg=tmpMsg
					}
				} else {
					if '##class(cod.objItemName).isNameValidForNewCrossEventQuestion(description,.tmpMsg) {
						set errMsg=tmpMsg
					}	
				}
			}
			
			if '$L(errMsg) && (tmpType="dateRange")&&('isQuestionForSingleEvent) {
				set errMsg="Date range questions must only apply to a single event."
			}
			if $l(errMsg) {
				set %session.Data("proweb","backend","errMsg")=errMsg
				set %response.Redirect=errorURL
				quit 0		
			}
			
			try {
				if isQuestionForSingleEvent {
					set itemNameID=##class(cod.objItemName).addSingleEventQuestion(description,tmpType,codGroup,xEventID)
				} else {
					set itemNameID=##class(cod.objItemName).add(description,mandatory,tmpType,codGroup,,,carryOver,eventHotelID)
				}
			} catch error {
				set %session.Data("proweb","backend","errMsg")=error.Name
				set %response.Redirect=errorURL
				return 0
			}
			
			// log it to the event audit trail
			if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Added new database item: "_description_", "_tmpType)
		}	
			
		// new data and existing cod item
		set layout=%request.Get("radLayout")
		if layout="" set layout="horizontal"
		
		
		// make multiple checkboxes that have a minimum number of checks mandatory
		if %request.Get("multiCheckboxMin") set mandatory=1
		
		if (%request.Get("txtFieldWidth")'?.N) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Field width"" must be a number"
			set %response.Redirect = errorURL
			return 0
		}
		
		if (%request.Get("txtFieldHeight")'?.N) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Height"" must be a number"
			set %response.Redirect = errorURL
			return 0
		}

		set dataID=##class(sc.xModules.objCODitem).add(itemNameID,questionText,parent,email,addToTop,%request.Get("txtHelpText"),%request.Get("selType"),mandatory,layout,%request.Get("txtFieldWidth"),%request.Get("txtFieldHeight"),isDelegate,isGuest,"",isAdditionalItem,,isQuantityItem,reportDescription)

		// log it to the event audit trail
		set codItemNameDescription=##class(cod.objItemName).getDescFromID(itemNameID)
		if isAdditionalItem {
			if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Added new Additional Booking Item: "_questionText_" ("_codItemNameDescription_"), "_%request.Get("selType")_", "_$S(mandatory:"Mandatory",1:"Not Mandatory"))
		} else {	
			if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Added new Registration Question: "_questionText_" ("_codItemNameDescription_"), "_%request.Get("selType")_", "_$S(mandatory:"Mandatory",1:"Not Mandatory"))
		}
		
		// Add new, dependend children right underneath their parent
		set dependsOnAlternative=%request.Get("selDependsOnCodAltID")
		if (dependsOnPrompt&&dependsOnAlternative) { //  only save as dependent if we have both a dependent question and a required answer
			&SQL(SELECT displayOrder,parent INTO :parentDisplayOrder,:depParentID FROM sc_xModules.objCODitem WHERE ID = :dependsOnPrompt)
			if +SQLCODE=0,dataID,depParentID'=parent { // Don't update display order if the dependent question list is different from this one.
				set lastPos=parentDisplayOrder
				
				// find the last dependend child
				&SQL(SELECT displayorder INTO :lastChild FROM sc_xModules.objCODitem WHERE (dependsOnPrompt = :dependsOnPrompt) AND (parent=:parent) ORDER BY displayOrder DESC)
				if +SQLCODE=0,lastChild set lastPos=lastChild
				// Also check text blocks
				&SQL(SELECT displayorder INTO :lastChild FROM sc_xModules.objText WHERE (dependsOnPrompt = :dependsOnPrompt) AND (parent=:parent) ORDER BY displayOrder DESC)
				if +SQLCODE=0,lastChild>lastPos {
					set lastPos=lastChild
				}
				
				// move all the subsequent items one step down
				&SQL(UPDATE sc.objData SET displayOrder = displayOrder+1 WHERE (parent = :parent) AND (displayOrder > :lastPos))
				
				// move the new item to right after the parent	
				&SQL(UPDATE sc_xModules.objCODitem SET displayOrder = :lastPos + 1 WHERE ID = :dataID)
			}
		} else {
			do ##class(sc.objData).moveNewElementToDesiredPosition(dataID)				
		}
		


	} else {  
		// existing objData
		if itemNameID="NEW" {
			// don't allow this
					
		} else {
			// existing cod item
			set layout=%request.Get("radLayout")
			if layout="" set layout="horizontal"
			set mandatory=%request.Get("chkMandatory")
			// make multiple checkboxes that have a minimum number of checks mandatory
			if %request.Get("multiCheckboxMin") set mandatory=1	

			do ##class(sc.xModules.objCODitem).update(dataID,questionText,email,%request.Get("txtHelpText"),%request.Get("selType"),mandatory,layout,%request.Get("txtFieldWidth"),%request.Get("txtFieldHeight"),isDelegate,isGuest,"",reportDescription)
			// log to event audit trail
			if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Saved Registration Question: "_questionText_", "_%request.Get("selType")_", "_$S(mandatory:"Mandatory",1:"Not Mandatory"))
		}
	
	}
	
	set question=##class(sc.xModules.objCODitem).%OpenId(dataID)
	if $IsObject(question) {
		do question.%Reload()
		set question.searchAsYouType = %request.Get("chkSearchAsYouType")
		do question.%Save()
		kill question
	}
	
	set codItemNameDescription=##class(cod.objItemName).getDescFromID(itemNameID)
	&SQL(UPDATE cod.objItemName SET concealed = :concealed WHERE ID = :itemNameID)
	
	set itemNameType=##class(cod.objItemName).getTypeById(itemNameID)
	if itemNameType="dateRange" {
		set lnkItemNameEvent=##class(cod.lnkItemNameEventDateRange).getLnkItemNameEvent(itemNameID,xEventID)
		if '$ISOBJECT(lnkItemNameEvent) {
			set lnkItemNameEvent=##class(cod.lnkItemNameEventDateRange).%New()
			do lnkItemNameEvent.objEventSetObjectId(xEventID)
			do lnkItemNameEvent.objItemNameSetObjectId(itemNameID)
		}
		set lnkItemNameEvent.minTimeStamp=minDateRange
		set lnkItemNameEvent.maxTimeStamp=maxDateRange
		do lnkItemNameEvent.%Save()
	}
	
	// add ticketing
	if isQuantityItem {
		
		set ticketID=##class(cod.objTicket).getTicketIDfromDataID(dataID)
		set useVatCodes=##class(eCom.objVatCode).isVatCodesEnabled()
		set priceByAttendeeCategory=+%request.Get("chkPriceByAttendeeCategory")
		set togglePriceByAttendeeCategory=%request.Get("togglePriceByAttendeeCategory")
		set createsAttendees=+%request.Get("chkqCreatesAttendees"),attendeeCategoryID=%request.Get("selqAttendeeCategory")
		
		set directPrice=%request.Get("txtDirectPrice")
		set directPrice=$TR(directPrice,",","")
		set currencyID=%request.Get("selCurrency")
		set priceDescriptorID=%request.Get("selPriceDescriptor")
		set showBookingLevel=+%request.Get("chkqShowBookingLevel")
		set qMin=%request.Get("txtqMin")
		set qMax=%request.Get("txtqMax")
		
		if (qMin'?.N) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Optional booking levels - minimum"" must be a number"
			set %response.Redirect = errorURL
			return 0
		}
		if (qMax'?.N) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Optional booking levels - maximum"" must be a number"
			set %response.Redirect = errorURL
			return 0
		}
		
		TSTART
		
		if ticketID	{
			do ##class(cod.objTicket).update(ticketID,xEventID,xControllerID,createsAttendees,attendeeCategoryID,showBookingLevel,qMin,qMax,priceByAttendeeCategory)
		} else {
			set ticketID=##class(cod.objTicket).add(dataID,xEventID,xControllerID,createsAttendees,attendeeCategoryID,showBookingLevel,qMin,qMax,priceByAttendeeCategory)
		}
		if 'createsAttendees {
			set bookableItemQBI = ##class(setup.eventBookableItemQBI).createNew(eventConfiguration,ticketID)
			do bookableItemQBI.load()
			set bookableItemQBI.registrationStatus = %request.Get("selRegistrationStatus")
			set bookableItemQBI.storedCapacity = %request.Get("txtqCapacity")
			set bookableItemQBI.hasCapacityNotification = +%request.Get("chkqNotification")
			set bookableItemQBI.capacityNotificationLevel = %request.Get("txtqNotificationLevel")
			if 'bookableItemQBI.isValid(.listOfErrorMessages) {
				set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because "_listOfErrorMessages.GetAt(1)_"."
				TROLLBACK
				set %response.Redirect = errorURL
				return 0
			}
			do bookableItemQBI.save()
		}
		TCOMMIT
		
		// create array of selected discounts
		set item="chkDiscount"
		kill checked
		// get all the checked ones
		for  {
			set item=$o(%request.Data(item)) q:item=""!(item'["chkDiscount")
			set checked($P(item,"_",2),+$P(item,"_",3))=""
		}
		
		// update the price
		set count=0
		if priceByAttendeeCategory {
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs.Prepare("SELECT objEventCategory->description,objEventCategory FROM setup.lnkCategoryEvent WHERE (objEvent=?) AND (active=1) AND (langID=?) GROUP BY objEventCategory ORDER BY isDefault DESC,objEventCategory->description")
			do rs.Execute(xEventID,xLangID)
			while rs.Next() {
				set count=count+1
				set eventCategoryID=rs.Get("objEventCategory")
				if count=1 set defaultID=eventCategoryID
				set directPrice=%request.Get("txtDirectPrice_"_eventCategoryID)
				set directPrice=$TR(directPrice,",","")
				set currencyID=%request.Get("selCurrency_"_eventCategoryID)
				set priceDescriptorID=%request.Get("selPriceDescriptor_"_eventCategoryID)
				set sameAs=%request.Get("selSameAs_"_eventCategoryID)
				set vatCodeID=%request.Get("selVatCode_"_eventCategoryID)				
				set basketItemID=##class(links.lnkCategoryItemBasketItem).getTicketLinkedBasketItem(ticketID,eventCategoryID)
				if basketItemID="",eventCategoryID'=defaultID set sameAs=defaultID
				// use any existing basketItem if we had one from before or create new one
				if basketItemID="" {
					// create new
					//  Add Property to link objBasketItem to the related object
					set basketItemID=##class(eCom.objBasketItem).add(priceDescriptorID,xControllerID,"quantityitem",,,ticketID)
					do ##class(cod.objTicket).updateBasketItem(ticketID,basketItemID,eventCategoryID)
					set ok=##class(links.lnkCategoryItemBasketItem).updateTicketLink(ticketID,eventCategoryID,sameAs)
				}
				if 'togglePriceByAttendeeCategory {
					set ok=##class(links.lnkCategoryItemBasketItem).updateTicketLink(ticketID,eventCategoryID,sameAs)
					if eventCategoryID'=%request.Get("updateSameAs") {
						do ##class(eCom.objBasketItem).updatePrices(.basketItemID,directPrice,priceDescriptorID,currencyID)
	
						set rs1=##class(%ResultSet).%New("eCom.objDiscount:qAllDiscounts")
						do rs1.Execute(xLangID,xControllerID)
						while rs1.Next() {
							set discID=rs1.Get("objDiscount")
							
							if $D(checked(discID,+eventCategoryID)) { //it's checked
								if '##class(eCom.lnkItemDiscount).exists(basketItemID,discID) { // it doesn't exist, create it
									set objLink=##class(eCom.lnkItemDiscount).%New()
									do objLink.objBasketItemSetObjectId(basketItemID)
									do objLink.objDiscountSetObjectId(discID)
									set ok=objLink.%Save()
								}
								
							} else { // it's not checked 
								if ##class(eCom.lnkItemDiscount).exists(basketItemID,discID) { // it exists, remove it
									set linkID=##class(eCom.lnkItemDiscount).returnLinkID(basketItemID,discID)
									do ##class(eCom.lnkItemDiscount).%DeleteId(linkID)
								}
							}
						}
					}
					if useVatCodes {
						&SQL(UPDATE eCom.objBasketItem set objVatCode=:vatCodeID WHERE ID=:basketItemID)
					}
				}
				// update costs
				set initialCost=%request.Get("initialCost_"_eventCategoryID)
				set unitCost=%request.Get("unitCost_"_eventCategoryID)
				&SQL(UPDATE eCom.objBasketItem set unitCost=:unitCost,initialCost=:initialCost WHERE ID=:basketItemID)			
			}
		} else {
			set basketItemID=##class(cod.objTicket).getBasketItemID(ticketID)
			set directPrice=%request.Get("txtDirectPrice_")
			set directPrice=$TR(directPrice,",","")
			set currencyID=%request.Get("selCurrency_")
			set priceDescriptorID=%request.Get("selPriceDescriptor_")
			set vatCodeID=%request.Get("selVatCode_")
			if basketItemID="" {
				// create new
				//  Add Property to link objBasketItem to the related object
				set basketItemID=##class(eCom.objBasketItem).add(priceDescriptorID,xControllerID,"quantityitem",,,ticketID)
				do ##class(cod.objTicket).updateBasketItem(ticketID,basketItemID,"")
			}
			if 'togglePriceByAttendeeCategory {
				do ##class(eCom.objBasketItem).updatePrices(basketItemID,directPrice,priceDescriptorID,currencyID)
				set rs1=##class(%ResultSet).%New("eCom.objDiscount:qAllDiscounts")
				do rs1.Execute(xLangID,xControllerID)
				while rs1.Next() {
					set discID=rs1.Get("objDiscount")
					
					if $D(checked(discID,0)) { //it's checked
						if '##class(eCom.lnkItemDiscount).exists(basketItemID,discID) { // it doesn't exist, create it
							set objLink=##class(eCom.lnkItemDiscount).%New()
							do objLink.objBasketItemSetObjectId(basketItemID)
							do objLink.objDiscountSetObjectId(discID)
							set ok=objLink.%Save()
						}
						
					} else { // it's not checked 
						if ##class(eCom.lnkItemDiscount).exists(basketItemID,discID) { // it exists, remove it
							set linkID=##class(eCom.lnkItemDiscount).returnLinkID(basketItemID,discID)
							do ##class(eCom.lnkItemDiscount).%DeleteId(linkID)
						}
					}
				}
				// update VAT Code
				if useVatCodes {
					&SQL(UPDATE eCom.objBasketItem set objVatCode=:vatCodeID WHERE ID=:basketItemID)
				}
			}
			// update costs
			set initialCost=%request.Get("initialCost_")
			set unitCost=%request.Get("unitCost_")
			&SQL(UPDATE eCom.objBasketItem set unitCost=:unitCost,initialCost=:initialCost WHERE ID=:basketItemID)		
		}
		
		// save the ecternal item codes
		if ##class(setup.objSystemTypes).isModuleAllowed("External Item Codes") {
			// save the account codes in all basketItems
			set extItemCode=%request.Get("txtExtItemCode")
			set extItemCode2=%request.Get("txtExtItemCode2")
	
			// update the main delegate basketItem
			set basketItemID=""
			&SQL(SELECT basketItemID INTO :tmp FROM cod.objTicket WHERE ID=:ticketID)
			if +SQLCODE=0 set basketItemID=tmp
			&SQL(UPDATE eCom.objBasketItem SET extItemCode=:extItemCode,extItemCode2=:extItemCode2
				WHERE ID=:basketItemID
			)
			// update for attendee categories
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs.Prepare("SELECT * FROM links.lnkCategoryItemBasketItem WHERE (objTicket=?)")
			do rs.Execute(ticketID)
			while rs.Next() {
				set basketItemID=rs.Get("objBasketItem")
				&SQL(UPDATE eCom.objBasketItem
					SET extItemCode=:extItemCode,extItemCode2=:extItemCode2
					WHERE ID=:basketItemID
				)
			}
		}
		
		// save the ecternal item codes
		if ##class(setup.objSystemTypes).isModuleAllowed("Profit & Loss") {
			// save the account codes in all basketItems
			set initialCost=%request.Get("initialCost")
			set unitCost=%request.Get("unitCost")
	
			// update the main delegate basketItem
			set basketItemID=""
			&SQL(SELECT basketItemID INTO :tmp FROM cod.objTicket WHERE ID=:ticketID)
			if +SQLCODE=0 set basketItemID=tmp
			&SQL(UPDATE eCom.objBasketItem SET initialCost=:initialCost,unitCost=:unitCost
				WHERE ID=:basketItemID
			)
			// update for attendee categories
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs.Prepare("SELECT * FROM links.lnkCategoryItemBasketItem WHERE (objTicket=?)")
			do rs.Execute(ticketID)
			while rs.Next() {
				set basketItemID=rs.Get("objBasketItem")
				&SQL(UPDATE eCom.objBasketItem
					SET initialCost=:initialCost,unitCost=:unitCost
					WHERE ID=:basketItemID
				)
			}
		}
	}

	// store the depencies
	set dependsOnPrompt=%request.Get("selDependsOnDataID")
	set dependsOnAlternative=%request.Get("selDependsOnCodAltID")
	
	//  only save as dependent if we have both a dependent question and a required answer
	if ('dependsOnAlternative || 'dependsOnPrompt) {
		set (dependsOnAlternative,dependsOnPrompt)=""
	}
	&SQL(UPDATE sc_xModules.objCODitem SET dependsOnPrompt = :dependsOnPrompt,dependsOnAlternative = :dependsOnAlternative WHERE ID = :dataID)
	if ((xEventID)&&((dependsOnPrompt'=dependsOnPromptExisting)!(dependsOnAlternative'=dependsOnAlternativeExisting))) {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). Dependency changed for question: "_questionText_" ("_codItemNameDescription_"),"
		if dependsOnAlternative	{
			set auditText=auditText_" now depends on:"_##class(sc.xModules.objCODitem).getCODItemName(dependsOnPrompt)_" ("_dependsOnPrompt_")"_", alternative:"_##class(cod.objItemAlternatives).getDescriptionByID(dependsOnAlternative)_" ("_dependsOnAlternative_")"
		} else {
			set auditText=auditText_" dependency cleared."
		}
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}

	// store the suppressNewLine
	set suppressNewLine=%request.Get("suppressNewLine")
	set promptWidth=+%request.Get("promptWidth")
	&SQL(UPDATE sc_xModules.objCODitem SET promptWidth = :promptWidth,supressNewLine = :suppressNewLine WHERE ID = :dataID)
	
	//store the backendOnly flag
	set backendOnly=+%request.Get("chkBackendOnly")
	set reportOn=%request.Get("chkReportOn")
	set readonlyFrontend=+%request.Get("chkReadonlyFrontend")
	&SQL(UPDATE sc_xModules.objCODitem SET backendOnly = :backendOnly,reportOn = :reportOn,readonlyFrontend = :readonlyFrontend WHERE ID = :dataID)
	if ((xEventID)&&(backendOnly'=+backendOnlyExisting)) {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). Backend only flag changed for question: "_questionText_" ("_codItemNameDescription_"),"
		set auditText=auditText_" from:"_$S(backendOnlyExisting:"on",1:"off")_" to:"_$S(backendOnly:"on",1:"off")
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}
	if ((xEventID)&&(readonlyFrontend'=+readonlyFrontendExisting)) {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). Read only flag changed for question: "_questionText_" ("_codItemNameDescription_"),"
		set auditText=auditText_" from:"_$S(readonlyFrontendExisting:"on",1:"off")_" to:"_$S(readonlyFrontend:"on",1:"off")
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}
	
	if ##class(setup.objSystemTypes).isModuleAllowed("Attendee Categories")	{
		// kill all category links and save
		// - do this in method so it can compile without class
		do ##class(links.lnkEventCategoryData).deleteAllForOne(dataID)
		set item=""
		set errorOnCategories=""
		for  {
			set item=$o(%request.Data(item))
			if item="" quit
			if item["chkEventCategory" {
				set eventCategoryID=$P(item,"_",2)
				set okToUpdate=1
				if ((dependsOnPrompt)&&(dependsOnAlternative)) {
					if '(##class(links.lnkEventCategoryData).allow(eventCategoryID,dependsOnPrompt)) {
						set errorOnCategories=errorOnCategories_$LISTBUILD(##class(setup.objEventCategory).getDescription(eventCategoryID))
						set okToUpdate=0
					}
				}
				if okToUpdate {
					do ##class(links.lnkEventCategoryData).updateAttendeeCategoryRestrictionsRecursive(eventCategoryID,dataID)
				}
			}
		}
		if ($LISTLENGTH(errorOnCategories)>1) {
			set tempListStr=$LISTTOSTRING($LIST(errorOnCategories,1,*-1),"', '")_"' and '"_$LIST(errorOnCategories,*)
			set %session.Data("proweb","backend","errMsg")="The question cannot be restricted to the categories '"_tempListStr_"' because it is linked to another question where it is not allowed"
		} elseif($LISTLENGTH(errorOnCategories)>0) {
			set %session.Data("proweb","backend","errMsg")="The question cannot be restricted to the category '"_$LISTTOSTRING(errorOnCategories,",")_"' because it is linked to another question where it is not allowed"
		}
		if $G(%session.Data("proweb","backend","errMsg"))'="" {
			set %response.Redirect=errorURL
			quit 0
		}
	}
	
	// store the required answer and maxCharacters
	if (%request.Get("maxCharacters")'?.N) {
		set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Max length of answer"" must be a number"
		set %response.Redirect = errorURL
		return 0
	}
	set maxCharacters=%request.Get("maxCharacters")
	set maxWords=""
	if %request.Get("radCharsOrWords")="words" {
		set maxWords=maxCharacters
		set maxCharacters=""
	}
	set noAmendments=+%request.Get("chkNoAmendments")

	do ##class(sc.xModules.objCODitem).updateRequiredAnswer(dataID,requiredAnswer)
	do ##class(sc.xModules.objCODitem).updateValidationErrorMessage(dataID,validationErrorMessage)
	do ##class(sc.xModules.objCODitem).updateMaxCharacters(dataID,maxCharacters)
	do ##class(sc.xModules.objCODitem).updateMaxWords(dataID,maxWords)
	do ##class(sc.xModules.objCODitem).updateMultiCheckboxMin(dataID,%request.Get("multiCheckboxMin"))
	do ##class(sc.xModules.objCODitem).updateMultiCheckboxMax(dataID,%request.Get("multiCheckboxMax"))
	do ##class(sc.xModules.objCODitem).updateDefaultValue(dataID,defaultValue)
	do ##class(sc.xModules.objCODitem).updateCopyValueFromBooker(dataID,copyValueFromBooker)
	do ##class(sc.xModules.objCODitem).updateNoAmendments(dataID,+%request.Get("chkNoAmendments"))
	
	if ((xEventID)&&(requiredAnswer'=requiredAnswerExisting)) {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). Custom validation changed for question: "_questionText_" ("_codItemNameDescription_"),"
		set auditText=auditText_" from:"_requiredAnswerExisting_" to:"_requiredAnswer
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}
	if validationErrorMessage'=validationErrorMessageExisting {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). Validation error message changed for question: "_questionText_" ("_codItemNameDescription_"),"
		set auditText=auditText_" from:"_validationErrorMessageExisting_" to:"_validationErrorMessage
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}
	if ((xEventID)&&(noAmendments'=+noAmendmentsExisting)) {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). No amendments changed for question: "_questionText_" ("_codItemNameDescription_"),"
		set auditText=auditText_" from:"_$S(noAmendmentsExisting:"on",1:"off")_" to:"_$S(noAmendments:"on",1:"off")
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}
	
	// always make it published if we are doing document manamenmt
	if %session.Data("proweb","isDOC") {
		set step=##class(sc.objStep).getFinalLevel()
		do ##class(sc.objData).approve(dataID,step)
	}
	
	// count the list of alternatives
	set alts=%request.Get("txtAlternatives")
	if $IsObject(alts) {
		set alts=%request.Get("txtAlternatives").Read($$$maxStringLength)	
	}
	
	set oldCount=##class(cod.objItemAlternatives).getAlternativesCountForCodItem(itemNameID)
	set oldString=""
	if oldCount<15 {
		set oldString=""
		set rsOC=##class(cod.objItemAlternatives).getAlternativesForCodItemAsResultSet(itemNameID)
		while rsOC.Next() {
			set oldString=oldString_$S($L(oldString):" | ",1:"")_rsOC.Get("description")
		}
	}
	// update the list of alternatives
	kill questArr
	for altCount=1:1:($L(alts,"|")-1) {
		set itemAlternativeID=$p($p(alts,"|",altCount),"~",1)
		set desc=##class(cod.objItemAlternatives).sanitiseDescription($p($p(alts,"|",altCount),"~",2))
		set code=$p($p(alts,"|",altCount),"~",3)
		if itemAlternativeID["NEW" {
			set itemAlternativeID=##class(cod.objItemAlternatives).create(itemNameID,desc,code,altCount)
			if (defaultValue="NEW|") {
				do ##class(sc.xModules.objCODitem).updateDefaultValue(dataID,desc)
			}
		} else {
			do ##class(cod.objItemAlternatives).update(itemAlternativeID,desc,code,altCount)
		}
		if %request.Get("additional") {
			//  Setup the ABI
			set extrasID=##class(cod.objAlternativeExtras).findExtra(itemAlternativeID,dataID)
			if 'extrasID {
				set extrasID=##class(cod.objAlternativeExtras).add(itemAlternativeID,dataID)
				//  Add Property to link objBasketItem to the related object
				set basketItemID=##class(eCom.objBasketItem).add(,xControllerID,"additional",extrasID)
				// And assign the basket Item
				do ##class(cod.objAlternativeExtras).updateBasketItem(extrasID,basketItemID,"")
			}
		}
		// Update any for any other events which may be using this as an ABI (even if this event is not uising it as an ABI, others might)
		do ##class(cod.objAlternativeExtras).updateAlternatives(itemAlternativeID, .questArr)
	}
	// log to event audit trail
	if xEventID {
		if altCount<15 {
			set newString=""			
			for altCount=1:1:($L(alts,"|")-1) {
				set desc=$p($p(alts,"|",altCount),"~",2)
				set newString=newString_$S($L(newString):" | ",1:"")_desc
			}
			if newString'=oldString,$L(newString) {
				do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Changed List of Alternatives from: "_oldString_"  to:  "_newString)
			}
		} else {
			if oldCount'=altCount {
				do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Changed Number of Alternatives from: "_oldCount_"  to:  "_altCount)
			}
		}
	}
	
	if (##class(sc.xModules.objPage).isAbstractDocumentPage(pageID)) && (##class(sc.objComponent).getComponentName(parent) = "Document List") {
		set value =  +%request.Get("chkAbsShowToReviewers")
		
		if ##class(cod.lnkItemNameEvent).getShowToReviewers(itemNameID,xEventID) '= value {
			do ##class(setup.objEventAudit).add(xUserID,xEventID,"updated 'showToReviewers' for '"_##class(cod.objItemName).getDescFromID(itemNameID)_"' - new value: "_value)	
		}
		do ##class(cod.lnkItemNameEvent).setShowToReviewers(itemNameID,value,xEventID)	
	}
	
	
	// delete alternatives
	set delAlts=%request.Get("txtDeletedAlternatives")
	for i=1:1:$L(delAlts,"|") {
		set id=$p(delAlts,"|",i)
		do ##class(cod.objItemAlternatives).deleteAlternative(id,xUserID)
	}
	
	set %response.Redirect=%request.Get("templateURL")
	 set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))
	
	if %request.Get("gotoCodQuestionCSV") {
		set codQuestionDetailsURL = ..addParameterToURL(codQuestionDetailsURL, "gotoCodQuestionCSV", 1)
		set %response.Redirect=codQuestionDetailsURL
		quit 0
	}
	
	if %request.Get("gotoPage")'="" {
		set %response.Redirect=%request.Get("gotoPage") // used from codQuestionDetails.csp
	}
	if %request.Get("backPage")'="" set %response.Redirect=%request.Get("backPage") // used from eventsForce/registraionDetails.csp
	
	if %request.Get("updateSameAs")!%request.Get("togglePriceByAttendeeCategory") {
		set %response.Redirect=codQuestionDetailsURL
	}
	
	set %response.Redirect=%response.Redirect_$S(%response.Redirect["?":"&",1:"?")_"mode=edit"
	
	quit 0
</script>
]]></CSP>


<CSP name="backEnd/proweb/deleteListItem.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	set xEventID=$G(%session.Data("eventsforce","backend","xEventID"))
	set xUserID=$G(%session.Data("eventsforce","backend","xPersonID"))

	set dataID=%request.Get("dataID")	
	if dataID'="" {
		set description=""
		&SQL(SELECT description INTO :tmp FROM sc_xModules.objCODitem WHERE ID = :dataID)
		if +SQLCODE=0 set description=tmp
		
		if description="" { //This is a non-cod item. Store object type and dataID in Audit trail.
			set description=", Deleted "_##class(sc.objData).getDataType(dataID)_" ("_dataID_")"
		} else {
			set description=", Deleted Registration Question: "_description_" ("_dataID_")"
		}
		
		set pageID=##class(sc.objData).getPageID(dataID)
		set pageName=""
		&SQL(SELECT description INTO :tmp FROM sc_xModules.objPage WHERE ID = :pageID)
		if +SQLCODE=0 set pageName=tmp
		
		set ok=##class(sc.objData).deleteItem(dataID)
		
		// log to the event audit trail
		if (xEventID && ok) do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_")"_description)		
	}
	set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_##class(sc.objData).getPageID(dataID)
	quit 0
</script>
]]></CSP>


<CSP name="backEnd/proweb/editItem.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<script language="cache" method="OnPreHTTPafter" arguments="" returntype="%Library.Boolean"> 
	set prowebID = %request.Get("prowebID")
	if 'prowebID {
		throw ##class(shared.exceptions.generalException).%New("No prowebID passed in into editItem.csp")
	}
	
		
	set prowebItem = ##class(sc.objData).%OpenId(prowebID)
	if '$IsObject(prowebItem) {
		throw ##class(shared.exceptions.generalException).%New("Could not open proweb item: "_prowebItem)
	}
	if prowebItem.%Extends("sc.xModules.objCODitem") {
		set targetPage = "codQuestionDetails.csp"
	
	} elseif prowebItem.%Extends("sc.xModules.objFileUpload") {
		set targetPage = "fileUploadDetails.csp?isVideo=1"	

	} elseif prowebItem.%Extends("sc.xModules.objText") {
		if ##class(sc.xModules.objText).isMultipleItemsPerComponent(prowebID) {
			set targetPage = "textDetailsMoxie.csp"	
		} else {
			set targetPage = "textHeaderMoxie.csp"	
		}

	} elseif prowebItem.%Extends("sc.xModules.objMenuBlock") {
		set targetPage = "menuDetails.csp"	
		
	} elseif prowebItem.%Extends("sc.xModules.objFlash") {
		set targetPage = "flashDetails.csp"	
		
	} else {
		throw ##class(shared.exceptions.generalException).%New("No edit page defined for proweb item type: "_prowebItem)	
	}
	
	
	set URL = ..addParameterToURL(targetPage, "dataID", prowebID) 
	set %response.ServerSideRedirect = URL
	
	return 0
</script>
]]></CSP>


<CSP name="backEnd/proweb/fileUploadDetails.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<csp:include page="../../backend/home/backendTop.csp?hideBackendMenu=1">
<script language="cache" runat="server">
	set itemNameID=%request.Get("itemNameID")
	if itemNameID="" set itemNameID=%session.Get("itemNameID")
	set %session.Data("itemNameID")=itemNameID
	set pageID=%session.Get("pageID")
	set groupID=##class(sc.objData).getParentID(pageID)

	set dataID=%request.Get("dataID")
	if dataID="" set dataID=%session.Get("dataID")
	// switch to the org data to enable edit when having multi-stage workflow
	// but we can't do it for single workflow because the it will stop adding new ones in EF
	if ##class(sc.objStep).getFinalLevel()>1 {
		if %request.Get("orgDataID") set dataID=%request.Get("orgDataID")
	}
	set %session.Data("dataID")=dataID
	
	do ##class(sc.objData).saveDesiredPositionFromRequestToSession(%request, %session)
	
	set templateURL=%request.Get("templateURL")	
	if templateURL="" set templateURL=%session.Get("templateURL")
	set %session.Data("templateURL")=templateURL

	set parent=%request.Get("parent")
	if parent="" set parent=%session.Get("parent")
	set %session.Data("parent")=parent

	set isDOC=%request.Get("isDOC")
	if isDOC="" set isDOC=$G(%session.Data("proweb","isDOC"))
	set %session.Data("proweb","isDOC")=isDOC
	
	set isAwardsEntryPage=0
	&SQL(SELECT ID INTO :tmp FROM awards.objCategory WHERE pageID=:pageID)
	if +SQLCODE=0 {
		set isAwardsEntryPage=1
	}
		
	set addToTop=%request.Get("addToTop")
	if addToTop="" set addToTop=%session.Get("addToTop")
	set %session.Data("addToTop")=addToTop

	kill %session.Data("eventsforce","backend","gotoPage")
	set gotoPage=%request.Get("gotoPage")
	set %session.Data("eventsforce","backend","file upload gotoPage")=gotoPage

	set xWorkLangID=%request.Get("xWorkLangID")
	if xWorkLangID="" set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if xWorkLangID="" set xWorkLangID=$G(xLangID,1)

	// are we in the bookers page?
	set inBookersPage=0
	if xEventID	{
		set extraBit=""
		if xWorkLangID,xWorkLangID'=xLangID set extraBit=" - "_##class(shared.objLanguage).getLanguageDesc(xWorkLangID)
		if ##class(setup.objEventSetting).getParameter("bookings","bookerRegPageID"_extraBit,xEventID)=pageID set inBookersPage=1
	}
	
	
	if $G(%session.Data("proweb","backend","errMsg"))'="" {
		write "<scri"_"pt language='javas"_"cript'>alert('"_%session.Data("proweb","backend","errMsg")_"');</scri"_"pt>"
		kill %session.Data("proweb","backend","errMsg")
	}
	set meetingsEnabled=##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID)
</script>

<csp:object name="objFileUpload" classname="sc.xModules.objFileUpload" objid="#(dataID)#">

<script language="cache" runat="server">
	// Get the itemNameID from the the proweb object if we are editing 
	if dataID set itemNameID=objFileUpload.objItemName.%Id()
</script>

<csp:object name="objItemName" classname="cod.objItemName" objid="#(itemNameID)#">

<script language="cache" runat="server">
	set (description,prompt,helpText,mandatory,backendOnly,carryOver,maxFileSize,minFileSize,allowedFileTypes,isHardcoded,isDelegate,isGuest)=""
	
	// get the data from COD
	if itemNameID {
		set (description,prompt)=objItemName.description
		set helpText=objItemName.helpText
		set carryOver=objItemName.carryOver
	}
	
	// get the data from proweb
	if dataID {
		set prompt=objFileUpload.description
		set helpText=objFileUpload.helpText
		set mandatory=objFileUpload.mandatory
		set backendOnly=objFileUpload.backendOnly
		set minFileSize=objFileUpload.minFileSize
		set maxFileSize=objFileUpload.maxFileSize
		set allowedFileTypes=objFileUpload.allowedFileTypes
		set isDelegate=objFileUpload.isDelegate
		set isGuest=objFileUpload.isGuest
		do objFileUpload.%Close()
	}
	if description="Profile Picture" {
		set isHardcoded=1
		set allowedFileTypes="JPG,JPEG"
	}

	kill allRegPages,allRegPageIDs,allReg
	set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xWorkLangID,1,.allRegPages,.allRegPageIDs,.allReg)
</script>

<form name="myform" method="post" action="fileUploadDetails2.csp" onSubmit="return checkSubmit();">


<style>
table {margin-left:0px;margin-right:0px;padding-left:24px;padding-right:24px;}
table table {padding-left:0px;padding-right:0px;}
</style>

<div class="contentarea_in_popup">
	<div class="contentbox">
	<h2 style="margin-bottom:0px;">File Upload Details</h2>

	<div class="gen1_panel_subheader">
	<p class="black10px">
		<tx>Select an existing item from the dropdown.</tx>
		<tx>To create a new one click ADD NEW and enter a new Database Name.</tx> <br>
		<tx>The Database Names are common to all events but their Frontend display can be overridden using the File Upload Prompt.</tx>
	</p>
	</div>

								<table width="100%" border="0" cellspacing="0" cellpadding="0">
									<tr>
										<td align="left" valign="top">
											<csp:if condition=(+itemNameID=0)>
												<table border="0" cellspacing="0" cellpadding="0">
													<tr>
														<td width="145" height="30" align="left" nowrap class="black10px"><tx>Select Existing Item</tx>:&nbsp;&nbsp;</td>
														<td height="30" width="608">
															<table width="100%" border="0" cellspacing="0" cellpadding="0">
																<tr>
																	<td width="45%">
																		<select name="selCODitem" class="black10px" style="width: 325px;" onChange="loadItem(this.value);">
																			<option selected>---<tx>Select from List</tx>---</option>
																			<script name="rs" language="SQL">
																				SELECT ID,description FROM cod.objItemName
																				WHERE (active=1)
																				AND (type='fileupload')
																				ORDER BY description
																			</script>
																			<csp:while condition="rs.Next()">
																				<script language="cache" runat="server">
																					set tempDesc=rs.Get("description")
																					set tmpItemID=rs.Get("ID")
																					set optionClass=""
																					if ##class(setup.objSetting).getParameter("system","isEventsForce"),%session.Get("eventCategoryID")	{ // if we have come from regPages.csp
																						set tmpEventCategory=%session.Get("eventCategoryID")
																						// v2.7 get all the registration pages used so that we can decide whether we are in a registration page for this category
																						set tmpPageID="",highlightItem=""
																						for  {
																							set tmpPageID=$O(allRegPageIDs(tmpEventCategory,tmpPageID))
																							if tmpPageID="" quit
																							// check each page																		
																							&SQL(SELECT COUNT(ID) INTO :tmp FROM sc_xModules.objFileUpload WHERE (active=1 AND objItemName = :tmpItemID AND parent->parent = :tmpPageID))
																							if +SQLCODE=0,tmp set highlightItem=1,highlightDesc="Already Used: "
																						}
																						if highlightItem	{
																							set optionClass="redbold10px"
																							set tempDesc=highlightDesc_tempDesc
																						}
																						
																					}
																				</script>
																				<option value='#(tmpItemID)#' class="#(optionClass)#">#(tempDesc)#</option>
																			</csp:while>
																		</select>
																	</td>
																	<td width="20%" align="center" class="blackbold10px">&nbsp;<tx>OR</tx>&nbsp;&nbsp;</td>
																	<td width="35%" align="left">
																		<a href="javascript: gotoNewItem();"><img name="butCreateNew" id="butCreateNew" src="../../media/images/English/Default/backend/add.gif" border="0" alt="" width="65" height="17"></a>
																	</td>
																</tr>
																<script language="javascript">
																function gotoNewItem() {
																	document.location= '#(..Link(%request.PageName_"?itemNameID=CREATE"))#'
																}
																</script>  
															</table>
														</td>
													</tr>
													<tr>
														<td colspan=99>
															<div id="divR_all" class="UnderTextField"></div>
														</td>
													</tr> 	
													<tr>
														<td colspan="3" height="30"><img src="../../media/images/English/Default/backend/line.gif" width="600" height="21"></td>
													</tr>
												</table>
											</csp:if>
											<table width="100%" border="0" cellspacing="0" cellpadding="0">
												<tr height="30">
													<td width="13">&nbsp;</td>
													<td class="black10px" align="right" width="184"><tx>Database Name</tx>:&nbsp;*&nbsp;</td>
													<td class="black10px" colspan="3">
														<script language="cache" runat="server">
															set disabled=""
															if itemNameID'="CREATE" set disabled="disabled  style='background-color: #eeeeee;'"
														</script>
														<input type="text" name="txtDescription" size="50" maxlength="44" class="black10px" value="#(description)#" onchange="if (document.forms[0].txtPrompt.value.length <2) {document.forms[0].txtPrompt.value=this.value;}" #(disabled)#>
													</td>
												</tr>
												<tr>
													<td width="13" height="33">&nbsp;</td>
													<td class="black10px" align="right" height="33" width="184" valign="top"><tx>File Upload Prompt</tx>:&nbsp;&nbsp;</td>
													<td class="black10px" valign="middle" height="33" colspan="3">
													<textarea name="txtPrompt" class="black10px" rows=1 cols=60>#(prompt)#</textarea>
													</td>
													<td class="black10px" valign="top" width="120" height="33">
														<csp:if condition=((itemNameID="NEW")!(itemNameID="CREATE"))>
															<img src="../../media/images/English/Default/backend/edit.gif" alt="" width="45" height="17" border="0" style="filter: alpha(opacity=35); opacity: 0.35;" title="You must save the question before you can edit the prompt.">
														<csp:else>
															<a href="javascript: popup('question');"><img src="../../media/images/English/Default/backend/edit.gif" alt="edit" width="45" height="17" border="0"></a>
														</csp:if>
													</td>
												</tr>
												
												<script language="cache" runat="server">
													set isAnonymousMode=+##class(setup.objEventSetting).getParameter("system","do not use email",xEventID)
												</script>
												<csp:if condition=('isAnonymousMode)>
													<tr>
														<td width="13">&nbsp;</td>
														<td class="black10px" align="right">&nbsp;</td>
														<td class="blackbold10px" colspan="98"><tx>Allow the data for this item to span events?</tx>
															<csp:if condition=(itemNameID)>
																<csp:if condition=(carryOver)>
																	<span class="redbold12px">YES</span>
																	<input type="checkbox" name="chkCarryOver" value="1" CHECKED style="visibility: hidden;">
																<csp:else>
																	<span class="redbold12px">NO</span>
																	<input type="checkbox" name="chkCarryOver" value="1" style="visibility: hidden;">
																</csp:if>
															<csp:else>
																<input type="checkbox" name="chkCarryOver" value="1">
															</csp:if>
															<br>
															<tx>(required for any data that is imported and CANNOT be changed after setting up)</tx>
														</td>								
													</tr>
													
													<tr><td height=10></td></tr>
												<csp:else>
													<input type="checkbox" name="chkCarryOver" value="0" style="visibility: hidden;" CHECKED>
												</csp:if>
												
												<csp:include page="dependancyOptionsInclude.csp">

												<systemType:if module="Mandatory Questions">
													<tr>
														<td width="13" height="30">&nbsp;</td>
														<td class="black10px" width="184" align="right">
															<tx>Mandatory</tx>:&nbsp;		
														</td>
														<td>
															<input type="checkbox" name='chkMandatory' value="1" class="black10px" #($S(mandatory=1:"checked",1:0))#>
														</td>
													</tr>
												</systemType:if>
												<systemType:if module="Backend Only Questions">
													<tr>
														<td width="13" height="30">&nbsp;</td>
														<td class="black10px" width="184" align="right">
															<tx>Backend Only</tx>:
														</td>
														<td>
															<input type="checkbox" name='chkBackendOnly' value="1" class="black10px" #($S(backendOnly=1:"checked",1:0))#>
														</td>
													</tr>
												</systemType:if>

												<tr>
													<td width="13">&nbsp;</td>
													<td class="black10px" align="right"><tx>Applies to</tx>:&nbsp;</td>
													<td class="black10px">
														<input type="radio" name="radDelegateOrGuest" value="delegate" #($S((isDelegate)!(('isDelegate)&('isGuest)):"checked",1:0))#><tx>Attendees</tx>&nbsp;&nbsp;
														<input type="radio" name="radDelegateOrGuest" value="guest" #($S(isGuest:"checked",1:0))#><tx>Guests</tx>&nbsp;&nbsp;
														<csp:comment><!--<input type="radio" name="radDelegateOrGuest" value="both" #($S((isGuest)&(isDelegate):"checked",1:0))#>Both--></csp:comment>
													</td>								
												</tr>
												<tr>
													<td width="13" height="30">&nbsp;</td>
													<td class="black10px" width="184" align="right">
														<tx>Min File Size</tx>:&nbsp;		
													</td>
													<td class="black10px">
														<input type="text" name='txtMinFileSize' value='#(minFileSize)#' size=4 class="black10px">&nbsp;kb
													</td>
												</tr>
												<tr>
													<td width="13" height="30">&nbsp;</td>
													<td class="black10px" width="184" align="right">
														<tx>Max File Size</tx>:*&nbsp;		
													</td>
													<td class="black10px">
														<input type="text" name='txtMaxFileSize' value='#(maxFileSize)#' size=4 class="black10px">&nbsp;kb
													</td>
												</tr>
												<tr>
													<td width="13" height="30">&nbsp;</td>
													<td class="black10px" width="184" align="right" valign="top">
														<tx>Allowed File Types</tx>:*&nbsp;		
													</td>
													<td class="black10px" colspan=4>
														<table width="100%" border="0" cellspacing="0" cellpadding="0">
															<tr>
																<td class="black10px" align="right">
																	<tx>CSV</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",CSV,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_CSV' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_CSV' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>DOC</tx>
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",DOC,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_DOC' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_DOC' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>DOCX</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",DOCX,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_DOCX' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_DOCX' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>DWG</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",DWG,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_DWG' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_DWG' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>																
																<td class="black10px" align="right">
																	<tx>EPS</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",EPS,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_EPS' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_EPS' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>GIF</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",GIF,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_GIF' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_GIF' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>JPG</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",JPG,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_JPG' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_JPG' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
															</tr>
															<tr>
																<td class="black10px" align="right">
																	<tx>JPEG</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",JPEG,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_JPEG' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_JPEG' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>ODF</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",ODF,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_ODF' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_ODF' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>ODG</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",ODG,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_ODG' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_ODG' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>PDF</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",PDF,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_PDF' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_PDF' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>PNG</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",PNG,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_PNG' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_PNG' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>PPT</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",PPT,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_PPT' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_PPT' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>PPTX</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",PPTX,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_PPTX' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_PPTX' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
															</tr>
															<tr>
																<td class="black10px" align="right">
																	<tx>RTF</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",RTF,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_RTF' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_RTF' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>TIF</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",TIF,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_TIF' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_TIF' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>


																<td class="black10px" align="right">
																	<tx>TIFF</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",TIFF,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_TIFF' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_TIFF' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>																
																<td class="black10px" align="right">
																	<tx>TXT</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",TXT,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_TXT' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_TXT' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>XLS</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",XLS,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_XLS' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_XLS' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>XLSX</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",XLSX,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_XLSX' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_XLSX' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>
																<td class="black10px" align="right">
																	<tx>ZIP</tx>&nbsp;
																	<script language="cache" runat="server">
																		set isChecked=(","_allowedFileTypes_",")[(",ZIP,")
																	</script>
																	<csp:if condition=(isHardcoded)>
																		<input type="hidden" name='chkFileType_ZIP' value="#(isChecked)#">
																		<csp:if condition=(isChecked)>
																			<img src="../../media/images/English/Default/backend/tick.gif" alt="File attached" width="14" height="12" />
																		<csp:else>
																			<img src="../../media/images/English/Default/backend/cross.gif" alt="File attached" width="14" height="12" />
																		</csp:if>
																	<csp:else>
																		<input type="checkbox" name='chkFileType_ZIP' value="1" class="black10px" #($S(isChecked:"checked",1:0))#>
																	</csp:if>
																</td>

															</tr>
															<tr>







															</tr>
															<tr>

															
															<tr>
														</table>
													</td>
												</tr>
												<tr>
													<td width="20">&nbsp;</td>
													<td class="black10px" align="right" height="15" width="160" valign="top"><tx>Help Text</tx>:&nbsp;&nbsp;</td>
													<td class="black10px" width="334" valign="top">
														<textarea name="txtHelpText" rows=2 cols=60 class="black10px">#(helpText)#</textarea>
													</td>
												</tr>
												<tr>
													<td colspan=7 align="center">
														<img src="../../media/images/English/Default/backend/line.gif" width="600" height="21">
													</td>
												</td>
												<script language="cache" runat="server">
													set show=1
													if $G(xEventID) {
														set eventConfiguration=##class(setup.eventConfiguration).createForEventID(xEventID)
														if 'eventConfiguration.areAttendeeCategoriesAllowed() {
															set show=0
														}
													}
												</script>	
												<csp:if condition=(show)>
							                        <img src="../../media/images/English/Default/backend/line.gif" width="600" height="21">
														<systemType:if module="Attendee Categories">
															<script language="cache" runat="server">
																set eventID=$G(%session.Data("eventsforce","backend","xEventID"))
																set langID=$G(%session.Data("eventsforce","backend","xLangID"))
															</script>
															<csp:if condition=(eventID)>
																<script language="cache" runat="server">
																	// get all the active categories for this event
																	set rs=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
																	do rs.Execute(eventID)
																</script>
																<csp:while counter="x" condition="rs.Next()">
																	<csp:if condition=(x=1)>
																		<tr>
																			<td width="20">&nbsp;</td>
																			<td width="50">&nbsp;</td>
																			<td class="blackbold10px" colspan="4" align="left" nowrap>&nbsp;&nbsp;<tx>Restrict access to these attendee categories</tx>:</td>
																			<td width="50">&nbsp;</td>
																		</tr>
																	</csp:if>
																	<csp:if condition=(x#2'=0)>
																		<tr>
																			<td width="50">&nbsp;</td>
																	</csp:if>
																	<script language="cache" runat="server">
																		set eventCategoryID=rs.Data("objEventCategory")
																		set CHECKED=""
																		if ##class(links.lnkEventCategoryData).isSet(eventCategoryID,dataID) set CHECKED="CHECKED"
																	</script>
																	<td align="right" class="black10px">#(##class(shared.stringFunctions).sentenceCase(rs.Data("description")))#</td>
																	<td align="left"><input type="checkbox" name="chkEventCategory_#(eventCategoryID)#" #(CHECKED)#></td>
																	<csp:if condition=(x#2=0)>
																			<td width="50">&nbsp;</td>
																		</tr>
																	</csp:if>
																</csp:while>
																<csp:if condition=(x#2'=0)>
																		<td align="right" class="black10px">&nbsp;</td>
																		<td align="left">&nbsp;</td>
																	</tr>
																</csp:if>
														</csp:if>
													</systemType:if>
						                    	</csp:if>
											</table>
										</td>
									</tr>
								</table>

	</div><!-- end of contentbox -->
</div><!-- end of contentarea -->

<div class="topsave_in_popup">
	<script language="cache" runat="server">
		set backPage="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))
		if gotoPage'="" set backPage=gotoPage
		set backPage=backPage_$S(backPage["?":"&",1:"?")_"mode=edit"
	</script>
	<a href="#(backPage)#"><img src="../../media/images/English/Default/backend/cancel.gif" alt="#" width="65" height="17" border="0"></a>
	<input type="image" src="../../media/images/English/Default/backend/save.gif" border="0" alt="Save" width="65" height="17">
</div>
	
	<input type="Hidden" name="gotoPage" value="#(gotoPage)#">
	<input type="hidden" name="templateURL" value='#(templateURL)#'>
	<input type="hidden" name="addToTop" value='#(addToTop)#'>
	<input type="hidden" name="parent" value='#(parent)#'>
	<input type="hidden" name="itemNameID" value='#(itemNameID)#'>
	<input type="hidden" name="dataID" value='#(dataID)#'>
	<input type="hidden" name="popupURL" value="">


</form>



<script language='javascript'>
function checkSubmit() {
	if (!checkName()) return false;
	return true;
}

function checkName() {
	var name= document.forms[0].txtDescription.value;
	// JAW 18JUN2007
	//alert("x"+name+"x");
	if (name=='') {
		alert('#(..out("Please enter a Database Name for this File Upload Prompt."))#');
		return false;
	}
	
	var dataID = document.forms[0].dataID.value;
	var itemNameID = document.forms[0].itemNameID.value;
	//Shahadat CASE000 : Stop people from entering special characters for databasename.
	if((itemNameID == 'CREATE') && (!name.match("^[A-Za-z0-9 _\:]*[A-Za-z0-9][A-Za-z0-9 _\:]*$"))){
			alert('#(..out("Only letters, numbers and spaces are allowed in Database Name. Please try again."))#');
			document.forms[0].txtDescription.focus();
			return false;	
	}	
	
	if ((dataID == 'NEW') && (itemNameID == 'CREATE')) {
		var found=0;
		for (var i = 0 ; i<document.forms[0].selCODitem.options.length; i++) {
			if (document.forms[0].selCODitem.options[i].text.toUpperCase() == name.toUpperCase()) {
				alert('#(..out("The prompt you are trying to add is already in the database. Please re-use the existing one."))#');
				return false;	
			}
		}
	}
	return true;	
	//return false;	
}

function updateAlts(codPromptID) {
	document.forms[0].selDependsOnCodAltID.options.length=0;
	if (codPromptID != '') {
		// populate the alternatives list box from the javascript array
		
		for (var i = 0; i < (alts[codPromptID].length); i++) {
			var tmp = alts[codPromptID][i].split('|');
			document.forms[0].selDependsOnCodAltID.options[i] = new Option(tmp[1],tmp[0])
		}	
	}
}

function loadItem(inStr) {
	document.location = '#(..Link(%request.PageName_"?loadItem=true"))#&itemNameID=' + inStr;
}
function disableMe(formElem){
	/* pjc 28 July 2009 */
	// generic function to check for existence of form element and disable it
	if (typeof document.myform[formElem] != "undefined") {
		// it exists, but is it a set of radio buttons
		if (typeof document.myform[formElem].length != "undefined") { 
			// either radio or select
			if ((typeof document.myform[formElem].type != "undefined")&&(document.myform[formElem].type.indexOf('select')!=-1)) { 
				// select
				document.myform[formElem].disabled=true;
				document.myform[formElem].style.background="#EEEEEE";
			} else {
				// radio - iterate over the whole array or just one?
				if (arguments.length > 1) { // if specific, the index will be passed as a second argument to the function
					document.myform[formElem][arguments[1]].disabled=true;
				} else {
					for (var i=0;i<document.myform[formElem].length;i++) {
						document.myform[formElem][i].disabled=true;
					}
				}
			}
		} else {
			document.myform[formElem].disabled=true;
			// is it a text field, textarea or password? 
			if ((typeof document.myform[formElem].type != "undefined")&&((document.myform[formElem].type.indexOf('text')!=-1)||(document.myform[formElem].type.indexOf('password')!=-1))) { 
				document.myform[formElem].style.background="#EEEEEE";
			}
		}
		
	}
}

function enableMe(formElem){
	/* pjc 28 July 2009 */
	// generic function to check for existence of form element and enable it
	if (typeof document.myform[formElem] != "undefined") {
		// it exists, but is it a set of radio buttons
		if (typeof document.myform[formElem].length != "undefined") { 
			// either radio or select
			if ((typeof document.myform[formElem].type != "undefined")&&(document.myform[formElem].type.indexOf('select')!=-1)) { 
				// select
				document.myform[formElem].disabled=false;
				document.myform[formElem].style.background="#FFFFFF";
			} else {
				// radio - iterate over the whole array or just one?
				if (arguments.length > 1) { // if specific, the index will be passed as a second argument to the function
					document.myform[formElem][arguments[1]].disabled=false;
				} else {
					for (var i=0;i<document.myform[formElem].length;i++) {
						document.myform[formElem][i].disabled=false;
					}
				}
			}
		} else {
			document.myform[formElem].disabled=false;
			// is it a text field, textarea or password? 
			if ((typeof document.myform[formElem].type != "undefined")&&((document.myform[formElem].type.indexOf('text')!=-1)||(document.myform[formElem].type.indexOf('password')!=-1))) { 
				document.myform[formElem].style.background="#FFFFFF";
			}
		}
		
	}
}

function applyOpacityStyle(elem) {
	/* pjc 28 July 2009 */
	// generic function to apply opacity filter to a passed in DOM element
	var myElem=document.getElementById(elem)

	if (myElem) {
		myElem.style.opacity="0.35";
		myElem.style.filter="alpha(opacity=35)";
	}
}
function disableOnLoad() {
	if ('#(itemNameID)#' == 'CREATE') {	
		disableMe('selCODitem');
		applyOpacityStyle('butCreateNew');
		enableMe('txtDescription');
		document.forms[0].txtDescription.focus();
	}
}

function popup(type) {
	// save first
	document.forms[0].gotoPage.value = 'fileUploadDetails.csp';
	document.forms[0].submit();
	
	var theURL='#(..Link("codQuestionHTML.csp?dataID="_dataID))#'

	// calculate where to open popup window
	var width = 750;
	var height = 450;
	var myLeft = (screen.width) ? (screen.width-width)/2 : 0;
	var myTop = (screen.height) ? (screen.height-height)/2 : 0;
	var left = myLeft;
	var top = myTop;
	
	myWindow = window.open(theURL,"LekOchLars",'location=no,screenX=' + left + ',screenY=' + top + ',top=' + top + ',left=' + left + ',directories=no,status=no,menubar=no,scrollbars=no,resizable=yes,hotkeys=no,toolbar=no,width=750,height=450');
	myWindow.focus();
}
	// disable all field on load new
	disableOnLoad();
</script>

<csp:include page="../../backend/home/backendBottom.csp">
]]></CSP>


<CSP name="backEnd/proweb/fileUploadDetails2.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">			// Fred April 2010 - in-page editing
			//set %response.Redirect=%request.Get("templateURL") // after save
			 set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))

	set xEventID=$G(%session.Data("eventsforce","backend","xEventID"))
	set xUserID=$G(%session.Data("eventsforce","backend","xPersonID"))
	set xControllerID=""
	if xEventID	{
		set xControllerID=##class(setup.objEvent).getControllerID(xEventID)
		set xLangID=$G(%session.Data("eventsforce","backend","xLangID"))
		set xLanguage=$G(%session.Data("eventsforce","backend","xLanguage"))
	}

	set dataID=%request.Get("dataID")
	set itemNameID=%request.Get("itemNameID")
	set parent=%request.Get("parent")
	set pageID=$G(%session.Data("pageID"))
	set mandatory=%request.Get("chkMandatory")
	set backendOnly=%request.Get("chkBackendOnly")
	set pageName=""
	&SQL(SELECT description INTO :tmp FROM sc_xModules.objPage WHERE ID = :pageID)
	if +SQLCODE=0 set pageName=tmp
	
	set addToTop=%request.Get("addToTop")
	set addToTop=$S(addToTop="true":1,1:0)
	
	set minFileSize=+%request.Get("txtMinFileSize")
	
	set maxFileSize=+%request.Get("txtMaxFileSize")
	if maxFileSize<1 {
		set %session.Data("proweb","backend","errMsg")=..out("Please give a value for the maximum file size.")
		set %response.Redirect="fileUploadDetails.csp"
		quit 0
	}
	
	if maxFileSize>5120 {
		set %session.Data("proweb","backend","errMsg")=..out("The maximum file size must not be greater than 5120 kB (5 MB).")
		set %response.Redirect="fileUploadDetails.csp"
		quit 0
	}

	if maxFileSize<minFileSize {
		set %session.Data("proweb","backend","errMsg")=..out("The maximum file size must not be smaller than the minimum file size.")
		set %response.Redirect="fileUploadDetails.csp"
		quit 0
	}
	
	
	set allowedFileTypes=""
	set item=""
	for  {
		set item=$o(%request.Data(item))
		if item="" quit
		if item["chkFileType_",%request.Get(item) {
			set fileType=$p(item,"chkFileType_",2)
			if ##class(shared.fileMethods).isAllowedExt(fileType) {
				set allowedFileTypes=allowedFileTypes_fileType_","
			}
		}
	}
	if '$l(allowedFileTypes) {
		set %session.Data("proweb","backend","errMsg")=..out("You must define which file types are allowed.")
		set %response.Redirect="fileUploadDetails.csp"
		quit 0
	}
	
	set isGuest=(%request.Get("radDelegateOrGuest")="guest")
	set isDelegate='isGuest

	set dependsOnPrompt=%request.Get("selDependsOnDataID")
	if dependsOnPrompt {
		if isDelegate {
			set isDependentParentForGuests=##class(sc.methods).isGuestItem(dependsOnPrompt)
			if isDependentParentForGuests {
				set %session.Data("proweb","backend","errMsg")=..out("You cannot make an attendee prompt dependent on a guest prompt")
				set %response.Redirect="fileUploadDetails.csp"
				quit 0
			}
		}
	}
	
	set email=##class(cod.objItemData).get($G(%session.Data("eventsforce","backend","xPersonID")),"email")
	if dataID="NEW" {
		if itemNameID="CREATE" {
			// new data and new cod
			set description=%request.Get("txtDescription")
			
			if $G(%session.Data("templateURL"))["tAdditionalRegistration.csp"  {
				// add the page name to the cod prompt if we are doing additional registration pages
				 &SQL(SELECT description INTO :pageName FROM sc_xModules.objPage WHERE ID = :pageID)				
				 set description=pageName_"|"_description
			}

			set errMsg=""
			// make sure it doesn't exist already
			if '##class(cod.objItemName).isNameValidForNewCrossEventQuestion(description,.tmpMsg) {
				set errMsg=tmpMsg
			}
			 
			if $l(errMsg) {
				set %session.Data("proweb","backend","errMsg")=errMsg
				set %response.Redirect="fileUploadDetails.csp"
				quit 0		
			}
			
			// create new proweb item
			set itemNameID=##class(cod.objItemName).add(description,mandatory,"fileupload","",0,1,%request.Get("chkCarryOver"),"",0,1,1)
			
			// log it to the event audit trail
			if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Added new database item: "_description)
		}	
			
		// new data and existing file upload
		set dataID=##class(sc.xModules.objFileUpload).add(itemNameID,%request.Get("txtPrompt"),parent,email,addToTop,%request.Get("txtHelpText"),mandatory,backendOnly,minFileSize,maxFileSize,allowedFileTypes,isDelegate,isGuest)
		if 'dataID {
			set %session.Data("proweb","backend","errMsg")=..out("Unable to create data item.")
				set %response.Redirect="fileUploadDetails.csp"
				quit 0
		}
		// log it to the event audit trail
		set tmpDesc=##class(cod.objItemName).getDescFromID(itemNameID)
		if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Added new File Upload: "_%request.Get("txtPrompt")_" ("_tmpDesc_"), "_$S(mandatory:"Mandatory",1:"Not Mandatory"))
		
		
		// Add new, dependend children right underneath their parent
		set dependsOnPrompt=%request.Get("selDependsOnDataID")
		if dependsOnPrompt {
			&SQL(SELECT displayOrder,parent INTO :parentDisplayOrder,:parentID FROM sc_xModules.objFileUpload WHERE ID = :dependsOnPrompt)
			if +SQLCODE=0,dataID {
				set lastPos=parentDisplayOrder
				
				// find the last dependend child
				&SQL(SELECT displayorder INTO :lastChild FROM sc_xModules.objFileUpload WHERE (dependsOnPrompt = :dependsOnPrompt)  AND (active=1) ORDER BY displayOrder DESC)
				if +SQLCODE=0 set lastPos=lastChild
				
				// move all the subsequent items one step down
				&SQL(UPDATE sc.objData SET displayOrder = displayOrder+1 WHERE (parent = :parentID) AND (displayOrder > :lastPos))
				
				// move the new item to right after the parent	
				&SQL(UPDATE sc_xModules.objFileUpload SET displayOrder = :lastPos + 1 WHERE ID = :dataID)
			}
		} else {
			do ##class(sc.objData).moveNewElementToDesiredPosition(dataID)	
		}
	} else {  
		// existing objData
		if itemNameID="NEW" {
			// don't allow this
					
		} else {
			// existing cod item
			set layout=%request.Get("radLayout")
			if layout="" set layout="horizontal"
			set mandatory=%request.Get("chkMandatory")
			// make multiple checkboxes that have a minimum number of checks mandatory
			if %request.Get("multiCheckboxMin") set mandatory=1	

			set ok=##class(sc.xModules.objFileUpload).update(dataID,%request.Get("txtPrompt"),email,%request.Get("txtHelpText"),mandatory,backendOnly,minFileSize,maxFileSize,allowedFileTypes,isDelegate,isGuest)

			// log to event audit trail
			if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Saved Registration Question: "_%request.Get("txtPrompt")_", "_%request.Get("selType")_", "_$S(mandatory:"Mandatory",1:"Not Mandatory"))
		}
	
	}

	// store the depencies
	set dependsOnPrompt=%request.Get("selDependsOnDataID")
	set dependsOnAlternative=%request.Get("selDependsOnCodAltID")
	if ('dependsOnAlternative || 'dependsOnPrompt) {
		set (dependsOnAlternative,dependsOnPrompt)=""
	}
	&SQL(UPDATE sc_xModules.objFileUpload SET dependsOnPrompt = :dependsOnPrompt,dependsOnAlternative = :dependsOnAlternative WHERE ID = :dataID)
	
	if ##class(setup.objSystemTypes).isModuleAllowed("Attendee Categories")	{
		// kill all category links and save
		// - do this in method so it can compile without class
		do ##class(links.lnkEventCategoryData).deleteAllForOne(dataID)
		set item=""
		for  {
			set item=$o(%request.Data(item))
			if item="" quit
			if item["chkEventCategory" {
				set eventCategoryID=$P(item,"_",2)
				set ok=##class(links.lnkEventCategoryData).add(eventCategoryID,dataID)
			}
		}
	}
	
	// always make it published if we are doing document manamenmt
	if %session.Data("proweb","isDOC") {
		set step=##class(sc.objStep).getFinalLevel()
		do ##class(sc.objData).approve(dataID,step)
	}
	
	set %session.Data("itemNameID")=itemNameID
	
	// Fred April 2010 - in-page editing
	 set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))
	
	if %request.Get("popupURL")'="" {
		set %session.Data("eventsforce","backend","popupURL") = %request.Get("popupURL")
	}
	
	if %request.Get("gotoPage")'="" {
		set %response.Redirect=%request.Get("gotoPage")
	}
	if %request.Get("backPage")'="" set %response.Redirect=%request.Get("backPage") // used from eventsForce/registraionDetails.csp
	
	set %response.Redirect=%response.Redirect_$S(%response.Redirect["?":"&",1:"?")_"mode=edit"
	
	quit 0
</script>
]]></CSP>


<CSP name="backEnd/proweb/flashDetails.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<csp:include page="../../backend/home/backendTop.csp?hideBackendMenu=1">
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	// rediredct to button page if we are editing a submit button
	if $ZCVT(%request.Get("componentName"),"U")["SUBMIT" {
		set %response.ServerSideRedirect="submitButtonDetails.csp"
		quit 0
	}
	
	set quitFlag=##class(sc.objData).reuseLogic("objFlash")
	quit quitFlag
</script>
<style>
	#hideMe {
		visibility : hidden;
		position : absolute;
		left : 0px;
		top : 0px;
	}
</style>
<script language="cache" runat="server">
	set dataID=%request.Get("dataID")
	if dataID="" set dataID=%session.Get("dataID")
	set %session.Data("dataID")=dataID
	
	do ##class(sc.objData).saveDesiredPositionFromRequestToSession(%request, %session)
	
	set orgDataID=%request.Get("orgDataID") // used when creating a new version of a data item
	if orgDataID="" set orgDataID=%session.Get("orgDataID")
	set %session.Data("orgDataID")=orgDataID

	set classNo=%request.Get("classNo")
	if classNo="" set classNo=%session.Get("classNo")
	set %session.Data("classNo")=classNo
	
	set templateURL=%request.Get("templateURL")
	if templateURL="" set templateURL=%session.Get("templateURL")
	set %session.Data("templateURL")=templateURL

	set templateID=%request.Get("templateID")
	if templateID="" set templateID=%session.Get("templateID")
	set %session.Data("templateID")=templateID
	
	set displayOrder=%request.Get("displayOrder")
	if displayOrder="" set displayOrder=%session.Get("displayOrder")
	set %session.Data("displayOrder")=displayOrder

	set addToTop=%request.Get("addToTop")
	if addToTop="" set addToTop=%session.Get("addToTop")
	set %session.Data("addToTop")=addToTop
	
	set xEventID=$G(%session.Data("eventsforce","backend","xEventID"))	
	
	// check if the event is using a template that is AA complient, if so, disable the legacy mode
	&SQL(SELECT layoutObjTemplate->accessibilityLevel INTO :tmp FROM setup.objEvent WHERE ID = :xEventID)
	set accessibilityLevel=tmp
</script>
<csp:object name="objData" classname="sc.objData" objid="#(dataID)#">
<script language="cache" runat="server">

	// So that the correct eventID is used in the file upload
	set %session.Data("eventsforce","frontend","xEventID")=xEventID
	set (currentPath,componentName,parent,componentName,fileName,mouseOverFileName,altText,titleText,border,width,height,loop)="" 
	
	if +dataID {
		set parent=objData.parent
		set parentID=objData.parent.%Id()
	} else {
		set parent=%request.Get("parent")
		if parent="" set parent=%session.Get("parent")
		set %session.Data("parent")=parent
		set parentID=parent
	}
	
	//set currentPath=##class(sc.objData).getPath(parent,0)
	set currentPath=##class(sc.objData).getPath(dataID,0)

	// get the data if we are editing
	if dataID {
		set fileNameNew=objData.fileNameNew
		set width=objData.width
		set height=objData.height
		set description=objData.description
		set loop=objData.loop
		&SQL(SELECT description INTO :componentName FROM sc.objComponent WHERE (objData = :dataID) )
		set fileName=$p(fileNameNew,"sc.objData_"_dataID_"_",2)
	}
	
	// get selected page from page browser
	if %request.Get("selectedPage")'="" {
		set URL="pageID="_%request.Get("selectedPage")
	}
		
	if border="" set border=0
	
	set componentName=%request.Get("componentName")
	if componentName="" set componentName=%session.Get("componentName")
	set %session.Data("componentName")=componentName

	if (componentName="")&(dataID'="") {
		&SQL(SELECT description INTO :componentName FROM sc.objComponent WHERE objData = :dataID)
	}
	
	// Show error messages from the save
	if %session.Get("errorMessage")'="" {
		write !,"<scr"_"ipt language='javasc"_"ript'>alert('",%session.Data("errorMessage"),"');</scr"_"ipt>"
		if %session.Data("errorMessage")?1"Error. Data cannot be saved.".E {	
			write !,"<scr"_"ipt language='javasc"_"ript'>top.location='login.csp';</scr"_"ipt>"
		}
		kill %session.Data("errorMessage")
	}

	// Set the this page as return page  from the upload
	set %session.Data("afterUpload")=..Link("../../backend/proweb/flashDetails.csp")
	
	//Conditional for Youtube video
    set isVideo = 0, pageTitle = "Flash", validationFunc = "validateFormFlash"
    if %request.Get("isVideo") '= "" {
	     set isVideo = 1, pageTitle = "YouTube", validationFunc = "validateFormVideo", fileNameNew=""
	     if 'dataID set width = 600, height = 360
    }
    if dataID {	    
    	if fileNameNew [ "http://www.youtube.com/v/" set isVideo = 1, pageTitle = "YouTube", validationFunc = "validateFormVideo"       	
    } 
</script>
<form method="post" action="flashDetails2.csp" name="myForm" onsubmit="return #(validationFunc)#(this);">

<style>
table {margin-left:0px;margin-right:0px;padding-left:24px;padding-right:24px;}
table table {padding-left:0px;padding-right:0px;}
</style>

<div class="contentarea_in_popup">
	<div class="contentbox">
	<h2>Edit #(pageTitle)# Item</h2>

                            <table width="100%" border="0" cellspacing="0" cellpadding="0">                                                  	
							<csp:if condition=(isVideo=0)>
                                <tr>
                                    <td class="blackbold10px" height="40" width="25%" align="right">Component Name:</td>
                                    <td height="20" width="2%">&nbsp;</td>
                                    <td class="REDBOLD10px" height="20" width="73%">#(componentName)#
                                </tr>
								<tr><td height=5></td></tr>
                                <tr>
                                    <td class="blackbold10px" width="25%" align="right" valign='top'>File Name:</td>
                                    <td width="2%">&nbsp;</td>
                                    <td class="black10px" valign="top">
                                        <input type="text" name="txtFileName" id="txtFileName" value="#(fileName)#" size="40" readonly class="black10px" style="background-color: Silver;">
		                                <input type="hidden" name="hasHiddenImage" value=0>
			                            <br>
            			                <a href="javascript: saveData('#(dataID)#','fileNameNew');" class="ef_hyperlink">Upload File</a>
										<csp:if condition=((fileName'="")&(dataID'="NEW"))>&nbsp;|&nbsp;<a href="javascript: removeImage('fileName');">Remove File</a></csp:if>
									</td>
                                </tr>
								<csp:if condition=((fileName'="")&(dataID'="NEW"))>
									<tr>
	                                    <td class="blackbold10px" height="15" width="25%" align="right" valign="top"><br>
	                            		</td>
	                                    <td height="30" width="2%">&nbsp;</td>
	                                </tr>
									<tr>
										<td class="blackbold10px" height="30" width="25%" align="right"></td>
	                                    <td height="30" width="2%">&nbsp;</td>
										<td class="black10px"  valign="top">
											<table>
												<tr>
													<td>
														<div style="border:solid 1px #000000; width=#(objData.width)#; height=#(objData.height)#;">
					                                       <object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=5,0,0,0" width="#(objData.width)#" height="#(objData.height)#"> 
																<param name=movie value="#(objData.fileNameNew)#">
																<param name=quality value=high>
																<param name=loop value="#($S(objData.loop:"true",1:"false"))#">
																<param name="menu" value="false">
																<embed src="#(objData.fileNameNew)#" quality=high pluginspage="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash" type="application/x-shockwave-flash" loop=#($S(objData.loop:"true",1:"false"))# width="#(objData.width)#" height="#(objData.height)#">
																</embed>
															</object>
														</div>
													</td>
												</tr>
											</table>
										</td>
									</tr>
								</csp:if>
							</csp:if>
							
							<csp:if condition=(isVideo=1)>
								<tr><td height=30></td></tr>							
								<tr>
                                    <td class="blackbold10px" width="25%" align="right" valign='top'>Youtube video url:</td>
                                    <td width="2%">&nbsp;</td>
                                    <td class="black10px" valign="top">
                                        <input type="text" name="txtFileName" id="txtFileName" value="#(fileNameNew)#" size="60" class="black10px">
		                                <input type="hidden" name="hasHiddenImage" value=0>
			                        </td>
                                </tr>								
							</csp:if>
							
                                <tr>
                                    <td class="blackbold10px" height="30" width="25%" align="right" valign="top"><br>
                            		</td>
                                    <td height="30" width="2%">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="blackbold10px" height="30" width="25%" align="right">Width:</td>
                                    <td height="30" width="2%">&nbsp;</td>
                                    <td class="black10px" height="30" width="73%">
                                        <input type="text" name="txtWidth" value="#(width)#" size="5" class="black10px" style="text-align:right;">
										&nbsp;pixels
									</td>
                                </tr>
                                <tr>
                                    <td class="blackbold10px" height="30" width="25%" align="right">Height:</td>
                                    <td height="30" width="2%">&nbsp;</td>
                                    <td class="black10px" height="30" width="73%">
                                        <input type="text" name="txtHeight" value="#(height)#" size="5" class="black10px" style="text-align:right;">
										&nbsp;pixels
									</td>
                                </tr>
								<tr>
                                    <td class="blackbold10px" height="30" width="25%" align="right">Loop:</td>
                                    <td height="30" width="2%">&nbsp;</td>
                                    <td class="black10px" height="30" width="73%">
                                        <input type="radio" name="radLoop" value="1" #($S(loop'=0:"checked",1:""))#>
										&nbsp;Yes&nbsp;&nbsp;&nbsp;&nbsp;
										<input type="radio" name="radLoop" value="0" #($S(loop=0:"checked",1:""))#>
										&nbsp;No&nbsp;&nbsp;&nbsp;&nbsp;
									</td>
                                </tr>
								<csp:if condition=(accessibilityLevel="AA")>
									<tr>
										<td colspan=99 align="center" class="redbold10px">
											<tx>Please note that this event is using a template that is marked with 'AA' standard accessability.</tx>
											<br>
											<tx>It is not recommended to use flash on sites that are optimised for accessability.</tx>
										</td>
									</tr>
								</csp:if>	
					            <tr>
						            <td width="25%" height="15">&nbsp;</td>
                                    <td height="15" width="2%">&nbsp;</td>
                                    <td height="15" width="73%">&nbsp;</td>
                                </tr>
					
				            </table>

	</div><!-- end of contentbox -->
</div><!-- end of contentarea -->

<div class="topsave_in_popup">
	<a href="javascript:cancelUpdate();"><img name="butSave" src="../../media/images/english/default/backend/back.gif" alt="Quit" border="0"></a>
	<csp:if condition=(##class(sc.objData).inMail(parent))>
	<csp:else>
		<script language="cache" runat="server">
			set userID=%session.Get("xUserID"),myStepOrder=""
			&SQL(SELECT approvalStep INTO :tmp FROM admin.objUser WHERE ID = :userID)
			if +SQLCODE=0 set myStepOrder=tmp
		</script>
		<csp:comment><!-- ONly display the publish butto if you have access rights--></csp:comment>
		<csp:if condition="myStepOrder>1">
			<a href="javascript: publish();"><img name="butPublish" src="../media/buttons/button_approve.gif" alt="Publish" border="0" title="Save and publish this version. Any current version will be archived."></a>
		</csp:if>
	</csp:if>
	<input type="image" name="butSave" src="../../media/images/english/default/backend/save.gif" alt="Save" border="0">
</div>

<input type="hidden" name="imageHeight" value="">
<input type="hidden" name="imageWidth" value="">
<input type="hidden" name="txtImageProp" value="">
<input type="hidden" name="txtGotoPage" value="">
<input type="hidden" name="displayOrder" value="#(%request.Get("displayOrder"))#">
<input type="hidden" name="templateID" value="#(templateID)#">
<input type="hidden" name="parent" value="#(parent)#">
<input type="hidden" name="componentName" value="#(componentName)#">
<input type="hidden" name="templateURL" value="#(templateURL)#">
<input type="hidden" name="dataID" value="#(dataID)#">
<input type="hidden" name="addToTop" value="#(addToTop)#">										
<input type="hidden" name="orgDataID" value="#(orgDataID)#">
<input type="hidden" name="cancelUpdate" value=0>
<input type="hidden" name="isVideo" value=#(isVideo)#>


<script language="javascript">

function validateFormFlash(){
	var fileName = document.getElementById('txtFileName');
	if(fileName.value == '') { 		
		alert('Please, upload a Flash item');
		return false;	
	}	
}

function validateFormVideo(){
	var fileName = document.getElementById('txtFileName');
	if(fileName.value == '') { 
		fileName.focus();
		alert('Please enter the URL to your Youtube video');
		return false;	
	}	
	else
	{
		var file = fileName.value;
		var matches = file.match(/http(?:s)?:\/\/(?:www\.)?youtube.*watch\?v=([a-zA-Z0-9\-_]+)/);
		var matches1 = file.match(/http(?:s)?:\/\/(?:www\.)?youtube.*\/v\/([a-zA-Z0-9\-_]+)/);
		var matches2 = file.match(/http(?:s)?:\/\/youtu.be.([a-zA-Z0-9\-_]+)/);
		
		if (matches) {
			vPosIni = file.indexOf('v=')+2;
		    vPosEnd = file.indexOf('&');
		    if(vPosEnd < 0) { vPosEnd = file.length; }
		    videoCode = file.substr(vPosIni,vPosEnd-vPosIni);
		    fileName.value = '//www.youtube.com/v/'+videoCode+'?fs=1&amp;hl=en_GB';	
		} else if (matches2) {
			vPosIni = file.indexOf('.be/')+4;
		    vPosEnd = file.indexOf('&');
		    if(vPosEnd < 0) { vPosEnd = file.length; }
		    videoCode = file.substr(vPosIni,vPosEnd-vPosIni);
		    fileName.value = '//www.youtube.com/v/'+videoCode+'?fs=1&amp;hl=en_GB';	
			
		} else if (!matches1) {					
		    alert('Please enter a valid #(pageTitle)# URL');
		    return false;			    
		}			    
								
	}
	return true;
}

function publish() {
	if (confirm("Are you sure that you want to approve this version?\nThe current version will be archived.") == true) {
		document.myForm.publish.value="yes"
		document.myForm.submit(); // save the data first
	}
}


function saveData(dataID,prop) {
	document.myForm.txtImageProp.value = prop;
	document.myForm.txtGotoPage.value = 'upload';
	document.myForm.submit();
}

function removeImage(prop) {
	document.myForm.txtImageProp.value = prop;
	document.myForm.txtGotoPage.value = 'remove';
	document.myForm.submit();
}



function browseInternal() {
	document.forms[0].txtGotoPage.value='#(%request.PageName)#';
	document.forms[0].submit();
	
	window.open('pageBrowser.csp',"LekOchLars",'location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,hotkeys=no,toolbar=no,width=640,height=500');
}
function pwOpenWin(theURL,theName,theWidth,theHeight) {
	var myLeft = window.screenLeft;
	var myTop = window.screenTop;
	if (myLeft == null) {
		myLeft=window.pageXOffset;
		myTop=window.pageYOffset;
	}
	var left = myLeft +250 ;
	var top = myTop + 50;
	if (typeof theWidth == 'undefined') theWidth="600"
	if (typeof theHeight == 'undefined') theHeight="500"
  	eval(theName + " = window.open(theURL,theName,'location=no,screenX=' + left + ',screenY=' + top + ',top=' + top + ',left=' + left + ',directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,hotkeys=no,toolbar=no,width=' + theWidth + ',height=' + theHeight)");
	eval(theName + ".focus()");
}

// Need to go to de-activate the image if we have just created it. 
function cancelUpdate() {
	document.myForm.cancelUpdate.value = 1
	document.forms[0].submit();
}
</script>
</form>
<csp:include page="../../backend/home/backendBottom.csp">
]]></CSP>


<CSP name="backEnd/proweb/flashDetails2.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	
	// check if we have lost the userID due to a session switch in flash, if so get it back from the cookie created in login2.csp
	if %session.Get("xUserID")="" set %session.Data("xUserID")=%request.GetCookie("xUserID")
	set userID=%session.Get("xUserID")

	// abort if we cant find a user, just to ensure database integrity
	if %session.Get("xUserID")="" {
		set %session.Data("errorMessage")="Error. Data cannot be saved. User Id cannot be found.\nPlease try again after a new logon"
		set %response.Redirect="flashDetails.csp"
		quit 0
	}
	new objData,objComponent

	set dataID=%request.Get("dataID")
	
	// if they have clicked the cancel button
	if %request.Get("cancelUpdate") {
		// Fred April 2010 - in-page editing
		//set %response.Redirect=%request.Get("templateURL") // after save
		 set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))
		quit 0
	}
	
	set %session.Data("dataID")=dataID
	set orgDataID=%request.Get("orgDataID")
	set parent=%request.Get("parent")
	set templateID=%request.Get("templateID")
	set componentName=%request.Get("componentName")
	set URL=%request.Get("txtURL")


	set displayOrder=%request.Get("displayOrder")
	if displayOrder="" set displayOrder=%session.Get("displayOrder")

	// validate that the called page exists
	if $ZCVT(URL,"U")?1"PAGEID=".E {
		// make it case insensitive
		set URL="pageID="_$p(URL,"=",2)
		
		// make sure it exists
		set tmp=$p(URL,"=",2)
		set tmp=$p(tmp,"#",1)
		set tmp=$p(tmp,"&",1)
		if '##class(sc.objData).%ExistsId(tmp) {
			set %session.Data("errorMessage")="pageID does not exist"
			set %response.Redirect="flashDetails.csp"
			quit 0
		}
		
		// make sure it is a page
		set dataType=""
		&SQL(SELECT dataType INTO :dataType FROM sc.objData WHERE ID = :tmp)
		if dataType'="objPage" {
			set %session.Data("errorMessage")="pageID is not pointing to a page. \nIt is pointing to a "_dataType
			set %response.Redirect="flashDetails.csp"
			quit 0
		}
	}	
	
		
	// validate that the called anchor exists
	if $ZCVT(URL,"U")?1"DATAID=".E {
		// make it case insensitive
		set URL="dataID="_$p(URL,"=",2)
		
		// make sure it exists
		set (tmpdataID,tmp)=+$p(URL,"=",2)
		
		if '##class(sc.objData).%ExistsId(tmp) {
			set %session.Data("errorMessage")="dataID does not exist"
			set %response.Redirect="flashDetails.csp"
			quit 0
		}
		
		// make sure it is a valid type
		set dataType=""
		&SQL(SELECT dataType INTO :dataType FROM sc.objData WHERE ID = :tmp)
		if "objPage,objGroup"[dataType {
			set %session.Data("errorMessage")="dataID is not pointing to a valid item. \nIt is pointing to a "_dataType
			set %response.Redirect="flashDetails.csp"
			quit 0
		}
		
		//find out the page of the data ID and add it to the link
		set tmpPageID=##class(sc.objData).getPageID(tmpDataID)
		set URL="pageID="_tmpPageID_"#dataID="_tmpDataID
	}	
	
	set debugDataID=dataID
	if dataID="NEW" {
		// create new image object
		set objData=##class(sc.xModules.objFlash).%New()
		
		// parent
		do objData.parentSetObjectId(parent)
		
		set objData.active=1
		
		set user="unknown"
		if %session.Get("xUserID")'="" {
			set objUser=##class(admin.objUser).%OpenId(%session.Get("xUserID"))
			set user=objUser.email
			do objUser.%Close()
		}
		set objData.creator=user
		
		do objData.%Save()
		set dataID=objData.%Id()
		set %session.Data("dataID")=dataID
		
		// link to the previous version
		if orgDataID'=""&(orgDataID'="NEW")&(orgDataID'="ADD") {
			do objData.previousVersionSetObjectId(orgDataID)

			// and link the previous to me
			//&SQL(UPDATE sc.objData SET nextVersion = :dataID WHERE ID = :orgDataID)
			set tempObj=##class(sc.objData).%OpenId(orgDataID)
			do tempObj.nextVersionSetObjectId(dataID)

			// copy the previous image to this version
			do objData.fileStream.CopyFrom(tempObj.fileStream)
			set objData.fileName=tempObj.fileName
			do objData.mouseOverFileStream.CopyFrom(tempObj.mouseOverFileStream)
			set objData.mouseOverFileName=tempObj.mouseOverFileName
			
			do tempObj.%Save()
			do tempObj.%Close()
		}
		
		// create new component object if we didn't have an predecessor
		if (orgDataID="")!(orgDataID="NEW")!(orgDataID="ADD") {
			if objData.parent.dataType'="objList",objData.parent.dataType'="objScrollingImage" {

				set objComponent=##class(sc.objComponent).%New()
				set objComponent.description=componentName
				do objComponent.objTemplateSetObjectId(templateID)
				do objComponent.objDataSetObjectId(dataID)
				do objComponent.%Save()
				do objComponent.%Close()
			}
		}
		// set a displayOrder if my parent is a List
		if (objData.parent.dataType="objList")!(objData.parent.dataType="objScrollingImage") {
			if +displayOrder=0 {
				if orgDataID="ADD" { // meaning that we are adding an item to the list
				
					
					if %session.Get("addToTop")="false" { // add to the top of the list
						set tmp=""
						&SQL(SELECT displayOrder INTO :tmp FROM sc.objData WHERE parent = :parent ORDER BY displayOrder DESC)
						set objData.displayOrder=(tmp+1)
						set %session.Data("displayOrder")=(tmp+1)
						
					} else { // add to the bottom of the list
						// increment everybodys displayorder with one before adding this one as number one
						&SQL(UPDATE sc.objData SET displayOrder = (displayOrder+1) WHERE parent = :parent)
						set objData.displayOrder=(1)
						set %session.Data("displayOrder")=(1)
					}
					
					// kill the addToTop not to confuse later saves
					kill %session.Data("addToTop")
					
				} else {  // meaning that we are adding a version to one of the list items
					set objData.displayOrder=objData.previousVersion.displayOrder  // use the same as previous version
				}
			} else { // set the passed in displayOrder if we are adding a column to an existing row
				set objData.displayOrder=displayOrder
			}
		}
		
		// add my new ID to the list of sibling if my dad was a list
		if objData.parent.dataType="objList" {
			if displayOrder>0 {
				new orgSibling
				set orgSibling=%session.Get("siblings"_displayOrder)
				set classNo=%session.Get("classNo")
				set pis=$p(orgSibling,"|",classNo)
				set $p(pis,"=",2)=dataID
				set $p(orgSibling,"|",classNo)=pis
				set %session.Data("siblings"_displayOrder)=orgSibling
			}
		}	
				
		 // audit trail
		 set comments="created"
		 &SQL(INSERT INTO sc.objAuditTrail (description,objData,objUser) VALUES (:comments,:dataID,:userID))
			
    	 do ##class(sc.objData).moveNewElementToDesiredPosition(dataID)	
		 
	} else {
		// open existing
		set objData=##class(sc.objData).%OpenId(dataID)

		 // audit trail
		 set comments="amended"
		 &SQL(INSERT INTO sc.objAuditTrail (description,objData,objUser) VALUES (:comments,:dataID,:userID))
	}
	
	// set the approval level to START for both new and existing items
	set step=""
	&SQL(SELECT ID INTO :step FROM sc.objStep WHERE stepOrder=1)
	do objData.objStepSetObjectId(step)

	// Send notification emails unless we are editing a bottom level item
	set targetLevel=1 
	if objData.objStep.stepOrder>1 do ##class(sc.objData).sendApprovalEmail(dataID,targetLevel)
	
	// add or remove the popup nvp (v3.5)
	if $ZCVT(URL,"L")[".csp"	{  // only for eventsforce links
		set urlTarget=$ZCVT(%request.Get("selTarget"),"L")
		if URL["?" {
			set firstbit="&"
		} else {
			set firstbit="?"
		}
		if urlTarget="new window"	{
			if URL["popup=0" {
				set URL=$P(URL,"popup=0",1)_"popup=1"_$P(URL,"popup=0",2)  // replace with zero to avoid issues with ? &
			} elseif URL'["popup=1" {
				set URL=URL_firstbit_"popup=1"
			}
		} else {
			if URL["popup=1" set URL=$P(URL,"popup=1",1)_"popup=0"_$P(URL,"popup=1",2)  // replace with zero to avoid issues with ? &
		}
	}
	
	// The properties	
	set isVideo = %request.Get("isVideo")	
	if isVideo = 1 set objData.fileNameNew=%request.Get("txtFileName")	
	set objData.width=%request.Get("txtWidth")
	if objData.width=0 set objData.width=""
	if objData.width="" & isVideo = 1 set objData.width=600
	set objData.height=%request.Get("txtHeight")
	if objData.height=0 set objData.height=""
	if objData.height="" & isVideo = 1 set objData.height=360
	set objData.streamHeight=%request.Get("imageHeight")
	set objData.streamWidth=%request.Get("imageWidth")
	
	if $l(%request.Get("radLoop")) {
		set objData.loop=%request.Get("radLoop")
	}
		
	set ok=objData.%Save()

	do objData.%Close()
	if (orgDataID="")&(debugDataID="NEW")&($G(^xfg("z",4,"save"))'?1.N) {
		set %session.Data("errorMessage")="Error while saving new object.\nNo component created"
		set %response.Redirect="flashDetails.csp" 
		quit 0
	}

	if %request.Get("txtGotoPage")="upload" {
		// or have we just save before we are uploading an image

		// are we doing emails or static pages_ If so, upload files - not streams
		// always upload files
		set stream=0
		/*
		if ##class(sc.objData).inMail(dataID) set stream=0	
		if ##class(sc.objData).inStatic(dataID) set stream=0	
		*/
		if stream=0 {
			set fileProp=%request.Get("txtImageProp")
			set %response.Redirect="../../backend/home/uploadFile.csp?allowOverwrite=1&title=upload&className=sc.objData&descPropertyName="_fileProp_"&objectID="_dataID_"&isImage=1"
		} else {
			// or do a streambased upload in any other case
			set fileProp="fileName"
			set streamProp="fileStream"
			if %request.Get("txtImageProp")["mouseOver" {
				set fileProp="mouseOverFileName"
				set streamProp="mouseOverFileStream"
			}
			set %response.Redirect="../../backend/home/uploadStream.csp?title=upload&streamPropertyName="_streamProp_"&descPropertyName="_fileProp_"&objectID="_dataID_"&className=sc.xModules.objImage"
		}
		
	} elseif %request.Get("txtGotoPage")="remove" {
		// remove image
		set %response.Redirect="flashDetailsRemove.csp?prop="_%request.Get("txtImageProp")
		
	} else {
		// Always autopublish if we are writing an email
		if ##class(sc.objData).inMail(dataID) {
			set %response.Redirect="publish.csp"
		} else {
			// or just go back to where we came from			
			if isVideo = 1 {
				set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))			
				quit 0
			}
			else
			{
				set %response.Redirect="flashDetails.csp" 
			}
			
		}
	}
	quit 0
</script>
]]></CSP>


<CSP name="backEnd/proweb/formDivider.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	do ##class(sc.objData).saveDesiredPositionFromRequestToSession(%request, %session)
	set dataID = ##class(sc.xModules.objFormDivider).add(%request.Get("parent"),%request.Get("position"))
	do ##class(sc.objData).moveNewElementToDesiredPosition(dataID)
	set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))			
				
	quit 0
</script>
]]></CSP>


<CSP name="backEnd/proweb/quickEditAJAX.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="cache" runat="server">
	#dim prowebItem as sc.xModules.objCODitem
	set contextData = ##class(EF.contextDataRegistration).createFromFrontendCSPSession()
	set prowebID = %request.Get("prowebID") 
	if 'prowebID {
		throw ##class(shared.exceptions.generalException).%New("No prowebID passed in")
	}
	set prowebItem = ##class(sc.objData).%OpenId(prowebID)
	if '$IsObject(prowebItem) {
		throw ##class(shared.exceptions.generalException).%New("Incorrect prowebID passed in: "_prowebID)
	}
	set pageID = ##class(sc.objData).getPageID(prowebID)
	set labelText = ##class(sc.xModules.objCODitem).getQuestionPrompt(prowebID,contextData.languageID)
	
	if "text,emailAddress,phoneNumber,webAddress,integer" [ prowebItem.type {
		set isTextInput = 1
	} else {
		set isTextInput = 0
	}
</script>
<input type="hidden" name="prowebID" value="#(prowebID)#">
<div class="form-horizontal ef-proweb-quick-edit-panel">
	<div class="row" style="margin-top: 0px;"> 
		<div class="col-sm-4">
			<label for="isMandatory" class="control-label" >
				<div class="ef-label-text">Label text:</div>
			</label>
		</div>
		<div class="col-sm-8">
			<input type="text" name="labelText" value="#(..encodeForHTMLAttribute(labelText))#" class="form-control ef-input">
		</div> 
	</div>

	<div class="row"> 
		<div class="col-sm-4 ">
			<label for="isMandatory" class="control-label" >
				Database item:
			</label>
		</div>	
		<div class='col-sm-8'>
			<script language="cache" runat="server">
				#dim prowebItem as sc.xModules.objCODitem
				if prowebItem.objItemName.carryOver {
					set scopeString = "Answer applies to all events"
				} elseif ##class(cod.objItemName).isSingleEventQuestion(prowebItem.objItemName.%Id()) {
					set scopeString = "Question is only available to this event"	
				} else {
					set scopeString = "Question is available to all events"	
				}
				set databaseItemDescription = prowebItem.objItemName.description_" ("_scopeString_")"
			</script>
			<input type="text" name="labelText" value="#(..encodeForHTMLAttribute(databaseItemDescription))#" disabled class="form-control ef-input">

		</div> 
	</div>

	<div class='row'> 
		<div class="col-sm-4 ">
			<label for="isMandatory" class="control-label" >The answer is:</label>
		</div>
		<div class='col-sm-8'>
			<div class="btn-group" id="isMandatory" data-toggle="buttons">
				<label class="btn ef-push-button #($Select(+prowebItem.mandatory = 0 :"active",1:""))#">
					<input type="radio" value="0" name="isMandatory">
					Optional
				</label>

				<label class="btn ef-push-button #($Select(+prowebItem.mandatory = 1 :"active",1:""))#">
					<input type="radio" value="1" name="isMandatory">
					Required
				</label>
			</div>
		</div>
	</div>

	<div class='row'> 
		<div class='col-sm-4 '>
			<label for="dependsOnParent" class="control-label" >
				Display only when:
			</label>
		</div>	
		<div class='col-sm-8'>
			<select name="dependsOnParent" id="dependsOnParent" class="form-control ef-input" onChange="ef_updateAlternatives(#(pageID)#, this.value)"  style="width: 35%; float: left;">
				<option value=""></option>
				<script language="cache" runat="server">
					set rsQuestions = ##class(%ResultSet).%New("sc.codItemMethods:qQuestionsThatCanBeDependencyParents")
					do rsQuestions.Execute(pageID)
					while rsQuestions.Next() {
						set altProwebID = rsQuestions.Get("prowebID")
						set altLabelText = rsQuestions.Get("labelText")
						 
						write !,"<option value=",..encodeForHTMLAttribute(altProwebID), $Select(altProwebID = prowebItem.dependsOnPrompt:" SELECTED",1:""),">",..encodeForHTML(altLabelText),"</option>"	
					}
				</script>
			</select>
			
			<span style="float: left; margin-left:20px; margin-right: 20px; margin-top:5px;">is</span>
			
			<select id="dependsOnAlternative" class="form-control ef-input" style="width: 35%; float: left;">
				<script language="cache" runat="server">
					if (prowebItem.dependsOnPrompt) && (prowebItem.dependsOnAlternative) {
						set databaseItemID = ##class(sc.xModules.objCODitem).getCODItemNameID(prowebItem.dependsOnPrompt)
						Set rsAlt=##class(cod.objItemAlternatives).getAlternativesForCodItemMatchingDescriptionAsResultSet(databaseItemID, ,contextData.languageID)
						While rsAlt.Next() {
							Write !,"<option value='",..encodeForHTMLAttribute(rsAlt.Get("description")),"'",$Select( prowebItem.dependsOnAlternative = rsAlt.Get("ID"):" SELECTED",1:"" ),">",..encodeForHTML(rsAlt.Get("description")),"</option>"
						}		
					}
				</script>
			</select>
		</div> 
	</div>
	<csp:if condition=(prowebItem.type="dropdown")>
		<div class="row"> 
			<div class="col-sm-4 ">
			</div>	
			<div class="col-sm-8">	
				<input type="checkbox" id="searchAsYouType" value=1 #( $Select(prowebItem.searchAsYouType:"CHECKED", 1:"") )#>
				<label for="searchAsYouType" class="control-label">Search-as-you-type</label>
			</div>	
		</div>
	</csp:if>

</div>
]]></CSP>


<CSP name="backEnd/proweb/quickEditSave.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="0">
<script language="cache" runat="server">
	#dim prowebItem as sc.xModules.objCODitem
	#dim selectedAlternativeID as %Integer = ""
	set auditType = 0
	set auditDepencency = 0
	
	set status = "error"
	set errorMsg = "There was a problem while saving"
	
	set contextData = ##class(EF.contextDataRegistration).createFromFrontendCSPSession()
	set prowebID = %request.Get("prowebID") 
	if 'prowebID {
		set errorMsg = "No prowebID passed in"
	}
	set prowebItem = ##class(sc.objData).%OpenId( prowebID )
	
	if '$IsObject(prowebItem) {
		set errorMsg = "Incorrect prowebID passed in: "_prowebID
	}	
	
	set oldLabelText = prowebItem.description
	set prowebItem.description = ##class(EF.sanitiser).getSanitisedSubmittedValue("labelText")
	set newLabelText = prowebItem.description
	
	set oldIsMandatory = prowebItem.mandatory
	set prowebItem.mandatory = +%request.Get("isMandatory")
	set newIsMandatory = prowebItem.mandatory
	
	set oldDependsOnPrompt = prowebItem.dependsOnPrompt
	set prowebItem.dependsOnPrompt = %request.Get("dependsOnParent")
	set newDependsOnPrompt = prowebItem.dependsOnPrompt
	
	if prowebItem.dependsOnPrompt {
		set auditDepencency = 1
		set selectedAlternative = %request.Get("dependsOnAlternative")
		set databaseItemID = ##class(sc.xModules.objCODitem).getCODItemNameID(prowebItem.dependsOnPrompt)
		set selectedAlternativeID = ##class(cod.objItemAlternatives).getIDFromDescription(databaseItemID, selectedAlternative)
	}
	
	set oldDependsOnAlternative = prowebItem.dependsOnAlternative
	set prowebItem.dependsOnAlternative = selectedAlternativeID
	set newDependsOnAlternative = prowebItem.dependsOnAlternative
	
	set oldSearchAsYouType = prowebItem.searchAsYouType
	set prowebItem.searchAsYouType = +%request.Get("searchAsYouType")
	set newSearchAsYouType = prowebItem.searchAsYouType
	
	set sc = prowebItem.%Save()
	if ('$$$ISERR(sc)) {
		set status = "ok"
		
		set xUserID = $Get(%session.Data("eventsforce","backend","xPersonID"))
		set eventID = prowebItem.objEvent.%Id()
		set pageID = ##class(sc.xModules.objCODitem).getPageIDforQuestion(prowebID)
		set pageName = ##class(sc.xModules.objPage).getDescription(pageID)
		
		if (oldLabelText '= newLabelText) {
			do ##class(setup.objEventAudit).add(xUserID, eventID, "Reg Page '"_pageName_"' ("_pageID_"), Changed Registration Question Label Text: "_newLabelText_" (New Value) - "_oldLabelText_" (Old Value)")
		}
		if (oldIsMandatory '= newIsMandatory) {
			do ##class(setup.objEventAudit).add(xUserID, eventID, "Reg Page '"_pageName_"' ("_pageID_"), Changed Registration Question Mandatory: "_newIsMandatory_" (New Value) - "_oldIsMandatory_" (Old Value)")
		}
		if (auditType) {
			do ##class(setup.objEventAudit).add(xUserID, eventID, "Reg Page '"_pageName_"' ("_pageID_"), Changed Registration Question Type: "_newType_" (New Value) - "_oldType_" (Old Value)")
		}
		if (auditDepencency) {
			do ##class(setup.objEventAudit).add(xUserID, eventID, "Reg Page '"_pageName_"' ("_pageID_"), Changed Registration Question Depends On Prompt: "_newDependsOnPrompt_" (New Value) - "_oldDependsOnPrompt_" (Old Value)")
			do ##class(setup.objEventAudit).add(xUserID, eventID, "Reg Page '"_pageName_"' ("_pageID_"), Changed Registration Question Depends On Alternative: "_newDependsOnAlternative_" (New Value) - "_oldDependsOnAlternative_" (Old Value)")
		}
		if (oldSearchAsYouType '= newSearchAsYouType) {
			do ##class(setup.objEventAudit).add(xUserID, eventID, "Reg Page '"_pageName_"' ("_pageID_"), Changed Registration Question Search as you type: "_newSearchAsYouType_" (New Value) - "_oldSearchAsYouType_" (Old Value)")
		}
	}
	
	write "{ ""status"" : """_status_""""
	if status = "error" {
		write ", ""errorMsg"" : """_##class(shared.jsonFunctions).jsonEscape(errorMsg)_""""
	}
	write " }"
</script>

]]></CSP>


<CSP name="backEnd/proweb/textDetailsMoxie.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<csp:include page="../../backend/home/backendTop.csp?hideBackendMenu=1&useHtml5=1&kendoweb=1&useTinyMce=1">

<script src="../../media/javascript/ef/ef-admin-tinyMceTextBlock.js?v=12"></script>

<script language="cache" runat="server">
	set %session.Data("eventsforce","backend","email or web page")="web page"
	set pageID=%request.Get("pageID")
	// following session items are set in textDetailsMoxie2.csp if redirecting to fonts and colours page
	kill %session.Data("parent")
	kill %session.Data("moxieDataID")
	kill %session.Data("isCOD")
	
	do ##class(sc.objData).saveDesiredPositionFromRequestToSession(%request, %session)
	&SQL(SELECT layoutObjTemplate->styleSource INTO :styleSource FROM setup.objEvent WHERE ID = :xEventID)
	
	set dataID=%request.Get("dataID")
	if dataID="" set dataID=%session.Get("dataID")
	set %session.Data("dataID")=dataID
	
	set orgDataID=%request.Get("orgDataID") // used when creating a new version of a data item
	if orgDataID="" set orgDataID=%session.Get("orgDataID")
	set %session.Data("orgDataID")=orgDataID

	set parent=""
	if dataID="NEW" set tmp=orgDataID
	else  set tmp=dataID
	&SQL(SELECT parent INTO :parent FROM sc.objData WHERE ID = :tmp)

	set classNo=%request.Get("classNo")
	if classNo="" set classNo=%session.Get("classNo")
	set %session.Data("classNo")=classNo
	

	set templateURL=%request.Get("templateURL")
	if templateURL="" set templateURL=%session.Get("templateURL")
	set %session.Data("templateURL")=templateURL

	set templateID=%request.Get("templateID")
	if templateID="" set templateID=%session.Get("templateID")
	set %session.Data("templateID")=templateID
	
	set displayOrder=%request.Get("displayOrder")
	if displayOrder="" set displayOrder=%session.Get("displayOrder")
	set %session.Data("displayOrder")=displayOrder

	set addToTop=%request.Get("addToTop")
	if addToTop="" set addToTop=%session.Get("addToTop")
	set %session.Data("addToTop")=addToTop

	// make sure we don't get the taglist from the email details
	kill %session.Data("eventsforce","backend","show taglist")	

	// check if the event is using a template that is AA complient, if so, disable the legacy mode
	&SQL(SELECT layoutObjTemplate->accessibilityLevel INTO :tmp FROM setup.objEvent WHERE ID = :xEventID)
	set accessibilityLevel=tmp
	set toolBar2="formatselect | fontselect | fontsizeselect | table | template"
	if accessibilityLevel="AA" {
		set toolBar2="formatselect | table | template"	
	}

	set surveyID=%request.Get("surveyID")
	
	if surveyID {
		set tmpTemplateID=##class(layout.objTemplate).getLayoutForSurvey(surveyID)
	} else {
		set tmpTemplateID=##class(layout.objTemplate).getLayoutForEvent(xEventID)
	}
	
	// get the name of the component
	set componentName=%request.Get("componentName")
	if componentName="" set componentName=%session.Get("componentName")
	set %session.Data("componentName")=componentName
	if (componentName="")&(dataID'="") {
		&SQL(SELECT description INTO :componentName FROM sc.objComponent WHERE objData = :dataID)
	}
	 
	// load the page in raw mode if it was saved in raw mode - to enable javascript, flash etc.
	set allowScripts=0,allowFontSelection=0
	if dataID {
		if ##class(sc.xModules.objText).isTextBlockRawMode(dataID) set allowScripts=1
		if ##class(sc.xModules.objText).isFontSelectionOn(dataID) set allowFontSelection=1
	}
	
	set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if 'xWorkLangID set xWorkLangID=xLangID
	// are we in the bookers page?
	set inBookersPage=0
	if xEventID	{
		set extraBit=""
		if xWorkLangID,xWorkLangID'=xLangID set extraBit=" - "_##class(shared.objLanguage).getLanguageDesc(xWorkLangID)
		set bookerPageID=##class(setup.objEventSetting).getParameter("bookings","bookerRegPageID"_extraBit,xEventID)
		if bookerPageID=pageID set inBookersPage=1
	}
	
	set eventAllowsGroupBookings=##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)
	set editWithoutColours=0
</script>

<csp:object name="objData" classname="sc.objData" objid="#(dataID)#">

<script language="cache" runat="server">
	//SHAHADAT: 11 Dec 09
	// Had to take out the componentName resetting from the line below as this messes things up when we try to add a new header CASE00012071.
	//Also, as we made a few decisions above based on this componentName, we could not find a good reason why we have to reset it here.
	//set (description,currentPath,componentName,parent,componentName,pageName)="" 
	set (description,currentPath,parent,pageName)="" 

	if +dataID {
		set parent=objData.parent.%Id()
	} else {
		set parent=%request.Get("parent")
		if parent="" set parent=%session.Get("parent")
		set %session.Data("parent")=parent
	}	
	
	set currentPath=##class(sc.objData).getPath(parent,0)
	set textStream=##class(%GlobalCharacterStream).%New()

	// get the data if we are editing
	if ##class(sc.objData).%ExistsId(dataID) {
		set description=objData.description
		set textStream=objData.textStream
		&SQL(SELECT description INTO :componentName FROM sc.objComponent WHERE (objData = :dataID) )
	} else {
		if orgDataID'="" {
			if ##class(sc.objData).%ExistsId(orgDataID) {
				// default data to the previous version if we are creting a new version
				set orgObjData=##class(sc.objData).%OpenId(orgDataID)
				set description=orgObjData.description
				set textStream=orgObjData.textStream
				do orgObjData.%Close()
			}
		}
	}

	set encodedTextStream=""
	try {
		set encodedTextStream=..encodeHTMLContentForTinyMCETextarea(textStream.Read($$$maxStringLength))	
	} catch {
		set %session.Get("errorMessage")="Cannot open text block because it is too long"
	}
	// get the name of the page
	&SQL(SELECT description INTO :pageName FROM sc_xModules.objPage WHERE ID = :pageID)

	set width=610 // default
	if dataID {
		if objData.parent.dataType="objList" {
			&SQL(SELECT width INTO :width FROM sc.objComponent WHERE objData = :parent)
		} else {
			&SQL(SELECT width INTO :width FROM sc.objComponent WHERE objData = :dataID)
		}
	}

	set temp="siblings"_displayOrder
	
	kill allRegPages,allRegPageIDs,allReg
	set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xWorkLangID,1,.allRegPages,.allRegPageIDs,.allReg)

</script>

<csp:if condition=($l($G(%session.Data("errorMessage"))))>
	<script language='javascript'>
		alert("#(..encodeForJavaScript(%session.Data("errorMessage")))#");
	</script>
	<script language="cache" runat="server">
		kill %session.Data("errorMessage")
	</script>
</csp:if>

<script language="cache" runat="server">
	set textDetailsMoxieShowDependentSection=0
	if (%request.Get("isCOD")) set textDetailsMoxieShowDependentSection=1
	if ##class(sc.pageMethods).isAwardsEntryPage(pageID) {
		set textDetailsMoxieShowDependentSection=1
	}
	set showCategoryRestrictions = 0
	if xEventID {
		if ##class(setup.lnkCategoryEvent).numCategories(xEventID,1,1)>1 {
			set showCategoryRestrictions=1	
		}
	}
	if ($zcvt(templateURL,"l") [ $zcvt("treceipt.csp","l")) set showCategoryRestrictions = 0
	if ($zcvt(templateURL,"l") [ $zcvt("xtTsurveyPage.csp","l")) set showCategoryRestrictions = 0
	set showAttendeeOptions=0
	if textDetailsMoxieShowDependentSection!showCategoryRestrictions {
		set showAttendeeOptions=1
	}
	set dependsOnPrompt=##class(sc.dependencyMethods).getDependsOnPrompt(dataID)
	set dependsOnAlternative=##class(sc.dependencyMethods).getDependsOnAlternative(dataID)
</script>


<script language="javascript" type="text/javascript">
	$(function() {
		ef.tinyMceTextBlock.properties.allowFontSelection = #(..rawJS(+allowFontSelection))#;
		ef.tinyMceTextBlock.properties.allowScripts = #(..rawJS(+allowScripts))#;
		ef.tinyMceTextBlock.properties.editWithoutColours = #(..rawJS(+editWithoutColours))#;
		ef.tinyMceTextBlock.properties.showAttendeeOptions = #(..rawJS(showAttendeeOptions))#;
		ef.tinyMceTextBlock.urls.content_css = '#(..encodeJS(##class(EF.ui.pageSections.textDetailsMoxieStyles).outputStylesForMoxie(xEventID)))#';
	    ef.tinyMceTextBlock.urls.link_list = '#(..encodeJS(..Link("../../backend/home/moxieLinksJSON.csp")))#';
	    ef.tinyMceTextBlock.urls.file_picker_callback = '#(..encodeJS(..Link("../../backend/home/moxieFileUpload.csp?zzz=1")))#';
	    ef.tinyMceTextBlock.properties.table_class_list = #(..rawJS(##class(setup.systemSettingsMethods).getMoxieTableClasses()))#; 
	    ef.tinyMceTextBlock.initialise();
	});
</script>

<div style="margin-top: 33px;"></div>
 <form method="post" action="textDetailsMoxie2.csp"  name="composeform" ID="composeform">
 
 <div class="topsave_in_popup">
 	<a href="../../proweb/frontend/start.csp?mode=edit&version=current&pageID=#(pageID)#"><img name="butQuit" src="../../media/images/english/default/backend/cancel.gif" alt="Quit" border="0"></a>
	
	<script language="cache" runat="server">
		set show=0
		if ##class(layout.objTemplate).isEventIFrame(xEventID) set show=1
		if ##class(layout.objTemplate).isUsingLegacyTemplate(xEventID) set show=1
		
		if ('show) {
			set fontsAndColoursTooltip=..out("You do not have access to Fonts & Colours if you are using an Eventsforce or Custom Made design. You have access if you are using the Blank Design or iFrame template")
		} else {
			set fontsAndColoursTooltip=..out("Click here to amend your font, colour and size for your chosen format")
		}
	</script>
	<csp:if condition=(show=0)>
		<img src="../../media/images/english/default/backend/fonts_and_colours_disabled.gif" alt="#(fontsAndColoursTooltip)#" title="#(fontsAndColoursTooltip)#" />
	<csp:else>
		<input type="image" name="butEdit" id="butEdit" src="../../media/images/english/default/backend/fonts_and_colours.gif" alt="#(fontsAndColoursTooltip)#" title="#(fontsAndColoursTooltip)#" border="0">
	</csp:if>
	<input type="image" id="butSave" name="butSave" onclick="ef.tinyMceTextBlock.resetColors(0);" src="../../media/images/english/default/backend/save.gif" alt="Save" border="0" >
 </div>

<table style="with: 1024px;" border="0" cellspacing="0" cellpadding="0">
    <tr>
        <td>
            <table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF">
                <tr  class="gen1_panel_header">
	                <td>Edit Text Item</td>
                </tr>
				<tr>
		            <td valign="top">
					   <table width="100%" style="max-width:1100px;" border="0" cellspacing="0" cellpadding="0">
							<tr>
								<td colspan="4">
									<input type="hidden" id="rawText" name="rawText" value="">
									<textarea id="editBox" class="ef-admin-tinyMceTextBlock-edit-box" name="editBox">#(..rawHTML(encodedTextStream))#</textarea>
									<input type="hidden" name="displayOrder" value="#(%request.Get("displayOrder"))#">
					               <input type="hidden" name="templateID" value="#(templateID)#">
						           <input type="hidden" name="parent" value="#(parent)#">
						           <input type="hidden" name="componentName" value="#(componentName)#">
						           <input type="hidden" name="templateURL" value="#(templateURL)#">
						           <input type="hidden" name="dataID" value="#(dataID)#">
						           <input type="hidden" name="txtGotoPage" value="">
						           <input type="hidden" name="addToTop" value="#(addToTop)#">										
						           <input type="hidden" name="publish" value="no">
						           <input type="hidden" name="orgDataID" value="#(orgDataID)#">
								   <input type="hidden" name="isCOD" value="#(%request.Get("isCOD"))#">
								   <input type="hidden" id="dependsOnPrompt" name="dependsOnPrompt" value="#(dependsOnPrompt)#">
								   <input type="hidden" id="dependsOnAlternative" name="dependsOnAlternative" value="#(dependsOnAlternative)#">								   
								   <input type="hidden" id="allowFontSelection" name="allowFontSelection" value=#(allowFontSelection)#>
								   <input type="hidden" id="allowScripts" name="allowScripts" value=#(allowScripts)#>
								   <input type="hidden" id="editWithoutColours" name="editWithoutColours" value=#(editWithoutColours)#>
								   <input type="hidden" id="okToSaveEmpty" name="okToSaveEmpty" value=0>
								   <script language="cache" runat="server">
										// get all the active categories for this event
										set rs2=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
										do rs2.Execute(xEventID)
									</script>
									<csp:while condition="rs2.Next()">
										<input type="hidden" id="restrictByEventCategory_#(rs2.Data("objEventCategory"))#" class="hiddenRestrictByEventCategory" name="restrictByEventCategory_#(rs2.Data("objEventCategory"))#" value="#($S(##class(links.lnkEventCategoryData).isSet(rs2.Data("objEventCategory"),dataID):1,1:0))#">
									</csp:while>
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
		</td>
    </tr>
</table>
<script language="cache" runat="server">
	Set lightBox=##class(EF.ui.backend.controls.lightBox).%New("attendee-options-lightbox")
	set lightBox.boxTitle="Options"
	set lightBox.showBoxTitle=1
	set lightBox.width="700px"
	set lightBox.cancelButtonID="attendeeOptionsCloseButton"
	set lightBox.actionButtonID="attendeeOptionsSaveButton"
</script>
<script language="javascript" type="text/javascript">
	ef.textDetailsMoxie = ef.textDetailsMoxie || {};
	ef.textDetailsMoxie.showAttendeeDetails = function() {
		#[do lightBox.show()]#
	}
	$(function() {
		$('##(lightBox.cancelButtonID)#').click( function () {
			#[do lightBox.hide()]#
			if (($("#dependsOnPrompt").val()) != '') {
				$("#selDependsOnDataID").val($("#dependsOnPrompt").val());
			} else {
				$("#selDependsOnDataID").prop("selectedIndex", 0);
			}
			updateAlts($("#dependsOnPrompt").val());
			$("#selDependsOnCodAltID").val($("#dependsOnAlternative").val());
			$(".hiddenRestrictByEventCategory").each(function() {
				var thisID=$(this).attr('id');
				var categoryID = thisID.split('_')[1];
				var checkbox= $('#chkEventCategory_' + categoryID);
				if ($(this).val() == 1) {
					checkbox.prop('checked',true);
				} else {
					checkbox.prop('checked',false);
				}
			});
		});
		$('##(lightBox.actionButtonID)#').click( function () {
			#[do lightBox.hide()]#
			$("#dependsOnPrompt").val($("#selDependsOnDataID").val());
			$("#dependsOnAlternative").val($("#selDependsOnCodAltID").val());
			$(".hiddenRestrictByEventCategory").each(function() {
				var thisID=$(this).attr('id');
				var categoryID = thisID.split('_')[1];
				var checkbox= $('#chkEventCategory_' + categoryID);
				if (checkbox.prop('checked')) {
					$(this).val(1);
				} else {
					$(this).val(0);
				}
			});
		});
	});
</script>
	<div id="attendee-options-lightbox" style="display:none; width: #(lightBox.width)#;">
		<div class='ef_settings_group'>
			<table width="100%" border=0 cellpadding=0 style="margin-left: 0px; margin-right: 0px; margin-bottom: 12px;">
				<csp:if condition=(textDetailsMoxieShowDependentSection)>
					<csp:include page="dependancyOptionsInclude.csp">
				</csp:if>
			</table>
			<csp:if condition=(showCategoryRestrictions)>	
				<table width="100%" border=0 cellpadding=0 style="margin: 0px;">
					<tr>
						<td class="black10px" colspan="4">
							<script language="cache" runat="server">
								set eventID=$G(%session.Data("eventsforce","backend","xEventID"))
								set langID=$G(%session.Data("eventsforce","backend","xLangID"))	
							</script>
							<csp:if condition=(eventID)>
								<script language="cache" runat="server">
									// get all the active categories for this event
									set rs2=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
									do rs2.Execute(eventID)
								</script>
								<tr>
									<td colspan="3">
										<table  border=0 cellpadding=0 cellspacing=0>
											<csp:while counter="x" condition="rs2.Next()">
												<csp:if condition=(x=1)>
													<tr>
														<td class="black10px" colspan="99" align="left" nowrap><tx>Restrict access to these attendee categories</tx>:</td>
						
													</tr>
												</csp:if>
												<csp:if condition=(x#2'=0)>
													<tr>
														<td width=103></td>
												</csp:if>
														<script language="cache" runat="server">
															set eventCategoryID=rs2.Data("objEventCategory")
															set CHECKED=""
															if ##class(links.lnkEventCategoryData).isSet(eventCategoryID,dataID) set CHECKED="CHECKED"
														</script>
														<td align="left" width=35>
															<input type="checkbox" id="chkEventCategory_#(eventCategoryID)#" name="chkEventCategory_#(eventCategoryID)#" #(CHECKED)#>
														</td>
														<td align="left"  width=100 class="black10px">
															#(##class(shared.stringFunctions).sentenceCase(rs2.Data("description")))#
														</td>
														<td>&nbsp;</td>
												<csp:if condition=(x#2=0)>
													</tr>
												</csp:if>
											</csp:while>
												<csp:if condition=(x#2'=0)>
														<td align="right" ></td>
														<td align="left"></td>
													</tr>
												</csp:if>
										</table>
									</td>
								</tr>
							</csp:if>
						</td>
					</tr>
				</csp:if>
			</table>						
		</div>
		<div class="ef_backend_button_section">
			<input type="image" id="#(lightBox.cancelButtonID)#" src="../../media/images/English/Default/backend/cancel.gif" border="0" alt="cancel" name="Cancel">
			<input type="image" id="#(lightBox.actionButtonID)#" src="../../media/images/English/Default/backend/ok.gif" border="0" alt="Save" name="Submit">
		</div>
	</div>
 </form>


<script language="javascript" >
$(function() {
	$("#composeform").submit(function() {
		stripHTML(); 
		return ef.tinyMceFunctions.checkForEmptySave(tinyMCE.activeEditor);
	}
)});
	
function stripHTML() {
	var oldString = tinyMCE.activeEditor.getContent();
	$("#rawText").val($("<div/>").html(oldString).text());
}

function updateAlts(codPromptID) {
	if ($("#selDependsOnCodAltID").length !=0) {
		document.getElementById("selDependsOnCodAltID").options.length=0;
		if (codPromptID != '') {
			// populate the alternatives list box from the javascript array
			
			for (var i = 0; i < (alts[codPromptID].length); i++) {
				var tmp = alts[codPromptID][i].split('|');
				document.getElementById("selDependsOnCodAltID").options[i] = new Option(tmp[1],tmp[0])
			}	
		}
	}
}


</script>
<csp:include page="../../backend/home/backendBottom.csp">                                                                                                                              
]]></CSP>


<CSP name="backEnd/proweb/textDetailsMoxie2.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	// check if we have lost the userID due to a session switch in flash, if so get it back from the cookie created in login2.csp
	if %session.Get("xUserID")="" set %session.Data("xUserID")=%request.GetCookie("xUserID")
	set userID=%session.Get("xUserID")
	if %request.Get("isHeader") {
		set redirectOnErrorURL="textHeaderMoxie.csp"
	} else {
		set redirectOnErrorURL="textDetailsMoxie.csp"
	}
	// abort if we cant find a user, just to ensure database integrity
	if %session.Get("xUserID")="" {
		set %session.Data("errorMessage")="Error. Data cannot be saved. User Id cannot be found.\nPlease try again after a new logon"
		set %response.Redirect=redirectOnErrorURL
		quit 0
	}
	
	// try to remove any XML from pasted Word
	set text=%request.Get("editBox")

	// abort if text block contains javascript from proWeb
	if $IsObject(text) {
		if text.FindAt(-1,"HM_Array")'=-1 {
			set %session.Data("errorMessage")="Error. Text cannot be saved. It has seems to have been copied from a proWeb page in edit mode. \nPlease switch to Preview mode before copying any data."
			set %response.Redirect=redirectOnErrorURL
			quit 0
		}
		set validator=##class(EF.validator.htmlText).%New()
		if 'validator.isInputValidStream(text) {
			set %session.Data("errorMessage")="Your text is too long. Please amend and re-save."
			set %response.Redirect=redirectOnErrorURL
			quit 0
		}
	} else {
		
		if text["HM_Array" {
			set %session.Data("errorMessage")="Error. Text cannot be saved. It has seems to have been copied from a proWeb page in edit mode. \nPlease switch to Preview mode before copying any data."
			set %response.Redirect=redirectOnErrorURL
			quit 0
		}	
	
		if (($LENGTH(text)<1)&&(%request.Get("mode")="")) { //  don't save empty text blocks...unless we're just switching mode. 
			if %request.Get("okToSaveEmpty")'=1 {
				set %session.Data("errorMessage")="Error. Empty text block cannot be saved. \nTo remove a text block, click Cancel and then select Delete from the menu next to the specific text block."
				set %response.Redirect=redirectOnErrorURL
				quit 0
			}
		}
		set validator=##class(EF.validator.htmlText).%New()
		if 'validator.isInputValid(text) {
			set %session.Data("errorMessage")="Your text is too long. Please amend and re-save."
			set %response.Redirect=redirectOnErrorURL
			quit 0
		}	
	}
	new objData,objComponent

	set dataID=%request.Get("dataID")
	set %session.Data("dataID")=dataID
	set orgDataID=%request.Get("orgDataID")
	set parent=%request.Get("parent")
	set templateID=%request.Get("templateID")
	set componentName=%request.Get("componentName")

	set displayOrder=%request.Get("displayOrder")
	if displayOrder="" set displayOrder=%session.Get("displayOrder")
	
	// Need to initialize the variables otherwise they cause crashes. 
	set dependsOnPrompt=%request.Get("dependsOnPrompt")
	set dependsOnAlternative=%request.Get("dependsOnAlternative")
	
	if dataID="NEW" {
		// create new text object
		set objData=##class(sc.xModules.objText).%New()
		
		// parent
		do objData.parentSetObjectId(parent)
		
		set objData.active=1

		set user="unknown"
		if %session.Get("xUserID")'="" {
			set objUser=##class(admin.objUser).%OpenId(%session.Get("xUserID"))
			set user=objUser.email
			do objUser.%Close()
		}
		set objData.creator=user
		
		do objData.%Save()
		set dataID=objData.%Id()
		set %session.Data("dataID")=dataID

		// link to the previous version
		if (orgDataID'="")&(orgDataID'="NEW")&(orgDataID'="ADD") {

			if ##class(sc.objData).%ExistsId(orgDataID) {

				set ok=objData.previousVersionSetObjectId(orgDataID)
				if 'ok {
					set ^xErrors(%request.PageName,"not able to link back new text object",dataID)=orgDataID_"|"_ok
					quit 0
				} else {
					// and link the previous to me
					set tempObj=##class(sc.objData).%OpenId(orgDataID)
					do tempObj.nextVersionSetObjectId(dataID)
					do tempObj.%Save()
					do tempObj.%Close()
				}
			}
		}

			
		// create new component object if we didn't have an predecessor
		if (orgDataID="")!(orgDataID="NEW")!(orgDataID="ADD") {
			if objData.parent.dataType'="objList" {
				set objComponent=##class(sc.objComponent).%New()
				set objComponent.description=componentName
				do objComponent.objTemplateSetObjectId(templateID)
				do objComponent.objDataSetObjectId(dataID)
				do objComponent.%Save()
				do objComponent.%Close()

			}
		}

		// set a displayOrder if my parent is a List
		if objData.parent.dataType="objList" {
			if +displayOrder=0 {
				if orgDataID="ADD" { // meaning that we are adding an item to the list
					if %session.Get("addToTop")="false" { // add to the top of the list
						set tmp=""
						&SQL(SELECT displayOrder INTO :tmp FROM sc.objData WHERE parent = :parent ORDER BY displayOrder DESC)
						set objData.displayOrder=(tmp+1)
						set %session.Data("displayOrder")=(tmp+1)
					} else { // add to the bottom of the list
						// increment everybodys displayorder with one before adding this one as number one
						&SQL(UPDATE sc.objData SET displayOrder = (displayOrder+1) WHERE parent = :parent)
						set objData.displayOrder=(1)
						set %session.Data("displayOrder")=(1)
					}
					
					// kill the addToTop not to confuse later saves
					kill %session.Data("addToTop")
					
				} else {  // meaning that we are adding a version to one of the list items
					set objData.displayOrder=objData.previousVersion.displayOrder  // use the same as previous version
				}
			} else { // set the passed in displayOrder if we are adding a column to an existing row
				set objData.displayOrder=displayOrder
			}
			
			// Add new, dependent children right underneath their parent
			set dependsOnPrompt=%request.Get("dependsOnPrompt")
			set dependsOnAlternative=%request.Get("dependsOnAlternative")
			if dependsOnPrompt {
				&SQL(SELECT displayOrder,parent INTO :parentDisplayOrder,:parentID FROM sc_xModules.objCODitem WHERE ID = :dependsOnPrompt)
				if +SQLCODE=0,dataID {
					set lastPos=parentDisplayOrder
				
					// find the last dependent child
					&SQL(SELECT displayorder INTO :lastChild FROM sc_xModules.objCODitem WHERE (dependsOnPrompt = :dependsOnPrompt)  AND (parent = :parent) ORDER BY displayOrder DESC)
					if +SQLCODE=0 set lastPos=lastChild
				
					&SQL(SELECT displayorder INTO :lastChild FROM sc_xModules.objText WHERE (dependsOnPrompt = :dependsOnPrompt)  AND (parent = :parent) ORDER BY displayOrder DESC)
					if ((+SQLCODE=0)&&(lastChild > lastPos)) {
						set lastPos=lastChild
					}
					
					// move all the subsequent items one step down
					&SQL(UPDATE sc.objData SET displayOrder = displayOrder+1 WHERE (parent = :parent) AND (displayOrder > :lastPos))
				
					// move the new item to right after the parent	
					&SQL(UPDATE sc_xModules.objText SET displayOrder = :lastPos + 1 WHERE ID = :dataID)
				}
			}
		}

		// add my new ID to the list of sibling if my dad was a list
		if objData.parent.dataType="objList" {
			if displayOrder>0 {
				new orgSibling
				set orgSibling=%session.Get("siblings"_displayOrder)
				set classNo=%session.Get("classNo")
				set pis=$p(orgSibling,"|",classNo)
				set $p(pis,"=",2)=dataID
				set $p(orgSibling,"|",classNo)=pis
				set %session.Data("siblings"_displayOrder)=orgSibling
			}
		}	

		 // audit trail
		 set comments="created"
		 &SQL(INSERT INTO sc.objAuditTrail (description,objData,objUser) VALUES (:comments,:dataID,:userID))
		 
	} else {
		// open existing
		set objData=##class(sc.objData).%OpenId(dataID)

		// dependencies
		set dependsOnPrompt=%request.Get("dependsOnPrompt")
		set dependsOnAlternative=%request.Get("dependsOnAlternative")
			
		 // audit trail
		 set comments="amended"
		 &SQL(INSERT INTO sc.objAuditTrail (description,objData,objUser) VALUES (:comments,:dataID,:userID))
	}
	
	// set the approval level to START for both new and existing items
	set step=""
	&SQL(SELECT ID INTO :step FROM sc.objStep WHERE stepOrder=1)
	do objData.objStepSetObjectId(step)
	
	set targetLevel=1
	
	set scTextBlockAudit=##class(EF.audit.scTextBlock).%New()
	do scTextBlockAudit.oldHtmlStream.CopyFrom(objData.textStream)
	do scTextBlockAudit.oldTextStream.CopyFrom(objData.rawTextStream)

	if $IsObject(text) { // if more than 32K
		do objData.textStream.CopyFrom(text)
	} else { // if less than 32K
		do objData.textStream.Write(text)
		//  Restrict to 1000 chars to avoid MAXSTRING errors, as sometimes 32k may not be the limit (UTF-8 encoded text)
		// set objData.description=text // this prop is not used for anything important but still used by the layout.method.applyBannersToTemplate()
		set objData.description=$E(text,1,1000) // this prop is not used for anything important but still used by the layout.method.applyBannersToTemplate()
	}
	// save the rawText, used by emails and such
	set rawText=%request.Get("rawText")
	set objData.suppressTextEditor=+%request.Get("allowScripts")
	set objData.isFontSelectionOn=+%request.Get("allowFontSelection")
	
	if $IsObject(rawText) {
		do objData.rawTextStream.CopyFrom(rawText)
	} else {
		do objData.rawTextStream.Write(rawText)
	}
	
	//update dependencies. 
	if (dependsOnPrompt && dependsOnAlternative) { //Save if both are defined. Otherwise, remove dependency altogether. 
		set objData.dependsOnPrompt=dependsOnPrompt
		set objData.dependsOnAlternative=dependsOnAlternative
	} else {
		set objData.dependsOnPrompt=""
		set objData.dependsOnAlternative=""
	}
	
	set scTextBlockAudit.objText=objData
	do scTextBlockAudit.htmlStream.CopyFrom(objData.textStream)
	do scTextBlockAudit.textStream.CopyFrom(objData.rawTextStream)
	set ok=objData.%Save()
	
	set scTextBlockAudit.savingStatus=ok
	do scTextBlockAudit.%Save()

	// update the width of the component
	set width=%request.Get("txtWidth"),compoID=""
	if objData.parent.dataType="objList" {
		&SQL(SELECT ID INTO :compoID FROM sc.objComponent WHERE objData = :parent)
	} else {
		&SQL(SELECT ID INTO :compoID FROM sc.objComponent WHERE objData = :dataID)
	}
	if compoID {
		set objComponent=##class(sc.objComponent).%OpenId(compoID)
		set objComponent.width=width
		do objComponent.%Save()
		do objComponent.%Close()
	}

	do objData.%Close()	
	do ##class(sc.objData).moveNewElementToDesiredPosition(dataID)

	// kill all category links and save
	// - do this in method so it can compile without class
	do ##class(links.lnkEventCategoryData).deleteAllForOne(dataID)
	set item=""
	for  {
		set item=$o(%request.Data(item))
		if item="" quit
		if (item["restrictByEventCategory")&&(%request.Get(item)) {
			set eventCategoryID=$P(item,"_",2)
			set ok=##class(links.lnkEventCategoryData).add(eventCategoryID,dataID)
		}
	}
	
	if (dependsOnPrompt) {
 		// Apply att cat restrictions for dependent text blocks
		// update restrictions of text block based on parent prompt
		set rsDep=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
		do rsDep.Prepare("SELECT objEventCategory FROM links.lnkEventCategoryData WHERE objData=?")
		do rsDep.Execute(dependsOnPrompt)
		while rsDep.Next() {
			// apply current restriction to child prompt if not already set
			set currentEventCategory = rsDep.Get("objEventCategory")
			&SQL(SELECT COUNT(objEventCategory) INTO :tmp FROM links.lnkEventCategoryData WHERE objEventCategory=:currentEventCategory AND objData=:dataID)
			if ((+SQLCODE=0)&&(tmp=0)){
				do ##class(links.lnkEventCategoryData).add(currentEventCategory,dataID)
			}
		}
	}
	
	set eventID = ##class(sc.objData).getEventID(dataID)
	if (eventID) && (##class(setup.objEvent).isEventUsingProweb2(eventID)) {
		set pageID = ##class(sc.objData).getPageID(dataID)
		set %response.Redirect = "../../proweb/frontend/start.csp?pageID="_pageID_"&eventID="_eventID
		quit 0	
	}
	
	// should we go on and publish direct? Always autopublish if we are writing an email
	if %request.Get("publish")="yes"!(##class(sc.objData).inMail(dataID)) {
		set %response.Redirect="publish.csp"
	} else {
		if %request.Get("txtGotoPage")="" {
			 set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))
		} else {
			set %session.Data("reuse created object")=dataID
			set %session.Data("reuse dataType")="objText"
			set %response.Redirect=%request.Get("txtGotoPage") // after goto re-use
		}
	}

	// go back to editor if we switched mode
	if %request.Get("mode")'="" {
		set %response.Redirect="textDetailsMoxie.csp?dataID="_dataID_"&mode="_%request.Get("mode")_"&displayOrder="_displayOrder_"&templateID="_templateID_"&parent="_parent //_"&templateURL="_%request.Get("templateURL")
	}
	
	// switching to CSSMainPage.csp
	if %request.Get("butEdit.x") {
		set %response.Redirect="../home/CSSMainPage.csp"
		// store some needed session data first
		set %session.Data("parent")=parent
		set %session.Data("moxieDataID")=dataID
		set %session.Data("isCOD")=%request.Get("isCOD")
	}
	
	quit 0
</script>
<html>
<body>
<script language="cache" runat="server">
	if %session.Data("errMessage")'="" {
		write "<scr"_"ipt language='javasc"_"ript'>alert("_%session.Data("errMessage")_");</sc"_"ript>"
		kill %session.Data("errMeassage")
	}
	
</script>
<script language='javascript'>
	document.location = "blank.csp";
</script>
</body>
</html>
]]></CSP>


<CSP name="backEnd/proweb/updateLabelText.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<script language="cache" runat="server">
	set prowebID = %request.Get("prowebID")
	set labelText = %request.Get("labelText")
	set status = "error"
	set errorMsg = "There was a problem changing the label text."
	
	try {
		set labelText = ##class(EF.sanitiser).sanitise(labelText)
		set objCODitem = ##class(sc.xModules.objCODitem).%OpenId(prowebID)
		if ($ISOBJECT(objCODitem)) {
			set oldLabelText = objCODitem.description
			set objCODitem.description = labelText
			set ok = objCODitem.%Save()
			if ('$$$ISERR(ok)) {
				set xUserID = $Get(%session.Data("eventsforce","backend","xPersonID"))
				set eventID = objCODitem.objEvent.%Id()
				set pageID = ##class(sc.xModules.objCODitem).getPageIDforQuestion(prowebID)
				set pageName = ##class(sc.xModules.objPage).getDescription(pageID)
				
				do ##class(setup.objEventAudit).add(xUserID, eventID, "Reg Page '"_pageName_"' ("_pageID_"), Changed Registration Question Label Text: "_labelText_" (New Value) - "_oldLabelText_" (Old Value)")
				
				set status = "ok"
			}
		}
	} catch errObj{
		If errObj.%IsA("shared.exceptions.generalException") {
			set errorMsg = errObj.DisplayString()
		}	
	}
		
	write "{ ""status"" : """_status_""""
	if status = "error" {
		write ", ""errorMsg"" : """_##class(shared.jsonFunctions).jsonEscape(errorMsg)_""""
	} else {
		write ", ""labelText"" : """_labelText_""""
	}
	write " }"
</script>
]]></CSP>


<CSP name="frontEnd/reg/errorLoadingPage.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="cache" runat="server">w ##class(shared.pageMethods).outputFrontendHeader()</script>
<head>
<layout:section from="" to="{{ef_header}}">
<csp:include page="frontendHTTPheader.csp">
<csp:include page="colourScheme.csp">
</head>
<body class="bodyBackground">

<layout:section from="{{ef_header}}" to="{{ef_banner}}">
<layout:section from="{{ef_banner}}" to="{{ef_main_progress}}">
<layout:section from="{{ef_main_progress}}" to="{{ef_main_header}}">
<layout:section from="{{ef_main_header}}" to="{{ef_main_content}}">
	<h1>
		<tx>Error in loading page</tx>
	</h1>
	<p>
		<h3>#(%request.Get("reasonForRedirect"))#</h3>
	</p>

<layout:section from="{{ef_main_content}}" to="{{ef_main_buttons}}">
<layout:section from="{{ef_main_buttons}}" to="{{ef_footer}}">
<layout:section from="{{ef_footer}}" to="">
</body>
</html>
]]></CSP>


<CSP name="frontEnd/reg/frontendStyles.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="CACHE" method="OnPreHTTPbefore" arguments="" returntype="%Boolean">
	if %request.Get("noStyleTags") {
		set %response.ContentType="text/css"
	}
	quit 1
</script>
<script language="cache" runat="server"> 
	// Set up common variables
	set frontBack="frontend"
	// if edit mode or preview mode use backend
	if %session.Get("mode")="edit" set frontBack="backend"
	if %request.Get("hideButtons") set frontBack="backend"
	
	set surveyID=%request.Get("surveyID")
	
	
	set xLangID=$G(%session.Data("eventsforce",frontBack,"xLangID"))
	set xLanguage=$G(%session.Data("eventsforce",frontBack,"xLanguage"))
	set xEventID=$G(%session.Data("eventsforce",frontBack,"xEventID"))
	set xEventDescription=$G(%session.Data("eventsforce",frontBack,"xEventDescription"))
	
	if surveyID set xEventID="",xEventDescription=""

	set xDateFormat=$G(%session.Data("eventsforce",frontBack,"xDateFormat"))
	set xTimeFormat=##class(setup.objEventSetting).getParameter("system","time format",xEventID)
	if xDateFormat="" set xDateFormat=##class(setup.objSetting).getParameter("system","defaultDateFormat")
	set xControllerID=""
	if xEventID	{
		set xControllerID=##class(setup.objEvent).getControllerID(xEventID)
		set xDateFormat=##class(setup.objEvent).getDateFormat(xEventID)
	}
	set %session.Data("eventsforce",frontBack,"xDateFormat")=xDateFormat

	set useQtip=1
	
</script>
<script language="cache" runat="server">
	// get some properties from the template
	set tmpTemplateID=$G(%session.Data("eventsforce","frontend","layoutTemplateID"))
	if 'tmpTemplateID {
		if surveyID {
			set tmpTemplateID=##class(layout.objTemplate).getLayoutForSurvey(surveyID)
		} else {
			set tmpTemplateID=##class(layout.objTemplate).getLayoutForEvent(xEventID)
		}
	}

	set styleSource=##class(layout.objTemplate).getStyleSource(tmpTemplateID)
	
	// find out if loading from editor so that we can load the core styles too.
	set fromEditor=+%request.Get("fromEditor")
	// shall we show STYLE html tags? default to no so it's backwards compatible. 
	set noStyleTags=+%request.Get("noStyleTags")
	
	// decide whether to show the frontend default stylesheet (so we can have a completely free css)
	set showFrontCSS=1
	if '##class(setup.objEventSetting).getParameter("stylesheet","use default stylesheet",xEventID) set showFrontCSS=0
	//Use the default stylesheet for surveys as we currently don't have a way of changing the stylesheet 
	if surveyID set showFrontCSS=1
	
	// decide whether to show the uploaded style sheet
	if xEventID	{
		set showFrontCSS2=0
		set objEvent=##class(setup.objEvent).%OpenId(xEventID)
		if objEvent.stylesheetFileStream.Size set showFrontCSS2=1
		if '##class(setup.objEventSetting).getParameter("stylesheet","use uploaded stylesheet",xEventID) set showFrontCSS2=0
	} else{
		set showFrontCSS2=0
	}
	//stop uploaded and default style sheets appearing for frontend
	set streamTemplateStyleSheet=0
	if styleSource="template" {
		set showFrontCSS=0,showFrontCSS2=0
		if fromEditor {
			set streamTemplateStyleSheet=1
			do ##class(layout.cssDefaultMethods).outputGen2Defaults()
			do ##class(layout.cssOverrideMethods).outputDynamicCSS(xEventID)
		}
	}
	
	if 'noStyleTags w "<style>",!
	
	// CSS output order is different for Gen3, so all CSS is output by layout.cssDefaultMethods:outputDefaultCSS 
	if ##class(layout.objTemplate).isTemplateGen3(tmpTemplateID) {
		if streamTemplateStyleSheet {
			do ##class(layout.cssOverrideMethods).streamTemplateStyleSheet(xEventID,styleSource)	
		}
	} else {
		if showFrontCSS {
			do ##class(layout.cssDefaultMethods).outputLegacyDefaultCSS()
		}
		if showFrontCSS2 {
			do ##class(layout.cssOverrideMethods).outputUploadedStylesheet(xEventID)
		}
		if streamTemplateStyleSheet {
			do ##class(layout.cssOverrideMethods).streamTemplateStyleSheet(xEventID,styleSource)	
		}
		if (##class(layout.objTemplate).isTemplateGen2(tmpTemplateID))	{ // if we are using the new color picker, then output the buttons that use those colors and have a better design
			do ##class(layout.cssDefaultMethods).outputGen2and3Defaults()
			do ##class(layout.cssDefaultMethods).outputGen2Defaults()
		}
		w !,"</style>",!
		&html<
			<link rel="stylesheet" href="../../media/stylesheets/frontend/gen1-3/ef-website-gen1-3-main.css" type="text/css" />
		>
		w "<style>",!
		if (##class(layout.objTemplate).isTemplateGen2(tmpTemplateID))	{
			do ##class(layout.cssOverrideMethods).outputDynamicCSS(xEventID)
		}
	}
	if (##class(layout.methods).canUseStyleOverrides(xEventID))	{  // we also have a white content area but use body bg colour for our default and standard designs
		if fromEditor do ##class(layout.cssOverrideMethods).outputStyleToChangeBGColourInMoxie()
	}
	
	if ##class(layout.methods).canUseWebsiteColorsForEvent(xEventID) {
		do ##class(layout.cssOverrideMethods).outputCustomEventCSS(xEventID)		
	}	

	if 'noStyleTags w "</style>",!
	
	if (##class(layout.objTemplate).isTemplateUsingProweb2(layoutTemplateID)) && (##class(sc.objTemplate).isProweb2ImplementedForPageName(%request.PageName)) {
		if ##class(shared.pageMethods).getEditMode() = "edit" {
			&html<
				<!-- ====== Proweb2 editor styles ============= -->
				<link rel="stylesheet" href="../../media/stylesheets/backend/gen4/ef-editor.css" type="text/css" />
			>
		}	
	}
</script>
]]></CSP>


<CSP name="frontEnd/reg/home.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class super="EF.pages.base">
<csp:parameter name="contextDataClass" value="EF.contextDataFrontend">
<csp:parameter name="mvcHandlerClass" value="EF.mvcHandler.frontendProweb">


<script language="cache" runat="server">
	Do ##super() 
</script>

<csp:section name="PageContent">
   	<div class="row ef-proweb-reorderable" data-ef-reorderable-save-url="#(..encodeForHTMLAttribute(..Link("../../frontend/reg/reorderProwebElements.csp")))#" >
		<ef-proweb2-element prowebcomponentname="Main List" componenttype="list" >
	</div>
</csp:section>

]]></CSP>


<CSP name="frontEnd/reg/pageControllerStandardSave.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">

<script language="cache" method="OnPreHTTPafter" arguments="" returntype="%Library.Boolean"> 
	#dim pageController as EF.pageController.page
	set contextData = ##class(EF.contextDataRegistration).createFromFrontendCSPSession()
	set pageControllerID=%request.Get("prowebPageControllerID")
	if 'pageControllerID {
		throw ##class(shared.exceptions.generalException).%New("No pageControllerID passed in to standardSave")
	}
	
	set ok=1
	set pageController=##class(EF.pageController.page).open(pageControllerID,contextData) 
	
	set pageNavProceedKey = %request.Get("pageNavProceedKey") 
	set backforward=##class(setup.objPageNav).goWhere(pageNavProceedKey, , contextData.tempPersonID, %request.Get("pageID")) 
	set redirectURL = $Piece(backforward,"|",2)

	set pageController.submitButtonClickedIdentifier=%request.Get("efSubmitButtonIdentifier")
	
	if %request.Get("efSaveAndReloadFormOnly") {
		// copy submitted fields into the pageController
		do pageController.updateFromRequest()
		do pageController.%Save()
		

	} else {
		// copy submitted fields into the pageController
		do pageController.updateFromRequest()
		
		// validate all data
		do pageController.validatePage() 
		if pageController.errorMessages.Count() {
			set pageController.hasError=1
		}
		
		// save the temp structure to database
		if 'pageController.hasError {
			// save temp structure to database
			Try {
				// the save has the validation and THROWS exceptions if any validations fail
				do pageController.save()

			} Catch exObj {
				set ok=0
				If exObj.%IsA("shared.exceptions.generalException") {
					set error=exObj.DisplayString()
				} else {
					// don't know what this error was (like a sub method throwing an error)
					set error="There was an error saving this page"
					throw exObj
				}
				do pageController.setErrorMessage(error)
				set pageController.hasError=1
			}
		}
		do pageController.%Save()
	}
	do pageController.copyAllDataToEComTemp()
	if pageController.hasError {
		set redirectURL = ##class(EF.htmlGenerator).addParameterToURL("registration.csp", "prowebPageControllerID",pageControllerID) // #######
		set redirectURL = ##class(EF.htmlGenerator).addParameterToURL(redirectURL, "pageID", %request.Get("pageID"))
		set redirectURL = ##class(EF.htmlGenerator).addParameterToURL(redirectURL, "eventID", contextData.eventID)
	}
	set %response.Redirect=redirectURL
	quit 0
</script>

]]></CSP>


<CSP name="frontEnd/reg/registration.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class super="EF.pages.base">
<csp:parameter name="contextDataClass" value="EF.contextDataRegistration">
<csp:parameter name="mvcHandlerClass" value="EF.mvcHandler.frontendProwebRegistration">
<csp:parameter name="pageNavProceedKey" value="codFormSave.csp">

<script language="cache" runat="server">
	Do ##super() 
</script>

<csp:section name="PageContent">
   	<div class="row ef-proweb-reorderable" data-ef-reorderable-save-url="#(..encodeForHTMLAttribute(..Link("../../frontend/reg/reorderProwebElements.csp")))#" >
		<ef-proweb2-element prowebcomponentname="Main List" componenttype="listWithQuestionsRegistration" >
	</div>
</csp:section>

]]></CSP>


<CSP name="frontEnd/reg/reorderProwebElements.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<script language="cache" runat="server">
	set contextData = ##class(EF.contextDataRegistration).createFromFrontendCSPSession()
	set pageControllerID = %request.Get("prowebPageControllerID")
	if 'pageControllerID {
		throw ##class(shared.exceptions.generalException).%New("No pageController passed in to the re-ordering page")
	}
	set orderedElementIds = %request.Get("orderedElementIds")
	set pageController = ##class(EF.pageController.proweb.page).open(pageControllerID,contextData)
	
	do pageController.reorderProwebElements(orderedElementIds)
</script>
]]></CSP>


<CSP name="frontEnd/reg/tRegistration.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="cache" runat="server">w ##class(shared.pageMethods).outputFrontendHeader()</script>
<head>
<layout:section from="" to="{{ef_header}}">
<csp:include page="frontendHTTPheader.csp">
<csp:include page="colourScheme.csp">
</head>
<body class="bodyBackground">
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	set sessionID=%session.SessionId
	set mode=%request.Get("mode")
	if mode="" set mode=%session.Get("mode")

	quit 1
</script>
<script language="cache" runat="server">
	// flag for making proweb display COD related things
	set isCOD=1
</script>

<sc:templatestart>

<script language="cache" runat="server">
	// v2.7 - need these as we lookup the page description now from the link table
	if '$G(xEventID) set xEventID=$G(%session.Data("eventsforce","backend","xEventID"))
	if '$G(xLangID) set xLangID=$G(%session.Data("eventsforce","backend","xLangID"))
	if '$G(pageID) set pageID=$G(%session.Data("pageID"))
	
	// are we in an accessible layout?
	set isAccessible=##class(layout.methods).isAccessible(xEventID)

	// tell the codQuestionDetails page to go back here after edit/add
	set gotoPage="../../frontend/reg/"_%request.PageName_"?pageID="_pageID
	if %request.Get("hideButtons") set gotoPage=gotoPage_"&hideButtons=1"
	set %session.Data("eventsforce","backend","cod question gotoPage")=gotoPage
 

	if (%session.Get("mode")="preview")!($G(%session.Data("inSitePageEditing")))	{
		set tempPersonID=%request.Get("tempPersonID")
		if $L(tempPersonID)=0 set tempPersonID=$G(%session.Data("eventsforce","frontend","currentPersonID"))
		// find out where to go
		if $L(tempPersonID),'%request.Get("hideButtons"){
			set backforward=##class(setup.objPageNav).goWhere(pageID,,tempPersonID)
			set backpage=$P(backforward,"|",1)  // go back
			set forwardpage=$P(backforward,"|",2)  // go forward
			// get the category (gets it from person or purchase or creates or returns blank if we will show the page to ask for it)
			set eventCategoryID=##class(eCom.tempPurchase).getEventCategory(sessionID,tempPersonID)
		} else { // allow for preview in the backend
			set backforward=""
			set backpage=""
			set forwardpage=""
			set eventCategoryID=%request.Get("eventCategoryID")
		}
	} else {  // edit mode backend
		set backforward=""
		set backpage=""
		set forwardpage=""
		set eventCategoryID=%request.Get("eventCategoryID")
	}
	
	if 'eventCategoryID	{
		set eventCategoryID=%session.Get("eventCategoryID")
	}
	
	if $L(%request.Get("eventCategoryID"))	set %session.Data("eventCategoryID")=%request.Get("eventCategoryID")
	
	// determine whether this is a meeting manager event, this will be used by tagfree
	set isMeetMan=0
	if ##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID) {
		set isMeetMan=(##class(meetMan.objDiary).getProfilePageID(eventCategoryID,xEventID,xLangID)=pageID)
	}

	/// Are we in a meeting manager page? - initialise this variable here in global scope, do the actual check in a later if block
	set meetManFileUpload=0

	set checkMerge=$G(%session.Data("eventsforce","frontend","checkMerge"))
	if ($E(forwardpage)="?"){ 
		//forward page such as ?tempPersonID=xxx, ie, no page name.
		set forwardpage="../../frontend/reg/codFormSave.csp?pageID="_pageID_"&tempPersonID="_tempPersonID
	}
	
	// don't do JS validation if accessible layout.
	set onsub="this.butProceed.disabled=true;"  
	if 'isAccessible set onsub=onsub_" return validateMandatory();"
</script>

<form name="prowebCODForm" method="post" action="#(forwardpage)#" onsubmit="#(onsub)#" AUTOCOMPLETE="off">
<layout:section from="{{ef_header}}" to="{{ef_banner}}">
<layout:section from="{{ef_banner}}" to="{{ef_main_progress}}">
	<csp:if condition=(($G(%session.Data("mode"))="preview")!($G(%session.Data("inSitePageEditing"))))>
		<csp:if condition=('%request.Get("hideButtons"))>
			<csp:include page="progress.csp">
		</csp:if>
	</csp:if>
<layout:section from="{{ef_main_progress}}" to="{{ef_main_header}}">
<script language="cache" runat="server">
	set pageHeading=..out("Attendee Details")
	if ##class(cod.objTicket).isTicketingPersonMode(xEventID)	{
		set pageHeading=..out("Attendee Details")   // make generic if we're adding people using ticketing as we may show more than one attendee category on this page
	} else {
		set pageHeading=##class(setup.lnkCategoryEvent).getPageDescription(xEventID,eventCategoryID,pageID)
	}
</script>
#(pageHeading)#
<layout:section from="{{ef_main_header}}" to="{{ef_main_content}}">
<script language="cache" runat="server">
	if isAccessible	{
		if $G(%session.Data("eventsforce","frontend","errString"))'="" {
			write !,"<h2 class=""errormessage"">",..out("Error saving data:"),"</h2>"
			set errString=%session.Data("eventsforce","frontend","errString")
			write !,"<ul class=""errormessage"">"
			for i=1:1:$L(errString,"|") w "<li class=""redbold10px errormessage"">"_$p(errString,"|",i)_"</li>"
			write !,"</ul>"
			kill %session.Data("eventsforce","frontend","errString")
		}
	
		// do we have any warnings to show
		if $G(%session.Data("eventsforce","frontend","warning string"))'="" {
			write !,"<h2 class=""warningmessage"">",..out("Warning:"),"</h2>"
			write !,"<ul class=""warningmessage"">"
			write "<li class=""redbold10px warningmessage"">"_%session.Data("eventsforce","frontend","warning string")_"</li>"
			write !,"</ul>"
			kill %session.Data("eventsforce","frontend","warning string")
		}
	}	
</script>
		<table width="100%" border="0" cellspacing="3" cellpadding="0" class="black12px ef-registration-section" id="mainTable">
			<tr>
				<td colspan="2"><sc:text name="header"></td>
			</tr>
				<script language="cache" runat="server">
					if ##class(setup.objEventSetting).getParameter("registration pages","supress hardcoded email field for new and copied events - May 2016",xEventID) {
						set showEmail=0
					} else {
						set showEmail=1	
					}
				</script>
				<csp:if condition="showEmail">
					<script language="cache" runat="server">
						set doNotShowEmail=##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)
						if ##class(setup.objEventSetting).getParameter("system","do not use email",xEventID) set doNotShowEmail=1
						
						if ##class(cod.objTicket).isTicketingPersonMode(xEventID) set doNotShowEmail=1
						set emailOrUsername=##class(setup.objEventSetting).getParameter("system","identifying field",xEventID)
						
						// Fred Sep 2010 - add an override to hide the email field if required
						if ##class(setup.objEventSetting).getParameter("system","hide email field in tRegistration",xEventID) set doNotShowEmail=1
					</script>
					<csp:if condition=(doNotShowEmail)>
					<csp:else>
						<tr>
							<td class="black12px ef_proweb_form_prompt"><tx>Email</tx></td>
							<td class="black12px ef_proweb_form_field_container ef_proweb_form_field_container_type_text">
								<csp:if condition=(emailOrUsername="username")>
									<script language="cache" runat="server">
										set codID=##class(cod.objItemName).getIDFromDescriptionNoEvent("EMAIL2")
										set tempPersonID=$G(tempPersonID)
									</script>
									<input type="text" name="txtQuestion_#(codID)#__0__#(tempPersonID)#" id="txtQuestion_#(codID)#__0__#(tempPersonID)#" size=50 class="EF_inputBox" value="#(##class(eCom.tempCodData).get(tempPersonID,"email2"))#">
								<csp:else>
									#(##class(eCom.tempCodData).get(%request.Get("tempPersonID"),"email"))#
								</csp:if>
								
							</td>
						</tr>
					</csp:if>
				</csp:if>
			
				<script language="cache" runat="server">
					set ticketingPersonMode=0
					if (%session.Get("mode")="preview")&(##class(cod.objTicket).isTicketingPersonMode(xEventID)),'%request.Get("hideButtons") set ticketingPersonMode=1
				</script>
				<csp:if condition=(ticketingPersonMode)>
						<script language="cache" runat="server">
						// store current pageid before we insert another one
						set curPageID=%request.Get("pageID")
						if curPageID="" set curPageID=$G(%session.Data("pageID"))
						
						// get all the pages for each category
						kill allRegPages,allRegPageIDs
						set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xLangID,backendBooking,.allRegPages,.allRegPageIDs)
					</script>
					<script name="rs77" language="SQL" P1="#(sessionID)#">
						SELECT ID
						FROM eCom.tempPerson 
						WHERE (tempPurchase->sessionID = ?) AND (isDelegate=1) AND (active=1) 
						ORDER BY ID
					</script>
					<csp:while condition="rs77.Next()">
						<script language="cache" runat="server">
							set tmpTempPersonID=rs77.Data("ID")
							set tmpEventCategoryID=##class(eCom.tempPurchase).getEventCategory(sessionID,tmpTempPersonID)
							set tmpDesc=" ",tmpDisplayOrder=""
							if tmpEventCategoryID	{
								set tmpDesc=$E(##class(setup.objEventCategory).getDescription(tmpEventCategoryID),1,150)_tmpEventCategoryID
								// go to the first (and only category) reg page
								set tmpDisplayOrder=$O(allRegPages(tmpEventCategoryID,""))
								set tmpPageID=allRegPages(tmpEventCategoryID,tmpDisplayOrder)
								set tmpDisplayOrder=##class(setup.lnkAttendeeCategoryDetailsEvent).getDisplayOrder(xEventID,tmpEventCategoryID)
							}
							set personList(+tmpDisplayOrder,+tmpEventCategoryID)=tmpPageID
							set personList(+tmpDisplayOrder,+tmpEventCategoryID,tmpTempPersonID)=""
						</script>
					</csp:while>
					<script language="cache" runat="server">
						//Save the current tempPersonID from session.
						set oldTempPersonID = $G(%session.Data("eventsforce","frontend","currentPersonID"))
						// repeat the tagfree for each attendee
						set (tmpDisplayOrder,tmpEventCategoryID)=""
						for  {
							set tmpDisplayOrder=$O(personList(tmpDisplayOrder))
							if tmpDisplayOrder="" quit
							for  {
								set tmpEventCategoryID=$O(personList(tmpDisplayOrder,tmpEventCategoryID))
								if tmpEventCategoryID="" quit
								set pageID=personList(tmpDisplayOrder,tmpEventCategoryID)													
								set %session.Data("pageID")=pageID

								// get the page description
								set pageHeading=##class(setup.lnkCategoryEvent).getPageDescription(xEventID,tmpEventCategoryID,pageID)
								do ..OnPageHeadingSection()
								set tempPersonOverride=""
								for  {
									set tempPersonOverride=$O(personList(tmpDisplayOrder,tmpEventCategoryID,tempPersonOverride))
									if tempPersonOverride="" quit
									s tempPersonCountByCat(tmpEventCategoryID) = $G(tempPersonCountByCat(tmpEventCategoryID)) + 1
						
									//save the current personID before going to tagfree.
									s %session.Data("eventsforce","frontend","currentPersonID") =  tempPersonOverride //so that the system can pick up this person's attendee category in tagfree.csp.
									do ..OnPageProwebSection()
								}
							}
						}

						//set the current person to the original personID here. SHAHADAT 18-02-10
						set %session.Data("eventsforce","frontend","currentPersonID") = oldTempPersonID
						// reset the pageID
						if curPageID {
							set pageID=curPageID
							set %session.Data("pageID")=pageID
						}
					</script>
				<csp:else>
					<script language="cache" runat="server">
						// if in edit mode just show one persons fields
						do ..OnPageProwebSection()
					</script>
				</csp:if>
				<script language="cache" runat="server">
					/// Are we in a meeting manager page?
					if isMeetMan {
						if ##class(setup.objEventSetting).getParameter("meetMan","file Upload",xEventID) {
							set meetManFileUpload=1
							do ..OnPageMeetFileSection()
						}
					}
				</script>
				<csp:section name="HeadingSection">
					<tr><td colspan="2" height="10"><hr></td></tr>
					<tr><td colspan="2" height="20">#(pageHeading)#</td></tr>
					<tr><td colspan="2" height="10">&nbsp;</td></tr>
				</csp:section>
				<csp:section name="ProwebSection">
					<script language="cache" runat="server">
						if ($G(isCOD)=1) {
							set beforeItem=##class(sc.xModules.objPage).getBeforeItem(pageID,,1)
						} else {
							set beforeItem=##class(sc.xModules.objPage).getBeforeItem(pageID)
						}
					</script>
					<SC:FREE NAME="Main List" BEFOREROW="" AFTERROW="" BEFOREITEM="#(beforeItem)#" AFTERITEM="</td></tr>">
					<tr><td colspan="2" height="30"></td></tr>
				</csp:section>
				
				<csp:section name="MeetFileSection">
					<tr>
						<td></td>
						<td class="blackbold10px">
							<table border=0 cellpadding=0 cellspacing=0 width=100%>
								<tr>
									<td class="blackbold10px">
										<tx>Uploaded Files</tx>
									</td>
									<td width=70>
										<csp:if condition=(%session.Get("mode")="preview")>
											<csp:if condition=('%request.Get("hideButtons"))>
												<input class="standardButton" type="button"  value="#(..out("Upload"))#" name="butUpload" onClick="SaveAndUploadProfile('#($G(tempPersonID))#');"  title="Upload a file from your computer">
											</csp:if>
										</csp:if>
									</td>
								</tr>
							</table>
						</td>
					</tr>
					<script name="rsMeetMan" language="SQL" P1="#($G(tempPersonID))#">
						SELECT * FROM  meetMan.tempFile
						WHERE tempDiary->tempPerson = ?
						ORDER BY xCRstamp
					</script>
					<tr>
						<td class="black10px" colspan=2>
							<table border=0 cellpadding=2 >
								<script language="cache" runat="server">
									set fileCount=0
									set webPath=##class(meetMan.objFile).getWebPath(xEventID)
									set FTPpath=##class(meetMan.objFile).getFTPpath(xEventID)
								</script>
								<csp:while condition="rsMeetMan.Next()">
									<script language="cache" runat="server">
										set tempEntryFileID=rsMeetMan.Get("ID")
										set filename=rsMeetMan.Get("fileName")
										set hasUploaded=1
										set fileCount=fileCount+1
										
										set date=##class(shared.dateFunctions).multiDate(rs.Get("xCRstamp"),xDateFormat)
										set time=$p($p(rsMeetMan.Get("xCRstamp")," ",2),":",1,2)
										set show=1
										if filename="" set show=0
										
										// if new entry, suppress the ones that was defaulted but we have clicked Remove on
										if $D(%session.Data("eventsforce","frontend","meetMan files to suppress",tempEntryFileID)) set show=0
									</script>		
									<csp:if condition=(show)>
										<tr>
											<td width=100></td>
											<td class="black10px" >
												<script language="cache" runat="server">
													set size=##class(shared.ftpMethods).getFileSize(FTPpath,filename)
												</script>
												<a target="_blank" href="#(webPath_..EscapeURL(filename))#">#($P(filename,"_",3,99))#</a>
												#(size\1024)#&nbsp;Kb															
											</td>
											<td width=40></td>
											<td class="black9px">
												#(date)#&nbsp;&nbsp;#(time)#
											</td>
											<td width=15></td>
											<td class="black9px">
												<a href="javascript: removeProfileFile(#(tempEntryFileID)#);"><tx>remove</tx></a>
											</td>
										</tr>
									</csp:if>
								</csp:while>
							</table>
						</td>
					</tr>
				</csp:section>							
		</table>

<layout:section from="{{ef_main_content}}" to="{{ef_main_buttons}}">
<script language="cache" runat="server">
	set show=1
	if %request.Get("hideButtons") set show=0
	if %session.Get("mode")="edit",'$G(%session.Data("inSitePageEditing")) set show=0
</script>

<csp:if condition=(show)>
	<input type="hidden" name="tempPersonID" value="#(%request.Get("tempPersonID"))#">
	<table width="100%" border="0" cellspacing="0" cellpadding="5">
		<tr>
			<csp:comment><!-- NOTE. The submit button will be placed here in runtime as a proweb item --></csp:comment>
			<td width="33%" align="left">
				<csp:include page="frontEndButton.csp?buttonText=Back&URL=#(..EscapeURL(backpage))#&hoverText=Go Back">
			</td>
			<td width="33%" align="center" style="vertical-align: bottom;">
				<script language="cache" runat="server">
					set ticketingPersonMode=0
					if (%session.Get("mode")="preview")&(##class(cod.objTicket).isTicketingPersonMode(xEventID)),'%request.Get("hideButtons") set ticketingPersonMode=1
					
					set show=1
					
					//only show "add another delegate" option if they've come from the Add Another Attendee link on the basket page, in which case seenBasket will be set
					&SQL(SELECT seenBasket INTO :tmp FROM eCom.tempPurchase WHERE sessionID = :sessionID)
					if ((+SQLCODE=0) && (tmp'=1)){
						set show=0
					}
					
					if ('ticketingPersonMode) { set show=0 }
				</script>
				<csp:if condition=(show)>
					<script language="cache" runat="server">
						//add option to add new delegate 
						set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
						set qry="SELECT ID,categoryToCreate FROM cod.objTicket WHERE (eventID=?) AND (scCodItemID->active=1)"
						if ('(##class(eCom.tempPurchase).isBackendBooking(sessionID))) {
							set qry=qry_" AND (scCodItemID->backendOnly=0)"
						}
						do rs.Prepare(qry)
						do rs.Execute(xEventID)
					</script>
					<csp:while condition="rs.Next()">
						<script language="cache" runat="server">
							set tmpEventCategoryID=rs.Get("categoryToCreate")
							
							if (tmpEventCategoryID) {
								set show=1
								if $D(tempPersonCountByCat(tmpEventCategoryID)) {
									set totalBooked = tempPersonCountByCat(tmpEventCategoryID)
										set maximum=$P(##class(cod.objTicket).getMinMax(rs.Get("ID")),"|",2)
										if maximum,totalBooked>=maximum set show=0										
								}
								if show {
									set tmpDisplayOrder=+##class(setup.lnkAttendeeCategoryDetailsEvent).getDisplayOrder(tmpEventCategoryID,xEventID)
									set ticketArray(tmpDisplayOrder,tmpEventCategoryID)=rs.Get("ID")
								}
							}
						</script>
					</csp:while>
					<script language="cache" runat="server">
						set tmpDisplayOrder=""
					</script>
					<csp:if condition=($l($o(ticketArray(tmpDisplayOrder))))>
						Add another <select name="selAddTicketCategory" class="ef_element ef_element_dropdown EF_inputBox">
						<option value=""></option>
							<csp:while condition=($l($o(ticketArray(tmpDisplayOrder))))>
							<script language="cache" runat="server">
									set tmpDisplayOrder=$O(ticketArray(tmpDisplayOrder))
									set tmpEventCategoryID=""
							</script>
								<csp:while condition=($l($o(ticketArray(tmpDisplayOrder,tmpEventCategoryID))))>
									<script language="cache" runat="server">
										set tmpEventCategoryID=$O(ticketArray(tmpDisplayOrder,tmpEventCategoryID))
										set tmpTicketID=ticketArray(tmpDisplayOrder,tmpEventCategoryID)
									</script>
									<option value="#(tmpTicketID)#">#(##class(setup.objEventCategory).getDescription(tmpEventCategoryID))#</option>
								</csp:while>
						</csp:while>
						</select>	
					</csp:if>
				</csp:if>									
			</td>
			<td width="34%" align="right">
				<csp:if condition=((%session.Get("mode")="preview")!($G(%session.Data("inSitePageEditing"))))>
					<input type="hidden" name="pageID" value="#($G(pageID))#">
					<input type="hidden" name="uploadMeetManFile" value=0>
					<input type="hidden" name="mergeWithBooker" value=0>
					<input type="hidden" name="tempFileID" value=0>
					<input type="hidden" name="deleteMeetManFile" value=''>
					<csp:include page="frontEndButton.csp?isSubmit=1&name=butProceed&buttonText=Proceed&hoverText=Submit and proceed">
					<input type="hidden" name="uploadFile" value=''>
					<input type="hidden" name="deleteFile" value=''>
					<input type="hidden" name="uploadItemNameID" value=''>
					<input type="hidden" name="uploadTempPersonID" value=''>
					<input type="hidden" name="uploadGuestNumber" value=''>
					<input type="hidden" name="uploadDataID" value=''>
				<csp:else>
					<img src="../../media/images/english/default/frontend/proceed.gif" alt="Proceed" border="0">
				</csp:if>
			</td>
		</tr>
	</table>
</csp:if>
<layout:section from="{{ef_main_buttons}}" to="{{ef_footer}}">

<csp:if condition=(checkMerge)>
	<script language="javascript">
		$(function() {
			if (confirm(#(..QuoteJS(..out("This attendee has the same first and last name as the registration contact, would you like to merge the details?")))#) == true) {
				document.forms[0].mergeWithBooker.value = 1;
				document.forms[0].submit();
			} else {
				document.forms[0].submit();
			}
		})
	</script>
</csp:if>

<csp:if condition=(meetManFileUpload)>
	<script language="javascript">
		function SaveAndUploadProfile(tempPersonID) {
			document.forms[0].uploadMeetManFile.value = 1;
		
			document.prowebCODForm.submit();
		}
		function removeProfileFile(tempFileID) {
			document.forms[0].deleteMeetManFile.value = tempFileID;
			document.prowebCODForm.submit();
		}
	</script>
</csp:if>

<script language="javascript">
	function SaveAndUpload(tempPersonID,dataID,guestNumber) {
		document.forms[0].uploadFile.value = 1;
		document.forms[0].uploadTempPersonID.value=tempPersonID;
		document.forms[0].uploadGuestNumber.value=guestNumber;
		document.forms[0].uploadDataID.value=dataID;
	
		document.prowebCODForm.submit();
	}
	function removeFile(tempPersonID,codItemNameID) {
		document.forms[0].deleteFile.value = codItemNameID;
		document.forms[0].uploadTempPersonID.value=tempPersonID;
		document.forms[0].uploadItemNameID.value=codItemNameID;
		
		document.prowebCODForm.submit();
	}
</script>
	
<layout:section from="{{ef_footer}}" to="">
#[ do ##class(sc.methods).outputFormCompleteMarker() ]#
</form>  

<csp:include page="editingFooter.csp"> 

<sc:templatestop>

<script language="cache" runat="server">
	set amendMode=+$G(%session.Data("eventsforce","frontend","amend"))

	// Do we have any error message from a previous save to show
	if 'isAccessible	{
		if $G(%session.Data("eventsforce","frontend","errString"))'="" {
			write !,"<sc"_"ript language='javas"_"cript'>"
			set errString=%session.Data("eventsforce","frontend","errString")
			set temp=""
			for i=1:1:$L(errString,"|") set temp=temp_$p(errString,"|",i)_$c(10)
			write !,"alert("_..QuoteJS(temp)_");"
			write !,"</sc"_"ript>"
			// allow for messages to non-javascript browsers
			write !,"<nosc"_"ript>"
			write !,##class(shared.stringFunctions).hyperTranslate(temp,$C(10),"<br>")
			write !,"</nosc"_"ript>"
			kill %session.Data("eventsforce","frontend","errString")
		}
	
		// do we have any warnings to show
		if $G(%session.Data("eventsforce","frontend","warning string"))'="" {
			write !,"<sc"_"ript language='javas"_"cript'>"
			write !,"alert("_..QuoteJS(%session.Data("eventsforce","frontend","warning string"))_");"
			write !,"</sc"_"ript>"
			// allow for messages to non-javascript browsers
			write !,"<nosc"_"ript>"
			write !,##class(shared.stringFunctions).hyperTranslate(%session.Data("eventsforce","frontend","warning string"),$C(10),"<br>")
			write !,"</nosc"_"ript>"
			kill %session.Data("eventsforce","frontend","warning string")
		}
	}	
</script>
</body>
</html>
]]></CSP>


<CSP name="frontEnd/reg/tmenu.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="cache" runat="server">w ##class(shared.pageMethods).outputFrontendHeader()</script>

<head>
<layout:section from="" to="{{ef_header}}">
<csp:include page="frontendHTTPheader.csp">
<csp:include page="colourScheme.csp">
</head>
<body class="bodyBackground">
<sc:templatestart>
<script language="cache" runat="server">
	do ..OnPageProwebSection()
</script>
<csp:section name="ProwebSection">
	<script language="cache" runat="server">
		set URLbit="/"_$ZCVT(^%ZCSPAPPS($ZNSPACE),"L")   // so that it works for no framesets too - should always be absolute (without domain)

		set showEFLogo=##class(setup.objSetting).getParameter("system","show eventsforce logo in menu")
		// might be calling this page from another page - i.e. when using noframeset

	</script>

	<div id="ef_menu_area" class="ef_proweb_menu_block ef-menu-block noPrint">
		<script language="cache" runat="server">
			set beforeItems="",afterItems="",beforeRow="",afterRow=""   

			// determine which layout is in use
			set tmpLayoutTemplateID=##class(layout.objTemplate).getLayoutForEvent(xEventID)

			// special fix for when we have horizontal items - have to stop the "<br>" 
			if $ZCVT(##class(layout.objTemplate).getIntDesc(tmpLayoutTemplateID),"U")="FRONTENDFRAMESET3.CSP" set afterItems=""
			if $ZCVT(##class(layout.objTemplate).getIntDesc(tmpLayoutTemplateID),"U")="LAYOUT6" set afterItems=""
			set isInclude=1  // added this to avoid some special behaviour when isCOD etc.
			
			// output the menu twice to accommodate bootstrap's way of doing responsive menues
			set showRepeatedMenu=0
			if $G(%session.Data("mode"))'="edit"  {
				if ##class(layout.objTemplate).hasBootstrapMenu(tmpLayoutTemplateID) {
					set showRepeatedMenu=1 	
				}
			}
		</script>
		
		
		<csp:if condition=(showRepeatedMenu)>
			<div class="dropdown visible-xs-block">
                    <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown" type="button">Menu <span class="caret"></span>
                    </button>			
                    <script language="cache" runat="server">
                    	do ##class(EF.pages.frontend.base).outputProwebListRows("INDEXLIST", $G(%session.Data("pageID")),0,1)
                    </script>
			</div>
		</csp:if>
		
		<div class="ef_nav_horizontal hidden-xs" role="nav">	
			<script language="cache" runat="server">
		            	do ##class(EF.pages.frontend.base).outputProwebListRows("INDEXLIST", $G(%session.Data("pageID")),0,0)
		            </script>
		</div>
		
		<script language="cache" runat="server">
			set isInclude=0
		</script>
	</div>


<script language="cache" runat="server">
	// AUTO POUPLATE THE MENU WITH ITEM PRONOIA THINK SHOULD BE THERE
	// THIS CODE HAS TO BE AFTER THE SC FREE TAG SO THAT THE LIST IS AUTO GENERATED FIRST

	// first get the pageID to get the listID
	if $G(%session.Data("eventsforce","frontend","xPrefLangID")) set xLangID=%session.Data("eventsforce","frontend","xPrefLangID")
	set tmp="",listID="",pageID=%session.Data("pageID")
	&SQL(SELECT ID INTO :tmp FROM sc_xModules.objList WHERE (parent=:pageID) AND (active=1) )
	if +SQLCODE=0 set listID=tmp
	// now check if to see if any data items exist with the objList as their parent,
	// if not then this is first time in the page so auto create the defaults

	if listID	{
		set URLbit="/"_$ZCVT(^%ZCSPAPPS($ZNSPACE),"L")   // JAW 03MAY2007 - so that it works for no framesets too - should always be absolute (without domain)
		set tmp="",create=0
		&SQL(SELECT ID INTO :tmp FROM sc.objData WHERE (parent=:listID AND active=1))
		if +SQLCODE'=0 set create=1   // no data items exist with the listID as their parent
		if create	{
			do ##class(setup.eventCreationMethods).addDefaultMenuItems(pageID,xLangID)		
			
			// reload page as now the image items are part of the above free list thingy
			write "<scr"_"ipt language=JavaSc"_"ript>self.document.location=self.document.location</scr"_"ipt>"
		}
	}
</script>
<csp:include page="../../frontEnd/reg/socialMediaButtons.csp?option=menu">	
</csp:section>

<csp:include page="editingFooter.csp">

<sc:templatestop>

</body>
</html>
]]></CSP>


<CSP name="media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-04/index.html" application="/largedevsrc/" default="1"><![CDATA[
<link rel="stylesheet" type="text/css" href="../../media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-04/template-styles.css" >
[[ef_header]]
<div class="container ef-template-container">
  <div class="jumbotron ef-banner" role="banner">
        [[ef_banner]]
  </div>
  <div class="row">
      <div class="col-sm-3 ef-left-column" role="navigation">
        [[ef_menu]]
      </div>
      <div class="col-sm-9 ef-middle-column" role="main">
    [[ef_main_progress]]
    [[ef_main_header]]
    [[ef_main_content]]
    [[ef_main_buttons]]
      </div>
  </div>		
	<div class="row">
		<div class="col-sm-12 ef-footer">
			[[ef_footer]]
			[[ef_logo]]
		</div>
	</div>
</div>
]]></CSP>


<CSP name="media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-04/style.LESS" application="/largedevsrc/" default="1"><![CDATA[
// out: template-styles.css 


/* Navigation */
.ef-menu-block-ul {
	padding: 0;
	margin: 0;
}

.ef-menu-block-ul li {
    list-style-type: none;
	border-bottom: 1px solid #ffffff;
}

.ef-menu-block-ul a {
	padding: 10px 0 10px 12px;
	text-decoration: none;
	display: block;
}

/* non-standard fonts are downloaded from google fonts  */
@font-face {
  font-family: 'Roboto Slab';
  font-style: normal;
  font-weight: 400;
  src: local('Roboto Slab Regular'), local('RobotoSlab-Regular'), url(https://themes.googleusercontent.com/static/fonts/robotoslab/v1/y7lebkjgREBJK96VQi37ZobN6UDyHWBl620a-IRfuBk.woff) format('woff');
}













]]></CSP>


<CSP name="media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-07/index.html" application="/largedevsrc/" default="1"><![CDATA[
<link href="../../media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-07/template-styles.css" rel="stylesheet">
[[ef_header]]
<div class="container ef-template-container">
	<div class="jumbotron" role="banner">
		[[ef_banner]]
	</div><!-- /.jumbotron -->
	<div class="row">
    	<div class="col-sm-12" role="navigation">
			[[ef_menu]]
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12">
			[[ef_main_progress]]
			[[ef_main_header]]
		</div>
	</div>
	<div class="row">
		<div id="middle_column" class="col-sm-9 ef-event-middle-column" role="main">
			[[ef_main_content]]
			[[ef_main_buttons]]
		</div>
		<div id="right_column" class="col-sm-3 ef-event-right-column">
			[[ef_right]]
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12 ef-footer">
			[[ef_footer]]
			[[ef_logo]]
		</div>
	</div>
</div>
]]></CSP>


<CSP name="media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-07/style.LESS" application="/largedevsrc/" default="1"><![CDATA[
// out: template-styles.css 

/* Navigation */
.ef-menu-block-ul {
    font-size: 0;
    padding: 0;
    margin: 0;
    border: 0;
    list-style: none;
    line-height: 34px;
    height: 34px;
}

.ef-menu-block-ul li {
    display: inline-block;
    zoom: 1;
    *display: inline;
    border-right: 1px solid #ffffff;
    height: 34px;
}

.ef-menu-block-ul a {
    display: inline-block;
    padding-left: 22px;
    padding-right: 22px;
    margin-bottom: 0;
    text-decoration: none;
    text-align: left;
}
.ef-menu-block-ul>* {
    font-size: 13px;
}





]]></CSP>


<CSP name="media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-08/index.html" application="/largedevsrc/" default="1"><![CDATA[
<link href="../../media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-08/template-styles.css" rel="stylesheet">
  [[ef_header]]
<div class="container ef-template-container">
		<div class="row ef-template-navigation" role="navigation">
        	<div class="col-sm-12">
				[[ef_menu]]
			</div>
		</div>
		<div class="jumbotron" role="banner">
			[[ef_banner]]
		</div>
		<div class="row ef-template-main" role="main">
        	<div class="col-sm-12">
				[[ef_main_progress]]
				<div class="ef-page-header">
					[[ef_main_header]]
				</div>
				[[ef_main_content]]
				[[ef_main_buttons]]
			</div>
		</div>
		<div class="row">
        	<div class="col-sm-12 ef-footer">
				[[ef_footer]]
				[[ef_logo]]
			</div>
		</div>
</div>
]]></CSP>


<CSP name="media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-08/style.LESS" application="/largedevsrc/" default="1"><![CDATA[
// out: template-styles.css 


/* Navigation */
.ef-menu-block-button {
    padding-left: 40px;   
}

.ef-template-navigation {
    position: fixed; // stop it from scrolling
    z-index: 99; // make sure it stays on top of everything
    width: 100%; // make the menu bar extension go across the page
}

.ef-template-container .jumbotron {
    // move the rest of the page down when in edit mode
    position: relative;
    margin-bottom: 40px;
    top: 40px;   
}

// position the small viewfinder dropdown menu
.ef-menu-block-ul-xs {
    margin-left: 30px;
    margin-top: 0px;
    padding: 0px;
}

// format the large viewfinder menu
.ef-menu-block-ul {
    font-size: 0;
    padding-left: 40px;
    margin: 0;
    border: 0;
    list-style: none;
    line-height: 34px;
    height: 34px;
}

.ef-menu-block-ul li {
    display: inline-block;
    *display: inline;
    zoom: 1;
    border-right: 1px solid #ffffff;
    height: 34px;
}

.ef-menu-block-ul a {
    display: inline-block;
    padding-left: 22px;
    padding-right: 22px;
    margin-bottom: 0;
    text-decoration: none;
    text-align: left;
}
.ef-menu-block-ul>* {
    font-size: 13px;
}

// makre sure the page doesn't float out across the entire width of very large screens
.ef-template-container .jumbotron,
.ef-nav-horizontal,
.ef-template-main
{
    max-width: 1280px;
    margin-left: auto;
    margin-right: auto;
}

/* non-standard fonts are downloaded from google fonts  */
@font-face {
  font-family: 'Roboto Slab';
  font-style: normal;
  font-weight: 400;
  src: local('Roboto Slab Regular'), local('RobotoSlab-Regular'), url(https://themes.googleusercontent.com/static/fonts/robotoslab/v1/y7lebkjgREBJK96VQi37ZobN6UDyHWBl620a-IRfuBk.woff) format('woff');
}

]]></CSP>


<CSP name="media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-09/index.html" application="/largedevsrc/" default="1"><![CDATA[
  [[ef_header]]
<div class="container ef-template-container">
		<div class="jumbotron" role="banner">
			[[ef_banner]]
		</div><!-- /.jumbotron -->
		<div class="row" role="main">
        	<div class="col-sm-12">
				[[ef_main_progress]]
				[[ef_main_header]]
				[[ef_main_content]]
				[[ef_main_buttons]]
			</div>
		</div>
		<div class="row">
        	<div class="col-sm-12 ef-footer">
				[[ef_footer]]
				[[ef_logo]]
			</div>
		</div>
</div>
]]></CSP>


<CSP name="media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-21/index.html" application="/largedevsrc/" default="1"><![CDATA[
<link rel="stylesheet" href="../../media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-21/template-style.css" rel="stylesheet" />

[[ef_header]]

<style>
body {background-color:white;}
#eflogodiv {padding-top:10px;padding-bottom:10px;}
</style>

<div id="wrapper">

<div id="middle_column">

[[ef_main_progress]]

[[ef_main_header]]

[[ef_main_content]]
	[[ef_main_buttons]]

	[[ef_footer]]

	[[ef_logo]]

</div> <!-- end of middle_column div -->

<div style="clear:both;"></div>

</div> <!-- end of wrapper div -->
]]></CSP>


<CSP name="media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-21/style.LESS" application="/largedevsrc/" default="1"><![CDATA[
// out: template-styles.css 

/* Navigation */
.ef-menu-block-ul {
	text-align: left;
	padding-top:7px;
	padding-bottom:7px;
	padding-left:0px;
	padding-right:0px;
	margin:0px;
	border: 0px;
	background-color: #17b3c4;
	height:20px;
}

.ef-menu-block-ul li {
	display: inline;
	list-style-type: none;
	height: 40px;}

.ef-menu-block-ul a {
	font:  13px Verdana, Arial, Helvetica, sans-serif;
	padding:8px 22px 10px 22px;
	margin-bottom: 0px;
	background-color: #17b3c4;
	text-decoration:none;
	text-align: left;
	margin-right: -4px;
	border-right: 1px solid #ffffff;
	}
	
.ef-menu-block-ul  a:hover {	
	background-color: #4D141F;
	color: #ffffff;
}


/* boxes */
#wrapper {
	margin:20px;
	background-color: #ffffff;
}

#middle_column {
	background-color: #ffffff;
	min-height: 500px;
}
	
]]></CSP>


<CSP name="system/eventsForceRules.csr" application="/largedevsrc/" default="1"><![CDATA[
	// please note that the NEW command dannot be used in rules! (nor the: <CSP:if>)


// This little beuty replaces the given path in compile time with a call to an inherited page method in runtime!
// It also translates the 'Alt' and the 'Title' attributes
<csr:RULE name="PathExpander" match="IMG[SRC]" empty>
<csr:ACTION>
<script language="cache" runat="compiler">
	set inPath=%this.GetAttribute("SRC")
	if inPath'["StreamServer" { // leave streamed images
		if inPath["#(" {
			// do nothing if dynamic
		} else {
			set inPath="#(..resolvePath("""_inPath_"""))#" 
			do %this.SetAttribute("SRC",inPath)
		}
	}
		
	set titleText=%this.GetAttribute("TITLE")
	//if (titleText'="")&(titleText'["#(") set titleText="#(##class(shared.translation).translateSingle(%request.PageName,%session.Get(""xLanguage""),"""_titleText_"""))#" 
	if (titleText'="")&(titleText'["#(") set titleText="#(..out("""_$TR(titleText,"""","'")_"""))#" 
	do %this.SetAttribute("TITLE",titleText)

	set altText=%this.GetAttribute("ALT")
	//if (altText'="")&(altText'["#(") set altText="#(##class(shared.translation).translateSingle(%request.PageName,%session.Get(""xLanguage""),"""_altText_"""))#" 
	if (altText'="")&(altText'["#(") set altText="#(..out("""_$TR(altText,"""","'")_"""))#" 
	do %this.SetAttribute("ALT",altText)
	
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>


//Same as above but for input tags with images (submit button to you and me)
<csr:RULE name="PathExpander2" match="INPUT[SRC]" empty>
<csr:ACTION>
<script language="cache" runat="compiler">
	set inPath=%this.GetAttribute("SRC")
	if inPath'["StreamServer" { // leave streamed images
		if inPath["#(" {
			// do nothing if dynamic
		} else {
			set inPath="#(..resolvePath("""_inPath_"""))#" 
			do %this.SetAttribute("SRC",inPath)
		}

	}

	set titleText=%this.GetAttribute("TITLE")
	//if (titleText'="")&(titleText'["#(") set titleText="#(##class(shared.translation).translateSingle(%request.PageName,%session.Get(""xLanguage""),"""_titleText_"""))#" 
	if (titleText'="")&(titleText'["#(") set titleText="#(..out("""_$TR(titleText,"""","'")_"""))#" 
	do %this.SetAttribute("TITLE",titleText)
	
	set altText=%this.GetAttribute("ALT")
	//if (altText'="")&(altText'["#(") set altText="#(##class(shared.translation).translateSingle(%request.PageName,%session.Get(""xLanguage""),"""_altText_"""))#" 
	if (altText'="")&(altText'["#(") set altText="#(..out("""_$TR(altText,"""","'")_"""))#" 
	do %this.SetAttribute("ALT",altText)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efA" match="ef-a" myData>
<csr:ACTION>
<script language="cache" runat="compiler">
	set %this.TagName="a"
	do ##class(EF.ui.cspRuleMethods).linkStandatdURLAttributes(%this)
	do ##class(EF.ui.cspRuleMethods).htmlEncodeAllAttributes(%this)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efSelect" match="ef-select" myData>
<csr:ACTION>
<script language="cache" runat="compiler">
	set %this.TagName="select"
	do ##class(EF.ui.cspRuleMethods).linkStandatdURLAttributes(%this)
	do ##class(EF.ui.cspRuleMethods).htmlEncodeAllAttributes(%this)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efInput" match="ef-input" myData>
<csr:ACTION>
<script language="cache" runat="compiler">
	set %this.TagName="input"
	do ##class(EF.ui.cspRuleMethods).linkStandatdURLAttributes(%this)
	do ##class(EF.ui.cspRuleMethods).htmlEncodeAllAttributes(%this)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

// language thing for href tags with titles
<csr:RULE name="titleAHREF" match="A[TITLE]" myData>
<csr:ACTION>
<script language="cache" runat="compiler">
	set titleText=%this.GetAttribute("TITLE")
	if (titleText'="")&(titleText'["#(") set titleText="#(..out("""_$TR(titleText,"""","'")_"""))#" 
	do %this.SetAttribute("TITLE",titleText)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

// language thing for span tags with titles
<csr:RULE name="titleSPAN" match="SPAN[TITLE]" myData>
<csr:ACTION>
<script language="cache" runat="compiler">
	set titleText=%this.GetAttribute("TITLE")
	if (titleText'="")&(titleText'["#(") set titleText="#(..out("""_$TR(titleText,"""","'")_"""))#" 
	do %this.SetAttribute("TITLE",titleText)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

// Replace the path to the stylesheet
// No longer needed, but you can't just delete a csp rule
<csr:RULE name="StyleSheetFinder" match="LINK[HREF]" empty>
<csr:ACTION>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>


// Translate the breadtext
<csr:RULE name="breadText" match="tx" myData>
<csr:attribute name=cl description="The classname to use in the span" type="expression:STRING">
<csr:attribute name=nospan description="If 1 then do not surround the text with a span" type="expression:STRING">
<csr:ACTION>
<script language="cache" runat="compiler">
	// Replace the innertext with a call to ..out()
	set txText=%this.InnerText()   // GET THE CONTENTS OF THE TX TAGS
	set txText=$TR(txText,"""","'")
	set (v1plus,v2plus,v3plus)=0
	
	// extract the variables
	set var1=$P($p(txText,"#(",2),")#",1)
	if var1?1"+".E set var1=$e(var1,2,99),v1plus=1
	if var1'="" set txText=$p(txText,"#(",1)_"{{{VAR01}}}"_$p(txText,")#",2,99)

	set var2=$P($p(txText,"#(",2),")#",1)
	if var2?1"+".E set var2=$e(var2,2,99),v2plus=1
	if var2'="" set txText=$p(txText,"#(",1)_"{{{VAR02}}}"_$p(txText,")#",2,99)

	set var3=$P($p(txText,"#(",2),")#",1)
	if var3?1"+".E set var3=$e(var3,2,99),v3plus=1
	if var3'="" set txText=$p(txText,"#(",1)_"{{{VAR03}}}"_$p(txText,")#",2,99)
	  
	set routine=classname // classname is intersystems variable. it might change in the next version
	
	set string="..out("""_txText_""""
	set string=string_","""_routine_""""
	if var1'="" {
		if var1="BR" {
			set string=string_","_$S(v1plus:"+",1:"")_"<BR>"
		} else {
			set string=string_","_$S(v1plus:"+",1:"")_"$G("_var1_")"
 		}
	}
	if var2'="" set string=string_","_$S(v2plus:"+",1:"")_"$G("_var2_")"
	if var3'="" set string=string_","_$S(v3plus:"+",1:"")_"$G("_var3_")"
	set string=string_")"
	
	//set CSSclassname="ef_tx_normal" // fred june 2009 - removed becuase it is creating mixed font sizes when data is mixed with text
	set CSSclassname=""
	if $L(..GetAttribute("cl")) set CSSclassname=..GetAttribute("cl")
	
	// do not write out the span if we specifically say so or if backend page
	set doSpan=1
	if CSSclassname="" set doSpan=0
	
	if ..GetAttribute("nospan")=1 set doSpan=0
	if $L($G(%pageName)),$ZCVT(%pageName,"L")["/backend/" set doSpan=0

	if doSpan do ..WriteText("<span class="""_CSSclassname_""">")
	Do ..WriteExpressionText(string) 
	if doSpan do ..WriteText("</span>")

	//Do ..WriteExpressionText("..out("_txText_")   // csp rule:breadText")     
	//
</script>
</csr:ACTION>
</csr:RULE>


<!-- SYSTEMTYPE IF --------------------------------------------- -->
// create if statements around a section of code based on the systemType (setup.objSystemType)
<csr:rule name="systemTypeIF" match="SYSTEMTYPE:IF">
<csr:attribute name=module required description="A run-time expression to be evaluated." type="expression:STRING">
<csr:attribute name=autoelse description="should this write the standard page not allowed msg" type="expression:STRING">

<csr:description>
	The autoelse=1 causes an ELSE to be written automatically containing the "This is only available in the following editions..." message
	If autoelse is used then you CANNOT use ELSE.
	<EXAMPLE>
		<systemType:if module="EMAIL" autoelse="1">
			do email stuff
		</systemType:if>
	</EXAMPLE>
</csr:description>

<csr:class super=%CSP.RuleBlock>

<csr:action>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>
		Do ..NewBlock()
		Set ..NextLabel=..GetNewLabel()
		Do ..WriteServer(" If '(##class(setup.objSystemTypes).isModuleAllowed("""_..GetAttribute("MODULE")_""")) Goto "_..NextLabel_" ;{")
	</SCRIPT>
	<csr:children>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>
		New ifblock
		if ..GetAttribute("AUTOELSE")=1	{   // if this is used then cannot use an ELSE tag - otherwise it will not work.
			Set ifblock=..GetCurrentBlock()
			If ifblock.EndLabel="" Set ifblock.EndLabel=..GetNewLabel()
			Do ..WriteServer(" Goto "_ifblock.EndLabel_" ;} END IF")
			Do ..WriteServer(ifblock.NextLabel_" ;{ START ELSE")
			// do the standard msg stuff
			Set ifblock.NextLabel=""
		}

		New comment Set comment=" ;} END ELSE"
		If ..EndLabel'="" Do ..WriteServer(..EndLabel_comment) Set comment=""
		If ..NextLabel'="" Do ..WriteServer(..NextLabel_comment)
		Do ..RemoveBlock()
	</SCRIPT>
</csr:action>

</csr:rule>

<!-- SYSTEMTYPE ELSE --------------------------------------------- -->
<csr:rule name="systemTypeELSE" match="SYSTEMTYPE:IF/SYSTEMTYPE:ELSE" empty>

<csr:description>
	see description for systemTypeIF
</csr:description>

<csr:class super=%CSP.RuleBlock>

<csr:action>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>
		New ifblock
		Set ifblock=..GetCurrentBlock()
		If ifblock'="" {
			If ifblock.EndLabel="" Set ifblock.EndLabel=..GetNewLabel()
			Do ..WriteServer(" Goto "_ifblock.EndLabel_" ;} END IF")
			Do ..WriteServer(ifblock.NextLabel_" ;{ START ELSE")
			Set ifblock.NextLabel=""
		}
	</SCRIPT>
</csr:action>
</csr:rule>

<csr:rule name="layoutSection0" match="LAYOUT:SECTION" empty>
<csr:attribute name=from required description="the tag to start writing from" type="expression:STRING">
<csr:attribute name=to required description="the tag to end at" type="expression:STRING">
<csr:action>
<script language="cache" runat="compiler">
	//Do ..WriteExpressionText(string) 
	//do ..WriteText("</span>")
    Do ..WriteServer(" do ##class(layout.objTemplate).writeBit("""_..GetAttribute("FROM")_""","""_..GetAttribute("TO")_""")")
</script>
</csr:action>
</csr:rule>

// =============================================================================================================================
<csp:comment><!-- PROWEB RULES--></csp:comment>
	// please note that the NEW command cannot be used in rules! (nor the: <CSP:if>)
// =============================================================================================================================



<csr:rule name="TEMPLATESTART" match="SC:TEMPLATESTART" empty dwenabled>
<csr:description>
	The <B>CS:TEXT</B> tag is the proWeb's initialising a template page.
</csr:description>
<csr:action>
<script language="cache" runat="server">
	set app=##class(sc.objData).applicationPath()
	do ##class(cspRealEV.system.proweb.templatestart).OnPageCSPROOT()
	
	// put the pageID int the session
	// JAW - done in template start (security hole) if %request.Get("pageID")'="" set %session.Data("pageID")=%request.Get("pageID")
</script>

</csr:action>
</csr:rule>

// =============================================================================================================================
<csr:rule name="TEMPLATESTOP" match="SC:TEMPLATESTOP" empty dwenabled>
<csr:description>
	The <B>CS:TEXT</B> tag is the proWeb's ending a template page.
</csr:description>
<csr:action>
<script language="cache" runat="server">
	set app=##class(sc.objData).applicationPath()
	do ##class(cspRealEV.system.proweb.templatestop).OnPageCSPROOT()
</script>
<script language="javascript">
// open popup window
function proWebNewWin(mypage,myname,w,h,scroll){
	leftPos = (screen.width) ? (screen.width-w)/2 : 0;
	topPos = (screen.height) ? (screen.height-h)/2 : 0;
	settings = 'height='+h+',width='+w+',top='+topPos+',left='+leftPos+',scrollbars=' + scroll + ',resizable=yes'
	win = window.open(mypage,myname,settings)
	win.focus();
}
</script>
</csr:action>
</csr:rule>

// =============================================================================================================================
<csr:rule name="TEXT" match="SC:TEXT" empty dwenabled>
<csr:description>
	The <B>CS:TEXT</B> tag is the proWeb's way of outputting a block of text. It will include an external page that only handles texts. Texts may include html formatting.
</csr:description>
<csr:attribute name="NAME" description="Specifies the component name of the template page" type="accessType:STRING">
<csr:action>
 <script language="CACHE" runat="SERVER">
	new pageURL,app
  
	// retrieve the passed component name
	set %session.Data("componentName")=##'%this.GetAttribute("NAME")'##

	set app=##class(sc.objData).applicationPath()
	set pageURL=app_"/system/proWeb/tagText.csp"
	do ##class(cspRealEV.system.proweb.tagtext).OnPageCSPROOT()
 </script>
</csr:action>
</csr:rule>


// =============================================================================================================================
<csr:rule name="FREE" match="SC:FREE" empty dwenabled>
FRRE RULE
<csr:description>
	The <B>SC:FREE</B> tag is the proWeb's way of outputting a list of freely chosed items. It will include an external page that only handles lists.
</csr:description>
<csr:attribute name="NAME" description="Specifies the component name of the template page" type="accessType:STRING">
<csr:action>
<script language="CACHE" runat="SERVER">
	do ##class(EF.pages.frontend.base).outputProwebListRows(##'%this.GetAttribute("NAME")'##, %session.Get("pageID"),1)
	s a="test"
</script>
</csr:action>
</csr:rule>

// =============================================================================================================================
<csr:rule name="IMAGE" match="SC:IMAGE" empty dwenabled>
<csr:description>
	The <B>CS:IMAGE</B> tag is the proWeb's way of outputting an image. It will include an external page that only handles images.
</csr:description>
<csr:attribute name="NAME" description="Specifies the component name of the template page" type="accessType:STRING">
<csr:action>
 <script language="CACHE" runat="SERVER">
  new pageURL,app
  
  // retrieve the passed component name
  set %session.Data("componentName")=##'%this.GetAttribute("NAME")'##
  set app=##class(sc.objData).applicationPath()
  set pageURL=app_"/system/proweb/tagImage.csp"
	if +$system.Version.GetNumber()<5 {		
	  	do DisplayPage^%customCSP(pageURL)
	} else {
		do ##class(cspRealEV.system.proweb.tagimage).OnPageCSPROOT()
	}

 </script>
</csr:action>
</csr:rule>



<csr:RULE name="HTMLLANG" match="HTML" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
    // set the lang attribute for the HTML tag
    Do ..SetAttribute("lang","en")
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>



<csr:RULE name="efBackendToggle" match="EF:BACKEND:TOGGLE" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendToggleAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendToggleAttr"_"("""_attr_""")="_value)
	}
</script>
<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderEfBackendToggle(.efRulesVarBackendToggleAttr)
</script>
</csr:ACTION>
</csr:RULE>



<csr:RULE name="efBackendTextField" match="EF:BACKEND:TEXTFIELD" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendTextFieldAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendTextFieldAttr"_"("""_attr_""")="_value)
	}
</script>
<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendTextField(.efRulesVarBackendTextFieldAttr)
</script>
</csr:ACTION>
</csr:RULE>



<csr:RULE name="efBackendTextArea" match="EF:BACKEND:TEXTAREA" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendTextAreaAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendTextAreaAttr"_"("""_attr_""")="_value)
	}
</script>
<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendTextArea(.efRulesVarBackendTextAreaAttr)
</script>
</csr:ACTION>
</csr:RULE>



<csr:RULE name="efBackendURLField" match="EF:BACKEND:URLFIELD" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendURLFieldAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendURLFieldAttr"_"("""_attr_""")="_value)
	}
</script>
<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendURLField(.efRulesVarBackendURLFieldAttr)
</script>
</csr:ACTION>
</csr:RULE>


<csr:RULE name="efBackendImageUploader" match="EF:BACKEND:IMAGEUPLOADER" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarImageUploaderAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarImageUploaderAttr"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderImageUploader(.efRulesVarImageUploaderAttr)
</script>
</csr:ACTION>
</csr:RULE>


<csr:RULE name="efBackendSaveButton" match="EF:BACKEND:SAVEBUTTON" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendSaveButtonAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendSaveButtonAttr"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendSaveButton(.efRulesVarBackendSaveButtonAttr)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efBackendButton" match="EF:BACKEND:BUTTON" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendButtonAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendButtonAttr"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendButton(.efRulesVarBackendButtonAttr)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efBackendColorPicker" match="EF:BACKEND:COLORPICKER" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendColorPickerAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendColorPickerAttr"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendColorPicker(.efRulesVarBackendColorPickerAttr)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efBackendInlineColorPicker" match="EF:BACKEND:INLINECOLORPICKER" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendInlineColorPickerAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendInlineColorPickerAttr"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendInlineColorPicker(.efRulesVarBackendInlineColorPickerAttr)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efBackendErrorMessage" match="EF:BACKEND:ERRORMESSAGE:START" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendErrorMessage")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendErrorMessage"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendErrorMessageStart(.efRulesVarBackendErrorMessage)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efBackendErrorMessageEnd" match="EF:BACKEND:ERRORMESSAGE:STOP" empty>
<csr:ACTION>
<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendErrorMessageEnd(.efRulesVarBackendErrorMessage)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efPageControllerElement" match="ef-pc-element" empty>
	<csr:ACTION>
		<script language="CACHE" runat="COMPILER">
		   Do ..WriteServer("	// -- generated from eventsForceRules.csr - 'ef-pc-element' --")
		   Do ..WriteServer("	kill efRulesTempParams")
		   kill paramsordered
		   do ..GetAttributesOrdered(.paramsordered)
		   set index=""
		   for {
				set index=$o(paramsordered(index))
				if index="" quit
				set attr=$ZCVT($LIST(paramsordered(index),1),"L")
				set value=..QuoteAttribute(attr)
				Do ..WriteServer("	set efRulesTempParams"_"("""_attr_""")="_value)
			}
			</script>
			<script language="CACHE" runat="SERVER">
			   do pageController.renderHTMLControlFromTag(.efRulesTempParams)
			   kill efRulesTempParams
			</script>
			<script language="CACHE" runat="COMPILER">
			Do ..WriteServer("	// -- end of rule --")
		</script>
	</csr:ACTION>
</csr:RULE>

<csr:RULE name="efPageControllerElement2" match="ef-proweb2-element" empty>
	<csr:ACTION>
		<script language="CACHE" runat="COMPILER">
		   Do ..WriteServer("	// -- generated from eventsForceRules.csr - 'ef-proweb2-element' --")
		   Do ..WriteServer("	kill efRulesTempParams")
		   kill paramsordered
		   do ..GetAttributesOrdered(.paramsordered)
		   set index=""
		   for {
				set index=$o(paramsordered(index))
				if index="" quit
				set attr=$ZCVT($LIST(paramsordered(index),1),"L")
				set value=..QuoteAttribute(attr)
				Do ..WriteServer("	set efRulesTempParams"_"("""_attr_""")="_value)
			}
			</script>
			<script language="CACHE" runat="SERVER">
			   do %zMvcHandler.controller.renderHTMLControlFromTag(.efRulesTempParams)
			   kill efRulesTempParams
			</script>
			<script language="CACHE" runat="COMPILER">
			Do ..WriteServer("	// -- end of rule --")
		</script>
	</csr:ACTION>
</csr:RULE>


<csr:rule name="efPageControllerContainer" match="ef-pc-container">

<csr:class super=%CSP.RuleBlock>

<csr:action>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>
		Do ..NewBlock()
		Set ..NextLabel=..GetNewLabel()
		Do ..WriteServer(" kill efRulesTempParams")
		kill paramsordered
		do ..GetAttributesOrdered(.paramsordered)
		set index=""
		for {
			set index=$o(paramsordered(index))
			if index="" quit
			set attr=$ZCVT($LIST(paramsordered(index),1),"L")
			set value=..QuoteAttribute(attr)
			Do ..WriteServer(" set efRulesTempParams"_"("""_attr_""")="_value)
		}
		Do ..WriteServer(" if 'pageController.showElementFromTag(.efRulesTempParams) Goto "_..NextLabel_" ;{")
	</SCRIPT>
	<script language="CACHE" runat="SERVER">
	   Do pageController.renderContainerStartFromTag(.efRulesTempParams)
	   kill efRulesTempParams
	</script>
	<csr:children>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>
		Do ..WriteServer(" kill efRulesTempParams")
		kill paramsordered
		do ..GetAttributesOrdered(.paramsordered)
		set index=""
		for {
			set index=$o(paramsordered(index))
			if index="" quit
			set attr=$ZCVT($LIST(paramsordered(index),1),"L")
			set value=..QuoteAttribute(attr)
			Do ..WriteServer(" set efRulesTempParams"_"("""_attr_""")="_value)
		}
		Do ..WriteServer(" if 'pageController.showElementFromTag(.efRulesTempParams) Goto "_..NextLabel_" ;{")
	</SCRIPT>
	<script language="CACHE" runat="SERVER">
	   Do pageController.renderContainerEndFromTag(.efRulesTempParams)
	</script>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>

		New comment Set comment=" ;} END Container"
		If ..NextLabel'="" Do ..WriteServer(..NextLabel_comment)
		Do ..RemoveBlock()
	</SCRIPT>
</csr:action>
</csr:rule>

<csr:RULE name="efFrontendlabel" match="ef-label" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesTempParams")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesTempParams"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   do ##class(EF.ui.components.frontend.label).renderFromEfLabelRule(.efRulesTempParams)
   kill efRulesTempParams
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efAwardsCategoryDropdown" match="ef-awards-category-dropdown" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesTempParams")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesTempParams"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   do ##class(EF.ui.backend.controls.awardsCategoryDropdown).renderFromEfLabelRule(.efRulesTempParams)
   kill efRulesTempParams
</script>
</csr:ACTION>
</csr:RULE>
]]></CSP>


<CSP name="system/proweb/start.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">	
	set pageID = ##class(shared.pageMethods).getPageID()
	set eventID = ##class(sc.objData).getEventID(pageID)

	if (eventID) && (##class(setup.objEvent).isEventUsingProweb2(eventID)) & (%request.Get("initialiseSession") = 1) {
		kill %session.Data("eventsforce","frontend")
		set tempPurchaseID=##class(eCom.tempPurchase).getID(%session.SessionId)
		do ##class(eCom.tempPurchase).delete(tempPurchaseID)
	}
	
	// enforce public mode in normal cases
	if %request.Get("honorMode")'="yes",$G(%session.Data("mode"))'="edit" {
		set %session.Data("mode")="preview"
		set %session.Data("version")="current"
	}
	
	// accept mode and version changes through URL
	if %request.Get("mode")'="" set %session.Data("mode")=%request.Get("mode")
	if %request.Get("version")'="" set %session.Data("version")=%request.Get("version")
	set %session.Data("memberID")=%request.Get("memberID")

	// force preview mode non logged on users
	if '$D(%session.Data("password validated")) {
		set %session.Data("mode")="preview"
		set %session.Data("version")="current"
	}	

	// capture the flag that's used when selecting items for re-use
	set %session.Data("selectItem")=%request.Get("selectItem")
	
	
	
	set eventID = ##class(sc.objData).getEventID(pageID)
	if (eventID) && (##class(setup.objEvent).isEventUsingProweb2(eventID)) {
		set pageID = ##class(sc.xModules.objPage).getHomePageIdInsteadOfIncludePageId(pageID) // we should never render an include page on it's own
	}
	
	set cspFileName = ##class(sc.xModules.objPage).getTemplateFile(pageID)
	
	if cspFileName'="" {
		set URL=cspFileName_"?pageID="_pageID
		if %session.Get("memberID") set URL=URL_"&memberID="_%session.Get("memberID")_"&surveyID="_%request.Get("surveyID")_"&mode="_%session.Get("mode")_"&version="_%session.Get("version")

		// store the referer in the session to be picked up, stored and killed by logPageHit() in objLog
		set %session.Data("proweb","referer")=$G(%request.CgiEnvs("HTTP_REFERER"))
		
		// go to the static version of the page if we have one
		if %session.Get("xUserID")="" {
			if %request.Get("noStatic")'=1 {
				if ##class(setup.objSetting).getParameter("system","static html") {
					set tmp=##class(sc.xModules.objPage).getStaticURL(pageID)
					if tmp'="",tmp'=0 set URL=tmp
				}
			}
		}
		
		// add anchorID if we used that to navigate to this page
		if %session.Get("anchorID")'="" {
			set URL=URL_"#dataID="_%session.Data("anchorID")
			kill %session.Data("anchorID")
		}
		
		// goto page
		// add all passed in params
		set URL=URL_"&"_##class(shared.pageMethods).requestDataToParams("pageID")  // exclude pageID as added just above
		do ##class(shared.pageMethodsFrontend).setRedirection(URL)
		quit 0
	} else {
		quit 1
	}
</script>
<html>
<body>
<h3>No CspFileName Found</h3>
<br>
<font color="#FFFFFF">request pageID=#(%request.Get("pageID"))#
<br>
session pageID=#(%session.Get("pageID"))#
</font></body>
</html>
]]></CSP>


<Class name="layout.cssDefaultMethods">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: layout.cssDefaultMethods.CLS/EV.85
;vc; Component: CLS.layout.cssDefaultMethods
;vc;  Location: LargeDev
;vc; Date/Time: 24-Jan-17 14:16
;vc;      User: MindaugasL
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>layout.cssDefaultMethods.CLS/EV.85</td><td>CLS.layout.cssDefaultMethods</td><td>LargeDev</td><td style='white-space: nowrap;'>24-Jan-17 14:16</td><td>MindaugasL</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<ClassType/>
<ProcedureBlock>1</ProcedureBlock>
<TimeChanged>64308,60371.978595</TimeChanged>
<TimeCreated>63046,56232.897117</TimeCreated>

<Method name="outputDefaultCSS">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID,layoutTemplateID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	do ..outputComponentCSS()
	w "<style>",!
	
	do ..outputFonts()
	do ..outputGeneralCSS()
	do ..outputGeneralProgressBarCSS()
	do ..outputGeneralKendoCSS()
	if '##class(layout.objTemplate).isTemplateGen3(layoutTemplateID)	{
		do ..outputLegacyClasses()	
	}
	do ..outputSegmentedButtonCSS()
	do ..outputAgendaGridListSwitchCSS()
	do ..outputAgendaGeneralCSS()
	do ..outputAgendaPopoverCSS()
	
	if ##class(layout.objTemplate).isTemplateGen3(layoutTemplateID)	{
		do ..outputGen2and3Defaults()
		do ..outputGen3Defaults()
		w !,"</style>",!
		&html<
			<link rel="stylesheet" href="../../media/stylesheets/frontend/gen1-3/ef-website-gen1-3-main.css" type="text/css" />
		>
		w "<style>",!
		do ##class(layout.cssOverrideMethods).outputDynamicCSS(xEventID)
	}
	w !,"</style>",!
]]></Implementation>
</Method>

<Method name="outputLegacyClasses">
<Description>
yellow red grey etc. Used for ALL templates below gen3</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputLegacyClasses() ======= */
		a {
			color: #111111; 
		}
		a:hover { 
			color: #666666;
		}
		.yellow {background-color: #F4F4F4;}
		.grey {background-color: #e6e6e6;}
		.red, .k-calendar td.ef-date-picker-event-day {
			background-color : SILVER;
		}
		.k-calendar td.ef-date-picker-event-day {
			border-radius: 0;
		}
		.ef-time-span {
			white-space: nowrap;	
		}
		
		div.ef-button-area .ef_frontend_button_proceed,div.ef-button-area .ef-logout-button {
			float : right;
			margin-right: 0px;
			margin-left: 12px;
		}
		.k-picker-wrap .k-select {
			padding-top: 1px;	
		}
		
		input.efDatePicker, input.efTimePicker { 
			/* input box */
			margin: 0px;
			border-width: 0px;

			color: inherit;
		}

		.efDatePicker .k-picker-wrap, .efTimePicker .k-picker-wrap {
			/* inner span */
			padding: 0px;
			margin: 0px;
		}

		.efDatePicker, .efTimePicker {
			/* out span */
			padding: 0px;
			margin:0px;
		}
		
			
		
	>
]]></Implementation>
</Method>

<Method name="outputGen2and3Defaults">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputGen2and3Defaults() ======= */
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section input[type=email],
		.ef-registration-section textarea, 
		.ef-registration-section select,
		.EF_inputBox,ef-table-booking-footer,
		.select2-dropdown {
			font-family: Verdana, Arial, Helvetica, sans-serif; 
			font-size: 14px; 
			font-style: normal; 
			line-height: normal; 
			font-weight: normal; 
			text-decoration: none;			
		}
		.select2-container .select2-selection--single .select2-selection__rendered {
			padding-left: 5px;
		}
		.ef-registration-section input[type=text]:not(.efDatePicker):not(.efTimePicker) ,
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section input[type=email],
		.ef-registration-section textarea, 
		.ef-registration-section select,
		.EF_inputBox:not(.efDatePicker):not(.efTimePicker) {
			padding: 5px;
			margin-top: 2px;
			margin-bottom: 2px;
			border-width: 1px;
			border-style: solid; 
		}

		.ef-registration-section .select2-container {
			padding: 2px 0 2px 0;
		}
		.ef-registration-section .select2-container--default .select2-selection--single {
			background: none;
			border: none;
		}
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section input[type=email],
		.ef-registration-section textarea, 
		.ef-registration-section select {
			max-width: 481px;
			width: 89%;
		}
	
		
		@font-face {
		  font-family: 'Roboto Slab';
		  font-style: normal;
		  font-weight: 300;
		  src: local('Roboto Slab Light'), local('RobotoSlab-Light'), url(https://themes.googleusercontent.com/static/fonts/robotoslab/v1/dazS1PrQQuCxC3iOAJFEJR_xHqYgAV9Bl_ZQbYUxnQU.woff) format('woff');
		}
		@font-face {
		  font-family: 'Roboto Slab';
		  font-style: normal;
		  font-weight: 400;
		  src: local('Roboto Slab Regular'), local('RobotoSlab-Regular'), url(https://themes.googleusercontent.com/static/fonts/robotoslab/v1/y7lebkjgREBJK96VQi37ZobN6UDyHWBl620a-IRfuBk.woff) format('woff');
		}
		@font-face {
		  font-family: 'Roboto Slab';
		  font-style: normal;
		  font-weight: 700;
		  src: local('Roboto Slab Bold'), local('RobotoSlab-Bold'), url(https://themes.googleusercontent.com/static/fonts/robotoslab/v1/dazS1PrQQuCxC3iOAJFEJTqR_3kx9_hJXbbyU8S6IN0.woff) format('woff');
		}
 		
		.k-datepicker, .k-timepicker {
			border-radius: 0;
		}
		
		.k-picker-wrap {
			border-radius: 0;
			border:none;
		}
		.k-picker-wrap .k-input {
			border-radius: 0;
		}
		
		.ef_frontend_button, .standardButton, .strongButton, .hyperlinkButton, .ef_frontend_file_uploader .k-upload-button {
			margin-top:15px;
			
		}
		
		.ef-table .ef_frontend_button,
		.ef-table .standardButton,
		.ef-table .strongButton,
		.ef-table .hyperlinkButton,
		.ef-registration-section .ef_frontend_button,
		.ef-registration-section .standardButton,
		.ef-registration-section .strongButton,
		.ef-registration-section .hyperlinkButton,
		.ef-registration-section .ef_frontend_file_uploader .k-upload-button {
			margin-top:0px;
			
		}
		.ef_frontend_button, .ef_frontend_file_uploader .k-upload-button {
			cursor: pointer;
			font-family: Verdana, Arial, Helvetica, sans-serif;
			font-weight: normal;
			padding: 6px 15px;
			cursor: pointer;
			font-size: 12px;
			width: auto;
			-moz-border-radius: 5px;
			border-radius: 5px;
			line-height: 18px;
		}
		.ef_frontend_button:hover, .ef_frontend_file_uploader .k-upload-button {
			text-decoration: none;
			background-image:inherit;
			background-position:inherit;
			box-shadow: none;
		}
		.ef_frontend_button_proceed:hover {
			text-decoration: none;
		}
		td.ef_proweb_form_prompt {
			text-align: right;
		}

		.ef-registration-section td label {
			display: inline-block;
		    font-weight: normal;
		    margin-bottom: 0;
		    width: 100%;
		}		

		.ef-registration-section td.ef_proweb_form_prompt label {
		    text-align: right;
		}

		.ef-registration-section label.ef-radio {
			display: inline;
		   
		}
		
		
		body, p, h2, h3, td, div, .black10px, .blackbold10px, .black12px, .blackbold12px, .red9px, .whitebold12px,
		.ef_proweb_menu_ul, .ef_proweb_menu_ul a, .dropdown .btn, .EF_inputBox, .ef_frontend_button,
		.ef_frontend_file_uploader .k-upload-button, .ef_frontend_button:hover, .ef_frontend_file_uploader .k-upload-button:hover,
		.ef_frontend_button_proceed, .ef_frontend_button_proceed:hover, td.ef_proweb_form_prompt,
		.whitebold10px, a.whitebold10px:hover, .yellow, td.yellow, .grey, td.grey,
		.ef_progress_bar_text, .ef-table th,
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section textarea, 
		.ef-registration-section select {
			font-family: Verdana, Geneva, Kalimati, sans-serif;
		}
		body {
			background-color: #96C3C8;
		}
		h1 {
			color: #17b3c4;
			font-family: 'Roboto Slab',Verdana,Arial,Helvetica,sans-serif	
		}
		.ef_proweb_menu_ul, .ef_proweb_menu_ul a, .dropdown .btn,
		.select2-container--default .select2-results__option--highlighted[aria-selected]  {
			background-color: #17b3c4;	
			color: #FFFFFF;
		}
	>
	w ".ef_proweb_menu_ul li:hover, .ef_proweb_menu_ul a:hover, .dropdown .btn:hover, .dropdown .btn:focus, .open>.dropdown-toggle.btn-primary"
	w "	  {"
	w "		background-color: #128996;"
	w "		color: #FFFFFF;"
	w "	}"
	&html<
		.EF_inputBox, 
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section textarea, 
		.ef-registration-section select,
		.select2-dropdown,
		.select2-container--default .select2-selection--single .select2-selection__rendered {
			background-color: #D8ECEE; 
			color: #111111;
			border-color: #AAAAAA;
		}
		.select2-container--default .select2-selection--single .select2-selection__placeholder {
			color: inherit;
		}
		.ef-registration-section input[type=text]:disabled,
		.ef-registration-section input[type=password]:disabled,
		.ef-registration-section input[type=number]:disabled,
		.ef-registration-section input[type=url]:disabled,
		.ef-registration-section input[type=tel]:disabled,
		.ef-registration-section input[type=email]:disabled,
		.ef-registration-section textarea:disabled, 
		.ef-registration-section select:disabled {
			background-color: #EEEEEE; 
		}
		.ef_form_divider {
			color: #17b3c4;
			border-color:#17b3c4;
			background-color: #17b3c4;
		}
		.ef_progress_bar_progress_div {	
			background-color:#17b3c4;
		}
		.ef_progress_bar_border_div {	
			border: 1px solid  #AAAAAA;
		}
		.ef_frontend_button, .ef_frontend_file_uploader .k-upload-button {
			color: #111111;
			background-color: #96C3C8;
			border: 1px solid #AAAAAA;
		}
		.ef_frontend_button:hover, .ef_frontend_file_uploader .k-upload-button:hover {
			color: #111111;
			background-color: #D8ECEE;
		}
		.ef_frontend_button_proceed {
			color: #FFFFFF;
			background-color: #17b3c4;
			border: 1px solid #FFFFFF;
		}
		
		.ef_frontend_button_proceed:hover {
			color: #FFFFFF;
			background-color: #128996;
		}
		.ef_frontend_file_uploader .k-file-progress .k-progress {
		    background-color:#17b3c4
		}

		.ef_frontend_help_text_icon {
			background-color: #17b3c4;
			color: #FFFFFF;
			border-color: #128996;
		}
		.ef_frontend_help_text_popover {
			background-color: #17b3c4;
			border-color: #128996;
		}
		.ef_frontend_help_text_popover .ui-tooltip-tip, .ef_frontend_help_text_popover .qtip-tip {
			border-color: #128996;
			background-color: #17b3c4;
		}
		.ef-table-header td, 
		.ef-table-header th,
		.ef-table th {
			background-color:  #128996;
			color: #FFFFFF;
		}
		.ef-table-header a {
			color: inherit;
		}
		.ef-info-table td:first-child {
		    color: #888888;
		}
		.select2-container--default .select2-results__option[aria-selected=true] {
		    background: none;
		}
		
		.k-calendar td.ef-date-picker-event-day {
			background-color: silver;
			border-radius: 0;
		}
		input[type=checkbox].ef-multicheckbox  {
			margin-left: 0px;
			margin-right: 10px;	
		}
		.ef-multicheckbox-checkbox-label  {
			margin-left: 0px;
			margin-right: 10px;	
		}		
	>
	w " .ef_frontend_help_text_content>pre { color: #FFFFFF}"
]]></Implementation>
</Method>

<Method name="outputGen2Defaults">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		.ef-logo {padding-bottom:16px;}
		.red, .k-calendar td.ef-date-picker-event-day {
			background-color: #128996;
		}
		.whitebold10px, a.whitebold10px:hover {
			color: #FFFFFF;
		}
		/* changed box-sizing for Gen2 to make the selects the same widths as the inputs */
		.ef-registration-section select {
			-ms-box-sizing:content-box;
    		-moz-box-sizing:content-box;
    		box-sizing:content-box;
    		-webkit-box-sizing:content-box; 
		}
		.EF_inputBox.efDatePicker {
			padding: 0px;
		}
		
		.EF_inputBox.efTimePicker {
			padding: 0px;	
		}
		input.k-input, .ef-registration-section input.k-input {
			height: 28px;
		}
		.k-picker-wrap .k-select {
			border-left: 0;
		}
		
		.efDatePicker .k-picker-wrap,.efTimePicker .k-picker-wrap{
			/* inner span */
			padding-right: 26px;
		}
		.k-picker-wrap .k-select {
			padding-top: 6px;	
		}

	>
]]></Implementation>
</Method>

<Method name="outputGen3Defaults">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputGen3Defaults() ======= */
		.ef-custom-content-section img {
		  display: block;
		  max-width: 100%;
		  height: auto;
		}		
		
		a {
			color: #111111; 
			text-decoration:underline;
		}
		a:hover {
			color: #666666;
			text-decoration:underline;
		}
		/* THIS BIT IF FOR THE NEW TABLE CLASSESS */
		.ef-table td {
			color: BLACK;
			border-collapse: collapse;	
		}
		.ef-table-header
		 {
			background-color: SILVER;	
		}
		.ef-table-header td, 
		.ef-table-header th
		 {
			font-weight: bold;
			font-size: 12px;
			vertical-align: bottom;
		}
		.ef-instructionText {
			color: BLACK !important;	/* '!important' to override element style in markup */
			margin-left: 0px !important;	
		}

		.ef-table tr:nth-child(odd) {
		    background-color: #e6e6e6;
		}
		.ef-table tr:nth-child(even) {
		    background-color: #F4F4F4;
		}
		.ef-table tr.ef-row-odd, tr.ef-row-odd {
			background-color: #E6E6E6; 
		}
		.ef-table tr.ef-row-even, tr.ef-row-even {
			background-color: #F4F4F4; 
		}
		.ef-table table tr:nth-child(n) { /* used to stop the striping where each line is a table within a table */
			background-color: inherit;
			padding: 0px;
		}
		.ef-image-table	{
			table-layout: fixed;	/* needed for responsive images*/ 
		}
		.ef-logo { 
			padding-top:16px;
		}
		@media only screen and (min-width: 768px) {
			div.ef-button-area .ef_frontend_button_proceed,div.ef-button-area .ef-logout-button {
				float : right;
				margin-right: 0px;
				margin-left: 12px;
			}
		}
		.ef-table-booking-footer {
			margin-left: 20px;	
		}
		/* THIS BIT IS FOR OOVERRIDING BOOTSTRAP */
		input[type=radio], input[type=checkbox] {
		    margin: 3px 3px 3px 3px;
		}

		.ef-ie6 .container, .ef-ie7 .container, .ef-ie8 .container  {
	            width: 970px; 
	        }
	        #timeoutbox {
				font-size: 12px;
				padding: 12px;
				font-weight: normal;

	        }	
		.ef-table h4 {
			font-size: 12px;
			font-weight: bold;	
		}
		
		[class*="col-"] .select2-container {
		    width:89%!important;
		    max-width: 481px;
		}
		

	>
	write ".dropdown .btn, .btn-primary:hover, .btn-primary:focus, .btn-primary:active, .btn-primary.active, .open > .dropdown-toggle.btn-primary {",!
	write "	border-color: #FFFFFF;",!	
	write "}",!
]]></Implementation>
</Method>

<Method name="outputComponentCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set eventID=$G(%session.Data("eventsforce","frontend","xEventID"))
	if eventID {
		set layoutTemplateID=##class(layout.objTemplate).getLayoutForEvent(eventID)
		if ##class(layout.objTemplate).isTemplateUsingBootstrap(layoutTemplateID) {
			&html<
				<!-- ======= outputComponentCSS() ======= -->
				<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" type="text/css" />
			>
		}
	}
	&html<

		<link type="text/css" href="#(##class(EF.htmlGenerator).rawHTML(##class(shared.pageMethodsFrontend).getKendoBaseURL()))#/styles/kendo.common.min.css" rel="Stylesheet" />
		<link type="text/css" href="#(##class(EF.htmlGenerator).rawHTML(##class(shared.pageMethodsFrontend).getKendoBaseURL()))#/styles/kendo.silver.min.css" rel="Stylesheet" />

		<link rel="stylesheet" type="text/css" media="screen" href="//cdn.jsdelivr.net/qtip2/2.2.1/jquery.qtip.min.css" />
		
		<link rel="stylesheet" type="text/css" media="screen" href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/css/select2.min.css" />
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">	
	>
]]></Implementation>
</Method>

<Method name="outputFonts">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	
	&html<
	/* ======= outputFonts() ======= */
	@font-face { 
		font-family: 'CasinoHandRegular';
		src: url('../../media/components/frontend/fonts/Casino_Hand-webfont.eot');
		src: url('../../media/components/frontend/fonts/Casino_Hand-webfont.eot?#iefix') format('embedded-opentype'),
    	url('../../media/components/frontend/fonts/Casino_Hand-webfont.woff') format('woff'),
    	url('../../media/components/frontend/fonts/Casino_Hand-webfont.ttf') format('truetype'),
    	url('../../media/components/frontend/fonts/Casino_Hand-webfont.svg#CasinoHandRegular') format('svg');
    	font-weight: normal;
    	font-style: normal;
	}
	>
	/* end @font-face declarations */
]]></Implementation>
</Method>

<Method name="outputGeneralProgressBarCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputGeneralProgressBarCSS() ======= */
		.ef_progress_bar_border_div {
			width: 100%;
			max-width: 300px;
			border: 1px solid #AAAAAA;
			height: 12px;
			text-align: center;
			box-sizing: content-box;
			margin: 4px auto 4px auto;
			display:block;
		}
		.ef_progress_bar_progress_div {
			height: 100%;
			border: none;
			background-color: rgb(220, 220, 220);
			text-align: left;
			float: left;
		}
		.ef_progress_bar_text {
			color: #666666;
			font-size: 12px;
			font-style: normal;
			line-height: normal;
			padding:4px;
			text-align: center;
			display:block;
		}
		#ef_progressbar {
			margin-bottom: 12px;	
		}	
	>
]]></Implementation>
</Method>

<Method name="outputGeneralKendoCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputGeneralKendoCSS() ======= */ 
		
		/* date picker tweaking */

		

		.efDatePicker .k-picker-wrap, .efTimePicker .k-picker-wrap {
			border-width: 1px;
			border-style: solid;
			border-color: inherit;
			color: inherit;
		}
		.efDatePicker, .efTimePicker {
			border-width: 0px;
		}
		
		.k-picker-wrap {
			border-radius: 0;
		}
		.k-picker-wrap .k-input {
			border-radius: 0;
		}
		
		.ef_frontend_file_uploader .k-upload-status {
			display: none;	
		}
		.ef-ie8 .ef_frontend_file_uploader .k-upload-status,
		.ef-ie9 .ef_frontend_file_uploader .k-upload-status {
			display: block;
			position: inherit;
			margin-top: 16px;
			font-weight: normal;
		}
		.ef_frontend_file_uploader .k-upload {
 			position: inherit;
 			border-width:0px;
 			background: none;
		}
		.ef_frontend_file_uploader {
			background-color: inherit;
		}
		.ef_frontend_file_uploader .k-upload-button {
			margin-top:16px;
 			margin-bottom: 16px;
			margin-left: 0px;
			margin-right: 0px;
			line-height: 12px;
			float: left;
			clear: left;
		}
		
	    .ef_frontend_file_uploader .k-upload-files {
	     	border: 0px;   
	    }
	    .ef_frontend_file_uploader .k-file {
	     	border: 0px;
	     	background-color: inherit;
	    }
	    .ef_file_wrapper {
		    color: #000000;
		    text-align: left;
		    width: 100%
	    }
	    .ef_frontend_file_uploader .k-file-progress .k-progress {
		    background-color: #777777;
		}
		.ef_frontend_file_upload_progress_container {
			width:100%;
			position: relative;
			float: left;
			clear: left;
		}
	    li.k-file div.ef_file_wrapper
	    {
	        position: relative;
	    }
	    .ef_file_wrapper {
		 	margin-left:12px;
		 	margin-right:12px;
		 	margin-bottom:6px;  
		 	margin-top:6px;
	    }
	    .ef_frontend_file_uploader.k-content {
		    min-height: 84px;
		    width: 100%;
		    text-align: right;
	    }
	    
	    .ef_frontend_file_uploader .k-upload-files {
		 	line-height: 18px; 
	    }
	    
	>
]]></Implementation>
</Method>

<Method name="outputGeneralCSS">
<Description>
The basic frontend default stuff</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputGeneralCSS() ======= */ 
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section input[type=email],
		.ef-registration-section textarea, 
		.ef-registration-section select {
			width: 360px;
		}
		.ef-table {
		    width: 100%;
	    	margin-top: 10px;
	    	margin-bottom: 10px;
		}
		
		.ef-table td {
			padding-top: 7px;
			padding-bottom: 7px;
			padding-left: 8px;
			padding-right: 8px;
		}
		
		/* For embedded tables */
		.ef-table table td {
			padding-top: 0;
			padding-bottom: 0;
			padding-left: 0;
			padding-right: 0;
		}
		
		table.ef-registration-section {
			border-collapse: collapse;
			border-spacing: 0;
			border:0;
		}
		table.ef-registration-section td {
			padding-top: 4px;
			padding-bottom: 4px;
			padding-left: 4px;
			padding-right: 4px;
		}
		
		/* For embedded tables */
		.ef-registration-section table td {
			padding-top: 0;
			padding-bottom: 0;
			padding-left: 0;
			padding-right: 0;
		}

		.ef-registration-section label.ef-radio {
		    margin-right: 12px;
		}
		
		.ef-table .ef-item-discount {
			padding-left: 24px;	
		}
		.noPrint { 
		
		}
		@media print {
			.noPrint { 
				display:none; 
			}
			 a[href]:after {
   				 content: none !important;
  			}
  			a:link {
	  			text-decoration: none;	
  			}
		}
		.ef_form_divider {
			height: 2px;
			border: 0px;
			border-top: 0px solid;
			border-bottom: 0px solid;
			margin-top: 12px;
			margin-bottom: 12px;	
		}
		td.ef_proweb_form_prompt {
			width:31%;
		}
		.ef-registration-section table td.ef_proweb_form_prompt_dependent {
			padding-right: 6px;	
		}
		.ef-registration-section table td.ef_proweb_form_input_dependent {
			padding-left: 3px;	
		}
		.ef_element {
			margin-left: 0px;	
		}
		.ef_element_dependent_disabled_but_visible,
		.select2-container.ef_element_dependent_disabled_but_visible {
			background-color: #DDDDDD;
		}
			
		/* mandatory prompt asterisk */
		.mandatory {
			color: red;	
		}
		
		.ef_frontend_text_limit_exceeded {
			color: red;		
		}
		
		img.helpIcon {
			vertical-align: middle;
		}
		
		/* highlighted mandatory form fields */
		.EF_inputBox.mandatoryIgnored,
		.mandatoryIgnored,
		.ef-registration-section .EF_inputBox.mandatoryIgnored,
		.ef-registration-section .mandatoryIgnored,
		.ef-registration-section .select2-container--default.mandatoryIgnored .select2-selection--single .select2-selection__rendered {
			background-color: #fc9d9d;	
		}
		/* remove spacing on hidden dep prompts + text blocks */
		.hiddenDep { display: none; } 
		/* general instructions text style */
		.ef_frontend_instructions_text {
			font-family: CasinoHandRegular, Verdana, Arial, Helvetica, sans-serif;
			font-size: 16px;
		}
		
		.ef_frontend_overflow_ellipsis {
			white-space: nowrap;
	   		overflow: hidden;
			text-overflow: ellipsis;
			-o-text-overflow: ellipsis;
			-ms-text-overflow: ellipsis;
		}
		
		.ef_frontend_button, .ef_frontend_file_uploader .k-upload-button {
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
			font-weight: bold;
			font-size: 9px;
			text-decoration: none;
			color: black;
		}
		.standardButton {
		}
		.strongButton {
		}
		.hyperlinkButton {
		}
		.ef_frontend_button_proceed {
			min-width:85px;
		}
		.ef_frontend_button_back {
			min-width:85px;
		}
		.ef_frontend_help_text_icon {
			background-color: rgb(220,220,220);
			color: rgb(0,0,0);
			font: 12px Helvetica, Verdana, Arial, sans-serif;
			font-weight: 800;
			height: 16px;
			width: 16px;
			-moz-border-radius: 12px;
			-webkit-border-radius: 12px;
			border-radius: 12px;
			cursor: default;
			display: inline-block;
			text-align: center;
			margin-left: 12px;
			border-width: 1px;
			border-style: solid;
			border-color: #AAAAAA;
			line-height: 17px;
			text-indent: 0;
		}
		.ef_frontend_help_text_popover {
			background-color: rgb(220,220,220);
			border-color: #AAAAAA;
			-moz-border-radius: 6px;
			-webkit-border-radius: 6px;
			border-radius: 6px;
			-webkit-box-shadow: 0px 0px 10px 0px rgb(100,100,100);
			-moz-box-shadow: 0px 0px 10px 0px rgb(100,100,100);
			box-shadow: 0px 0px 10px 0px rgb(100,100,100);
		}
		.ef_frontend_help_text_popover div {
			margin: 0;
		}
		.ef_frontend_help_text_popover .ui-tooltip-tip, .ef_frontend_help_text_popover .qtip-tip {
			border-color: #AAAAAA;
			background-color: rgb(220,220,220);
		}
		
		
		.ef-awards-review hr {
			margin-top: 24px;	
			margin-bottom: 12px;	
		}
		.ef-awards-review h2 {
			margin-bottom:20px;
		}
		.ef-awards-criteria-header {
			padding-bottom:12px;	
		}
		
		.ef-awards-review label {
			font-weight: normal;
		}
		.ef-awards-review .ef-info-label {
			font-weight: bold;
		}
		.ef-primary-field {
			font-weight: bold;	
		}
		.ef-awards-review .reviewDivs {
			padding-top:12px;	
		}
		div.ef-button-area {
			margin-top: 6px;
			margin-bottom: 6px;	
		}
		.ef-button-area .ef_frontend_button, .ef-button-area a {
			margin-top: 6px;
			margin-bottom: 6px;
			margin-right:12px;
		}
		.ef-button-area a {
			white-space:nowrap;		
		}
		
		.ef-meeting-manager-contentbox {
			margin: 12px 0px 12px 0px;
			font-size: 10pt;
			background-color: #F2F2F2;
			border: 1px solid black;
			padding-left: 4px;
			padding-right: 4px;
			padding-top: 4px;
			padding-bottom: 4px;

		}
		
	>
	w " .ef_frontend_help_text_content>pre {",!
	&html<
			color: rgb(0,0,0);
			background-color: transparent;
			border: none;
			padding: 0px;
			font:  12px Helvetica, Verdana, Arial, sans-serif;
			margin: 0px;
			overflow: hidden;
			white-space: pre-wrap;       /* css-3 */
			white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
			white-space: -pre-wrap;      /* Opera 4-6 */
			white-space: -o-pre-wrap;    /* Opera 7 */
			word-wrap: normal;
			word-break: normal;
		}

		.ef_proweb_form_field_container textarea {
		    resize: vertical;
		}

		#top {position: absolute; top: -8em; display: none} /*Opera*/
		* html #top {display: block; position: absolute; top: -8em; left: 0; z-index: 0} /*Seen by IE*/
		html:not([dummy]) #top {display: block; position: absolute; top: -8em; left: 0; z-index: 0} /*Seen by Moz and FF*/
		/* class for reg prompt table rows while being dragged in edit mode */
		.tDnD_whileDrag {
			background-color:#F0F0F0;
		}
		/*  transparent BG for new templates which add a bg image/color to Moxie */
		.transparentMoxieBG {
			background: transparent none;
		}
		.ef_frontend_presenter_details_biography {
			max-width: 600px;
		}
		.ef_frontend_presenter_details_picture img {
			max-width: 200px;
		}
		.ef_frontend_presenter_details_title_and_name h1 {
			margin-bottom: 8px;
		}
		.ef_frontend_presenter_details_job_title h4 {
			font-weight: 700;
			margin: 0;
		}
		.ef_frontend_presenter_details_company h4 {
			font-weight: 400;
			margin: 0 0 1rem 0;
		}
		.ef-menu-block {
	    	margin-bottom: 20px;
		}
		.ef-menu-block .dropdown-menu {
		    top: auto;
		}

		#timeoutbox {
			position: absolute;
			top: 40%;
			left: 50%;
			width:300px;
			margin-left: -150px;
			z-index: 9999;
			background-color:#ffffff;
			padding:5px;
			border:1px;
			solid #666;
			text-align:center;
			font-weight:bold;
			visibility:hidden;
			-moz-border-radius: 11px;
			-webkit-border-radius: 11px;
			border-radius: 11px;	
		}
		#socialMediaModule{
			width:100%;
			height:100%;
			margin:10px 0px 20px 0px;
			z-index:999;
		}
    	#smShareButtons{
	    	height: 30px; }
    	.addthis_toolbox {
	    	height: 30px;
	    }
    	#smFollowButtons{
	    	margin:20px 0px;
	    }
    	#smFollowButtons img{
	    	vertical-align:bottom;
	    	*vertical-align:middle;
	    	border:0px;
	    	margin:0px 5px;
	    }
    	#smShareButtons .a{
	    	margin:2px 4px 0px;
	    }
    	#socialMediaModuleMenu{
	    	width:100px;
	    	height:40px;
	    	display:block;
	    }		    
    	#smFollowButtonsMenu{
	    	float:left;
	    	padding:0px 20px;
	    }
    	#smFollowButtonsMenu img{
	    	vertical-align:bottom;
	    	margin:5px 10px;
	    	border:0px;
	    }
		.ef-table-sub-heading {
			background-color: #CCCCCC;
			font-weight: bold;
		}
	
		.ef_proweb_form_field_container_type_textarea .ef_frontend_help_text_icon {
			vertical-align: top;
		}
		.ef-info-table td:first-child {
		    text-align: right;
		    padding-right: 5px;
		    min-width: 120px;
		}

		.ef-session-time {
			vertical-align: top;	
			text-align: right;
			width: 150px;
		}
		
		.ef-date-time,
		.ef-session-price,
		.ef-no-wrap {
			white-space: nowrap;
		}
		.ef-table .ef-author-name {
			padding-top: 0px;
		}
		.ef-table .ef-abstract-description {
			padding-bottom: 0px;
		}
		.ef-table .ef-abstract-time,
		.ef-table .ef-abstract-description{
			padding-top: 0px;
		}
		.ef-table .ef-abstract-time {
			padding-bottom: 0px;
			text-align: right;	
		}
		.ef_session_details_panel_session_property_description .ef-author-name {
			margin-bottom:7px;	
		}

		.ef-author-affiliation {
		    font-style: italic;
		}
		.ef-author-country {
			font-style: italic;				
		}

		.ef-info-table td {
		    vertical-align: top;
		}

		.ef-table .ef-table-sub-row td {
		    padding-top: 0px;
		    vertical-align: top;
		}

		.ef-table .ef-table-sub-header {
		    font-weight:bold;
		}

		.ef-session-details-sub-row {
		    margin-bottom: 4px;
		}

		.ef-primary-field {
		    font-weight: bold;
		}


		.ef-info-table pre {
			text-align: left;	
		}
		.ef-table .ef-session-name-with-abstracts,
		.ef-table .ef-session-name-with-abstracts .ef-session-price label
		 {
			font-weight: bold;	
			
		}
		.ef-table .ef-session-name-with-abstracts,
		.ef-table .ef-session-name,
		.ef-table .ef-session-location,
		.ef-table .ef-session-book, 
		.ef-table .ef-session-price,
		.ef-table .ef-session-abstract-price,
		.ef-table .ef-session-boookingLevel-capacity,
		.ef-table .ef-session-abstract-boookingLevel-capacity,
		.ef-table .ef-session-type {
			vertical-align: top;
		}
		.ef-table .ef-session-boookingLevel-capacity,
		.ef-table .ef-session-abstract-boookingLevel-capacity {
			text-align: center;	
		} 
		
		.ef-session-collision {
			background-color: red;	
		}
		.ef-session-price label {
			font-weight: normal;
		}
		.ef-session-booking-checkbox-disabled {
			background-image: url(../../media/images/english/default/frontend/cross_trans.gif);
			width: 13px;
			height: 13px;	
			border: 0px;
			margin-top: 5px;
			margin-bottom: 0px;
		}
		.ef-session-booking-checkbox-ticked {
			background-image: url(../../media/images/english/default/frontend/tick.gif);
			width: 13px;
			height: 13px;	
			border: 0px;
			margin-top: 5px;
			margin-bottom: 0px;
		}		
		.ef-session-list-abstract-row {
			font-weight: normal;	
		}
		.ef-table .ef-presenter {
			padding-top: 0px;	
		}
		.ef-inline-filter-row {
			float: left;
			margin-top: 12px;
			margin-bottom: 12px;
		}
		.ef-inline-filter-dropdown {
			float: left;
		}
		.ef-inline-filter-row .ef-inline-filter-dropdown:not(:first-child) {
			margin-left: 16px;
		}
		.ef-inline-filter-dropdown select {
			min-width: 150px;
			max-width: 300px;
		}
		#ef-absReviewList-review-button-column {
			width: 100px;
		}
		
		.ef-registration-section .select2-container--default .select2-selection--single {
			border-radius: 0;
		}
		.select2-container--default .select2-results__option--highlighted[aria-selected] {
			color: inherit;
		}
		
		.select2-container--default .select2-results__option.loading-results[aria-disabled="true"],
		.select2-container--default .select2-results__options .option.load-more {
			color: inherit;
			opacity: 0.5;
			font-style: italic;
		}
		.select2-container--default .select2-results__options .option.load-more {
			padding: 6px;
		}

		/* bug workaround: https://github.com/select2/select2/issues/3306 */		
		.select2-selection__clear {
		    position: absolute !important;
		    right: 20px !important;
		}
		
		.select2-container--default .select2-selection--single .select2-selection__rendered .ef-select2-templated-selection {
			overflow: hidden;
			text-overflow: ellipsis;
			padding-right: 16px;
			line-height: inherit;
		}
		
		.ef-highlight-warning {
			color: #cc0000;
			font-weight: bold;
		}
	>
]]></Implementation>
</Method>

<Method name="outputAgendaPopoverCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputAgendaPopoverCSS() ======= */
		/* sesstion details popover panel styles */
		.ef_qtip_session_details_popover {
			min-width: 350px;
			background: none;
			border: 0;
		}
		.ef_qtip_session_details_popover .ui-tooltip-content, .ef_qtip_session_details_popover .qtip-content {
			padding: 0;
			-moz-border-radius: 6px;
			-webkit-border-radius: 6px;
			border-radius: 6px;
			border: 0;
			-webkit-box-shadow: 0px 0px 10px 0px rgb(100,100,100);
			-moz-box-shadow: 0px 0px 10px 0px rgb(100,100,100);
			box-shadow: 0px 0px 10px 0px rgb(100,100,100);
			-ms-filter: "progid:DXImageTransform.Microsoft.Shadow(Strength=4, Direction=135, Color='#646464')";
			filter: progid:DXImageTransform.Microsoft.Shadow(Strength=4, Direction=135, Color='#646464');
		}
		.ef_qtip_session_details_popover .ui-tooltip-tip, .ef_qtip_session_details_popover .qtip-tip {
			border: 1px solid rgb(100,100,100);
			background: rgb(100,100,100);
		}
		/* this is the outermost container */
		.ef_session_details_panel_container {
			background: rgb(255,255,255);
			width: 350px;
			display: none;
			z-index: 999999999;
			overflow: hidden;
			-moz-border-radius: 6px;
			-webkit-border-radius: 6px;
			border-radius: 6px;
			margin: 0;
		}
		
		/* main sub containers */
		.ef_session_details_panel_session_properties_container {
			padding: 10px 10px 10px 10px;
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_session_info_container {
			padding: 12px 12px 12px 12px;
			display: block;
			margin: 0;
		}
	>
	
	w " .ef_session_details_panel_session_info {",!
	w "		_height: expression( this.scrollHeight > 300 ? ""300px"" : ""auto"" );",!
	w "		max-height: 300px;"
	w "		_width: expression( this.scrollWidth > 350 ? ""350px"" : ""auto"" );"
	w "		max-width: 350px;"
	w "		overflow-y: auto;"
	w "		display: block;"
	w "		margin: 0;"
	w "		background: #ffffff;"
	w "	}",!
	&html<
		.ef_session_details_panel_session_info p {
			color: rgb(160,160,160);
		}
		.ef_session_details_panel_action_button_container {
			height: 42px;
			width: 348px;
			text-align: center;
			display: inline-block;
			margin: 0;
		}
		/* each row of ef_session_details_panel_session_properties_container */
		.ef_session_details_panel_session_property_row {
			overflow: hidden;
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_session_property_row_top_spacing {
			margin-top: 10px;
		}
		/* general icon/description styling */
		.ef_session_details_panel_session_property_icon {
			height: 24px;
			width: 24px;
			float: left;
			display: inline;
			background-repeat: no-repeat;
			background-position: left center;
			display: inline-block;
			margin: 0;
			text-align: center;
			vertical-align: middle;
		}
		.ef_session_details_panel_session_property_description {
			float: left;
			display: inline;
			width: 298px;
			padding: 2px 4px 2px 4px;
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_session_property_description p {
			margin-top: 0;
			margin-bottom: 0;
		}
		/* session title / description */
		.ef_session_details_panel_title_icon {
			background-image: url("../../media/images/english/default/frontend/popover_info.png");
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_title_description {
			display: inline-block;
			margin: 0;
		}
		/* time/location */
		.ef_session_details_panel_time_location_icon {
			background-image: url("../../media/images/english/default/frontend/popover_clock.png");
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_time_location_description {
			display: inline-block;
			margin: 0;
		}
		/* presenter */
		.ef_session_details_panel_presenter_icon {
			background-image: url("../../media/images/english/default/frontend/popover_person.png");
			display: inline-block;
			margin: 0;
		}
		/*abstract presentation*/
		.ef_session_details_panel_abstract_icon {
			background-image: url("../../media/images/english/default/frontend/presentation-icon-16x16.png");
			display: inline-block;
			margin: 0;
		}
		
		
		.ef_session_details_panel_presenter_description,
		.ef_session_details_panel_presenter_description	 {
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_abstract_description {
			font-size: 10.5px;
		}
		
				
		
		/* the action button */
		.ef_session_details_panel_action_button {
			width: 326px;
			margin-left: auto;
			margin-right: auto;
			height: 30px;
			display: inline-block;
			text-align: center;
			font-size: 18px;
			font-family: 'Verdana';
			line-height: 30px;
			-webkit-border-radius: 4px; 
			-moz-border-radius: 4px;
			border-radius: 4px; 
			-moz-user-select: none;
		  	-khtml-user-select: none;
		  	-webkit-user-select: none;
		  	user-select: none;
		}
		
		.ef_session_details_panel_action_button_no_info_spacing {
			margin-top: 12px;
		}
		
	    .ef_frontend_ie7 .ef_qtip_session_details_popover .qtip-content,
	    .ef_frontend_ie8 .ef_qtip_session_details_popover .qtip-content {
			filter: none;
	    }
		
	    .ef_frontend_ie9 .ef_session_details_panel_action_button_add,
	    .ef_frontend_ie9 .ef_session_details_panel_action_button_remove {
			filter: none;
	    }
	    
		.ef_session_details_panel_action_button_add {
			border: 1px solid rgb(115,229,255);
			-webkit-border-radius: 4px; 
			-moz-border-radius: 4px;
			border-radius: 4px; 
			-webkit-box-shadow: 0 -1px 1px 0 rgb(48,116,168);
			-moz-box-shadow: 0 -1px 1px 0 rgb(48,116,168);
			box-shadow: 0 -1px 1px 0 rgb(48,116,168);
			color: #FFFFFF;
		 	cursor: pointer;
			background-color: rgb(73,193,242); /* Old browsers */
			background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzQ5YzFmMiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMzMDc0YTgiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
			background-image: -moz-linear-gradient(top,  rgb(73,193,242) 0%, rgb(48,116,168) 100%); /* FF3.6+ */
			background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgb(73,193,242)), color-stop(100%,rgb(48,116,168))); /* Chrome,Safari4+ */
			background-image: -webkit-linear-gradient(top,  rgb(73,193,242) 0%,rgb(48,116,168) 100%); /* Chrome10+,Safari5.1+ */
			background-image: -o-linear-gradient(top,  rgb(73,193,242) 0%,rgb(48,116,168) 100%); /* Opera 11.10+ */
			background-image: -ms-linear-gradient(top,  rgb(73,193,242) 0%,rgb(48,116,168) 100%); /* IE10+ */
			background-image: linear-gradient(to bottom,  rgb(73,193,242) 0%,rgb(48,116,168) 100%); /* W3C */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#49c1f2', endColorstr='#3074a8',GradientType=0 ); /* IE6-8 */
		}
		.ef_session_details_panel_action_button_remove {
			border: 1px solid rgb(204,125,125); 
			-webkit-border-radius: 4px; 
			-moz-border-radius: 4px;
			border-radius: 4px; 
			-webkit-box-shadow: 0 -1px 0 0 rgb(179,49,36);
			-moz-box-shadow: 0 -1px 0 0 rgb(179,49,36);
			box-shadow: 0 -1px 0 0 rgb(179,49,36);
			color: #FFFFFF;
		 	cursor: pointer;
			background-color: rgb(193,107,93); /* Old browsers */
			background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2MxNmI1ZCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNiMzMxMjQiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
			background-image: -moz-linear-gradient(top,  rgb(193,107,93) 0%, rgb(179,49,36) 100%); /* FF3.6+ */
			background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgb(193,107,93)), color-stop(100%,rgb(179,49,36))); /* Chrome,Safari4+ */
			background-image: -webkit-linear-gradient(top,  rgb(193,107,93) 0%,rgb(179,49,36) 100%); /* Chrome10+,Safari5.1+ */
			background-image: -o-linear-gradient(top,  rgb(193,107,93) 0%,rgb(179,49,36) 100%); /* Opera 11.10+ */
			background-image: -ms-linear-gradient(top,  rgb(193,107,93) 0%,rgb(179,49,36) 100%); /* IE10+ */
			background-image: linear-gradient(to bottom,  rgb(193,107,93) 0%,rgb(179,49,36) 100%); /* W3C */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#c16b5d', endColorstr='#b33124',GradientType=0 ); /* IE6-8 */
		}
		
		.ef_session_details_panel_action_button_disabled {
			background-image: none;
			cursor: default;
			background: rgb(245,245,245);
			border: 1px solid rgb(220,220,220);
			color: rgb(200,200,200);
		}
		
		.ef_session_details_panel_action_button_conflict_code {
			background-image: none;
			cursor: default;
			background: rgb(245,245,245);
			border: 1px solid rgb(220,220,220);
			color: rgb(200,200,200);
		}
		
		.ef_session_details_panel_action_button_conflict_time {
			background-image: none;
			cursor: default;
			background: rgb(245,245,245);
			border: 1px solid rgb(220,220,220);
			color: rgb(200,200,200);
		}
		.ef_session_details_panel_before_booking_button_icon {
			background-image: url("../../media/images/english/default/frontend/popover_info.png");
			display: inline-block;
			margin: 0;
			height: 24px;
			width: 24px;
			float: left;
			display: inline;
			background-repeat: no-repeat;
			background-position: left center;
			text-align: center;
			vertical-align: top;
			color: rgb(200,200,200);
		}
		
		.ef_session_details_panel_before_booking_button_container {
			padding: 12px;
		}
		
		.ef_session_details_panel_before_booking_button_text {
			padding: 2px 4px 2px 4px;
			color: rgb(130,130,130);
		}
		
		div.qtip-content { margin: 0; }
	>
]]></Implementation>
</Method>

<Method name="outputSegmentedButtonCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputSegmentedButtonCSS() ======= */
		.ef_segmented_button_container {
			border: 1px solid rgb(255,255,255);
			display: inline-block; /* For modern browsers */
			*display:inline; /* Hack for IE 7 and less */
			 zoom:1; /* Hack for IE */
			_height:1%; /* Hack for IE6 */
			vertical-align:top; /* Just makes sure everything is at the top */
			font-family: "Trebuchet MS", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", Tahoma, sans-serif;
			font-size: 14px;
			height: 22px;
			overflow: hidden;
			
			-moz-border-radius: 6px;
			-webkit-border-radius: 6px;
			border-radius: 6px;
			
			-webkit-box-shadow: 0px 1px 2px rgba(0,0,0,0.3);
			-moz-box-shadow: 0px 1px 2px rgba(0,0,0,0.3);
			box-shadow: 0px 1px 2px rgba(0,0,0,0.3);
			
			-moz-user-select: none;
		  	-khtml-user-select: none;
		  	-webkit-user-select: none;
		  	user-select: none;
		  	box-sizing: content-box;
		}
		.ef_segmented_button_container div {
			float: left;
		}
		.ef_segmented_button {
			cursor: pointer;
			height: 22px;
			line-height: 22px;
		}
		.ef_segmented_button_text {
			padding: 0 16px;
		}
		.ef_segmented_button_previous {
			background-image: url("../../media/images/english/default/frontend/left-arrow.png");
		    background-repeat: no-repeat;
		    height: 19px;
		    margin: 2px 4px 1px 8px;
		    width: 12px;
		}
		.ef_segmented_button_next {
			background-image: url("../../media/images/english/default/frontend/right-arrow.png");
		    background-repeat: no-repeat;
		    height: 19px;
		    margin: 2px 8px 1px 4px;
		    width: 12px;
		}
		.ef_segmented_button_disabled_outer_off {
			cursor: default;
		}
		.ef_segmented_button_disabled_off {
			cursor: default;
			background-image: none;
		}
		.ef_segmented_button_icon {
			padding: 0 8px;
		}
		.ef_segmented_button_icon_inner {
			vertical-align: middle;
			background-position: center;
			background-repeat: no-repeat;
			border: 0;
		}
		.ef_segmented_button_off, .ef_segmented_button_main_buttons_container {
			color: rgb(130,130,130);
			text-shadow: 0 1px #FFFFFF;
			background: #ffffff; /* Old browsers */
			/* IE9 SVG, needs conditional override of 'filter' to 'none' */
			background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjcwJSIgc3RvcC1jb2xvcj0iI2UzZTNlNCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNlM2UzZTQiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
			background: -moz-linear-gradient(top,  #ffffff 0%, #e3e3e4 70%, #e3e3e4 100%); /* FF3.6+ */
			background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(70%,#e3e3e4), color-stop(100%,#e3e3e4)); /* Chrome,Safari4+ */
			background: -webkit-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* Chrome10+,Safari5.1+ */
			background: -o-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* Opera 11.10+ */
			background: -ms-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* IE10+ */
			background: linear-gradient(to bottom,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* W3C */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#e3e3e4',GradientType=0 ); /* IE6-8 */
		}
		.ef_segmented_button_on {
			color: rgb(255,255,255);
			background: #3074a8; /* Old browsers */
			background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzMwNzRhOCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjMwJSIgc3RvcC1jb2xvcj0iIzI5ODlkOCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM0OWMxZjIiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
			background: -moz-linear-gradient(top,  #3074a8 0%, #2989d8 30%, #49c1f2 100%); /* FF3.6+ */
			background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#3074a8), color-stop(30%,#2989d8), color-stop(100%,#49c1f2)); /* Chrome,Safari4+ */
			background: -webkit-linear-gradient(top,  #3074a8 0%,#2989d8 30%,#49c1f2 100%); /* Chrome10+,Safari5.1+ */
			background: -o-linear-gradient(top,  #3074a8 0%,#2989d8 30%,#49c1f2 100%); /* Opera 11.10+ */
			background: -ms-linear-gradient(top,  #3074a8 0%,#2989d8 30%,#49c1f2 100%); /* IE10+ */
			background: linear-gradient(to bottom,  #3074a8 0%,#2989d8 30%,#49c1f2 100%); /* W3C */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#3074a8', endColorstr='#49c1f2',GradientType=0 ); /* IE6-8 */
		}
		.ef_segmented_button_caption {
			line-height: 22px;
			padding: 0 4px 0 8px;
			
			color: rgb(130,130,130);
			text-shadow: 0 1px #FFFFFF;
			background: #ffffff; /* Old browsers */
			/* IE9 SVG, needs conditional override of 'filter' to 'none' */
			background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjcwJSIgc3RvcC1jb2xvcj0iI2UzZTNlNCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNlM2UzZTQiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
			background: -moz-linear-gradient(top,  #ffffff 0%, #e3e3e4 70%, #e3e3e4 100%); /* FF3.6+ */
			background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(70%,#e3e3e4), color-stop(100%,#e3e3e4)); /* Chrome,Safari4+ */
			background: -webkit-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* Chrome10+,Safari5.1+ */
			background: -o-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* Opera 11.10+ */
			background: -ms-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* IE10+ */
			background: linear-gradient(to bottom,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* W3C */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#e3e3e4',GradientType=0 ); /* IE6-8 */
		}
		
		.ef_segmented_button_main_buttons_container {
			overflow: hidden;
		}
		
		.ef-ie7 .ef_segmented_button_main_buttons_container {
			position: relative;
		}
	>
]]></Implementation>
</Method>

<Method name="outputAgendaGridListSwitchCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputAgendaGridListSwitchCSS() ======= */
		.ef_agenda_view_switch_grid_icon_on {
			background-image: url('../../media/images/english/default/frontend/viewswitch_grid_on_icon.png');
			background-repeat: no-repeat;
			width: 15px;
			height: 15px;
			margin: 4px 0 3px;
		}
		.ef_agenda_view_switch_grid_icon_off {
			background-image: url('../../media/images/english/default/frontend/viewswitch_grid_off_icon.png');
			background-repeat: no-repeat;
			width: 15px;
			height: 15px;
			margin: 4px 0 3px;
		}
		.ef_agenda_view_switch_list_icon_on {
			background-image: url('../../media/images/english/default/frontend/viewswitch_list_on_icon.png');
			background-repeat: no-repeat;
			width: 15px;
			height: 15px;
			margin: 4px 0 3px;
		}
		.ef_agenda_view_switch_list_icon_off {
			background-image: url('../../media/images/english/default/frontend/viewswitch_list_off_icon.png');
			background-repeat: no-repeat;
			width: 15px;
			height: 15px;
			margin: 4px 0 3px;
		}
	>
]]></Implementation>
</Method>

<Method name="outputAgendaGeneralCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputAgendaGeneralCSS() ======= */
		/* agenda calendar main grid styles */
		
		.ef-reset-box-sizing, .ef-reset-box-sizing *, .ef-reset-box-sizing *:before, .ef-reset-box-sizing *:after {
			-webkit-box-sizing: content-box;
			-moz-box-sizing: content-box;
			box-sizing: content-box;
		}
		
		.ef_agenda_calendar_container {
			table-layout: fixed;
			/* position: relative; pjc - needed for css3pie */
			border-collapse: separate;
			border-spacing: 6px 7px;
		}
		
		.ef_agenda_calendar_header {
			background: rgb(100,100,100);
			color: rgb(255,255,255);
			font-size: 13px;
			padding: 4px 8px 4px 8px;
			height: 20px;
		}
		
		.ef_agenda_calendar_header_time {
			padding-left: 0;
			width: 50px;
			visibility: hidden;
		}
		
		.ef_agenda_calendar_header_loc {
			width: 130px;
		}
		
		.ef_frontend_agenda_grid_time_container {
			float: right;
			padding: 0 2px 0 0;
			margin: 0;
		}
		
		.ef_gridline_horizontal_container {
			position: relative;
			vertical-align: top;
			width: 4px;
		}
		
		.ef_frontend_agenda_grid_gridline_horizontal {
			position: relative;
			z-index: 10;
			display: inline-block;
			height: 0px;
			border-top: 1px solid rgb(220,220,220);
		}
		
		.ef_frontend_agenda_grid_gridline_vertical {
			position: absolute;
			float: left;
			z-index: 10;
			display: inline-block;
			width: 0px;
			border-left: 1px solid rgb(220,220,220);
		}
		
		.ef_agenda_calendar_item {
			-moz-border-radius: 5px;
			-webkit-border-radius: 5px;
			border-radius: 5px;
			width: 100%;
			padding: 0;
			overflow: hidden;
			position: relative;
			z-index: 30;
			vertical-align: top;
		}
		
		/* css attributes added to this will not take effect without change of relevant code */
		.ef_agenda_calendar_item_conflict_time {
			background: rgb(245,245,245);
			border: 1px solid rgb(220,220,220);
			color: rgb(200,200,200);
			opacity: 0.2;
		}
		/* css attributes added to this will not take effect without change of relevant code */
		.ef_agenda_calendar_item_conflict_code {
			background: rgb(245,245,245);
			border: 1px solid rgb(220,220,220);
			color: rgb(200,200,200);
			opacity: 0.2;
		}
		
		.ef_agenda_calendar_item div {
			vertical-align: top;
		}
		
		.ef_agenda_calendar_item div {
			margin: 0;
		}
		
		.ef_agenda_calendar_item_title {
			display: inline-block;
			min-height: 23px;
			padding: 0;
			float: left;
			width: 100%;
		}
		.ef_agenda_calendar_item_time_from {
			display: inline-block;
			float: left;
			padding: 6px;
			vertical-align: top;
			font-size: 12px;
			line-height: 12px;
		}
		.ef_agenda_calendar_item_time_from_single_row {
			display: inline-block;
			float: left;
			padding: 4px 6px 4px 6px;
			
			vertical-align: top;
			font-size: 12px;
		}
		
		.ef_agenda_calendar_item_session_icon {
			display: inline-block;
			background-position: right top;
			background-repeat: no-repeat;
			width: 17px;
			height: 17px;
			float: right;
		}
		
		div.ef_agenda_calendar_item_session_icon {
			margin-top: 4px;
			margin-right: 4px;
		}
		.ef_agenda_calendar_item_session_icon_faded {
			-khtml-opacity:0.2; 
			-moz-opacity:0.2; 
			opacity:0.2; 
		}
		.ef_agenda_calendar_item_selected_icon {
			display: inline-block;
			background-image: url('../../media/images/english/default/frontend/icon_attending_tick.png');
			background-repeat: no-repeat;		
			background-position: right top;
			width: 17px;
			height: 17px;
			float: right;
		}
		div.ef_agenda_calendar_item_selected_icon {
			margin-top: 4px;
			margin-right: 4px;
		}
		.ef_agenda_calendar_item_info {
			display: inline-block;
			float: left;
			width: 100%;
		}
		.ef_agenda_calendar_item_info_inner {
			display: inline-block;
			float: left;
			width: 100%;
		}
		div.ef_agenda_calendar_item_info_single_row {
			float: left;
			padding-top: 4px;
			padding-bottom: 4px;
		}
		
		div.ef_agenda_calendar_item_info_inner_single_row {
			float: left;
			width: 100%;
			font-size: 12px;
		}
		
		.ef_frontend_ie7 div.ef_agenda_calendar_item_info_inner_single_row {
			padding-bottom: 4px;
		}
		
		.ef_agenda_calendar_item_info_inner span {
			display: block;
			padding: 6px;
		}
		.ef_frontend_agenda_time_ampm {
			font-size: smaller;	
		}
		/* agenda calendar filter styles */	
		.ef_agenda_calendar_filters_container {
			text-align: left;
			padding: 0px 0px 0px 0px;
			margin: 0;
			background: #ffffff;
		}
		.ef_agenda_calendar_filters_container p {
			margin-top: 0;
			margin-bottom: 0;
			color: #000000;
		}
		.ef_agenda_calendar_filters_session_types_container {
			margin: 0;
			padding-bottom: 12px;
		}
		
		.ef_agenda_calendar_filters_instructions_text_session_type {
			padding: 16px 10px 16px 10px;
			margin: 0;
		}
		
		.ef_agenda_calendar_filters_filter {
			border: solid 1px rgb(200,200,200);
			margin: 0px 4px 4px 4px;
			cursor: pointer;
			padding: 4px 4px 4px 4px;
			text-align: center;
			-moz-border-radius: 6px;
		    -webkit-border-radius: 6px;
		    -khtml-border-radius: 6px;
		    border-radius: 6px;
		    display: block;
		    position: relative;
		    -moz-user-select: none;
		  	-khtml-user-select: none;
		  	-webkit-user-select: none;
		  	user-select: none;
		}
		
		.ef_agenda_calendar_filters_filter a {
			text-decoration: none;
			display: block;
		}
		.ef_agenda_calendar_filters_my_agenda_container {
			margin: 0;
			padding-top: 16px;
		}
		.ef_agenda_calendar_filters_instructions_text_my_agenda {
			padding: 0px 10px 4px 10px;
			margin: 0;
		}
		
		/* the colors will be overridden by session type color settings 
		for session filters, but will apply for other filters */
		.ef_agenda_calendar_filters_filter_on {
			color: rgb(255,255,255);
			border:1px solid rgb(44,151,204); 
			background-color: rgb(69,176,229);
		}
		.ef_agenda_calendar_filters_filter_on p {
			color: rgb(255,255,255);
		}
		.ef_agenda_calendar_filters_filter_off {
			color: rgb(160,160,160);
			background: rgb(255,255,255);
		}
		
		.ef_agenda_calendar_filters_filter_off p {
			color: rgb(160,160,160);
			background: rgb(255,255,255);
		}
		
		.ef_agenda_filter_my_itinerary {
			background-image: url('../../media/images/english/default/frontend/icon_attending_tick.png');
			background-repeat: no-repeat;		
			background-position: 6px center;
			text-align: left;
			padding-left: 32px;
		}
		
		.ef_agenda_filter_my_itinerary_on {
			background-image: url('../../media/images/english/default/frontend/icon_attending_tick_white.png');
		}
		
		#DayAndViewSelectorAndInstructionTextAndButtons #[w ">"]# #instructionText {
			margin-top: 18px;
			margin-bottom:12px;
		}
		
		#daySwitcher {
			height: 24px;
			float: left;
			text-align: left;
		}
		
		#daySwitcher, #viewSwitcher, #buttonDiv {
			margin-top: 8px;
			margin-bottom: 8px;
			display: block;
			clear: left;
		}
		.ef_agenda_view_switch_container {
			float:left;
			margin-bottom: 12px;
		}
		.ef_agenda_day_selector_day {
			position: relative;
			float: left;
		}
		.ef_frontend_ie6 #DayAndViewSelectorAndInstructionTextAndButtons,
		.ef_frontend_ie7 #DayAndViewSelectorAndInstructionTextAndButtons {
			margin-top: 0;
		}
	>
]]></Implementation>
</Method>

<Method name="outputLegacyDefaultCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputLegacyDefaultCSS() ======= */
		h1 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 24px; font-weight: bold; color: #000000; 	}
		h2 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 20px; font-weight: bold; color: #000000; 	}
		h3 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 16px; font-weight: bold; color: #000000; 	}
		h4 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-weight: bold; color: #000000; 	}
		h5 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-weight: bold; color: #000000; 	}
		h6 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-weight: bold; color: #000000; 	}
		body
		{
			font-size:12px;
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
		}
		
		.default_text { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; 	}
		.alt_text_1 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-weight: bold; color: #000000; 	}
		.alt_text_2 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: italic; color: #000000; 	}
		.alt_text_3 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; 	}
		.alt_text_4 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; 	}
		.alt_text_5 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; 	}
		
		td {font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; 	}
		p, li, div
		{
			margin:0in;
			margin-bottom: 10pt;
			font-size:12px;
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
		}
		li.k-item {
			margin-bottom: 0;
		}
		
		a:link, a:visited, a:hover, a:active {
		}
		
		ul.menuUL	{
			margin:0;
			margin-bottom: 0;
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
		}
		li.menuLI	{
			margin:0;
			margin-bottom: 0;
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
			list-style : none;
			xxborder-bottom: 1px solid red;
		}
		li.menuLI a	{
			margin:0;
			margin-bottom: 0;
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
			list-style : none;
			xxborder-bottom: 1px solid red;
		}
		
		.black8px {  font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 8px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none}
		.black9px {  font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none}
		.black10px {  font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none}
		.EF_inputBox {  font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none}
		.blackbold10px {  font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #000000}
		.white9px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: normal; color: #ffffff}
		.white10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: normal; color: #ffffff}
		.white12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: normal; color: #ffffff; text-decoration: none}
		.white14px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-style: normal; line-height: normal; font-weight: normal; color: #ffffff; text-decoration: none}
		.whitebold9px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: bold; color: #ffffff; text-decoration: none}
		.whitebold10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #ffffff; text-decoration: none}
		.whitebold12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: bold; color: #ffffff; text-decoration: none}
		.whitebold14px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-style: normal; line-height: normal; font-weight: bold; color: #ffffff; text-decoration: none}
		.whiteOnGrey10px { margin: 0; padding: 0; vertical-align: middle; line-height: 18px; text-indent: 7px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-weight: bold; font-style: normal; color: white; background: #959595; }
		.black10pxUL { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: underline}
		.blackbold10pxUL { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #000000 ; text-decoration: underline}
		.redbold12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: bold; color: #cc0000; text-decoration: none }
		.redbold10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #cc0000; text-decoration: none }
		.greybold10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #666666}
		.blackbold12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: bold; color: #000000 }
		.bluebold12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: bold; color: #1F4757}
		.black12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none }
		.blue12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: normal; color: #6699CC }
		.blue10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: normal; color: #6699CC }
		.blue9px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: normal; color: #6699CC }
		.bluebold9px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: bold; color: #6699CC }
		.yellowbold10px {
			font-family: Verdana, Arial, Helvetica, sans-serif;
			font-size: 10px;
			font-style: normal;
			line-height: normal;
			font-weight: bold;
			color: #FFFF80;
			text-decoration: none;
		}
		.yellow {  background-color: #FFFFCC;}
		.grey {  background-color: #e6e6e6}
		.red, .k-calendar td.ef-date-picker-event-day { 	background-color : #CC0033;}
		.k-calendar td.ef-date-picker-event-day .k-link {
			color: #FFFFFF
		}
		.notSoRed { 	background-color : #FFD1A0;}
		.bluebold10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #1F4757 }
		.bluebold14px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-style: normal; line-height: normal; font-weight: bold; color: #1F4757 }
		.activeButton {background-color: #FFDEAD}
		.orangeSelect {
			background-color: #FFDEAD;
			cursor : hand;
		}
		.red9px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: normal; color: #cc0000; text-decoration: none }
		.black9px_UL { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none }
		.grey2 { background-color: #CC0000}
		.butBlueWhite8px {
			font-family : Arial, Helvetica, Verdana;
			font-size: 8pt;
			color: White;
			font-weight: normal;
			background:#6699CC;
			text-align : center;
			font-weight: Bold;
			text-decoration : none;
			padding : 0px;
			cursor:hand;
		}
		.butGreyBlue8px {
			color: #185496;
			background: #B3C4CE;
			text-align : center;
			text-decoration : none;
			padding : 0px;
			cursor:hand;
			font : bold 8pt Arial, Helvetica, sans-serif;
			width: 95px;
			max-width: 95px;
			height: 20px;
			margin: 0px;
		}
		.hiddenDiv	{
			position:absolute;
			visibility:hidden;
			background-color: #FFFFE1;
			border: 1px double;
			width:0px;
			height:0px;
			left:200px;
		}
		td.black10pxBorder {
			border-style: solid none solid none;
			border-width:1px;
			border-color: #FFFFFF #FFFFFF #000000 #000000;
			border-collapse: collapse;
		}
		.mainPageBorderTop	{
			background-color: black;
		}
		.mainPageBorderLeft	{
			background-color: black;
		}
		.mainPageBorderRight	{
			background-color: black;
		}
		.mainPageBorderBottom	{
			background-color: black;
		}
		.mainPageLine	{
		/* need both color (for IE) and background-color (for Mozilla + Opera) */;
			width: 100%;
			color: black;
			background-color: black;
			height: 1px;
		}
	>
]]></Implementation>
</Method>
</Class>


<Class name="layout.cssOverrideMethods">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: layout.cssOverrideMethods.CLS/EV.28
;vc; Component: CLS.layout.cssOverrideMethods
;vc;  Location: LargeDev
;vc; Date/Time: 27-Jan-17 11:17
;vc;      User: MindaugasL
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>layout.cssOverrideMethods.CLS/EV.28</td><td>CLS.layout.cssOverrideMethods</td><td>LargeDev</td><td style='white-space: nowrap;'>27-Jan-17 11:17</td><td>MindaugasL</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<ClassType/>
<ProcedureBlock>1</ProcedureBlock>
<TimeChanged>64296,61994</TimeChanged>
<TimeCreated>63046,56108.531536</TimeCreated>

<Method name="outputDynamicCSS">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set templateID=##class(layout.objTemplate).getLayoutForEvent(xEventID)
	set showDynamicCSS=0
	if (##class(layout.methods).canUseStyleOverrides(xEventID))	{ // if we are using the new color picker, then output the buttons that use those colors and have a better design
		set showDynamicCSS=1
	}
	
	do ..outputAbstractDynamicCSS(xEventID)
	
	if 'showDynamicCSS quit
	set efwscolor1=##class(layout.eventColorMethods).getWebsiteColor1(xEventID)
	set efwscolor2=##class(layout.eventColorMethods).getWebsiteColor2(xEventID)
	set efwscolor3=##class(layout.eventColorMethods).getWebsiteColor3(xEventID)
	set menuTextColor=##class(layout.eventColorMethods).getMenuTextColor(xEventID)
	set formDividerColor=##class(layout.eventColorMethods).getFormDividerColor(xEventID)
 
 	&html<
		/* outputDynamicCSS() */
		body, p, h2, h3, td, div, .black10px, .blackbold10px, .black12px, .blackbold12px, .red9px, .whitebold12px,
		.ef_proweb_menu_ul, .ef_proweb_menu_ul a, .dropdown .btn, .EF_inputBox, .ef_frontend_button,
		.ef_frontend_file_uploader .k-upload-button, .ef_frontend_button:hover, .ef_frontend_file_uploader .k-upload-button:hover,
		.ef_frontend_button_proceed, .ef_frontend_button_proceed:hover, td.ef_proweb_form_prompt,
		.whitebold10px, a.whitebold10px:hover, .yellow, td.yellow, .grey, td.grey,
		.ef_progress_bar_text, .ef-table th,
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section textarea, 
		.ef-registration-section select {
			#(..getFontCSS(xEventID,"otherText"))#
		}
			
		body {
			background-color: #(##class(layout.eventColorMethods).getWebsiteBgColor(xEventID))#;
		}
		
		h1, .ef-tinyMCE-header {
			color: #(##class(layout.eventColorMethods).getHeadingColor(xEventID))#;
			#(..getFontCSS(xEventID,"headings"))#	
		}		
		
		.ef_proweb_menu_ul, .ef_proweb_menu_ul a, .dropdown .btn,
		.select2-container--default .select2-results__option--highlighted[aria-selected], .ef-agenda-time-block  {
			background-color: #(efwscolor1)#;	
			color: #(menuTextColor)#;
		}
		
		.ef_proweb_menu_ul li:hover, .ef_proweb_menu_ul a:hover, .dropdown .btn:hover, .dropdown .btn:focus,>
		write ".open>.dropdown-toggle.btn-primary " // note the '>' sign that causes compile issues
		&html<
		  {
			background-color: #(##class(layout.eventColorMethods).getMenuHoverBgColor(xEventID))#;
			color: #(##class(layout.eventColorMethods).getMenuHoverTextColor(xEventID))#;
		}
    	
		.EF_inputBox, 
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section textarea, 
		.ef-registration-section select,
		.select2-dropdown,
		.select2-container--default .select2-selection--single .select2-selection__rendered {
			background-color: #(##class(layout.eventColorMethods).getInputFieldBgColor(xEventID))#; 
			color: #(##class(layout.eventColorMethods).getInputFieldTextColor(xEventID))#;
			border-color: #(##class(layout.eventColorMethods).getInputBorderColor(xEventID))#;
		}
		
		.ef_form_divider {
			color: #(formDividerColor)#;
			border-color:#(formDividerColor)#;
			background-color: #(formDividerColor)#;
		}
		.ef_progress_bar_progress_div {	
			background-color:#(##class(layout.eventColorMethods).getProgressBarColor(xEventID))#;
		}
		.ef_progress_bar_border_div {	
			border: 1px solid  #(##class(layout.eventColorMethods).getProgressBarBorderColor(xEventID))#;
		}
		.ef_frontend_button, .ef_frontend_file_uploader .k-upload-button {
			color: #(##class(layout.eventColorMethods).getButtonTextColor(xEventID))#;
			background-color: #(##class(layout.eventColorMethods).getButtonBgColor(xEventID))#;
			border: 1px solid #(##class(layout.eventColorMethods).getButtonBorderColor(xEventID))#;
		}
		.ef_frontend_button:hover, .ef_frontend_file_uploader .k-upload-button:hover {
			color: #(##class(layout.eventColorMethods).getButtonHoverTextColor(xEventID))#;
			background-color: #(##class(layout.eventColorMethods).getButtonHoverBgColor(xEventID))#;
		}
		.ef_frontend_button_proceed {
			color: #(##class(layout.eventColorMethods).getButtonProceedTextColor(xEventID))#;
			background-color: #(##class(layout.eventColorMethods).getButtonProceedBgColor(xEventID))#;
			border: 1px solid #(##class(layout.eventColorMethods).getButtonProceedBorderColor(xEventID))#;
		}
		.ef_frontend_button_proceed:hover {
			color: #(##class(layout.eventColorMethods).getButtonProceedHoverTextColor(xEventID))#;
			background-color: #(##class(layout.eventColorMethods).getButtonProceedHoverBgColor(xEventID))#;
		}
		.ef_frontend_file_uploader .k-file-progress .k-progress {
		    background-color:#(##class(layout.eventColorMethods).getProgressBarColor(xEventID))#
		}
		.ef-table-header td, 
		.ef-table-header th
		 {
			background-color: #(##class(layout.eventColorMethods).getTableHeaderBgColor(xEventID))#;
			color: #(##class(layout.eventColorMethods).getTableHeaderTextColor(xEventID))#;
		}
		>
		if ##class(layout.objTemplate).isTemplateGen3(templateID)	{
			write ".dropdown .btn, .btn-primary:hover, .btn-primary:focus, .btn-primary:active, .btn-primary.active, .open > .dropdown-toggle.btn-primary {",!
			write "		border-color: "_##class(layout.eventColorMethods).getDropdownMenuBorderColor(xEventID)_";",!	
			write "}",!
		} else {
			&html<
				.red {
					background-color: #(##class(layout.eventColorMethods).getTableHeaderBgColor(xEventID))#;
				}
				.whitebold10px, a.whitebold10px:hover {
					color: #(##class(layout.eventColorMethods).getTableHeaderTextColor(xEventID))#;
				}				
			>
		}
		&html<

		
		.ef_frontend_help_text_icon {
			background-color: #(##class(layout.eventColorMethods).getHelpTextIconBgColor(xEventID))#;
			color: #(##class(layout.eventColorMethods).getHelpTextIconTextColor(xEventID))#;
			border-color: #(##class(layout.eventColorMethods).getHelpTextIconBorderColor(xEventID))#;
		}
		
		.ef_frontend_help_text_popover {
			background-color: #(##class(layout.eventColorMethods).getHelpTextBgColor(xEventID))#;
			border-color: #(##class(layout.eventColorMethods).getHelpTextBorderColor(xEventID))#;
		}
		
		.ef_frontend_help_text_popover .ui-tooltip-tip, .ef_frontend_help_text_popover .qtip-tip {
			border-color: #(##class(layout.eventColorMethods).getHelpTextBorderColor(xEventID))#;
			background-color: #(##class(layout.eventColorMethods).getHelpTextBgColor(xEventID))#;
		}
		.ef-table th {
			background-color:  #(##class(layout.eventColorMethods).getTableHeaderBgColor(xEventID))#;
			color: #(##class(layout.eventColorMethods).getTableHeaderTextColor(xEventID))#;
		}
		.k-calendar td.ef-date-picker-event-day {
			background-color: #(##class(layout.eventColorMethods).getInputFieldBgColor(xEventID))#; 
		}
		.k-calendar td.ef-date-picker-event-day .k-link {
			color: #(##class(layout.eventColorMethods).getInputFieldTextColor(xEventID))#;
		}

	>
	// CSS direct child selector doesn't work in &html tag. Bloody cache compiler
	w "		.ef_frontend_help_text_content>pre { color: "_##class(layout.eventColorMethods).getHelpTextTextColor(xEventID)_"}"
		
	// quit blank so it can be used in #()#
	quit ""
]]></Implementation>
</Method>

<Method name="outputStyleToChangeBGColourInMoxie">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputStyleToChangeBGColourInMoxie() ======= */
		.mceContentBody,.mce-content-body {
			background-color: #FFFFFF;
		}
	>
	quit
]]></Implementation>
</Method>

<Method name="getClassAgendaCalendarSessionTypeSpecificOn">
<ClassMethod>1</ClassMethod>
<FormalSpec>className,color,background,borderColor</FormalSpec>
<Implementation><![CDATA[
	set out=""
	set out=out_" ."_className_" {"
	set out=out_"	color:"_color_";"
	set out=out_"	background:"_background_";"
	set out=out_"	border: 1px solid "_borderColor_";"
	set out=out_"}"
	set out=out_" ."_className_" p {"
	set out=out_"	color:"_color_";"
	set out=out_"}"
	quit out
]]></Implementation>
</Method>

<Method name="getClassSessionDetailsPopOverSpecific">
<ClassMethod>1</ClassMethod>
<FormalSpec>className,borderColor</FormalSpec>
<Implementation><![CDATA[
	set out=""
	set out=out_" ."_className_" {"
	set out=out_"	border-color:"_borderColor_";"
	set out=out_"}"
	quit out
]]></Implementation>
</Method>

<Method name="getMenuBlockItemStyles">
<ClassMethod>1</ClassMethod>
<FormalSpec>liClass,liStyle,aClass,aStyle,aHoverStyle</FormalSpec>
<Implementation><![CDATA[
	set out=""
	set out=out_" li."_liClass_" {"_liStyle_"}"
	set out=out_" a."_aClass_" {"_aStyle_"}"
	set out=out_" a."_aClass_":hover {"_aHoverStyle_"}"
	quit out
]]></Implementation>
</Method>

<Method name="getFontCSS">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID,elementName</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=""
	set font=##class(layout.objStyleAttribute).getAttribute(xEventID,elementName,"font")
	
	if %request.Get("efPreviewInIframe") {
		if elementName="headings" {
			if $Data(%session.Data("headingsFont")) {
				set font = %session.Data("headingsFont")
			}
		} elseif elementName="otherText" {
			if $Data(%session.Data("otherTextFont")) {
				set font = %session.Data("otherTextFont")
			}
		}
	}

	if $l(font) {
		set fontFamily=##class(layout.objStyleAttribute).getFontFamily(font)
		set out="font-family: "_fontFamily
	}
	quit out
]]></Implementation>
</Method>

<Method name="outputUploadedStylesheet">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set objEvent=##class(setup.objEvent).%OpenId(xEventID)
	//  output a style for the inputboxes because we have changed it from being black10px to being 'EF_inputBox'.
	// Existing custom style sheets will not have the new class so we need to output it somewhere but it has before the custom CSS is outputted so that existing clients can override it by putting it in their custom CSS 
	if $L(##class(setup.eventWebMethods).getStyleSheetClass(xEventID,".EF_inputBox"))<2 { // only if it isn't specified in the stream
		 set currentBlack10pxClass=##class(setup.eventWebMethods).getStyleSheetClass(xEventID,".black10px")	
		 write !,"EF_inputBox {",currentBlack10pxClass,"}"
	}
	w !!,"/* ======= outputUploadedStylesheet() ======= */",!
	do objEvent.stylesheetFileStream.Rewind()
	while 'objEvent.stylesheetFileStream.AtEnd	{
		write objEvent.stylesheetFileStream.Read(30000)
	}
	w !!,"/* ======= end of outputUploadedStylesheet() ======= */",!
]]></Implementation>
</Method>

<Method name="streamTemplateStyleSheet">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID,styleSource</FormalSpec>
<Implementation><![CDATA[
	write !,"/* ======= streamTemplateStyleSheet() ======= */",!
	// get the style sheet from template related style file
	set coreCSSfile=""
	&SQL(SELECT layoutObjTemplate->templateDirectory,layoutObjTemplate->originalFilename,layoutObjTemplate INTO :templateDirectory,:templateFilename,:templateID FROM setup.objEvent WHERE ID = :xEventID)
	if +SQLCODE=0 {
		set templateFilename=$p(templateFilename,"\",$L(templateFilename,"\")) // remove the path
		set templateFilename=$p(templateFilename,".",1) // get rid of the extension
		set coreCSSfile="../../frontend/layouts/"_templateDirectory_"/"_templateFilename_"_efCoreStyles.css"
	}
	set coreCSSfile=##class(EF.config.server).getEFRootPathSourceNew()_$TR($P(coreCSSfile,"../",3),"/","\")
	if ##class(%File).Exists(coreCSSfile) {
		set cssstream=##class(%FileCharacterStream).%New()
		set cssstream.Filename=coreCSSfile
		while 'cssstream.AtEnd {
			write cssstream.ReadLine()_$C(13,10)
		}
		kill cssstream
	}
	// output theme styles
	if (styleSource="template") {
		// try to get from the stream that contains the style.css file (saved when uploading a custom template ZIP file)
		set objTemplate=##class(layout.objTemplate).%OpenId(templateID)
		if ($ISOBJECT(objTemplate)&&(objTemplate.templateCSSFile.Size>0)) {
			do objTemplate.templateCSSFile.OutputToDevice()
		}
	}
]]></Implementation>
</Method>

<Method name="outputAbstractDynamicCSS">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<Implementation><![CDATA[
	set marker=$ZCVT(##class(setup.objEventSetting).getParameter("abstracts","Identify the presenting author using",eventID),"L")
	if marker="*" {
		&html<
			.ef-presenting-author::after {
		    	content: "*";
			}
		>
	} elseif marker="bold" {
		
		&html<
			.ef-presenting-author {
		    	font-weight: bold;
			}
		>
	} elseif marker="underline" {
		
		&html<
			.ef-presenting-author {
		    	text-decoration: underline;
			}
		>
	}
]]></Implementation>
</Method>

<Method name="outputCustomEventCSS">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%Integer</FormalSpec>
<Implementation><![CDATA[
	write !,"/* Custom Event CSS */"

	if %request.Get("pageControllerID") {
		set contextData = ##class(EF.contextData).createFromBackendCSPSession()
		set pageControllerID=%request.Get("pageControllerID")
		if pageControllerID {
			try {
				set pageController=##class(EF.pageController.page).open(pageControllerID,contextData)
				if pageController.getValueByIdentifier("useCustomCSS") {
					write !,##class(EF.htmlGenerator).rawCSS(pageController.getValueByIdentifier("customCSS"))
				}
			} catch error {
				do ##class(EF.errors.loggingMethods).logException(error,"outputCustomEventCSS() - Could not open page controller")
			}
		}

	} else {
		if eventID {
			set event = ##class(setup.objEvent).%OpenId(eventID)
			if $IsObject(event) {
				do event.%Reload()
				if event.useCustomEventCSS {
					write !,##class(EF.htmlGenerator).rawCSS(event.customEventCSS)
				}
				kill event
			}
		}
	}
]]></Implementation>
</Method>

<Method name="getFontFamilyHeadings">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%Integer</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set font = ##class(layout.objStyleAttribute).getAttribute(eventID,"headings","font")
	return ##class(layout.objStyleAttribute).getFontFamily(font)
]]></Implementation>
</Method>

<Method name="getFontFamilyOtherText">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%Integer</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set font = ##class(layout.objStyleAttribute).getAttribute(eventID,"otherText","font")
	return ##class(layout.objStyleAttribute).getFontFamily(font)
]]></Implementation>
</Method>

<Method name="outputWebsiteAppearanceCSS">
<Description>
This is only used by proweb 2</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%Integer</FormalSpec>
<Implementation><![CDATA[
	write !,"<!-- ========= CSS styles defined in Website Appearance ======= -->"
	set greaterThan = ">"
	&html<
		<style>
			body {
				font-family: #(..getFontFamilyOtherText(eventID))#;
				background-color: #(##class(layout.eventColorMethods).getWebsiteBgColor(eventID))#;
			}
			
			.ef-input-background, 
			.ef-push-button-secondary,
			.form-control, select, .k-input, .select2-container--default .select2-selection--single 
			{
				background-color: #(##class(layout.eventColorMethods).getWebsiteColor3(eventID))#;
				color: #(##class(layout.eventColorMethods).getInputFieldTextColor(eventID))#;
			}
			
			h1, h2, h3, h4, h5,	h6, .ef-page-header {
				font-family: #(..getFontFamilyHeadings(eventID))#;
				color: #(##class(layout.eventColorMethods).getHeadingColor(eventID))#;
			}
			
			.ef-menu-block,
			.ef-menu-block a, 
			.ef-push-button-primary, 
			.ef-form-divider,
			.ef-panel-heading,
			.ef-progress-bar-filled,
			.ef-form-divider,
			.ef-menu-block-ul-xs li a,#(".open"_greaterThan_".dropdown-toggle.btn-primary")#,
			.ef-table-header {
				background-color: #(##class(layout.eventColorMethods).getWebsiteColor1(eventID))#;
				color: #(##class(layout.eventColorMethods).getMenuTextColor(eventID))#;
			}

			.ef-push-button {
				font-family: #(..getFontFamilyOtherText(eventID))#;	
			}
			
			#(".ef-panel-heading { "_..getFontCSS(eventID,"headings")_" }")#

			.ef-help-icon {
				background-color: #(##class(layout.eventColorMethods).getMenuTextColor(eventID))#;
				color: #(##class(layout.eventColorMethods).getWebsiteColor1(eventID))#;
			}

			.ef-menu-block a:hover, 
			.ef-push-button.ef-push-button-primary:hover  {
				background-color: #(##class(layout.eventColorMethods).getMenuHoverBgColor(eventID))#;
				color: #(##class(layout.eventColorMethods).getMenuHoverTextColor(eventID))#;
			}
			
			.ef-push-button.ef-push-button-secondary:hover {
				color: #(##class(layout.eventColorMethods).getButtonHoverTextColor(eventID))#;
				background-color: #(##class(layout.eventColorMethods).getButtonHoverBgColor(eventID))#;
			}
			
			.ef-panel-body, 
			.ef-panel {
				color: #(##class(layout.eventColorMethods).getPanelTextColor(eventID))#;
				background-color: #(##class(layout.eventColorMethods).getPanelBgColor(eventID))#;
			}
			
			.ef-admin-only {
   				background-color: burlywood;    
			}
		</style>
	>
]]></Implementation>
</Method>
</Class>


<Class name="layout.disposableMethods">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: layout.disposableMethods.CLS/EV.7
;vc; Component: CLS.layout.disposableMethods
;vc;  Location: LargeDev
;vc; Date/Time: 01-Dec-16 15:58
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>layout.disposableMethods.CLS/EV.7</td><td>CLS.layout.disposableMethods</td><td>LargeDev</td><td style='white-space: nowrap;'>01-Dec-16 15:58</td><td>FredG</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<TimeChanged>64253,59816.575309</TimeChanged>
<TimeCreated>63440,48937.670163</TimeCreated>

<Method name="setHasBootstrapFlagForTemplate8">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	&SQL(UPDATE layout.objTemplate SET hasBootstrap=1 WHERE internalDescription = 'EF_THEME_default_design_08')
]]></Implementation>
</Method>

<Method name="recreateCustomTemplate">
<Description>
re-build the template from the template stored in the database and the files on the web server</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID,deleteFiles=1</FormalSpec>
<Implementation><![CDATA[
	if 'templateID {
		throw ##class(shared.exceptions.generalException).%New("Missing templateID")
	}
	if '##class(layout.objTemplate).isTemplateCustomMade(templateID) return
	if ##class(layout.objTemplate).isThisAPopupTemplate(templateID) return
	
	set popupTemplateID=##class(layout.objTemplate).getPopupTemplate(templateID)
	
	set internalDesc=##class(layout.objTemplate).getIntDesc(templateID)
	set zipFileName=internalDesc_".zip"
	set webserverPathToTemplateFiles="/"_##class(layout.objTemplate).getPath(templateID)
	// (LT=C:\websites\efsys.net\largetest\media\templates)
	set dir=##class(EF.config.server).getTemplatesRoot()_"\tmprecreated\"_$ZNSPACE_"\"_internalDesc_"\"
	set filename="index.html"
	set popupfilename="index_popup.html"
	set objTemplate=##class(layout.objTemplate).%OpenId(templateID)
	
	do ##class(layout.objTemplate).rebuildAndOutputToFile(templateID,dir,filename)
	if (popupTemplateID) {
		do ##class(layout.objTemplate).rebuildAndOutputToFile(popupTemplateID,dir,popupfilename)
	}
	
	// get the files from the webserver
	kill filelist
	do ##class(shared.ftpMethods).connectAndGetDirectoryList(webserverPathToTemplateFiles,.filelist)
	
	set fileToGetIndex=""
	for  {
		set fileToGetIndex=$O(filelist(fileToGetIndex))
		if fileToGetIndex="" quit
		set fileToGet=filelist(fileToGetIndex)
		
		if $ZCVT($P(fileToGet,".",$L(fileToGet,".")),"L")="zip" continue   // don't include the zip file as well - sometimes the directory that has the template also has the zip of the template
		if $ZCVT(fileToGet,"L")="index.html" continue  // don't get this if it's there, we are recreating from the actual stored template
		
		kill tmpStream
		set ok=##class(shared.ftpMethods).getFile(webserverPathToTemplateFiles,fileToGet,.tmpStream)
		if 'ok {
			throw ##class(shared.exceptions.generalException).%New("Cannot get:"_fileToGet_" from webserver")
		}
		do ##class(shared.fileMethods).createFileFromStream(tmpStream,dir,fileToGet)
		
		if $ZCVT(fileToGet,"L")="style.css" {
			// store the style.css in order for moxie to get this without ftp'ing to the web servers
			set sc=objTemplate.templateCSSFile.CopyFromAndSave(tmpStream)
			If $$$ISERR(sc) {
				Throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
			}
		}
		
	}
	
	// zip up the directory
	do ##class(shared.fileMethods).deleteLocalFile(dir,zipFileName)  // make sure it's not there already (will be if we have run this for this templateID once before)
	do ##class(shared.fileMethods).zipFiles(dir,"*.*",dir,zipFileName,0,,0)
	
	set templateZipFileStream=##class(%Stream.FileBinary).%New()
	set templateZipFileStream.Filename=dir_zipFileName
	set sc=objTemplate.templateSourceFile.CopyFromAndSave(templateZipFileStream)
	If $$$ISERR(sc) {
		Throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
	}
	kill templateZipFileStream
	set objTemplate.customTemplate=1

	set sc=objTemplate.%Save()
	If $$$ISERR(sc) {
		Throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
	}
	
	if deleteFiles {
		// delete all the files we just retrieved
		do ##class(%File).RemoveDirectoryTree(dir)
	}
	
	quit
]]></Implementation>
</Method>

<Method name="recreateAllCustomTemplatesAndStore">
<ClassMethod>1</ClassMethod>
<FormalSpec>deleteFiles=1</FormalSpec>
<Implementation><![CDATA[
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set sqltext="SELECT ID FROM layout.objTemplate ORDER BY ID"
	do rs.Prepare(sqltext)
	do rs.Execute()
	while rs.Next() {
		set templateID=rs.Data("ID")
		do ..recreateCustomTemplate(templateID,deleteFiles)
	}
	quit
]]></Implementation>
</Method>

<Method name="updateDefaultTemplate">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set currentDefaultTemplateID = ##class(setup.objSetting).getParameter("themes","default theme for new events")	
	set currentDefaultTemplateName = ##class(layout.objTemplate).getIntDesc(currentDefaultTemplateID)
	
	if $zcvt(currentDefaultTemplateName,"U")["EF_THEME_STANDARD_DESIGN_" {
		set newDefaultTemplateName = "EF_THEME_standard_design-v2_"_$Piece(currentDefaultTemplateName,"_",5)
		set newDefaultTemplateID = ##class(layout.objTemplate).getIDfromIntDesc(newDefaultTemplateName)
			
		do ##class(setup.objSetting).setParameter("themes","default theme for new events",newDefaultTemplateID)
	}
]]></Implementation>
</Method>

<Method name="reorderStandardDesigns">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set rs = ##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT * FROM layout.objStandardDesign ORDER BY ID DESC")
	do rs.Execute()
	while rs.Next() {
		if (rs.Get("description") = 1) && (rs.Get("displayOrder") = 24) {
			w !,"This method has already been run in this namespace"
			quit	
		}
		set designID = rs.Get("ID")
		&SQL(UPDATE layout.objStandardDesign SET displayOrder = displayOrder + 1 WHERE ID = :designID)			
	}
	&SQL(UPDATE layout.objStandardDesign SET displayOrder = 1 WHERE description = 'Standard Design 2.0')
	&SQL(UPDATE layout.objStandardDesign SET displayOrder = 24 WHERE description = 'Responsive Standard Design')
]]></Implementation>
</Method>
</Class>


<Class name="layout.methods">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: layout.methods.CLS/EV.139
;vc; Component: CLS.layout.methods
;vc;  Location: LargeDev
;vc; Date/Time: 28-Nov-16 15:36
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>layout.methods.CLS/EV.139</td><td>CLS.layout.methods</td><td>LargeDev</td><td style='white-space: nowrap;'>28-Nov-16 15:36</td><td>FredG</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<ClassType/>
<ProcedureBlock>1</ProcedureBlock>
<TimeChanged>64266,50401.170258</TimeChanged>
<TimeCreated>61075,71223.195943</TimeCreated>

<Method name="reloadAll">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	do ..addStandardDesigns()
	
	// set path="d:\websites\eventsforce.net\SOURCENEW\frontend\layouts\",newPath="d:\websites\eventsforce.net\SOURCENEW\media\templates\ALL_CLIENTS\"
	set path=##class(shared.fileMethods).addSlash(##class(EF.config.server).getTemplatesRootPathOld())
	set newPath=##class(shared.fileMethods).addSlash(##class(EF.config.server).getTemplatesRootShared())
	
	// THE DESCRIPTIONS HAVE TO BE UNIQUE - it will be overwritten with another template if the same
	set fn($I(fn))=newPath_"EF_base_layout_left_menu\index.csp",de(fn)="Blank 01 "_##class(layout.methods).getLayoutDescriptionFromNumber(10),in(fn)="EF_DEFAULT_LEFT_MENU",img(fn)="layout1.jpg",level(fn)="none",source(fn)="event",directory(fn)="ALL_CLIENTS/EF_base_layout_left_menu",layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(10),design(fn)="Blank Design"
	set fn($I(fn))=path_"table1.html",de(fn)="Blank 02 "_##class(layout.methods).getLayoutDescriptionFromNumber(11),in(fn)="frontEndFrameset1.csp",img(fn)="layout1.jpg",level(fn)="none",source(fn)="event",directory(fn)="EF/EF_theme_blank-02",efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(11),design(fn)="Blank Design"
	set fn($I(fn))=path_"table2.html",de(fn)="Blank 03 "_##class(layout.methods).getLayoutDescriptionFromNumber(12),in(fn)="frontEndFrameset2.csp",img(fn)="layout2.jpg",level(fn)="none",source(fn)="event",directory(fn)="EF/EF_theme_blank-03",efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(12),design(fn)="Blank Design"
	set fn($I(fn))=path_"table3.html",de(fn)="Blank 04 "_##class(layout.methods).getLayoutDescriptionFromNumber(13),in(fn)="frontEndFrameset3.csp",img(fn)="layout3.jpg",level(fn)="none",source(fn)="event",directory(fn)="EF/EF_theme_blank-04",efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(13),design(fn)="Blank Design"
	set fn($I(fn))=path_"table4.html",de(fn)="Blank 05 "_##class(layout.methods).getLayoutDescriptionFromNumber(14),in(fn)="frontEndFrameset4.csp",img(fn)="layout4.jpg",level(fn)="none",source(fn)="event",directory(fn)="EF/EF_theme_blank-05",efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(14),design(fn)="Blank Design"
	set fn($I(fn))=path_"table5.html",de(fn)="Blank 06 "_##class(layout.methods).getLayoutDescriptionFromNumber(15),in(fn)="frontEndFrameset5.csp",img(fn)="layout5.jpg",level(fn)="none",source(fn)="event",directory(fn)="EF/EF_theme_blank-06",efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(15),design(fn)="Blank Design"
	set fn($I(fn))=path_"table6.html",de(fn)="Blank 07 "_##class(layout.methods).getLayoutDescriptionFromNumber(16),in(fn)="layout6",img(fn)="layout6.jpg",level(fn)="none",source(fn)="event",directory(fn)="EF/EF_theme_blank-07",efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(16),design(fn)="Blank Design"
	set fn($I(fn))=path_"divexistingnoframeset.html",de(fn)="Blank 08 "_##class(layout.methods).getLayoutDescriptionFromNumber(17),in(fn)="noFrameset.csp",img(fn)="layoutNoFrameset.jpg",level(fn)="none",source(fn)="event",directory(fn)="EF/EF_theme_blank-08",efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(17),design(fn)="Blank Design"
	set fn($I(fn))=path_"3_column_static_glish.html",de(fn)="Blank 09 "_##class(layout.methods).getLayoutDescriptionFromNumber(18),in(fn)="Glish3ColStatic",img(fn)="layout4.jpg",level(fn)="A",source(fn)="event",directory(fn)="EF/EF_theme_blank-09",efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(18),design(fn)="Blank Design"
	set fn($I(fn))=path_"2_column_static_jw.html",de(fn)="Blank 10 "_##class(layout.methods).getLayoutDescriptionFromNumber(19),in(fn)="JAW2ColStatic",img(fn)="layout5.jpg",level(fn)="A",source(fn)="event",directory(fn)="EF/EF_theme_blank-10",efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(19),design(fn)="Blank Design"
	set fn($I(fn))=path_"1_column_static_jw.html",de(fn)="Blank 11 "_##class(layout.methods).getLayoutDescriptionFromNumber(20),in(fn)="JAW1ColStatic",img(fn)="layout3.jpg",level(fn)="A",source(fn)="event",directory(fn)="EF/EF_theme_blank-11",efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(20),design(fn)="Blank Design"
	
	set fn($I(fn))=newPath_"EF_theme_iFrame\index.csp",de(fn)="No Menu and Banner (For IFRAMES)",in(fn)="IFRAME",img(fn)="layoutiFrame.jpg",level(fn)="none",source(fn)="event",directory(fn)="ALL_CLIENTS/EF_theme_iFrame",isIframe(fn)=1
	set fn($I(fn))=newPath_"EF_theme_survey\index.csp",de(fn)="Generic Template for Surveys",in(fn)="SURVEY",img(fn)="layoutiFrame.jpg",level(fn)="none",source(fn)="event",directory(fn)="ALL_CLIENTS/EF_theme_survey"
	
	// automated section for loading numeric themes
	for d=1:1:19 {
		set design="",$P(design,"0",4-$L(d))="",design=design_d // add the leading zeroes
		for l=1:1:9 {
			set layout="",$P(layout,"0",3-$L(l))="",layout=layout_l // add the leading zeroes
			set fn($I(fn))=newPath_"EF_theme_"_design_"-"_layout_"\index.csp",de(fn)="Theme "_design_" "_layout_" "_##class(layout.methods).getLayoutDescriptionFromNumber(l),in(fn)="EF_THEME_"_design_"_"_layout,img(fn)="layout_structure_"_l_".gif",level(fn)="none",source(fn)="template",directory(fn)="ALL_CLIENTS/EF_theme_"_design_"-"_layout,efLogo(fn)=0,layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(l),design(fn)="Design "_+design
			
			
			set indexFile = ##class(shared.fileMethods).fileActions(newPath_"EF_theme_"_design_"-"_layout_"\index.csp", "R")
			set resultFile = ##class(shared.fileMethods).fileActions(newPath_"EF_theme_"_design_"-"_layout_"\index.csp", "WR", indexFile, "[[PATH]]|"_"../../media/templates/ALL_CLIENTS/EF_theme_"_design_"-"_layout_"/")
		}
	}
	
	// add new default design - as not numeric have to hard code the values
	for l=4,7,8,9,21 {
		set design="default_design"
		set layout="",$P(layout,"0",3-$L(l))="",layout=layout_l // add the leading zeroes
		set fn($I(fn))=newPath_"EF_theme_"_design_"-"_layout_"\index.csp"
		set de(fn)="Default Design "_layout_" "_##class(layout.methods).getLayoutDescriptionFromNumber(l)
		set in(fn)="EF_THEME_"_design_"_"_layout
		set img(fn)="layout_structure_"_l_".gif",level(fn)="none",source(fn)="template"
		set directory(fn)="ALL_CLIENTS/EF_theme_"_design_"-"_layout,efLogo(fn)=1

		set isIframe(fn)=$S(l=21:1,1:0) // No 21 is an iFrame
		set isUsingBootstrap(fn)=0

		set layout(fn)=##class(layout.methods).getLayoutDescriptionFromNumber(l)
		set design(fn)="Default Design"
		
		set indexFile = ##class(shared.fileMethods).fileActions(newPath_"EF_theme_"_design_"-"_layout_"\index.csp", "R")
		set resultFile = ##class(shared.fileMethods).fileActions(newPath_"EF_theme_"_design_"-"_layout_"\index.csp", "WR", indexFile, "[[PATH]]|"_"../../media/templates/ALL_CLIENTS/EF_theme_"_design_"-"_layout_"/")
	}

	set i=""
	for  {
		set i=$O(fn(i))
		if i="" quit
		
		s fn=fn(i)
		w !,"Loading:",fn,"..."
		w " result=",##class(layout.objTemplate).loadTemplate(de(i),in(i),1,i,fn,1,0,img(i),level(i),source(i),directory(i),$G(efLogo(i)),$G(layout(i)),$G(design(i)),$G(isIframe(i)),$G(isUsingBootstrap(i)))
		s fn=$P(fn,".html",1)_"_popup.html"
		if ##class(%Library.File).Exists(fn)	{  // if we don't have a popup template, doesn't matter, the normal one will be used
			w !,"Loading:",fn,"..."
			w " result=",##class(layout.objTemplate).loadTemplate(de(i)_"_popup",in(i)_"_popup",1,i,fn,1,1,img(i),level(i),source(i),directory(i),$G(efLogo(i)),$G(layout(i)),$G(design(i)),$G(isIframe(i)),$G(isUsingBootstrap(i)))
		} else {
			// Check for csp popup
			s fn=$P(fn,".csp",1)_"_popup.csp"
			if ##class(%Library.File).Exists(fn)	{  // if we don't have a popup template, doesn't matter, the normal one will be used
				w !,"Loading:",fn,"..."
				w " result=",##class(layout.objTemplate).loadTemplate(de(i)_"_popup",in(i)_"_popup",1,i,fn,1,1,img(i),level(i),source(i),directory(i),$G(efLogo(i)),$G(layout(i)),$G(design(i)),$G(isIframe(i)),$G(isUsingBootstrap(i)))
			}
		}
	}
	
	do ..loadResponsiveStandardTemplates()
	
	do ..updateTemplateCSSFileAll()
]]></Implementation>
</Method>

<Method name="loadResponsiveStandardTemplates">
<Description>
Loads the first generation templates of the Eventsforce responsive standard design</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	#define horiMenuNoSponsNoLogo 8
	#define vertMenuNoSponsNoLogo 4
	#define horiMenuSponsNoLogo 7
	#define noMenuNoSponsNoLogo 9
	#define iFrame 21
	
	set path=##class(shared.fileMethods).addSlash(##class(EF.config.server).getTemplatesRootShared())
	
	for layoutNumber=$$$horiMenuNoSponsNoLogo,$$$vertMenuNoSponsNoLogo,$$$horiMenuSponsNoLogo,$$$noMenuNoSponsNoLogo,$$$iFrame {
		
		set template=##class(%ZEN.proxyObject).%New()
		set template.isIframe=(layoutNumber=$$$iFrame)
		set internalDesignName="standard_design"
		
		set layout="",$P(layout,"0",3-$L(layoutNumber))="",layout=layout_layoutNumber // add the leading zeroes
		
		set template.description="Responsive Standard Design "_layout_" "_##class(layout.methods).getLayoutDescriptionFromNumber(layoutNumber)
		set template.internalName="EF_THEME_"_internalDesignName_"_"_layout
		set template.designName="Responsive Standard Design"
		set template.layoutStructure=##class(layout.methods).getLayoutDescriptionFromNumber(layoutNumber)
		
		set template.indexFilename=path_"EF_theme_"_internalDesignName_"-"_layout_"\index.csp"
		set template.templateDirectory="ALL_CLIENTS/EF_theme_"_internalDesignName_"-"_layout
		set template.imageFile="layout_structure_"_layoutNumber_".gif"

		set template.accessibilityLevel="none"
		set template.styleSource="template"
		set template.isLogoIncudedInTemplate=1
		set template.isUsingBootstrap=1
		
		set indexFile = ##class(shared.fileMethods).fileActions(path_"EF_theme_"_layoutNumber_"-"_layout_"\index.csp", "R")
		set resultFile = ##class(shared.fileMethods).fileActions(path_"EF_theme_"_layoutNumber_"-"_layout_"\index.csp", "WR", indexFile, "[[PATH]]|"_"../../media/templates/ALL_CLIENTS/EF_theme_"_layoutNumber_"-"_layout_"/")

		do ##class(layout.objTemplate).loadTemplateUsingProxy(template)
		kill template
	}
]]></Implementation>
</Method>

<Method name="loadStandardDesignV2">
<Description>
loads the Eventsforce templates that can use Proweb2</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	#define horiMenuNoSponsNoLogo 8	
	#define vertMenuNoSponsNoLogo 4
	#define horiMenuSponsNoLogo 7
	#define noMenuNoSponsNoLogo 9
	#define iFrame 21
	
	set path = ##class(shared.fileMethods).addSlash(##class(EF.config.server).getTemplatesRootShared())	
	for layoutNumber=$$$horiMenuNoSponsNoLogo,$$$vertMenuNoSponsNoLogo,$$$horiMenuSponsNoLogo,$$$noMenuNoSponsNoLogo,$$$iFrame {
		
		set template=##class(%ZEN.proxyObject).%New()
		set template.isIframe=(layoutNumber=$$$iFrame)
		set internalDesignName="standard_design-v2"
		
		set layout="",$P(layout,"0",3-$L(layoutNumber))="",layout=layout_layoutNumber // add the leading zeroes
		
		set template.description="Standard Design 2.0"_layout_" "_##class(layout.methods).getLayoutDescriptionFromNumber(layoutNumber)
		set template.internalName="EF_THEME_"_internalDesignName_"_"_layout
		set template.designName="Standard Design 2.0"
		set template.layoutStructure=##class(layout.methods).getLayoutDescriptionFromNumber(layoutNumber)
		
		set template.indexFilename=path_"EF_theme_"_internalDesignName_"-"_layout_"\index.html"
		set template.templateDirectory="ALL_CLIENTS/EF_theme_"_internalDesignName_"-"_layout
		set template.imageFile="layout_structure_"_layoutNumber_".gif"

		set template.accessibilityLevel="none"
		set template.styleSource="template"
		set template.isLogoIncudedInTemplate=1
		set template.isUsingBootstrap=1
		set template.isUsingProweb2=1
		
		set indexFile = ##class(shared.fileMethods).fileActions(path_"EF_theme_"_layoutNumber_"-"_layout_"\index.html", "R")
		set resultFile = ##class(shared.fileMethods).fileActions(path_"EF_theme_"_layoutNumber_"-"_layout_"\index.html", "WR", indexFile, "[[PATH]]|"_"../../media/templates/ALL_CLIENTS/EF_theme_"_layoutNumber_"-"_layout_"/")

		do ##class(layout.objTemplate).loadTemplateUsingProxy(template)
		kill template

	}
]]></Implementation>
</Method>

<Method name="addStandardDesigns">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	write !,##class(layout.objStandardDesign).add("Standard Design 2.0") 
	write !,##class(layout.objStandardDesign).add("Responsive Standard Design") 
	write !,##class(layout.objStandardDesign).add("Default Design") 
	write !,##class(layout.objStandardDesign).add("Design 1")
	write !,##class(layout.objStandardDesign).add("Design 2")
	write !,##class(layout.objStandardDesign).add("Design 3")
	write !,##class(layout.objStandardDesign).add("Design 4")
	write !,##class(layout.objStandardDesign).add("Design 5")
	write !,##class(layout.objStandardDesign).add("Design 6")
	write !,##class(layout.objStandardDesign).add("Design 7")
	write !,##class(layout.objStandardDesign).add("Design 8")
	write !,##class(layout.objStandardDesign).add("Design 9")
	write !,##class(layout.objStandardDesign).add("Design 10")
	write !,##class(layout.objStandardDesign).add("Design 11")
	write !,##class(layout.objStandardDesign).add("Design 12")
	write !,##class(layout.objStandardDesign).add("Design 13")
	write !,##class(layout.objStandardDesign).add("Design 14")
	write !,##class(layout.objStandardDesign).add("Design 15")
	write !,##class(layout.objStandardDesign).add("Design 16")
	write !,##class(layout.objStandardDesign).add("Design 17")
	write !,##class(layout.objStandardDesign).add("Design 18")
	write !,##class(layout.objStandardDesign).add("Design 19")
	write !,##class(layout.objStandardDesign).add("Blank Design") // Legacy design
]]></Implementation>
</Method>

<Method name="getTemplateIDFromInternalDescription">
<ClassMethod>1</ClassMethod>
<FormalSpec>internalDescription</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT ID INTO :tmp FROM layout.objTemplate WHERE internalDescription = :internalDescription)
	if +SQLCODE=0 {
		return tmp
	} else {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$G(%msg))	
	}
]]></Implementation>
</Method>

<Method name="reloadTemplate">
<Description>
reloads an individual template. uses "internal description" from layout.objTemplate as input
needs to be used after changing the CSP/HTML index file</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateDescription:%String</FormalSpec>
<Implementation><![CDATA[
	try {
		set templateID=..getTemplateIDFromInternalDescription(templateDescription)
		do ..reloadTemplateID(templateID)
	} catch {
		write !,"Error: Description did not match any Template."
	}
]]></Implementation>
</Method>

<Method name="reloadTemplateID">
<Description>
reloads an individual template. uses ID from layout.objTemplate as input
needs to be used after changing the CSP/HTML index file</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<Implementation><![CDATA[
	if 'templateID quit 0
	
	// create the sql object
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set ok=rs.Prepare("SELECT * FROM layout.objTemplate WHERE ID=?")
	set ok=rs.Execute(templateID)
	do rs.Next()
	set fn=rs.Get("originalFilename")
	
	set isIframe=$S(rs.Get("isIframe")=1:1,1:0)
	set isUsingBootstrap=$S(rs.Get("hasBootstrap")=1:1,1:0)

	set indexFile = ##class(shared.fileMethods).fileActions(fn, "R")
	set resultFile = ##class(shared.fileMethods).fileActions(fn, "WR", indexFile, "[[PATH]]|"_"../../media/templates/"_rs.Get("templateDirectory")_"/")
	
	w !,"Loading:",fn,"..."
	w " result=",##class(layout.objTemplate).loadTemplate(rs.Get("description"),rs.Get("internalDescription"),1,rs.Get("displayOrder"),fn,1,0,rs.Get("exampleImage"),rs.Get("accessibilityLevel"),rs.Get("styleSource"),rs.Get("templateDirectory"),rs.Get("efLogoInTemplate"),rs.Get("layoutStructure"),,isIframe,isUsingBootstrap)
	s fn=$P(fn,".html",1)_"_popup.html"
	if ##class(%Library.File).Exists(fn)	{  // if we don't have a popup template, doesn't matter, the normal one will be used
		w !,"Loading:",fn,"..."
		w " result=",##class(layout.objTemplate).loadTemplate(rs.Get("description")_"_popup",rs.Get("internalDescription")_"_popup",1,rs.Get("displayOrder"),fn,1,1,rs.Get("exampleImage"),rs.Get("accessibilityLevel"),rs.Get("styleSource"),rs.Get("templateDirectory"),rs.Get("efLogoInTemplate"),rs.Get("layoutStructure"),,isIframe,isUsingBootstrap)
	} else {
		s fn=$P(fn,".csp",1)_"_popup.csp"
		if ##class(%Library.File).Exists(fn)	{  // if we don't have a popup template, doesn't matter, the normal one will be used
			w !,"Loading:",fn,"..."
			w " result=",##class(layout.objTemplate).loadTemplate(rs.Get("description")_"_popup",rs.Get("internalDescription")_"_popup",1,rs.Get("displayOrder"),fn,1,1,rs.Get("exampleImage"),rs.Get("accessibilityLevel"),rs.Get("styleSource"),rs.Get("templateDirectory"),rs.Get("efLogoInTemplate"),rs.Get("layoutStructure"),,isIframe,isUsingBootstrap)
		}
	}
	
	Do ..updateTemplateCSSFile(templateID)
]]></Implementation>
</Method>

<Method name="reloadTemplateDesign">
<Description>
reloads a set of templates in one design group. uses "description" from layout.objStandardDesign as input
needs to be used after changing the CSP/HTML index file</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateDesignDescription:%String</FormalSpec>
<Implementation><![CDATA[

	&SQL(SELECT ID INTO :tmp FROM layout.objStandardDesign WHERE description = :templateDesignDescription)
	if +SQLCODE=0 {
		set templateDesignID = tmp
		d ..reloadTemplateDesignID(templateDesignID)
	} else {
		w !,"Error: Description did not match any Template Design."
	}
]]></Implementation>
</Method>

<Method name="reloadTemplateDesignID">
<Description>
reloads a set of templates in one design group. uses ID from layout.objStandardDesign as input
needs to be used after changing the CSP/HTML index file</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateDesignID</FormalSpec>
<Implementation><![CDATA[
	if 'templateDesignID quit 0
	
	// create the sql object
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set ok=rs.Prepare("SELECT * FROM layout.objTemplate WHERE objStandardDesign=?")
	set ok=rs.Execute(templateDesignID)
	while rs.Next() {
		set isIframe=$S(rs.Get("isIframe")=1:1,1:0)
		set fn=rs.Get("originalFilename")
		
		set indexFile = ##class(shared.fileMethods).fileActions(fn, "R")
		set resultFile = ##class(shared.fileMethods).fileActions(fn, "WR", indexFile, "[[PATH]]|"_"../../media/templates/"_rs.Get("templateDirectory")_"/")
		
		w !,"Loading:",fn,"..."
		w " result=",##class(layout.objTemplate).loadTemplate(rs.Get("description"),rs.Get("internalDescription"),1,rs.Get("displayOrder"),fn,1,0,rs.Get("exampleImage"),rs.Get("accessibilityLevel"),rs.Get("styleSource"),rs.Get("templateDirectory"),rs.Get("efLogoInTemplate"),rs.Get("layoutStructure"),,isIframe)
		s fn=$P(fn,".html",1)_"_popup.html"
		if ##class(%Library.File).Exists(fn)	{  // if we don't have a popup template, doesn't matter, the normal one will be used
			w !,"Loading:",fn,"..."
			w " result=",##class(layout.objTemplate).loadTemplate(rs.Get("description")_"_popup",rs.Get("internalDescription")_"_popup",1,rs.Get("displayOrder"),fn,1,1,rs.Get("exampleImage"),rs.Get("accessibilityLevel"),rs.Get("styleSource"),rs.Get("templateDirectory"),rs.Get("efLogoInTemplate"),rs.Get("layoutStructure"),,isIframe)
		} else {
			//SA 17/01/2012 PBUG00006021 - Check for csp popup
			s fn=$P(fn,".csp",1)_"_popup.csp"
			if ##class(%Library.File).Exists(fn)	{  // if we don't have a popup template, doesn't matter, the normal one will be used
				w !,"Loading:",fn,"..."
				w " result=",##class(layout.objTemplate).loadTemplate(rs.Get("description")_"_popup",rs.Get("internalDescription")_"_popup",1,rs.Get("displayOrder"),fn,1,1,rs.Get("exampleImage"),rs.Get("accessibilityLevel"),rs.Get("styleSource"),rs.Get("templateDirectory"),rs.Get("efLogoInTemplate"),rs.Get("layoutStructure"),,isIframe)
			}
		}
	}
]]></Implementation>
</Method>

<Method name="reloadSingle">
<ClassMethod>1</ClassMethod>
<FormalSpec>page:%String</FormalSpec>
<Implementation><![CDATA[
	
	set page=$ZCVT(page,"L")

	if $ZUTIL(131,0)="TOYOTA"	{
		set path="d:\websites\eventsforce\frontend\layouts\"
		if $ZNSPACE="EVDEV" set path="d:\websites\eventsforcedev\frontend\layouts\"
	} else { 
		// default to D:\ for all live servers 
		set path="d:\websites\eventsforce.net\eventsforce\frontend\layouts\"
	}
	
	// THE DESCRIPTIONS HAVE TO BE UNIQUE - it will be overwritten with another template if the same
	set fn($I(fn))="table1.html",de(fn)="Left menu, banner and footer",in(fn)="frontEndFrameset1.csp",img(fn)="layout1.jpg",level(fn)="none",source(fn)="event",directory(fn)=""
	set fn($I(fn))="table2.html",de(fn)="Right menu, banner and footer",in(fn)="frontEndFrameset2.csp",img(fn)="layout2.jpg",level(fn)="none",source(fn)="event",directory(fn)=""
	set fn($I(fn))="table3.html",de(fn)="Menu along top and footer",in(fn)="frontEndFrameset3.csp",img(fn)="layout3.jpg",level(fn)="none",source(fn)="event",directory(fn)=""
	set fn($I(fn))="table4.html",de(fn)="Left menu, banner, footer and right hand page",in(fn)="frontEndFrameset4.csp",img(fn)="layout4.jpg",level(fn)="none",source(fn)="event",directory(fn)=""
	set fn($I(fn))="table5.html",de(fn)="Left menu, banner and footer centre aligned",in(fn)="frontEndFrameset5.csp",img(fn)="layout5.jpg",level(fn)="none",source(fn)="event",directory(fn)=""
	set fn($I(fn))="table6.html",de(fn)="Banner, menu along top and footer centre aligned",in(fn)="layout6",img(fn)="layout6.jpg",level(fn)="none",source(fn)="event",directory(fn)=""
	set fn($I(fn))="divexistingnoframeset.html",de(fn)="Existing no frameset layout",in(fn)="noFrameset.csp",img(fn)="layoutNoFrameset.jpg",level(fn)="none",source(fn)="event",directory(fn)=""
	set fn($I(fn))="tableiframe.html",de(fn)="No menu and banner (for IFRAMES)",in(fn)="IFRAME",img(fn)="layoutiFrame.jpg",level(fn)="none",source(fn)="event",directory(fn)=""
	set fn($I(fn))="EF_base_layout_left_menu.html",de(fn)="Standard Layout",in(fn)="EF_DEFAULT_LEFT_MENU",img(fn)="theme_8_small.gif",level(fn)="none",source(fn)="event",directory(fn)="EF/EF_base_layout_left_menu"
	set fn($I(fn))="EF_base_layout_left_menu_sponsors.html",de(fn)="Standard Layout with sponsors",in(fn)="EF_DEFAULT_LEFT_MENU_SPONSORS",img(fn)="theme_9_small.gif",level(fn)="none",source(fn)="event",directory(fn)="EF/EF_base_layout_left_menu_sponsors"
	set fn($I(fn))="EF_theme_001-01.html",de(fn)="EF theme 001-01",in(fn)="EF_THEME_001_01",img(fn)="layout4.jpg",level(fn)="none",source(fn)="template",directory(fn)="EF/EF_theme_001-01",efLogo(fn)=0,layout(fn)="vertical menu, sponsors, logo",design(fn)="Proof of Concept template"
	set fn($I(fn))="EF_theme_001-02.html",de(fn)="EF theme 001-02",in(fn)="EF_THEME_001_02",img(fn)="layout4.jpg",level(fn)="none",source(fn)="template",directory(fn)="EF/EF_theme_001-02",efLogo(fn)=0,layout(fn)="vertical menu, no sponsors, logo",design(fn)="Proof of Concept template"
	set fn($I(fn))="EF_theme_007-03.html",de(fn)="Theme 007 03 vertical menu, sponsors, logo",in(fn)="EF_THEME_007_03",img(fn)="layout1.jpg",level(fn)="none",source(fn)="template",directory(fn)="EF/EF_theme_007-03",efLogo(fn)=0,layout(fn)="vertical menu, sponsors, logo",design(fn)="Design 7"
	set fn($I(fn))="EF_theme_006-04.html",de(fn)="Theme 006 04 horizontal menu, no sponsors, no logo",in(fn)="EF_THEME_006_04",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="EF/EF_theme_006-04",efLogo(fn)=0,layout(fn)=" horizontal menu, no sponsors, no logo",design(fn)="Design 6"
	
	// eventsforce branded template
	set fn($I(fn))="eventsforce_2010.html",de(fn)="Eventsforce Brand 2010",in(fn)="EF_2010",img(fn)="layout4.jpg",level(fn)="none",source(fn)="template",directory(fn)="EF/eventsforce_2010"
	
	set fn($I(fn))="schroders.html",de(fn)="Schroders",in(fn)="SCHRODERS",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="schroders_images"
	set fn($I(fn))="schroders2.html",de(fn)="Schroders (no banner)",in(fn)="SCHRODERSNOBANNER",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="schroders_images"
	set fn($I(fn))="schroders_2010.html",de(fn)="Schroders 2010",in(fn)="SCHRODERS2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Schroders/2010"
	set fn($I(fn))="juniper3cols.html",de(fn)="Juniper 3 columns",in(fn)="Juniper3Col",img(fn)="layout4.jpg",level(fn)="none",source(fn)="template",directory(fn)="juniper"
	set fn($I(fn))="vodafone.html",de(fn)="Vodafone",in(fn)="VODAFONE",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="vodafone"
	set fn($I(fn))="vodafone2.html",de(fn)="Vodafone.com",in(fn)="VODAFONE.COM",img(fn)="layout3.jpg",level(fn)="none",source(fn)="template",directory(fn)="vodafone2"
	set fn($I(fn))="rslive_ncsl.html",de(fn)="NCSL",in(fn)="NCSL",img(fn)="layout4.jpg",level(fn)="none",source(fn)="template",directory(fn)="rslive_NCSL"
	set fn($I(fn))="rslive_learndirect_awards.html",de(fn)="LEARNDIRECT AWARDS",in(fn)="RSLIVE LEARNDIRECT AWARDS",img(fn)="layout5.jpg",level(fn)="none",source(fn)="template",directory(fn)="rslive_learndirect_awards"
	set fn($I(fn))="rslive_dh.html",de(fn)="Dept of Health",in(fn)="DEPT OF HEALTH",img(fn)="layout3.jpg",level(fn)="none",source(fn)="template",directory(fn)="rslive_dh"
	set fn($I(fn))="rslive_chpo_conf.html",de(fn)="CHPO Conference",in(fn)="CHPO CONFERENCE",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="rslive_chpo_conf"
	set fn($I(fn))="rslive_ucl_09.html",de(fn)="UCL 2009",in(fn)="UCL 2009",img(fn)="layout1.jpg",level(fn)="none",source(fn)="template",directory(fn)="rslive_ucl"
	set fn($I(fn))="menu_along_top_over_banner.html",de(fn)="Menu along top, banner below, centred",in(fn)="MENUTOPBANNERBELOW",img(fn)="layout6.jpg",level(fn)="none",source(fn)="event",directory(fn)="menu_along_top_over_banner"
	set fn($I(fn))="rockwell.html",de(fn)="Rockwell",in(fn)="ROCKWELL",img(fn)="layout1.jpg",level(fn)="none",source(fn)="template",directory(fn)="rockwell"
	set fn($I(fn))="AOP2008.html",de(fn)="AOP2008",in(fn)="AOP2008",img(fn)="layout4.jpg",level(fn)="none",source(fn)="template",directory(fn)="AOP2008"
	set fn($I(fn))="PPA_FIPP.html",de(fn)="PPA FIPP",in(fn)="PPAFIPP",img(fn)="layout5.jpg",level(fn)="none",source(fn)="template",directory(fn)="PPA_FIPP"
	set fn($I(fn))="PPA_FIPP2.html",de(fn)="PPA FIPP2",in(fn)="PPAFIPP2",img(fn)="layout5.jpg",level(fn)="none",source(fn)="template",directory(fn)="PPA_FIPP2"
	set fn($I(fn))="DODS_westminster.html",de(fn)="DODS Westminster",in(fn)="DODS WESTMINSTER",img(fn)="layout4.jpg",level(fn)="none",source(fn)="template",directory(fn)="DODS_Westminster"
	set fn($I(fn))="DODS_div_template.html",de(fn)="DODS Blank",in(fn)="DODS BLANK",img(fn)="layoutNoFrameset.jpg",level(fn)="none",source(fn)="event",directory(fn)=""
	set fn($I(fn))="centaur_awards.html",de(fn)="Centaur Awards",in(fn)="CENTAUR AWARDS",img(fn)="layout5.jpg",level(fn)="none",source(fn)="template",directory(fn)="centaur_awards"
	set fn($I(fn))="waterfront.html",de(fn)="Waterfront",in(fn)="WATERFRONT",img(fn)="layout2.jpg",level(fn)="none",source(fn)="template",directory(fn)="waterfront"
	set fn($I(fn))="3_column_static_glish.html",de(fn)="Left menu, banner, footer, right page, centred (accessible)",in(fn)="Glish3ColStatic",img(fn)="layout4.jpg",level(fn)="A",source(fn)="event",directory(fn)=""
	set fn($I(fn))="2_column_static_jw.html",de(fn)="Left menu, banner, footer, centred (accessible)",in(fn)="JAW2ColStatic",img(fn)="layout5.jpg",level(fn)="A",source(fn)="event",directory(fn)=""
	set fn($I(fn))="1_column_static_jw.html",de(fn)="Top menu, banner, footer, centred (accessible)",in(fn)="JAW1ColStatic",img(fn)="layout3.jpg",level(fn)="A",source(fn)="event",directory(fn)=""
	set fn($I(fn))="idl_fixed_banner.html",de(fn)="IDL (fixed top banner)",in(fn)="PJCFixedTopBanner",img(fn)="layout1.jpg",level(fn)="A",source(fn)="event",directory(fn)=""
	set fn($I(fn))="juniper_feb_2009.html",de(fn)="Juniper (top site menu, left menu, banner)",in(fn)="PJCJuniper",img(fn)="layout1.jpg",level(fn)="none",source(fn)="template",directory(fn)="juniper"
	set fn($I(fn))="juniper_oct_2009.html",de(fn)="Juniper Oct 2009",in(fn)="JUNIPER_OCT2009",img(fn)="layout1.jpg",level(fn)="none",source(fn)="template",directory(fn)="juniper/juniper_oct_2009"
	set fn($I(fn))="p4m_tandberg.html",de(fn)="P4M Tandberg",in(fn)="P4MTandberg",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="p4m/tandberg"
	set fn($I(fn))="p4m_wabcg.html",de(fn)="P4M WABCG",in(fn)="P4MWABCG",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="p4m/wabcg"
	set fn($I(fn))="p4m_tandberg_amsterdam.html",de(fn)="P4M Tandberg Amsterdam",in(fn)="P4MTandbergAmsterdam",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="p4m/tandberg_amsterdam"
	set fn($I(fn))="incisive_bia2010.html",de(fn)="Incisive - The British Insurance Awards 2010",in(fn)="Incisive_BIA2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Incisive/Incisive_BIA2010"
	set fn($I(fn))="Reed_Mackay_Generic.html",de(fn)="Reed & Mackay Generic",in(fn)="Reed_Mackay_Generic",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Reed_Mackay/Generic"
	set fn($I(fn))="bad_agm2010.html",de(fn)="BAD AGM 2010",in(fn)="BAD_AGM2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="BAD/BAD_AGM2010"
	set fn($I(fn))="aviva2010branded.html",de(fn)="Aviva Branded 2010",in(fn)="AVIVA_2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/2010"
	set fn($I(fn))="tfl2010.html",de(fn)="TFL Branded 2010",in(fn)="TFL_2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="TFL/2010"
	set fn($I(fn))="Enterprise_Ireland_new.html",de(fn)="Enterprise Ireland Branded 2010",in(fn)="Enterprise_Ireland",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Enterprise_Ireland/new"
	set fn($I(fn))="Enterprise_Ireland_current.html",de(fn)="Enterprise Ireland Current",in(fn)="Enterprise_Ireland",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Enterprise_Ireland/current"
	set fn($I(fn))="ScottishEnterprise.html",de(fn)="Scottish Enterprise",in(fn)="Scottish_Enterprise",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Scottish_Enterprise/ScottishE"
	set fn($I(fn))="TFI_Tarkett2011.html",de(fn)="TFI Tarkett 2011",in(fn)="TFI",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="TFI/Tarkett_2011"
	set fn($I(fn))="EuroRSCG_Heist.html",de(fn)="EuroRSCG Heist",in(fn)="EuroRSCG",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="EuroRSCG/EuroRSCG_Heist"
	set fn($I(fn))="aocms_2011.html",de(fn)="AoC MS 2011",in(fn)="AOC",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="AOC/AOCMS_2011"
	set fn($I(fn))="aocms_2011_orange.html",de(fn)="AoC MS 2011 Orange",in(fn)="AOC_orange",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="AOC/AOCMS_2011_orange"
	set fn($I(fn))="aocms_2011_blue.html",de(fn)="AoC MS 2011 Blue",in(fn)="AOC_blue",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="AOC/AOCMS_2011_blue"
	set fn($I(fn))="ifb_nextgen2011.html",de(fn)="IFB Next Generation",in(fn)="IFB_NextGen",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="IFB/NEXTGEN2011"
	set fn($I(fn))="EuroRSCG_Heist_UHR.html",de(fn)="EuroRSCG Heist UHR",in(fn)="EuroRSCG_UHR",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="EuroRSCG/EuroRSCG_Heist_UHR"
	set fn($I(fn))="lwm_iframe.html",de(fn)="Last Word Media Iframe",in(fn)="LWM_IFRAME",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="lwm/lwm_iframe"
	set fn($I(fn))="Bookseller_Awards2011.html",de(fn)="Bookseller Awards 2011",in(fn)="BOOKSELLERA2011",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Bookseller/Bookseller_Awards2011"
	// AVIVA
	set fn($I(fn))="Aviva2010.html",de(fn)="Aviva 2010",in(fn)="AVIVA2010",img(fn)="layout1.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/aviva2010"
	set fn($I(fn))="AvivaInvestors2010.html",de(fn)="Aviva Investors 2010",in(fn)="AVIVA_INVESTORS2010",img(fn)="layout1.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivainvestors2010"
	set fn($I(fn))="AvivaAthletics2010.html",de(fn)="Aviva Athletics 2010",in(fn)="AVIVA_ATHLETICS2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivaathletics2010"
	set fn($I(fn))="AvivaBoat2010.html",de(fn)="Aviva Boat 2010",in(fn)="AVIVA_BOAT2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivaboat2010"
	set fn($I(fn))="AvivaArsenal2010.html",de(fn)="Aviva Arsenal 2010",in(fn)="AVIVA_ARSENAL2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivaarsenal2010"
	set fn($I(fn))="AvivaGleneagles2010.html",de(fn)="Aviva Gleneagles 2010",in(fn)="AVIVA_GLENEAGLES2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivagleneagles2010"
	set fn($I(fn))="AvivaMurrayField2010.html",de(fn)="Aviva MurrayField 2010",in(fn)="AVIVA_MURRAYFIELD2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivamurrayfield2010"
	set fn($I(fn))="AvivaManchester2010.html",de(fn)="Aviva Manchester 2010",in(fn)="AVIVA_MANCHESTER2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivamanchester2010"
	set fn($I(fn))="AvivaMillennium2010.html",de(fn)="Aviva Millennium 2010",in(fn)="AVIVA_MILLENNIUM2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivamillennium2010"
	set fn($I(fn))="AvivaTwickenham2010.html",de(fn)="Aviva Twickenham 2010",in(fn)="AVIVA_TWICKENHAM2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivatwickenham2010"
	set fn($I(fn))="AvivaWembley2010.html",de(fn)="Aviva Wembley 2010",in(fn)="AVIVA_WEMBLEY2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivawembley2010"
	set fn($I(fn))="AvivaWimbledon2010.html",de(fn)="Aviva Wimbledon 2010",in(fn)="AVIVA_WIMBLEDON2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivawimbledon2010"
	set fn($I(fn))="AvivaTop2010.html",de(fn)="Aviva Top 2010",in(fn)="AVIVA_TOP2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivatop2010"
	set fn($I(fn))="AvivaInvestorsTop2010.html",de(fn)="Aviva Investors Top 2010",in(fn)="AVIVA_INVESTORSTOP2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivainvestorstop2010"
	set fn($I(fn))="AvivaNoImage2010.html",de(fn)="Aviva No images 2010",in(fn)="AVIVA_NOIMAGE2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivanoimage2010"
	set fn($I(fn))="AvivaNoImage2011.html",de(fn)="Aviva No images 2011",in(fn)="AVIVA_NOIMAGE2011",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivanoimage2011"
	set fn($I(fn))="AvivaRacNoImages.html",de(fn)="Aviva RAC No images",in(fn)="AVIVA_RACNOIMAGES",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="aviva/avivaracnoimages"
	// HAYMARKET
	set fn($I(fn))="haymarket_av2010.html",de(fn)="Haymarket - AV Awards 2010",in(fn)="Haymarket_AV2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Haymarket/Haymarket_AV2010"
	// INCISIVE MEDIA
	set fn($I(fn))="incisive_crn2010.html",de(fn)="Incisive - CRN Channel Awards 2010",in(fn)="Incisive_CRN2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Incisive/Incisive_CRN2010"
	set fn($I(fn))="incisive_ukit2010.html",de(fn)="Incisive - UK IT Industry Awards 2010",in(fn)="Incisive_UKIT2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Incisive/Incisive_UKIT2010"
	set fn($I(fn))="incisive_accountancyage10.html",de(fn)="Incisive - Accountancy Age Awards 2010",in(fn)="Incisive_accountancyage10",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Incisive/Incisive_AccountancyAge10"
	set fn($I(fn))="incisive_rfa2010.html",de(fn)="Incisive - Rehabilitation First Awards 2010",in(fn)="Incisive_RFA2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Incisive/Incisive_RFA2010"
	
	// WELLCOME TRUST
	set fn($I(fn))="wellcome_pacifichealth2010.html",de(fn)="Wellcome Pacific Health 2010",in(fn)="WELLCOME_PACIFICHEALTH2010",img(fn)="layout6.jpg",level(fn)="none",source(fn)="template",directory(fn)="Wellcome/Wellcome_PacificHealth2010"
	set fn($I(fn))="wellcome_events.html",de(fn)="Wellcome Trust Events",in(fn)="WELLCOME_EVENTS",img(fn)="layout5.jpg",level(fn)="none",source(fn)="template",directory(fn)="Wellcome/Wellcome_Events"
	set fn($I(fn))="wellcome_generic.html",de(fn)="Wellcome Trust Generic",in(fn)="WELLCOME_GENERIC",img(fn)="layout5.jpg",level(fn)="none",source(fn)="template",directory(fn)="Wellcome/Wellcome_Generic"
	set fn($I(fn))="wellcome_2011.html",de(fn)="Wellcome 2011",in(fn)="WELLCOME_2011",img(fn)="layout5.jpg",level(fn)="none",source(fn)="template",directory(fn)="Wellcome/Wellcome_2011"
	// CMPI
	set fn($I(fn))="cmpi_cmpmedica_dementia.html",de(fn)="CMPMedica dementia",in(fn)="CMPI_CMPMEDICA_DEMENTIA",img(fn)="layout3.jpg",level(fn)="none",source(fn)="template",directory(fn)="CMPI/CMPMedica_Dementia"
	// DEMOS
	set fn($I(fn))="societe_generale.html",de(fn)="Societe Generale Demo",in(fn)="SOCIETE_GENERALE_DEMO",img(fn)="layout1.jpg",level(fn)="none",source(fn)="template",directory(fn)="societe_generale/demo"
	
	set i=""
	for  {
		set i=$O(fn(i))
		if i="" quit
		
		s fn=$ZCVT(fn(i),"L")
		if fn=page!(page="*") {
			w !,"Loading:",fn,"..."
			if ##class(%Library.File).Exists(path_fn) {
				w " result=",##class(layout.objTemplate).loadTemplate(de(i),in(i),1,i,path_fn,1,0,img(i),level(i),source(i),directory(i),$G(efLogo(i)),$G(layout(i)),$G(design(i)))
			} else {
				w " file not found"
			}
		}
		s fnP=$P(fn,".html",1)_"_popup.html"
		if fn=page!(page="*"),##class(%Library.File).Exists(path_fnP)	{  // if we don't have a popup template, doesn't matter, the normal one will be used
			w !,"Loading:",fnP,"..."
			w " result=",##class(layout.objTemplate).loadTemplate(de(i)_"_popup",in(i)_"_popup",1,i,path_fnP,1,1,img(i),level(i),source(i),directory(i),$G(efLogo(i)),$G(layout(i)),$G(design(i)))
		}
	}
	
	quit
]]></Implementation>
</Method>

<Method name="isAccessible">
<Description>
to determine when to use the accessible coding in frontend</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set layoutTemplateID=##class(layout.objTemplate).getLayoutForEvent(eventID)
	set isAccessible=(##class(layout.objTemplate).getAccessibility(layoutTemplateID)["A")
	// use this for now - will be removed when we've educated the masses on the accessible templates
	if '##class(setup.objSetting).getParameter("accessibility","use new accessible code") set isAccessible=0
	quit isAccessible
]]></Implementation>
</Method>

<Method name="setNewProps">
<Description>
noddy to populate the new properties for accessibility and style sheets</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	// MAKE SURE NEW TEMPLATES HAVE A PATH TO NEW CSS FILE PRIOR TO RUNNING THIS
	// this will reload the templates a client currently has on their system and also populate the properties (as the properties are set in the above methods)
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set sqltext="SELECT * FROM layout.objTemplate "
	do rs.Prepare(sqltext)
	do rs.Execute()
	while rs.Next() {
		set templateID=rs.Data("ID")
		set filename=rs.Data("originalFilename")
		set filename=$P(filename,"\",$L(filename,"\"))
		// don't load popups, they get loaded by the original file
		if 'rs.Data("popup") do ..reloadSingle(filename)
	}
	
	quit
]]></Implementation>
</Method>

<Method name="removeStyleFromAllMenusInEvent">
<Description>
apply CSS based menu</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	if 'xEventID quit 0
	set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"removeStyleFromAllMenusInEvent")="start - xEventID="_xEventID

	// loop on all languages in the event
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT ID FROM shared.objLanguage")
	d rs.Execute()
	set out=0
	while rs.Next() {
		set xLangID=rs.Get("ID")
		set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"removeStyleFromAllMenusInEvent")="Language loop - xLangID="_xLangID
		// find the page that contains the menu
		&SQL(SELECT menuPageID INTO :tmp FROM setup.objEventDetails WHERE objEvent = :xEventID AND objLanguage = :xLangID)
		if +SQLCODE=0 {
			set menuPageID=tmp
			set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"removeStyleFromAllMenusInEvent")="Language loop - menuPageID found="_menuPageID
	
			// remove any style from the menu block
			set rs2=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs2.Prepare("SELECT ID,description FROM sc_xModules.objMenuBlock WHERE parent->parent=? ORDER BY xMOstamp DESC")
			do rs2.Execute(menuPageID)
			while rs2.Next() { 
				set dataID=rs2.Get("ID")
				set mbDescription=rs2.Get("description")
				do ##class(sc.xModules.objMenuBlock).update(dataID,mbDescription,"","","","","","","") // clear all styles
				set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"removeStyleFromAllMenusInEvent")="menu block dataID="_dataID
			}
		}
	}
		
	quit out
]]></Implementation>
</Method>

<Method name="applyLegacyStyleToMenu">
<Description>
aplly the style of the legacy templates to the menu</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	if 'xEventID quit 0
	set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"applyLegacyStyleToMenu")="start - xEventID="_xEventID

	// loop on all languages in the event
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT ID FROM shared.objLanguage")
	d rs.Execute()
	set out=0
	while rs.Next() {
		set xLangID=rs.Get("ID")
		set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"applyLegacyStyleToMenu")="Language loop - xLangID="_xLangID
		// find the page that contains the menu
		&SQL(SELECT menuPageID INTO :tmp FROM setup.objEventDetails WHERE objEvent = :xEventID AND objLanguage = :xLangID)
		if +SQLCODE=0 {
			set menuPageID=tmp
			set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"applyLegacyStyleToMenu")="Language loop - menuPageID found="_menuPageID
			
			// identify the themeID for the 'vertical graduated black/green' default style
			set themeID=""
			&SQL(SELECT ID INTO :tmp FROM layout.objTheme WHERE internalDescription='vertical graduated black/green menu')
			if +SQLCODE=0 set themeID=tmp
	
			// add the 'vertical graduated black/green' default style to the menu block
			set rs2=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs2.Prepare("SELECT ID,description FROM sc_xModules.objMenuBlock WHERE parent->parent=? ORDER BY xMOstamp DESC")
			do rs2.Execute(menuPageID)
			while rs2.Next() { 
				set dataID=rs2.Get("ID")
				set mbDescription=rs2.Get("description")
				do ##class(sc.xModules.objMenuBlock).update(dataID,mbDescription,"","","","","",themeID,"") // clear all styles
				
				set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"applyLegacyStyleToMenu")="menu block dataID="_dataID
			}
		}
	}
		
	quit out
]]></Implementation>
</Method>

<Method name="applyBannersToTemplate">
<Description>
apply the banners to EF standard templates</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>layoutTemplateID,xEventID,dontAddImage=0</FormalSpec>
<Implementation><![CDATA[
	set out=0
	if 'layoutTemplateID quit out
	set bannerImage="banner.png"
	set secondaryBannerImage="secondary_banner.png"
	#dim imageTag as %String 

	// get the path to the template
	&SQL(SELECT templateDirectory INTO :templateDirectory FROM layout.objTemplate WHERE ID =:layoutTemplateID)
	
	// check if we are using the new style (autoban) or the old style templates
	if ##class(layout.objTemplate).isTemplateNewStyle(layoutTemplateID) {
		set rootDir="../../media/templates/"
	} else {
		set rootDir="../../frontend/layouts/"
	}
	
	// loop on all languages in the event
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT ID FROM shared.objLanguage")
	do rs.Execute()
	set out=0
	while rs.Next() {
		set xLangID=rs.Get("ID")
		set desciptionModifier=""
		if xLangID'=1 set desciptionModifier=" - "_##class(shared.objLanguage).getLanguageDesc(xLangID)
		
		// find the pages that contains the banner
		&SQL(SELECT bannerPageID INTO :tmp FROM setup.objEventDetails WHERE objEvent = :xEventID AND objLanguage = :xLangID)
		if +SQLCODE=0 {
			set bannerPageID=tmp
			set secondaryBannerPageID=##class(setup.objEventSetting).getParameter("mainpages","secondary banner pageID"_desciptionModifier,xEventID)

			for pageID=bannerPageID,secondaryBannerPageID {
				set filename=rootDir_templateDirectory_"/"_$S(pageID=bannerPageID:bannerImage,1:secondaryBannerImage)
				set imageTag="<img alt='Eventsforce banner' src='"_filename_"' border=0 style='width: 100%'>"
				
				// walk through all the text blocks
				set foundTextBlock=0
				set rs2=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
				do rs2.Prepare("SELECT ID,description FROM sc_xModules.objText WHERE (active=1) AND (parent->parent=?)")
				do rs2.Execute(pageID)
				while rs2.Next() {
					set dataID=rs2.Get("ID")
					set foundTextBlock=1
					set HTMLstring=rs2.Get("description")	
					if (HTMLstring["ADDED BY layout.methods.applyBannersToTemplate(dontAddImage)") ! (HTMLstring["alt='Eventsforce banner'")  { // remove any banners that were 'factory' added
				
						set objTextItem=##class(sc.xModules.objText).%OpenId(dataID)
						set listID=objTextItem.parent.%Id()
						kill objTextitem

						// disable ANY old text blocks in this list
						&SQL(UPDATE sc_xModules.objText SET active=0 WHERE parent = :listID AND active=1)
					
						// add my new text block with the passed in image
						set text=imageTag
						if dontAddImage set text="<!-- ADDED BY layout.methods.applyBannersToTemplate(dontAddImage) -->"
						set out=##class(sc.xModules.objText).add(listID,text)
						
						quit  // quit the text block loop to make sure we don't find the item we just added
						
					} else { // do not touch banners that have been manually uploaded
						// do nothing
					}
				}
			
				// create new text block if none found
				if foundTextBlock=0 {
					// check if we already have a list item
					&SQL(SELECT ID INTO :tmp FROM sc_xModules.objList WHERE active=1 AND parent= :pageID)
					if +SQLCODE=0 {
						set listID=tmp	
					} else {
						set listID=##class(sc.xModules.objList).add(pageID)
						// create a component
						&SQL(SELECT objTemplate INTO :templateID FROM sc_xModules.objPage WHERE (active=1 AND ID = :pageID))		
						if +SQLCODE=0 {
							do ##class(sc.objComponent).add("INDEXLIST",templateID,listID)	
						}
					}
				
					// add the text
					set text=imageTag
					if dontAddImage set text="<!-- ADDED BY layout.methods.applyBannersToTemplate(dontAddImage) -->"
					set out=##class(sc.xModules.objText).add(listID,text)
				}
			}
		}
	}
	quit out
]]></Implementation>
</Method>

<Method name="applyHomePageContents">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	if 'xEventID quit 0
	set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"applyHomePageContents")=xEventID

	set SQLCODE=""
	// loop on all languages in the event
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT ID FROM shared.objLanguage")
	do rs.Execute()
	while rs.Next() {
		set xLangID=rs.Get("ID")
		
		// find the page that contains the homepage
		&SQL(SELECT homePageID INTO :tmp FROM setup.objEventDetails WHERE objEvent = :xEventID AND objLanguage = :xLangID)
		if +SQLCODE=0 {
			set homePageID=tmp,tmp2=""
			set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"homePageID")=homePageID
			// look for any text block that was created by this method
			&SQL(SELECT ID,description INTO :tmp1,:tmp2 FROM sc_xModules.objText WHERE (parent->parent = :homePageID) AND (active=1) AND (description LIKE '%ADDED BY layout.methods.applyHomePageContents()%'))
			set foundTextBlock=$S(+SQLCODE=0:1,1:0)
			set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"foundTextBlock")=foundTextBlock_" | "_tmp2
			
			if foundTextBlock=0 {
				// check if we already have a list item
				&SQL(SELECT ID INTO :tmp FROM sc_xModules.objList WHERE active=1 AND parent= :homePageID)
				if +SQLCODE=0 {
					set listID=tmp	
				} else {
					set listID=##class(sc.xModules.objList).add(homePageID)
					// create a component
					&SQL(SELECT objTemplate INTO :templateID FROM sc_xModules.objPage WHERE (active=1 AND ID = :homePageID))		
					if +SQLCODE=0 {
						do ##class(sc.objComponent).add("Main List",templateID,listID)	
						set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"applyHomePageContents")="added component for listID "_listID_" and templateID: "_templateID
					}						
				
				}
				
				&SQL(SELECT ID FROM sc_xModules.objtext WHERE parent=:listID AND active=1)
				if +SQLCODE'=0 {
					// add the text but only if we have no real text and no latin text
					set text="<!-- ADDED BY layout.methods.applyHomePageContents() --><h2>Lorem ipsum</h2><h3>dolor sit</h3><p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex ea commodo consequat. Duis autem vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent luptatum zzril delenit augue duis dolore te feugait nulla facilisi.</p><h3>Nam liber<br /></h3><p>Nam liber tempor cum soluta nobis eleifend option congue nihil imperdiet doming id quod mazim placerat facer possim assum. Typi non habent claritatem insitam; est usus legentis in iis qui facit eorum claritatem. Investigationes demonstraverunt lectores legere me lius quod ii legunt saepius. Claritas est etiam processus dynamicus, qui sequitur mutationem consuetudium lectorum. Mirum est notare quam litteraothica, quam nunc putamus parum claram, anteposuerit litterarum formas humanitatis per seacula quarta decima et quinta decima. Eodem modo typi, qui nunc nobis videntur parum clari, fiant sollemnes in futurum.</p>"
					set ok=##class(sc.xModules.objText).add(listID,text)
					set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"applyHomePageContents")="added text item: "_ok_" - text:" _text
				}
			}
		}
	}
		
	quit 1
]]></Implementation>
</Method>

<Method name="applySampleSponsors">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	if 'xEventID quit 0
	set out=0
	set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"applySampleSponsors")=xEventID
	set SQLCODE=""
	// loop on all languages in the event
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT ID FROM shared.objLanguage")
	do rs.Execute()
	while rs.Next() {
		set xLangID=rs.Get("ID")
		
		set desciptionModifier=""
		if xLangID'=1 set desciptionModifier=" - "_##class(shared.objLanguage).getLanguageDesc(xLangID)
		set rightPageID=##class(setup.objEventSetting).getParameter("mainpages","rightPageID"_desciptionModifier,xEventID)	
		
		// make sure we do NOT have a text block already
		set foundTextBlock=0
		&SQL(SELECT ID FROM sc_xModules.objText WHERE (active=1) AND parent->parent = :rightPageID)
		if +SQLCODE'=0,rightPageID {
			// check if we already have a list item
			&SQL(SELECT ID INTO :tmp FROM sc_xModules.objList WHERE active=1 AND parent= :rightPageID)
			if +SQLCODE=0 {
				set listID=tmp	
			} else {
				set listID=##class(sc.xModules.objList).add(rightPageID)
				// create a component
				&SQL(SELECT objTemplate INTO :templateID FROM sc_xModules.objPage WHERE (active=1 AND ID = :rightPageID))		
				if +SQLCODE=0 do ##class(sc.objComponent).add("INDEXLIST",templateID,listID)	
			}
			
			// add the text
			set text="<!-- ADDED BY 'layout.methods.applySampleSponsors()' --><table width='100%'><tr><td align='center'><img src='../../media/images/English/Default/frontend/example_acorn.png' alt='' /><br /><br /><img src='../../media/images/English/Default/frontend/example_atari.png' alt='' /><br /><br /><img src='../../media/images/English/Default/frontend/example_betamax.png' alt='' /><br /><br /><img src='../../media/images/English/Default/frontend/example_sinclair.png' alt='' /><br /><br /><img src='../../media/images/English/Default/frontend/example_amiga.png' alt='' /><br /><br /></td></tr></table>"
			do ##class(sc.xModules.objText).add(listID,text)
			set ^xApplyThemeLog($I(^xApplyThemeLog),$ZTS,"applySampleSponsors")="added text block: "_text
			set out=out+1
		}
	}
		
	quit out
]]></Implementation>
</Method>

<Method name="getCurrentTheme">
<Description>
returns "templateID | template description"</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<Implementation><![CDATA[
	set out="",tmp="",currentTemplateID=""
	&SQL(SELECT layoutObjTemplate INTO :tmp FROM setup.objEvent WHERE ID = :eventID)
	if +SQLCODE=0 set currentTemplateID=tmp

	&SQL(SELECT description INTO :desc FROM layout.objTemplate WHERE ID = :currentTemplateID)
	if +SQLCODE=0 {
		set desc=$replace(desc,"Default Design","Standard Design") // renamed Oct 2014
		set out=currentTemplateID_"|"_desc
	}
	quit out
]]></Implementation>
</Method>

<Method name="getLayoutDescriptionFromNumber">
<ClassMethod>1</ClassMethod>
<FormalSpec>layoutNumber</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out="0|not found"

	if layoutNumber=1 set out="Vertical Menu, Sponsors, Logo"
	if layoutNumber=2 set out="Vertical Menu, No Sponsors, Logo"
	if layoutNumber=3 set out="Vertical Menu, Sponsors, No Logo"
	if layoutNumber=4 set out="Vertical Menu, No Sponsors, No Logo"
	if layoutNumber=5 set out="Horizontal Menu, Sponsors, Logo"
	if layoutNumber=6 set out="Horizontal Menu, No Sponsors, Logo"
	if layoutNumber=7 set out="Horizontal Menu, Sponsors, No Logo"
	if layoutNumber=8 set out="Horizontal Menu, No Sponsors, No Logo"
	if layoutNumber=9 set out="No Menu, No Sponsors, No Logo"
	if layoutNumber=10 set out="Left Menu"
	if layoutNumber=11 set out="Left Menu, Banner and Footer"
	if layoutNumber=12 set out="Right Menu, Banner and Footer"
	if layoutNumber=13 set out="Top Menu and Footer"
	if layoutNumber=14 set out="Left Menu, Banner, Footer and Right Hand Page"
	if layoutNumber=15 set out="Left Menu, Banner and Footer Centre Aligned"
	if layoutNumber=16 set out="Top Menu, Banner and Footer Centre Aligned"
	if layoutNumber=17 set out="Existing No Frameset Layout"
	if layoutNumber=18 set out="Left Menu, Banner, Footer, Right Page, Centred (Accessible)"
	if layoutNumber=19 set out="Left Menu, Banner, Footer, Centred (Accessible)"
	if layoutNumber=20 set out="Top Menu, Banner, Footer, Centred (Accessible)"
	if layoutNumber=21 set out="Iframe"
	
	quit out
]]></Implementation>
</Method>

<Method name="getDefaultThemeID">
<Description>
get the theme either we have setup or the client has overridden - used for brand new events</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set themeID=##class(setup.objSetting).getParameter("themes","default theme for new events")
	if 'themeID {
		set themeID=##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_default_design_04")
	}
	if 'themeID {  // if we still haven't found the default, use the latest one we've loaded
		&SQL(SELECT TOP 1 ID INTO :tmp FROM layout.objTemplate ORDER BY ID DESC)
		if +SQLCODE=0 set themeID=tmp
	}
	quit themeID
]]></Implementation>
</Method>

<Method name="convertDefaultTheme">
<Description>
convert currently set default them from our old to newer template</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	
	set curDefaultThemeID=##class(setup.objSetting).getParameter("themes","default theme for new events")
	set oldDefaultThemeID=##class(layout.objTemplate).getIDfromIntDesc("EF_DEFAULT_LEFT_MENU")
	set newDefaultThemeID=##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_default_design_04")
	set updateDefault=0
	if oldDefaultThemeID=curDefaultThemeID set updateDefault=1
	if 'curDefaultThemeID set updateDefault=1
	if curDefaultThemeID&&$L(##class(layout.objTemplate).getIntDesc(curDefaultThemeID))="" set updateDefault=1  // deal with deleted default templates
	if updateDefault	{
		do ##class(setup.objSetting).setParameter("themes","default theme for new events",newDefaultThemeID)
	}
]]></Implementation>
</Method>

<Method name="canUseWebsiteColorsForEvent">
<Description>
Can website colors be used for this event?</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%Integer</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set templateID = +(##class(layout.objTemplate).getLayoutForEvent(eventID))
	
	if ..isThisDefaultDesign(templateID) {
		return 1
	}
	
	return 0
]]></Implementation>
</Method>

<Method name="canUseStyleOverrides">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// Same as canUseWebsiteColorsForEvent for now....
	quit ..canUseWebsiteColorsForEvent(eventID)
]]></Implementation>
</Method>

<Method name="canUseCustomEventCSS">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%Integer</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	if ##class(layout.objTemplate).getIntDesc( ##class(layout.objTemplate).getLayoutForEvent(eventID) ) ?1"EF_THEME_standard_design".E	{
		return 1	
	} else {
		return 0
	}
]]></Implementation>
</Method>

<Method name="isThisDefaultDesign">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// *** NOTE THIS SHOULD BE CHANGED TO USE THE THEME GROUP NAME rather than the actual layout ***
	set ret=0
	
	kill allowedThemeIDs
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_default_design_04")))=""
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_default_design_07")))=""
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_default_design_08")))=""
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_default_design_09")))=""
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_default_design_21")))="" 

	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design_04")))="" 
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design_07")))="" 
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design_08")))="" 
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design_09")))="" 
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design_21")))="" 
	
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design-v2_08")))="" 
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design-v2_04")))="" 
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design-v2_07")))="" 
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design-v2_09")))="" 
	set allowedThemeIDs(+(##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design-v2_21")))="" 

	If (templateID) {
		If ($DATA(allowedThemeIDs(templateID))) {
			Set ret=1
		}
	}
	
	quit ret
]]></Implementation>
</Method>

<Method name="canChangeWebsiteStyles">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=1
	
	set eventStatus=""
	&SQL(SELECT status INTO :tmpEventStatus FROM setup.objEvent WHERE ID = :eventID)
	if +SQLCODE=0 {
		if tmpEventStatus="live" set out=0
	}
	
	quit out
]]></Implementation>
</Method>

<Method name="popIsIframeForExistingTempl">
<Description>
one-off noddy to set the 'isIframe' value to '1' for the two existing iFrame templates we have</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&SQL(UPDATE layout.objTemplate SET isIframe=1 WHERE description='No Menu and Banner (For IFRAMES)')
	&SQL(UPDATE layout.objTemplate SET isIframe=1 WHERE description='Default Design 21 Iframe')
]]></Implementation>
</Method>

<Method name="updateEFLogoForDefaultDesign">
<Description>
one-off to update all clients who have not got the EF logo flag correctly set on their default design templates 
 - these will only be new clients since we installed the default design</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT ID FROM layout.objTemplate")
	do rs.Execute()
	while rs.Next() {
		set templateID=rs.Data("ID")
		if ..isThisDefaultDesign(templateID) {
			if '##class(layout.objTemplate).isEFLogoInTemplate(templateID)	{
				&SQL(UPDATE layout.objTemplate SET efLogoInTemplate=1 WHERE ID=:templateID)
			}
		}
	}
	quit
]]></Implementation>
</Method>

<Method name="isClientUsingSingleEventDomain">
<Description>
Checks if the passed in namespace is in the list of clients using Single Event Domain.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set out=0 
	
	set clientNamespace=$ZCVT($ZNSPACE,"U")
	// This is a comma seperated list of namespaces.Must start and end with a comma and no spaces anywhere.
	set clientsUsingSingleEventDomain = $LB("EVSTANDREWS","EVBANKSSADLER","EVULTIMATEEVENT","EVEQUITY","EVSCHRODERS","EVTFI","EVPMM")
	
	if ($LISTFIND(clientsUsingSingleEventDomain,clientNamespace)) {
		set out=1
	}
	if $G(^xForceStopFrameBreaker) set out=1
	
	quit out
]]></Implementation>
</Method>

<Method name="moveResponsiveStandardDesignToTop">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	&SQL(update layout.objStandardDesign set displayorder=0 where description='Responsive Standard Design')
]]></Implementation>
</Method>

<Method name="updateDefaultTemplate">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set templateID=..getTemplateIDFromInternalDescription("EF_THEME_default_design_08")
	do ##class(setup.objSetting).setParameter("themes","default theme for new events",templateID)
]]></Implementation>
</Method>

<Method name="getTemplateToUseForBackendBookings">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set eventLayoutTemplateID=##class(layout.objTemplate).getLayoutForEvent(xEventID)
	set layoutTemplateID=""
	if ##class(layout.objTemplate).isUsingEFStandardTemplate(xEventID) {
		if ##class(layout.objTemplate).isTemplateHTML5Compatible(eventLayoutTemplateID)	{
			// use responsive one if the current template is using HTML5 doc type otherwise doctype will not match the doctype the template needs
			set layoutTemplateID=##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_standard_design_08")
		} else {
			set layoutTemplateID=##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_default_design_08")
		}
	} else {
		set isPopup=1
		set layoutTemplateID=##class(layout.objTemplate).getLayoutForEvent(xEventID,isPopup)
	}
	if layoutTemplateID="" set layoutTemplateID=eventLayoutTemplateID
	quit layoutTemplateID
]]></Implementation>
</Method>

<Method name="getTemplateToUseForPopups">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set regularTemplateID=##class(layout.objTemplate).getLayoutForEvent(eventID,0)
	set popupTemplateID=##class(layout.objTemplate).getLayoutForEvent(eventID,1)

	if popupTemplateID=regularTemplateID {
		if (##class(layout.objTemplate).isTemplateGen2(regularTemplateID)) ! (##class(layout.objTemplate).isTemplateGen3(regularTemplateID)) {
			return ##class(layout.objTemplate).getIDfromIntDesc("EF_THEME_default_design_21") // this is the Gen 2 iFrame template
		} else {
			return regularTemplateID  // This is the wrong behaviour as it will show menu in popup but we don't want to change this now (as part of responsive project).
		}
	}
	return popupTemplateID
]]></Implementation>
</Method>

<Method name="areMandatoryMarkersOnTheLeftForEventID">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set out=0
	set templateID=+(##class(layout.objTemplate).getLayoutForEvent(eventID))
	if ##class(layout.methods).isThisDefaultDesign(templateID) set out=1
	return out
]]></Implementation>
</Method>

<Method name="getAllowedExtensionsForTemplateUpload">
<Description>
Returns comma delimited list of extensions</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set allowedExtensions=##class(shared.fileMethods).allowedExtensions()
	set allowedExtensions=allowedExtensions_",TTF,EOT,WOFF"   // fonts are uploaded inside template zips
	set allowedExtensions=allowedExtensions_",XML,HTML,HTM,JS"  // web page contents
	return $ZCVT(allowedExtensions,"U")
]]></Implementation>
</Method>

<Method name="isExtensionAllowedForTemplateUpload">
<ClassMethod>1</ClassMethod>
<FormalSpec>fileExtension</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ##class(shared.fileMethods).isExtensionInList(fileExtension,..getAllowedExtensionsForTemplateUpload())
]]></Implementation>
</Method>

<Method name="updateTemplateCSSFileAll">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set sqltext="SELECT ID FROM layout.objTemplate ORDER BY ID"
	do rs.Prepare(sqltext)
	do rs.Execute()
	while rs.Next() {
		set templateID=rs.Data("ID")
		
		do ..updateTemplateCSSFile(templateID)
	}
	do rs.Close()
	Kill rs
]]></Implementation>
</Method>

<Method name="updateTemplateCSSFile">
<Description>
Looks for "style.css" file to update "templateCSSFile" with</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<Implementation><![CDATA[
	&SQL(SELECT templateDirectory, originalFilename INTO :templateDirectory, :originalFilename
		FROM layout.objTemplate
		WHERE ID=:templateID)
		
	If (+SQLCODE=0) {
		if ('(##class(layout.objTemplate).isTemplateCustomMade(templateID))) {
			set objTemplate=##class(layout.objTemplate).%OpenId(templateID)
			if ($ISOBJECT(objTemplate)) {
				do objTemplate.%Reload()
				if ($ZCVT($P(originalFilename,"\",*),"L") = "index.csp") {
					set fileName=$REPLACE(originalFilename,"index.csp","style.css")
					if (##class(%Library.File).Exists(fileName)) {
						w !,"Updating templateCSSFile for templateID "_templateID_" from "_fileName_" ..."
						set styleCSSStream=##class(%Stream.FileCharacter).%New()
						set styleCSSStream.Filename=fileName
						set sc=styleCSSStream.Rewind()
						if ($$$ISERR(sc)) {
							Throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
						}
						set sc=objTemplate.templateCSSFile.Clear()
						if ($$$ISERR(sc)) {
							Throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
						}
						set sc=objTemplate.templateCSSFile.CopyFromAndSave(styleCSSStream)
						if ($$$ISERR(sc)) {
							Throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
						}
						set sc=objTemplate.%Save()
						if ($$$ISERR(sc)) {
							Throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
						}
						kill styleCSSStream
					}
				}
			}
			kill objTemplate
		}
	}
	quit
]]></Implementation>
</Method>
</Class>


<Class name="layout.objTemplate">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: layout.objTemplate.CLS/EV.52
;vc; Component: CLS.layout.objTemplate
;vc;  Location: LargeDev
;vc; Date/Time: 19-Jan-17 12:05
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>layout.objTemplate.CLS/EV.52</td><td>CLS.layout.objTemplate</td><td>LargeDev</td><td style='white-space: nowrap;'>19-Jan-17 12:05</td><td>FredG</td></tr></table>
]]></Description>
<ClassType>persistent</ClassType>
<ProcedureBlock>1</ProcedureBlock>
<Super>%Library.Persistent,shared.timeStamp</Super>
<TimeChanged>64302,43612.879912</TimeChanged>
<TimeCreated>60782,60196.270659</TimeCreated>
<Inheritance>right</Inheritance>

<Property name="accessibilityLevel">
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
<Parameter name="VALUELIST" value=",none,A,AA,AAA"/>
</Property>

<Property name="description">
<Description>
shown in drop down menu - also used as lookup so has to be unique</Description>
<Type>%String</Type>
<Required>1</Required>
<Parameter name="MAXLEN" value="200"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="internalDescription">
<Description>
used for reference in code</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="200"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Index name="descriptionIndex">
<Properties>description</Properties>
<Unique>1</Unique>
</Index>

<Property name="originalFilename">
<Type>%String</Type>
<Parameter name="MAXLEN" value="200"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="active">
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="displayOrder">
<Description>
make numeric so ordered correctly and not int so can insert stuff between items</Description>
<Type>%Numeric</Type>
<Parameter name="SCALE" value="1"/>
</Property>

<Property name="popup">
<Description>
for each template we need two templates - one for the normal layout and one for the layout when popups are used
so this indicates that this is the popup template</Description>
<Type>%Boolean</Type>
</Property>

<Property name="linkedTemplateID">
<Description>
this will be the real template</Description>
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="exampleImage">
<Description>
link to actual image file for example of layout</Description>
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="styleSource">
<Description>
Indicates whether the style is coming from the event (streamed) or from a file that is pulled in from the layout.</Description>
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
<Parameter name="VALUELIST" value=",event,template"/>
</Property>

<Property name="templateDirectory">
<Type>%String</Type>
<Parameter name="MAXLEN" value="250"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="objStandardDesign">
<Type>layout.objStandardDesign</Type>
<Cardinality>one</Cardinality>
<Inverse>objTemplates</Inverse>
<Relationship>1</Relationship>
</Property>

<Property name="layoutStructure">
<Type>%String</Type>
<Parameter name="MAXLEN" value="200"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="efLogoInTemplate">
<Type>%Boolean</Type>
</Property>

<Property name="isIframe">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="hasBootstrap">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="isUsingProweb2">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="customTemplate">
<Description>
is this a template uploaded by a customer and therefore available in the templates page to select</Description>
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="templateSourceFile">
<Description>
the template.zip file that contains all the images/css/index.html and any other files that the template allows</Description>
<Type>%Stream.GblBinCompress</Type>
</Property>

<Property name="templateCSSFile">
<Description>
to store the style.css stream in order to avoid having to get it via FTP from a web server</Description>
<Type>%Stream.GblChrCompress</Type>
</Property>

<Index name="objStandardDesignIndex">
<Properties>objStandardDesign</Properties>
</Index>

<Method name="getStandardDesignName">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT objStandardDesign->description INTO :designName FROM layout.objTemplate WHERE ID = :templateID)	
	if +SQLCODE=0 {
		if designName="Default Design" set designName="Non-responsive Standard Design" //renamed July 2016
		// commented out until release of proweb2 // if designName="Responsive Standard Design" set designName="Standard Design 1.0" //renamed Dec 2016
		return designName
	} else {
		throw ##class(shared.exceptions.generalException).%New("no such template found") 	
	}
]]></Implementation>
</Method>

<Method name="getCreationTimestamp">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT xCRstamp INTO :timestamp FROM layout.objTemplate WHERE ID = :templateID)	
	if +SQLCODE=0 {
		return timestamp // e.g. "2009-07-07 10:23:48"
	} else {
		throw ##class(shared.exceptions.generalException).%New("no such template found") 	
	}
]]></Implementation>
</Method>

<Method name="getLayoutForEvent">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%String,popup:%Boolean=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// if popup get the popup layout instead
	set templateID=""
	&SQL(SELECT layoutObjTemplate INTO :tmp FROM setup.objEvent WHERE ID=:eventID)
	if +SQLCODE=0 set templateID=tmp
	if popup	{
		&SQL(SELECT ID INTO :tmp FROM layout.objTemplate WHERE linkedTemplateID=:templateID)
		if +SQLCODE=0 set templateID=tmp
	}
	quit templateID
]]></Implementation>
</Method>

<Method name="isThisAPopupTemplate">
<Description>
gets the templateID for the popup - if there is one</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set linkedTemplateID=""
	&SQL(SELECT linkedTemplateID INTO :tmp FROM layout.objTemplate WHERE ID=:templateID)
	if +SQLCODE=0 set linkedTemplateID=tmp
	if (linkedTemplateID) {
		return 1
	} else {
		return 0
	}
]]></Implementation>
</Method>

<Method name="getPopupTemplate">
<Description>
gets the templateID for the popup - if there is one</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set popupTemplateID=""
	&SQL(SELECT ID INTO :tmp FROM layout.objTemplate WHERE linkedTemplateID=:templateID)
	if +SQLCODE=0 set popupTemplateID=tmp
	return popupTemplateID
]]></Implementation>
</Method>

<Method name="getLayoutForSurvey">
<ClassMethod>1</ClassMethod>
<FormalSpec>surveyID:%String,popup:%Boolean=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// if popup get the popup layout instead
	set templateID=""
	&SQL(SELECT layoutObjTemplate INTO :tmp FROM sc_xModules.objForm WHERE ID=:surveyID)
	if +SQLCODE=0 set templateID=tmp
	if popup	{
		&SQL(SELECT ID INTO :tmp FROM layout.objTemplate WHERE linkedTemplateID=:templateID)
		if +SQLCODE=0 set templateID=tmp
	}
	quit templateID
]]></Implementation>
</Method>

<Method name="getIDfromDesc">
<ClassMethod>1</ClassMethod>
<FormalSpec>description:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set templateID=""
	&SQL(SELECT ID INTO :tmp FROM layout.objTemplate WHERE (%SQLUPPER(description) = %SQLUPPER(:description)) AND (active=1))
	if +SQLCODE=0 set templateID=tmp
	quit templateID
]]></Implementation>
</Method>

<Method name="getIDfromIntDesc">
<ClassMethod>1</ClassMethod>
<FormalSpec>internalDescription:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set templateID=""
	&SQL(SELECT ID INTO :tmp FROM layout.objTemplate WHERE (%SQLUPPER(internalDescription) = %SQLUPPER(:internalDescription)) AND (active=1))
	if +SQLCODE=0 set templateID=tmp
	quit templateID
]]></Implementation>
</Method>

<Method name="getStyleSource">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data=""
	&SQL(SELECT styleSource INTO :tmp FROM layout.objTemplate WHERE ID=:templateID)
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="getPath">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#define tPath As %String
	set tPath=""
	&SQL(SELECT  templateDirectory INTO :tmp FROM layout.objTemplate WHERE ID=:templateID)
	if +SQLCODE=0 {
		set tPath = tmp
	}
	quit tPath
]]></Implementation>
</Method>

<Method name="getAccessibility">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data=""
	&SQL(SELECT accessibilityLevel INTO :tmp FROM layout.objTemplate WHERE ID=:templateID)
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="isEFLogoInTemplate">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data=""
	&SQL(SELECT efLogoInTemplate INTO :tmp FROM layout.objTemplate WHERE ID=:templateID)
	if +SQLCODE=0 set data=tmp
	quit +data
]]></Implementation>
</Method>

<Method name="getIntDesc">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set desc=""
	&SQL(SELECT internalDescription INTO :tmp FROM layout.objTemplate WHERE ID=:templateID)
	if +SQLCODE=0 set desc=tmp
	quit desc
]]></Implementation>
</Method>

<Method name="getDesc">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set desc=""
	&SQL(SELECT description INTO :tmp FROM layout.objTemplate WHERE ID=:templateID)
	if +SQLCODE=0 set desc=tmp
	quit desc
]]></Implementation>
</Method>

<Method name="deleteTemplate">
<ClassMethod>1</ClassMethod>
<FormalSpec>description:%String,templateID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// ** CAREFUL - THIS DOES NOT CHECK IF THIS TEMPLATE IS IN USE BY AN EVENT
	
	if $G(description)'="" set templateID=..getIDfromDesc(description)
	// find the popup template if there is one
	set linkedTemplateID=""
	&SQL(SELECT ID INTO :tmp FROM layout.objTemplate WHERE linkedTemplateID=:templateID )
	if +SQLCODE=0 set linkedTemplateID=tmp
	if linkedTemplateID	{
		&SQL(DELETE FROM layout.objSection WHERE objTemplate=:linkedTemplateID)
		&SQL(DELETE FROM layout.objTemplate WHERE ID=:linkedTemplateID)
	}	
	&SQL(DELETE FROM layout.objSection WHERE objTemplate=:templateID)
	&SQL(DELETE FROM layout.objTemplate WHERE ID=:templateID)
	quit 1
]]></Implementation>
</Method>

<Method name="loadTemplateUsingProxy">
<ClassMethod>1</ClassMethod>
<FormalSpec>t:%ZEN.proxyObject</FormalSpec>
<Implementation><![CDATA[
	#define active 1			
	#define replace 1
	#define notPopup 0
	write " result=",##class(layout.objTemplate).loadTemplate(t.description,t.internalName,$$$active,,t.indexFilename,$$$replace,$$$notPopup,t.imageFile,t.accessibilityLevel,t.styleSource,t.templateDirectory,t.isLogoIncudedInTemplate,t.layoutStructure,t.designName,t.isIframe,t.isUsingBootstrap, , t.isUsingProweb2)
]]></Implementation>
</Method>

<Method name="loadTemplate">
<ClassMethod>1</ClassMethod>
<FormalSpec>description:%String,internalDescription:%String,active:%String,displayOrder:%String,filename:%String,replace:%Boolean=0,popup:%Boolean=0,imgFile:%String,level,source,directory,efLogoInTemplate=0,layoutStructure="",standardDesign="",isIframe=0,hasBootstrap=0,customTemplate=0,isUsingProweb2=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set replace=+$G(replace)
	set popup=+$G(popup)
	set customTemplate=+customTemplate
	set inFile=##class(%FileCharacterStream).%New()
	if $G(filename)="" quit 0
	set inFile.Filename=filename
	if inFile.Size<10 quit "0~Could not find file or too small, check there is an index.html file in the zip file (if this is a new template)."
	if $G(imgFile)="" set imgFile=""
		
	set linkedTemplateID=""
	if popup {
		// get the original
		set origIntDesc=$P(internalDescription,"_popup",1)
		set linkedTemplateID=..getIDfromIntDesc(origIntDesc)
	}
	set templateID=""
	if replace set templateID=..getIDfromIntDesc(internalDescription)
	if replace,templateID	{
		// get the id of the template
		set templateID=..getIDfromIntDesc(internalDescription)
		if templateID {
			&SQL(DELETE FROM layout.objSection WHERE objTemplate=:templateID)
			set objTemplate=..%OpenId(templateID)
		} else {
			quit "0~Template not found"
		}
	} else {
		set objTemplate=..%New()
		set objTemplate.originalFilename=filename
		set objTemplate.description=description
		set objTemplate.isIframe=+isIframe
		set objTemplate.hasBootstrap=+hasBootstrap	
		set objTemplate.isUsingProweb2 = +isUsingProweb2
		set ok=objTemplate.%Save()
		if 'ok quit "0~Error creating template - "_ok_" - description='"_description_"'"
		set templateID=objTemplate.%Id()
	}
	set displayOrder=$G(displayOrder)
	if displayOrder="" {
		// get last displayorder if we didn't pass one in  
		set displayOrder=1
		&SQL(SELECT displayOrder INTO :tmp FROM layout.objTemplate ORDER BY displayOrder DESC)
		if +SQLCODE=0 set displayOrder=tmp+1
	}
	
	// get the standardDesignID from the description
	set standardDesignID=""
	if standardDesign'="" {
		// passed in
		&SQL(SELECT ID INTO :tmp FROM layout.objStandardDesign WHERE description=:standardDesign)
		if +SQLCODE=0 set standardDesignID=tmp	
	} else {
		// get it from existing template	
		&SQL(SELECT objStandardDesign INTO :standardDesignID FROM layout.objTemplate WHERE ID = :templateID)
	}
	
	// get the exsting layoutstructure if not passed in
	if layoutStructure="" {
		&SQL(SELECT layoutStructure INTO :layoutStructure FROM layout.objTemplate WHERE ID = :templateID)
	}
	
	&SQL(
		UPDATE layout.objTemplate 
		SET description=:description, internalDescription=:internalDescription, active=:active, displayOrder=:displayOrder, linkedTemplateID=:linkedTemplateID, popup=:popup,exampleImage=:imgFile, accessibilityLevel=:level,
		styleSource=:source, templateDirectory=:directory,efLogoInTemplate=:efLogoInTemplate,layoutStructure=:layoutStructure,objStandardDesign=:standardDesignID, originalFilename=:filename,isIframe=:isIframe,hasBootstrap=:hasBootstrap,customTemplate=:customTemplate
		WHERE ID=:templateID
		)
	
	do parseBlock(inFile,.positionAr)
	// now we have an array like this:
	// positionAr(43)="[[ef_banner]]"
	// positionAr(44)="[[ef_secondary_banner]]"
	// positionAr(115)="[[ef_menu]]"
	// positionAr(157)="[[ef_main_header]]" 
	// positionAr(179)="[[ef_main_content]]"
	// positionAr(202)="[[ef_main_buttons]]"
	// positionAr(254)="[[ef_footer]]"
	// have to catch the last section after the last tag so add one entry
	set positionAr(inFile.Size)=""
	
	// now I want to extract each block between the bits and store in order that it gets written
	set pos="",lastPos=0,displayOrder=100,lastTag=""
	for  {
		set pos=$O(positionAr(pos))
		if pos="" quit
		
		//set ^xJAW("layout",$I(^xJAW("layout")))=lastPos_"|"_pos_"|"_lastTag
		// have to do object insert as streams involved
		set objSection=##class(layout.objSection).%New()
		set objSection.objTemplate=objTemplate
		set objSection.before=lastTag
		set objSection.after=positionAr(pos)
		set objSection.displayOrder=displayOrder
		set objSection.type="BODY"
		
		// copy the stream section
		do inFile.Rewind()
		for curPos=0:1:pos	{
			set byte=inFile.Read(1)
			if (curPos>=lastPos)&(curPos<pos) do objSection.htmlStream.Write(byte)
		}
		set ok=objSection.%Save()
		kill objSection
		// set vars ready for next loop
		set displayOrder=displayOrder+100
		set lastPos=pos+$L(positionAr(pos))  // we don't want to include the [[tags]]
		set lastTag=positionAr(pos)
		
	}
	
	quit templateID
	
parseBlock(htmlStream,positionAr)	; receives the method code and parses
	;
	set secondBits=0  // assume there are none - as soon as we get one, set this to 1
	set bits("[[ef_header]]")=""
	set bits("[[ef_banner]]")=""
	set bits("[[ef_secondary_banner]]")=""
	set bits("[[ef_menu]]")=""
	set bits("[[ef_main_progress]]")=""
	set bits("[[ef_main_header]]")=""
	set bits("[[ef_main_content]]")=""
	set bits("[[ef_main_buttons]]")=""
	set bits("[[ef_right]]")=""
	set bits("[[ef_footer]]")=""
	set bits("[[ef_func_menuwidth]]")=""    // left hand page/menu width
	set bits("[[ef_func_rightwidth]]")=""   // right hand page width
	set bits("[[ef_func_bannerheight]]")=""   // prob. not used in future
	set bits("[[ef_func_maintotal]]")=""    // do not use - will be replaced in the future
	set bits("[[ef_func_mainwidth]]")=""    // the centre main content area
	set bits("[[ef_func_totalwidth]]")=""   // the sum of left + centre + right + (mainpadding x 2)
	set bits("[[ef_func_mainpadding]]")=""  // the value entered for "padding:npx; " for the centre content area - so it applies on left and right
	set bits("[[ef_logo]]")=""  // gets replaced with the ef logo html code
	
	set bit=""
	for  {
		set bit=$O(bits(bit))
		if bit="" quit
		// store the places for this delimiter
		do ##class(shared.streamFunctions).getDelimPositions(.htmlStream,bit,.positionAr)
	}
	quit
]]></Implementation>
</Method>

<Method name="writeContents">
<Description>
writes out the htmlStream to current device</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>sectionID:%String</FormalSpec>
<Implementation><![CDATA[
	set objSection=##class(layout.objSection).%OpenId(sectionID)
	while 'objSection.htmlStream.AtEnd	{
		write objSection.htmlStream.Read(30000)
	}
]]></Implementation>
</Method>

<Method name="outputTemplate">
<Description>
used to output contents to terminal</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>description:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// get the id of the template
	set templateID=..getIDfromDesc(description)
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set sqltext="SELECT * FROM layout.objSection WHERE (objTemplate=?) ORDER BY displayOrder "
	do rs.Prepare(sqltext)
	do rs.Execute(templateID)
	while rs.Next() {
		set sectionID=rs.Data("ID")
		do ..writeContents(sectionID)
	}
]]></Implementation>
</Method>

<Method name="writeBit">
<Description>
outputs each section of code doing the banner, menu and footer when needed
############ we really need to refactor the 'writeBit' method to be an instance method with procedureblock ############</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>from:%String,to:%String</FormalSpec>
<ProcedureBlock>0</ProcedureBlock>
<Implementation><![CDATA[
	// 	 set bits("[[ef_banner]]")=""
	// 	 set bits("[[ef_secondary_banner]]")=""
	// 	 set bits("[[ef_menu]]")=""
	// 	 set bits("[[ef_main_header]]")=""
	// 	 set bits("[[ef_main_header_logo]]")=""
	// 	 set bits("[[ef_main_content]]")=""
	// 	 set bits("[[ef_main_buttons]]")=""
	// 	 set bits("[[ef_footer]]")=""
	//
	new contextData,okToWrite,rs,sqltext,menuPageID,homePageID,bannerPageID,secondaryBannerPageID,layoutTemplateID,sectionID,before,after,curPageName,isSurvey,surveyID,curPageID,externalLoginPage,standardDesingID,isUsingProweb2
	set xEventID=$G(%session.Data("eventsforce","backend","xEventID"))
	
	
	
	if from["{{" set from=$TR(from,"{","[")
	if from["}}" set from=$TR(from,"}","]")
	if to["{{" set to=$TR(to,"{","[")
	if to["}}" set to=$TR(to,"}","]")
	
	// don't write out the bits when in edit mode
	set backendEdit=0
	if %session.Get("mode")="edit" set backendEdit=1
	set backendPreview=0
	if %request.Get("hideButtons") set backendPreview=1
	
	// use parameters to stop showing menu and banner in some places (pop ups)
	set layoutReq=$ZCVT(%request.Get("layout"),"U")  // = "nomenunobanner" or just one
	set doNotShowMenu=+(layoutReq["NOMENU")
	set doNotShowBanner=+(layoutReq["NOBANNER")
	set doNotShowSecondaryBanner=+(layoutReq["NOSECONDARYBANNER")
	set isPopup=+%request.Get("popup")
	// Set up common variables
	if backendEdit!backendPreview	{
		// force use of popup layout
		set isPopup=1
		set frontBack="backend"
		set xLangID=$G(%session.Data("eventsforce","backend","xLangID"))
		set xLanguage=$G(%session.Data("eventsforce","backend","xLanguage"))
		
		set xEventDescription=$G(%session.Data("eventsforce","backend","xEventDescription"))
	
		set xDateFormat=$G(%session.Data("eventsforce","backend","xDateFormat"))
		set xTimeFormat=##class(setup.objEventSetting).getParameter("system","time format",xEventID)
		if xDateFormat="" set xDateFormat=##class(setup.objSetting).getParameter("system","defaultDateFormat")
		set xControllerID=""
		if xEventID	{
			set xControllerID=##class(setup.objEvent).getControllerID(xEventID)
			set xDateFormat=##class(setup.objEvent).getDateFormat(xEventID)
		}
	} else {
		set frontBack="frontend"
		set xLangID=$G(%session.Data("eventsforce","frontend","xLangID"))
		set xLanguage=$G(%session.Data("eventsforce","frontend","xLanguage"))
		set xEventID=$G(%session.Data("eventsforce","frontend","xEventID")) 
		set xEventDescription=$G(%session.Data("eventsforce","frontend","xEventDescription"))
	
		set xDateFormat=$G(%session.Data("eventsforce","frontend","xDateFormat"))
		set xTimeFormat=##class(setup.objEventSetting).getParameter("system","time format",xEventID)
		if xDateFormat="" set xDateFormat=##class(setup.objSetting).getParameter("system","defaultDateFormat")
		set xControllerID=""
		if xEventID	{
			set xControllerID=##class(setup.objEvent).getControllerID(xEventID)
			set xDateFormat=##class(setup.objEvent).getDateFormat(xEventID)
		}
		set %session.Data("eventsforce","frontend","xDateFormat")=xDateFormat
	}
	
	set isSurvey=0
	if '$g(%session.Data("eventsforce","frontend","xEventID")) {
		set surveyID=##class(shared.pageMethods).getSurveyID()
		if surveyID {
			set isSurvey=1
			set xEventID=""
		}
	}
	set externalLoginPage=0
	set curPageID=##class(shared.pageMethods).getPageID()
	if xEventID {
		if ##class(setup.objEventSetting).getParameter("website","externalEventLoginPageID",xEventID)=curPageID {
			set doNotShowMenu=1
			set externalLoginPage=1
		}
	}
	
	// determine which layout is in use
	// inpage editing of pagees
	if $g(isSurvey) {
		if %session.Get("mode")="edit",$G(%session.Data("inSitePageEditing")) {
			set layoutTemplateID=..getLayoutForSurvey(surveyID,0) // make editing see all parts of the page
		} else {
			set layoutTemplateID=..getLayoutForSurvey(surveyID,isPopup)	
		}
	} else {
		if %session.Get("mode")="edit",$G(%session.Data("inSitePageEditing")) {
			set layoutTemplateID=..getLayoutForEvent(xEventID,0) // make editing see all parts of the page
		} else {
			set layoutTemplateID=..getLayoutForEvent(xEventID,isPopup)	
		}
	}

	// switch to use a different template layout if backend booking as the menu and banner will not be shown so we want to try and show one that doesn't have big gaps
	if ((##class(eCom.tempPurchase).isBackendBooking(%session.SessionId))&('isSurvey)) {
		set layoutTemplateID=##class(layout.methods).getTemplateToUseForBackendBookings(xEventID)
	}
	
	if %request.Get("supressBannerAndMenu") {
		set layoutTemplateID=##class(layout.methods).getTemplateToUseForPopups(xEventID)
	}
	
	if ..isUsingEFStandardTemplate(xEventID)&&externalLoginPage {
		// Switch the layout to the horizontal menu version
		&SQL(SELECT layoutStructure,objStandardDesign INTO :tmp,:tmp2 FROM layout.objTemplate WHERE ID = :layoutTemplateID)
		if +SQLCODE=0 {
			set layoutStructure=tmp
			set standardDesignID=tmp2
			if $p(layoutStructure,",",1)="Vertical Menu" {
				set $p(layoutStructure,",",1)="Horizontal Menu"
				&SQL(SELECT ID INTO :tmp
					FROM layout.objTemplate
					WHERE objStandardDesign = :standardDesignID
					AND layoutStructure = :layoutStructure
				)
				if +SQLCODE=0 {
					set layoutTemplateID=tmp
				}
			}
		}
	}

	// check the to and from values to see if they are in the template
	// use previous value stored if we have one
	if $L($G(layoutLastFrom)) set from=layoutLastFrom
	set fromIsInTemplate=0
	if from=""	{
		&SQL(SELECT ID FROM layout.objSection WHERE (objTemplate=:layoutTemplateID) AND (after IS NULL) )
	} else {
		&SQL(SELECT ID FROM layout.objSection WHERE (objTemplate=:layoutTemplateID) AND (%SQLUPPER(after)=%SQLUPPER(:from)) )
	}
	if +SQLCODE=0 set fromIsInTemplate=1
	set toIsInTemplate=0
	if to=""	{
		&SQL(SELECT ID FROM layout.objSection WHERE (objTemplate=:layoutTemplateID) AND (after IS NULL) )
	} else {
		&SQL(SELECT ID FROM layout.objSection WHERE (objTemplate=:layoutTemplateID) AND (%SQLUPPER(after)=%SQLUPPER(:to)) )
	}
	if +SQLCODE=0 set toIsInTemplate=1
	if 'fromIsInTemplate {
		// do I need to do anything here? no because the $G(layoutLastFrom) above will use the correct one.
	}
	
	set quitNow=0
	if toIsInTemplate {
		// reset the last from var
		set layoutLastFrom=""
	} else {
		// don't know when to stop so store the "from" and quit to be used in next call
		set layoutLastFrom=from
		set quitNow=1
	}
	if quitNow quit	
	set isUsingProweb2 = 0
	if (..isTemplateUsingProweb2(layoutTemplateID)) && (##class(sc.objTemplate).isProweb2ImplementedForPageName(%request.PageName)) { 
		set isUsingProweb2 = 1
		set pageControllerID = $Get(%session.Data("mvcHandler","pageControllerID")) 
		set pageController = ##class(EF.pageController.proweb.page).open(pageControllerID)
		if '$IsObject(pageController) {
			throw ##class(shared.exceptions.generalSQLException).%New("Failed to open pageController with ID = '"_pageControllerID_"'")
		}
	}
	
	// pick up the preferred language if they have clicked on a flag or we are coming in edit mode
	if $G(%session.Data("eventsforce","frontend","xPrefLangID")) set xLangID=%session.Data("eventsforce","frontend","xPrefLangID")
	// get the banner and menu
	set (menuPageID,homePageID,bannerPageID)=""
	&SQL(SELECT menuPageID,homePageID,bannerPageID INTO :tmp,:tmp2,:tmp3 FROM setup.objEventDetails WHERE (objEvent = :xEventID) AND (objLanguage = :xLangID) )	
	if +SQLCODE=0 set menuPageID=tmp,homePageID=tmp2,bannerPageID=tmp3
	set desciptionModifier=""
	if xLangID'=1 set desciptionModifier=" - "_##class(shared.objLanguage).getLanguageDesc(xLangID)	
	set footerPageID=##class(setup.objEventSetting).getParameter("mainpages","footerPageID"_desciptionModifier,xEventID)
	set rightPageID=##class(setup.objEventSetting).getParameter("mainpages","rightPageID"_desciptionModifier,xEventID)
	set secondaryBannerPageID=##class(setup.objEventSetting).getParameter("mainpages","secondary banner pageID"_desciptionModifier,xEventID)
	set rsLT=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set sqltext="SELECT * FROM layout.objSection WHERE (objTemplate=?) ORDER BY displayOrder "
	do rsLT.Prepare(sqltext)
	do rsLT.Execute(layoutTemplateID)
	set okToWrite=0
	
	set %session.Data("eventsforce","frontend","layoutTemplateID")=layoutTemplateID   // set so we can pick up from frontendStyles.csp to be consistent with the template override code in this page
	
	while rsLT.Next() {
		set sectionID=rsLT.Data("ID")
		set before=rsLT.Data("before"),after=rsLT.Data("after")
		if from=before set okToWrite=1   // start writing
		if to=before set okToWrite=0   // stop writing if the item we've got to is the one we want to stop at
		if okToWrite	{
			if before="" {
				if isUsingProweb2 { 
					do ##class(layout.cssDefaultMethods).outputComponentCSS()
					
					&html<
						<!-- ====== Default generation 4 frontend base styles ============= -->
						<link rel="stylesheet" href="../../media/stylesheets/frontend/gen4/ef-website-gen4-base-styles.css" type="text/css" />
					>
					
					if ##class(layout.methods).canUseWebsiteColorsForEvent(xEventID) {
						do ##class(layout.cssOverrideMethods).outputWebsiteAppearanceCSS(xEventID)
					}
					
				} else {
					do ##class(layout.cssDefaultMethods).outputDefaultCSS(xEventID,layoutTemplateID)
				}
			}
			if before="[[ef_logo]]" {
				do ##class(EF.ui.templateComponents.efLogo).outputLogoHTMLfromTemplateTag(xEventID)
			}
			if before="[[ef_func_menuwidth]]" {
				set EFcols=##class(setup.objEventSetting).getParameter("frameset","side menu cols",xEventID)
				if EFcols="" set EFcols=##class(setup.objSetting).getParameter("frameset","side menu cols")
				if EFcols="" set EFcols=170 
				if ##class(eCom.tempPurchase).isBackendBooking(%session.SessionId) set EFcols=0
				if isSurvey set EFcols=0
				if doNotShowMenu set EFcols=0
				w +EFcols
			}
			if before="[[ef_func_rightwidth]]" {
				set EFcols=##class(setup.objEventSetting).getParameter("frameset","right width",xEventID)
				if EFcols="" set EFcols=##class(setup.objSetting).getParameter("frameset","right width")
				if EFcols="" set EFcols=210
				if isSurvey set EFcols=0
				if ##class(eCom.tempPurchase).isBackendBooking(%session.SessionId) set EFcols=0
				w +EFcols
			}
			if before="[[ef_func_bannerheight]]" {
				set EFrows=##class(setup.objEventSetting).getParameter("frameset","side menu rows",xEventID)
				if EFrows="" set EFrows=##class(setup.objSetting).getParameter("frameset","side menu rows")
				if EFrows="" set EFrows=100
				if ##class(eCom.tempPurchase).isBackendBooking(%session.SessionId) set EFrows=0
				if isSurvey set EFrows=0
				w +EFrows
			}
			if before="[[ef_func_mainwidth]]" {
				set EFmainwidth=##class(setup.objEventSetting).getParameter("frameset","main width",xEventID)
				if EFmainwidth="" set EFmainwidth=##class(setup.objSetting).getParameter("frameset","main width")
				if EFmainwidth="" set EFmainwidth=615
				w +EFmainwidth
			}
			if before="[[ef_func_mainpadding]]" {
				set EFmainpadding=##class(setup.objEventSetting).getParameter("frameset","main padding",xEventID)
				if EFmainpadding="" set EFmainpadding=##class(setup.objSetting).getParameter("frameset","main padding")
				if EFmainpadding="" set EFmainpadding=10
				w +EFmainpadding
			}
			if before="[[ef_func_maintotal]]" {  // older
				set EFcols=##class(setup.objEventSetting).getParameter("frameset","side menu cols",xEventID)
				if EFcols="" set EFcols=##class(setup.objSetting).getParameter("frameset","side menu cols")
				if EFcols="" set EFcols=170 
				if ##class(eCom.tempPurchase).isBackendBooking(%session.SessionId) set EFcols=0
				if isSurvey set EFcols=0
				if doNotShowMenu set EFcols=0
				
				set EFmainwidth=##class(setup.objEventSetting).getParameter("frameset","main width",xEventID)
				if EFmainwidth="" set EFmainwidth=##class(setup.objSetting).getParameter("frameset","main width")
				if EFmainwidth="" set EFmainwidth=615
				
				set EFmenumainspacing=##class(setup.objEventSetting).getParameter("frameset","menu main spacing",xEventID)
				if EFmenumainspacing="" set EFmenumainspacing=##class(setup.objSetting).getParameter("frameset","main margin")
				if EFmenumainspacing="" set EFmenumainspacing=35
				if ##class(eCom.tempPurchase).isBackendBooking(%session.SessionId) set EFmenumainspacing=0
				if isSurvey set EFmenumainspacing=0
				if doNotShowMenu set EFmenumainspacing=0
				w EFcols+EFmainwidth+EFmenumainspacing
			}
			if before="[[ef_func_totalwidth]]" {  // newer
				set EFleft=##class(setup.objEventSetting).getParameter("frameset","side menu cols",xEventID)
				if EFleft="" set EFleft=##class(setup.objSetting).getParameter("frameset","side menu cols")
				if EFleft="" set EFleft=170 
				if ##class(eCom.tempPurchase).isBackendBooking(%session.SessionId) set EFleft=0
				if isSurvey set EFleft=0
				if doNotShowMenu set EFleft=0
				
				set EFmainwidth=##class(setup.objEventSetting).getParameter("frameset","main width",xEventID)
				if EFmainwidth="" set EFmainwidth=##class(setup.objSetting).getParameter("frameset","main width")
				if EFmainwidth="" set EFmainwidth=615
				
				set EFright=##class(setup.objEventSetting).getParameter("frameset","right width",xEventID)
				if EFright="" set EFright=##class(setup.objSetting).getParameter("frameset","right width")
				if EFright="" set EFright=210
				if ##class(eCom.tempPurchase).isBackendBooking(%session.SessionId) set EFright=0
				//if EFright set EFleft=0   // JAW causes incorrect total in frontend, spoke to Adrian, not sure why added yet. Will fix now. PIV33413453
				set EFmainpadding=##class(setup.objEventSetting).getParameter("frameset","main padding",xEventID)
				if EFmainpadding="" set EFmainpadding=##class(setup.objSetting).getParameter("frameset","main padding")
				if EFmainpadding="" set EFmainpadding=10
				if ##class(eCom.tempPurchase).isBackendBooking(%session.SessionId) set EFmainpadding=0
				w EFleft+EFmainwidth+EFright+(EFmainpadding*2)+15 // allow a little extra (the +4) for weird padding and borders
			}
			if before="[[ef_banner]]",'##class(eCom.tempPurchase).isBackendBooking(%session.SessionId),'isSurvey {
				//do banner
				if isUsingProweb2 { 
					set parentListElement = pageController.getElementByIdentifier("banner page")
					write !,"<div class=""ef-banner-section"">"
					do parentListElement.renderElements()
					w !,"</div>"
						
				} else {
					// store current pageid before we insert another one
					set curPageID=##class(shared.pageMethods).getPageID()
					set currentIsCOD=$G(isCOD) kill isCOD // 'new' the isCOD variable that controls if we can add questions or not
					set currentIsAward=$G(isAward) kill isAward
					set currentIsAbstract=$G(isAbstract) kill isAbstract
					set currentIsAbsPerson=$G(isAbsPerson) kill isAbsPerson
					set currentIsHotel=$G(isHotel) kill isHotel
					set currentIsForm=$G(isForm) kill isForm
					set currentIsxtSurvey=$G(isxtSurvey) kill isxtSurvey
					
					set pageID=bannerPageID
					set %session.Data("pageID")=pageID
					//  inpage editing of pages
					if backendEdit,'$G(%session.Data("inSitePageEditing"))	{
						write !,"<p>banner area</p>"
					} else {
						if doNotShowBanner {
							// do nothing
						} else {
							do ##class(cspRealEV.frontend.reg.tbanner).OnPageProwebSection()
						}
					}
					set %session.Data("pageID")=curPageID
					set pageID=curPageID
					set isCOD=currentIsCOD
					set isAward=currentIsAward
					set isAbstract=currentIsAbstract
					set isAbsPerson=currentIsAbsPerson
					set isHotel=currentIsHotel
					set isForm=currentIsForm
					set isxtSurvey=currentIsxtSurvey
				}
			}
			if before="[[ef_secondary_banner]]",'##class(eCom.tempPurchase).isBackendBooking(%session.SessionId),'isSurvey {
				// do secondary banner
				// store current pageid before we insert another one
				set curPageID=##class(shared.pageMethods).getPageID()
				set currentIsCOD=$G(isCOD) kill isCOD // 'new' the isCOD variable that controls if we can add questions or not
				set currentIsAward=$G(isAward) kill isAward
				set currentIsAbstract=$G(isAbstract) kill isAbstract
				set currentIsAbsPerson=$G(isAbsPerson) kill isAbsPerson
				set currentIsHotel=$G(isHotel) kill isHotel
				set currentIsForm=$G(isForm) kill isForm
				set currentIsxtSurvey=$G(isxtSurvey) kill isxtSurvey
				
				set pageID=secondaryBannerPageID
				set %session.Data("pageID")=pageID
				//  inpage editing of pages
				if backendEdit,'$G(%session.Data("inSitePageEditing"))	{
					write !,"<p>secondary banner area</p>"
				} else {
					if doNotShowSecondaryBanner {
						// do nothing
					} else {
						do ##class(cspRealEV.frontend.reg.tsecondarybanner).OnPageProwebSection()
					}
				}
				set %session.Data("pageID")=curPageID
				set pageID=curPageID
				set isCOD=currentIsCOD
				set isAward=currentIsAward
				set isAbstract=currentIsAbstract
				set isAbsPerson=currentIsAbsPerson
				set isHotel=currentIsHotel
				set isForm=currentIsForm
				set isxtSurvey=currentIsxtSurvey
			}
			
			if before="[[ef_menu]]",'##class(eCom.tempPurchase).isBackendBooking(%session.SessionId),'isSurvey {
				//do menu
				if isUsingProweb2 { 
					set parentListElement = pageController.getElementByIdentifier("navigation bar page")
					write !,"<div class=""ef-navigation-section"">"
					do parentListElement.renderElements()
					write !,"</div>"

					write !,"<div class=""ef-social-media-section"">"
					set %request.Data("option",1) = "menu"
					do ##class(cspRealEV.frontend.reg.socialmediabuttons).OnPage()
					write !,"</div>"						
				} else {
					// store current pageid before we insert another one
					set curPageID=##class(shared.pageMethods).getPageID()
					set currentIsCOD=$G(isCOD) kill isCOD // 'new' the isCOD variable that controls if we can add questions or not
					set currentIsAward=$G(isAward) kill isAward
					set currentIsAbstract=$G(isAbstract) kill isAbstract
					set currentIsAbsPerson=$G(isAbsPerson) kill isAbsPerson
					set currentIsHotel=$G(isHotel) kill isHotel
					set currentIsForm=$G(isForm) kill isForm
					set currentIsxtSurvey=$G(isxtSurvey) kill isxtSurvey

					// load the menu page
					set pageID=menuPageID
					set %session.Data("pageID")=pageID
					// inpage editing of pages
					if backendEdit,'$G(%session.Data("inSitePageEditing"))	{
						write !,"<p>menu area</p>"
					} else {
						if doNotShowMenu {
							// do nothing
						} else {
							do ##class(cspRealEV.frontend.reg.tmenu).OnPageProwebSection()
						}
					}
					set %session.Data("pageID")=curPageID
					set pageID=curPageID
					set isCOD=currentIsCOD
					set isAward=currentIsAward
					set isAbstract=currentIsAbstract
					set isAbsPerson=currentIsAbsPerson
					set isHotel=currentIsHotel
					set isForm=currentIsForm
					set isxtSurvey=currentIsxtSurvey
				}
			}
			if before="[[ef_right]]",'##class(eCom.tempPurchase).isBackendBooking(%session.SessionId),'isSurvey {
				if isUsingProweb2 { 
					set parentListElement = pageController.getElementByIdentifier("sponsor page")
					write !,"<div class=""ef-sponsors-section"">"
					do parentListElement.renderElements()
					write !,"</div>"
						
				} else {
					// store current pageid before we insert another one
					set curPageID=##class(shared.pageMethods).getPageID()
					set currentIsCOD=$G(isCOD) kill isCOD // 'new' the isCOD variable that controls if we can add questions or not
					set currentIsAward=$G(isAward) kill isAward
					set currentIsAbstract=$G(isAbstract) kill isAbstract
					set currentIsAbsPerson=$G(isAbsPerson) kill isAbsPerson
					set currentIsHotel=$G(isHotel) kill isHotel
					set currentIsForm=$G(isForm) kill isForm
					set currentIsxtSurvey=$G(isxtSurvey) kill isxtSurvey
					// load the menu page
					set pageID=rightPageID
					set %session.Data("pageID")=pageID
					// inpage editing of pages
					if backendEdit,'$G(%session.Data("inSitePageEditing"))	{
						write !,"<p>right hand area</p>"
					} else {
						do ##class(cspRealEV.frontend.reg.tblank).OnPageProwebSection()
					}
					set %session.Data("pageID")=curPageID
					set pageID=curPageID
					set isCOD=currentIsCOD
					set isAward=currentIsAward
					set isAbstract=currentIsAbstract
					set isAbsPerson=currentIsAbsPerson
					set isHotel=currentIsHotel
					set isForm=currentIsForm
					set isxtSurvey=currentIsxtSurvey
				}
			}
			if before="[[ef_footer]]",'##class(eCom.tempPurchase).isBackendBooking(%session.SessionId),'isSurvey {
				//do footer
				if isUsingProweb2 { 
					set parentListElement = pageController.getElementByIdentifier("footer page")
					write !,"<div class=""ef-footer-section"">"
					do parentListElement.renderElements()
					write !,"</div>"
					
					write !,"<div class=""ef-social-media-section"">"
					set %request.Data("option",1) = "footer"
					do ##class(cspRealEV.frontend.reg.socialmediabuttons).OnPage()
					write !,"</div>"
						
				} else {
					// store current pageid before we insert another one
					set curPageID=##class(shared.pageMethods).getPageID()
					set currentIsCOD=$G(isCOD) kill isCOD // 'new' the isCOD variable that controls if we can add questions or not
					set currentIsAward=$G(isAward) kill isAward
					set currentIsAbstract=$G(isAbstract) kill isAbstract
					set currentIsAbsPerson=$G(isAbsPerson) kill isAbsPerson
					set currentIsHotel=$G(isHotel) kill isHotel
					set currentIsForm=$G(isForm) kill isForm
					set currentIsxtSurvey=$G(isxtSurvey) kill isxtSurvey
					// load the footer page
					set pageID=footerPageID
					set %session.Data("pageID")=pageID
					// Fred april 2010 - inpage editing of pages
					if backendEdit,'$G(%session.Data("inSitePageEditing"))	{
						write !,"<p>footer area</p>"
					} else {
						do ##class(cspRealEV.frontend.reg.tfooter).OnPageProwebSection()
					}
					set %session.Data("pageID")=curPageID
					set pageID=curPageID
					set isCOD=currentIsCOD
					set isAward=currentIsAward
					set isAbstract=currentIsAbstract
					set isAbsPerson=currentIsAbsPerson
					set isHotel=currentIsHotel
					set isForm=currentIsForm
					set isxtSurvey=currentIsxtSurvey
				}
			}
			
			
			do ..writeContents(sectionID)
			
			// do eventsforce powered by - add this with a parameter
			if after=""	{
				Do ##class(shared.pCSP).Include("../../frontend/reg/frontendBottom.csp")
			}
		}
	}
	quit
]]></Implementation>
</Method>

<Method name="reloadAll">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	do ##class(layout.methods).reloadAll()	
	quit
]]></Implementation>
</Method>

<Method name="reloadSingle">
<ClassMethod>1</ClassMethod>
<FormalSpec>page:%String</FormalSpec>
<Implementation><![CDATA[
	do ##class(layout.methods).reloadSingle(page)	
	quit
]]></Implementation>
</Method>

<Method name="isUsingEFStandardTemplate">
<Description>
returns true if they are using  any of the eventsforce designs (MTLs) but NOT "Blank Design" (aka Leagacy template)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set out="0|nothing found"
	&SQL(SELECT layoutObjTemplate INTO :tmp FROM setup.objEvent WHERE ID =:xEventID)
	if +SQLCODE=0 {
		set activeTemplate=tmp
		&SQL(SELECT objStandardDesign INTO :tmp FROM layout.objTemplate WHERE (ID = :activeTemplate) AND (objStandardDesign->description <> 'Blank Design'))
		if +SQLCODE=0 {
			if tmp'="" {
				set out=1
			} else {
				set out=0	
			}
		}
	} else {
		set out="0|no template found"				
	}
	quit out
]]></Implementation>
</Method>

<Method name="isUsingLegacyTemplate">
<Description>
returns true if it is using any of the "Blank Design" variations, aka 'Legacy'</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set out="0|nothing found"
	&SQL(SELECT layoutObjTemplate INTO :tmp FROM setup.objEvent WHERE ID =:xEventID)
	if +SQLCODE=0 {
		set activeTemplate=tmp
		&SQL(SELECT styleSource INTO :tmp FROM layout.objTemplate WHERE ID = :activeTemplate)
		if +SQLCODE=0 {
			if tmp="event" {
				set out=1
			} else {
				set out=0	
			}
		}
	} else {
		set out="0|no template found"				
	}
	quit out
]]></Implementation>
</Method>

<Method name="isEventIFrame">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set out=0
	set templateID=..getLayoutForEvent(xEventID)
	set out=..isTemplateIFrame(templateID)
	if out="err" set out=0
	quit out
]]></Implementation>
</Method>

<Method name="isPageOrEventIframe">
<Description>
This method takes two parameters namely a pageID and an eventID and finds out if the template in use is an iframe template.
PageID is required for survey module where eventID does not exist. PageID will get priority over eventID.
Returns 0 if the template in use is not an Iframe template and 1 otherwise.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID="",eventID=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=0, surveyID=0
	if pageID {
		set surveyID= ##class(shared.pageMethods).getSurveyID(pageID)
		if surveyID {
			//Find the template and its properties from the Survey pageID.
			set templateID=..getLayoutForSurvey(surveyID,0)
			if ..isTemplateIFrame(templateID) {
				set out=1
			}
		}
	}
	if out quit out
	if ('surveyID) && (eventID) {
		//Check template and its properties based on the xEventID.
		if ..isEventIFrame(eventID) set out=1
		if ($D(%session)) && (+$G(%session.Data("inSitePageEditing"))) set out=1
		if ($D(%request)) && (+%request.Get("efPreviewInIframe")) set out=1			
	}
	quit out
]]></Implementation>
</Method>

<Method name="isTemplateIFrame">
<Description>
Checks if the template is designed to be inside an Iframe. Takes in a templateID and returns 1 or 0. 
Returns 'err' if templateID is not valid, does not exist or not supplied.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<Implementation><![CDATA[
	set out=0
	if '$L(templateID) set out="err" quit out
	if templateID'=+templateID set out="err" quit out
	
	&SQL(SELECT isIframe INTO :tmp FROM layout.objTemplate WHERE ID = :templateID)
	if +SQLCODE=0 {
		set out=+tmp
	} else {
		set out="err"
	}
	quit out
]]></Implementation>
</Method>

<Method name="isTemplateNewStyle">
<Description>
Returns true if the template is using the unified style (auto-ban) uploaded by themeUpload.csp
determined by the name of the original file being index.csp</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<Implementation><![CDATA[
	set out=0
	&SQL(SELECT originalFilename INTO :tmp FROM layout.objTemplate WHERE ID = :templateID)
	if +SQLCODE=0 {
		if $ZCVT(tmp,"L")["index.csp" set out=1
		if $ZCVT(tmp,"L")["\media\templates\" set out=1
	}
	quit out
]]></Implementation>
</Method>

<Method name="isTemplateCustomMade">
<Description>
Returns true if the template is custom made</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<Implementation><![CDATA[
	// NOTE: we should be able to use the new property: customTemplate after the first release and the conversion is run
	set out=0
	&SQL(SELECT * FROM layout.objTemplate WHERE ID = :templateID AND active=1 AND (objStandardDesign='' OR objStandardDesign IS NULL) AND styleSource='template')
	if +SQLCODE=0 {
		set out=1
	}
	quit out
]]></Implementation>
</Method>

<Method name="hasBootstrapMenu">
<ClassMethod>1</ClassMethod>
<FormalSpec>layoutTemplateID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT hasBootstrap INTO :result FROM layout.objTemplate WHERE ID  = :layoutTemplateID)
	if +SQLCODE=0 {
		return +result
	} elseif +SQLCODE=100 {
		throw ##class(shared.exceptions.generalException).%New("Invalid layoutTemplateID")	
	} else {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,%msg)	
	}
]]></Implementation>
</Method>

<Method name="isTemplateUsingBootstrap">
<ClassMethod>1</ClassMethod>
<FormalSpec>layoutTemplateID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ..hasBootstrapMenu(layoutTemplateID)
]]></Implementation>
</Method>

<Method name="isTemplateHTML5Compatible">
<ClassMethod>1</ClassMethod>
<FormalSpec>layoutTemplateID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ..hasBootstrapMenu(layoutTemplateID)
]]></Implementation>
</Method>

<Method name="isTemplateGen3">
<ClassMethod>1</ClassMethod>
<FormalSpec>layoutTemplateID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ..hasBootstrapMenu(layoutTemplateID)
]]></Implementation>
</Method>

<Method name="isTemplateGen2">
<ClassMethod>1</ClassMethod>
<FormalSpec>layoutTemplateID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	if ..isTemplateGen3(layoutTemplateID) return 0
	if ##class(layout.methods).isThisDefaultDesign(layoutTemplateID) return 1
	return 0
]]></Implementation>
</Method>

<Method name="rebuildAndOutputToFile">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID,dir,filename</FormalSpec>
<Implementation><![CDATA[
	if 'templateID {
		Throw ##class(shared.exceptions.generalException).%New("TemplateID is required.")
	}
	set stream=..rebuildFromSections(templateID)
	do ##class(shared.fileMethods).createFileFromStream(stream,dir,filename)
	return
]]></Implementation>
</Method>

<Method name="rebuildFromSections">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID</FormalSpec>
<ReturnType>%Stream.GlobalCharacter</ReturnType>
<Implementation><![CDATA[
	if 'templateID return
	
	set stream=##class(%Stream.GlobalCharacter).%New()

	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set sqltext="SELECT * FROM layout.objSection WHERE (objTemplate=?) ORDER BY displayOrder "
	do rs.Prepare(sqltext) 
	do rs.Execute(templateID)
	while rs.Next() {
		set sectionID=rs.Data("ID")
		set tag=rs.Data("after")
		set objSection=##class(layout.objSection).%OpenId(sectionID)
		while ('objSection.htmlStream.AtEnd) {
			set tmpSection=objSection.htmlStream.ReadLine()
			// we have to replace the path to the template files with the tag [[PATH]]
			if tmpSection["../../media/templates/" {
				// EXAMPLES:
				// this:             <link href="../../media/templates/SMALLDEVSRC/SMALLDEVSRC_UCAS2015_NON_RESP/style.css" rel="stylesheet">
				// is replaced with: <link href="[[PATH]]style.css" rel="stylesheet">

				// this:             <link href=../../media/templates/SMALLDEVSRC/SMALLDEVSRC_UCAS2015_NON_RESP/blah.css rel="stylesheet">
				// is replaced with: <link href=[[PATH]]style.css rel="stylesheet">

				// this              <link href='../../media/templates/SMALLDEVSRC/SMALLDEVSRC_UCAS2015_NON_RESP/dfgdfg.css' rel="stylesheet">
				// is replaced with: <link href='[[PATH]]style.css' rel="stylesheet">

				// this:             <link href="../../media/templates/someotherplace/style.css" rel="stylesheet">
				// is not changed as it only matches two directories below /media/templates (namespace and template name)

				set tmpSection=##class(%Regex.Matcher).%New("\.\./\.\./media/templates/([^\""\'\s]*/){2}",tmpSection).ReplaceAll("[[PATH]]")
			}
			do stream.WriteLine(tmpSection)
		}
		kill objSection
		do stream.Write(tag)
	}
	
	return stream
]]></Implementation>
</Method>

<Method name="isTemplateInUse">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[templateID,&message]]></FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set message=""
	&SQL(SELECT ID into :IDs() FROM setup.objEvent WHERE layoutObjTemplate = :templateID)
	if %ROWCOUNT=0 {
		return 0
	} else {
		set x=""
		set IDList=""
		for {
			set x=$O(IDs(x))
			if x="" quit
			set IDList=IDList_" "_IDs(x)
		}
		set message="This template is being used on event(s):"_IDList
		return 1
	}
]]></Implementation>
</Method>

<Method name="isAllowed">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID:%Integer</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	#dim result as %Boolean = 1
	
	set description = ..getIntDesc(templateID)	
		
	&SQL(SELECT xCRstamp  FROM cod.objPerson WHERE ID=1 AND xCRstamp > '2016-08-01 00:00:01')
	if +SQLCODE=0 {
		if $ZCVT(description,"U")["EF_DEFAULT_" { // "blank" design should not be available to new clients
			 set result = 0
			
		} elseif $ZCVT(description,"U")["EF_THEME_DEFAULT_DESIGN" { // non-responsive "standard design" should not be available to new clients
			set result = 0	
		}
	}
	
	return result
]]></Implementation>
</Method>

<Method name="isTemplateUsingProweb2">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID:%Integer</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set template = ..%OpenId(templateID)
	if '$IsObject(template) {
		throw ##class(shared.exceptions.generalException).%New("Invalid templateID: "_templateID)
	}
	return template.isUsingProweb2
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^layout.objTemplateD</DataLocation>
<DefaultData>objTemplateDefaultData</DefaultData>
<IdLocation>^layout.objTemplateD</IdLocation>
<IndexLocation>^layout.objTemplateI</IndexLocation>
<StreamLocation>^layout.objTemplateS</StreamLocation>
<ExtentSize>100000</ExtentSize>
<Data name="objTemplateDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>description</Value>
</Value>
<Value name="3">
<Value>originalFilename</Value>
</Value>
<Value name="4">
<Value>xCRstamp</Value>
</Value>
<Value name="5">
<Value>xCRuserID</Value>
</Value>
<Value name="6">
<Value>xMOstamp</Value>
</Value>
<Value name="7">
<Value>xMOuserID</Value>
</Value>
<Value name="8">
<Value>internalDescription</Value>
</Value>
<Value name="9">
<Value>active</Value>
</Value>
<Value name="10">
<Value>displayOrder</Value>
</Value>
<Value name="11">
<Value>linkedTemplateID</Value>
</Value>
<Value name="12">
<Value>popup</Value>
</Value>
<Value name="13">
<Value>exampleImage</Value>
</Value>
<Value name="14">
<Value>accessibilityLevel</Value>
</Value>
<Value name="15">
<Value>styleSource</Value>
</Value>
<Value name="16">
<Value>templateDirectory</Value>
</Value>
<Value name="17">
<Value>hasBGcolourOnTable</Value>
</Value>
<Value name="18">
<Value>isEFstandard</Value>
</Value>
<Value name="19">
<Value>objStandardDesign</Value>
</Value>
<Value name="20">
<Value>layoutStructure</Value>
</Value>
<Value name="21">
<Value>efLogoInTemplate</Value>
</Value>
<Value name="22">
<Value>isIframe</Value>
</Value>
<Value name="23">
<Value>hasBootstrap</Value>
</Value>
<Value name="24">
<Value>templateSourceFile</Value>
</Value>
<Value name="25">
<Value>templateCSSFile</Value>
</Value>
<Value name="26">
<Value>customTemplate</Value>
</Value>
<Value name="27">
<Value>isUsingProweb2</Value>
</Value>
</Data>
</Storage>
</Class>


<Project name="proweb 2" LastModified="2017-01-30 10:59:46.338538" Target="largedevsrc/backEnd/home/login.csp" TargetType="3">
  <Items>
    <ProjectItem name="EF.contextDataFrontend" type="CLS"></ProjectItem>
    <ProjectItem name="EF.contextDataRegistration" type="CLS"></ProjectItem>
    <ProjectItem name="EF.contextDataRegistrationMock" type="CLS"></ProjectItem>
    <ProjectItem name="EF.mvcHandler.frontend" type="CLS"></ProjectItem>
    <ProjectItem name="EF.mvcHandler.frontendProweb" type="CLS"></ProjectItem>
    <ProjectItem name="EF.mvcHandler.frontendProwebRegistration" type="CLS"></ProjectItem>
    <ProjectItem name="EF.mvcHandler.page" type="CLS"></ProjectItem>
    <ProjectItem name="EF.mvcHandler.securityHandlers.base" type="CLS"></ProjectItem>
    <ProjectItem name="EF.mvcHandler.securityHandlers.frontendProweb" type="CLS"></ProjectItem>
    <ProjectItem name="EF.mvcHandler.securityHandlers.frontendProwebWithBackend" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.containerElement" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.element" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.buttonAddGuest" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.buttonDeleteGuest" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.checkbox" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.checkboxGroup" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.datePicker" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.dateRange" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.divider" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.dropdown" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.emailInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.emailInputMulti" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.fileUpload" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.guestPanel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.hiddenInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.inputElement" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.integerInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.list" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.listOfSingleElement" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.listWithQuestions" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.listWithQuestionsRegistration" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.menuBlock" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.numericInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.page" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.pageHeader" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.panel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.passwordInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.phoneNumber" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.privateData" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.prowebBase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.radioGroup" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.checkboxGroupTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.datePIckerTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.dateRangeTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.dropdownTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.emailInputMultiTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.emailInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.fileUploadInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.integerInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.numericInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.pageTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.passwordInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.phoneNumberTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.radioButtonsTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.textAreaTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.textBlockTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.textInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.timeInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.webAddressTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.youTubeVideoTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.textArea" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.textBlock" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.textInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.timeInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.webAddress" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.youTubeVideo" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pages.base" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pages.frontend.base" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pages.frontend.baseProweb" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pages.frontend.registrationProcessProweb" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pages.securityHandlerFrontendProweb" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.attribute" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.backend.panel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.alternativeABI" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.alternativeABIDropdown" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.alternativeABIRadio" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.buttonAddGuest" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.buttonDeleteGuest" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.buttonLink" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.buttonSubmit" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.checkbox" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.checkboxGroup" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.datePicker" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.dateRange" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.divider" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.dropdown" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.editorControlPanel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.emailInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.emailInputMulti" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.fileUpload" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.fileUploadFacade" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.floatingMenu" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.hiddenInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.inputElement" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.inputLabel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.integerInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.label" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.menuBlock" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.numericInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.pageHeader" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.panel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.passwordInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.phoneNumber" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.privateData" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.progressBar" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.prowebBase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.radioGroup" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.textArea" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.textBlock" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.textInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.timeInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.webAddress" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.wholeNumber" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.youTubeVideo" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.panel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.bespokeValidationMethod" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.emailAddressMulti" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.patternMatchValidation" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.personRegisteredWithSameAnswer" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.phoneNumber" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.phoneNumberTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.webAddress" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.webAddressTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/Home/inSiteEditingFrame.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/Home/regPages.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/codQuestionDetails.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/codQuestionDetails2.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/deleteListItem.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/editItem.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/fileUploadDetails.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/fileUploadDetails2.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/flashDetails.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/flashDetails2.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/formDivider.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/quickEditAJAX.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/quickEditSave.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/textDetailsMoxie.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/textDetailsMoxie2.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/updateLabelText.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/errorLoadingPage.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/frontendStyles.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/home.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/pageControllerStandardSave.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/registration.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/reorderProwebElements.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/tRegistration.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/tmenu.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-04/index.html" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-04/style.LESS" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-07/index.html" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-07/style.LESS" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-08/index.html" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-08/style.LESS" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-09/index.html" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-21/index.html" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/media/templates/ALL_CLIENTS/EF_theme_standard_design-v2-21/style.LESS" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/system/eventsForceRules.csr" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/system/proweb/start.csp" type="CSP"></ProjectItem>
    <ProjectItem name="layout.cssDefaultMethods" type="CLS"></ProjectItem>
    <ProjectItem name="layout.cssOverrideMethods" type="CLS"></ProjectItem>
    <ProjectItem name="layout.disposableMethods" type="CLS"></ProjectItem>
    <ProjectItem name="layout.methods" type="CLS"></ProjectItem>
    <ProjectItem name="layout.objTemplate" type="CLS"></ProjectItem>
    <ProjectItem name="sc.codItemMethods" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItem" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorage" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageDivider" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageFileUpload" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageFileUploadMock" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageInputElement" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageInputElementAlternative" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageInputElementMock" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageMenuBlock" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageMenuBlockItem" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStoragePageHeader" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageTextBlock" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageTextBlockMock" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageYouTubeVideo" type="CLS"></ProjectItem>
    <ProjectItem name="sc.facade.prowebItemStorageYouTubeVideoMock" type="CLS"></ProjectItem>
    <ProjectItem name="sc.methods" type="CLS"></ProjectItem>
    <ProjectItem name="sc.objComponent" type="CLS"></ProjectItem>
    <ProjectItem name="sc.objData" type="CLS"></ProjectItem>
    <ProjectItem name="sc.proweb2methods" type="CLS"></ProjectItem>
    <ProjectItem name="sc.viewQuestionsByPageID" type="CLS"></ProjectItem>
    <ProjectItem name="sc.xModules.objCODitem" type="CLS"></ProjectItem>
    <ProjectItem name="sc.xModules.objList" type="CLS"></ProjectItem>
    <ProjectItem name="sc.xModules.objPage" type="CLS"></ProjectItem>
    <ProjectItem name="setup.availabilityCheckerSession" type="CLS"></ProjectItem>
    <ProjectItem name="setup.backendMenu" type="CLS"></ProjectItem>
    <ProjectItem name="setup.bookingLevelCounterFrontendSession" type="CLS"></ProjectItem>
    <ProjectItem name="setup.eventCreationMethods" type="CLS"></ProjectItem>
    <ProjectItem name="setup.objPageNav" type="CLS"></ProjectItem>
    <ProjectItem name="shared.pageMethods" type="CLS"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/initProweb2Session.csp" type="CSP"></ProjectItem>
  </Items>
  <BreakPoints>
    <BreakPoint Routine="cspRealEV.frontend.reg.pagecontrollerstandardsave.CLS" Offset="OnPreHTTPafter+35"></BreakPoint>
  </BreakPoints>
</Project>


<Class name="sc.codItemMethods">
<Description><![CDATA[
methods dealing with sc.xModules.objCODitem stuff
<!-- ;vc;
;vc;    Object: sc.codItemMethods.CLS/EV.13
;vc; Component: CLS.sc.codItemMethods
;vc;  Location: LargeDev
;vc; Date/Time: 17-Jan-17 17:09
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>sc.codItemMethods.CLS/EV.13</td><td>CLS.sc.codItemMethods</td><td>LargeDev</td><td style='white-space: nowrap;'>17-Jan-17 17:09</td><td>FredG</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<TimeChanged>64300,61753.923294</TimeChanged>
<TimeCreated>63006,56247.192197</TimeCreated>

<Method name="isSimpleInputTextDataType">
<Description>
Is this data type a simple HTML text input type?</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataType:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Set ret=0
	
	If (	(dataType="text")
		!	(dataType="time")
		!	(dataType="textarea")
		!	(dataType="emailAddress")
		!	(dataType="multiEmailAddress")
		!	(dataType="phoneNumber")
		!	(dataType="integer")
		!	(dataType="floatingPointNumber")
		!	(dataType="webAddress")
	) {
		Set ret=1
	}

	Quit ret
]]></Implementation>
</Method>

<Method name="outputHelpTextForDataID">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String,dataType:%String=""</FormalSpec>
<Implementation><![CDATA[
	Set helpText=""
	If (dataType="fileUpload") {
		&SQL(SELECT helpText INTO :tmpHelpText FROM sc_xModules.objFileUpload WHERE ID=:dataID)
	} else {
		&SQL(SELECT helpText INTO :tmpHelpText FROM sc_xModules.objCODitem WHERE ID=:dataID)
	}
	
	If (+SQLCODE=0) {
		Set helpText=tmpHelpText
		If ($LENGTH(helpText)) {
			Do ..outputHelpTextHTML(helpText)
		}
	}
]]></Implementation>
</Method>

<Method name="outputHelpTextHTML">
<ClassMethod>1</ClassMethod>
<FormalSpec>helpTextIn:%String</FormalSpec>
<Implementation><![CDATA[
	if $Length(helpTextIn)>0 {
		Set helpTextID="helpTextIcon_"_$TR(##class(%SYSTEM.Util).CreateGUID(),"-","")
			
		&html<
			<div id="#(helpTextID)#" class="ef_frontend_help_text_icon">?</div>
			<div id="#(helpTextID)#_content" class="ef_frontend_help_text_content" style="display: none;"><pre>#(##class(%CSP.Page).EscapeHTML(helpTextIn))#</pre></div>
			<script language="javascript">
			$(document).ready(function(){
				ef_create_help_text_qtip('#(helpTextID)#');
			});
			</script>
		>
	}
]]></Implementation>
</Method>

<Method name="getPageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<Implementation><![CDATA[
	set pageID=""
	&SQL(SELECT parent->parent INTO :tmp FROM sc_xModules.objCodItem WHERE ID=:dataID)
	if +SQLCODE=0 {
		set pageID=tmp
	}
	quit pageID
]]></Implementation>
</Method>

<Method name="correctTypeForCodItem">
<ClassMethod>1</ClassMethod>
<FormalSpec>itemName</FormalSpec>
<Implementation><![CDATA[
	set itemNameID=##class(cod.objItemName).getIDFromDescriptionNoEvent(itemName)
	if 'itemNameID {
		throw ##class(shared.exceptions.generalException).%New("item does not exist")	
	}
	set newType=##class(cod.objItemName).getTypeById(itemNameID)
	if ($ZCVT(newType,"L")'=$ZCVT("date","L"))&&($ZCVT(newType,"L")'=$ZCVT("emailAddress","L"))&&($ZCVT(newType,"L")'=$ZCVT("phoneNumber","L")) {
		throw ##class(shared.exceptions.generalException).%New("Method does not support type: "_type)	
	}
	set qry="SELECT ID,description,type FROM sc_xModules.objCodItem WHERE objItemName = ?"
	set rs=##class(%ResultSet).%New()
	do rs.Prepare(qry)
	do rs.Execute(itemNameID)
	while rs.Next() {
		set codItemID=rs.Get("ID")
		set oldType=rs.Get("type")
		if $ZCVT(newType,"L")'=$ZCVT(oldType,"L") {
			write "Updating type sc.xModules.objCodItem ID = ",codItemID,", itemName = '",itemName,"' description = '",rs.Get("description"),"', old type = '",oldType,"', new type = '",newType,"'",!
			&SQL(UPDATE sc_xModules.objCodItem SET type = :newType WHERE ID = :codItemID)
		}
	}
]]></Implementation>
</Method>

<Query name="qQuestionsThatCanBeDependencyParents">
<Type>%SQLQuery</Type>
<FormalSpec>pageID:%Integer</FormalSpec>
<SqlQuery>	SELECT prowebID, labelText
	FROM sc.viewActiveQuestions 
	WHERE (pageID = :pageID) 
	AND (questionType IN ('dropdown', 'radiobutton')) 
	ORDER BY displayOrder</SqlQuery>
</Query>
</Class>


<Class name="sc.facade.prowebItem">
<Description>
Facade class for the sc.objData</Description>
<Super>%RegisteredObject</Super>
<TimeChanged>64206,39804.000095</TimeChanged>
<TimeCreated>64206,36952.573447</TimeCreated>

<Property name="storage">
<Type>sc.facade.prowebItemStorage</Type>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>storage:sc.facade.prowebItemStorage</FormalSpec>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	set prowebItem = ..%New()
	set prowebItem.storage = storage
	return prowebItem
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorage">
<Super>%RegisteredObject</Super>
<TimeChanged>64293,61468.814234</TimeChanged>
<TimeCreated>64206,37017.045507</TimeCreated>

<Property name="prowebID">
<Description>
Property displayOrder As %Integer [ Required ];</Description>
<Type>%Integer</Type>
</Property>

<Property name="pageID">
<Type>%Integer</Type>
</Property>

<Property name="dependsOnProwebAlternativeID">
<Type>%Integer</Type>
</Property>

<Property name="dependsOnProwebID">
<Type>%Integer</Type>
</Property>

<Property name="dependsOnProwebItem">
<Type>sc.facade.prowebItemStorage</Type>
</Property>

<Property name="dependencyHoverText">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>prowebItemID:%Integer</FormalSpec>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[	// only implemented in subclasses
]]></Implementation>
</Method>

<Method name="getListID">
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	if ..prowebID {
		return ##class(sc.objData).getParentID(..prowebID)	
	} else {
		return "dummy-listID"
	}
]]></Implementation>
</Method>

<Method name="isOkToLoad">
<FormalSpec>contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	if 'contextData.%Extends("EF.contextDataFrontend") {
		throw ##class(shared.exceptions.generalException).%New("Proweb2 has not been implemented for this type of contextData yet: "_contextData)
	}
	if contextData.prowebMode = "edit" {
		return 1
	}
	
	if (contextData.attendeeCategoryID) {
		if '##class(links.lnkEventCategoryData).allow(contextData.attendeeCategoryID, ..prowebID) {
			return 0	
		}
	}
	if (contextData.%Extends("EF.contextDataRegistration")) && (contextData.tempPersonID) && (..dependsOnProwebID) {
		if '..hasInPageDependency(contextData) {
			if '..isElementActiveForDependency(contextData) {
				return 0	
			}
		}	
	}
	
	return 1
]]></Implementation>
</Method>

<Method name="hasInPageDependency">
<FormalSpec>contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set parentInputElement = ..getDependsOnProwebItem(contextData)
	if ..pageID = parentInputElement.pageID {
		return 1	
	}
	return 0
]]></Implementation>
</Method>

<Method name="isElementActiveForDependency">
<FormalSpec>contextData:EF.contextDataRegistration</FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
	#Dim parentInputElement As sc.facade.prowebItemStorageInputElement = ..getDependsOnProwebItem(contextData)
	set tempPersonToCheckID = contextData.tempPersonID
	if contextData.eventWebsiteLanguage.eventConfiguration.getAllowGroupBookings() {
		if parentInputElement.pageID = contextData.eventWebsiteLanguage.getBookerPageID() {
			set personToCheck = ##class(eCom.tempPerson).getBookerIDfromTempPurchaseID(contextData.tempPersonID)
		}
	}
	if ##class(eCom.tempCodData).get(tempPersonToCheckID,parentInputElement.databaseItemName) '= ##class(cod.objItemAlternatives).getDescriptionByID(..dependsOnProwebAlternativeID) {
		return 0
	}
	return 1
]]></Implementation>
</Method>

<Method name="getDependsOnProwebItem">
<FormalSpec>contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>sc.facade.prowebItemStorageInputElement</ReturnType>
<Implementation><![CDATA[
	if '$IsObject(..dependsOnProwebItem) {
		set ..dependsOnProwebItem = ##class(sc.facade.prowebItemStorageInputElement).createNew(..dependsOnProwebID,contextData)	
	}
	return ..dependsOnProwebItem
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageDivider">
<Super>sc.facade.prowebItemStorage</Super>
<TimeChanged>64212,33280.177807</TimeChanged>
<TimeCreated>64206,41722.621925</TimeCreated>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>prowebItemID:%Integer,contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	#dim prowebItem as sc.xModules.objCODitem
	
	set storage = ..%New()
	set prowebItem = ##class(sc.objData).%OpenId(prowebItemID)
	set storage.prowebID = prowebItemID
	
	return storage
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageFileUpload">
<Super>sc.facade.prowebItemStorageInputElement</Super>
<TimeChanged>64210,56671.066979</TimeChanged>
<TimeCreated>64209,36902.156071</TimeCreated>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>prowebItemID:%Integer,contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	#dim prowebItem as sc.xModules.objFileUpload
	
	set storage = ..%New()
	set prowebItem = ##class(sc.objData).%OpenId(prowebItemID)
	set storage.prowebID = prowebItemID
	set storage.inputType = "fileUpload"
	set storage.labelText = prowebItem.description
	
	return storage
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageFileUploadMock">
<Super>sc.facade.prowebItemStorageFileUpload</Super>
<TimeChanged>64223,61248.111216</TimeChanged>
<TimeCreated>64209,55230.373856</TimeCreated>

<Property name="testValue">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>prowebItemID:%Integer,contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	
	
	set storage = ..%New()
	set storage.inputType = "fileUpload"
	
	return storage
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageInputElement">
<Super>sc.facade.prowebItemStorage</Super>
<TimeChanged>64265,56598.252711</TimeChanged>
<TimeCreated>64206,40073.01042</TimeCreated>

<Property name="inputType">
<Type>%String</Type>
<Required>1</Required>
<Parameter name="VALUELIST" value=",text,textarea,radiobutton,checkbox,dropdown,password,multibox,date,dateRange,time,emailAddress,multiEmailAddress,phoneNumber,integer,floatingPointNumber,webAddress,fileUpload"/>
</Property>

<Property name="databaseItemName">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="databaseItemID">
<Type>%Integer</Type>
<Required>1</Required>
</Property>

<Property name="listOfAlternatives">
<Type>sc.facade.prowebItemStorageInputElementAlternative</Type>
<Collection>list</Collection>
</Property>

<Property name="isGuest">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="labelText">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Property name="helpText">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Property name="isBackendOnly">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="isReadOnly">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="isMandatory">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="requiredAnswer">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Property name="defaultValue">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Property name="isSearchAsYouType">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="customValidation">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Property name="bespokeValidationMethod">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Property name="validationErrorMessage">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Property name="maxWords">
<Type>%Integer</Type>
</Property>

<Property name="maxCharacters">
<Type>%Integer</Type>
</Property>

<Property name="fieldHeight">
<Type>%Integer</Type>
</Property>

<Property name="minAltsChecked">
<Type>%Integer</Type>
</Property>

<Property name="maxAltsChecked">
<Type>%Integer</Type>
</Property>

<Property name="caseConversionCommand">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>prowebItemID:%Integer,contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	#dim prowebItem as sc.xModules.objCODitem
	
	set storage = ..%New()
	set prowebItem = ##class(sc.objData).%OpenId(prowebItemID)
	
	set storage.prowebID = prowebItemID
	set storage.inputType = prowebItem.type
	set storage.isGuest = prowebItem.isGuest
	set storage.labelText = prowebItem.description
	set storage.helpText = prowebItem.helpText
	set storage.isBackendOnly = prowebItem.backendOnly
	set storage.isReadOnly = prowebItem.readonlyFrontend
	if (contextData.isAmendment) && (prowebItem.noAmendments) {
		set storage.isReadOnly = 1	
	}
	set storage.isMandatory = prowebItem.mandatory
	set storage.requiredAnswer = prowebItem.requiredAnswer
	set storage.isSearchAsYouType = prowebItem.searchAsYouType
	set storage.databaseItemName = prowebItem.objItemName.description
	set storage.databaseItemID = prowebItem.objItemName.%Id()
	set storage.defaultValue = prowebItem.defaultValue
	set storage.maxWords = prowebItem.maxWords
	set storage.maxCharacters = prowebItem.maxCharacters
	set storage.fieldHeight = prowebItem.fieldHeight
	set storage.minAltsChecked = prowebItem.minAltsChecked
	set storage.maxAltsChecked = prowebItem.maxAltsChecked

	
	if (prowebItem.requiredAnswer ? 1"?".E) ! (prowebItem.requiredAnswer ? 1"?".E) !(prowebItem.requiredAnswer ? 1"#".AN) {
		set storage.customValidation = prowebItem.requiredAnswer 
		
	} elseif prowebItem.requiredAnswer ? 1"##".AN {
		set storage.bespokeValidationMethod = prowebItem.requiredAnswer 
		
	} elseif prowebItem.requiredAnswer '= "" {
		// turn literal string values in to a pattern match
		set storage.customValidation = "?1"""_prowebItem.requiredAnswer_""""	
	}
	
	set storage.validationErrorMessage = prowebItem.validationErrorMessage
	set storage.dependsOnProwebAlternativeID = prowebItem.dependsOnAlternative
	set storage.dependsOnProwebID = prowebItem.dependsOnPrompt
	set storage.pageID = prowebItem.parent.parent.%Id()
	
	if ##class(setup.objEventSetting).getParameter("COD prompts","convert names to sentence case", contextData.eventID) {
		if ($ZCVT(storage.databaseItemName, "U") = "FIRSTNAME") ! ($ZCVT(storage.databaseItemName, "U") = "LASTNAME") ! ($ZCVT(storage.databaseItemName, "U") = "TOWN") {
			set storage.caseConversionCommand =	 " onBlur='sentenceCase(this);'"
			
		}  elseif $ZCVT(storage.databaseItemName, "U") = "POSTCODE" {
			set storage.caseConversionCommand =	 " onBlur='this.value = this.value.toUpperCase();'"
		}
	}
	
	do ..populateAlternatives(storage, prowebItem,contextData)
	
	if storage.inputType = "dropdown" {
		set storage.isSearchAsYouType = prowebItem.searchAsYouType	
	}
	set storage.dependencyHoverText = prowebItem.getDependencyHoverText()
	return storage
]]></Implementation>
</Method>

<Method name="populateAlternatives">
<ClassMethod>1</ClassMethod>
<FormalSpec>storage:sc.facade.prowebItemStorageInputElement,prowebItem:sc.objData,contextData:EF.contextDataRegistration</FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
	#dim alternative as sc.facade.prowebItemStorageInputElementAlternative

	if (storage.inputType = "dropdown") !(storage.inputType = "multibox") ! (storage.inputType = "radiobutton") {
		if (prowebItem.type = "dropdown") && (+prowebItem.mandatory = 0) {
			set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).createEmpty()
			do storage.listOfAlternatives.Insert( alternative ) 
		}
		
		set rsAlternative = ##class(cod.objItemAlternatives).getAlternativesForCodItemAsResultSet( storage.databaseItemID )
		while rsAlternative.Next()	{
			set alternative = ##class(sc.facade.prowebItemStorageInputElementAlternative).createNew(prowebItem.%Id(), rsAlternative.Get("ID"), contextData)
			do storage.listOfAlternatives.Insert( alternative)
		}
	}
]]></Implementation>
</Method>

<Method name="isHiddenToBooker">
<Description>
to make sure group bookers can't see already existing data of attendees</Description>
<FormalSpec>contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	#dim realAttendeeID as %Integer = ##class(eCom.tempPerson).getPersonID(contextData.tempPersonID)
	#dim realBookerID as %Integer  
	#dim editableBy as %Integer = ##class(cod.objItemData).get(realAttendeeID, "editableBy")
	#dim storedValue as %String = ##class(cod.objItemData).get(realAttendeeID,..databaseItemName)
	
	#define isGroupBooking contextData.tempBookerID > 0
	#define isPreExistingAttendee realAttendeeID > 0
	#define isEventSpanning ##class(cod.objItemName).isEventSpanningAnswer(..databaseItemName) = 1
	#define isRegisteringForSomeoneElse contextData.tempBookerID '= contextData.tempPersonID
	#define isFrontEndRegistration +contextData.isBackendBooking = 0
	#define isOwnedBySomeoneElse editableBy '= realBookerID
	#define isAnythingButName ($ZCVT(..databaseItemName,"L") '= "firstname") && ($ZCVT(..databaseItemName,"L") '= "lastname")
	
	try {
		set realBookerID = ##class(eCom.tempPerson).getTempBookerIDFromTempPersonID(contextData.tempPersonID)	
	} catch {
		set realBookerID = ""	
	}
	
	if ($$$isGroupBooking) && ($$$isPreExistingAttendee) && ($$$isRegisteringForSomeoneElse) && ($$$isFrontEndRegistration) && ($$$isOwnedBySomeoneElse) && ($$$isEventSpanning) && ($$$isAnythingButName){
		return 1
	} else {
		return 0
	}
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageInputElementAlternative">
<Super>%RegisteredObject</Super>
<TimeChanged>64247,30922.188857</TimeChanged>
<TimeCreated>64211,61761.805017</TimeCreated>

<Property name="value">
<Type>%String</Type>
</Property>

<Property name="displayText">
<Type>%String</Type>
</Property>

<Property name="alternativeID">
<Type>%Integer</Type>
</Property>

<Property name="isABI">
<Type>%Boolean</Type>
</Property>

<Property name="ABIPrice">
<Type>%Numeric</Type>
</Property>

<Property name="ABICapacity">
<Type>%Integer</Type>
</Property>

<Property name="ABICurrentBookingLevel">
<Type>%Integer</Type>
</Property>

<Property name="ABIIsBookingStopped">
<Type>%Boolean</Type>
</Property>

<Method name="createEmpty">
<ClassMethod>1</ClassMethod>
<ReturnType>sc.facade.prowebItemStorageInputElementAlternative</ReturnType>
<Implementation><![CDATA[
	set alternative = ..%New()
	return alternative
]]></Implementation>
</Method>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>prowebID:%Integer,alternativeID:%Integer,contextData:EF.contextDataRegistration=""</FormalSpec>
<ReturnType>sc.facade.prowebItemStorageInputElementAlternative</ReturnType>
<Implementation><![CDATA[
	#dim prowebAlternative AS cod.objItemAlternatives = ##class(cod.objItemAlternatives).%OpenId(alternativeID)
	#dim controllerID as %Integer = ##class(setup.objEvent).getControllerID(contextData.eventID)
	#define returnBookingLevel 1
	#dim availabilityChecker as setup.availabilityCheckerABI
	
	if '$IsObject(prowebAlternative) {
		throw ##class(shared.exceptions.generalException).%New("Failed to open alternative")
	}
	
	set alternative = ..%New()

	set alternative.displayText = ##class(cod.objItemAlternativeDetails).getDescription(alternativeID, contextData.languageID)
	set alternative.displayText = ##class(EF.htmlGenerator).unescapeXSSFix(alternative.displayText)
	set alternative.value = alternative.displayText		

	set alternativeExtraID=##class(cod.objAlternativeExtras).getExtrasIDFromItemAltID(alternativeID, prowebID )
	if alternativeExtraID {			
		set alternative.isABI = 1
		
		
		set availabilityChecker = ##class(setup.availabilityCheckerABI).createForABIIDAndTempPersonID(alternativeExtraID,contextData.tempPersonID)
		
		set alternative.ABICurrentBookingLevel = availabilityChecker.getBookingLevel()
		set alternative.ABICapacity = availabilityChecker.getCapacity()
		set alternative.ABIIsBookingStopped = availabilityChecker.isStopped()
	}

	set alternative.alternativeID = alternativeID
	return alternative
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageInputElementMock">
<Super>sc.facade.prowebItemStorageInputElement</Super>
<TimeChanged>64223,60485.795637</TimeChanged>
<TimeCreated>64206,37060.296556</TimeCreated>

<Property name="testValue">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	set storage = ..%New()
	set storage.inputType = "text"
	return storage
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageMenuBlock">
<Super>sc.facade.prowebItemStorage</Super>
<TimeChanged>64223,57288.253857</TimeChanged>
<TimeCreated>64223,41312.114214</TimeCreated>

<Property name="listOfMenuItems">
<Type>sc.facade.prowebItemStorageMenuBlockItem</Type>
<Collection>list</Collection>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>prowebItemID:%Integer,contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	#dim prowebItem as sc.xModules.objMenuBlock
	
	set storage = ..%New()
	set storage.prowebID = prowebItemID

	set rsMenuItems = ##class(%ResultSet).%New("layout.objMenuItem:qGetMenuItems")
	do rsMenuItems.Execute(prowebItemID)
	while rsMenuItems.Next() {
		set menuItemText = rsMenuItems.Data("text")
		set menuItemLinkURL = rsMenuItems.Data("linkURL")
		set menuItemLinkTarget = rsMenuItems.Data("linkTarget")

		set menuItem = ##class(sc.facade.prowebItemStorageMenuBlockItem).createNew(menuItemText, menuItemLinkURL, menuItemLinkTarget)
		if '$IsObject(menuItem) {
			throw ##class(shared.exceptions.generalException).%New("failed to create menu item: "_menuItemText)
		}
		
		do storage.listOfMenuItems.Insert(menuItem)
	}	
	return storage
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageMenuBlockItem">
<Super>%RegisteredObject</Super>
<TimeChanged>64223,57670.129916</TimeChanged>
<TimeCreated>64223,55863.589205</TimeCreated>

<Property name="text">
<Type>%String</Type>
<Parameter name="MAXLEN" value="200"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="linkURL">
<Type>%String</Type>
<Parameter name="MAXLEN" value="1000"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="linkTarget">
<Type>%String</Type>
<Parameter name="MAXLEN" value="50"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>menuItemText:%String,menuItemLinkURL:%String,menuItemLinkTarget:%String</FormalSpec>
<ReturnType>sc.facade.prowebItemStorageMenuBlockItem</ReturnType>
<Implementation><![CDATA[
	set menuBlockItem = ..%New()
	
	set menuBlockItem.text = menuItemText
	set menuBlockItem.linkURL = menuItemLinkURL

	if menuItemLinkTarget = "" {
		set miLinkTarget = "_self"
	}
	set menuBlockItem.linkTarget = menuItemLinkTarget
	
	return menuBlockItem
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStoragePageHeader">
<Super>sc.facade.prowebItemStorageTextBlock</Super>
<TimeChanged>64264,59532.3045</TimeChanged>
<TimeCreated>64264,59532.3045</TimeCreated>
</Class>


<Class name="sc.facade.prowebItemStorageTextBlock">
<Super>sc.facade.prowebItemStorage</Super>
<TimeChanged>64223,41363.221653</TimeChanged>
<TimeCreated>64206,41475.453349</TimeCreated>

<Property name="text">
<Type>%String</Type>
<Parameter name="MAXLEN" value="3000000"/>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>prowebItemID:%Integer,contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	#dim prowebItem as sc.xModules.objText
	
	set storage = ..%New()
	set prowebItem = ##class(sc.objData).%OpenId(prowebItemID)
	set storage.text = prowebItem.description
	set storage.prowebID = prowebItemID
	set storage.dependsOnProwebAlternativeID = prowebItem.dependsOnAlternative
	

	
	return storage
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageTextBlockMock">
<Super>sc.facade.prowebItemStorageTextBlock</Super>
<TimeChanged>64223,74073.587616</TimeChanged>
<TimeCreated>64223,62062.865015</TimeCreated>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	set storage = ..%New()


	
	return storage
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageYouTubeVideo">
<Super>sc.facade.prowebItemStorage</Super>
<TimeChanged>64210,56672.319609</TimeChanged>
<TimeCreated>64208,57300.34753</TimeCreated>

<Property name="youTubeVideoURL">
<Type>%String</Type>
</Property>

<Property name="width">
<Type>%Integer</Type>
</Property>

<Property name="height">
<Type>%Integer</Type>
</Property>

<Property name="isLooped">
<Type>%Boolean</Type>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>prowebItemID:%Integer,contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	#dim prowebItem as sc.xModules.objFlash
	
	set storage = ..%New()
	set prowebItem = ##class(sc.objData).%OpenId(prowebItemID)
	set storage.prowebID = prowebItemID
	
	set storage.youTubeVideoURL = prowebItem.description
	set storage.width = prowebItem.width
	set storage.height = prowebItem.height
	set storage.isLooped = prowebItem.loop
	
	return storage
]]></Implementation>
</Method>
</Class>


<Class name="sc.facade.prowebItemStorageYouTubeVideoMock">
<Super>sc.facade.prowebItemStorageYouTubeVideo</Super>
<TimeChanged>64210,56672.614741</TimeChanged>
<TimeCreated>64208,59949.51444</TimeCreated>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<ReturnType>sc.facade.prowebItemStorage</ReturnType>
<Implementation><![CDATA[
	set storage = ..%New()
	set storage.youTubeVideoURL = "https://www.youtube.com/watch?feature=player_embedded&v=sJ363mnyHEk"
	set storage.height = 600
	set storage.width = 800
	set storage.isLooped = 1
	
	return storage
]]></Implementation>
</Method>
</Class>


<Class name="sc.methods">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: sc.methods.CLS/EV.55
;vc; Component: CLS.sc.methods
;vc;  Location: LargeDev
;vc; Date/Time: 04-Nov-16 11:26
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>sc.methods.CLS/EV.55</td><td>CLS.sc.methods</td><td>LargeDev</td><td style='white-space: nowrap;'>04-Nov-16 11:26</td><td>FredG</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<ProcedureBlock>1</ProcedureBlock>
<TimeChanged>64295,58076.764366</TimeChanged>
<TimeCreated>61845,54770.681958</TimeCreated>

<Method name="changeURL">
<Description>
decide whether this url should be changed to the SEO friendly version</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,url,addlanguage=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// only changes URL if it's a csp page with a pageID parameter value for the current event
	// or a specific special page? 
	// will also add language=n if passed in so that menu links get created with a language value when generated from a SEO page
	set origURL=url  // keep this for use later
	
	if 'eventID quit origURL
	// if event is not live, do not convert urls as each seo request is a new session request
	set evStatus=""
	&SQL(SELECT status INTO :tmp FROM setup.objEvent WHERE ID=:eventID)
	if +SQLCODE=0 set evStatus=tmp
	
	if evStatus'="live" quit origURL
	// need to allow preview mode etc when in backend, so just check if we've come from SEO htaccess file
	// set in homepage.csp from htaccess config
	
	// if not using SEO one-to-one mode then return original URL
	if '##class(setup.objEventSetting).getParameter("SEO","one-to-one mode",eventID) quit origURL
	
	// break up URL into it's component parts
	set url=$TR(url,"\","/")  // next method requires slashes to be the correct ones
	do ##class(%Net.URLParser).Parse(url,.arr)
	set scheme=$ZCVT($G(arr("scheme")),"L")
	set host=$ZCVT($G(arr("host")),"L")
	set path=$ZCVT($G(arr("path")),"L")
	set path2="/"_$P(path,"/",3,999)
	set query=$G(arr("query"))
	if addlanguage	{
		if $L(query) {
			set query=query_"&language="_addlanguage
		} else {
			set query="language="_addlanguage
		}
	}
	
	// need backend domain used for this event (includes http or https)
	set backendURL=##class(shared.pageMethods).getFullPath(eventID)
	// Check if the URL domain is the same as the backend domain. If not, leave them alone.
	do ##class(%Net.URLParser).Parse(backendURL,.arrBack)
	set backendDomain = $ZCVT($G(arrBack("host")),"L")
	if $L(host),backendDomain'=host quit origURL
	
	// first check if URL is csp page - if not then return current URL
	if path2'[".csp" quit backendURL_path2_"?"_query
	
	// entered by the client and sets up files on our webserver
	set domain=$ZCVT(##class(setup.objEventSetting).getParameter("SEO","one-to-one site name",eventID),"L")
	
	// get the pageID
	set pageID=+$P(query,"pageID=",2)
	if pageID=0 {
		if (path2["homepage")&(query["language=") {
			set newURL="http://"_domain_"/home?"_query // must be a special page name like dailyAgenda.csp - OR homepage with a language parameter
		} else {
			set newURL=backendURL_path2_"?"_query // must be a special page name like dailyAgenda.csp - OR homepage with a language parameter
		}
		quit newURL
	}
	// check if pageID is for an allowed template (i.e. one that has no functionality beyond that single page)
	if '..templateAllowed(pageID) quit backendURL_path2_"?"_query
	
	// get the seoPageName from the pageID
	set seoPageName=..getSeoPageFromPageID(pageID,eventID)
	if seoPageName="" set seoPageName=pageID  // not found one so just use the pageID

	// new try to extract the language from pageID
	set langIDpageID=..getLangFromPageID(pageID)

	set langIDtoUse=addlanguage
	if 'langIDtoUse set langIDtoUse=langIDpageID
	set addLangToURL=0
	// only want to add the language to the URL of the links that are SEO friendly and not for English. Otherwise we'll always have the language=1 on the URL.
	if $G(%session.Data("eventsforce","frontend","xPrefLangID")),langIDtoUse	{
		set addLangToURL=1
		if langIDtoUse=1,(langIDtoUse=%session.Data("eventsforce","frontend","xPrefLangID")) set addLangToURL=0
	}
	
	set newURL="http://"_domain_"/"_seoPageName
	if addLangToURL set newURL=newURL_"?language="_langIDtoUse

	quit newURL
]]></Implementation>
</Method>

<Method name="templateAllowed">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set allowed("../../frontend/reg/totherpage.csp")=""
	set allowed("../../frontend/reg/tvenue.csp")=""
	set allowed("../../frontend/reg/ttandc.csp")=""
	set allowed("../../frontend/reg/thome.csp")=""
	set filename=$ZCVT(##class(sc.xModules.objPage).getTemplateFile(pageID),"L")
	if filename="" quit 0  // Fred Feb 2012 - it should not crash if bad pageID passed in
	if $D(allowed(filename)) quit 1
	quit 0
]]></Implementation>
</Method>

<Method name="getPageIDfromSeoPage">
<Description>
return the static filename for this page if it has been compiled and it is a static page template</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,seoPage</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// if seoPage is numeric then it's a pageID (as I stop any all numeric page names from being allowed to be created)
	if seoPage?1.N quit seoPage
	
 	// find the groupID for the event
 	set homePageID="",tmp1=""
 	&SQL(SELECT homePageID INTO :tmp1 FROM setup.objEventDetails WHERE objEvent=:eventID)
 	if +SQLCODE=0 set homePageID=tmp1
	if homePageID="" quit ""
	set groupID="",tmp1=""
 	&SQL(SELECT parent->parent INTO :tmp1 FROM sc.objData WHERE ID=:homePageID)
 	if +SQLCODE=0 set groupID=tmp1
	if groupID="" quit ""
	
	set pageID=""
	&SQL(SELECT ID INTO :tmp FROM sc_xModules.objPage WHERE (seoPageName = :seoPage) AND (parent->parent=:groupID) )
	if +SQLCODE=0 set pageID=tmp
	quit pageID
]]></Implementation>
</Method>

<Method name="getLangFromPageID">
<Description>
return the language that this pageID is used in</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set desc="",tmp1=""
 	&SQL(SELECT description INTO :tmp1 FROM sc_xModules.objPage WHERE ID=:pageID)
 	if +SQLCODE=0 set desc=tmp1

	set lang=$P(desc," - ",2)
	set langID=""
	if $L(lang) set langID=##class(shared.objLanguage).getLanguageID(lang)
	if 'langID set langID=1  // default is ENGLISH
			
	quit langID
]]></Implementation>
</Method>

<Method name="getSeoPageFromPageID">
<Description>
return the static filename for this page if it has been compiled and it is a static page template</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,eventID,groupID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// either pass in eventID or groupID (pass in groupID to make it faster)
	set groupID=$G(groupID)
	if $G(eventID) 	set groupID=..getEventGroupID(eventID)
	if groupID="" quit "0~no groupID found"
	
	set data="",foundGroupID=""
	&SQL(SELECT seoPageName,parent->parent INTO :tmp,:tmp2 FROM sc_xModules.objPage WHERE (ID=:pageID) )
	if +SQLCODE=0 set data=tmp,foundGroupID=tmp2
	if foundGroupID'=groupID quit "-1~pageID not valid for this event"
	quit data
]]></Implementation>
</Method>

<Method name="getEventGroupID">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 	// find the groupID for the event
 	set homePageID="",tmp1=""
 	&SQL(SELECT homePageID INTO :tmp1 FROM setup.objEventDetails WHERE objEvent=:eventID)
 	if +SQLCODE=0 set homePageID=tmp1
	if homePageID="" quit ""
	set groupID="",tmp1=""
 	&SQL(SELECT parent->parent INTO :tmp1 FROM sc.objData WHERE ID=:homePageID)
 	if +SQLCODE=0 set groupID=tmp1
	quit groupID
]]></Implementation>
</Method>

<Method name="getPageTitle">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data="",tmp=""
	&SQL(SELECT titleBarText INTO :tmp FROM sc_xModules.objPage WHERE ID=:pageID)
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="getSeoKeywords">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data="",tmp=""
	&SQL(SELECT seoKeywords INTO :tmp FROM sc_xModules.objPage WHERE ID=:pageID)
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="getSeoDescription">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data="",tmp=""
	&SQL(SELECT seoDescription INTO :tmp FROM sc_xModules.objPage WHERE ID=:pageID)
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="getEventIDfromPageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<Implementation><![CDATA[
	// ### please note that this logic should at some future stage be replaced by getting the eventID directly from a property on objData. 
	// ### This will be rolled out gradually starting in Sep 2014
	set eventID=""
	set objPage=##class(sc.xModules.objPage).%OpenId(pageID)
	if $ISOBJECT(objPage) {
		if $ISOBJECT(objPage.objEvent) {
			set eventID=objPage.objEvent.%Id()
		}
	}
	return eventID
]]></Implementation>
</Method>

<Method name="updateBackendVariablesFromPageID">
<Description>
This is used to reset variables in the backend for proweb pages.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ProcedureBlock>0</ProcedureBlock>
<Implementation><![CDATA[
	new tmpEventID
	if pageID {
		set tmpEventID=##class(sc.methods).getEventIDfromPageID(pageID)
		if tmpEventID {
			set xEventID=tmpEventID
			set xControllerID=##class(setup.objEvent).getControllerID(xEventID)
			set xFrontendInputDateFormat=##class(setup.objEvent).getDateFormat(xEventID)
		}
	}
]]></Implementation>
</Method>

<Method name="outputProwebTree">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",indent=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
	set ok=""
	
	if dataID="" set indent="" // very first call
	
	//  find all its children
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	if dataID {
		do rs.Prepare("SELECT ID FROM sc.objData WHERE (active=1) AND (parent=?)")
		do rs.Execute(dataID)
	} else {
		do rs.Prepare("SELECT ID FROM sc.objData WHERE parent IS NULL")	
		do rs.Execute()
	}
	while rs.Next() {
		// must open object to get to the desc prop due to casting 
		if rs.Get("ID") {
			set objData=##class(sc.objData).%OpenId(rs.Get("ID"))
			if "objGroup,objPage"[objData.dataType {
				set description=objData.description
			} else {
				set description=objData.dataType	
			}
	 		kill objData
		} else {
			set description="top"	
		}

		write "<LI class='black10px' value="""_rs.Get("ID")_""" "
		write " >"_indent_description_" ("_rs.Get("ID")_")"_"</LI>"

		// find my children
		set ok=..outputProwebTree(rs.Get("ID"),indent_"-&nbsp;")		
	}


 
 
 quit ok
]]></Implementation>
</Method>

<Method name="getComponentIDfromPageIDlistName">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,listName</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set result=""
	set templateID=##class(sc.pageMethods).getTemplateIDfromPageID(pageID)
	&SQL(SELECT ID INTO :tmp 
		FROM sc.objComponent
		WHERE (%SQLUPPER(description) = %SQLUPPER(:listName) AND (objTemplate = :templateID) AND (objData->parent = :pageID))
	)
	if +SQLCODE=0 set result=tmp
	
	return result
]]></Implementation>
</Method>

<Method name="initSCText">
<Description>
Used to automatically initialise a sc:text item</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,listName,text</FormalSpec>
<Implementation><![CDATA[
	set templateID=##class(sc.pageMethods).getTemplateIDfromPageID(pageID)
	if templateID="" quit
	
	if ..getComponentIDfromPageIDlistName(pageID,listName)="" {
		set dataID=##class(sc.xModules.objText).add(pageID,text)
		
		do ##class(sc.objComponent).add(listName, templateID, dataID)
	}
	quit
]]></Implementation>
</Method>

<Method name="initSCFreeWithText">
<Description>
Used to automatically initialise a sc:free item with a text item</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,listName,text</FormalSpec>
<Implementation><![CDATA[
	set templateID=##class(sc.pageMethods).getTemplateIDfromPageID(pageID)
	if templateID="" quit
	
	if ..getComponentIDfromPageIDlistName(pageID,listName)="" {
		set listID=##class(sc.xModules.objList).add(pageID)
		do ##class(sc.objComponent).add(listName, templateID, listID)
		set dataID=##class(sc.xModules.objText).add(listID,text)
	}
]]></Implementation>
</Method>

<Method name="populatePageQuestionsIfEmpty">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,listName</FormalSpec>
<Implementation><![CDATA[
	if ..anyQuestionsOnPage(pageID,listName)=0 {
		do ##class(setup.eventCreationMethods).addDefaultRegistrationPromptsToPage(pageID,listName,"registration page")	
		set %xPageModifiedAndNeedsReload=1 // tell templateStop to reload the page
	}
]]></Implementation>
</Method>

<Method name="anyQuestionsOnPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,listName</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set listID=..getListIDfromPageIDlistName(pageID,listName)
	&SQL(SELECT COUNT(ID) INTO :hits FROM sc_xModules.objCodItem WHERE (active=1) AND (parent = :listID))
	if (+SQLCODE=0) && (hits>0) {
		return 1
	} else {
		return 0
	}
]]></Implementation>
</Method>

<Method name="addQuestionToPageIfMissing">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,listName,codItemName,eventID,label,type="text",isMandatory=0</FormalSpec>
<Implementation><![CDATA[
	set templateID=##class(sc.pageMethods).getTemplateIDfromPageID(pageID)
	if templateID="" quit
	
	set codItemNameID=##class(cod.objItemName).getIDFromDescriptionAndEvent(codItemName,eventID)
	set listID=..getListIDfromPageIDlistName(pageID,listName)
	if 'listID {
		set listID=##class(sc.xModules.objList).add(pageID)
		do ##class(sc.objComponent).add(listName, templateID, listID)
	}
	
	if ..isQuestionInList(listID,codItemNameID)=0 {
		set dataID=##class(sc.xModules.objCODitem).add(codItemNameID,label,listID,,,,type,isMandatory,,"")
		set %xPageModifiedAndNeedsReload=1 // tell templateStop to reload the page
	}
]]></Implementation>
</Method>

<Method name="getListIDfromPageIDlistName">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,listName</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set result=""
	set templateID=##class(sc.pageMethods).getTemplateIDfromPageID(pageID)
	&SQL(SELECT objdata INTO :tmp 
		FROM sc.objComponent
		WHERE (%SQLUPPER(description) = %SQLUPPER(:listName) AND (objTemplate = :templateID) AND (objData->parent = :pageID))
	)
	if +SQLCODE=0 set result=tmp
	
	return result
]]></Implementation>
</Method>

<Method name="isQuestionInList">
<ClassMethod>1</ClassMethod>
<FormalSpec>listID,codItemNameID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
		&SQL(SELECT ID FROM sc_xModules.objCodItem WHERE (parent = :listID) AND (objitemName = :codItemNameID) AND (active=1))
		if +SQLCODE=0 {
			return 1
		} else {
			return 0
		}
]]></Implementation>
</Method>

<Method name="updateTemplateType">
<Description>
method for transfering the variable that are set in the CSP template page into the database table as props</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>templateID,prop,value</FormalSpec>
<Implementation><![CDATA[
	set ok="0|init"
	set objTemplate=##class(sc.objTemplate).%OpenId(templateID)
	if 'objTemplate quit "0|could not open template" 
	set $Property(objTemplate,prop) = value
	set ok=objTemplate.%Save()
	quit ok
]]></Implementation>
</Method>

<Method name="verifyAndFixDisplayOrders">
<Description>
Verifies and corrects the displayOrder of all objects below the passed in pageID</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID:%Library.String=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
	kill orderArray
	
	// tests
	If '##class(sc.objData).%ExistsId(pageID) Quit "0|Don't exist"
	set count=0

	// loop on all lists on the page
	set rsLists=""
	set rsLists=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rsLists.Prepare("SELECT ID FROM sc_xModules.objList WHERE  parent=?")
	do rsLists.Execute(pageID)
	while rsLists.Next() {
		set parentID=rsLists.Get("ID")
		// AJM 12/1/2012 15186-6003 There are some really old text blocks with no display order. These should be de-activated as they were not displaying 
		&SQL(UPDATE sc.objData
			SET active = 0
			WHERE displayOrder IS NULL AND parent = :parentID AND active = 1
		)
		// loop through all children of the list in displayOrder order
		set rsChildren=""
		set rsChildren=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
		do rsChildren.Prepare("SELECT ID,displayOrder,dataType FROM sc.objData WHERE (active=1) AND (parent=?) ORDER BY displayOrder")
		do rsChildren.Execute(parentID)
		while rsChildren.Next() {
			if rsChildren.Get("dataType")'="objList" {
				set dataID=rsChildren.Get("ID")
				set displayOrder=""
				&SQL(SELECT displayOrder INTO :tmp FROM sc.objData WHERE ID =:dataID)
				if +SQLCODE=0 {
					set displayOrder=tmp
				}
				// check if this is a duplicated displayorder
				&SQL(SELECT ID FROM sc.objData WHERE parent=:parentID AND ID <> :dataID AND active=1 AND displayOrder=:displayOrder)
				if +SQLCODE=0 {
			
					// fix duplicates by pushing all subsequent object down one step
					set count=count+1
					set rsSubs=""
					set rsSubs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
					do rsSubs.Prepare("SELECT ID,displayOrder FROM sc.objData WHERE (active=1) AND (parent=?) AND (displayOrder > ?) ORDER BY displayOrder")
					do rsSubs.Execute(parentID,displayOrder)
					while rsSubs.Next() {
						set subsID=rsSubs.Get("ID")
						set subsDisplayOrder=0
						set subsDisplayOrder=rsSubs.Get("displayOrder")+1
						&SQL(UPDATE sc.objData SET displayOrder = :subsDisplayOrder WHERE ID = :subsID)	
					}
			
					// and then push the duplicate down one step
					set displayOrder=displayOrder+1
					&SQL(UPDATE sc.objData SET displayOrder = :displayOrder WHERE ID = :dataID)	
			
					kill rsSubs
				}
			
				// store their displayOrder in an array
				set orderArray(displayOrder)=dataID
			}
		}
		kill rsChildren
	}
	
	// log it if any corrections were made
	if count set ^%xFixDisplayOrder($H,$ZNSPACE,pageID)=count	
	
	quit count
]]></Implementation>
</Method>

<Method name="copyPageContent">
<Description>
Copy page content. In the following, the page is copied part by part even though we could copy it in one go. 
The reason behind that is that we try to reuse the 'OjbList' items. All over the system it is assumed that there cannot be two of them
and active flag in the objComponent class is just ignored. </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>sourcePageID="",targetPageID=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=""
	if sourcePageID,targetPageID,targetPageID'=sourcePageID {
		set targetEventID=##class(sc.xModules.objPage).getEventID(targetPageID)
		set rs2=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
		do rs2.Prepare("SELECT * FROM sc_xModules.objList WHERE parent=? ORDER BY ID ASC")
		do rs2.Execute(sourcePageID)
		while rs2.Next() {
			set sourceListID=rs2.Get("ID")
			
			// find the componentName from the source page
			set sourceComponentName=""
			&SQL(SELECT description INTO :tmp FROM sc.objComponent WHERE objData = :sourceListID)
			if +SQLCODE=0 set sourceComponentName=tmp
			
			set targetListID=""
			
			// find the target list ID by looping through all lists on the target page and pick the one that have a matching component
			set rs3=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs3.Prepare("SELECT * FROM sc_xModules.objList WHERE parent=? ORDER BY ID ASC")
			do rs3.Execute(targetPageID)
			while rs3.Next() {
				set tempListID=rs3.Get("ID")
				// find the componentName of the targetList
				&SQL(SELECT description INTO :tmp FROM sc.objComponent WHERE objData = :tempListID)
				if +SQLCODE=0,tmp=sourceComponentName set targetListID=tempListID
			}
			
			// if we didn't find a list on the target page then create it
			if targetListID="" {
				// create a list item if dont have one
				set targetListID=##class(sc.xModules.objList).add(targetPageID)
				
				// find the templateID from the target page
				set templateID=""
				&SQL(SELECT objTemplate INTO :tmp FROM sc_xModules.objPage WHERE ID = :targetPageID)
				if +SQLCODE=0 set templateID=tmp

				// create the component
				set componentID=##class(sc.objComponent).add(sourceComponentName,templateID,targetListID)
			}
			
			
			// now  we should have a target list
			if targetListID {
				
				// delete all contents on the target page
				&SQL(UPDATE sc.objData SET active=0 WHERE parent = :targetListID)

				// copy the contents
				set rs33=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
				do rs33.Prepare("SELECT ID FROM sc.objData WHERE (parent=?) AND (active=1) ORDER BY ID ASC")
				do rs33.Execute(sourceListID)
				while rs33.Next() {
					set oldObjectID = rs33.Get("ID")
					set newObjectID=##class(sc.objData).copyRecursively(oldObjectID,targetListID,targetEventID)
				}
				kill rs33
			}
		}
		//PBUG00005047 SHAHADAT : Need to clean up the multi-page dependencies; otherwise it may create cross event dependencies that are not acceptable in our system.
		//first look into cod items that were copeid and remove any dependency where the controller item is not on this same page.
		set rs5=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
		do rs5.Prepare("SELECT * FROM sc_xModules.objCodItem WHERE (parent->parent=?) AND (dependsOnPrompt>0) ORDER BY ID ASC")
		do rs5.Execute(targetPageID)
		while rs5.Next() {
			set dependsOnPrompt = rs5.Get("dependsOnPrompt")
			set itemID = rs5.Get("ID")
			set tmp=0
			&SQL(SELECT parent->parent INTO :tmp FROM sc_xModules.objCodItem WHERE ID=:dependsOnPrompt) //parent->parent is the pageID.
			if +SQLCODE=0 {
				set dependsOnPageID=tmp
				if dependsOnPageID'=targetPageID {
					&SQL(UPDATE sc_xModules.objCodItem SET dependsOnPrompt=NULL, dependsOnAlternative=NULL WHERE ID=:itemID) //dependency is not inside this page. So, remove it.	
				}
				
			}
		}
		kill rs5
		//Now look into the text items that were copied and do the same.
		set rs5=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
		do rs5.Prepare("SELECT * FROM sc_xModules.objText WHERE (parent->parent=?) AND (dependsOnPrompt>0) ORDER BY ID ASC")
		do rs5.Execute(targetPageID)
		while rs5.Next() {
			set dependsOnPrompt = rs5.Get("dependsOnPrompt")
			set itemID = rs5.Get("ID")
			set tmp=0
			&SQL(SELECT parent->parent INTO :tmp FROM sc_xModules.objText WHERE ID=:dependsOnPrompt) //parent->parent is the pageID.
			if +SQLCODE=0 {
				set dependsOnPageID=tmp
				if dependsOnPageID'=targetPageID {
					&SQL(UPDATE sc_xModules.objText SET dependsOnPrompt=NULL, dependsOnAlternative=NULL WHERE ID=:itemID) //dependency is not inside this page. So, remove it.	
				}
				
			}
		}
		kill rs5
		
		Quit "1|"_##class(shared.pCSP).translateAdmin("Page content copied successfully")
		
	} else {
		Quit "0|"_##class(shared.pCSP).translateAdmin("Source and Destination page IDs must be provided and they must not be the same page ID")
	}
]]></Implementation>
</Method>

<Method name="canPageHaveGuestCODItems">
<Description>
Can given page have guest prompts?
(If there are other pages using guest prompts, then don't allow guest prompts on this page)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Set ret=1
	
	Set showBackendPages=1
	
	Set eventID=..getEventIDfromPageID(pageID)
	
	Set langID=1
	
	&SQL(SELECT objLanguage INTO :tmp FROM setup.objEventDetails WHERE objEvent=:eventID)
	If +SQLCODE=0 Set langID=tmp
	
	// first get all pages for the event
	Set ok=##class(setup.lnkCategoryEvent).getAllRegPages(eventID,langID,showBackendPages,.allRegPages,.allRegPageIDs,.allReg)
	
	// get the category ID for the page
	set eventCategoryID=""
	
	set tmpCatID=""
	
	For {
		Set tmpCatID=$ORDER(allRegPageIDs(tmpCatID))
		If ((tmpCatID="") ! (eventCategoryID'="")) Quit
		
		set tmpPageID=""
		For {
			Set tmpPageID=$ORDER(allRegPageIDs(tmpCatID,tmpPageID))
			If ((tmpPageID="") ! (eventCategoryID'="")) Quit
			
			If tmpPageID=pageID {
				Set eventCategoryID=tmpCatID
			}
		}
	}
	
	if (eventCategoryID) {
		// now go through all other pages
		set tmpPageID=""
		For {
			Set tmpPageID=$ORDER(allRegPageIDs(eventCategoryID,tmpPageID))
			If tmpPageID="" Quit
		
			If tmpPageID'=pageID {
				set active=0
			
				// check that this other page is active
				&SQL(SELECT active INTO :tmpActive FROM sc_xModules.objPage WHERE ID=:tmpPageID)
				If +SQLCODE=0 Set active=tmpActive
			
				If (active) {
					// check if this other page has guest items
					&SQL(SELECT COUNT(*) INTO :tmp FROM sc_xModules.objCODItem WHERE parent->parent=:tmpPageID AND isGuest=1 AND active=1)
					If +SQLCODE=0 {
						If tmp>0 Set ret=0
					}
				}
			}
		}
	}
	
	Quit ret
]]></Implementation>
</Method>

<Method name="getPageID">
<Description>
Gets pageID in the correct language for an event</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,settingGroup,settingName,langID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set eventLanguage=##class(setup.objEventSetting).getParameter("system","language",eventID)
	set eventLangID=##class(shared.objLanguage).getLanguageID(eventLanguage)
	set extraBit=""
	if langID'=eventLangID set extraBit=" - "_##class(shared.objLanguage).getLanguageDesc(langID)	
	set pageID=##class(setup.objEventSetting).getParameter(settingGroup,settingName_extraBit,eventID)
	quit pageID
]]></Implementation>
</Method>

<Method name="isGuestItem">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=0,tmp=""
	set dataType=##class(sc.objData).getDataType(dataID)
	if dataType="objCODitem" {
		&SQL(SELECT isGuest INTO :tmp FROM sc_xModules.objCodItem WHERE ID = :dataID)
		if +SQLCODE=0,tmp {
			set out=1
		}
	} elseif dataType="objFileUpload" {
		&SQL(SELECT isGuest INTO :tmp FROM sc_xModules.objFileUpload WHERE ID = :dataID)
		if +SQLCODE=0,tmp {
			set out=1
		}
	}
	quit out
]]></Implementation>
</Method>

<Method name="outputFloatingMenu">
<Description>
outputs the floating menu for proweb ### SHOULD BE MOVED TO sc.floatinMenu ##</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID:%Integer,componentName:%String,menuID:%Integer,position:%String</FormalSpec>
<Implementation><![CDATA[
	set page = ##class(sc.xModules.objPage).%OpenId(pageID)
	set pageFileName = page.getFileNameWithoutPathLowerCase()
	set floatingMenu = ##class(sc.floatingMenu).createNew(pageID,componentName,position,page.allowRegistrationQuestions(componentName))
	
	if $Data(%session) {
		set %session.Data("eventsforce","backend","email or web page")="web page"
	}
	if $IsObject(page.objEvent) {
		set eventConfiguration=##class(setup.eventConfiguration).createForEventID(page.objEvent.%Id())
	}
	
	write !,"<sc"_"ript language='javasc"_"ript'>"
	write !,"HM_Array"_menuID_" = [[150,,,,,,,,,,,,,,,,,,,,1],"
	
	if page.allowRegistrationQuestions(componentName){
		write !,floatingMenu.getMenuItemJS("Registration Question")
	
	}
	if page.allowABIs() {
		write !,floatingMenu.getMenuItemJS("Bookable Item")
		if eventConfiguration.areQBIsAllowed() {
			write !,floatingMenu.getMenuItemJS("Quantity Bookable Item")
		}
	}
	if page.alllowPromptCollections() {
		write !,floatingMenu.getMenuItemJS("Reg Prompt Collections")	
	}
	if page.isSurvey() {
		set surveyGroupID = ##class(sc.objData).getParentID(pageID)
		&SQL(SELECT TOP 1 ID INTO :lastPageID FROM sc_xModules.objPage WHERE parent = :surveyGroupID ORDER BY displayOrder DESC)
		if lastPageID '= pageID {
			write !,floatingMenu.getMenuItemJS("Question")
		}
	}
	if page.isHotel() {
		write !,floatingMenu.getMenuItemJS("Question With Price")
		write !,floatingMenu.getMenuItemJS("Question With No Price")
	}
	
	write !,floatingMenu.getMenuItemJS("Text Block")
	
	if page.allowDivider(componentName) {
		write !,floatingMenu.getMenuItemJS("Divider")	
	}
	if page.allowMiscMedia() {
		write !,floatingMenu.getMenuItemJS("Menu Block")
		write !,floatingMenu.getMenuItemJS("Button")
		write !,floatingMenu.getMenuItemJS("Scrolling Image")
		write !,floatingMenu.getMenuItemJS("Flash")
		write !,floatingMenu.getMenuItemJS("YouTube Video")
	}
	if page.allowFrontendUpload() {
		write !,floatingMenu.getMenuItemJS("File Upload")
	}
	write !,"]</sc"_"ript>"
]]></Implementation>
</Method>

<Method name="outputFormCompleteMarker">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	&html<<input type="hidden" name="ef_frontend_form_complete_marker" id="ef_frontend_form_complete_marker" value=1>>
]]></Implementation>
</Method>

<Method name="isFormComplete">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set out=0
	if %request.Get("ef_frontend_form_complete_marker")=1 set out=1
	quit out
]]></Implementation>
</Method>

<Method name="moveAwardsDataToMainList">
<Description>
move all objData from list called "Bottom List" to "Main List"
allow to run without changing anything (doUpdate=0) for discovery purposes</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>doUpdate=1</FormalSpec>
<Implementation><![CDATA[

	//for each awards entry page
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set sc=rs.Prepare("SELECT objEvent,pageID FROM awards.objCategory ORDER BY CONVERT(INT,objEvent)")
	set sc=rs.Execute()
	while rs.Next() {
		set pageID=rs.Data("pageID")
		set eventID=rs.Data("objEvent")
	 	w !,"EventID:",eventID," - pageID:"_pageID
		do ..moveAwardsDataToMainListForOnePage(pageID,doUpdate)
	}
]]></Implementation>
</Method>

<Method name="moveAwardsDataToMainListForOnePage">
<Description>
move all objData from list called "Bottom List" to "Main List"</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,doUpdate=1</FormalSpec>
<Implementation><![CDATA[
	set topListID=##class(sc.methods).getListIDfromPageIDlistName(pageID,"Main List")
	if 'topListID {
		w !," no topListID for pageID:",pageID,", skipping"
		quit
	}
	
	&SQL(SELECT displayOrder INTO :tmp FROM sc.objData WHERE (parent = :topListID) AND (active = 1) ORDER BY displayOrder DESC)
	if +SQLCODE=0 {
		set topListLastDisplayOrder=+tmp
	} else {
		set topListLastDisplayOrder=0
	}
	if topListLastDisplayOrder<0 set topListLastDisplayOrder=0

	set bottomListID=##class(sc.methods).getListIDfromPageIDlistName(pageID,"Bottom List")
	if 'bottomListID {
		w !,"Error no bottomListID for pageID:",pageID
		quit
	}
 	set count=0

	//get all dataID with parent=:bottomListID order by displayOrder
	set rs2=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set sc=rs2.Prepare("SELECT ID FROM sc.objData WHERE (parent = ?) AND (active = 1) ORDER BY displayOrder")
	set sc=rs2.Execute(bottomListID)
	while rs2.Next() {
		set dataID=rs2.Data("ID")
	 	set count=count+1
	 	set objData=##class(sc.objData).%OpenId(dataID)
	 	do objData.parentSetObjectId(topListID)
	 	set objData.displayOrder=topListLastDisplayOrder+count
	 	w !?5,"dataID:"_dataID
	 	w " "_$S(doUpdate:"updated",1:"found (not updated)")_" "
	 	w "with parent=",topListID," and displayOrder=",topListLastDisplayOrder+count
		if doUpdate {
			set sc=objData.%Save()
			if 'sc W " save returned error:"_$SYSTEM.Status.DisplayError(sc)
		}
		kill objData
	}
		
	quit
]]></Implementation>
</Method>
</Class>


<Class name="sc.objComponent">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: sc.objComponent.CLS/EV.8
;vc; Component: CLS.sc.objComponent
;vc;  Location: LargeDev
;vc; Date/Time: 10-Nov-16 11:27
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>sc.objComponent.CLS/EV.8</td><td>CLS.sc.objComponent</td><td>LargeDev</td><td style='white-space: nowrap;'>10-Nov-16 11:27</td><td>FredG</td></tr></table>
]]></Description>
<ClassType>persistent</ClassType>
<ProcedureBlock>1</ProcedureBlock>
<Super>%Library.Persistent,shared.timeStamp</Super>
<TimeChanged>64301,56443.320027</TimeChanged>
<TimeCreated>58926,57258</TimeCreated>
<Inheritance>right</Inheritance>

<Parameter name="EXTENTSIZE">
<Default>3689</Default>
</Parameter>

<Property name="description">
<Type>%Library.String</Type>
<Parameter name="MAXLEN"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="objData">
<Type>sc.objData</Type>
<Cardinality>one</Cardinality>
<Inverse>objComponents</Inverse>
<Relationship>1</Relationship>
</Property>

<Property name="objTemplate">
<Type>sc.objTemplate</Type>
<Cardinality>one</Cardinality>
<Inverse>objComponents</Inverse>
<Relationship>1</Relationship>
</Property>

<Property name="width">
<Type>%Library.Integer</Type>
<InitialExpression>610</InitialExpression>
<Parameter name="MINVAL" value="10"/>
</Property>

<Property name="componentType">
<Type>%String</Type>
<Parameter name="MAXLEN" value="255"/>
<Parameter name="VALUELIST" value=",text,list,listWithQuestionsRegistration,listWithQuestions,listOfSingleElement"/>
</Property>

<Index name="descriptionIndex">
<Description>
Index for property description</Description>
<Properties>description</Properties>
</Index>

<Index name="objDataIndex">
<Properties>objData</Properties>
</Index>

<Method name="add">
<ClassMethod>1</ClassMethod>
<FormalSpec>description:%String,templateID:%String,listID:%String,componentType:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	&SQL(INSERT INTO sc.objComponent (description, objTemplate, objData, componentType) VALUES (:description, :templateID, :listID, :componentType))
	
	if +SQLCODE = 0 {
		return %ROWID
	} else {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE, "Failed to add objComponent of type: "_componentType)	
	}
]]></Implementation>
</Method>

<Method name="getComponentName">
<ClassMethod>1</ClassMethod>
<FormalSpec>listID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT description INTO :tmp FROM sc.objComponent WHERE objData = :listID)	
	if +SQLCODE=0 {
		return tmp
	} else {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$G(%msg))
	}
]]></Implementation>
</Method>

<Method name="getDescriptionForDisplay">
<Implementation><![CDATA[
	if $e($ZCVT(..description,"L"),1,6)="header" {
		return "Heading"_$e(..description,7,$l(..description))	
	} elseif $ZCVT(..description,"L")="page header" {
		return "Page Heading"
	}
	return ..description
]]></Implementation>
</Method>

<Method name="getEditorURLForTagText">
<Implementation><![CDATA[
	set objPage=..objData.parent
	if ##class(sc.xModules.objText).canTextBlockUseFullMoxie(objPage,..description) {
		set editorPage="textDetailsMoxie.csp"
	} else {
		set editorPage="textHeaderMoxie.csp"
	}
	
	set tmpDataID=..objData.%Id()
	if 'tmpDataID {
		set tmpDataID="NEW"	
	}
	
	set url=objPage.applicationPath()_"/backend/proweb/"_editorPage
	set url=##class(EF.htmlGenerator).addParameterToURL(url,"dataID",tmpDataID)
	set url=##class(EF.htmlGenerator).addParameterToURL(url,"templateURL",objPage.objTemplate.filename)
	set url=##class(EF.htmlGenerator).addParameterToURL(url,"parent",objPage.%Id())
	set url=##class(EF.htmlGenerator).addParameterToURL(url,"componentName",..description)
	set url=##class(EF.htmlGenerator).addParameterToURL(url,"templateID",objPage.objTemplate.%Id())
	
	return url
]]></Implementation>
</Method>

<Query name="qComponentsByPageID">
<Type>%SQLQuery</Type>
<FormalSpec>pageID:%Integer</FormalSpec>
<SqlQuery><![CDATA[	SELECT description,objData AS listID,objData->dataType, componentType As listType 
	FROM  sc.objComponent 
	where objData->parent = :pageID]]></SqlQuery>
</Query>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^sc.objComponentD</DataLocation>
<DefaultData>objComponentDefaultData</DefaultData>
<IdLocation>^sc.objComponentD</IdLocation>
<IndexLocation>^sc.objComponentI</IndexLocation>
<StreamLocation>^sc.objComponentS</StreamLocation>
<ExtentSize>3689</ExtentSize>
<Data name="objComponentClassName">
<Attribute>%%CLASSNAME</Attribute>
<Structure>node</Structure>
<Subscript>0</Subscript>
</Data>
<Data name="objComponentDefaultData">
<Value name="1">
<Value>xCRstamp</Value>
</Value>
<Value name="2">
<Value>xMOstamp</Value>
</Value>
<Value name="3">
<Value>description</Value>
</Value>
<Value name="4">
<Value>objData</Value>
</Value>
<Value name="5">
<Value>objTemplate</Value>
</Value>
<Value name="6">
<Value>width</Value>
</Value>
<Value name="7">
<Value>xCRuserID</Value>
</Value>
<Value name="8">
<Value>xMOuserID</Value>
</Value>
<Value name="9">
<Value>type</Value>
</Value>
<Value name="10">
<Value>componentType</Value>
</Value>
</Data>
<Property name="description">
<Selectivity>14.2857%</Selectivity>
</Property>
<Property name="objData">
<Selectivity>1</Selectivity>
</Property>
<Property name="objTemplate">
<Selectivity>5.5554%</Selectivity>
</Property>
<Property name="width">
<Selectivity>49.9999%</Selectivity>
</Property>
<Property name="xCRstamp">
<Selectivity>0.6236%</Selectivity>
</Property>
<Property name="xCRuserID">
<Selectivity>7.6923%</Selectivity>
</Property>
<Property name="xMOstamp">
<Selectivity>0.1678%</Selectivity>
</Property>
<Property name="xMOuserID">
<Selectivity>5.5554%</Selectivity>
</Property>
</Storage>
</Class>


<Class name="sc.objData">
<Description><![CDATA[
Please note that this class will be the super class of all underlying data items.
<!-- ;vc;
;vc;    Object: sc.objData.CLS/EV.38
;vc; Component: CLS.sc.objData
;vc;  Location: LargeDev
;vc; Date/Time: 21-Dec-16 10:30
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>sc.objData.CLS/EV.38</td><td>CLS.sc.objData</td><td>LargeDev</td><td style='white-space: nowrap;'>21-Dec-16 10:30</td><td>FredG</td></tr></table>
]]></Description>
<ClassType>persistent</ClassType>
<IncludeCode>EF.common.macros</IncludeCode>
<ProcedureBlock>1</ProcedureBlock>
<Super>%Library.Persistent,shared.timeStamp</Super>
<TimeChanged>64287,50701.53939</TimeChanged>
<TimeCreated>59148,67793</TimeCreated>
<Inheritance>right</Inheritance>

<Property name="objAuditTrails">
<Type>sc.objAuditTrail</Type>
<Cardinality>many</Cardinality>
<Inverse>objData</Inverse>
<Relationship>1</Relationship>
</Property>

<Parameter name="EXTENTSIZE">
<Description>
for cutin and padsting in the navigation tree</Description>
<Default>5000</Default>
</Parameter>

<Property name="active">
<Type>%Library.Boolean</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="creator">
<Description>
Who created this version of the data item.</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="200"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="dataType">
<Description>
Used for identifying the class of the object withour having to call
cache mysterious APIs.</Description>
<Type>%Library.String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="displayOrder">
<Description>
A display order number has to be set at creation time. It can then be
swapped for the displayorder number of adjacent data item.
This controls the order which the data is displayed in the backend data tree.</Description>
<Type>%Library.Integer</Type>
</Property>

<Property name="nextVersion">
<Description>
Pointer to the next version of this data item. Not mandatory.</Description>
<Type>sc.objData</Type>
</Property>

<Property name="objComponents">
<Type>sc.objComponent</Type>
<Cardinality>many</Cardinality>
<Inverse>objData</Inverse>
<Relationship>1</Relationship>
</Property>

<Property name="objStep">
<Type>sc.objStep</Type>
<Cardinality>one</Cardinality>
<Inverse>objDatas</Inverse>
<Relationship>1</Relationship>
</Property>

<Property name="parent">
<Description>
Points to the parent of this data item. This makes up the hiarachy.
It has to be read by a recursive method to build up the tree structure.</Description>
<Type>sc.objData</Type>
</Property>

<Property name="previousVersion">
<Description>
Poiter to the previous version of this data item.
Note that this can be chain of many versions linked together.</Description>
<Type>sc.objData</Type>
</Property>

<Property name="publishAt">
<Description>
If the object is to be published at a future point of time, use this prop.</Description>
<Type>%Library.TimeStamp</Type>
</Property>

<Property name="sourceID">
<Description>
if the object is a re-use of another object, indicate the ID of the orginal object here</Description>
<Type>sc.objData</Type>
</Property>

<Property name="beforeItem">
<Description>
to override the template value - blank = nothing</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="100"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="afterItem">
<Description>
to override the template value - blank = nothing</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="100"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="beforeRow">
<Description>
not used at present</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="100"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="afterRow">
<Description>
not used at present</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="100"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="objEvent">
<Type>setup.objEvent</Type>
<SqlComputeCode>set {objEvent} = ..getEventID({parent})</SqlComputeCode>
<SqlComputed>1</SqlComputed>
<SqlComputeOnChange>parent</SqlComputeOnChange>
</Property>

<Index name="objEventIndex">
<Properties>objEvent</Properties>
</Index>

<Index name="sourceIDIndex">
<Properties>sourceID</Properties>
</Index>

<Index name="dataTypeIndex">
<Description>
Index for property dataType</Description>
<Properties>dataType</Properties>
</Index>

<Index name="displayOrderIndex">
<Description>
Index for property displayOrder</Description>
<Properties>displayOrder</Properties>
</Index>

<Index name="nextVersionIndex">
<Description>
Index for property nextVersion</Description>
<Properties>nextVersion</Properties>
</Index>

<Index name="parentIndex">
<Description>
Index for property parent</Description>
<Properties>parent</Properties>
</Index>

<Index name="previousVersionIndex">
<Description>
Index for property previousVersion</Description>
<Properties>previousVersion</Properties>
</Index>

<Index name="publishAtIndex">
<Description>
Index for property publishAt</Description>
<Properties>publishAt</Properties>
</Index>

<Method name="getEventID">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set eventID=""
	&SQL(SELECT objEvent,parent->objEvent,parent->parent->objEvent INTO :thisEvent,:parentEvent,:grandParentEvent FROM sc.objData WHERE ID = :dataID)
	if +SQLCODE=0 {
		set eventID=$Select(thisEvent:thisEvent,parentEvent:parentEvent,grandParentEvent:grandParentEvent,1:"")	
	}
	return eventID
]]></Implementation>
</Method>

<Method name="getDataType">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 set ok=""
 
 &SQL(SELECT dataType INTO :tmp FROM sc.objData WHERE ID = :dataID)
 if +SQLCODE=0 set ok=tmp
 
 quit ok
]]></Implementation>
</Method>

<Method name="findLastVersion">
<Description>
pass in a objectID of any age and this will return the ID of the latest version, future or current</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String="",version:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set lastStep=##class(sc.objStep).getFinalLevel()
	set out="",parent="",myDisplayOrder="",dataType=""
	for  {
		&SQL(SELECT nextVersion,objStep->stepOrder INTO :tmp1,:tmp2 FROM sc.objData WHERE ID = :dataID)
		if +SQLCODE=0 {
			set nextVersion=tmp1,stepOrder=tmp2
		} else {
			quit
		}
		
		// quit if there isn't a future version
		if nextVersion="" quit
		
		if (version="current") {
			// quit if the next item is unpublished (this is the last published one)
			set nextStepOrder=""
			&SQL(SELECT objStep->stepOrder INTO :tmp1 FROM sc.objData WHERE ID = :nextVersion)	
			if +SQLCODE=0 set nextStepOrder=tmp1
			if nextStepOrder'=lastStep quit
		}
		
		// jump to next one in chain
		set dataID=nextVersion		
	}
	
	quit dataID
]]></Implementation>
</Method>

<Method name="applicationPath">
<Description>
Returns the part of the URL which is the CSP application path</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 // this method is called by all the tags. It's put here because this page compiles before the tag pages.
 if $Data(%request) {
 	return $piece(%request.URL,"/",1,$G(^pathDepth,2))
 } else {
	return "dummyCSPAppPath"
 }
]]></Implementation>
</Method>

<Method name="deleteRecursively">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",reallyDelete=0</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 set ok=""
 //  find all its children
 set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 do rs.Prepare("SELECT ID FROM sc.objData WHERE parent=?")
 do rs.Execute(dataID)
 while rs.Next() {
 	// exterminate the entire family, top down
 	set ok=##class(sc.objData).deleteRecursively(rs.Get("ID"),reallyDelete)		
 }
 if reallyDelete {
	set ok=..%DeleteId(dataID)
 } else {
	 set objData=##class(sc.objData).%OpenId(dataID)
 	set objData.active=0
 	set ok=objData.%Save()
 	kill objData
 }
 
 quit ok
]]></Implementation>
</Method>

<Method name="updateObjEventRecursively">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,eventID</FormalSpec>
<Implementation><![CDATA[
	 do ..updateObjEvent(dataID,eventID)
	 set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	 do rs.Prepare("SELECT ID FROM sc.objData WHERE parent=?")
	 do rs.Execute(dataID)
	 while rs.Next() {
	 	do ..updateObjEventRecursively(rs.Get("ID"),eventID)		
	 }
]]></Implementation>
</Method>

<Method name="updateObjEvent">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,eventID</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc.objData SET objEvent = :eventID WHERE ID = :dataID)
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalException).%New("updating sc.ObjData with objEvent failed")
]]></Implementation>
</Method>

<Method name="updateParent">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,parentID</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc.objData SET parent = :parentID WHERE ID = :dataID)
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$G(%msg))
]]></Implementation>
</Method>

<Method name="copyRecursively">
<Description>
this will copy a tree of data items. parentID initially send in as NULL as it is only used internally
do NOT pass in a parentID, it's only for internal use!</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",parentID:%Library.String="",newEventID="",userID=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
	set ok=""
	// get the type of object	
	set objData=##class(sc.objData).%OpenId(dataID)
	set objDataNew=objData.%ConstructClone(0)
	// if we have a parentID then it is a new parent otherwise it's the top level data item so same parent
	if parentID do objDataNew.parentSetObjectId(parentID)
	do objDataNew.nextVersionSetObjectId("")
	do objDataNew.previousVersionSetObjectId("")
	do objDataNew.sourceIDSetObjectId("")
	if newEventID {
		if (objData.dataType="objGroup") ! (objData.dataType="objPage") {
			do objDataNew.objEventSetObjectId(newEventID)
		}
	}
	set objDataNew.creator="autocopy"
	// if this is the top level starting group or page then increment the displayorder
	if 'parentID,(objData.dataType="objGroup")!(objData.dataType="objPage") {
		set tmpParentID=objDataNew.parent.%Id()
		// set the displayOrder to last
		set displayOrder=""
		&SQL(SELECT displayOrder INTO :displayOrder FROM sc.objData WHERE (parent=:tmpParentID) ORDER BY displayOrder DESC)
		set objDataNew.displayOrder=(displayOrder+1)
	}
	set ok=objDataNew.%Save()
	
	if 'ok quit ok
	set dataNewID=objDataNew.%Id()
	
	// store old and new dataID's - needed in eventCopy.csp to re-link location and item pages after copy
	if $d(%session) {
		set ^xCOPYAUDIT(%session.SessionId,dataID)=dataNewID
	} elseif $G(userID) {
		set ^xCOPYAUDIT(userID,dataID)=dataNewID
	} else {
		set ^xCOPYAUDIT("unknown",dataID)=dataNewID
	}
	// the objects with relationships would've also been cloned so that new components are auto created
	// but have to remove some of the objects pointing to me that were auto created
	&SQL(DELETE FROM sc.objAuditTrail WHERE objData = :dataNewID)
	kill objDataNew
	kill objData
	
	//  find all its children
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT ID FROM sc.objData WHERE (parent=?) AND (active=1)")
	do rs.Execute(dataID)
	while rs.Next() {
		// copy the entire family
		// first check to see if this is the most recent version as we only want to copy
		// the latest one not all the old ones
		set latestVersionID=##class(sc.objData).findLastVersion(rs.Data("ID"),"current")
		if latestVersionID=rs.Data("ID") set ok=##class(sc.objData).copyRecursively(rs.Data("ID"),dataNewID,newEventID)
	}
	
	quit dataNewID
]]></Implementation>
</Method>

<Method name="getDependsOnPrompt">
<Description>
Implemented in some of the sub classes. </Description>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ""
]]></Implementation>
</Method>

<Method name="findChildren">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[dataID:%Library.String="",&array:%Library.String=""]]></FormalSpec>
<Implementation><![CDATA[
 set ok=""
 //  find all its children
 set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 do rs.Prepare("SELECT ID FROM sc.objData WHERE (parent=?) AND (active=1)")
 do rs.Execute(dataID)
 while rs.Next() {
 	set array(rs.Get("ID"))=""
 	do ..findChildren(rs.Get("ID"),.array)		
 }
]]></Implementation>
</Method>

<Method name="findChildrenPages">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[dataID:%Library.String="",&array:%Library.String=""]]></FormalSpec>
<Implementation><![CDATA[
 set ok=""
 //  find all its children
 set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 do rs.Prepare("SELECT ID,dataType FROM sc.objData WHERE (parent=?) AND (active=1)")
 do rs.Execute(dataID)
 while rs.Next() {
 	if (rs.Get("dataType")="objGroup")!(rs.Get("dataType")="objPage") {
 		if rs.Get("dataType")="objPage" set array(rs.Get("ID"))=rs.Get("dataType")
 			do ##class(sc.objData).findChildrenPages(rs.Get("ID"),.array)		
 	}
 }
]]></Implementation>
</Method>

<Method name="getPageID">
<Description>
Returns the ID of the page where the passed in data object resides.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 set pageID=""
 set parentID="",tmpID=dataID
 
 for  {
 	set dataType=""
 	// get my class
 	&SQL(SELECT dataType INTO :tmp FROM sc.objData WHERE ID = :tmpID)
 	if +SQLCODE=0 set dataType=tmp
 	
 	set pageID=tmpID 
 	if (dataType="objPage")!(dataType="objSurveyPage") quit
 	// get my parent for next loop
 	&SQL(SELECT parent INTO :tmpID FROM sc.objData WHERE ID = :tmpID) 
 	if +SQLCODE'=0 quit
 	
 }
 
 quit pageID
]]></Implementation>
</Method>

<Method name="getPath">
<Description>
returns a string of the texctual path to the item passed in</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",hideLast:%Library.Boolean=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 set (out,last)=""
 if '##class(sc.objData).%ExistsId(dataID) quit ""
 // get the last name
 if 'hideLast {
 	set objData=..%OpenId(dataID)
 	if (objData.dataType="objImage") {
	 	set last=objData.fileName
	 } elseif objData.dataType="objList" {
	 	set last=""
	 } else {
	 	set last=objData.description
	 }
	 do objData.%Close()
 }
 // find the tree in from the bottom up
 while dataID'="" {
 	&SQL(SELECT parent INTO :dataID FROM sc.objData WHERE ID = :dataID)
 	if ..%ExistsId(dataID) {
 		set objData=..%OpenId(dataID)
 		if objData.dataType="objImage" {
 			set out=out_"/"_objData.fileName
 		} elseif objData.dataType="objList" {
 			//
 		} else {
 			set out=out_"/"_objData.description
 		}
	
		 do objData.%Close()
 	} else {
	 	set dataID=""	
 	}
 }
 // and now reverse the string
 set tmp=""
 for i=$l(out,"/"):-1:1 {
 	set tmp=tmp_"/"_$p(out,"/",i)
 }
 set out=tmp_last
 quit out
]]></Implementation>
</Method>

<Method name="getPathInTree">
<Description>
Same as get path but specialised for the tree redrawing
retusn the items like description1|ID1~description2|id2~...</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",hideLast:%Library.Boolean=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 set (out,last)=""
 if '##class(sc.objData).%ExistsId(dataID) quit ""
 // get the last name
 if 'hideLast {
 set objData=..%OpenId(dataID)
 if objData.dataType="objImage" {
	 set last=objData.fileName
 } elseif objData.dataType="objList" {
	 set last=""
 } else {
	 set last=objData.description
 }
	 do objData.%Close()
 }
 // find the tree in from the bottom up
 while dataID'="" {
 	&SQL(SELECT parent INTO :dataID FROM sc.objData WHERE ID = :dataID)
 	if ..%ExistsId(dataID) {
 		set objData=..%OpenId(dataID)
 			if objData.dataType="objImage" {
 				set out=out_"/"_objData.fileName
 			} elseif objData.dataType="objList" {
 				//
 			} else {
 				set out=out_"~"_objData.description_"|"_dataID
 		}
 		do objData.%Close()
	 }
 }
 // and now reverse the string
 set tmp=""
 for i=$l(out,"~"):-1:1 {
 	set tmp=tmp_"~"_$p(out,"~",i)
 }
 set out=tmp_last
 // remove the first delimiter
 set out=$E(out,2,9999)
 quit out
]]></Implementation>
</Method>

<Method name="inMail">
<Description>
Returns true if the passed in object is used in a template that has the "isMail" flag set.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String=""</FormalSpec>
<ReturnType>%Library.Boolean</ReturnType>
<Implementation><![CDATA[
 set pageID="",isMail="NOT FOUND"
 // first, check if the passed in item is a page
 if ##class(sc.objData).%ExistsId(dataID) {
	 set objData=##class(sc.objData).%OpenId(dataID)
	 if objData.%ClassName(0)["objPage" set pageID=dataID
	 do objData.%Close()
 } 	
 if pageID="" {
	 // walk up the tree and look for my parent page
	 while (pageID="")&(dataID'="") {
		 set tmp=""
		 &SQL(SELECT parent INTO :tmp FROM sc.objData WHERE ID = :dataID)
		 if SQLCODE=0 {
			 set dataID=tmp
			 if ##class(sc.objData).%ExistsId(dataID) {
				 set objData=##class(sc.objData).%OpenId(dataID)
				 if objData.%ClassName(0)["objPage" set pageID=dataID
				 do objData.%Close()
			 }
		 } else {
			 set dataID=""
		 }
	 }
 }
 // ok, we found the parent page, is it using a mail template or not
 if pageID'="" {
	 set tmp=""
	 &SQL(SELECT objTemplate->isMail INTO :tmp FROM sc_xModules.objPage WHERE ID = :pageID)
	 if SQLCODE=0 set isMail=+tmp
 }
 quit isMail
]]></Implementation>
</Method>

<Method name="inStatic">
<Description>
Returns true if the passed in object is used in a template that has the "isStatic" (for static html pages) flag set.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String=""</FormalSpec>
<ReturnType>%Library.Boolean</ReturnType>
<Implementation><![CDATA[
 set pageID="",isStatic="NOT FOUND"
 // first, check if the passed in item is a page
 if ##class(sc.objData).%ExistsId(dataID) {
	 set objData=##class(sc.objData).%OpenId(dataID)
	 if objData.%ClassName(0)["objPage" set pageID=dataID
	 do objData.%Close()
 } 	
 if pageID="" {
	 // walk up the tree and look for my parent page
	 while (pageID="")&(dataID'="") {
		 set tmp=""
		 &SQL(SELECT parent INTO :tmp FROM sc.objData WHERE ID = :dataID)
		 if SQLCODE=0 {
			 set dataID=tmp
			 if ##class(sc.objData).%ExistsId(dataID) {
				 set objData=##class(sc.objData).%OpenId(dataID)
				 if objData.%ClassName(0)["objPage" set pageID=dataID
				 do objData.%Close()
			 }
		 } else {
			 set dataID=""
		 }
	 }
 }
 // ok, we found the parent page, is it using a static template or not
 if pageID'="" {
	 set tmp=""
	 &SQL(SELECT objTemplate->isStatic INTO :tmp FROM sc_xModules.objPage WHERE ID = :pageID)
	 if SQLCODE=0 set isStatic=+tmp
 }
 quit isStatic
]]></Implementation>
</Method>

<Method name="moveChain">
<Description>
Moves an object upwards or downwards in the displayOrder. Pass in "up" or "down".
This is the same as the normal move but this version takes all the items that share a displayorder and swaps them 
with all the adjacent items. This is to make sure that all previous and future version have the same 
displayOrder.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ID:%Library.String="",dir:%Library.String=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 Set adjacent=""
 // tests
 If '..%ExistsId(ID) Quit 0
 set dir=$ZCVT(dir,"L")
 if "up,down,top,bottom"'[dir quit 0
 if dir="" quit 0
 // Who is my parent
 Set dataID=""
 &SQL(SELECT parent INTO :parentID FROM sc.objData WHERE ID = :ID)
 // First, what's my own display order?
 &SQL(SELECT displayOrder INTO :myPos FROM sc.objData WHERE ID = :ID)
 
 // handle tops and bottoms first 
 if "top,bottom"[dir {
 	// find all object before (or after) me
 	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 	if (dir="top") {
	 	set query="SELECT ID,displayOrder FROM sc.objData WHERE (parent=?) AND (displayOrder < ?) "
 	} else {
	 	set query="SELECT ID,displayOrder FROM sc.objData WHERE (parent=?) AND (displayOrder > ?) "
 	}
 	do rs.Prepare(query)
 	do rs.Execute(parentID,myPos)
 	while rs.Next() {
 		// increment (or decrement) them

 		set myID=rs.Get("ID")
 		set tmpDisplayOrder=rs.Get("displayOrder")
 		if dir="top" set tmpDisplayOrder=tmpDisplayOrder+1
 		if dir="bottom" set tmpDisplayOrder=tmpDisplayOrder-1 		
 		&SQL(UPDATE sc.objData SET displayOrder=:tmpDisplayOrder WHERE ID = :myID)
 		if SQLCODE'=0 w 1/0 // could not move item
 	}
 	// and now move myself 
 	set tmpDisplayOrder=""
 	if dir="top" set tmpDisplayOrder=1
 	if dir="bottom" {
 		&SQL(SELECT TOP 1 displayOrder INTO :tmpDisplayOrder FROM sc.objData WHERE  (parent = :parentID ) ORDER BY displayOrder DESC)
 		set tmpDisplayOrder=tmpDisplayOrder+1
 	}
 	&SQL(UPDATE sc.objData SET displayOrder=:tmpDisplayOrder WHERE ID = :ID)
 	quit 1
 }
 // Find previous displayOrder if we moving up
 If dir="up" {
 	&SQL(	SELECT displayOrder INTO :adjacent 
 	FROM sc.objData
 	WHERE 	(displayOrder < :myPos) AND
 	(parent = :parentID) AND (active=1)
 	ORDER BY displayOrder DESC)
 }
 // find next displayOrder if we are moving down
 If dir="down" {
 	&SQL(	SELECT displayOrder INTO :adjacent 
 	FROM sc.objData
 	WHERE 	(displayOrder > :myPos) AND
 	(parent = :parentID) AND (active=1)
 	ORDER BY displayOrder)
 }
 If adjacent'="" {
 	// Swap the displayOrder betwixt the two lines of objects
 	// first the adjacent ones and then my own blood line
 	for type="adjacent","myPos" {
 		set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 		set query="SELECT ID,parent FROM sc.objData WHERE (parent=?) AND (displayOrder=?)"
 		do rs.Prepare(query)
 		do rs.Execute(parentID,@type)
 		while rs.Next() { // put all ID into two arrays
 			if type="adjacent" set adjacent(rs.Get("ID"))=""
 			if type="myPos" set myPos(rs.Get("ID"))=""
 		}
 	do rs.%Close()
 }
 set m=""
 for  {
 	set m=$O(adjacent(m))	
 	if m="" quit

 	&SQL(UPDATE sc.objData SET displayOrder=:myPos WHERE ID = :m)
 }
 set m=""
 for  {
 	set m=$O(myPos(m))	
 	if m="" quit

 	&SQL(UPDATE sc.objData SET displayOrder=:adjacent WHERE ID = :m)
 }
 Quit 1
 } else {
 	quit 0
 }
]]></Implementation>
</Method>

<Method name="approve">
<Description>
Use this to approve an object.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",targetLevel:%Integer=""</FormalSpec>
<ReturnType>%Library.Boolean</ReturnType>
<Implementation><![CDATA[
 set ok=1
 set finalLevel=##class(sc.objStep).getFinalLevel()
 
 // make the component point to me if I'm a final level (published)
 if targetLevel=finalLevel {
 	// find the previous version ID
 	set previousID=""
 	&SQL(SELECT previousVersion INTO :previousID FROM sc.objData WHERE ID = :dataID)
 	if +SQLCODE=0 { // opposite of cache status, 0=ok
 		// Find all components that point to the current version object and make it point to this version object
 		&SQL(UPDATE sc.objComponent SET objData = :dataID WHERE objData = :previousID)
 	}
 }
 set stepID=""
 &SQL(SELECT ID INTO :stepID FROM sc.objStep WHERE stepOrder = :targetLevel )
 if +SQLCODE=0 { 
 	set objData=##class(sc.objData).%OpenId(dataID)
 	do objData.objStepSetObjectId(stepID)
 	do objData.%Save()
 	do objData.%Close()
 }
 // compile page into static HTML if applicable
 if targetLevel=finalLevel {
	 if ##class(setup.objSetting).getParameter("system","static html")=1 {
	 	set pageID=##class(sc.xModules.objPage).getPageID(dataID)
		set app=##class(sc.objData).applicationPath()
	 }
 }	
 // audit trail
 set levelDesc=""
 &SQL(SELECT description INTO :tmp FROM sc.objStep WHERE stepOrder = :targetLevel)
 if +SQLCODE=0 set levelDesc=tmp
 
 set comments="approved to level: "_targetLevel_" - "_levelDesc
 if targetLevel=finalLevel set comments=comments_" (published to live)"
 &SQL(INSERT INTO sc.objAuditTrail (description,objData,objUser) VALUES (:comments,:dataID,:userID))
 
 // make sure we remove any auto publishing flag or it will looop - May2006
 &SQL(SELECT publishAt INTO :tmp FROM sc.objData WHERE ID = :dataID) 
 if +SQLCODE=0,tmp'="" {
	&SQL(UPDATE sc.objData SET publishAt = NULL WHERE ID = :dataID)	 
 } 
  
 quit ok
]]></Implementation>
</Method>

<Method name="sendApprovalEmail">
<Description>
Send notification emails to the corresponding email addresses associated with the current approval level</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String="",targetLevel:%String=""</FormalSpec>
<Implementation><![CDATA[	// disused
]]></Implementation>
</Method>

<Method name="deleteItem">
<Description>
Method for deleting an item in a list</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String=""</FormalSpec>
<Implementation><![CDATA[
	set ok = ""
	if (dataID '="") {
		set previousVersion=""
		set codItemName=""
		&SQL(SELECT objItemName->description INTO :tmp FROM sc_xModules.objCODitem WHERE ID = :dataID)
		if +SQLCODE=0 { 
			set codItemName=tmp
			//clean up category dependent pricing if exist.
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs.Prepare("SELECT ID FROM cod.objAlternativeExtras WHERE codItemID=?")
			do rs.Execute(dataID)
			while rs.Next() {
				set alternativeExtrasID = rs.Get("ID")
				//delete all items in links.lnkCategoryItemBasketItem.CLS reated to the found alternative extras.
				&SQL(DELETE FROM links.lnkCategoryItemBasketItem WHERE objAlternativeExtras=:alternativeExtrasID)
				&SQL(UPDATE cod.objAlternativeExtras SET priceByAttendeeCategory=0 WHERE ID=:alternativeExtrasID)
			}
			
			set pageID=##class(sc.objData).getPageID(dataID)
			&SQL(UPDATE sc_xModules.objCODitem SET dependsOnAlternative='', dependsOnPrompt='' WHERE (dependsOnPrompt = :dataID)) //Clear all the dependency on this item. SHAHADAT 23rd Sep 2008
			&SQL(UPDATE sc_xModules.objText SET dependsOnAlternative='', dependsOnPrompt='' WHERE (dependsOnPrompt = :dataID)) //Clear all the text block dependencies on this item. pjc 10 November 2009
			&SQL(UPDATE setup.lnkCategoryEvent
				SET dependsOnAlternative = NULL ,dependsOnPrompt = NULL ,dependsOnPromptPageID = NULL, dependsOnObjItemName = NULL
				WHERE dependsOnPromptPageID = :pageID AND %SQLUPPER(dependsOnPrompt) = %SQLUPPER(:codItemName)
			)
		}

		set ok=1
		// loop on all version of this item
		while dataID'="" {
			set previousVersion=""
			&SQL(SELECT previousVersion INTO :previousVersion FROM sc.objData WHERE ID = :dataID)
			if +SQLCODE=0 {

				// Fred July 2004 - deactivate rather than delete stuff.
				&SQL(UPDATE sc.objData SET active = 0 WHERE ID = :dataID)
				
				if dataID'=previousVersion set dataID=previousVersion		
			}
		}
	}
	quit ok
]]></Implementation>
</Method>

<Method name="reuseLogic">
<Description>
this method replaces and consolidates the onPreHttp scripts on textDetails.csp, imageDetails.csp and fileDetails.csp</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataType:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set dataID=%request.Get("dataID")
	set orgDataID=%request.Get("orgDataID")
	if dataID="NEW" set dataID=orgDataID
	
	// is this object linked to another?
	set sourceID=""
	&SQL(SELECT sourceID INTO :tmp FROM sc.objData WHERE ID = :dataID)
	if +SQLCODE=0 set sourceID=tmp
	// find the latest version
	set latestSourceID=##class(sc.objData).findLastVersion(sourceID,"future")
	
	
	// unlink an item
	if %request.Get("unlink")="true" {
		set sourceID=""
		
		// open new item	
		set tmpID=$S(dataID:dataID,orgDataID:orgDataID,1:"")
		set objData=##class(sc.objData).%OpenId(tmpID)
		do objData.sourceIDSetObjectId("")
		
		// open old item
		set orgObj=##class(sc.objData).%OpenId(latestSourceID)
				
		// find latest data and copy it to new item
		if dataType="objText" {
			set objData.description=orgObj.description
			set objData.rawText=orgObj.rawText
		
		} elseif dataType="objImage" {
			
			set objData.fileName=orgObj.fileName
			set objData.mouseOverFileName=orgObj.mouseOverFileName
			do objData.fileStream.CopyFrom(orgObj.fileStream)
			do objData.mouseOverFileStream.CopyFrom(orgObj.mouseOverFileStream)
			set objData.altText=orgObj.altText
			set objData.titleText=orgObj.titleText
			set objData.border=orgObj.border
			set objData.width=orgObj.width
			set objData.height=orgObj.height
			set objData.popupWidth=orgObj.popupWidth
			set objData.popupHeight=orgObj.popupHeight
			set objData.popupScrollbars=orgObj.popupScrollbars
			set objData.URL=orgObj.URL
			set objData.target=orgObj.target
		
		}
		kill orgObj	
		do objData.%Save()
		kill objData
	}
	// are any other objects linked to this?
	if (dataID="")!(dataID="NEW") if orgDataID'="" set dataID=orgDataID
	set objectIsReused=0
	&SQL(SELECT ID INTO :tmp FROM sc.objData WHERE (sourceID = :dataID)  AND (active=1))
	if +SQLCODE=0 set objectIsReused=1
	set %session.Data("objectIsReused")=objectIsReused
	// show warning if we are redirecting to a original object
	if ((sourceID)!(objectIsReused))&(%request.Get("skipWarning")'=1) {
		set %session.Data("returnPage")=%request.PageName
		set %response.ServerSideRedirect="reUseWarning.csp"
		quit 0
	} else {
	
		quit 1
	}
]]></Implementation>
</Method>

<Method name="getParentID">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=""
	&SQL(SELECT parent INTO :tmp FROM sc.objData WHERE ID = :dataID)	
	if +SQLCODE=0 set out=tmp
	quit out
]]></Implementation>
</Method>

<Method name="hasChildren">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set out=0
	&SQL(SELECT ID INTO :tmp FROM sc.objData WHERE (active=1 AND parent = :dataID))
	if +SQLCODE=0 set out=1
	
	quit out
]]></Implementation>
</Method>

<Method name="getDisplayOrder">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data=""
	&SQL(SELECT displayOrder INTO :tmp FROM sc.objData	WHERE (active=1 AND ID = :dataID))
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="getQuestionPrompt">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,languageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if ##class(sc.objData).getDataType(dataID)="objFileUpload" {
		set questionPrompt=##class(sc.xModules.objFileUpload).getQuestionPrompt(dataID)
	
	} elseif ##class(sc.objData).getDataType(dataID)="objCODitem" {
		set questionPrompt=##class(sc.xModules.objCODitem).getQuestPrompt(dataID,languageID)
	
	} else {
		throw ##class(shared.exceptions.generalException).%New("Data item has no question prompt")	
	}
	return questionPrompt
]]></Implementation>
</Method>

<Method name="getEditorPageNameForDataType">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataType:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	return $Case(dataType,
					"objText":"textDetailsMoxie.csp",
					"objImage":"imageDetails.csp",
					"objSurveyQuestion":"disused",
					"objCODitem":"codQuestionDetails.csp",
					"objMenuBlock":"menuDetails.csp",
					"objScrollingImage":"scrollingImageDetails.csp",
					"objFlash":"flashDetails.csp",
					"objFileUpload":"fileUploadDetails.csp",
					:"")
]]></Implementation>
</Method>

<Method name="getEditMenuArray">
<FormalSpec><![CDATA[context:%ZEN.proxyObject,&editMenuStr]]></FormalSpec>
<Implementation><![CDATA[
	#dim className as %String = ..getDataType(..%Id())
	#dim dataID as %Integer = ..%Id()
	#dim pageID as %Integer = context.pageID
	#dim xEventID as %Integer = ..objEventGetObjectId()
	#dim idx as %Integer = $Order(editMenuStr(""),-1)+1
	
	set editPage = ..getEditorPageNameForDataType(className)
	
	// Set up the URLs
	set editURL=##class(shared.pCSP).Link(context.app_"/backend/proweb/"_editPage_"?dataID="_##class(EF.htmlGenerator).encodeForURL(context.editID)_"&templateURL="_##class(EF.htmlGenerator).encodeForURL(context.templateFilename)_"&componentName="_##class(EF.htmlGenerator).encodeForURL(context.componentName)_"&templateID="_##class(EF.htmlGenerator).encodeForURL(context.templateID)_"&warning="_##class(EF.htmlGenerator).encodeForURL(context.warning)_"&orgDataID="_##class(EF.htmlGenerator).encodeForURL(context.orgDataID)_"&parent="_##class(EF.htmlGenerator).encodeForURL(context.listID)_"&classNo=1&displayOrder="_##class(EF.htmlGenerator).encodeForURL(context.displayOrder)_"&isCOD="_##class(EF.htmlGenerator).encodeForURL(context.isCOD)_"&pageID="_##class(EF.htmlGenerator).encodeForURL(context.pageID))
	set delURL="javasc"_"ript: confirmDelete("_context.deleteID_");"

	// output javascript for the edit version of the floater
	set editMenuStr($I(idx)) = "<sc"_"ript language='javasc"_"ript'>"
	set editMenuStr($I(idx)) = "HM_Array"_context.menuID_" = [[150,,,,,,,,,,,,,,,,,,,,1],"

	// make a title bar in the floater
	set titleText=$S(className="objFormDivider":"Form Divider",className="objScrollingImage":"Scolling Image",className="objText":"Text",className="objImage":"Image",1:className)
	set title="----- "_titleText_" ------"
	if className="objCODitem" {
		set obj=##class(sc.objData).%OpenId(context.viewID)
		// display coditemname rather than desc because html formatted desc upsets JS 
		set title="----- "_$S(obj.isGuest:"GUEST_",1:"")_##class(shared.pCSP).EscapeHTML(obj.objItemName.description)_" -----"
		kill obj
	}

	if className="objFileUpload" {
		set obj=##class(sc.objData).%OpenId(context.viewID)
		// display coditemname rather than desc because html formatted desc upsets JS // Fred v 1.1.5
		set title="----"_##class(shared.pCSP).EscapeHTML($ZCVT(obj.objItemName.description,"U"))_"---"
		kill obj
	}

	set editMenuStr($I(idx)) = "['"_title_"','',0,0,0],"
	
	if className'="objFormDivider" {
		if (context.isCOD)!(context.isDOC)!(context.isForm) {
			set editMenuStr($I(idx))= "['Edit','"_editURL_"',1,0,0],"
		} else {
			set editMenuStr($I(idx)) = "['Edit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;("_dataID_")','"_editURL_"',1,0,0],"
		}
	}
	
	// Do not allow them to delete questions that have dependent children
	set rsChildPrompts=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set query="SELECT ID,parent->parent As pageID FROM sc_xModules.objCODitem WHERE (dependsOnPrompt = ?) AND (active=1) AND (parent->parent->active = 1)"
	do rsChildPrompts.Prepare(query)
	do rsChildPrompts.Execute(dataID)
	while rsChildPrompts.Next() {
		set tmpPageID=rsChildPrompts.Get("pageID")
		if (tmpPageID=context.pageID)!(##class(setup.lnkCategoryEvent).isPageActive(xEventID,tmpPageID,context.langID)) {
			set delURL="javasc"_"ript: alert("""_##class(shared.pCSP).translateAdmin("Can not be deleted because it has dependent questions")_""");"
		}
	}
	
	// Do not allow them to delete questions that have dependent children
	set rsChildText=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set query="SELECT ID,parent->parent As pageID FROM sc_xModules.objText WHERE (dependsOnPrompt = ?) AND (active=1) AND (parent->parent->active = 1)"
	do rsChildText.Prepare(query)
	do rsChildText.Execute(dataID)
	while rsChildText.Next() {
		set tmpPageID=rsChildText.Get("pageID")
		if (tmpPageID=context.pageID)!(##class(setup.lnkCategoryEvent).isPageActive(dataID,tmpPageID,context.langID)) {
			set delURL="javasc"_"ript: alert("""_##class(shared.pCSP).translateAdmin("Can not be deleted because it has dependent text blocks")_""");"
		}
	}
	
	if className="objCODitem" {
		&SQL(SELECT objItemName->description INTO :tmp FROM sc_xModules.objCODitem WHERE (ID = :dataID) AND (active=1))
		if +SQLCODE=0 {
			&SQL(SELECT ID FROM setup.lnkCategoryEvent 
				WHERE (dependsOnPromptPageID = :pageID) AND (%SQLUPPER(dependsOnObjItemName->description) = %SQLUPPER(:tmp)) AND (active=1)
				AND objEventCategory IN (
					SELECT objEventCategory
					FROM setup.lnkAttendeeCategoryDetailsEvent 
					WHERE (objEvent=:xEventID)
				)
			)
			if +SQLCODE=0 set delURL="javasc"_"ript: alert("""_##class(shared.pCSP).translateAdmin("Can not be deleted because it has a dependent page")_""");"
		}
	}

	// do not allow them to delete firstname and lastname on tablebooking or abstract signup page
	if className="objCODitem" {
		if ($ZCVT(context.pageName,"L")="ttableguests.csp") ! ($ZCVT(context.pageName,"L")="tabssignup.csp") {
			set obj=##class(sc.objData).%OpenId(context.viewID)
			if ($ZCVT(obj.objItemName.description,"U")="FIRSTNAME")!($ZCVT(obj.objItemName.description,"U")="LASTNAME") set context.suppressDelete=1
			kill obj
		}
	}

	if 'context.suppressDelete {
		set editMenuStr($I(idx)) = "['Delete','"_delURL_"',1,0,0],"
	}

	set up="up",down="down"
	set top="top",bottom="bottom"
	set editMenuStr($I(idx)) = "['Move Up',""javasc"_"ript: moveItem("_dataID_",'"_up_"');"",1,0,0],['Move Down',""javasc"_"ript: moveItem("_dataID_",'"_down_"');"",1,0,0]"
	set editMenuStr($I(idx)) = ",['Move to Top',""javasc"_"ript: moveItem("_dataID_",'"_top_"');"",1,0,0],['Move to Bottom',""javasc"_"ript: moveItem("_dataID_",'"_bottom_"');"",1,0,0],['Move to Position',""javasc"_"ript: moveItemToPosition("_dataID_");"",1,0,0]];"
	set editMenuStr($I(idx)) = "</sc"_"ript>"
]]></Implementation>
</Method>

<Method name="getDependsOnAlternativeID">
<Description>
note that this must be a classmethod or you will a compile error as the property only exists on some of the child classes</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>listItem:sc.objData</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	try {
		return listItem.dependsOnAlternative
	} catch { // this will happen for images, dividers etc.
		return ""	
	}
]]></Implementation>
</Method>

<Method name="getDependsOnQuestionID">
<ClassMethod>1</ClassMethod>
<FormalSpec>listItem:sc.objData</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	try {
		return listItem.dependsOnPrompt
	} catch { // this will happen for images, dividers etc.
		return ""	
	}
]]></Implementation>
</Method>

<Method name="getDependsOnItemName">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set dependsOnAltID = ..getDependsOnAlternativeID($this)
	if dependsOnAltID {
		set alternative = ##class(cod.objItemAlternatives).%OpenId(dependsOnAltID)
		if $IsObject(alternative) {
			return alternative.objItemName.description
		}
	}
	return ""
]]></Implementation>
</Method>

<Method name="getDependsOnAlternativeName">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set dependsOnAltID = ..getDependsOnAlternativeID($this)
	if dependsOnAltID {
		set alternative = ##class(cod.objItemAlternatives).%OpenId(dependsOnAltID)
		if $IsObject(alternative) {
			return alternative.description
		}
	}
	return ""
]]></Implementation>
</Method>

<Method name="getDependencyHoverText">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim dependsOnPromptDesc as %String  = ..getDependsOnItemName()
	#dim dependsOnAlternativeDesc as %String = ..getDependsOnAlternativeName()
	#dim hoverText as %String = ""
	
	if $Length(dependsOnPromptDesc) {
		set hoverText = " title='Display when: "_dependsOnPromptDesc_" = "_dependsOnAlternativeDesc
		
		set dependsOnPageID = ..getPageID(..getDependsOnQuestionID($this))
		set myPageID = ..getPageID(..%Id())
		
		if myPageID '= dependsOnPageID {
			set hoverText = hoverText_" (on page &quot;"_##class(sc.xModules.objPage).getDescription(dependsOnPageID)_"&quot;)"	
		}
		set hoverText = hoverText_"'"
	}	
	return hoverText
]]></Implementation>
</Method>

<Method name="moveNewElementToDesiredPosition">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Integer</FormalSpec>
<Implementation><![CDATA[
	#dim targetPosition as %Integer = ""
	#dim beforeOrAfter as %Integer = $Get(%session.Data("eventsforce","backend","proweb page","insert proweb item","beforeOrAfter"))
	#dim selectedProwebID As %Integer = $Get(%session.Data("eventsforce","backend","proweb page","insert proweb item","selectedProwebID"))

	if (beforeOrAfter = "after") {
		set targetPosition = ##class(sc.objData).getDisplayOrder(selectedProwebID)
	}
	
	if targetPosition {
		do ..moveChildToPosition(dataID, targetPosition)
	}
	
	kill %session.Data("eventsforce","backend","proweb page")
]]></Implementation>
</Method>

<Method name="moveChildToPosition">
<ClassMethod>1</ClassMethod>
<FormalSpec>childProwebID:%Integer,targetPosition:%Integer</FormalSpec>
<Implementation><![CDATA[
	set child = ##class(sc.objData).%OpenId(childProwebID)
	
	if '$IsObject(child)   {
		throw ##class(shared.exceptions.generalException).%New("Could not open child object ID: "_childProwebID)
	}
	if 'child.parent.%IsA("sc.xModules.objList") {
		throw ##class(shared.exceptions.generalException).%New("Passsed in childID is not a a child of an objList")
	}

	set currentDisplayOrder = child.displayOrder
	set listID = child.parent.%Id()
	
	set difference = $Select(targetPosition < currentDisplayOrder:+1, 1:-1)

	&SQL(UPDATE sc.objData 
		 SET displayOrder = (displayOrder + :difference) 
		 WHERE (parent = :listID) 
		 AND (displayOrder <= :targetPosition) 
		 AND (ID <> :childProwebID)
	 )
	
	set child.displayOrder = targetPosition
	set status = child.%Save()
	if 'status {
		throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(status)
	}
]]></Implementation>
</Method>

<Method name="saveDesiredPositionFromRequestToSession">
<ClassMethod>1</ClassMethod>
<FormalSpec>requestObject:%CSP.Request,sessionObject:%CSP.Session</FormalSpec>
<Implementation><![CDATA[
	if ((requestObject.Get("selectedProwebID") '= "") && (requestObject.Get("beforeOrAfter") '= "")) {
		do ..setDesiredPositionToSession(sessionObject, requestObject.Get("selectedProwebID"), requestObject.Get("beforeOrAfter")) 
	}
]]></Implementation>
</Method>

<Method name="setDesiredPositionToSession">
<ClassMethod>1</ClassMethod>
<FormalSpec>sessionObject:%CSP.Session,selectedProwebID:%Integer,beforeOrAfter:%String</FormalSpec>
<Implementation><![CDATA[
	set sessionObject.Data("eventsforce","backend","proweb page","insert proweb item","selectedProwebID") = selectedProwebID
	set sessionObject.Data("eventsforce","backend","proweb page","insert proweb item","beforeOrAfter") = beforeOrAfter
]]></Implementation>
</Method>

<Query name="qGetChildren">
<Type>%SQLQuery</Type>
<FormalSpec>parentID:%String=""</FormalSpec>
<SqlQuery>SELECT ID FROM objData
 WHERE (parent = :parentID AND active = 1)
 ORDER BY displayOrder</SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^sc.objDataD</DataLocation>
<DefaultData>objDataDefaultData</DefaultData>
<IdLocation>^sc.objDataD</IdLocation>
<IndexLocation>^sc.objDataI</IndexLocation>
<StreamLocation>^sc.objDataS</StreamLocation>
<ExtentSize>5000</ExtentSize>
<Data name="objDataClassName">
<Attribute>%%CLASSNAME</Attribute>
<Structure>node</Structure>
<Subscript>0</Subscript>
</Data>
<Data name="objDataDefaultData">
<Value name="1">
<Value>xCRstamp</Value>
</Value>
<Value name="2">
<Value>xMOstamp</Value>
</Value>
<Value name="3">
<Value>creator</Value>
</Value>
<Value name="4">
<Value>displayOrder</Value>
</Value>
<Value name="5">
<Value>nextVersion</Value>
</Value>
<Value name="6">
<Value>parent</Value>
</Value>
<Value name="7">
<Value>previousVersion</Value>
</Value>
<Value name="8">
<Value>objTemplate</Value>
</Value>
<Value name="9">
<Value>objStep</Value>
</Value>
<Value name="10">
<Value>dataType</Value>
</Value>
<Value name="11">
<Value>active</Value>
</Value>
<Value name="12">
<Value>publishAt</Value>
</Value>
<Value name="13">
<Value>sourceID</Value>
</Value>
<Value name="14">
<Value>xCRuserID</Value>
</Value>
<Value name="15">
<Value>xMOuserID</Value>
</Value>
<Value name="16">
<Value>afterItem</Value>
</Value>
<Value name="17">
<Value>afterRow</Value>
</Value>
<Value name="18">
<Value>beforeItem</Value>
</Value>
<Value name="19">
<Value>beforeRow</Value>
</Value>
<Value name="20">
<Value>deleteMe</Value>
</Value>
<Value name="21">
<Value>objEvent</Value>
</Value>
</Data>
<Property name="active">
<Selectivity>100.0000%</Selectivity>
</Property>
<Property name="creator">
<Selectivity>16.6667%</Selectivity>
</Property>
<Property name="dataType">
<Selectivity>14.2857%</Selectivity>
</Property>
<Property name="displayOrder">
<Selectivity>7.6923%</Selectivity>
</Property>
<Property name="nextVersion">
<Selectivity>2.4390%</Selectivity>
</Property>
<Property name="objStep">
<Selectivity>50.0000%</Selectivity>
</Property>
<Property name="parent">
<Selectivity>0.01%</Selectivity>
</Property>
<Property name="previousVersion">
<Selectivity>2.5000%</Selectivity>
</Property>
<Property name="publishAt">
<Selectivity>33.3333%</Selectivity>
</Property>
<Property name="sourceID">
<Selectivity>24.9999%</Selectivity>
</Property>
<Property name="xCRstamp">
<Selectivity>0.3831%</Selectivity>
</Property>
<Property name="xCRuserID">
<Selectivity>6.2500%</Selectivity>
</Property>
<Property name="xMOstamp">
<Selectivity>0.5076%</Selectivity>
</Property>
<Property name="xMOuserID">
<Selectivity>4.7619%</Selectivity>
</Property>
</Storage>
</Class>


<Class name="sc.xModules.objCODitem">
<Description><![CDATA[
link to a OCD item. Provides a facility for adding questions about COD item in a proweb form
<!-- ;vc;
;vc;    Object: sc.xModules.objCODitem.CLS/EV.73
;vc; Component: CLS.sc.xModules.objCODitem
;vc;  Location: LargeDev
;vc; Date/Time: 26-Jan-17 10:06
;vc;      User: MindaugasL
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>sc.xModules.objCODitem.CLS/EV.73</td><td>CLS.sc.xModules.objCODitem</td><td>LargeDev</td><td style='white-space: nowrap;'>26-Jan-17 10:06</td><td>MindaugasL</td></tr></table>
]]></Description>
<ClassType>persistent</ClassType>
<IncludeCode>EF.common.macros</IncludeCode>
<ProcedureBlock>1</ProcedureBlock>
<Super>sc.objData</Super>
<TimeChanged>64310,38055.883253</TimeChanged>
<TimeCreated>59478,65593.453</TimeCreated>

<Property name="maxAltsChecked">
<Description>
Only used for multiple check boxes</Description>
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="minAltsChecked">
<Description>
Only used for multiple check boxes</Description>
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Parameter name="EXTENTSIZE">
<Default>40158</Default>
</Parameter>

<Property name="description">
<Description>
this is the question prompt, might be in HTML</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="30000"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="type">
<Description>
this type overrides the type set on the coditem itself
Controls the type of windows control that should be used for</Description>
<Type>%Library.String</Type>
<InitialExpression>"text"</InitialExpression>
<Parameter name="TRUNCATE" value="1"/>
<Parameter name="VALUELIST" value=",text,textarea,radiobutton,checkbox,dropdown,password,multibox,date,dateRange,time,emailAddress,multiEmailAddress,phoneNumber,integer,floatingPointNumber,webAddress"/>
</Property>

<Property name="objItemName">
<Description>
Link to cod.objItemName which is a COD item such as "email" or "first name"</Description>
<Type>cod.objItemName</Type>
<Required>1</Required>
</Property>

<Property name="readonlyFrontend">
<Type>%Boolean</Type>
</Property>

<Property name="readonlyAmendment">
<Description>
added for 3.5 JAW but not used yet - will be so that amendments are not allowed on this question</Description>
<Type>%Boolean</Type>
</Property>

<Property name="mandatory">
<Type>%Boolean</Type>
</Property>

<Property name="fieldHeight">
<Type>%Integer</Type>
</Property>

<Property name="fieldWidth">
<Type>%Integer</Type>
</Property>

<Property name="helpText">
<Type>%String</Type>
<Parameter name="MAXLEN" value="30000"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="layout">
<Description>
Determines if the prompt should be on the left and the input field on the right OR if they should be on top of each other</Description>
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="dataType">
<Description>
Used for identifying the class of the object withour having to call
cache mysterious APIs.</Description>
<Type>%Library.String</Type>
<InitialExpression>"objCODitem"</InitialExpression>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="isDelegate">
<Description>
indicates if the property should be used for storing delegate details or guest details</Description>
<Type>%Boolean</Type>
</Property>

<Property name="isGuest">
<Type>%Boolean</Type>
</Property>

<Property name="reportOn">
<Type>%Boolean</Type>
</Property>

<Property name="backendOnly">
<Description>
will hide this question for the normal punters, used for setting delegateType etc.</Description>
<Type>%Boolean</Type>
</Property>

<Property name="courseID">
<Description>
used for course specific questions in the attendee reg page. Will only be displayed for the course with this ID</Description>
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="dependsOnPrompt">
<Description>
Dependencies are handled by refferring to another questions answer
Please note that it is pointing to a code object rather than an sc object because there are no sc objects for alternatives
it is a string rather than a real object because of cross namespace compability issues</Description>
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="dependsOnAlternative">
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="isAdditionalItem">
<Description>
Flag controlling if an item can have a price and capacity or not</Description>
<Type>%Boolean</Type>
</Property>

<Property name="isQuantityItem">
<Description>
Flag controlling if an item is a ticketing type of item</Description>
<Type>%Boolean</Type>
</Property>

<Property name="promptWidth">
<Description>
Only used with supressNewLine. Controls the width of the first column of the line.</Description>
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="reportDescription">
<Description>
an alternative name of this item. used in reporting.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="250"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="requiredAnswer">
<Type>%String</Type>
<Parameter name="MAXLEN" value="250"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="validationErrorMessage">
<Type>%String</Type>
<Parameter name="MAXLEN" value="250"/>
</Property>

<Property name="supressNewLine">
<Description>
Will ignore the TR if set. Must be set on both Firstname and Lastname to get them on the same line</Description>
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="maxCharacters">
<Description>
The maximum number of characters allowed in a text field</Description>
<Type>%Integer</Type>
</Property>

<Property name="maxWords">
<Description>
The maximum number of words allowed in a text field</Description>
<Type>%Integer</Type>
</Property>

<Property name="defaultValue">
<Description>
The default Value</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="32000"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="noAmendments">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="copyValueFromBooker">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="searchAsYouType">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Index name="objItemNameIndex">
<Properties>objItemName</Properties>
</Index>

<Index name="dependsOnPromptIndex">
<Properties>dependsOnPrompt</Properties>
</Index>

<Index name="dependsOnAlternativeIndex">
<Properties>dependsOnAlternative</Properties>
</Index>

<Index name="isAdditionalItemIndex">
<Properties>isAdditionalItem</Properties>
</Index>

<Index name="isQuantityItemIndex">
<Properties>isQuantityItem</Properties>
</Index>

<Method name="add">
<Description>
adds a new cod item to a list</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>itemNameID:%String,description:%String="",parent:%String="",user:%String="",addToTop:%String=0,helpText:%String="",type:%String="",mandatory:%Boolean=0,pageLayout:%String="",fieldWidth:%Integer,fieldHeight:%Integer,isDelegate:%Boolean=0,isGuest:%Boolean=0,reportOn:%Boolean=0,isAdditionalItem:%Boolean=0,backendOnly:%Boolean=0,isQuantityItem:%Boolean=0,reportDescription=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if '##class(cod.objItemName).%ExistsId(itemNameID) {
		throw ##class(shared.exceptions.generalException).%New("cod.objItemName item does not exist")	
	}
	// new displayOrder,firstLevel,tmp
	set isGuest=+isGuest,isDelegate=+isDelegate,reportOn=+reportOn
	// we never want both isGuest and isDelegate to be unset.
	if (('isGuest) && ('isDelegate)) {
		set isDelegate=1	
	}
	//default field width
	if fieldWidth="",type="textarea" set fieldWidth=$$$defaultTextFieldWidthPx
	if fieldWidth="",type="dropdown" set fieldWidth=$$$defaultDropdownWidthPx
	if fieldWidth="" set fieldWidth=$$$defaultTextFieldWidthPx
	
	// find displayOrder
	set displayOrder=0,ok=0
	if addToTop {
		set displayOrder=1
		&SQL(UPDATE sc.objData SET displayOrder = displayOrder+1 WHERE parent = :parent )
	} else {
		&SQL(SELECT TOP 1 displayOrder INTO :displayOrder FROM sc.objData WHERE parent = :parent ORDER BY displayOrder DESC)
		set displayOrder=displayOrder+1
	}
			
	// find the first approval level
	set firstLevel=""
	&SQL(SELECT ID INTO :tmp FROM sc.objStep WHERE stepOrder = 1)
	if +SQLCODE=0 set firstLevel=tmp
	

	if (firstLevel'="")&(parent) {
		set is1to5=0
		if type="1-5 scale" set type="radiobutton",is1to5=1
		
		// CREATE NEW OBJECT
		&SQL(
			INSERT INTO sc_xModules.objCODitem 
			(objItemName,description,parent,creator,displayOrder,objStep,helpText,active,type,mandatory,fieldWidth,fieldHeight,layout,isDelegate,isGuest,reportOn,isAdditionalItem,backendOnly,isQuantityItem,reportDescription) 
			VALUES 
			(:itemNameID,:description,:parent,:user,:displayOrder,:firstLevel,:helpText,1,:type,:mandatory,:fieldWidth,:fieldHeight,:pageLayout,:isDelegate,:isGuest,:reportOn,:isAdditionalItem,:backendOnly,:isQuantityItem,:reportDescription)
		)
		if +SQLCODE = 0 set ok = %ROWID
		
		if is1to5 {
			for i=1:1:5 do ##class(cod.objItemAlternatives).create(itemNameID,i)	
		}
		
	}
	quit ok
]]></Implementation>
</Method>

<Method name="update">
<Description>
updates a cod item</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String,description:%String="",user:%String="",helpText:%String="",type:%String="",mandatory:%Boolean=0,layout:%String="horizontal",fieldWidth:%Integer,fieldHeight:%Integer,isDelegate:%Boolean=0,isGuest:%Boolean=0,reportOn:%Boolean=0,reportDescription=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set isGuest=+isGuest,isDelegate=+isDelegate,reportOn=+reportOn
	//default field width
	if fieldWidth="",type="textarea" set fieldWidth=50
	if fieldWidth="",type="dropdown" set fieldWidth=266
	if fieldWidth="" set fieldWidth=50
	// update
	&SQL(
	UPDATE sc_xModules.objCODitem  SET 
	description = :description, creator =:user , helpText = :helpText, type = :type, mandatory = :mandatory, fieldWidth = :fieldWidth, 
	fieldHeight = :fieldHeight, layout = :layout,isDelegate=:isDelegate,isGuest=:isGuest,reportOn=:reportOn, reportDescription = :reportDescription
	WHERE ID = :dataID 
	) 
	quit SQLCODE
]]></Implementation>
</Method>

<Method name="update2">
<Description>
updates a cod item - simple</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String,description:%String="",helpText:%String="",mandatory:%Boolean=0,isDelegate:%Boolean=0,isGuest:%Boolean=0,reportOn:%Boolean=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set isGuest=+isGuest,isDelegate=+isDelegate,reportOn=+reportOn
	// update
	&SQL(
	UPDATE sc_xModules.objCODitem  SET 
	description = :description,  helpText = :helpText, mandatory = :mandatory, isDelegate=:isDelegate, isGuest=:isGuest, reportOn = :reportOn
	WHERE ID = :dataID 
	) 
	quit SQLCODE
]]></Implementation>
</Method>

<Method name="updateRequiredAnswer">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,value</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objCODitem  SET requiredAnswer = :value WHERE ID = :dataID)	
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))
]]></Implementation>
</Method>

<Method name="updateValidationErrorMessage">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,value</FormalSpec>
<Implementation><![CDATA[
	set question=##class(sc.xModules.objCODitem).%OpenId(dataID)
	do question.%Reload()
	set question.validationErrorMessage = value
	do question.%Save()
]]></Implementation>
</Method>

<Method name="updateMaxCharacters">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,value</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objCODitem  SET maxCharacters = :value WHERE ID = :dataID )	
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))
]]></Implementation>
</Method>

<Method name="updateMaxWords">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,value</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objCODitem  SET maxWords = :value WHERE ID = :dataID )	
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))
]]></Implementation>
</Method>

<Method name="updateMultiCheckboxMin">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,value</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objCODitem  SET minAltsChecked = :value WHERE ID = :dataID )	
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))
]]></Implementation>
</Method>

<Method name="updateMultiCheckboxMax">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,value</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objCODitem  SET maxAltsChecked = :value WHERE ID = :dataID )	
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))
]]></Implementation>
</Method>

<Method name="updateDefaultValue">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,value</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objCODitem  SET defaultValue = :value WHERE ID = :dataID )	
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))
]]></Implementation>
</Method>

<Method name="updateCopyValueFromBooker">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,value</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objCODitem  SET copyValueFromBooker = :value WHERE ID = :dataID )	
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))
]]></Implementation>
</Method>

<Method name="getCopyValueFromBooker">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT copyValueFromBooker INTO :copyValueFromBooker FROM sc_xModules.objCODitem  WHERE ID = :dataID )	
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))
	return +copyValueFromBooker
]]></Implementation>
</Method>

<Method name="updateNoAmendments">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,value</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objCODitem  SET noAmendments = :value WHERE ID = :dataID )	
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))
]]></Implementation>
</Method>

<Method name="getCODItemNameID">
<Description>
get codItemNameID from sc.xModules.objCODItem ID</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set itemNameID=""
	&SQL(SELECT objItemName INTO :tmp FROM sc_xModules.objCODitem	WHERE (active=1 AND ID = :dataID))
	if +SQLCODE=0 set itemNameID=tmp
	quit itemNameID
]]></Implementation>
</Method>

<Method name="getCODItemName">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set itemName=""
	&SQL(SELECT objItemName->description INTO :tmp FROM sc_xModules.objCODitem	WHERE (active=1 AND ID = :dataID))
	if +SQLCODE=0 set itemName=tmp
	quit itemName
]]></Implementation>
</Method>

<Method name="getType">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data=""
	&SQL(SELECT type INTO :tmp FROM sc_xModules.objCODitem	WHERE (active=1 AND ID = :dataID))
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="getIsDelegate">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data=""
	&SQL(SELECT isDelegate INTO :tmp FROM sc_xModules.objCODitem	WHERE (active=1 AND ID = :dataID))
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="getIsGuest">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data=""
	&SQL(SELECT isGuest INTO :tmp FROM sc_xModules.objCODitem	WHERE (active=1 AND ID = :dataID))
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="getFieldWidth">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT fieldWidth INTO :tmp FROM sc_xModules.objCODitem	WHERE ID = :dataID)
	if +SQLCODE=0 {
		return tmp
	} else {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$G(%msg))
	}
]]></Implementation>
</Method>

<Method name="setFieldWidth">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,fieldWidth</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objCODitem	SET fieldWidth = :fieldWidth WHERE ID = :dataID)
	if +SQLCODE'=0 {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$G(%msg))
	}
]]></Implementation>
</Method>

<Method name="getPageIDforQuestion">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data=""
	&SQL(SELECT parent->parent INTO :tmp FROM sc_xModules.objCODitem WHERE (active=1 AND ID = :dataID))
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="getPrefixForQuestionType">
<ClassMethod>1</ClassMethod>
<FormalSpec>type</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data=$S(type="radiobutton":"rad",type="checkbox":"chk",type="dropdown":"sel",type="text":"txt",type="password":"txt",type="textarea":"txt",type="multibox":"mul",type="emailAddress":"txt",type="multiEmailAddress":"txt",type="phoneNumber":"txt",type="integer":"txt",type="floatingPointNumber":"txt",type="webAddress":"txt",1:"")
	quit data
]]></Implementation>
</Method>

<Method name="getQuestPrompt">
<Description><![CDATA[
get translated description from sc.xModules.objCODItem using dataID (and prefLangID). This works if objItemName<20 and description (question prompt) is the same as database name (objItemName.Description).]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,prefLangID:%String=1</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set itemNameID="",questPrompt = "", itemNameDesc=""
	&SQL(SELECT description, objItemName, objItemName->description INTO :tmp,:tmp1,:tmp2 FROM sc_xModules.objCODitem WHERE (active=1 AND ID = :dataID))
	if +SQLCODE=0 set questPrompt=tmp,itemNameID=tmp1,itemNameDesc=tmp2
	set translatePhrase=0
	if ((itemNameID) && (itemNameID<20) && ($ZCVT(questPrompt,"L")=$ZCVT(itemNameDesc,"L"))) {
		set translatePhrase=1
	}
	if $ZCVT(questPrompt,"L")="first name" {
		set translatePhrase=1	
	}
	if $ZCVT(questPrompt,"L")="last name" {
		set translatePhrase=1	
	}
	if translatePhrase {
		set questPrompt = ##class(translations.objPhraseWebsite).translatePhrase(questPrompt,prefLangID,"","","","")
	}
	quit questPrompt
]]></Implementation>
</Method>

<Method name="getSCItemDetails">
<Description>
gets the displayOrder for a cod item from sc.xModules.objCODItem</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,langID,codItemName</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set delim="|"
	set eventDetailsID=##class(setup.objEventDetails).getDetailsID(eventID,langID)
	set objEventDetails=##class(setup.objEventDetails).%OpenId(eventDetailsID)
	set pageID=objEventDetails.registrationPageID
	set itemNameID=""
	&SQL(
		SELECT displayOrder,objItemName INTO :tmp,:tmp2 FROM sc_xModules.objCODitem
		WHERE (parent->parent = :pageID) 
		AND (active = 1) 
		AND (%UPPER(objItemName->description) = %UPPER(:codItemName))
		AND (isDelegate = 1)
	)
	set data=""
	if +SQLCODE=0 set data=tmp_delim_tmp2
	
	quit data
]]></Implementation>
</Method>

<Method name="getRegPageItems">
<Description>
get the items for the event</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<ReturnType>%ResultSet</ReturnType>
<Implementation><![CDATA[
	set eventGroupID=##class(sc.methods).getEventGroupID(eventID)
	
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set query="SELECT ID As scID,description,objItemName As ID,objItemName->description As codName,displayOrder,isDelegate,isGuest,type,parent->parent As pageID,isAdditionalItem,isQuantityItem,reportDescription,objItemName->concealed,COUNT(objItemName->description) AS promptCount "
	set query=query_"FROM sc_xModules.objCODitem WHERE ((parent->parent->parent->parent=?) OR ((parent->parent->parent->parent->parent=?))) AND (active=1) AND (objEvent=?)"
	set query = query_" AND (objItemName->description <> 'Password') AND (objItemName->description <> 'Password Re-typed')"
	set query=query_" GROUP BY objItemName->description ORDER BY parent->parent,displayOrder"
	set ok=rs.Prepare(query)
	do rs.Execute(eventGroupID,eventGroupID,eventID)
	
	quit rs
]]></Implementation>
</Method>

<Method name="getDependendPrompts">
<Description>
Recursive method for getting all children that is depending on me. Used in mail tags.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>personID:%String,dataID:%String,data:%String="",resultString:%String,LF:%String="$C(13,10)",pageID:%String,controllerID:%String,questPrompt:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	//check questPrompt first. If the value is 'ND' for No dependents, we do not need to execute this method at all. So, we will quit.
	set questPromptGet = questPrompt
	set questPrompt = $p(questPrompt,"|",1)
	set queryFilterBackEnd = $p(questPromptGet,"|",2)
		
	// RQ 22-Jul-2011 PBUG00004044 - Remove the LF added for ND types	
	// if questPrompt="ND" set resultString=resultString_LF
	if questPrompt="ND" quit 1 
	
	// JAW 24OCT2007 - controllerID missing from cod.objItemData.get() !!?
	set controllerID=$G(controllerID)
	// JAW 09NOV206 - added pageID. Otherwise the query to get children will get ALL questions in the database that are set up with that dependancy
	// find the cod Item name
	&SQL(SELECT objItemName INTO :itemNameID FROM sc_xModules.objCODitem WHERE ID = :dataID)
	if +SQLCODE=0 {
		
		// find the alternative that correcsponds to the data
		set answerAltID=##class(cod.objItemAlternatives).getIDFromDescription(itemNameID,data)
		if answerAltID {
			
			// find all the children who depends on the alternative
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			set ok=rs.Prepare("SELECT *,objItemName->description AS itemName FROM sc_xModules.objCODitem WHERE (parent->parent=?) AND (active=1) "_##class(EF.encoders.sql).doNotEncodeString(queryFilterBackEnd)_" AND (dependsOnAlternative=?) ORDER BY displayOrder")
			do rs.Execute(pageID,answerAltID)
			while rs.Next() {
				set newDataID=rs.Get("ID")
				set prompt=rs.Get("itemName") //default behaviour: show database name.
				//check if concealed 
				set isPromptConcealed = ##class(cod.objItemName).isConcealed(prompt)
				if 'isPromptConcealed {
					set result=##class(cod.objItemData).get(personID,prompt,controllerID)
					if rs.Get("type")="checkbox" set result = $S(result="true":"Yes", 1:"No")
				} else {
					set result="*****"
				} 
				
				if questPrompt="QP" set prompt=rs.Get("description") //show Question Prompt if questPrompt="QP"
				if questPrompt="NP" set prompt="" //Do not show any prompt at all.
				set resultString=resultString_LF_prompt_$select($l(prompt):" = ",1:"")_result_$S($L(LF):"",1:", ")
				
				do ..getDependendPrompts(personID,newDataID,data,.resultString,LF,pageID,controllerID,questPrompt)
			}
		}
	}
	quit 1
]]></Implementation>
</Method>

<Method name="getDependsOnPrompt">
<Description>
Returns the id of the objData that this item is dependent on.</Description>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ..dependsOnPrompt
]]></Implementation>
</Method>

<Method name="findDependentQuestions">
<Description>
do we have any dependent questions?
returns: ID1~description1|ID2~desc2 etc</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=""
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT ID,description FROM sc_xModules.objCODitem WHERE (dependsOnPrompt=?) AND (active=1)")
	do rs.Execute(dataID)
	while rs.Next() {
		set out=out_$S($L(out):"|",1:"")_rs.Get("ID")_"~"_rs.Get("description")
	}
		
	quit out
]]></Implementation>
</Method>

<Method name="findDependentTextBlocks">
<Description>
do we have any dependent text blocks?
returns: textblockID1~pageID1|textblockID2~pageID2 etc</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=""
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT ID, parent->parent FROM sc_xModules.objText WHERE (dependsOnPrompt=?) AND (active=1)")
	do rs.Execute(dataID)
	while rs.Next() {
		set out=out_$S($L(out):"|",1:"")_rs.Get("ID")_"~"_rs.Get("parent")
	}
		
	quit out
]]></Implementation>
</Method>

<Method name="getDependsOnAlternativeValue">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=##class(cod.objItemAlternatives).getDescriptionByID(..dependsOnAlternative)
	quit out
]]></Implementation>
</Method>

<Method name="areDependenciesSatisfiedForTempPerson">
<FormalSpec>tempPersonID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set out=1
	if $l(..dependsOnPrompt) {
		set pageID=..getPageID(..dependsOnPrompt)
		set codItemName=..getCODItemName(..dependsOnPrompt)
		set tempPersonToCheckID=tempPersonID
		if ##class(sc.xModules.objPage).isBookerPage(pageID) {
			set tempPurchaseID=##class(eCom.tempPerson).getTempPurchaseID(tempPersonID)
			set tempPersonToCheckID=##class(eCom.tempPerson).getBookerIDfromTempPurchaseID(tempPurchaseID)
		}
		if $ZCVT(##class(eCom.tempCodData).get(tempPersonToCheckID,codItemName),"L")'=$ZCVT(..getDependsOnAlternativeValue(),"L") {
			set out=0
		}
	}
	quit out
]]></Implementation>
</Method>

<Method name="getBackendOnlyColour">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	return "#F5DEB3"
]]></Implementation>
</Method>

<Method name="getMaxWords">
<ClassMethod>1</ClassMethod>
<FormalSpec>objData,isAccessible</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// get input limits if specified
	set maxWords=objData.maxWords
	if (isAccessible) {
		// use server-side code for accessible templates
		set (maxWords)=""
	}
	return maxWords
]]></Implementation>
</Method>

<Method name="getMaxCharacters">
<ClassMethod>1</ClassMethod>
<FormalSpec>objData,isAccessible</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// get input limits if specified
	set maxChars=objData.maxCharacters	
	if (isAccessible) {
		// use server-side code for accessible templates
		set (maxChars)=""
	}
	return maxChars
]]></Implementation>
</Method>

<Method name="getFieldNameExtra">
<ClassMethod>1</ClassMethod>
<FormalSpec>objData,displayOrder,isAbstract,isAbsPerson,coAuthorNo,guestID,tempPersonID,personID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// put info about guest item onto the field name
	set fieldNameExtra=""
	if objData.isGuest set $P(fieldNameExtra,"_",2)="guest"

	// and add an extra bit to the field name if it's a repeated guest item
	if displayOrder#1 set $P(fieldNameExtra,"_",3)=$p(displayOrder#1,".",2)
	if $g(isAbstract) {
		set $P(fieldNameExtra,"_",2)="absDocument"	
	}
	if $g(isAbsPerson) {
		if $g(coAuthorNo) {
			set $P(fieldNameExtra,"_",2)="coAuthor"
			set $P(fieldNameExtra,"_",3)=coAuthorNo
		} else {
			set $P(fieldNameExtra,"_",2)="mainAuthor"
		}
	}

	// add the guestID to the fieldName
	if objData.isGuest,guestID set $p(fieldNameExtra,"_",4)=guestID
	
	// add tempPersonID now (added to allow smartbook to show lots of peoples questions on one page)
	if ($ZCONVERT(tempPersonID,"U")'="NEW") {
		if $L(tempPersonID) {
			set tempPersonID=+tempPersonID  // force to numeric (to help avoid XSS attack when constructing the javascript in codItem.csp - although it is now encoded on output)
		}
		if (tempPersonID=0) {
			set tempPersonID=""
		}
	}
	set $P(fieldNameExtra,"_",5)=tempPersonID

	if $g(isAbsPerson) {
		set $P(fieldNameExtra,"_",5)=personID
	}
	return fieldNameExtra
]]></Implementation>
</Method>

<Method name="getPrice">
<ClassMethod>1</ClassMethod>
<FormalSpec>itemAlternativeID,dataID,xEventID,currencyID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set eventCategoryID=""
	

	if ##class(setup.objSystemTypes).isModuleAllowed("Attendee Categories")	{
		if (%session.Get("mode")="preview")!($G(%session.Data("inSitePageEditing")))	{
			if $G(%session.Data("eventsforce","frontend","currentPersonID"))	{
				set tempPersonID=$G(%session.Data("eventsforce","frontend","currentPersonID"))
				// get the categoryID - may be null
				set eventCategoryID=##class(eCom.tempPurchase).getEventCategory(%session.SessionId,tempPersonID)
			} else { 
				// When a new attendee is added through 'Add another attendee' button on Basket page. We will assume the booker's attendee category to be 
				// the attendee category for the new attendee. Otherwise, system fails to pick up prices when 'Price by attendee category' switch is turned ON.
				set bookerID=##class(eCom.tempPerson).getBookerID(%session.SessionId)
				set eventCategoryID=##class(eCom.tempPurchase).getEventCategory(%session.SessionId,bookerID)
			}				
		} else {
			// get the default
			set eventCategoryID=##class(setup.lnkCategoryEvent).getDefault(xEventID)
		}
	}
	set tmpBasketItemID=##class(cod.objAlternativeExtras).findBasketItem(itemAlternativeID,dataID,eventCategoryID)
	set price=##class(eCom.objBasketItem).getPrice(xEventID,tmpBasketItemID,,currencyID,0,0)
	quit price
]]></Implementation>
</Method>

<Method name="isDatabaseItemOnPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,codItemNameID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT ID FROM sc_xModules.objCODitem WHERE (objItemName = :codItemNameID) AND (parent->parent = :pageID) AND (active=1))
	return +SQLCODE=0
]]></Implementation>
</Method>

<Method name="isDatabaseItemOnAnyRegPage">
<Description>
is the database on any of the pages EXCEPT the payment method pages</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,codItemNameID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set groupID=##class(sc.xModules.objGroup).getGroupIDfromEventIDandGroupName(eventID,"Payment Method Instructions")	
	&SQL(SELECT ID INTO :tmp FROM sc_xModules.objCODitem WHERE (objItemName = :codItemNameID) AND (parent->parent->parent <> :groupID) AND (active=1) AND (objEvent = :eventID) )
	return +SQLCODE=0
]]></Implementation>
</Method>

<Method name="isABI">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT isAdditionalItem INTO :isAdditionalItem FROM sc_xModules.objCODitem WHERE ID = :dataID)		
	if +SQLCODE=0 {
		return +isAdditionalItem
	} else {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$G(%msg))	
	}
]]></Implementation>
</Method>

<Method name="isQBI">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT isQuantityItem INTO :isQuantityItem FROM sc_xModules.objCODitem WHERE ID = :dataID)		
	if +SQLCODE=0 {
		return +isQuantityItem
	} else {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$G(%msg))	
	}
]]></Implementation>
</Method>

<Method name="isQuestionRelatedToAnyPrice">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	if ..isABI(dataID) {
		set eventID=##class(sc.objData).getEventID(dataID) 
		set codItemNameID=##class(sc.xModules.objCODitem).getCODItemNameID(dataID)
		set rsAlts=##class(%ResultSet).%New("cod.objItemAlternatives:qAlternativesForCodItem")
		do rsAlts.Execute(codItemNameID)	
		while rsAlts.Next() {
			set altID=rsAlts.Get("ID")
			set extrasID=##class(cod.objAlternativeExtras).findExtra(altID,dataID)
			set rsBasketItems=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rsBasketItems.Prepare("SELECT ID FROM eCom.objBasketItem WHERE (objAlternativeExtra = ?) AND (objEvent = ?)")
			do rsBasketItems.Execute(extrasID,eventID)	
			while rsBasketItems.Next() {
				set basketItemID=rsBasketItems.Get("ID")
				if ##class(eCom.objBasketItem).hasAnyPrice(basketItemID,eventID) {
					return 1					
				} 
			}
		}
	} elseif ..isQBI(dataID) {
		set ticketID=##class(cod.objTicket).getTicketIDfromDataID(dataID)
		if ##class(cod.objTicket).hasAnyPrice(ticketID) {
			return 1
		}
	} 
	return 0
]]></Implementation>
</Method>

<Method name="isRelatedToAnyDiscounts">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set eventID=##class(sc.objData).getEventID(dataID)
	set controllerID=##class(setup.objEvent).getControllerID(eventID)
	set codItemName=##class(sc.xModules.objCODitem).getCODItemName(dataID)
	
	&SQL(SELECT COUNT(ID) INTO :count 
		FROM eCom.objDiscount 
		WHERE (active=1)
		AND (objController = :controllerID)
		AND (
			(objCodItemName->description = :codItemName) OR (objCodItemName2->description = :codItemName) OR (objCodItemName3->description = :codItemName)			
		)
	)
	if +SQLCODE=0 {
		return count>0	
	} else {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$G(%msg))
	}
]]></Implementation>
</Method>

<Method name="isRelatedToAnyPaymentMethods">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set eventID=##class(sc.objData).getEventID(dataID)
	set codItemID=##class(sc.xModules.objCODitem).getCODItemNameID(dataID)
	
	&SQL(SELECT ID FROM links.lnkEventPaymentMethod WHERE (objEvent = :eventID) AND (criteriaCODid = :codItemID))
	if +SQLCODE=0 {
		return 1	
	} else {
		return 0
	}
]]></Implementation>
</Method>

<Method name="isQuestionOnAnyPageForBookers">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,langID,codItemNameID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	
	do ..getArrayOfBookerPages(eventID, langID, .bookersPages)
	set counter=""
	for  {
		set counter=$O(bookersPages(counter))
		if counter="" quit
		set pageID=bookersPages(counter)
		if ..isDatabaseItemOnPage(pageID,codItemNameID) return 1
	}
	
	return 0
]]></Implementation>
</Method>

<Method name="getArrayOfBookerQuestions">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[eventID,langID,&returnArray]]></FormalSpec>
<Implementation><![CDATA[
	do ..getArrayOfBookerPages(eventID, langID, .bookersPages)
	set counter=""
	for  {
		set counter=$O(bookersPages(counter))
		if counter="" quit
		set pageID=bookersPages(counter)
		set rsQuestions=##class(%ResultSet).%New("sc.xModules.objPage:qQuestionsByPageID")
		do rsQuestions.Execute(pageID)
		while rsQuestions.Next() {
			set scCodItemID=rsQuestions.Get("ID")
			set codItemNameID=rsQuestions.Get("objItemName")
			set returnArray(pageID,scCodItemID)=codItemNameID
		}
	}
]]></Implementation>
</Method>

<Method name="getArrayOfBookerPages">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[eventID,langID,&bookersPages]]></FormalSpec>
<Implementation><![CDATA[
	kill bookersPages
	set counter=1
	set bookersPageID=##class(sc.xModules.objPage).getBookerPageID(eventID,langID)	
	
	set bookersPages(counter)=bookersPageID
	set rsPaymentMethodPages=##class(%ResultSet).%New("eCom.objPaymentMethod:qAllPaymentMethodPages")
	do rsPaymentMethodPages.Execute(eventID)
	while rsPaymentMethodPages.Next() {
		set counter=counter+1
		set paymentmethodPageID=rsPaymentMethodPages.Get("instructionPageID")
		set bookersPages(counter)=paymentmethodPageID
	}
]]></Implementation>
</Method>

<Method name="isBasketItemIDRelatedToABookersQuestion">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,langID,basketItemID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set foundBookerQuestionMatch=0
	set scCodItemIDForIncomingBasketItemID=..getScIDfromBasketItemID(basketItemID)
	
	kill bookerQuestions
	do ..getArrayOfBookerQuestions(eventID,langID,.bookerQuestions)
	set loopPageID=""
	for  {
		set loopPageID=$O(bookerQuestions(loopPageID))
		if loopPageID="" quit
		
		set loopScCodItemID=""
		for  {
			set loopScCodItemID=$O(bookerQuestions(loopPageID,loopScCodItemID))
			if loopScCodItemID="" quit
			
			if (scCodItemIDForIncomingBasketItemID=loopScCodItemID) {
				set foundBookerQuestionMatch=1
				quit
			}
		}
	}
	return foundBookerQuestionMatch
]]></Implementation>
</Method>

<Method name="getScIDfromBasketItemID">
<ClassMethod>1</ClassMethod>
<FormalSpec>basketItemID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set scCodItemID=""
	
	// is it an ABI?
	set alternativeExtrasID=##class(cod.objAlternativeExtras).getExtrasIDfromBasketItemID(basketItemID)
	if (alternativeExtrasID) {
		// get the scID?
		set scCodItemID=##class(cod.objAlternativeExtras).getDataIDfromAlternativeExtrasID(alternativeExtrasID)
	}
	
	// is it a QBI?
	set ticketID=##class(cod.objTicket).getTicketIDfromBasketItemID(basketItemID)
	if (ticketID) {
		// get the scID?
		set scCodItemID=##class(cod.objTicket).getDataIDfromTicketID(ticketID)
	}
	
	return scCodItemID
]]></Implementation>
</Method>

<Method name="checkAllowed">
<ClassMethod>1</ClassMethod>
<FormalSpec>extrasID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set eventCategoryID="",allowedToSee=1 

	if ##class(setup.objSystemTypes).isModuleAllowed("Attendee Categories")	{
		if %session.Get("mode")="preview"	{
			if %request.Get("hideButtons") {
				// preview mode
				if %request.Get("eventCategoryID") {
					set allowedToSee=+##class(links.lnkEventCategoryAltExtras).allow(%request.Get("eventCategoryID"),extrasID)
				}
			} else {
				if $G(%session.Data("eventsforce","frontend","currentPersonID"))	{
					set tempPersonID=$G(%session.Data("eventsforce","frontend","currentPersonID"))
					// get the categoryID - may be null
					set eventCategoryID=##class(eCom.tempPurchase).getEventCategory(%session.SessionId,tempPersonID)
					if eventCategoryID {
						set allowedToSee=+##class(links.lnkEventCategoryAltExtras).allow(eventCategoryID,extrasID)
					}
				}
				// if I've get the categoryID from above then that overrides the original MyAccount categories (as a person can theoretically be assigned to more than one category in the links.lnkPersonEventCategory)
				if 'eventCategoryID	{
					set personID=$G(%session.Data("eventsforce","xtfrontend","MyAccount","personID"))
					// check logged in
					if personID {
						set eventID=$G(%session.Data("eventsforce","frontend","xEventID"))
						// can this person see this dataID (based on the links.lnkPersonEventCategory)
						set allowedToSee=+##class(links.lnkEventCategoryAltExtras).allowMyAccount(eventID,personID,extrasID)
					}
				}
			}
		}
	}
	quit allowedToSee
]]></Implementation>
</Method>

<Method name="removePlaceOnSameLine">
<Description>
split up all questions on registration pages that are placed on the same line as part of phasing out this functionality</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<Implementation><![CDATA[	&SQL(UPDATE sc_xModules.objCODitem SET supressNewLine=0 WHERE (supressNewLine=1) AND (objEvent = :eventID))
]]></Implementation>
</Method>

<Method name="getLanguageID">
<Implementation><![CDATA[
	set languageID=""
	set objPage=..parent.parent
	set objLanguage=objPage.objLanguage
	if $IsObject(objLanguage) {
		set languageID=objLanguage.%Id()	
	}
	return languageID
]]></Implementation>
</Method>

<Method name="doCustomValidation">
<FormalSpec><![CDATA[value,&errString,&store]]></FormalSpec>
<Implementation><![CDATA[
	#dim ok as %Boolean = 1
	#dim errDelim as %String ="|"
	if $l(..getBespokeValidationMethod()) {
		set ok=1
	} elseif ($E(..requiredAnswer,1)="?") ! ($E(..requiredAnswer,1,2)="'?") {
		set ok=##class(cod.objItemName).patternMatch(value,..requiredAnswer)
	} elseif ..requiredAnswer?1"#"2.AN {
		if ..requiredAnswer="#personRegisteredWithSameAnswer" {
			do ..validatePersonRegisteredWithSameAnswer(value,.errString,.store)
		} else {
			set ok=-1			
		}
	} else { // direct string comparasion
		if $zcvt(value,"u")'=$zcvt(..requiredAnswer,"U") set ok=0
	}
	
	if 'ok {
		if $l($p(ok,"|",2)) {
			set errString=errString_$S($L(errString):errDelim,1:"")_$p(ok,"|",2)
		} else {
			do ..addValidationFailureMessage(.errString)
		}
		set store=0
	}
	if ok=-1 {
		set errString=errString_$S($L(errString):errDelim,1:"")_##class(shared.pCSP).out("The question")_" '"_..description_"' "_##class(shared.pCSP).out("has a validation error")
		set store=0
	}
]]></Implementation>
</Method>

<Method name="hasPromptPassedBespokeValidationForTempPerson">
<FormalSpec>tempPersonID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set methodName=..getBespokeValidationMethod()
	if $l(methodName) {
		set codItemName=..objItemName.description
		set data=##class(eCom.tempCodData).get(tempPersonID,codItemName)
		set className="customCode.codAnswerValidation."_##class(shared.callOuts).classNameForBespokeCode()
		return $CLASSMETHOD(className,methodName,codItemName,data,tempPersonID)
	}
	return 1
]]></Implementation>
</Method>

<Method name="doBespokeValidationForTempPerson">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[tempPersonID,listOfQuestions:%ListOfDataTypes,&arrayOfMandatoryQuestions,&errString]]></FormalSpec>
<Implementation><![CDATA[
	#dim question as sc.xModules.objCODitem
	#dim errDelim as %String ="|"
	for ind=1:1:listOfQuestions.Count() {
		set question=listOfQuestions.GetAt(ind)
		set ok=question.hasPromptPassedBespokeValidationForTempPerson(tempPersonID)
		if 'ok {
			set errMsg=$p(ok,"|",2)
			if $l(errMsg) {
				set errString=errString_$S($L(errString):errDelim,1:"")_errMsg
			} else {
				do question.addValidationFailureMessage(.errString)
			}
			set data=$G(mandatoryItems(question.objItemName.%Id()))
			// If mandatorty set to the original otherwise blank
			do ##class(eCom.tempCodData).set(tempPersonID,question.objItemName.description,data,question.getPageIDforQuestion(question.%Id()),question.objEvent.%Id())	
		}
	}
]]></Implementation>
</Method>

<Method name="getBespokeValidationMethod">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if $E(..requiredAnswer,1,2)="##" {
		set callOutMethod=$e(..requiredAnswer,3,$l(..requiredAnswer))
		if callOutMethod?1A.AN {
			return callOutMethod	
		}
	}
	return ""
]]></Implementation>
</Method>

<Method name="validatePersonRegisteredWithSameAnswer">
<FormalSpec><![CDATA[value,&errString,&store]]></FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
	if ..type="time" {
		set value = ##class(shared.timeFunctions).getHorologTime(value)	
	} elseif ..type="date" {
		set value=##class(shared.dateFunctions).multiDate(value,1)	
	}
	if ##class(cod.objItemData).findSingleForEvent(..objItemName.description,value,..objEvent.%Id()) {
		// Found a person with this data
		
	} else {
		do ..addValidationFailureMessage(.errString)
		set store=0
	}
]]></Implementation>
</Method>

<Method name="addValidationFailureMessage">
<FormalSpec><![CDATA[&errString]]></FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
	#dim errDelim as %String ="|"
	
	if ..validationErrorMessage="" {
		set errString=errString_$S($L(errString):errDelim,1:"")_##class(shared.pCSP).out("The question")_" '"_..description_"' "_##class(shared.pCSP).out("was not answered correctly")
	} else {
		set errString=errString_$S($L(errString):errDelim,1:"")_..validationErrorMessage
	}
]]></Implementation>
</Method>

<Method name="tempRemoveMe">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	return 1
]]></Implementation>
</Method>

<Method name="getQuestionForCodItemNameIDAndPageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,itemNameID,attendeeCategoryID="",isGuest=0</FormalSpec>
<ReturnType>sc.xModules.objCODitem</ReturnType>
<Implementation><![CDATA[
	set dataID=""
	set rsQuestions=##class(%ResultSet).%New("sc.xModules.objCODitem:qSCitemsByCODitem")
	do rsQuestions.Execute(pageID,itemNameID)
	while rsQuestions.Next() {
		set dataID=rsQuestions.Get("ID")
		if (isGuest)&&('rsQuestions.Data("isGuest")) {
			continue
		}
		if ('isGuest)&&('rsQuestions.Data("isDelegate")) {
			continue
		}
		if (attendeeCategoryID)&&('##class(links.lnkEventCategoryData).allow(attendeeCategoryID,dataID)) {
			continue
		}
		set question=##class(sc.xModules.objCODitem).%OpenId(dataID)
		do question.%Reload()
		return question
	}
	return ""
]]></Implementation>
</Method>

<Method name="getPromptNameForErrorMessage">
<Implementation><![CDATA[
	set tmpDesc=..description
	set tmpDesc=##class(shared.stringFunctions).removeHTML(tmpDesc) 
	set tmpLength = $L(tmpDesc)
	if tmpLength > 50 set tmpDesc = $E(tmpDesc, 1, 40)_"..."_$E(tmpDesc, tmpLength-7, tmpLength)
	set tmpDesc=$TR(tmpDesc,$C(13)_$C(10),"") // remove CRLF that can cause JS error
	set tmpDesc = ##class(shared.stringFunctions).hyperTranslate(tmpDesc,"\","\\")
	set tmpDesc = ##class(shared.stringFunctions).hyperTranslate(tmpDesc,"'","\'")
	set tmpDesc = ##class(shared.stringFunctions).hyperTranslate(tmpDesc,"""","\""")
	return tmpDesc
]]></Implementation>
</Method>

<Method name="hasSurroundingTable">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// do we need a surrounding table
	set surroundingTable=0
	if (..promptWidth)!(..dependsOnAlternative) set surroundingTable=1
	if ..supressNewLine set surroundingTable=0
	if $IsObject(%session) {
		if %session.Get("mode") = "edit" {
			set surroundingTable = 0
		}
	}
	return surroundingTable
]]></Implementation>
</Method>

<Method name="getGeneratorName">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if ..type="text" {
		return "textField"
		
	} elseif ..type="textarea" {
		return "textArea"
		
	} elseif ..type="radiobutton" {
		return "radioButtons" 	
		
	} elseif ..type="checkbox" {
		return "checkBox" 	
		
	} elseif ..type="dropdown" {
		return "dropDown" 	
		
	} elseif ..type="password" {
		return "passwordField" 	
		
	} elseif ..type="multibox" {
		return "multiCheckBoxes" 	
		
	} elseif ..type="date" {
		return "dateField" 	
		
	} elseif ..type="dateRange" {
		return "dateRange" 	
		
	} elseif ..type="time" {
		return "timeField" 	
		
	} elseif ..type="outputOnly" {
		return "outputOnly"
			
	} elseif ..type="private" {
		return "privateField"
			
	} else {
		return "textField" 	
	}
]]></Implementation>
</Method>

<Query name="qReportItems">
<Description>
this will show all the cod items used in reg page for guests and deles with no overlaps
ie if guest and dele have used firstname, only one firstname will appear in this query as
it is using GROUP BY objItemName</Description>
<Type>%SQLQuery</Type>
<FormalSpec>regPageID:%String</FormalSpec>
<SqlQuery><![CDATA[SELECT ID As scID,description,objItemName As ID,objItemName->description As codName,displayOrder 
FROM sc_xModules.objCODitem 
WHERE (parent->parent = :regPageID) AND (reportOn = 1) AND (active=1)
GROUP BY objItemName 
ORDER BY description]]></SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Query name="qReportItemsDelegate">
<Type>%SQLQuery</Type>
<FormalSpec>regPageID:%String</FormalSpec>
<SqlQuery><![CDATA[SELECT ID As scID,description,objItemName As ID,objItemName->description As codName,displayOrder 
FROM sc_xModules.objCODitem 
WHERE (parent->parent = :regPageID) AND (reportOn = 1) AND (isDelegate = 1) AND (active=1)
ORDER BY displayOrder]]></SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Query name="qReportItemsGuest">
<Type>%SQLQuery</Type>
<FormalSpec>regPageID:%String</FormalSpec>
<SqlQuery><![CDATA[SELECT ID As scID,description,objItemName As ID,objItemName->description As codName,displayOrder 
FROM sc_xModules.objCODitem 
WHERE (parent->parent = :regPageID) AND (reportOn = 1) AND (isGuest = 1) AND (active=1)
ORDER BY displayOrder]]></SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Query name="qItemsByPage">
<Type>%SQLQuery</Type>
<FormalSpec>pageID:%String</FormalSpec>
<SqlQuery><![CDATA[SELECT ID As scID,description,objItemName As ID,objItemName->description As codName,displayOrder,isDelegate,isGuest
FROM sc_xModules.objCODitem 
WHERE (parent->parent = :pageID) AND (active=1)
ORDER BY displayOrder]]></SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Query name="qQuestionsByGroupID">
<Type>%SQLQuery</Type>
<FormalSpec>groupID:%String</FormalSpec>
<SqlQuery><![CDATA[SELECT ID As scID,description,objItemName As codItemID,objItemName->description As codName
FROM sc_xModules.objCODitem 
WHERE (parent->parent->parent = :groupID) AND (active=1)
ORDER BY parent->parent,displayOrder]]></SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Query name="qAdditionalItemsByPage">
<Type>%SQLQuery</Type>
<FormalSpec>pageID:%String</FormalSpec>
<SqlQuery><![CDATA[SELECT ID As scID, description, objItemName As itemNameID, objItemName->description As codName, displayOrder, isDelegate, isGuest 
FROM sc_xModules.objCODitem 
WHERE (parent->parent = :pageID) AND (isAdditionalItem = 1) AND (active=1)
ORDER BY displayOrder]]></SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Query name="qQBIsByPage">
<Type>%SQLQuery</Type>
<FormalSpec>pageID:%String</FormalSpec>
<SqlQuery><![CDATA[SELECT ID As scID, description, objItemName As itemNameID, objItemName->description As codName, displayOrder, isDelegate, isGuest 
FROM sc_xModules.objCODitem 
WHERE (parent->parent = :pageID) AND (isQuantityItem = 1) AND (active=1)
ORDER BY displayOrder]]></SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Query name="qSCitemsByCODitem">
<Description>
get a list of these sc items that relate to a cod item</Description>
<Type>%SQLQuery</Type>
<FormalSpec>regPageID:%String,codItemNameID</FormalSpec>
<SqlQuery><![CDATA[SELECT ID,description,isDelegate,isGuest,type,displayOrder,mandatory
FROM sc_xModules.objCODitem 
WHERE (parent->parent = :regPageID) AND (objItemName = :codItemNameID) AND (active=1)
ORDER BY objItemName->codGroup DESC,displayOrder]]></SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Method name="getQuestionIDFromPageAndCodItem">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,itemNameID,isGuest=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set dataID=""
	set rsQuestions=##class(%ResultSet).%New("sc.xModules.objCODitem:qSCitemsByCODitem")
	do rsQuestions.Execute(pageID,itemNameID)
	while rsQuestions.Next() { 
		if (isGuest&&rsQuestions.Data("isGuest")) {
			set dataID=rsQuestions.Data("ID")
			quit
		}
		if ('isGuest&&rsQuestions.Data("isDelegate")) {
			set dataID=rsQuestions.Data("ID")
			quit
		}
	}
	return dataID
]]></Implementation>
</Method>

<Method name="isQuestionABackendOnlyQuestion">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set backend=0
	&SQL(SELECT backendOnly INTO :tmp FROM sc_xModules.objCODitem WHERE ID=:dataID)
	if ((+SQLCODE=0)&&(tmp)) set backend=1
	return backend
]]></Implementation>
</Method>

<Method name="getPromptTextJSsafe">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim result = ""
	set result=##class(EF.conversions.htmlToText).stripHTML(..description)
	
	set result=$TR(result,$C(13)_$C(10)," ") // remove CRLF that can cause JS error
	set result = $replace(result,"\","\\")
	set result = $replace(result,"'","\'")
	set result = $replace(result,"""","\""")
	
	#dim tmpLength = $L(result)
	if tmpLength > 50 set result = $E(result, 1, 40)_"..."_$E(result, tmpLength-7, tmpLength)
	
	return result
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>objCODitemDefaultData</DefaultData>
<Data name="objCODitemDefaultData">
<Subscript>"objCODitem"</Subscript>
<Value name="1">
<Value>objItemName</Value>
</Value>
<Value name="2">
<Value>description</Value>
</Value>
<Value name="3">
<Value>fieldHeight</Value>
</Value>
<Value name="4">
<Value>fieldWidth</Value>
</Value>
<Value name="5">
<Value>helptText</Value>
</Value>
<Value name="6">
<Value>layout</Value>
</Value>
<Value name="7">
<Value>mandatory</Value>
</Value>
<Value name="8">
<Value>type</Value>
</Value>
<Value name="9">
<Value>helpText</Value>
</Value>
<Value name="10">
<Value>isDelegate</Value>
</Value>
<Value name="11">
<Value>isGuest</Value>
</Value>
<Value name="12">
<Value>reportOn</Value>
</Value>
<Value name="13">
<Value>backendOnly</Value>
</Value>
<Value name="14">
<Value>courseID</Value>
</Value>
<Value name="15">
<Value>dependsOn</Value>
</Value>
<Value name="16">
<Value>dependsOnAlternative</Value>
</Value>
<Value name="17">
<Value>dependsOnPrompt</Value>
</Value>
<Value name="18">
<Value>isAddtionalItem</Value>
</Value>
<Value name="19">
<Value>isAdditionalItem</Value>
</Value>
<Value name="20">
<Value>requiredAnswer</Value>
</Value>
<Value name="21">
<Value>supressNewLine</Value>
</Value>
<Value name="22">
<Value>promptWidth</Value>
</Value>
<Value name="23">
<Value>isQuantityItem</Value>
</Value>
<Value name="24">
<Value>readonlyFrontend</Value>
</Value>
<Value name="25">
<Value>reportDescription</Value>
</Value>
<Value name="26">
<Value>readonlyAmendment</Value>
</Value>
<Value name="27">
<Value>maxCharacters</Value>
</Value>
<Value name="28">
<Value>maxWords</Value>
</Value>
<Value name="29">
<Value>maxAltsChecked</Value>
</Value>
<Value name="30">
<Value>minAltsChecked</Value>
</Value>
<Value name="31">
<Value>defaultValue</Value>
</Value>
<Value name="32">
<Value>noAmendments</Value>
</Value>
<Value name="33">
<Value>dependsOnPromptPage</Value>
</Value>
<Value name="34">
<Value>minTimestamp</Value>
</Value>
<Value name="35">
<Value>maxTimestamp</Value>
</Value>
<Value name="36">
<Value>copyValueFromRegistrationContact</Value>
</Value>
<Value name="37">
<Value>copyValueFromBooker</Value>
</Value>
<Value name="38">
<Value>validationErrorMessage</Value>
</Value>
<Value name="39">
<Value>searchAsYouType</Value>
</Value>
</Data>
<Property name="active">
<Selectivity>49.9998%</Selectivity>
</Property>
<Property name="afterItem">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="afterRow">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="backendOnly">
<Selectivity>33.3332%</Selectivity>
</Property>
<Property name="beforeItem">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="beforeRow">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="courseID">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="creator">
<Selectivity>7.1429%</Selectivity>
</Property>
<Property name="dataType">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="dependsOnAlternative">
<Selectivity>6.2500%</Selectivity>
</Property>
<Property name="dependsOnPrompt">
<Selectivity>4.5455%</Selectivity>
</Property>
<Property name="description">
<Selectivity>0.6444%</Selectivity>
</Property>
<Property name="displayOrder">
<Selectivity>1.2187%</Selectivity>
</Property>
<Property name="fieldHeight">
<Selectivity>33.3332%</Selectivity>
</Property>
<Property name="fieldWidth">
<Selectivity>8.3333%</Selectivity>
</Property>
<Property name="helpText">
<Selectivity>49.9998%</Selectivity>
</Property>
<Property name="isAdditionalItem">
<Selectivity>49.9998%</Selectivity>
</Property>
<Property name="isDelegate">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="isGuest">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="isQuantityItem">
<Selectivity>49.9998%</Selectivity>
</Property>
<Property name="layout">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="mandatory">
<Selectivity>33.3332%</Selectivity>
</Property>
<Property name="nextVersion">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="objItemName">
<Selectivity>0.6682%</Selectivity>
</Property>
<Property name="objStep">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="parent">
<Selectivity>0.0488%</Selectivity>
</Property>
<Property name="previousVersion">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="promptWidth">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="publishAt">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="readonlyAmendment">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="readonlyFrontend">
<Selectivity>49.9998%</Selectivity>
</Property>
<Property name="reportDescription">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="reportOn">
<Selectivity>33.3332%</Selectivity>
</Property>
<Property name="requiredAnswer">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="sourceID">
<Selectivity>99.9991%</Selectivity>
</Property>
<Property name="supressNewLine">
<Selectivity>49.9998%</Selectivity>
</Property>
<Property name="type">
<Selectivity>10.0000%</Selectivity>
</Property>
<Property name="xCRstamp">
<Selectivity>0.2194%</Selectivity>
</Property>
<Property name="xCRuserID">
<Selectivity>5.2632%</Selectivity>
</Property>
<Property name="xMOstamp">
<Selectivity>0.0535%</Selectivity>
</Property>
<Property name="xMOuserID">
<Selectivity>4.5455%</Selectivity>
</Property>
</Storage>
</Class>


<Class name="sc.xModules.objList">
<Description><![CDATA[
Holds a list of other objects as children.
<!-- ;vc;
;vc;    Object: sc.xModules.objList.CLS/EV.3
;vc; Component: CLS.sc.xModules.objList
;vc;  Location: SmallDev
;vc; Date/Time: 25-Apr-16 14:50
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>sc.xModules.objList.CLS/EV.3</td><td>CLS.sc.xModules.objList</td><td>SmallDev</td><td style='white-space: nowrap;'>25-Apr-16 14:50</td><td>JeremyW</td></tr></table>
]]></Description>
<ClassType>persistent</ClassType>
<ProcedureBlock>1</ProcedureBlock>
<Super>sc.objData</Super>
<TimeChanged>64218,43868.929788</TimeChanged>
<TimeCreated>58926,57261</TimeCreated>

<Parameter name="EXTENTSIZE">
<Default>3492</Default>
</Parameter>

<Property name="dataType">
<Description>
Used for identifying the class of the object withour having to call
cache mysterious APIs.</Description>
<Type>%Library.String</Type>
<InitialExpression>"objList"</InitialExpression>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="subClass">
<Type>%Library.String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Method name="add">
<Description>
Creates new list object. Should be done the first time the page is loaded</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set pageID=+pageID
	if pageID=0 quit "0|no page ID passed in to add.objList"
	set stepID=##class(sc.objStep).getFinalLevelID()
	&SQL(INSERT INTO sc_xModules.objList (parent,creator,active,objStep) VALUES (:pageID,'system',1,:stepID))
	
	quit %ROWID
]]></Implementation>
</Method>

<Method name="getListIDFromPageIDAndComponentName">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,componentName</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set rsLists = ##class(%ResultSet).%New("sc.objData:qGetChildren")
	do rsLists.Execute(pageID)
	while rsLists.Next() {
		set listID = rsLists.Get("ID")		
		if $ZCVT(##class(sc.objComponent).getComponentName(listID),"L") = $ZCVT(componentName,"L") {
			return listID
		}
	}
	return ""
]]></Implementation>
</Method>

<Query name="qGetQuestions">
<Type>%SQLQuery</Type>
<FormalSpec>listID:%String=""</FormalSpec>
<SqlQuery>SELECT ID FROM sc_xModules.objCODitem
 WHERE (parent = :listID) 
 AND (active = 1)
 ORDER BY displayOrder</SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Query name="qGetChildren">
<Type>%SQLQuery</Type>
<FormalSpec>listID:%String=""</FormalSpec>
<SqlQuery>SELECT * FROM sc.objData
 WHERE (parent = :listID) AND (active = 1)
 ORDER BY displayOrder</SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>objListDefaultData</DefaultData>
<Data name="objListDefaultData">
<Subscript>"objList"</Subscript>
<Value name="1">
<Value>subClass</Value>
</Value>
</Data>
<Property name="active">
<Selectivity>49.9999%</Selectivity>
</Property>
<Property name="creator">
<Selectivity>49.9999%</Selectivity>
</Property>
<Property name="dataType">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="displayOrder">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="nextVersion">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="objStep">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="parent">
<Selectivity>0.0320%</Selectivity>
</Property>
<Property name="previousVersion">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="publishAt">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="sourceID">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="subClass">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="xCRstamp">
<Selectivity>0.6952%</Selectivity>
</Property>
<Property name="xCRuserID">
<Selectivity>9.0909%</Selectivity>
</Property>
<Property name="xMOstamp">
<Selectivity>0.1257%</Selectivity>
</Property>
<Property name="xMOuserID">
<Selectivity>6.2499%</Selectivity>
</Property>
</Storage>
</Class>


<Class name="sc.xModules.objPage">
<Description><![CDATA[
The data type that represents a a page level in the hierachy. 
<!-- ;vc;
;vc;    Object: sc.xModules.objPage.CLS/EV.40
;vc; Component: CLS.sc.xModules.objPage
;vc;  Location: LargeDev
;vc; Date/Time: 24-Jan-17 15:57
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>sc.xModules.objPage.CLS/EV.40</td><td>CLS.sc.xModules.objPage</td><td>LargeDev</td><td style='white-space: nowrap;'>24-Jan-17 15:57</td><td>FredG</td></tr></table>
]]></Description>
<ClassType>persistent</ClassType>
<ProcedureBlock>1</ProcedureBlock>
<Super>sc.objData</Super>
<TimeChanged>64308,31426.837242</TimeChanged>
<TimeCreated>58926,57261</TimeCreated>

<Parameter name="EXTENTSIZE">
<Default>6869</Default>
</Parameter>

<Property name="accessLevel">
<Type>%Library.String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="dataType">
<Description>
Used for identifying the class of the object without having to call
cache mysterious APIs.</Description>
<Type>%Library.String</Type>
<InitialExpression>"objPage"</InitialExpression>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="description">
<Description>
Only used in the backend when navigation thru the tree.</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="250"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="staticPage">
<Description>
The filename for the static version (if applicable) of this page</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="500"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="staticURL">
<Description>
The URL for the static version (if applicable) of this page</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="500"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="objTemplate">
<Type>sc.objTemplate</Type>
<Cardinality>one</Cardinality>
<Inverse>objPages</Inverse>
<Relationship>1</Relationship>
</Property>

<Property name="showInMenu">
<Description>
This prop will be used to build up a tree structure for a dynamic
menu system which might be in javascript or in HTML.</Description>
<Type>%Library.Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="redirect">
<Description>
holds trhe redirect name for direct access. Generates a static file which redirect to this page</Description>
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="allowRemoteUpdating">
<Description>
is the page available for auto update (what's new pages)</Description>
<Type>%Boolean</Type>
</Property>

<Property name="seoPageName">
<Description>
the seo friendly page name (shown in browser address bar)  JAW APR2010</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="50"/>
</Property>

<Property name="titleBarText">
<Description>
the browser title bar text for this page (html TITLE) JAW APR2010</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="100"/>
</Property>

<Property name="seoKeywords">
<Description>
SEO keywords output to the page (used by very few crawlers)  JAW APR2010</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="200"/>
</Property>

<Property name="seoDescription">
<Description>
SEO description output to the page (used by some crawlers in different ways)  JAW APR2010</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="400"/>
</Property>

<Property name="showInXmlSiteMap">
<Description>
should this page appear in the SEO site map?  JAW APR2010 (although not going to be used for now maybe never)</Description>
<Type>%Boolean</Type>
</Property>

<Property name="promptAlign">
<Description>
pjc 2010-04-21
customisable reg page form parameters
alignment of the form prompt TD</Description>
<Type>%String</Type>
<Parameter name="VALUELIST" value=",left,right,center,justify"/>
</Property>

<Property name="inputAlign">
<Description>
alignment of the form input TD </Description>
<Type>%String</Type>
<Parameter name="VALUELIST" value=",left,right,center,justify"/>
</Property>

<Property name="promptWidth">
<Description>
width of the form prompt TD</Description>
<Type>%Integer</Type>
</Property>

<Property name="inputWidth">
<Description>
width of the form input TD</Description>
<Type>%Integer</Type>
</Property>

<Property name="promptHeight">
<Description>
height of the form prompt TD</Description>
<Type>%Integer</Type>
</Property>

<Property name="inputHeight">
<Description>
height of the form input TD</Description>
<Type>%Integer</Type>
</Property>

<Property name="units">
<Description>
unit of measurement for the numeric values</Description>
<Type>%String</Type>
<Parameter name="VALUELIST" value=",pixels,percentage"/>
</Property>

<Property name="objLanguage">
<Type>shared.objLanguage</Type>
</Property>

<Method name="getStaticURL">
<Description>
return the static URL for this page if it has been compiled and it is a static page template</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=0
	
	if ##class(sc.objData).inStatic(pageID) {
		&SQL(SELECT staticURL INTO :tmp FROM sc_xModules.objPage WHERE ID = :pageID)
		if +SQLCODE=0 set out=tmp
	}
	
	quit out
]]></Implementation>
</Method>

<Method name="getTemplateFile">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID:%Integer</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set pageUrl = ""
	set objPage = ..%OpenId(pageID)
	do objPage.%Reload()
	set eventID = ..getEventID(pageID)
	if (eventID) && (##class(setup.objEvent).isEventUsingProweb2(eventID)) {
		set pageUrl = objPage.objTemplate.getProweb2PageUrl()
		
	}
	if '$Length(pageUrl) {
		set pageUrl = objPage.objTemplate.filename
	}
	return pageUrl
]]></Implementation>
</Method>

<Method name="add">
<ClassMethod>1</ClassMethod>
<FormalSpec>templateDescription:%Library.String="",pageDescription:%Library.String="",parent:%Library.String="",eventID="",langID=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
	// create new proweb page and return the pageID
	if $L(pageDescription)=0 quit "0|no description"
	
	//get the templateID 
	set tmp="",templateID=""
	&SQL(SELECT ID INTO :tmp FROM sc.objTemplate WHERE description = :templateDescription)
	if +SQLCODE=0 set templateID=tmp
	if 'templateID quit "0|no templateID"
	
	// create new
	set objData=##class(sc.xModules.objPage).%New()
	
	// parent
	set parent=$G(parent)
	if parent="" quit "0|no parent"
	do objData.parentSetObjectId(parent)
	
	if langID do objData.objLanguageSetObjectId(langID)
	
	// set creator
	set objData.active=1
	set objData.creator="system"
	
	// set the displayOrder to last
	set displayOrder=""
	&SQL(SELECT displayOrder INTO :displayOrder FROM sc.objData WHERE parent=:parent ORDER BY displayOrder DESC)
	set objData.displayOrder=(displayOrder+1)
	
	// set the step
	set finalStep=##class(sc.objStep).getFinalLevel()
	set finalStepID=##class(sc.objStep).getFinalLevelID()
	do objData.objStepSetObjectId(finalStepID)
	
	// set the template
	do objData.objTemplateSetObjectId(templateID)
	
	set objData.description=pageDescription
	if eventID do objData.objEventSetObjectId(eventID)
	
	set ok=objData.%Save()
	if 'ok set ^xERROR($ZTS,"addPage method","objData.%Save()"_pageDescription)=ok
	set pageID=objData.%Id()
	do objData.%Close()
	quit pageID
]]></Implementation>
</Method>

<Method name="getBeforeItem">
<Description>
pjc 2010-06-01 configurable width + alignment for TDs
Method to return the before item string to use as a parameter to the SC:FREE tag
Includes any alignment, width etc parameters
Includes the default CSS class for TDs
Accepts three optional parameters - width, colspan, styleClass, noTR (no table row)
Note that this only applies to the prompt TDs
Input TDs are written out in coditem.csp</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID:%Integer,notUsed1,notUsed2,notUsed3,notUsed4,notUsed5</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// pjc 2011-12-14 drag and drop on all pages
	set beforeItem="<tr class=""draggableTR""><td"
	
	&SQL(SELECT promptAlign, promptHeight, promptWidth, units INTO :promptAlign, :promptHeight, :promptWidth, :units FROM sc_xModules.objPage WHERE ID = :pageID)
	if +SQLCODE=0 {
		
		// CSS
		set CSSClass=##class(setup.objSetting).getParameter("frontend","td css class") // never set anywhere as of 2010-04-28 but could well be useful in future
		if (CSSClass=""){
			set CSSClass="black12px ef_proweb_form_prompt"
		}
		
		set beforeItem=beforeItem_" class="""_CSSClass_""""
		
		// HTML attributes
		if (promptAlign '= "") {
			set beforeItem=beforeItem_" align="""_promptAlign_""""
		}
		
		if (units="percentage"){
			set units="%"
		}else{
			set units="px"	
		}
		
		if (promptHeight) {
			set beforeItem=beforeItem_" height="""_promptHeight_"px""" // % makes no sense for height measurements
		}	
		
		if (promptWidth) {
			set beforeItem=beforeItem_" width="""_promptWidth_units_""""
		}
	}
	
	set beforeItem=beforeItem_">" // close the TD
	
	quit beforeItem
]]></Implementation>
</Method>

<Method name="getExtraBit">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set langID=##class(sc.methods).getLangFromPageID(pageID)
	set extraBit=""
	if langID'=1 set extraBit=" - "_##class(shared.objLanguage).getLanguageDesc(langID)
	return extraBit
]]></Implementation>
</Method>

<Method name="getBookerPageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,langID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set extraBit=##class(sc.pageMethods).getDescriptionModifier(langID)
	
	if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",eventID) {
		set bookerPageID=..getAwardSubmitterPageID(eventID,langID)
	} else {
		set bookerPageID=##class(setup.objEventSetting).getParameter("bookings","bookerRegPageID"_extraBit,eventID)
	}
	return bookerPageID
]]></Implementation>
</Method>

<Method name="getAwardSubmitterPageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,langID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set pageID=##class(setup.objEventSetting).getParameter("awards","awardClientPageID",eventID)
	return pageID
]]></Implementation>
</Method>

<Method name="isBookerPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set out=0
	set eventID=##class(sc.methods).getEventIDfromPageID(pageID)
	if pageID=##class(setup.objEventSetting).getParameter("bookings","bookerRegPageID"_..getExtraBit(pageID),eventID) {
		set out=1
	}	
	quit out
]]></Implementation>
</Method>

<Method name="isAwardsEntryPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set isAwardsEntryPage=0
	&SQL(SELECT ID INTO :tmp FROM awards.objCategory WHERE pageID=:pageID)
	if +SQLCODE=0 {
		set isAwardsEntryPage=1
	}
	return isAwardsEntryPage
]]></Implementation>
</Method>

<Method name="isAbstractDocumentPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
 	Set inAbsDocPage=0
 	set eventID=##class(sc.methods).getEventIDfromPageID(pageID)
 	if ##class(setup.objEventSetting).getParameter("event setup","has abstracts",eventID) {
		set documentPageID=##class(setup.objEventSetting).getParameter("abstract management pages","documentPageID"_..getExtraBit(pageID),eventID)
		if (pageID=documentPageID) {
			Set inAbsDocPage=1
		}
 	}
 	return inAbsDocPage
]]></Implementation>
</Method>

<Method name="isAbstractSignUpPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	
	set eventID=##class(sc.methods).getEventIDfromPageID(pageID)
	set signUpPageID=##class(setup.objEventSetting).getParameter("abstract management pages","signUpPageID"_..getExtraBit(pageID),eventID)
	if pageID=signUpPageID {
		set result=1
	} else {
		set result=0	
	}
	return result
]]></Implementation>
</Method>

<Method name="isRegistrationPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set parentID=##class(sc.objData).getParentID(pageID)
	set groupName=##class(sc.xModules.objGroup).getDescription(parentID)
	set result=0
	if $ZCVT(groupName,"L")="registration pages" set result=1
	return result
]]></Implementation>
</Method>

<Method name="isPaymentMethodPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set parentID=##class(sc.objData).getParentID(pageID)
	set groupName=##class(sc.xModules.objGroup).getDescription(parentID)
	set result=0
	if $ZCVT(groupName,"L")="payment method instructions" set result=1
	return result
]]></Implementation>
</Method>

<Method name="isPageForBooker">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set result=0
	if ..isBookerPage(pageID) set result=1
	if ..isPaymentMethodPage(pageID) set result=1
	return result
]]></Implementation>
</Method>

<Method name="checkDependenciesRecursively">
<Description>
check through lists on a page to check for any parents of dependent prompts
if these have active, non-cancelled data, return true
check needed to prevent deletion of pages containing such items
start with a passed-in pageID</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Integer=0,eventCategoryID:%Integer,eventID:%Integer=0</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	
	if (dataID=0!eventID=0!eventCategoryID=0) {
		quit 0
	}
	
	set ok=1
	
	// is dataID a page dependent on a prompt which has active data saved
	&SQL(SELECT ID FROM sc.objData WHERE ID=:dataID AND dataType='objPage')
	if (+SQLCODE=0){
	 	&SQL(SELECT dependsOnObjItemName->description INTO :tmp FROM setup.lnkCategoryEvent WHERE (objEventCategory=:eventCategoryID) AND (objEvent=:eventID) AND (dependsOnPromptPageID IS NOT NULL) AND ((pageID=:dataID) OR (sameAs->pageID=:dataID)))
	 	if (+SQLCODE=0) {
			set promptName=tmp
	 		set hasActiveData=##class(cod.objItemData).findActiveData(promptName,eventID)
	 		if (hasActiveData=1) {
				set ok=0	
	 		}
	 	}
	}
	if ok=0 quit ok
	
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 	do rs.Prepare("SELECT ID, dataType FROM sc.objData WHERE parent=?")
 	do rs.Execute(dataID)
 	while rs.Next() {
 		if (rs.Get("dataType")="objList"){
	 		// call self to check through lists on page
 			set ok=##class(sc.xModules.objPage).checkDependenciesRecursively(rs.Get("ID"),eventCategoryID,eventID)		
 		} elseif (rs.Get("dataType")="objCODitem"){
	 		// do we have children?
	 		set myID = rs.Get("ID")
	 		set hasChildren=0
	 		&SQL(SELECT TOP 1 ID FROM sc_xModules.objCODitem WHERE dependsOnPrompt = :myID)
	 		if (+SQLCODE = 0) { // yes we do
	 			set hasChildren=1
	 		}
	 		if (hasChildren=0) { // do we have dependent text blocks
	 			&SQL(SELECT TOP 1 ID FROM sc_xModules.objText WHERE dependsOnPrompt = :myID)
	 			if (+SQLCODE = 0) { // yes we do
	 				set hasChildren=1
	 			}	
	 		}
	 		if (hasChildren) {
		 		&SQL(SELECT description INTO :tmp FROM sc_xModules.objCODitem WHERE ID = :myID)
		 		if (+SQLCODE=0) {
			 		set promptName=tmp
	 				set hasActiveData=##class(cod.objItemData).findActiveData(promptName,eventID)
	 				if (hasActiveData=1) {
		 				set ok=0	
	 				}
		 		}
	 		}
 		}
 		if ok=0 quit
 	}
	quit ok
]]></Implementation>
</Method>

<Method name="getTemplateName">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=""
	&SQL(SELECT objTemplate->description INTO :tmp
		FROM sc_xModules.objPage
		WHERE ID = :pageID
	)
	if +SQLCODE=0 {
		set out=tmp
	}
	quit out
]]></Implementation>
</Method>

<Method name="updateObjLanguage">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,langID</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objPage SET objlanguage = :langID WHERE ID = :dataID)
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalException).%New("updating sc.ObjData with objLanguage failed")
]]></Implementation>
</Method>

<Method name="getDescription">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	&SQL(SELECT description INTO :tmp  FROM sc_xModules.objPage WHERE id = :dataID)
	if +SQLCODE=0 {
		return tmp
	} else {
		return ""
	}
]]></Implementation>
</Method>

<Method name="updateDescription">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,description</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc_xModules.objPage SET description = :description WHERE ID = :pageID)
	if +SQLCODE'=0 {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$g(%msg))
	}
]]></Implementation>
</Method>

<Method name="hasAnyQuestionThatAffectsPricing">
<ClassMethod>1</ClassMethod>
<FormalSpec>paymentPageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	do ..getArrayOfQuestionsThatAffectsPricing(paymentPageID,.questions)
	return $Data(questions)>0
]]></Implementation>
</Method>

<Method name="getArrayOfQuestionsThatAffectsPricing">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[pageID,&array]]></FormalSpec>
<Implementation><![CDATA[
	kill array
	set rsQuestions=##class(%ResultSet).%New("sc.xModules.objPage:qQuestionsByPageID")
	do rsQuestions.Execute(pageID)
	while rsQuestions.Next() {
		set questionID=rsQuestions.Get("ID")
		if (##class(sc.xModules.objCODitem).isQuestionRelatedToAnyPrice(questionID)) ! (##class(sc.xModules.objCODitem).isRelatedToAnyDiscounts(questionID)) {
			set count=$I(array)
			set array(count,"codID")=questionID	
			set array(count,"questionName")=rsQuestions.Get("description")	
		}
	}
]]></Implementation>
</Method>

<Method name="hasAnyQuestionThatAffectsPaymentMethods">
<ClassMethod>1</ClassMethod>
<FormalSpec>paymentPageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	do ..getArrayOfQuestionsThatAffectsPaymentMethods(paymentPageID,.questions)
	return $Data(questions)>0
]]></Implementation>
</Method>

<Method name="getArrayOfQuestionsThatAffectsPaymentMethods">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[pageID,&array]]></FormalSpec>
<Implementation><![CDATA[
	kill array
	set rsQuestions=##class(%ResultSet).%New("sc.xModules.objPage:qQuestionsByPageID")
	do rsQuestions.Execute(pageID)
	while rsQuestions.Next() {
		set questionID=rsQuestions.Get("ID")
		if ##class(sc.xModules.objCODitem).isRelatedToAnyPaymentMethods(questionID) {
			set count=$I(array)
			set array(count,"codID")=questionID	
			set array(count,"questionName")=rsQuestions.Get("description")	
		}
	}
]]></Implementation>
</Method>

<Method name="findChildPageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>groupID,pageName</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set result=""
	do ##class(sc.objData).findChildrenPages(groupID,.pages)
	set pageID=""
	for  {
		set pageID=$O(pages(pageID))
		if pageID="" quit
		
		if $ZCVT(##class(sc.xModules.objPage).getDescription(pageID),"L")=$ZCVT(pageName,"L") {
			set result=pageID
			quit
		}	
	}
	return result
]]></Implementation>
</Method>

<Method name="getParentGroupName">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim parentID as %Integer
	#dim parentName as %String
	set parentID=##class(sc.objData).getParentID(pageID)
	set parentName=##class(sc.xModules.objGroup).getDescription(parentID)		
	return parentName
]]></Implementation>
</Method>

<Method name="getEquivalentPageIDForLanguageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>inPageID,langID</FormalSpec>
<Implementation><![CDATA[
	set objPage=..%OpenId(inPageID)
	if '$IsObject(objPage) {
		return 0	
	}
	set groupID=objPage.parent.%Id()
	set genericDescription=objPage.getGenericDescription()
	set descriptionForLanguage=genericDescription_##class(sc.pageMethods).getDescriptionModifier(langID)
	set pageID=..findChildPageID(groupID,descriptionForLanguage)
	if 'pageID {
		set pageID=..findChildPageID(groupID,genericDescription)
	}
	return pageID
]]></Implementation>
</Method>

<Method name="getComponentByDesciption">
<FormalSpec>componentName</FormalSpec>
<ReturnType>sc.objComponent</ReturnType>
<Implementation><![CDATA[
	set objComponent=""
	set pageID=..%Id()
	set templateID=..objTemplate.%Id()
	&SQL(SELECT ID INTO :componentID FROM sc.objComponent 
		WHERE (%UPPER(description) = %UPPER(:componentName))
		AND (objTemplate = :templateID) AND (objData->parent = :pageID) AND (objData->active=1)
	) 
	if +SQLCODE=0 {
		set objComponent=##class(sc.objComponent).%OpenId(componentID)
	}
	return objComponent
]]></Implementation>
</Method>

<Method name="getGenericDescription">
<Description>
Gets the description without the language modifier</Description>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set description=..description
	if $IsObject(..objLanguage) {
		if ..objLanguage.%Id()'=$$$efEnglishLangID {
			set description=$P(..description," - ",1,$l(..description," - ")-1)
		}
	}
	return description
]]></Implementation>
</Method>

<Method name="isSearchAsYouTypeAllowed">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	#dim result as %Boolean = 0
	#dim eventID as %Integer
	#dim templateID as %Integer
	#dim intDesc as %String
	
	set page=##class(sc.xModules.objPage).%OpenId(pageID)
	if $IsObject(page) {
		if $IsObject(page.objEvent) {
			set eventID = page.objEvent.%Id()
			if eventID {
				set result=1
			}
		}
	}

	return result
]]></Implementation>
</Method>

<Method name="getFileNameWithoutPathLowerCase">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return $Piece( $ZCVT(..objTemplate.filename,"L") ,"/",*)
]]></Implementation>
</Method>

<Method name="allowRegistrationQuestions">
<FormalSpec>componentName:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set pageName = ..getFileNameWithoutPathLowerCase()
	
	set result = $Case(pageName, 
				"tabssignup.csp":1,
				"taccomguest.csp":1,
				"tawardsclient.csp":1,
				"tbooker.csp":1,
				"tcancellation.csp":1,
				"tpaymentmethod.csp":1,
				"tregistration.csp":1,
	 		:0)
	 
	 if pageName="tawardsentry.csp" {
		 if componentName="Main List" {
			 set result = 1
		 } else {
			 set result = 0
		 }
	 }
	 if pageName="ttableguests.csp" {
		 if componentName="Main List" {
			 set result = 1
		 } else {
			 set result = 0
		 }
	 }
	 if pageName="tabsdocument.csp" {
		 if "Document List|Main Author List|Co Author List" [ componentName {
			 set result = 1
		 } else {
			 set result = 0
		 }
	 }
	 return result
]]></Implementation>
</Method>

<Method name="alllowPromptCollections">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	return $Case(..getFileNameWithoutPathLowerCase(), 
				"tawardsclient.csp":1,
				"tbooker.csp":1,
				"tpaymentmethod.csp":1,
				"tregistration.csp":1,
	 		:0)
]]></Implementation>
</Method>

<Method name="allowABIs">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	return $Case(..getFileNameWithoutPathLowerCase(),  
				"tawardsclient.csp":1,
				"tbooker.csp":1,
				"tpaymentmethod.csp":1,
				"tregistration.csp":1,
	 		:0)
]]></Implementation>
</Method>

<Method name="isSurvey">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return $Case(..getFileNameWithoutPathLowerCase(), "xttsurveypage.csp":1, :0)
]]></Implementation>
</Method>

<Method name="isHotel">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return $Case(..getFileNameWithoutPathLowerCase(), "tHotelBooking.csp":1, :0)
]]></Implementation>
</Method>

<Method name="allowDivider">
<FormalSpec>componentName:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ..allowRegistrationQuestions(componentName)
]]></Implementation>
</Method>

<Method name="allowMiscMedia">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return '..isSurvey()
]]></Implementation>
</Method>

<Method name="allowFrontendUpload">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	return $Case(..getFileNameWithoutPathLowerCase(), 
				"tbooker.csp":1,
				"tregistration.csp":1,
	 		:0)
]]></Implementation>
</Method>

<Method name="isPageIDValidForEvent">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,pageID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set isAllowed = 1
	set pageEventID = ##class(sc.methods).getEventIDfromPageID(pageID)
	if pageEventID {
		if eventID'=pageEventID {
			set isAllowed = 0
		}
	}
	return isAllowed
]]></Implementation>
</Method>

<Method name="getLanguageIDFromPageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID:%Integer</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set page = ..%OpenId(pageID)
	if '$IsObject(page) {
		throw ##class(shared.exceptions.generalException).%New("Failed to open page: "_pageID)
	}
	if $IsObject(page.objLanguage) {
		return page.objLanguage.%Id()
	} else {
		return ""
	}
]]></Implementation>
</Method>

<Method name="getHomePageIdInsteadOfIncludePageId">
<Description>
return the homePageID in case someone is trying to load an include page without the surrounding sc template page</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	#dim prowebTemplateFile as %String = ##class(sc.xModules.objPage).getTemplateFile(pageID)
	
	set prowebTemplateFile = $Piece(prowebTemplateFile, "/", *)
	set prowebTemplateFile = $ZConvert(prowebTemplateFile, "U")
	
	if (prowebTemplateFile = "TBANNER.CSP") ! (prowebTemplateFile = "TFOOTER.CSP")  ! (prowebTemplateFile = "TMENU.CSP"){
		set eventID = ##class(sc.objData).getEventID(pageID)
		set langID = ##class(sc.xModules.objPage).getLanguageIDFromPageID(pageID)
		set pageID = ##class(setup.eventWebMethods).getHomePageID(eventID, langID)	
	}
	return pageID
]]></Implementation>
</Method>

<Query name="qPagesByTemplateEventLanguage">
<Description>
Used for listing corresponding pages in a different language</Description>
<Type>%SQLQuery</Type>
<FormalSpec>languageID:%Integer,eventID:%Integer,templateID:%Integer</FormalSpec>
<SqlQuery>	SELECT *
	FROM sc_xModules.objPage
	WHERE (objLanguage = :languageID)
			AND (objEvent = :eventID)
			AND (objTemplate = :templateID)
			AND (active = 1)
	ORDER BY ID</SqlQuery>
</Query>

<Query name="qQuestionsByPageID">
<Type>%SQLQuery</Type>
<FormalSpec>pageID</FormalSpec>
<SqlQuery><![CDATA[	SELECT * FROM sc_xModules.objCODitem 
	WHERE (active=1) AND (parent->parent = :pageID) 
	ORDER BY displayorder]]></SqlQuery>
</Query>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>objPageDefaultData</DefaultData>
<Data name="objPageDefaultData">
<Subscript>"objPage"</Subscript>
<Value name="1">
<Value>accessLevel</Value>
</Value>
<Value name="2">
<Value>description</Value>
</Value>
<Value name="3">
<Value>showInMenu</Value>
</Value>
<Value name="4">
<Value>staticPage</Value>
</Value>
<Value name="5">
<Value>staticURL</Value>
</Value>
<Value name="6">
<Value>objMenuItem</Value>
</Value>
<Value name="7">
<Value>redirect</Value>
</Value>
<Value name="8">
<Value>allowRemoteUpdating</Value>
</Value>
<Value name="9">
<Value>seoPageName</Value>
</Value>
<Value name="10">
<Value>titleBarText</Value>
</Value>
<Value name="11">
<Value>seoKeywords</Value>
</Value>
<Value name="12">
<Value>showInXmlSiteMap</Value>
</Value>
<Value name="13">
<Value>seoDescription</Value>
</Value>
<Value name="14">
<Value>promptAlign</Value>
</Value>
<Value name="15">
<Value>inputAlign</Value>
</Value>
<Value name="16">
<Value>promptWidth</Value>
</Value>
<Value name="17">
<Value>inputWidth</Value>
</Value>
<Value name="18">
<Value>promptHeight</Value>
</Value>
<Value name="19">
<Value>units</Value>
</Value>
<Value name="20">
<Value>inputHeight</Value>
</Value>
<Value name="21">
<Value>objLanguage</Value>
</Value>
<Value name="22">
<Value>objEvent</Value>
</Value>
</Data>
<Property name="accessLevel">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="active">
<Selectivity>49.9998%</Selectivity>
</Property>
<Property name="allowRemoteUpdating">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="creator">
<Selectivity>49.9998%</Selectivity>
</Property>
<Property name="dataType">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="description">
<Selectivity>1.7313%</Selectivity>
</Property>
<Property name="displayOrder">
<Selectivity>2.9394%</Selectivity>
</Property>
<Property name="nextVersion">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="objMenuItem">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="objStep">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="objTemplate">
<Selectivity>4.1666%</Selectivity>
</Property>
<Property name="parent">
<Selectivity>0.1427%</Selectivity>
</Property>
<Property name="previousVersion">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="publishAt">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="redirect">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="showInMenu">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="sourceID">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="staticPage">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="staticURL">
<Selectivity>99.9993%</Selectivity>
</Property>
<Property name="xCRstamp">
<Selectivity>1.3399%</Selectivity>
</Property>
<Property name="xCRuserID">
<Selectivity>8.3333%</Selectivity>
</Property>
<Property name="xMOstamp">
<Selectivity>0.1940%</Selectivity>
</Property>
<Property name="xMOuserID">
<Selectivity>5.5556%</Selectivity>
</Property>
</Storage>
</Class>


<Class name="setup.availabilityCheckerSession">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: setup.availabilityCheckerDay.CLS/EV.1
;vc; Component: CLS.setup.availabilityCheckerDay
;vc;  Location: LargeDev
;vc; Date/Time: 28-Sep-16 11:59
;vc;      User: MindaugasL
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>setup.availabilityCheckerDay.CLS/EV.1</td><td>CLS.setup.availabilityCheckerDay</td><td>LargeDev</td><td style='white-space: nowrap;'>28-Sep-16 11:59</td><td>MindaugasL</td></tr></table>
]]></Description>
<Super>setup.availabilityChecker</Super>
<TimeChanged>64236,52890.497672</TimeChanged>
<TimeCreated>64127,37806.646747</TimeCreated>

<Property name="eventSession">
<Type>setup.eventSession</Type>
</Property>

<Property name="bookingLevelCounter">
<Type>setup.bookingLevelCounterFrontendSession</Type>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventSession:setup.eventSession</FormalSpec>
<ReturnType>setup.availabilityCheckerDay</ReturnType>
<Implementation><![CDATA[
	set availabilityCheckerSession = ##super(eventSession)
	set availabilityCheckerSession.eventSession = eventSession
	return availabilityCheckerSession
]]></Implementation>
</Method>

<Method name="createForSessionID">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventConfiguration,sessionItemID</FormalSpec>
<Implementation><![CDATA[
	set eventSession = ##class(setup.eventSession).createNew(eventConfiguration, sessionItemID)
	do eventSession.load()
	return ..createNew(eventSession)
]]></Implementation>
</Method>

<Method name="createBookingLevelCounter">
<FormalSpec>eventSession:setup.eventSession</FormalSpec>
<Implementation><![CDATA[	set ..bookingLevelCounter=##class(setup.bookingLevelCounterFrontendSession).createNew(eventSession)
]]></Implementation>
</Method>

<Method name="getCapacity">
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[	return ..eventSession.getCapacity()
]]></Implementation>
</Method>

<Method name="isStopped">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ..eventSession.registrationStatus="stopped"
]]></Implementation>
</Method>

<Method name="isLimited">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ..eventSession.registrationStatus="limited"
]]></Implementation>
</Method>
</Class>


<Class name="setup.backendMenu">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: setup.backendMenu.CLS/EV.77
;vc; Component: CLS.setup.backendMenu
;vc;  Location: LargeDev
;vc; Date/Time: 12-Dec-16 09:39
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>setup.backendMenu.CLS/EV.77</td><td>CLS.setup.backendMenu</td><td>LargeDev</td><td style='white-space: nowrap;'>12-Dec-16 09:39</td><td>FredG</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<IncludeCode>%occStatus,%occXSLT,EF.common.macros</IncludeCode>
<TimeChanged>64313,39204.183403</TimeChanged>
<TimeCreated>62734,53934.49686</TimeCreated>

<XData name="backendMenuTree">
<Description>
please note that you must escape any ampersands in the data</Description>
<Data><![CDATA[
<backendMenu>
	<level1 description="Create New" hoverText="Create new..." divID="ef_menu_button_add" class="ef_menu_button_add" URL="" accessID="CREMANEV" spanEvents="yes" requiredModule="" menuPosition="left" noSiblingMenu="1" isPublic="1">
		<level2 description="Create new..." URL="" isMenuCaption="1" spanEvents="yes"/>
		<level2 description="Event" URL="../../backend/home/eventProperties.csp?eventID=NEW" accessID="NEWEVENT" spanEvents="yes" requiredModule="" previewImage="event.png"/>
		<level2 description="Event using an existing event as a template" URL="../../backend/home/eventCopy.csp" accessID="COPYEVENT" spanEvents="no" requiredModule="" previewImage="event using temp.png"/>
		<level2 description="Registration" URL="../../frontEnd/reg/initSession.csp?page=registerNew.csp&amp;backendBooking=1"  accessID="NEWBOOK" spanEvents="no" newWindow="1" requiredModule="New Backend Booking" previewImage="booking.png"/>
		<level2 description="Ad Hoc Email" URL="../../backend/home/gotoNewAdhocEmail.csp" accessID="NEWEMAIL" spanEvents="no" requiredModule="EMAIL" previewImage="ad-hoc email.png"/>
	</level1>
	<level1 description="Task List" hoverText="View Action List" onClick="wizardEntryPopup()" divID="ef_menu_button_tasks" class="ef_menu_button_tasks" accessID="ACTIONLISTUPD" spanEvents="no" requiredModule="Action List" menuPosition="left" hideFromActionList="1"/>
	<level1 description="Test" hoverText="Preview and test Event Website" URL="##PREVIEWURL##" divID="ef_menu_button_preview"  class="ef_menu_button_preview" newWindow="1" accessID="TESTEV" spanEvents="no" menuPosition="left" hideFromActionList="1"/>
	<level1 description="Shortcuts" accessID="SHORTCUTS" noSiblingMenu="1" hoverText="Shortcuts" isPublic="1" URL="" divID="ef_menu_button_shortcuts"  class="ef_menu_button_shortcuts"  menuPosition="left" hideFromActionList="1">
		<level2 description="Your shortcuts:"  isPublic="1" URL="" isMenuCaption="1"/>
		<level2 description="Configure Shortcuts" accessID="CONFIGSHORTCUTS" URL="../../backend/home/usershortcuts.csp" spanEvents="no" isPublic="1"/>
	</level1>
	<level1 description="Home" hoverText="Event Dashboard" URL="../../backend/home/dashboardRedirect.csp" class="ef_menu_button_home" accessID="HOME" isPublic="1" spanEvents="no" requiredModule="" menuPosition="right" hideFromActionList="1"/>
	<level1 description="System" hoverText="Change system settings" class="ef_menu_button_system" URL="" accessID="SYSMAN" spanEvents="yes" requiredModule="" menuPosition="right" isPublic="1">
		<level2 description="System Settings" URL="" isMenuCaption="1"/>
		<level2 description="My Details" URL="../../backend/home/myDetails.csp" accessID="MYDETAILS" isPublic="1" spanEvents="yes" requiredModule=""/>
		<level2 description="Security" URL="" accessID="SYSUSERMAN" spanEvents="yes" isPublic="1" requiredModule="">
			<level3 description="Users" URL="../../backend/home/userList.csp"        accessID="SYSUSER" spanEvents="yes" requiredModule="User Management" previewImage="user Profiles.png"/>
			<level3 description="Roles" URL="../../backend/home/userRoleList.csp"    accessID="SYSROLE" spanEvents="yes" requiredModule="Role Management"  previewImage="Roles.png"/>
			<level3 description="Organisational Units" URL="../../backend/home/orgUnitSetup.csp"  accessID="SYSORGUNITSETUP" spanEvents="yes" requiredModule="Organisational Units - Aviva Only" />
		</level2>
		<level2 description="Settings" URL="" isPublic="1" accessID="SYSPREF" spanEvents="yes" requiredModule="">
			<level3 description="System Settings" URL="../../backend/home/systemDefaults.csp"        accessID="SYSDEF" spanEvents="yes" requiredModule="" previewImage="system defaults.png"/>
			<level3 description="Account Details" URL="../../backend/home/clientSetting.csp"     accessID="SYSCLI" spanEvents="yes" requiredModule="" previewImage="my account details.png"/>
			<level3 description="Action Lists" URL="../../backend/home/wizardList.csp"        accessID="ACTLIS" spanEvents="yes" requiredModule="Action List" previewImage="action lists.png"/>
			<level3 description="Attendee Categories" URL="../../backend/home/eventCategoryList.csp"      accessID="ATTLIST" spanEvents="yes" requiredModule="Attendee Categories" previewImage="attendee categories2.png"/>
			<level3 description="Presentation Methods" URL="../../backend/home/absPresentationMethods.csp" accessID="ABSPRESEV" spanEvents="yes" requiredModule="Abstract Management" previewImage="default presentation methods.png"/>
			<level3 description="Accommodation Library" URL="../../backend/home/venueSearch.csp?pageMode=library"    accessID="ACCLIB" spanEvents="yes" requiredModule="Accommodation" previewImage="Hotel Library.png"/>
			<level3 description="Templates" URL="../../backend/home/themeLoad.csp" accessID="ACCESSLOADTHEME" spanEvents="yes" requiredModule="Upload Template" previewImage="templates.png"/>
			<level3 description="Translations" URL="../../backend/home/translationLanguages.csp" accessID="ACCESSTRANS" spanEvents="yes" requiredModule="Allow Access to Translation" previewImage="translations.png"/>
		</level2>
		<level2 description="Database" URL="" isPublic="1" accessID="SYSPROMPTS" spanEvents="yes" requiredModule="">
			<level3 description="Database Items" URL="../../backend/home/codItemSearch.csp"      accessID="SYSDATA" spanEvents="yes" requiredModule="Data Items" previewImage="data items.png"/>
			<level3 description="Collections" URL="../../backend/home/codCollectionList.csp"  accessID="REGCOLL" spanEvents="yes" requiredModule="Registration prompt collections" previewImage="collections.png"/>
			<level3 description="Custom Event Fields" URL="../../backend/home/softEventPromptList.csp"        accessID="CUSTEVFIELD" spanEvents="yes" requiredModule="Custom event fields" previewImage="soft event prompts.png"/>
			<level3 description="People De-Duplication" URL="../../backend/home/codPersonDeDupeSelectFields.csp?load=1"      accessID="SYSDEDUPE" spanEvents="yes" requiredModule="Person De-Duplication" previewImage="people de-duplication.png"/>
		</level2>
		<level2 description="Salesforce" URL="" isPublic="1" accessID="SFMENU" spanEvents="yes" requiredModule="SALESFORCE">
			<level3 description="Settings" URL="../../backend/home/systemSettingsSalesforce.csp"     accessID="SFSYSSETTINGS" spanEvents="yes" requiredModule="SALESFORCE" previewImage="salesforce system settings.png"/>
			<level3 description="Field Mappings" URL="../../backend/home/salesforceMappings.csp"     accessID="SFMAPPING" spanEvents="yes" requiredModule="SALESFORCE" previewImage="salesforce mappings.png"/> 
			<level3 description="Transactions" URL="../../backend/home/sfTxnList.csp"     accessID="SFTXNLIST" spanEvents="yes" requiredModule="SALESFORCE" previewImage="salesforce transactions.png"/>
			<level3 description="Schroders" URL="../../backend/home/sfTxnList.csp"     accessID="SFSCHRODERSTXNLIST" spanEvents="yes" requiredModule="SALESFORCE SCHRODERS" previewImage="salesforce transactions.png"/>
		</level2>
		<level2 description="Eventsforce Tools" URL="" isPublic="1" accessID="EVONLYTOOLS" spanEvents="yes" requiredModule="" menuGroup="EFONLY" hideFromActionList="1">
			<level3 description="Messages" URL="../../backend/home/userMessages.csp"    accessID="EVMSGS" spanEvents="yes" requiredModule="" previewImage=""/>
			<level3 description="Application Errors" URL="../../system/listAppErrors.csp" accessID="EVAPPERRORS" spanEvents="yes" requiredModule="" previewImage=""/>
			<level3 description="Unit Tests" URL="../../system/unitTests.csp" accessID="EVUNITTESTS" spanEvents="yes" requiredModule="" previewImage=""/>
			<level3 description="Session Dump" URL="../../system/sessionDump.csp" accessID="EVSESSDUMP" spanEvents="yes" requiredModule="" previewImage=""/>
			<level3 description="Multi Audit" URL="../../backend/home/multiSourceAudit.csp"       accessID="EVSMULTAUDIT" spanEvents="yes" requiredModule="" previewImage=""/>
			<level3 description="Proweb Tree" URL="../../backend/home/prowebTreeDisplay.csp"      accessID="EVPROWEBTREE" spanEvents="yes" requiredModule="" previewImage=""/>
			<level3 description="Templates" URL="../../backend/home/themeLoad.csp"        accessID="EVLOADTHEME" spanEvents="yes" requiredModule="" previewImage=""/>
		</level2>
		<level2 description="Eventsforce Settings" URL="" isPublic="1" accessID="EVONLYSETTINGS" spanEvents="yes" requiredModule="" menuGroup="EFONLY" hideFromActionList="1">
			<level3 description="Installation" URL="../../backend/home/systemSettings.csp"  accessID="EVSETT" spanEvents="yes" requiredModule=""/>
			<level3 description="License" URL="../../backend/home/eventsforceLicense.csp"   accessID="EVLIC" spanEvents="yes" requiredModule=""/>
			<level3 description="Custom Packages" URL="../../backend/home/systemTypeList.csp"       accessID="EVMOD" spanEvents="yes" requiredModule=""/>
			<level3 description="Currencies" URL="../../backend/home/currencyList.csp"    accessID="EVCURRENCIES" spanEvents="yes" requiredModule=""/>
			<level3 description="Translations" URL="../../backend/home/translationLanguages.csp"     accessID="EVTRANS" spanEvents="yes" requiredModule=""/>
		</level2>
	</level1>
	<level1 description="Events" hoverText="Choose an event to manage" URL="" isPublic="1" accessID="EVENTS" spanEvents="no" requiredModule="" menuPosition="right" noSiblingMenu="1" hideFromActionList="1">
		<level2 description="Select a recent event:" accessID="MRUEVENTS" URL="../../backend/home/switchEvent.csp" menuGroup="RecentEvents"/>
		<level2 description="Show all Events" URL="../../backend/home/eventSelection.csp"  accessID="ALLEVENTS" spanEvents="yes" requiredModule="" menuGroup="AllEvents"/> 
	</level1>
	<level1 description="Setup" hoverText="Set up your event" URL="" accessID="EVSETUP" spanEvents="no" requiredModule=""  menuPosition="right">
		<level2 description="Event" URL="" accessID="MAINSETT" spanEvents="no" requiredModule="" isPublic="1">
			<level3 description="Properties" URL="../../backend/home/eventProperties.csp" accessID="EVPROP" spanEvents="no" requiredModule="" previewImage="event.png"/>
			<level3 description="Categories" URL="../../backend/home/eventAttendeeCategories.csp"   accessID="ATTCAT" spanEvents="no" requiredModule="Attendee Categories" previewImage="attendee categories.png"/>
			<level3 description="Registration" URL="../../backend/home/registrationSettings.csp" accessID="BOOKOPT" spanEvents="no" requiredModule="" previewImage="booking options.png"/>
			<level3 description="Capacity" URL="../../backend/home/eventCapacity.csp" accessID="CAPA" spanEvents="no" requiredModule="" previewImage="capacity.png"/>
			<level3 description="Salesforce" URL="../../backend/home/eventSettingsSalesforce.csp" accessID="SFEVENTSETTV2" spanEvents="no" requiredModule="SALESFORCE" previewImage=""/>
		</level2>
		<level2 description="Program" URL="" accessID="PROG" spanEvents="no" requiredModule="Sessions" isPublic="1">
			<level3 description="Settings" URL="../../backend/home/eventSettingsAgendaSessions.csp" accessID="SESSSETT" spanEvents="no" requiredModule="Sessions" previewImage="session settings.png"/>
			<level3 description="Sessions" URL="../../backend/home/itemList.csp"     accessID="SESSDET" spanEvents="no" requiredModule="Sessions" previewImage="session details.png"/>
			<level3 description="Session Types" URL="../../backend/home/sessionTypeList.csp" accessID="SESSTYP" spanEvents="yes" requiredModule="Sessions" previewImage="session types.png"/>
			<level3 description="Labels" URL="../../backend/home/sessionLabels.csp" accessID="SESSIONLABELS" spanEvents="NO" requiredModule="Sessions"/>
			<level3 description="Presenters" URL="../../backend/home/presenterList.csp"      accessID="PRES" spanEvents="no" requiredModule="Sessions" previewImage="presenters.png"/>
			<level3 description="Locations" URL="../../backend/home/locationList.csp?"       accessID="LOCS" spanEvents="no" requiredModule="Sessions" previewImage="locations.png"/>
			<level3 description="Icons" URL="../../backend/home/iconList.csp"        accessID="ICONS" spanEvents="no" requiredModule="Sessions" previewImage="icons.png"/>
		</level2>
		<level2 description="Finance" URL="" accessID="FINSET" spanEvents="no" requiredModule="Pricing" menuGroup="EVFIN" isPublic="1">
			<level3 description="Settings" URL="../../backend/home/eventSettingsFinancial.csp"     accessID="FINSETT" spanEvents="no" requiredModule="" previewImage="settings (financial).png"/>
			<level3 description="Prices" URL="../../backend/home/priceList.csp"      accessID="PRICE" spanEvents="no" requiredModule="Price descriptors" previewImage="prices.png"/>
			<level3 description="Discounts" URL="../../backend/home/discountList.csp"        accessID="DISC" spanEvents="no" requiredModule="Discounts" previewImage="discounts.png"/>
			<level3 description="Payment Methods" URL="../../backend/home/paymentDetails.csp"        accessID="PAYMETH" spanEvents="no" requiredModule="" previewImage="payment methods.png"/>
			<level3 description="VAT Codes" URL="../../backend/home/vatCodeList.csp" accessID="VATCODE" spanEvents="yes" requiredModule="" previewImage="vat codes.png"/>
			<level3 description="Cost Centre Org Units" URL="../../backend/home/costCentreOrgUnitList.csp"   accessID="CCORGUNITLIST" spanEvents="yes" requiredModule="Organisational Units - Aviva Only" previewImage=""/>
			<level3 description="Profit &amp; Loss" URL="../../backend/home/profitAndLoss1.csp"  accessID="PROFLOSS" spanEvents="yes" requiredModule="Profit &amp; Loss" previewImage="profit and loss.png"/>
			<level3 description="Invoices" URL="../../backend/home/invoiceList.csp"     accessID="INVLIST" spanEvents="no" requiredModule="Invoice" requiredSystemSetting="haymarket special invoice list" previewImage=""/>
			<level3 description="Invoice Control" URL="../../backend/home/invoiceExport.csp" accessID="INVEXPORT" spanEvents="no" requiredModule="Invoice Export" previewImage="invoice control.png"/>
			<level3 description="Invoice Run" URL="../../backend/home/invoicingMain.csp"     accessID="INVRUN" spanEvents="no" requiredModule="Invoice" previewImage="invoice run.png"/>
		</level2>
		<level2 description="Table Booking" URL=""   accessID="TABL" spanEvents="no" requiredModule="Table Booking" isPublic="1">
			<level3 description="Settings" URL="../../backend/home/tableSettings.csp"  accessID="TABLSETT" spanEvents="no" requiredModule="Table Booking" previewImage="table settings.png"/>
			<level3 description="Groups" URL="../../backend/home/tableGroupList.csp"   accessID="TABLGROUP" spanEvents="no" requiredModule="Table Groups" previewImage="table groups.png"/>
			<level3 description="Tables" URL="../../backend/home/tableList.csp"  accessID="TABLELIST" spanEvents="no" requiredModule="Table Booking" previewImage="table list.png"/>
			<level3 description="Seating" URL="../../backend/home/tablePlanningAdvanced.csp"     accessID="TABLSEAT" spanEvents="no" requiredModule="Table Booking" previewImage="seating arrangement.png"/>
		</level2>
		<level2 description="Accommodation" URL=""    accessID="ACCOM" spanEvents="no" requiredModule="Accommodation" isPublic="1">
			<level3 description="Settings" URL="../../backend/home/eventSettingsAccom.csp"     accessID="ACCSETT" spanEvents="no" requiredModule="Accommodation" previewImage="accommodation settings.png"/>
			<level3 description="Rooms" URL="../../backend/home/hotelList.csp"  accessID="ACCHOT" spanEvents="no" requiredModule="Accommodation" previewImage="hotel list.png"/>
		</level2>
		<level2 description="Meeting Manager" URL=""  accessID="MEET" spanEvents="no" requiredModule="Meeting Manager" isPublic="1">
			<level3 description="Settings" URL="../../backend/home/eventSettingsMeetMan.csp" accessID="MEETSET" spanEvents="no" requiredModule="Meeting Manager" previewImage="meeting manager settings.png"/>
			<level3 description="Diary Slots" URL="../../backend/home/meetManDiarySlots.csp" accessID="MEETSLOTS" spanEvents="no" requiredModule="Meeting Manager" previewImage="diary slots.png"/>
			<level3 description="Lunches" URL="../../backend/home/meetManLunches.csp?load=1" accessID="MEETLUNCH" spanEvents="no" requiredModule="Meeting Manager Lunches" previewImage=""/>
			<level3 description="Arranged Meetings" URL="../../backend/home/meetManOverview.csp?load=1"      accessID="MEETOVER" spanEvents="no" requiredModule="Meeting Manager" previewImage="arranged meetings.png"/>
		</level2>
		<level2 description="Event Management" URL="" accessID="EVMAN" spanEvents="no" requiredModule="Event Management - Enterprise Ireland" isPublic="1">
			<level3 description="Tasks" URL="../../backend/evMan/evManTaskList.csp"  accessID="EVTASK" spanEvents="no" requiredModule="Event Management - Enterprise Ireland" previewImage="Tasks.png"/>
			<level3 description="Resources" URL="../../backend/evMan/evManResourceList.csp"  accessID="EVRES" spanEvents="no" requiredModule="Event Management - Enterprise Ireland" previewImage="resources.png"/>
			<level3 description="Task Planning" URL="../../backend/evMan/evManTaskPlanning.csp"      accessID="EVTASKPL" spanEvents="no" requiredModule="Event Management - Enterprise Ireland" previewImage="task planning.png"/>
			<level3 description="Task Types" URL="../../backend/evMan/evManTaskTypeList.csp"        accessID="EVTASKTYP" spanEvents="no" requiredModule="Event Management - Enterprise Ireland" previewImage="task types.png"/>
			<level3 description="Event Calendar" URL="../../backend/home/eventCalendarMonthly.csp"   accessID="EVCAL" spanEvents="yes" previewImage="event calendar (Event management).png" isPublic="1"/>
			<level3 description="Event Managers" URL="../../backend/evMan/evManEventManagers.csp"    accessID="EVMANS" spanEvents="yes" requiredModule="Event Management - Enterprise Ireland" previewImage="event managers.png"/>
		</level2>
		<level2 description="Badges and Documents" URL="../../backend/home/selectPrint.csp"   accessID="BADLAB" spanEvents="no" requiredModule="Badges &amp; Labels &amp; Letters" previewImage="setup and Management (Badges letters and labels).png"/>
	</level1>
	<level1 description="Awards" hoverText="Set up and manage your awards event" URL="" accessID="EVSETUPAWARDS" spanEvents="no" requiredModule="Awards"  menuPosition="right">	
		<level2 description="Setup" URL="" accessID="AWRD" spanEvents="no" requiredModule="Awards" menuGroup="Awards" isPublic="1">
			<level3 description="Settings" URL="../../backend/home/eventSettingsAwards.csp"   accessID="AWSETT" spanEvents="no" requiredModule="Awards" previewImage="settings (awards).png"/> 
			<level3 description="Sections" URL="../../backend/home/awardsSectionList.csp" accessID="AWSEC" spanEvents="no" requiredModule="Awards" previewImage="sections.png"/>
			<level3 description="Categories" URL="../../backend/home/awardsCategoryList.csp" accessID="AWCAT" spanEvents="no" requiredModule="Awards" previewImage="categories (Awards.png"/>
			<level3 description="Award Types" URL="../../backend/home/awardsAwardList.csp" accessID="AWAW" spanEvents="no" requiredModule="Awards" previewImage="award types.png"/>
			<level3 description="Judging Panel" URL="../../backend/home/awardsPanelList.csp" accessID="AWJUDGE" spanEvents="no" requiredModule="Awards" previewImage="judging panel.png"/>
			<level3 description="Criteria" URL="../../backend/home/awardsCriteriaList.csp" accessID="AWCRIT" spanEvents="no" requiredModule="Awards" previewImage="criteria awards.png"/>
		</level2>
		<level2 description="Management" URL="" accessID="AWMANAGE" spanEvents="no" requiredModule="Awards" menuGroup="Awards" isPublic="1">
			<level3 description="Entries" URL="../../backend/home/awardsOverview.csp?load=1" accessID="AWSUB" spanEvents="no" requiredModule="Awards"  previewImage="entries.png"/>
			<level3 description="Submitters" URL="../../backend/home/awardsSubmitterDetails.csp"      accessID="AWSUBDET" spanEvents="no" requiredModule="Awards"  previewImage="submitter details.png"/>
			<level3 description="Judges" URL="../../backend/home/awardsJudgingDetails.csp"   accessID="AWJUDDET" spanEvents="no" requiredModule="Awards" previewImage="judging details.png"/>
			<level3 description="Judging Overview" URL="../../backend/home/awardsJudgingOverview.csp?load=1" accessID="AWJUDOV" spanEvents="no" requiredModule="Awards" previewImage="judging overview.png"/>
			<level3 description="Award Assignment" URL="../../backend/home/awardsAssignment.csp"     accessID="AWASS" spanEvents="no" requiredModule="Awards" previewImage="awards assignment.png"/>
		</level2>
	</level1>
	<level1 description="Abstracts" hoverText="Set up and manage abstract submissions" URL="" accessID="EVSETUPABSTRACTS" spanEvents="no" requiredModule="Abstract Management"  menuPosition="right">	
		<level2 description="Setup" URL="" accessID="ABS" spanEvents="no" requiredModule="Abstract Management" menuGroup="Abstracts" isPublic="1">
			<level3 description="Settings" URL="../../backend/home/abstractSettings.csp" accessID="ABSSETT" spanEvents="no" requiredModule="Abstract Management" previewImage="settings abstracts.png"/>
			<level3 description="Topics" URL="../../backend/home/absTopicList.csp"   accessID="ABSTOP" spanEvents="no" requiredModule="Abstract Management" previewImage="topics.png"/>
			<level3 description="Review Criteria" URL="../../backend/home/absCriteriaList.csp"    accessID="ABSCRIT" spanEvents="no" requiredModule="Abstract Management" previewImage="reviewing criteria abstracts.png"/>
			<level3 description="Reviewers" URL="../../backend/home/absUserList.csp" accessID="ABSREV" spanEvents="no" requiredModule="Abstract Management" previewImage="reviewers.png"/>
			<level3 description="Presentation Methods" URL="../../backend/home/absPresentationMethodEvent.csp" accessID="SYSABSPRES" spanEvents="no" requiredModule="Abstract Management" previewImage="presentation methods.png"/>
		</level2>
		<level2 description="Management" URL="" accessID="ABSMANAGE" spanEvents="no" requiredModule="Abstract Management" menuGroup="Abstracts" isPublic="1">
			<level3 description="Submissions" URL="../../backend/home/abstractSubmissions.csp"        accessID="ABSSUB" spanEvents="no" requiredModule="Abstract Management" previewImage="submitted abstracts.png"/>
			<level3 description="Reviews" URL="../../backend/home/absReviewsOverview.csp?load=1"     accessID="ABSRVW" spanEvents="no" requiredModule="Abstract Management" previewImage="reviews.png"/>
		</level2>
	</level1>
	<level1 description="Website" URL="" hoverText="Set up your event website and registration process" accessID="FRONT" spanEvents="no" requiredModule="frontEndWebPages"  menuPosition="right" isPublic="1">
		<level2 description="Settings" URL="" accessID="FRONTSITESETNG" spanEvents="no" requiredModule="" isPublic="1">
			<level3 description="General" URL="../../backend/home/websiteSettings.csp" accessID="WEBSETT" spanEvents="no" requiredModule="" previewImage="website settings.png"/>
			<level3 description="Addresses" URL="../../backend/home/eventSettingsWebAddr.csp"    accessID="WEBADDR" spanEvents="no" requiredModule="" previewImage="web addresses.png"/>
			<level3 description="SEO" URL="../../backend/home/seoEventSettings.csp" accessID="SEOEVSETTINGS" spanEvents="no" requiredModule="SEO" previewImage="seo settings.png"/>
		</level2>
		<level2 description="Design" URL=""   accessID="FRONTSITEDESN" spanEvents="no" requiredModule="" isPublic="1">
			<level3 description="Template" URL="../../backend/home/themeBrowser.csp"  accessID="THEMES" spanEvents="no" requiredModule="" previewImage="select template.png"/>
			<level3 description="Appearance" URL="../../backend/home/websiteAppearance.csp" accessID="FONTSCOLORS" spanEvents="no" requiredModule="" previewImage="website colors.png"/>
		</level2>
		<level2 description="Content" URL=""  accessID="FRONTSITECONT" spanEvents="no" requiredModule="" isPublic="1">
			<level3 description="Website Pages" URL="../../backend/home/inSiteEditingFrame.csp"  accessID="CONMAN" spanEvents="no" requiredModule="" previewImage="website contents.png"/>
			<level3 description="Registration Pages" URL="../../backend/home/regPages.csp"   accessID="REGPAG" spanEvents="no" requiredModule="" previewImage="registration pages.png"/>
			<level3 description="External Pages" URL="../../backend/home/externalWebPages.csp" accessID="EXTWEB" spanEvents="yes" requiredModule="External Webpages" previewImage="external pages.png"/>
		</level2>
	</level1>
	<level1 description="Communications" URL="" hoverText="Manage automatic and ad hoc emails" accessID="INVMAIL" spanEvents="no" requiredModule=""  menuPosition="right" isPublic="1">
		<level2 description="Automatic" URL="../../backend/home/emailSettings.csp" accessID="MAILTEMPL" spanEvents="no" requiredModule="EMAIL" previewImage="automatic.png"/>
		<level2 description="Ad Hoc" URL="../../backend/home/eventEmails2.csp?butEvent_=1" accessID="EMAIL" spanEvents="no" requiredModule="EMAIL" previewImage="ad-hoc.png"/>
		<level2 description="Approvals" URL="../../backend/bespokePages/schrodersEmailApprovals.csp" accessID="SCHROEMAILAPP" spanEvents="yes" isPublic="1" requiredSystemSetting="Schroders approval required for bulk emails" previewImage=""/>
		<level2 description="Campaigns" URL="../../backend/home/emailCampaigns.csp" accessID="MAILCAMP" spanEvents="no" requiredModule="Email Campaigns" previewImage="campaigns.png"/>
		<level2 description="Meeting Manager" URL="../../backend/home/meetManEmailSettings.csp" accessID="MEETEMAIL" spanEvents="no" requiredModule="Meeting Manager" previewImage="meeting manager (emails).png"/>
		<level2 description="History" URL="../../backend/home/emailLog.csp" accessID="MAILLOG" spanEvents="yes" requiredModule="Email Log" previewImage="log (email).png"/>
	</level1>
	<level1 description="People" URL="" hoverText="Manage invitations, registrations and attendance recording" accessID="BOOKADM" spanEvents="no" requiredModule=""  menuPosition="right">
		<level2 description="Lists" URL="../../backend/home/codLists.csp?clearPage=1"  accessID="PEOPLIST" spanEvents="no" requiredModule="Lists of People"  previewImage="lists of people.png"/>
		<level2 description="Invitations" URL="../../backend/home/preRegister.csp?clearPage=1" accessID="INVITE" spanEvents="no" requiredModule="Invitations" previewImage="invitations.png"/>
		<level2 description="Edit Registrations" URL="../../backend/home/delegateSearchGoToSimple.csp"  accessID="VIEWBOOK" spanEvents="no" requiredModule="View &amp; edit bookings" previewImage="edit bookings.png"/>
		<level2 description="Registrations" URL="../../backend/home/registrations.csp"  accessID="REGISTRATIONLIST"  spanEvents="no"/>
		<level2 description="Bulk Edit" URL="../../backend/home/eventBooking2.csp?butBulkEdit_=1"  accessID="BULK" spanEvents="no" requiredModule="Bulk Edit" previewImage="bulk edit.png"/>
		<level2 description="Attendance Recording" URL="../../backend/home/attendanceRecording.csp" accessID="ATTREC" spanEvents="no" requiredModule="Attendance recording" previewImage="attendance recording.png"/>
		<level2 description="Surveys" URL="../../backend/home/surveyList.csp" accessID="SURV" spanEvents="yes" requiredModule="Surveys" previewImage="surveys.png"/>
	</level1>
	<level1 description="Reports" hoverText="Create and run reports" URL="" accessID="REPORTS" spanEvents="no" requiredModule=""  menuPosition="right" isPublic="1">
		<level2 description="Quick Search" URL="../../backend/home/delegateSearchSimple.csp?showEditButton=1" accessID="QUICKREP" spanEvents="no" requiredModule="Quick Search" previewImage="quick search.png"/>
		<level2 description="Search" URL="../../backend/home/gotoOnlineReports.csp?reportType=default"  accessID="ADVSEARCH" spanEvents="yes" requiredModule="Standard Search" previewImage="search.png"/>
		<level2 description="Reports" URL="../../backend/home/reportList.csp"  accessID="REPS" spanEvents="yes" requiredModule="Dynamic Reporting Runtime" previewImage="reports.png"/>
		<level2 description="Additional Bookable Items" URL="../../backend/home/additionalItemsList.csp"  accessID="ABIS" spanEvents="no" requiredModule="Additional Bookings Items Overview" previewImage="Additional booking items.png"/>
	</level1>
</backendMenu>
]]></Data>
</XData>

<Method name="validateBackendMenuTree">
<Description>
This checks the validity of the backend menu tree XML and returns invalid items in the array badMenuItems
1. All items must have an accessID (except placeholders)
2. All Access IDs must be unique</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&badMenuItems]]></FormalSpec>
<Implementation><![CDATA[
	set ok=1

	kill badMenuItems
	do ..buildMenuArray(.myResults)
	
	set m=""
	set count = 0
	for  {
		set m=$O(myResults(m))
		if m="" quit
		set count = count + 1
		set isMenuCaption=$G(myResults(m,"isMenuCaption"))
		if 'isMenuCaption {
			set accessID=$G(myResults(m,"accessID"))
			if '$l(accessID) {
				set badMenuItems(count,myResults(m,"description"))="No access ID"
			} else {
				if $D(menuItems(accessID)) set badMenuItems(count,myResults(m,"description"))=accessID_" is not unique"
				set menuItems(accessID) =""
			}
		}
	}
	
	if $D(badMenuItems) set ok=0
	
	return ok
]]></Implementation>
</Method>

<Method name="getMenuTreeForJSTree">
<Description>
create UL lists with hyperlinks that gets written out, use current pagename to create hyperlinks</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&menuItems,isTopLevel=1]]></FormalSpec>
<Implementation><![CDATA[
	if isTopLevel {
		w "<ul id=""menuTreeUL"" class=""filetree"">",!
	} else {
		w "<ul>"	
	}
	set item=""
	for {
		set item=$O(menuItems(item))
		if item="" quit
		
		set accessID=$G(menuItems(item,"accessID"))
		set description=$G(menuItems(item,"description"))
		set isMenuCaption=$G(menuItems(item,"isMenuCaption"))
		set hideFromActionList=$G(menuItems(item,"hideFromActionList"))
		set previewImage=$G(menuItems(item,"previewImage"))
		if ('isMenuCaption) && ('hideFromActionList) {
		
			w " <li id=""li_MenuItem_"_accessID_""" pageAccessID="""_accessID_""" previewImage="""_previewImage_""" pageName="""_description_""">"
		
			// only allow the leaves to be selected
			if $D(menuItems(item,"children")) {
				w description
				kill childItems
				merge childItems=menuItems(item,"children")
				do ..getMenuTreeForJSTree(.childItems,0)
			} else {
				w "<a href=""#"">"_description_"</a>"
			}
			w "</li>"
		}
	}
	w "</ul>"
]]></Implementation>
</Method>

<Method name="getPathByAccessID">
<Description>
Pass in an accessID and this returns the path through the menu
E.g. returns grandParentAccessID|parentAccessID|accessID</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&menuItems,accessID,index=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set result=""
	
	set index=$O(menuItems(index))
	if index="" quit ""
	if $D(menuItems(index,"children")) {
		kill childItems
		merge childItems=menuItems(index,"children")
		set result=result_..getPathByAccessID(.childItems,accessID,"")
	}
	set thisAccessID=$G(menuItems(index,"accessID"))
	
	if accessID=thisAccessID {
		set result=accessID
	} elseif $l(result) {
		set result=thisAccessID_"|"_result
	}
	if '$l(result) {
		set result=..getPathByAccessID(.menuItems,accessID,index)
	}
	quit result
]]></Implementation>
</Method>

<Method name="getDisplayAttributes">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[xEventID,xPersonID,level,&menuItem,&attributes]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	
	set (class,target,href,divID, onClick, outerClass)=""
	set output=$G(menuItem("description"))
	set hoverText=$G(menuItem("hoverText"))
	set accessID=$G(menuItem("accessID"))
	set URL=$G(menuItem("URL"))
	
	//If level2 and has children use the first childs accessID and URL
	if ((level=2)!(level=3))&&($D(menuItem("children"))) {
		set childID=$O(menuItem("children",""))
		set accessID=$G(menuItem("children",childID,"accessID"))
		set URL=$G(menuItem("children",childID,"URL"))
	}
	
	// hellipsisicise the title and the hover text
	set output=$replace(output,"...","&hellip;")
	set hoverText=$replace(hoverText,"...","&hellip;")
	if level=1 set class="ef_top_level_menu_right"
	if level=3 set class="ef_sibling_menu_item"
	if $G(menuItem("class"))'="" {
		set class=menuItem("class")
		if level=1 set output=""
	}
	
	if $ZCVT($G(menuItem("spanEvents")),"U")="YES" {
		set outerClass="ef_menu_option_is_event_spanning"
	}
	if $G(menuItem("isMenuCaption")) {
		set outerClass="ef_menu_top_caption"
	}
	if $G(menuItem("isGroupCaption")) {
		set outerClass="ef_menu_top_group_caption"
	}
	
	if level=1,$G(menuItem("currentlySelected")) set class=class_"_on"
	if level=3,$G(menuItem("currentlySelected")) {
		if outerClass'="" {
			set outerClass=outerClass_" ef_sibling_menu_selected"
		} else {
			set outerClass="ef_sibling_menu_selected"
		}
	}
	
	if $l($G(menuItem("onClick"))) set onClick="onClick='"_menuItem("onClick")_"'"
	if $l($G(menuItem("divID"))) set divID="ID='"_menuItem("divID")_"'"
	

	
	if URL'="" {
		if URL="##PREVIEWURL##" {
			set URL="../../frontEnd/reg/homePage.csp?inSitePageEditing=0&mode=preview&eventID="_xEventID
			set language=##class(setup.objEventSetting).getParameter("backend","default creation language",xEventID)
			if (language) && (language'=1) set URL=URL_"&language="_language
	
			if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID) {
				if URL["registerNew" set URL=URL_"&isAwards=1"
			}
			set href="../../backend/home/backendMenuRedirect.csp?URL="_##class(%CSP.Page).EscapeURL(URL)
		} else {
			// AJM temporary change to always redirect to the playground page
			if $G(%session.Data("eventsforce","backendMenuTest","redirectToPlayground")) set URL="aBackendPlayGround.csp"
			if URL["?" {
				// Make sure the event ID is not added twice
				if URL'["?eventID=",URL'["&eventID=" {
					set URL=URL_"&eventID="_xEventID
				}
			} else {
				set URL=URL_"?eventID="_xEventID
			}
			set href="../../backend/home/backendMenuRedirect.csp?selectedMenuAccessID="_accessID_"&URL="_##class(%CSP.Page).EscapeURL(URL)
		}
	}
	
	if (accessID = "CONMAN") && (##class(setup.objEvent).isEventUsingProweb2(xEventID)) {
		set pageID = ##class(setup.pageIDmethods).getEventHomePage(xEventID, $$$efEnglishLangID)
		set href = "../../system/proweb/start.csp?pageID="_pageID_"&eventID="_xEventID_"&initialiseSession=1"
		set menuItem("newWindow") = 1
	}	
	
	if href="" set href="#"
	if $g(menuItem("newWindow")) set target="target='_blank'"
	
	set attributes("divID")=divID
	set attributes("class")=class
	set attributes("hoverText")=hoverText
	set attributes("href")=href
	set attributes("output")=output
	set attributes("onClick")=onClick
	set attributes("target")=target
	set attributes("outerClass")=outerClass
	
	quit
]]></Implementation>
</Method>

<Method name="useLegacyEditRegistrationPageForEvent">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",eventID) {
		return 1
	} else {
		return 0	
	}
]]></Implementation>
</Method>

<Method name="accessIDappliesToEvent">
<Description>
check to see if a menu item is applicable to the selected event</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventConfiguration:setup.eventConfiguration,accessID</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set out=1
	
	if '$IsObject(eventConfiguration) {
		throw ##class(shared.exceptions.generalException).%New("eventConfiguration must be passed in to accessIDappliesToEvent")	
	}
	
	set xEventID=eventConfiguration.getEventID()
	
	// always allow empty 
	if accessID="" quit 1
	
	// check awards
	if (accessID="AWRD")!(accessID="AWJUDGESET")!(accessID="AWMANAGE") {
		return +eventConfiguration.getIsAwardsEvent()
	}
	if accessID="VIEWBOOK" {
		return ..useLegacyEditRegistrationPageForEvent(xEventID)
	}
	if accessID="REGISTRATIONLIST" {
		return '..useLegacyEditRegistrationPageForEvent(xEventID)
	}
	
	if (accessID="SFEVENTSETTV2") {
		return 0	
	}
	
	// pricing
	if (accessID="FINSET")!(accessID="FINMAN") {
		return +eventConfiguration.getHasCost()
		
	}
	
	// Badges, labels & Letters 
	if (accessID="BADLAB") {
		return 1	
	}
	
	// frontend website access 
	if (accessID="CAPA")!(accessID="WEBADDR")!(accessID="REGWEB")!(accessID="EXTWEB")!(accessID="CAPA")!(accessID="SURV")!(accessID="SEOEVSETTINGS") {
		return 1	
	}
	// sessions
	if (accessID="SESS")!(accessID="PRES")!(accessID="ICONS")!(accessID="SESSDET")!(accessID="SESSTYP")!(accessID="SESSSETT") {
		return +eventConfiguration.areSessionsAllowed()

	}
	if (accessID="PROG")!(accessID="LOCS") {
		if eventConfiguration.areSessionsAllowed() {
			return 1	
		}
		if eventConfiguration.getHasMeetingManager() {
			return 1	
		}
		return 0
	}
	// abstracts
	if (accessID="ABS")!(accessID="ABSMANAGE") {
		return +eventConfiguration.getHasAbstracts()	
	}
	
	
	// accomomodation
	if accessID="ACCOM" {
		return +eventConfiguration.getHasAccommodation()

	}
	// meeting
	if (accessID="MEET")!(accessID="MEETEMAIL") {
		return +eventConfiguration.getHasMeetingManager()

	}	
	// table boookings
	if accessID="TABL" {
		return +eventConfiguration.getHasTableBooking()	

		
	}
	if accessID="TABLGROUP" set out=+##class(setup.objEventSetting).getParameter("table bookings","use table groups",xEventID)
	
	if accessID="ATTCAT" {
		// don't show if standalone table booking mode
		return +eventConfiguration.areAttendeeCategoriesAllowed()

	}

	// Invitations  
	if accessID="INVITE" {
		return 1	
	}

	
	// Emails  
	if accessID="INVMAIL"  {
		return 1	
	}
	
	if accessID="ACTIONLISTUPD" {
		return $S(eventConfiguration.getActionListID():1,1:0)
	}

	if accessID="ATTREC" {
		return +eventConfiguration.getIsAwardsEvent()=0 	
	}	
	quit out
]]></Implementation>
</Method>

<Method name="getAllMenuItems">
<Description>
returns an array(toplevel,"description")= "login"
					      "URL") = "../../login.csp"
                		  "accessID") = "CREMANEV"
					      "spanEvent" = "yes"
					      "requiredModule") = "abstracts"
					      "class") = "ef_myClass"
					      "hoverText") = "click here to do something"
					      "newWindow") = "1"
					      "menuPosition") = "left"
                          "currentlySelected" = "1" -  If the item or a child has been selected
							  {{any other parameter from the backendMenuTree XML}}
                          "children",secondLevel) = array of 2nd level items
                          "children",secondLevel,"children",thirdLevel) = array of 3rd level items</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[xEventID:%String="",xPersonID:%String="",&menuItems]]></FormalSpec>
<Implementation><![CDATA[
	// retrieve the array from the cached version if possible
	if ((xPersonID) && $D(%session)) && ($D(^CacheTempUserMenu(%session.SessionId))) {
		merge menuItems=^CacheTempUserMenu(%session.SessionId)	
		quit
	} 

	set (level1counter,level2counter)=0

	do ..buildMenuArray(.myResults)
	set m=""
	for  {
		set m=$O(myResults(m))
		if m="" quit
		set level=myResults(m,"level")
		if level="level1" {
			set level1counter=level1counter+1
			set level2counter=0
		} elseif level="level2" {
			set level2counter=level2counter+1
			set level3counter=0
		} elseif level="level3" {
			set level3counter=level3counter+1
		}
		set attribute=""
		for  {
			set attribute=$O(myResults(m,attribute))	
			if attribute="" quit
			if level="level1" {
				set menuItems(+level1counter,attribute)=$G(myResults(m,attribute))
			} elseif level="level2" {
				set menuItems(+level1counter,"children",+level2counter,attribute)=$G(myResults(m,attribute))
			} elseif level="level3" {
				set menuItems(+level1counter,"children",+level2counter,"children",+level3counter,attribute)=$G(myResults(m,attribute))
			}
		}
	}	
	// add the shortcuts
	do ..addShortcutsToMenuArray(xPersonID,.menuItems)
	
	// Tidy up the menu
	// 1. cull the disallowed ones
	do ..removedDisallowedMenuItems(xEventID,xPersonID,.menuItems)
	// 2. cull menu items with no children 
	do ..removeMenuItemsWithNoChildren(.menuItems)
	// 3. cull group captions if there is only 1 option for that group
	do ..removeUnneccessaryGroupCaptions(.menuItems)
		

	// populate the temp array
	if (xPersonID) && $D(%session) {
		do ##class(shared.pageMethods).clearBackendMenuCache()
		merge ^CacheTempUserMenu(%session.SessionId)=menuItems
	}	
	return
]]></Implementation>
</Method>

<Method name="getURLFromAccessID">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID,userID,accessID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	do ##class(setup.backendMenu).getAllMenuItems(eventID,userID,.menuItems)
	do ##class(setup.backendMenu).sortMenuItemsByAccessID(.menuItems,.menuItemsByAccessID)
	
	return $G(menuItemsByAccessID(accessID,"URL"))
]]></Implementation>
</Method>

<Method name="removedDisallowedMenuItems">
<Description>
cull the disallowed ones</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[xEventID:%String="",xPersonID:%String="",&menuItems]]></FormalSpec>
<Implementation><![CDATA[
	if xEventID {
		set eventConfiguration=##class(setup.eventConfiguration).createForEventID(xEventID)
	} else {
		set eventConfiguration=""	
	}
	set (level1counter,level2counter,level3counter)=""
	for  {
		set level1counter=$O(menuItems(level1counter))		
		if level1counter="" quit
		set accessID=$G(menuItems(level1counter,"accessID"))
		if accessID'="" {
			kill menuItem merge menuItem=menuItems(level1counter)
			if '..isAllowedAccessToMenuItem(eventConfiguration , xPersonID,.menuItem) kill menuItems(level1counter)
			if accessID="EVENTS" {
				kill oldChildItems,newChildItems
				merge oldChildItems=menuItems(level1counter,"children")
				do ..addEventsToMenuArray(xPersonID,.oldChildItems,.newChildItems)
				
				kill menuItems(level1counter,"children")
				merge menuItems(level1counter,"children")=newChildItems
			} 
		}
		for  {
			set level2counter=$O(menuItems(level1counter,"children",level2counter))			
			if level2counter="" quit
			
			kill menuItem merge menuItem=menuItems(level1counter,"children",level2counter)
			if '..isAllowedAccessToMenuItem(eventConfiguration , xPersonID,.menuItem) {
				kill menuItems(level1counter,"children",level2counter)
			}
			for  {
				set level3counter=$O(menuItems(level1counter,"children",level2counter,"children",level3counter))			
				if level3counter="" quit
			
				kill menuItem merge menuItem=menuItems(level1counter,"children",level2counter,"children",level3counter)
				if '..isAllowedAccessToMenuItem(eventConfiguration , xPersonID,.menuItem) kill menuItems(level1counter,"children",level2counter,"children",level3counter)
			}
		}
	}
]]></Implementation>
</Method>

<Method name="removeMenuItemsWithNoChildren">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&menuItems]]></FormalSpec>
<Implementation><![CDATA[
	set (level1counter,level2counter,level3counter)=""
	for  {
		set level1counter=$O(menuItems(level1counter))		
		if level1counter="" quit
		set level2ItemCount=0
		for  {
			set level2counter=$O(menuItems(level1counter,"children",level2counter))			
			if level2counter="" quit
			set level3ItemCount=0
			for {
				set level3counter=$O(menuItems(level1counter,"children",level2counter,"children",level3counter))
				if level3counter="" quit
				set isMenuCaption=$G(menuItems(level1counter,"children",level2counter,"children",level3counter,"isMenuCaption"))
				if 'isMenuCaption {
					set level3ItemCount=level3ItemCount+1
				}	
			}
			set isMenuCaption=$G(menuItems(level1counter,"children",level2counter,"isMenuCaption"))
			set isGroupCaption=$G(menuItems(level1counter,"children",level2counter,"isGroupCaption"))
			set URL=$G(menuItems(level1counter,"children",level2counter,"URL"))
			set onClick=$G(menuItems(level1counter,"children",level2counter,"onClick"))
				// If I am a menu item and I have no children kill me
			if 'level3ItemCount && 'isMenuCaption &&'$l(URL) && '$l(onClick) && 'isGroupCaption {
				kill menuItems(level1counter,"children",level2counter)
			}
			if 'isMenuCaption {
				set level2ItemCount=level2ItemCount+1
			}
		}
		// If I am a menu item and I have no children kill me
		set isMenuCaption=$G(menuItems(level1counter,"children"))
		set URL=$G(menuItems(level1counter,"URL"))
		set onClick=$G(menuItems(level1counter,"onClick"))
		if 'level2ItemCount && 'isMenuCaption &&'$l(URL) && '$l(onClick) {
			kill menuItems(level1counter)
		}
	}
]]></Implementation>
</Method>

<Method name="removeUnneccessaryGroupCaptions">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&menuItems]]></FormalSpec>
<Implementation><![CDATA[
	set (level1counter,level2counter,level3counter)=""
	for {
		set level1counter=$O(menuItems(level1counter))		
		if level1counter="" quit
		kill menuGroups
		for  {
			set level2counter=$O(menuItems(level1counter,"children",level2counter))			
			if level2counter="" quit
			kill menuItem merge menuItem=menuItems(level1counter,"children",level2counter)
			set menuGroup=$G(menuItem("menuGroup"))
			if $l(menuGroup) {
				if $G(menuItem("isGroupCaption")) {
					set menuGroups(menuGroup,"caption")=level2counter
					
				} else {
					set menuGroups(menuGroup)=$I(menuGroups(menuGroup))
					set menuGroups(menuGroup,"node",level2counter)=""
				}
			}
		}
		// Check all the menu groups for this level and remove the group/caption if there is only one member of the group
		set menuGroup=""
		for {
			set menuGroup=$O(menuGroups(menuGroup))
			if menuGroup="" quit
			if $G(menuGroups(menuGroup))<2 {
				// Remove the caption if there is one
				set captionItem=$G(menuGroups(menuGroup,"caption"))
				if captionItem {
					kill menuItems(level1counter,"children",captionItem)
				}
				for {
					set level2counter=$O(menuGroups(menuGroup,"node",level2counter))
					if level2counter="" quit
					kill menuItems(level1counter,"children",level2counter,"menuGroup")
				}
			}
		}
	}
]]></Implementation>
</Method>

<Method name="updateCurrentlySelected">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[selectedMenuAccessID:%String="",&menuItems]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set (ind1,ind2,ind3)=""
	set selectedFound=0
	for {
		set ind1=$O(menuItems(ind1))
		if ind1="" quit
		if selectedFound quit
		set accessID=$G(menuItems(ind1,"accessID"))
		if $l(accessID),accessID=selectedMenuAccessID {
			set menuItems(ind1,"currentlySelected")=1
			set selectedFound=1
		}
		for {
			set ind2=$O(menuItems(ind1,"children",ind2))
			if ind2="" quit
			if selectedFound quit
			set accessID=$G(menuItems(ind1,"children",ind2,"accessID"))
			if $l(accessID),accessID=selectedMenuAccessID {
				set menuItems(ind1,"currentlySelected")=1
				set menuItems(ind1,"children",ind2,"currentlySelected")=1
				set selectedFound=1
			}
			for {
				set ind3=$O(menuItems(ind1,"children",ind2,"children",ind3))
				if ind3="" quit
				if selectedFound quit
				set accessID=$G(menuItems(ind1,"children",ind2,"children",ind3,"accessID"))
				if $l(accessID),accessID=selectedMenuAccessID {
					set menuItems(ind1,"currentlySelected")=1
					set menuItems(ind1,"children",ind2,"currentlySelected")=1
					set menuItems(ind1,"children",ind2,"children",ind3,"currentlySelected")=1
					set selectedFound=1
				}
			}
		}
	}
]]></Implementation>
</Method>

<Method name="addEventsToMenuArray">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[personID,&inMenuItems,&outMenuItems]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set (inIndex,outIndex)=""
	for {
		set inIndex=$o(inMenuItems(inIndex))
		if inIndex="" quit
		set accessID=$G(inMenuItems(inIndex,"accessID"))
		if accessID="MRUEVENTS" {
			set MRUlist=##class(cod.objItemData).get(personID,"Most Recently Used Events")
			// maximum number of visible links
			set maxLinks=##class(setup.objSetting).getParameter("homepage","Number of items on Most Recently Used Event list")
			if maxLinks="" set maxLinks=6
			set count=0
			for i=$L(MRUlist,","):-1:1 {
				set tmpEventID=$p(MRUlist,",",i)
		
				if count<(maxLinks) {
					if ##class(links.lnkAccessPersonEvent).hasEvent(personID,tmpEventID) {
						if '$D(eventsShown(tmpEventID)) {
							if $I(count)=1 {
								// Add the place holder
								merge outMenuItems($I(outIndex))=inMenuItems(inIndex)
								set outMenuItems(outIndex,"isMenuCaption")=1
								set outMenuItems(outIndex,"URL")=""	
							}
							set eventsShown(tmpEventID)=1 
							merge outMenuItems($I(outIndex))=inMenuItems(inIndex)
							set eventDesc=##class(setup.objEventDetails).getDetails(tmpEventID,1)
							set hoverText=##class(setup.eventBookingMethods).getEventStatus(tmpEventID)
							
							set hoverText=eventDesc_" ("_hoverText_")"
							set outMenuItems(outIndex,"description")="<span class='ef_menu_recent_event_ID'>"_tmpEventID_"</span><span class='ef_menu_recent_event_desc ef_overflow_ellipsis'>"_eventDesc_"</span>"
							set outMenuItems(outIndex,"URL")=$G(outMenuItems(outIndex,"URL"))_"?swEv=1&eventID="_tmpEventID
							set outMenuItems(outIndex,"hoverText")=hoverText
						}
					}
				}
			}
		} else {
			merge outMenuItems($I(outIndex))=inMenuItems(inIndex)
		}
	}
	quit 1
]]></Implementation>
</Method>

<Method name="addShortcutsToMenuArray">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[personID,&menuItems]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	do ..getAllMenuDataByAccessID(.accessIDarray)
	
	set (level1counter,level2counter,level3counter)=""
	for  {
		set level1counter=$O(menuItems(level1counter))		
		if level1counter="" quit
		set accessID=$G(menuItems(level1counter,"accessID"))
		if accessID="SHORTCUTS" {
			
			// save the last item ('configure your shortcuts') as we want to add it to the end of the list
			set level2counter=""
			for  {
				set level2counter=$O(menuItems(level1counter,"children",level2counter))
				if level2counter="" quit
				if $G(menuItems(level1counter,"children",level2counter,"accessID"))="CONFIGSHORTCUTS" {
					merge tempArray=menuItems(level1counter,"children",level2counter)		
				}	
			}
			
			
			// loop through the saved personal shortcuts
			set myIndex=1,foundAtLeastOne=0
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs.Prepare("SELECT * FROM links.lnkUserShortcut WHERE objUser = ?")
			do rs.Execute(personID)
			while (rs.Next()) && (myIndex<=20) {
				set myIndex=$I(myIndex)
				set accessID=rs.Get("accessID")
				if accessID'="" {
					set (shortcutDesc,hoverText)=$G(accessIDarray(accessID,"description"))
					set foundAtLeastOne=1
					set menuItems(level1counter,"children",myIndex,"description")="<span class='ef_menu_shortcut_item ef_overflow_ellipsis'>"_shortcutDesc_"</span>"
					set menuItems(level1counter,"children",myIndex,"URL")=$G(accessIDarray(accessID,"URL"))
					set menuItems(level1counter,"children",myIndex,"hoverText")=hoverText
					set menuItems(level1counter,"children",myIndex,"menuGroup")="ShortcutsItems"
				}
			}
			
			// add back the very last item
			if foundAtLeastOne {
				set myIndex=$I(myIndex)
				merge menuItems(level1counter,"children",myIndex)=tempArray
			}
		}
	}
		
	quit 1
]]></Implementation>
</Method>

<Method name="isAllowedAccessToMenuItem">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[eventConfiguration:setup.eventConfiguration="",xPersonID,&menuItem]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set allowed=1
	if $IsObject(eventConfiguration) {
		set xEventID=eventConfiguration.getEventID()
	} else {
		set xEventID=""	
	}
	set requiredModule=$G(menuItem("requiredModule"))
	set isPublic=$G(menuItem("isPublic"))
	set requiredSystemSetting=$G(menuItem("requiredSystemSetting"))
	set accessID=$G(menuItem("accessID"))
	set isMenuCaption=$G(menuItem("isMenuCaption"))
	set spanEvents=($ZCVT($G(menuItem("spanEvents")),"U")="YES")
	if 'isMenuCaption {
		if $l(requiredSystemSetting) {
			if '##class(setup.objSetting).getParameter("system",requiredSystemSetting) set allowed=0
		}
		if (allowed)&&$l(requiredModule) {
			if ##class(setup.objSystemTypes).isModuleAllowed(requiredModule)=0 set allowed=0
		}
		if (allowed)&&('isPublic) {
			if (xPersonID) && (##class(access.objFunction).hasFunctionByAccessID(xPersonID,accessID)=0) set allowed=0
		}
		if allowed {
			if (xEventID) && (..accessIDappliesToEvent(eventConfiguration,accessID)=0) set allowed=0
		}
	}
	if xPersonID {
		if ('xEventID) && ('spanEvents) set allowed=0
	}
	quit allowed
]]></Implementation>
</Method>

<Method name="getAllPrivateMenuItems">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&menuItems]]></FormalSpec>
<Implementation><![CDATA[
	set (level1counter,level2counter)=0

	do ..buildMenuArray(.myResults)
	
	set m=""
	set count = 0
	for  {
		set m=$O(myResults(m))
		if m="" quit
		if (('$G(myResults(m,"isMenuCaption")))&&('$G(myResults(m,"isPublic")))) {
			set count = count + 1
			set menuItems(count, "description") = myResults(m,"description")
			set menuItems(count, "accessID") = myResults(m,"accessID")
			set menuItems(count, "requiredModule") = $G(myResults(m,"requiredModule"))
			set menuItems(count, "requiredSystemSetting") = $G(myResults(m,"requiredSystemSetting"))
		}
	}
		
	return
]]></Implementation>
</Method>

<Method name="getAllMenuDataByAccessID">
<Description>
returns an array where accessID is the index</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&menuItems]]></FormalSpec>
<Implementation><![CDATA[
	set (level1counter,level2counter)=0

	do ..buildMenuArray(.myResults)
	
	set m=""
	for  {
		set m=$O(myResults(m))
		if m="" quit
		set accessID=$g(myResults(m,"accessID"))
		if $l(accessID) {
			kill menuItems(accessID)
			merge menuItems(accessID) = myResults(m)
		}
	}
		
	return
]]></Implementation>
</Method>

<Method name="getAllPrivateMenuItemsByAccessID">
<Description>
returns an array where accessID is the index and description is value.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&menuItems]]></FormalSpec>
<Implementation><![CDATA[
	set (level1counter,level2counter)=0
	
	do ..buildMenuArray(.myResults)
	
	set m=""
	for  {
		set m=$O(myResults(m))
		if m="" quit
		if (('$G(myResults(m,"isMenuCaption")))&&('$G(myResults(m,"isPublic")))) {
			set menuItems(myResults(m,"accessID"),"description") = myResults(m,"description")
			set menuItems(myResults(m,"accessID"),"requiredModule") =  $G(myResults(m,"requiredModule"))
			set menuItems(myResults(m,"accessID"),"requiredSystemSetting") = $G(myResults(m,"requiredSystemSetting"))
		}
	}
		
	return
]]></Implementation>
</Method>

<Method name="sortMenuItemsByAccessID">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&menuItems,&menuItemsByAccessID,index=""]]></FormalSpec>
<Implementation><![CDATA[
	set result=""
	
	set index=$O(menuItems(index))
	if index="" quit
	if $D(menuItems(index,"children")) {
		kill childItems
		merge childItems=menuItems(index,"children")
		do ..sortMenuItemsByAccessID(.childItems,.menuItemsByAccessID)
	}
	set accessID=$G(menuItems(index,"accessID"))
	if ($l(accessID)) {
		merge menuItemsByAccessID(accessID) = menuItems(index)
	}
	
	do ..sortMenuItemsByAccessID(.menuItems,.menuItemsByAccessID,index)
	
	quit
]]></Implementation>
</Method>

<Method name="getAllPublicMenuItemsByAccessID">
<Description>
returns an array where accessID is the index and description is value.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&menuItems]]></FormalSpec>
<Implementation><![CDATA[
	set (level1counter,level2counter)=0

	do ..buildMenuArray(.myResults)
	
	set m=""
	for  {
		set m=$O(myResults(m))
		if m="" quit
		if ($l($G(myResults(m,"accessID")))&&($G(myResults(m,"isPublic")))) {
			set menuItems(myResults(m,"accessID"),"description") = myResults(m,"description")
			set menuItems(myResults(m,"accessID"),"requiredModule") =  $G(myResults(m,"requiredModule"))
			set menuItems(myResults(m,"accessID"),"requiredSystemSetting") = $G(myResults(m,"requiredSystemSetting"))
		}
	}
		
	return
]]></Implementation>
</Method>

<Method name="clearDownPublicFunctions">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	do ##class(setup.backendMenu).getAllPublicMenuItemsByAccessID(.menuItems) 
	set accessID = ""
	for {
		set accessID = $O(menuItems(accessID))
		if accessID="" quit
		
		&SQL(DELETE FROM access.lnkFunctionRole
			WHERE objFunction->accessID = :accessID
		)
		
		&SQL(DELETE FROM access.objFunction
			WHERE accessID = :accessID
		)		
	}
]]></Implementation>
</Method>

<Method name="upgradeNewBackendMenu">
<Description>
this Method is to update all the current roles to have the new accessIDs 
so that users can use it without problem. </Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	do ##class(setup.objSetting).setParameter("homepage","Number of items on Most Recently Used Event list",5)
	//Add the TESTEV accessID to all roles except Dynamic reporting and single report roles.
	
	do ##class(access.objFunction).populateFunctionsFromXML()
	do ##class(access.lnkFunctionRole).addFunctionToAllRolesExcluding("TESTEV")
	
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT * FROM access.objRole")
	do rs.Execute()
	set roleID=""
	set roleDesc = ""
	set excludingRoles="|Dynamic Reports Only|Reports only|"
	while rs.Next() {
		set roleID = rs.Get("ID")
		set roleDesc = "|"_rs.Get("description")_"|"
		if excludingRoles[roleDesc {
			//ignore this role
		} else {
			//check if the role has got one of the children accessID for FrontEnd Website Content. FRONTSITECONT
				
			if ##class(access.lnkFunctionRole).doesRoleHasFunction(roleID,"INV") {
				do ##class(access.lnkFunctionRole).add(roleID,"INVLIST")
			}
			if ##class(access.lnkFunctionRole).doesRoleHasFunction(roleID,"INV") {
				do ##class(access.lnkFunctionRole).add(roleID,"INVRUN")
			}
		}
	}
	do ..clearDownPublicFunctions()
	do ..upgradeActionListToNewMenu()
	quit 1
]]></Implementation>
</Method>

<Method name="buildMenuArray">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&menuArray]]></FormalSpec>
<Implementation><![CDATA[
	kill menuArray
	
	set xDataID = "backendMenuTree"
	
	if (##class(setup.objSetting).getParameter("feature flags", "use legacy backend menu")) {
		set xDataID = "backendMenuTreeLegacy"
	}
	
	set xDataStream = ##class(%Dictionary.CompiledXData).%OpenId("setup.backendMenu||"_xDataID).Data
	if '$IsObject(xDataStream) {
		throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(%objlasterror)
	}
	
	set sc = ##class(%XML.XPATH.Document).CreateFromStream(xDataStream, .xmlDocument)
	if $$$ISERR(sc) {
		return
	}
	
	kill menuArray
	kill xmlNodes
	
	set sc = xmlDocument.EvaluateExpression("/backendMenu", "*", .xmlNodes) // '*' returns all children
	if $$$ISERR(sc) {
		throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
	}
	
	set counter=0
	for nodeIdx = 1 : 1 : xmlNodes.Count() {
		
		set xmlNode = xmlNodes.GetAt(nodeIdx)
		
		if (xmlNode.Type = $$$XPATHDOM) {
			
			while xmlNode.Read() {	
				
				set counter = counter + 1
				
				if (xmlNode.NodeType = "element") {
					
					set menuArray(counter, "level") = xmlNode.Name
					if (xmlNode.HasAttributes) {
						
						for attrIdx = 1 : 1 : xmlNode.AttributeCount {
							
							do xmlNode.MoveToAttributeIndex(attrIdx)
							
							set menuArray(counter, xmlNode.Name) = xmlNode.Value
						}
					}
					
				}
				
			}
			
		}
		
	}
]]></Implementation>
</Method>

<XData name="backendMenuTreeLegacy">
<Description>
please note that you must escape any ampersands in the data</Description>
<Data><![CDATA[
<backendMenu>
<level1 description="Create New" hoverText="Create New..." divID="ef_menu_button_add" class="ef_menu_button_add" URL="" accessID="CREMANEV" spanEvents="yes" requiredModule="" menuPosition="left" noSiblingMenu="1" isPublic="1">
<level2 description="Create New..." URL="" isMenuCaption="1" spanEvents="yes"/>
<level2 description="Event" URL="../../backend/home/eventProperties.csp?eventID=NEW" accessID="NEWEVENT" spanEvents="yes" requiredModule="" previewImage="event.png"/>
<level2 description="Event using an existing event as a template" URL="../../backend/home/eventCopy.csp" accessID="COPYEVENT" spanEvents="no" requiredModule="" previewImage="event using temp.png"/>
<level2 description="Registration" URL="../../frontEnd/reg/initSession.csp?page=registerNew.csp&amp;backendBooking=1"  accessID="NEWBOOK" spanEvents="no" newWindow="1" requiredModule="New Backend Booking" previewImage="booking.png"/>
<level2 description="Ad-Hoc Email" URL="../../backend/home/gotoNewAdhocEmail.csp" accessID="NEWEMAIL" spanEvents="no" requiredModule="EMAIL" previewImage="ad-hoc email.png"/>
</level1>
<level1 description="Task List" hoverText="View Action List" onClick="wizardEntryPopup()" divID="ef_menu_button_tasks" class="ef_menu_button_tasks" accessID="ACTIONLISTUPD" spanEvents="no" requiredModule="Action List" menuPosition="left" hideFromActionList="1"/>
<level1 description="Test" hoverText="Preview and test Event Website" URL="##PREVIEWURL##" divID="ef_menu_button_preview"  class="ef_menu_button_preview" newWindow="1" accessID="TESTEV" spanEvents="no" menuPosition="left" hideFromActionList="1"/>
<level1 description="Shortcuts" accessID="SHORTCUTS" noSiblingMenu="1" hoverText="Shortcuts" isPublic="1" URL="" divID="ef_menu_button_shortcuts"  class="ef_menu_button_shortcuts"  menuPosition="left" hideFromActionList="1">
<level2 description="Your Personal  Shortcuts..."  isPublic="1" URL="" isMenuCaption="1"/>
<level2 description="Configure Shortcuts" accessID="CONFIGSHORTCUTS" URL="../../backend/home/usershortcuts.csp" spanEvents="no" isPublic="1"/>
</level1>
<level1 description="Home" hoverText="Event Dashboard" URL="../../backend/home/dashboardRedirect.csp" class="ef_menu_button_home" accessID="HOME" isPublic="1" spanEvents="no" requiredModule="" menuPosition="right" hideFromActionList="1"/>
<level1 description="System" hoverText="System Settings" class="ef_menu_button_system" URL="" accessID="SYSMAN" spanEvents="yes" requiredModule="" menuPosition="right" isPublic="1">
<level2 description="System Settings" URL="" isMenuCaption="1"/>
<level2 description="My Details" URL="../../backend/home/myDetails.csp" accessID="MYDETAILS" isPublic="1" spanEvents="yes" requiredModule=""/>
<level2 description="Security" URL="" accessID="SYSUSERMAN" spanEvents="yes" isPublic="1" requiredModule="">
<level3 description="User Profiles" URL="../../backend/home/userList.csp"        accessID="SYSUSER" spanEvents="yes" requiredModule="User Management" previewImage="user Profiles.png"/>
<level3 description="Roles" URL="../../backend/home/userRoleList.csp"    accessID="SYSROLE" spanEvents="yes" requiredModule="Role Management"  previewImage="Roles.png"/>
<level3 description="Org Units Setup" URL="../../backend/home/orgUnitSetup.csp"  accessID="SYSORGUNITSETUP" spanEvents="yes" requiredModule="Organisational Units - Aviva Only" />
</level2>
<level2 description="Preferences" URL="" isPublic="1" accessID="SYSPREF" spanEvents="yes" requiredModule="">
<level3 description="System Defaults" URL="../../backend/home/systemDefaults.csp"        accessID="SYSDEF" spanEvents="yes" requiredModule="" previewImage="system defaults.png"/>
<level3 description="Account Details" URL="../../backend/home/clientSetting.csp"     accessID="SYSCLI" spanEvents="yes" requiredModule="" previewImage="my account details.png"/>
<level3 description="Translations" URL="../../backend/home/translationLanguages.csp" accessID="ACCESSTRANS" spanEvents="yes" requiredModule="Allow Access to Translation" previewImage="translations.png"/>
<level3 description="Templates" URL="../../backend/home/themeLoad.csp" accessID="ACCESSLOADTHEME" spanEvents="yes" requiredModule="Upload Template" previewImage="templates.png"/>
</level2>
<level2 description="Manage Lists" URL="" isPublic="1" accessID="SYSLIST" spanEvents="yes" requiredModule="">
<level3 description="Attendee Categories" URL="../../backend/home/eventCategoryList.csp"      accessID="ATTLIST" spanEvents="yes" requiredModule="Attendee Categories" previewImage="attendee categories2.png"/>
<level3 description="Action List" URL="../../backend/home/wizardList.csp"        accessID="ACTLIS" spanEvents="yes" requiredModule="Action List" previewImage="action lists.png"/>
<level3 description="Hotel Library" URL="../../backend/home/venueSearch.csp?pageMode=library"    accessID="ACCLIB" spanEvents="yes" requiredModule="Accommodation" previewImage="Hotel Library.png"/>
</level2>
<level2 description="Prompt Manager" URL="" isPublic="1" accessID="SYSPROMPTS" spanEvents="yes" requiredModule="">
<level3 description="Data Items" URL="../../backend/home/codItemSearch.csp"      accessID="SYSDATA" spanEvents="yes" requiredModule="Data Items" previewImage="data items.png"/>
<level3 description="Collections" URL="../../backend/home/codCollectionList.csp"  accessID="REGCOLL" spanEvents="yes" requiredModule="Registration prompt collections" previewImage="collections.png"/>
<level3 description="Custom Event Fields" URL="../../backend/home/softEventPromptList.csp"        accessID="CUSTEVFIELD" spanEvents="yes" requiredModule="Custom event fields" previewImage="soft event prompts.png"/>
</level2>
<level2 description="Salesforce" URL="" isPublic="1" accessID="SFMENU" spanEvents="yes" requiredModule="SALESFORCE">
<level3 description="Transactions" URL="../../backend/home/sfTxnList.csp"     accessID="SFTXNLIST" spanEvents="yes" requiredModule="SALESFORCE" previewImage="salesforce transactions.png"/>
<level3 description="Settings" URL="../../backend/home/systemSettingsSalesforce.csp"     accessID="SFSYSSETTINGS" spanEvents="yes" requiredModule="SALESFORCE" previewImage="salesforce system settings.png"/>
<level3 description="Field Mappings" URL="../../backend/home/salesforceMappings.csp"     accessID="SFMAPPING" spanEvents="yes" requiredModule="SALESFORCE" previewImage="salesforce mappings.png"/> 
</level2>
<level2 description="Schroders' Salesforce" URL="" isPublic="1" accessID="SFSCHRODERSMENU" spanEvents="yes" requiredModule="SALESFORCE SCHRODERS">
<level3 description="Transactions" URL="../../backend/home/sfTxnList.csp"     accessID="SFSCHRODERSTXNLIST" spanEvents="yes" requiredModule="SALESFORCE SCHRODERS" previewImage="salesforce transactions.png"/>
</level2>
<level2 description="Eventsforce Tools" URL="" isPublic="1" accessID="EVONLYTOOLS" spanEvents="yes" requiredModule="" menuGroup="EFONLY" hideFromActionList="1">
<level3 description="Messages" URL="../../backend/home/userMessages.csp"    accessID="EVMSGS" spanEvents="yes" requiredModule="" previewImage=""/>
<level3 description="Session Dump" URL="../../system/sessionDump.csp" accessID="EVSESSDUMP" spanEvents="yes" requiredModule="" previewImage=""/>
<level3 description="Application Errors" URL="../../system/listAppErrors.csp" accessID="EVAPPERRORS" spanEvents="yes" requiredModule="" previewImage=""/>
<level3 description="Unit Tests" URL="../../system/unitTests.csp" accessID="EVUNITTESTS" spanEvents="yes" requiredModule="" previewImage=""/>
<level3 description="Multi Audit" URL="../../backend/home/multiSourceAudit.csp"       accessID="EVSMULTAUDIT" spanEvents="yes" requiredModule="" previewImage=""/>
<level3 description="Proweb Tree" URL="../../backend/home/prowebTreeDisplay.csp"      accessID="EVPROWEBTREE" spanEvents="yes" requiredModule="" previewImage=""/>
<level3 description="Playground" URL="../../backend/home/aBackendPlayGround.csp"      accessID="EVPLAYGROUND" spanEvents="yes" requiredModule="" previewImage=""/>
<level3 description="Templates" URL="../../backend/home/themeLoad.csp"        accessID="EVLOADTHEME" spanEvents="yes" requiredModule="" previewImage=""/>
</level2>
<level2 description="Eventsforce Settings" URL="" isPublic="1" accessID="EVONLYSETTINGS" spanEvents="yes" requiredModule="" menuGroup="EFONLY" hideFromActionList="1">
<level3 description="Custom Packages" URL="../../backend/home/systemTypeList.csp"       accessID="EVMOD" spanEvents="yes" requiredModule=""/>
<level3 description="Translations" URL="../../backend/home/translationLanguages.csp"     accessID="EVTRANS" spanEvents="yes" requiredModule=""/>
<level3 description="License" URL="../../backend/home/eventsforceLicense.csp"   accessID="EVLIC" spanEvents="yes" requiredModule=""/>
<level3 description="Currencies" URL="../../backend/home/currencyList.csp"    accessID="EVCURRENCIES" spanEvents="yes" requiredModule=""/>
<level3 description="Salesforce" URL="../../backend/home/sfSettingsEF.csp"      accessID="EVSFSETT" spanEvents="yes" requiredModule="SALESFORCE"/>
<level3 description="Installation" URL="../../backend/home/systemSettings.csp"  accessID="EVSETT" spanEvents="yes" requiredModule=""/>
</level2>
</level1>
<level1 description="Event List" hoverText="" URL="" isPublic="1" accessID="EVENTS" spanEvents="no" requiredModule="" menuPosition="right" noSiblingMenu="1" hideFromActionList="1">
<level2 description="Select a recent event..." accessID="MRUEVENTS" URL="../../backend/home/switchEvent.csp" menuGroup="RecentEvents"/>
<level2 description="Show all Events" URL="../../backend/home/eventSelection.csp"  accessID="ALLEVENTS" spanEvents="yes" requiredModule="" menuGroup="AllEvents"/> 
</level1>
<level1 description="Event" hoverText="Setup and administer your event" URL="" accessID="EVSETUP" spanEvents="no" requiredModule=""  menuPosition="right">
<level2 description="Select Area..." URL="" isMenuCaption="1"/>
<level2 description="Settings" URL="" accessID="MAINSETT" spanEvents="no" requiredModule="" isPublic="1">
<level3 description="Properties" URL="../../backend/home/eventProperties.csp" accessID="EVPROP" spanEvents="no" requiredModule="" previewImage="event.png"/>
<level3 description="Capacity" URL="../../backend/home/eventCapacity.csp" accessID="CAPA" spanEvents="no" requiredModule="" previewImage="capacity.png"/>
<level3 description="Registration" URL="../../backend/home/registrationSettings.csp" accessID="BOOKOPT" spanEvents="no" requiredModule="" previewImage="booking options.png"/>
<level3 description="Attendee Categories" URL="../../backend/home/eventAttendeeCategories.csp"   accessID="ATTCAT" spanEvents="no" requiredModule="Attendee Categories" previewImage="attendee categories.png"/>
<level3 description="Salesforce" URL="../../backend/home/eventSettingsSalesforce.csp" accessID="SFEVENTSETTV2" spanEvents="no" requiredModule="SALESFORCE" previewImage=""/>
</level2>
<level2 description="Sessions" URL="" accessID="PROG" spanEvents="no" requiredModule="Sessions" isPublic="1">
<level3 description="Sessions Details" URL="../../backend/home/itemList.csp"     accessID="SESSDET" spanEvents="no" requiredModule="Sessions" previewImage="session details.png"/>
<level3 description="Presenters" URL="../../backend/home/presenterList.csp"      accessID="PRES" spanEvents="no" requiredModule="Sessions" previewImage="presenters.png"/>
<level3 description="Locations" URL="../../backend/home/locationList.csp?"       accessID="LOCS" spanEvents="no" requiredModule="Sessions" previewImage="locations.png"/>
<level3 description="Session Types" URL="../../backend/home/sessionTypeList.csp" accessID="SESSTYP" spanEvents="yes" requiredModule="Sessions" previewImage="session types.png"/>
<level3 description="Icons" URL="../../backend/home/iconList.csp"        accessID="ICONS" spanEvents="no" requiredModule="Sessions" previewImage="icons.png"/>
<level3 description="Session Settings" URL="../../backend/home/eventSettingsAgendaSessions.csp" accessID="SESSSETT" spanEvents="no" requiredModule="Sessions" previewImage="session settings.png"/>
</level2>
<level2 description="Financial Setup" URL="" accessID="FINSET" spanEvents="no" requiredModule="Pricing" menuGroup="EVFIN" isPublic="1">
<level3 description="Prices" URL="../../backend/home/priceList.csp"      accessID="PRICE" spanEvents="no" requiredModule="Price descriptors" previewImage="prices.png"/>
<level3 description="Discounts" URL="../../backend/home/discountList.csp"        accessID="DISC" spanEvents="no" requiredModule="Discounts" previewImage="discounts.png"/>
<level3 description="Payment Methods" URL="../../backend/home/paymentDetails.csp"        accessID="PAYMETH" spanEvents="no" requiredModule="" previewImage="payment methods.png"/>
<level3 description="VAT Codes" URL="../../backend/home/vatCodeList.csp" accessID="VATCODE" spanEvents="yes" requiredModule="" previewImage="vat codes.png"/>
<level3 description="Cost Centres" URL="../../backend/home/costCentreOrgUnitList.csp"   accessID="CCORGUNITLIST" spanEvents="yes" requiredModule="Organisational Units - Aviva Only" previewImage=""/>
<level3 description="Settings" URL="../../backend/home/eventSettingsFinancial.csp"     accessID="FINSETT" spanEvents="no" requiredModule="" previewImage="settings (financial).png"/>
</level2>
<level2 description="Financial Management" URL="" accessID="FINMAN" spanEvents="no" requiredModule="Pricing" menuGroup="EVFIN" isPublic="1">
<level3 description="Invoice Control" URL="../../backend/home/invoiceExport.csp" accessID="INVEXPORT" spanEvents="no" requiredModule="Invoice Export" previewImage="invoice control.png"/>
<level3 description="Invoice Run" URL="../../backend/home/invoicingMain.csp"     accessID="INVRUN" spanEvents="no" requiredModule="Invoice" previewImage="invoice run.png"/>
<level3 description="Invoice List" URL="../../backend/home/invoiceList.csp"     accessID="INVLIST" spanEvents="no" requiredModule="Invoice" requiredSystemSetting="haymarket special invoice list" previewImage=""/>
<level3 description="Profit &amp; Loss" URL="../../backend/home/profitAndLoss1.csp"  accessID="PROFLOSS" spanEvents="yes" requiredModule="Profit &amp; Loss" previewImage="profit and loss.png"/>
</level2>
<level2 description="Awards Setup" URL="" accessID="AWRD" spanEvents="no" requiredModule="Awards" menuGroup="Awards" isPublic="1">
<level3 description="Categories" URL="../../backend/home/awardsCategoryList.csp" accessID="AWCAT" spanEvents="no" requiredModule="Awards" previewImage="categories (Awards.png"/>
<level3 description="Sections" URL="../../backend/home/awardsSectionList.csp" accessID="AWSEC" spanEvents="no" requiredModule="Awards" previewImage="sections.png"/>
<level3 description="Award Types" URL="../../backend/home/awardsAwardList.csp" accessID="AWAW" spanEvents="no" requiredModule="Awards" previewImage="award types.png"/>
<level3 description="Settings" URL="../../backend/home/eventSettingsAwards.csp"   accessID="AWSETT" spanEvents="no" requiredModule="Awards" previewImage="settings (awards).png"/> 
</level2>
<level2 description="Judging Setup" URL="" accessID="AWJUDGESET" spanEvents="no" requiredModule="Awards" menuGroup="Awards" isPublic="1">
<level3 description="Judging Panel" URL="../../backend/home/awardsPanelList.csp" accessID="AWJUDGE" spanEvents="no" requiredModule="Awards" previewImage="judging panel.png"/>
<level3 description="Criteria" URL="../../backend/home/awardsCriteriaList.csp" accessID="AWCRIT" spanEvents="no" requiredModule="Awards" previewImage="criteria awards.png"/>
</level2>
<level2 description="Awards Management" URL="" accessID="AWMANAGE" spanEvents="no" requiredModule="Awards" menuGroup="Awards" isPublic="1">
<level3 description="Entries" URL="../../backend/home/awardsOverview.csp?load=1" accessID="AWSUB" spanEvents="no" requiredModule="Awards"  previewImage="entries.png"/>
<level3 description="Submitters" URL="../../backend/home/awardsSubmitterDetails.csp"      accessID="AWSUBDET" spanEvents="no" requiredModule="Awards"  previewImage="submitter details.png"/>
<level3 description="Judging Overview" URL="../../backend/home/awardsJudgingOverview.csp?load=1" accessID="AWJUDOV" spanEvents="no" requiredModule="Awards" previewImage="judging overview.png"/>
<level3 description="Judges" URL="../../backend/home/awardsJudgingDetails.csp"   accessID="AWJUDDET" spanEvents="no" requiredModule="Awards" previewImage="judging details.png"/>
<level3 description="Award Assignment" URL="../../backend/home/awardsAssignment.csp"     accessID="AWASS" spanEvents="no" requiredModule="Awards" previewImage="awards assignment.png"/>
</level2>

<level2 description="Abstracts Setup" URL="" accessID="ABS" spanEvents="no" requiredModule="Abstract Management" menuGroup="Abstracts" isPublic="1">
<level3 description="Topics" URL="../../backend/home/absTopicList.csp"   accessID="ABSTOP" spanEvents="no" requiredModule="Abstract Management" previewImage="topics.png"/>
<level3 description="Reviewing Criteria" URL="../../backend/home/absCriteriaList.csp"    accessID="ABSCRIT" spanEvents="no" requiredModule="Abstract Management" previewImage="reviewing criteria abstracts.png"/>
<level3 description="Reviewers" URL="../../backend/home/absUserList.csp" accessID="ABSREV" spanEvents="no" requiredModule="Abstract Management" previewImage="reviewers.png"/>
<level3 description="Presentation Methods" URL="../../backend/home/absPresentationMethodEvent.csp" accessID="SYSABSPRES" spanEvents="no" requiredModule="Abstract Management" previewImage="presentation methods.png"/>
<level3 description="Default Methods" URL="../../backend/home/absPresentationMethods.csp" accessID="ABSPRESEV" spanEvents="yes" requiredModule="Abstract Management" previewImage="default presentation methods.png"/>
<level3 description="Settings" URL="../../backend/home/abstractSettings.csp" accessID="ABSSETT" spanEvents="no" requiredModule="Abstract Management" previewImage="settings abstracts.png"/>

</level2>
<level2 description="Abstracts Management" URL="" accessID="ABSMANAGE" spanEvents="no" requiredModule="Abstract Management" menuGroup="Abstracts" isPublic="1">
<level3 description="Submissions" URL="../../backend/home/abstractSubmissions.csp"        accessID="ABSSUB" spanEvents="no" requiredModule="Abstract Management" previewImage="submitted abstracts.png"/>
<level3 description="Reviews" URL="../../backend/home/absReviewsOverview.csp?load=1"     accessID="ABSRVW" spanEvents="no" requiredModule="Abstract Management" previewImage="reviews.png"/>
</level2>
<level2 description="Table Bookings" URL=""   accessID="TABL" spanEvents="no" requiredModule="Table Booking" isPublic="1">
<level3 description="Table List" URL="../../backend/home/tableList.csp"  accessID="TABLELIST" spanEvents="no" requiredModule="Table Booking" previewImage="table list.png"/>
<level3 description="Table Groups" URL="../../backend/home/tableGroupList.csp"   accessID="TABLGROUP" spanEvents="no" requiredModule="Table Groups" previewImage="table groups.png"/>
<level3 description="Seating Arrangement" URL="../../backend/home/tablePlanningAdvanced.csp"     accessID="TABLSEAT" spanEvents="no" requiredModule="Table Booking" previewImage="seating arrangement.png"/>
<level3 description="Table Settings" URL="../../backend/home/tableSettings.csp"  accessID="TABLSETT" spanEvents="no" requiredModule="Table Booking" previewImage="table settings.png"/>
</level2>
<level2 description="Accommodation" URL=""    accessID="ACCOM" spanEvents="no" requiredModule="Accommodation" isPublic="1">
<level3 description="Hotel List" URL="../../backend/home/hotelList.csp"  accessID="ACCHOT" spanEvents="no" requiredModule="Accommodation" previewImage="hotel list.png"/>
<level3 description="Accommodation Settings" URL="../../backend/home/eventSettingsAccom.csp"     accessID="ACCSETT" spanEvents="no" requiredModule="Accommodation" previewImage="accommodation settings.png"/>
</level2>
<level2 description="Meeting Manager" URL=""  accessID="MEET" spanEvents="no" requiredModule="Meeting Manager" isPublic="1">
<level3 description="Arranged Meetings" URL="../../backend/home/meetManOverview.csp?load=1"      accessID="MEETOVER" spanEvents="no" requiredModule="Meeting Manager" previewImage="arranged meetings.png"/>
<level3 description="Diary Slots" URL="../../backend/home/meetManDiarySlots.csp" accessID="MEETSLOTS" spanEvents="no" requiredModule="Meeting Manager" previewImage="diary slots.png"/>
<level3 description="Lunches" URL="../../backend/home/meetManLunches.csp?load=1" accessID="MEETLUNCH" spanEvents="no" requiredModule="Meeting Manager Lunches" previewImage=""/>
<level3 description="Meeting Manager Settings" URL="../../backend/home/eventSettingsMeetMan.csp" accessID="MEETSET" spanEvents="no" requiredModule="Meeting Manager" previewImage="meeting manager settings.png"/>
</level2>
<level2 description="Event Management" URL="" accessID="EVMAN" spanEvents="no" requiredModule="Event Management - Enterprise Ireland" isPublic="1">
<level3 description="Tasks" URL="../../backend/evMan/evManTaskList.csp"  accessID="EVTASK" spanEvents="no" requiredModule="Event Management - Enterprise Ireland" previewImage="Tasks.png"/>
<level3 description="Resources" URL="../../backend/evMan/evManResourceList.csp"  accessID="EVRES" spanEvents="no" requiredModule="Event Management - Enterprise Ireland" previewImage="resources.png"/>
<level3 description="Task Planning" URL="../../backend/evMan/evManTaskPlanning.csp"      accessID="EVTASKPL" spanEvents="no" requiredModule="Event Management - Enterprise Ireland" previewImage="task planning.png"/>
<level3 description="Task Types" URL="../../backend/evMan/evManTaskTypeList.csp"        accessID="EVTASKTYP" spanEvents="no" requiredModule="Event Management - Enterprise Ireland" previewImage="task types.png"/>
<level3 description="Event Calendar" URL="../../backend/home/eventCalendarMonthly.csp"   accessID="EVCAL" spanEvents="yes" previewImage="event calendar (Event management).png" isPublic="1"/>
<level3 description="Event Managers" URL="../../backend/evMan/evManEventManagers.csp"    accessID="EVMANS" spanEvents="yes" requiredModule="Event Management - Enterprise Ireland" previewImage="event managers.png"/>
</level2>
<level2 description="Badges, Labels &amp; Letters" accessID="BADLABMEN" spanEvents="no" requiredModule="Badges &amp; Labels &amp; Letters" isPublic="1">
	<level3 description="Setup &amp; Management" URL="../../backend/home/selectPrint.csp"   accessID="BADLAB" spanEvents="no" requiredModule="Badges &amp; Labels &amp; Letters" previewImage="setup and Management (Badges letters and labels).png"/>
</level2>
</level1>
<level1 description="Website" URL="" hoverText="Setup and manage your website" accessID="FRONT" spanEvents="no" requiredModule="frontEndWebPages"  menuPosition="right" isPublic="1">
<level2 description="Manage your Website..." URL="" isMenuCaption="1"/>
<level2 description="Content" URL=""  accessID="FRONTSITECONT" spanEvents="no" requiredModule="" isPublic="1">
<level3 description="Website Contents" URL="../../backend/home/inSiteEditingFrame.csp"  accessID="CONMAN" spanEvents="no" requiredModule="" previewImage="website contents.png"/>
<level3 description="Registration Pages" URL="../../backend/home/regPages.csp"   accessID="REGPAG" spanEvents="no" requiredModule="" previewImage="registration pages.png"/>
<level3 description="Additional Booking Items" URL="../../backend/home/additionalItemsList.csp"  accessID="ABIS" spanEvents="no" requiredModule="Additional Bookings Items Overview" previewImage="Additional booking items.png"/>
<level3 description="External Pages" URL="../../backend/home/externalWebPages.csp" accessID="EXTWEB" spanEvents="yes" requiredModule="External Webpages" previewImage="external pages.png"/>
</level2>
<level2 description="Design" URL=""   accessID="FRONTSITEDESN" spanEvents="no" requiredModule="" isPublic="1">
<level3 description="Select Template" URL="../../backend/home/themeBrowser.csp"  accessID="THEMES" spanEvents="no" requiredModule="" previewImage="select template.png"/>
<level3 description="Appearance" URL="../../backend/home/websiteAppearance.csp" accessID="FONTSCOLORS" spanEvents="no" requiredModule="" previewImage="website colors.png"/>
</level2> 
<level2 description="Settings" URL="" accessID="FRONTSITESETNG" spanEvents="no" requiredModule="" isPublic="1">
<level3 description="Website Settings" URL="../../backend/home/websiteSettings.csp" accessID="WEBSETT" spanEvents="no" requiredModule="" previewImage="website settings.png"/>
<level3 description="SEO Settings" URL="../../backend/home/seoEventSettings.csp" accessID="SEOEVSETTINGS" spanEvents="no" requiredModule="SEO" previewImage="seo settings.png"/>
<level3 description="Web Addresses" URL="../../backend/home/eventSettingsWebAddr.csp"    accessID="WEBADDR" spanEvents="no" requiredModule="" previewImage="web addresses.png"/>

</level2>
</level1>
<level1 description="Communications" URL="" hoverText="Communicate with your customers by email and surveys" accessID="INVMAIL" spanEvents="no" requiredModule=""  menuPosition="right" isPublic="1">
<level2 description="Approvals" URL="../../backend/bespokePages/schrodersEmailApprovals.csp" accessID="SCHROEMAILAPP" spanEvents="yes" isPublic="1" requiredSystemSetting="Schroders approval required for bulk emails" previewImage=""/>
<level2 description="Emails" URL="" accessID="COMMEMAIL" spanEvents="no" requiredModule="" isPublic="1">
<level3 description="Log" URL="../../backend/home/emailLog.csp" accessID="MAILLOG" spanEvents="yes" requiredModule="Email Log" previewImage="log (email).png"/>
<level3 description="Automatic" URL="../../backend/home/emailSettings.csp" accessID="MAILTEMPL" spanEvents="no" requiredModule="EMAIL" previewImage="automatic.png"/>
<level3 description="Ad-Hoc" URL="../../backend/home/eventEmails2.csp?butEvent_=1" accessID="EMAIL" spanEvents="no" requiredModule="EMAIL" previewImage="ad-hoc.png"/>
<level3 description="Invitations" URL="../../backend/home/preRegister.csp?clearPage=1" accessID="INVITE" spanEvents="no" requiredModule="Invitations" previewImage="invitations.png"/>
<level3 description="Campaigns" URL="../../backend/home/emailCampaigns.csp" accessID="MAILCAMP" spanEvents="no" requiredModule="Email Campaigns" previewImage="campaigns.png"/>
<level3 description="Meeting Manager" URL="../../backend/home/meetManEmailSettings.csp" accessID="MEETEMAIL" spanEvents="no" requiredModule="Meeting Manager" previewImage="meeting manager (emails).png"/>
</level2>
<level2 description="Lists of People" URL="../../backend/home/codLists.csp?clearPage=1"  accessID="PEOPLIST" spanEvents="no" requiredModule="Lists of People"  previewImage="lists of people.png"/>
<level2 description="Surveys" URL="../../backend/home/surveyList.csp" accessID="SURV" spanEvents="yes" requiredModule="Surveys" previewImage="surveys.png"/>
</level1>

<level1 description="Registrations" URL="" hoverText="Manage event registrations" accessID="BOOKADM" spanEvents="no" requiredModule=""  menuPosition="right">
<level2 description="Edit Registrations" URL="../../backend/home/delegateSearchGoToSimple.csp"  accessID="VIEWBOOK" spanEvents="no" requiredModule="View &amp; edit bookings" previewImage="edit bookings.png"/>
<level2 description="Registrations" URL="../../backend/home/registrations.csp"  accessID="REGISTRATIONLIST"  spanEvents="no"/>
<level2 description="Attendance Recording" URL="../../backend/home/attendanceRecording.csp" accessID="ATTREC" spanEvents="no" requiredModule="Attendance recording" previewImage="attendance recording.png"/>
<level2 description="Bulk Edit" URL="../../backend/home/eventBooking2.csp?butBulkEdit_=1"  accessID="BULK" spanEvents="no" requiredModule="Bulk Edit" previewImage="bulk edit.png"/>

</level1>
<level1 description="Search &amp; Reports" URL="" accessID="REPORTS" spanEvents="no" requiredModule=""  menuPosition="right" isPublic="1">
<level2 description="Quick Search" URL="../../backend/home/delegateSearchSimple.csp?showEditButton=1" accessID="QUICKREP" spanEvents="no" requiredModule="Quick Search" previewImage="quick search.png"/>
<level2 description="Search" URL="../../backend/home/gotoOnlineReports.csp?reportType=default"  accessID="ADVSEARCH" spanEvents="yes" requiredModule="Standard Search" previewImage="search.png"/>
<level2 description="Reports" URL="../../backend/home/reportList.csp"  accessID="REPS" spanEvents="yes" requiredModule="Dynamic Reporting Runtime" previewImage="reports.png"/>
<level2 description="People De-Duplication" URL="../../backend/home/codPersonDeDupeSelectFields.csp?load=1"      accessID="SYSDEDUPE" spanEvents="yes" requiredModule="Person De-Duplication" previewImage="people de-duplication.png"/>
</level1>
</backendMenu>
]]></Data>
</XData>
</Class>


<Class name="setup.bookingLevelCounterFrontendSession">
<Super>setup.bookingLevelCounterFrontend</Super>
<TimeChanged>64236,54059.786335</TimeChanged>
<TimeCreated>64120,58159.969979</TimeCreated>

<Property name="bookingLevelCounter">
<Type>bookingLevelCounterSession</Type>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventSession:setup.eventSession=""</FormalSpec>
<ReturnType>setup.bookingLevelCounterFrontendSession</ReturnType>
<Implementation><![CDATA[
	set bookingLevel=##super(eventSession)

	return bookingLevel
]]></Implementation>
</Method>

<Method name="createBookingLevelCounter">
<FormalSpec>eventSession:setup.eventSession=""</FormalSpec>
<Implementation><![CDATA[	set ..bookingLevelCounter=##class(bookingLevelCounterSession).createNew(eventSession)
]]></Implementation>
</Method>

<Method name="getCountOfTemporaryForCurrentBookingFromStorage">
<Private>1</Private>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set count=0
	set delegateBasketItemID = ..bookingLevelCounter.delegateBasketItemID
	set guestBasketItemID = ..bookingLevelCounter.delegateBasketItemID
	set tempPurchaseID=..currentTempPurchaseID
	&SQL(SELECT COUNT(*) INTO :tmp FROM eCom.tempBasketItem 
 		WHERE (basketItemID = :delegateBasketItemID OR basketItemID = :guestBasketItemID)
 		AND (isCancelled = 0)
 		AND (tempPerson->active=1) 
 		AND (tempPerson->tempPurchase = :tempPurchaseID)
	)
	if +SQLCODE=0 {
		set count=tmp
	} elseif +SQLCODE'=100 {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE)
	}
	return count
]]></Implementation>
</Method>

<Method name="getCountOfTemporaryForCurrentPersonFromStorage">
<Private>1</Private>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set count=0
	set delegateBasketItemID = ..bookingLevelCounter.delegateBasketItemID
	set guestBasketItemID = ..bookingLevelCounter.delegateBasketItemID
	set currentTempPersonID=..currentTempPersonID
	&SQL(SELECT COUNT(*) INTO :tmp FROM eCom.tempBasketItem 
 		WHERE (basketItemID = :delegateBasketItemID OR basketItemID = :guestBasketItemID)
 		AND (isCancelled = 0)
 		AND (tempPerson = :currentTempPersonID)
	)
	if +SQLCODE=0 {
		set count=tmp
	} elseif +SQLCODE'=100 {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE)
	}
	
	return count
]]></Implementation>
</Method>
</Class>


<Class name="setup.eventCreationMethods">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: setup.eventCreationMethods.CLS/EV.116
;vc; Component: CLS.setup.eventCreationMethods
;vc;  Location: LargeDev
;vc; Date/Time: 25-Jan-17 10:53
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>setup.eventCreationMethods.CLS/EV.116</td><td>CLS.setup.eventCreationMethods</td><td>LargeDev</td><td style='white-space: nowrap;'>25-Jan-17 10:53</td><td>FredG</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<ClassType/>
<IncludeCode>EF.common.macros</IncludeCode>
<ProcedureBlock>1</ProcedureBlock>
<Super>%Persistent</Super>
<TimeChanged>64308,49963.173076</TimeChanged>
<TimeCreated>61908,40601.453382</TimeCreated>

<Method name="createEventPages">
<Description>
create the proweb structure for a new event - groups and pages
this is a seperate method so that the copyEvent can use the same code
Returns 1 if OK otherwise it'll be an error</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%String,newLangID:%String=""</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if 'eventID quit 0
	
	// v 2.9 - no language passed in means that it is creating the root language as opposed to a adding a new language to an existing event
	set eventLanguage=##class(setup.objEventSetting).getParameter("system","language",eventID)
	set langID=##class(shared.objLanguage).getLanguageID(eventLanguage)
	set eventDesc=##class(setup.objEventDetails).getDetails(eventID,langID)
	
	if newLangID {
		set langID=newLangID	
	}
	
	set detailsID=##class(setup.objEventDetails).getDetailsID(eventID,langID)
	set objEventDetails=##class(setup.objEventDetails).%OpenId(detailsID)
	if newLangID="" { // don't create groups if adding lingo - v2.9
		// find root level
		set rootID=""
		&SQL(SELECT ID INTO :tmp FROM sc_xModules.objGroup WHERE (parent IS NULL AND active=1))
		if +SQLCODE=0 set rootID=tmp
	
		if rootID="" {
			// create new root if we don't have one
			set rootID=##class(setup.objEventDetails).addNewGroup("eventsForce Event Pages",eventID)
		}
	
		// create a new top group for the event
		set eventGroupID=##class(setup.objEventDetails).addNewGroup(eventDesc,rootID,eventID)
		if $D(%objlasterror),'%objlasterror quit %objlasterror   // **** ERROR ****
	
		// this is a special case - the presenters span events so the group must be at the same level as the eventgroup
		//  - only need to create once for the namespace
		set presentersGroupID=##class(sc.xModules.objGroup).findGroupID("Presenter Pages",rootID)
		if 'presentersGroupID set presentersGroupID=##class(setup.objEventDetails).addNewGroup("Presenter Pages",rootID,eventID)
	
		//add sub groups for this event
		set homePagesGroupID=##class(setup.objEventDetails).addNewGroup("Home Pages",eventGroupID,eventID)
		set menuPagesGroupID=##class(setup.objEventDetails).addNewGroup("Menu Pages",eventGroupID,eventID)
		set footerPagesGroupID=##class(setup.objEventDetails).addNewGroup("Footer Pages",eventGroupID,eventID)
		set itemsGroupID=##class(setup.objEventDetails).addNewGroup("Item Pages",eventGroupID,eventID)
		set tAndCGroupID=##class(setup.objEventDetails).addNewGroup("Terms and Conditions Pages",eventGroupID,eventID)
		set venuesGroupID=##class(setup.objEventDetails).addNewGroup("Venue Pages",eventGroupID,eventID)
		set locationsGroupID=##class(setup.objEventDetails).addNewGroup("Location Pages",eventGroupID,eventID)
		set cancellationsGroupID=##class(setup.objEventDetails).addNewGroup("Cancellation Pages",eventGroupID,eventID)
		set moreGroupID=##class(setup.objEventDetails).addNewGroup("More Pages",eventGroupID,eventID)
		set registrationPagesGroupID=##class(setup.objEventDetails).addNewGroup("Registration Pages",eventGroupID,eventID)
		set thankYouPagesGroupID=##class(setup.objEventDetails).addNewGroup("Thank You Pages",eventGroupID,eventID)
		set bannerPagesGroupID=##class(setup.objEventDetails).addNewGroup("Banner Pages",eventGroupID,eventID)
		set secondaryBannerPagesGroupID=##class(setup.objEventDetails).addNewGroup("Secondary Banner Pages",eventGroupID,eventID)
		set paymentMethodPagesGroupID=##class(setup.objEventDetails).addNewGroup("Payment Method Instructions",eventGroupID,eventID)
		do ##class(setup.objEventDetails).addNewGroup("Additional Registration Pages",eventGroupID,eventID)
		set abstractGroupID=##class(setup.objEventDetails).addNewGroup("Abstract Management",eventGroupID,eventID)
		set moreGroupID=##class(setup.objEventDetails).addNewGroup("More Abstract Pages",eventGroupID,eventID)
		set groupBookingsGroupID=##class(setup.objEventDetails).addNewGroup("Group Booking Pages",eventGroupID,eventID)
		set awardsGroupID=##class(setup.objEventDetails).addNewGroup("Award Pages",eventGroupID,eventID)
		set hotelGroupID=##class(setup.objEventDetails).addNewGroup("Hotel Booking Pages",eventGroupID,eventID)
		set tableGroupID=##class(setup.objEventDetails).addNewGroup("Table Booking Pages",eventGroupID,eventID)
		set chooseDaysGroupID=##class(setup.objEventDetails).addNewGroup("Choose Days Pages",eventGroupID,eventID)
		set chooseSessionsGroupID=##class(setup.objEventDetails).addNewGroup("Choose Sessions Pages",eventGroupID,eventID)
		set registerEmailAmendGroupID=##class(setup.objEventDetails).addNewGroup("Register Email Amend Pages",eventGroupID,eventID)
		set registerEmailNewGroupID=##class(setup.objEventDetails).addNewGroup("Register Email New Pages",eventGroupID,eventID)
		set basketGroupID=##class(setup.objEventDetails).addNewGroup("Basket Pages",eventGroupID,eventID)
		set accomChooseDatesGroupID=##class(setup.objEventDetails).addNewGroup("Accom Choose Dates Pages",eventGroupID,eventID)
		set accomHotelListGroupID=##class(setup.objEventDetails).addNewGroup("Accom Hotel List Pages",eventGroupID,eventID)
		set accomGuestGroupID=##class(setup.objEventDetails).addNewGroup("Accom Guest Pages",eventGroupID,eventID)
		set accomEditGroupID=##class(setup.objEventDetails).addNewGroup("Accom Edit Pages",eventGroupID,eventID)
		set dailyAgendaGridviewGroupID=##class(setup.objEventDetails).addNewGroup("Daily Agenda Gridview Pages",eventGroupID,eventID)
		set dailyAgendaListviewGroupID=##class(setup.objEventDetails).addNewGroup("Daily Agenda Listview Pages",eventGroupID,eventID)
		set meetManGroupID=##class(setup.objEventDetails).addNewGroup("Meeting Manager Pages",eventGroupID,eventID)
		set sendEmailGroupID=##class(setup.objEventDetails).addNewGroup("Send Email Pages",eventGroupID,eventID)
		set declineGroupID=##class(setup.objEventDetails).addNewGroup("Decline Pages",eventGroupID,eventID)
		set bookingSummaryGroupID=##class(setup.objEventDetails).addNewGroup("Booking Summary Pages",eventGroupID,eventID)
		set eventLoginPagesGroupID=##class(setup.objEventDetails).addNewGroup("Event Login Pages",eventGroupID,eventID)
		set externalEventLoginPagesGroupID=##class(setup.objEventDetails).addNewGroup("External Event Login Pages",eventGroupID,eventID)
		set requestPasswordGroupID=##class(setup.objEventDetails).addNewGroup("Request Password Pages",eventGroupID,eventID)
		set resetPasswordGroupID = ##class(setup.objEventDetails).addNewGroup("Reset Password Pages", eventGroupID, eventID)
		set agendaWebsiteGroupID=##class(setup.objEventDetails).addNewGroup("Agenda View Website Pages",eventGroupID,eventID)
		set agendaRegistrationGroupID=##class(setup.objEventDetails).addNewGroup("Agenda View Registration Pages", eventGroupID, eventID)
	
		if $D(%objlasterror),'%objlasterror quit %objlasterror   // **** ERROR ****
		
	} else {
		
		// pick up the existing groups if adding a lingo	
		set eventGroupID=##class(sc.methods).getEventGroupID(eventID)
		&SQL(SELECT ID INTO :homePagesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Home Pages'))
		if +SQLCODE'=0 w 1/0 // ## error creating new language pages - no group found
		&SQL(SELECT ID INTO :menuPagesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Menu Pages'))
		&SQL(SELECT ID INTO :footerPagesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Footer Pages'))
		&SQL(SELECT ID INTO :itemsGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Item Pages'))
		&SQL(SELECT ID INTO :tAndCGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Terms and Conditions Pages'))
		&SQL(SELECT ID INTO :venuesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Venue Pages'))
		&SQL(SELECT ID INTO :locationsGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Location Pages'))
		&SQL(SELECT ID INTO :cancellationsGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Cancellation Pages'))
		&SQL(SELECT ID INTO :moreGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'More Pages'))
		&SQL(SELECT ID INTO :registrationPagesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Registration Pages'))
		&SQL(SELECT ID INTO :thankYouPagesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Thank You Pages'))
		&SQL(SELECT ID INTO :bannerPagesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Banner Pages'))
		&SQL(SELECT ID INTO :secondaryBannerPagesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Secondary Banner Pages'))
		&SQL(SELECT ID INTO :paymentMethodPagesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Payment Method Instructions'))
		&SQL(SELECT ID INTO :abstractGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Abstract Management'))
		&SQL(SELECT ID INTO :groupBookingsGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Group Booking Pages'))
		&SQL(SELECT ID INTO :awardsGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Award Pages'))
		&SQL(SELECT ID INTO :hotelGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Hotel Booking Pages'))
		&SQL(SELECT ID INTO :tableGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Table Booking Pages'))
		&SQL(SELECT ID INTO :chooseDaysGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Choose Days Pages'))
		&SQL(SELECT ID INTO :chooseSessionsGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Choose Sessions Pages'))
		&SQL(SELECT ID INTO :registerEmailAmendGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Register Email Amend Pages'))
		&SQL(SELECT ID INTO :registerEmailNewGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Register Email New Pages'))
		&SQL(SELECT ID INTO :basketGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Basket Pages'))
		&SQL(SELECT ID INTO :accomChooseDatesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Accom Choose Dates Pages'))
		&SQL(SELECT ID INTO :accomHotelListGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Accom Hotel List Pages'))
		&SQL(SELECT ID INTO :accomGuestGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Accom Guest Pages'))
		&SQL(SELECT ID INTO :accomEditGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Accom Edit Pages'))
		&SQL(SELECT ID INTO :dailyAgendaGridviewGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Daily Agenda Gridview Pages'))
		&SQL(SELECT ID INTO :dailyAgendaListviewGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Daily Agenda Listview Pages'))
		&SQL(SELECT ID INTO :meetManGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Meeting Manager Pages'))
		&SQL(SELECT ID INTO :sendEmailGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Send Email Pages'))
		&SQL(SELECT ID INTO :declineGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Decline Pages'))
		&SQL(SELECT ID INTO :bookingSummaryGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Booking Summary Pages'))
		&SQL(SELECT ID INTO :eventLoginPagesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Event Login Pages'))
		&SQL(SELECT ID INTO :externalEventLoginPagesGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'External Event Login Pages'))
		&SQL(SELECT ID INTO :requestPasswordGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Request Password Pages'))
		&SQL(SELECT ID INTO :resetPasswordGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active = 1) AND (description = 'Reset Password Pages'))
		set agendaRegistrationGroupID = ##class(sc.xModules.objGroup).findGroupID("Agenda View Registration Pages",eventGroupID)
		set agendaWebsiteGroupID = ##class(sc.xModules.objGroup).findGroupID("Agenda View Website Pages",eventGroupID)
	}
	
	set desciptionModifier=""
	if newLangID set desciptionModifier=" - "_##class(shared.objLanguage).getLanguageDesc(newLangID)
	
	//create new proweb pages for home, menu, tandc, and cancellation
	set objEventDetails.homePageID=##class(setup.objEventDetails).addNewPage("homepages","home page"_desciptionModifier,homePagesGroupID,eventID,langID)
	set objEventDetails.menuPageID=##class(setup.objEventDetails).addNewPage("menupages","menu page"_desciptionModifier,menuPagesGroupID,eventID,langID)
	do ..addDefaultMenuItems(objEventDetails.menuPageID, langID)
	set footerPageID=##class(setup.objEventDetails).addNewPage("footerpages","footer page"_desciptionModifier,footerPagesGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("mainpages","footerPageID"_desciptionModifier,footerPageID,eventID)
	set objEventDetails.tAndCPageID=##class(setup.objEventDetails).addNewPage("tandcpages","T&C page"_desciptionModifier,tAndCGroupID,eventID,langID)
	set objEventDetails.venuePageID=##class(setup.objEventDetails).addNewPage("venuepages","venue page"_desciptionModifier,venuesGroupID,eventID,langID)
	set objEventDetails.bannerPageID=##class(setup.objEventDetails).addNewPage("bannerpages","banner page"_desciptionModifier,bannerPagesGroupID,eventID,langID)
	set secondaryBannerPageID=##class(setup.objEventDetails).addNewPage("secondarybannerpages","secondary banner page"_desciptionModifier,secondaryBannerPagesGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("mainpages","secondary banner pageID"_desciptionModifier,secondaryBannerPageID,eventID)
	set rightPageID=##class(setup.objEventDetails).addNewPage("blank pages","right page"_desciptionModifier,homePagesGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("mainpages","rightPageID"_desciptionModifier,rightPageID,eventID)
	set objEventDetails.cancellationPageID=##class(setup.objEventDetails).addNewPage("cancellationpages","cancellation page"_desciptionModifier,cancellationsGroupID,eventID,langID)
	set objEventDetails.thankYouPageID=##class(setup.objEventDetails).addNewPage("Thank You Pages","Thank You Page"_desciptionModifier,thankYouPagesGroupID,eventID,langID)
	
	set regPageID=""
	if 'newLangID	{  // only when event is created from scratch
		// create the delegate reg page
		set regPageID=##class(setup.objEventDetails).addNewPage("Registration Page","Registration Page"_desciptionModifier,registrationPagesGroupID,eventID,langID)
		set objEventDetails.registrationPageID=regPageID
		set eventCategoryID=##class(setup.objEventCategory).getDefaultCategoryID()
		set eventCategoryDesc=##class(setup.objEventCategory).getDescription(eventCategoryID)
		set lnkCategoryEventID=##class(setup.lnkCategoryEvent).add(eventID,eventCategoryDesc,regPageID,0,"",langID)
		do ##class(setup.lnkAttendeeCategoryDetailsEvent).activate(eventID,eventCategoryID)
		do ##class(setup.lnkAttendeeCategoryDetailsEvent).setDefault(eventID,eventCategoryID)
	}
	// deal with multi reg pages
	if newLangID { // when adding a new language
		// when adding pages to a new language
		// loop on all activate attendee types and create a page for each
		set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
		// v3.0.0 - go through all the active English reg pages and copy to new langauge
		do rs.Prepare("SELECT *,objEventCategory->description As catDesc FROM setup.lnkCategoryEvent WHERE (objEvent=?) AND (langID=1) AND (active=1)")
		do rs.Execute(eventID)
		while rs.Next() {
			// copy the page? not yet - issues with ABI's
			set oldPageID=rs.Data("pageID")
			set newPageID=""
			set newDesc=rs.Data("description")
			set tmpCategoryID=rs.Data("objEventCategory")
			// If it is the default convert to the new language
			if newDesc=rs.Data("catDesc")_" details" {
				set newDesc=##class(setup.objEventCategory).getDescription(tmpCategoryID,newLangID)
			}
			set lnkCategoryEventID=##class(setup.lnkCategoryEvent).add(eventID,rs.Data("catDesc"),newPageID,rs.Data("backendOnly"),"",langID,newDesc)
		}
	}
	
	if newLangID {	
		// when adding pages to a new language
		&SQL(SELECT ID INTO :eventCategoryGroupID FROM sc_xModules.objGroup WHERE (parent = :eventGroupID) AND (active=1) AND (description = 'Category Selection Pages'))	
	} else {
		// when creating a new event
		set eventCategoryGroupID=##class(setup.objEventDetails).addNewGroup("Category Selection Pages",eventGroupID,eventID)
	}
	
	
	// create the person category selection page - v2.7
	set eventCategoryPageID=##class(setup.objEventDetails).addNewPage("Category Selection Pages","Category Selection Page"_desciptionModifier,eventCategoryGroupID,eventID,langID)
	// and store - v2.7
	do ##class(setup.objEventSetting).setParameter("bookings","SelectPersonCategoryPageID"_desciptionModifier,eventCategoryPageID,eventID)
	// new pages for group bookings
	set selectBookingModePageID=##class(setup.objEventDetails).addNewPage("Select Booking Mode Pages","selectBookingMode"_desciptionModifier,groupBookingsGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("bookings","selectBookingModePageID"_desciptionModifier,selectBookingModePageID,eventID)
	set delegateUIDPageID=##class(setup.objEventDetails).addNewPage("Delegate UID Pages","DelegateUID"_desciptionModifier,groupBookingsGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("bookings","delegateUIDPageID"_desciptionModifier,delegateUIDPageID,eventID)
	set bookerPageID=##class(setup.objEventDetails).addNewPage("Booker Pages","Booker Page"_desciptionModifier,groupBookingsGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("bookings","bookerRegPageID"_desciptionModifier,bookerPageID,eventID)
	// table booking pages
	set tableBookingPageID=##class(setup.objEventDetails).addNewPage("Table Booking Pages","Table Guests Page"_desciptionModifier,tableGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("bookings","Table Guests PageID"_desciptionModifier,tableBookingPageID,eventID)
	// Choose Days pages
	set chooseDaysPageID=##class(setup.objEventDetails).addNewPage("Choose Days Pages","Choose Days Pages"_desciptionModifier,chooseDaysGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("bookings","Choose Days PageID"_desciptionModifier,chooseDaysPageID,eventID)
	
	// Choose Sessions pages
	set chooseSessionsPageID=##class(setup.objEventDetails).addNewPage("Choose Sessions Pages","Choose Sessions Pages"_desciptionModifier,chooseSessionsGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("bookings","Choose Sessions PageID"_desciptionModifier,chooseSessionsPageID,eventID)
	
	// Register Email Amend pages
	set registerEmailAmendPageID=##class(setup.objEventDetails).addNewPage("Register Email Amend Pages","Register Email Amend Pages"_desciptionModifier,registerEmailAmendGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("bookings","Register Email Amend PageID"_desciptionModifier,registerEmailAmendPageID,eventID)
	
	// Register Email New pages
	set registerEmailNewPageID=##class(setup.objEventDetails).addNewPage("Register Email New Pages","Register Email New Pages"_desciptionModifier,registerEmailNewGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("bookings","Register Email New PageID"_desciptionModifier,registerEmailNewPageID,eventID)
	
	// Request Password pages
	set requestPasswordPageID=##class(setup.objEventDetails).addNewPage("Request Password Pages","Request Password Pages"_desciptionModifier,requestPasswordGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("bookings","Request Password PageID"_desciptionModifier,requestPasswordPageID,eventID)
	
	// Reset Password pages
	set resetPasswordPageID = ##class(setup.objEventDetails).addNewPage("Reset Password Pages", "Reset Password Pages"_desciptionModifier, resetPasswordGroupID, eventID, langID)
	do ##class(setup.objEventSetting).setParameter("bookings", "Reset Password PageID"_desciptionModifier, resetPasswordPageID, eventID)
	
	// Basket New pages
	set basketPageID=##class(setup.objEventDetails).addNewPage("Basket Pages","Basket Pages"_desciptionModifier,basketGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("bookings","Basket PageID"_desciptionModifier,basketPageID,eventID)
	
	//Daily Agenda pages
	set pageID=##class(setup.objEventDetails).addNewPage("Agenda View Website Pages","Agenda View Website Page"_desciptionModifier,agendaRegistrationGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("Agenda","Agenda View Website PageID"_desciptionModifier,pageID,eventID)
	set pageID=##class(setup.objEventDetails).addNewPage("Agenda View Registration Pages","Agenda View Registration Page"_desciptionModifier,agendaRegistrationGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("Agenda","Agenda View Registration PageID"_desciptionModifier,pageID,eventID)		
	
	set dailyAgendaGridviewPageID=##class(setup.objEventDetails).addNewPage("Daily Agenda Gridview Pages","Daily Agenda Gridview Pages"_desciptionModifier,dailyAgendaGridviewGroupID,eventID,langID)
	set dailyAgendaListviewPageID=##class(setup.objEventDetails).addNewPage("Daily Agenda Listview Pages","Daily Agenda Listview Pages"_desciptionModifier,dailyAgendaListviewGroupID,eventID,langID)
	
	
	
	
	// create abstract pages
	set documentPageID=##class(setup.objEventDetails).addNewPage("Abstract Document Pages","Abstract Submission Details"_desciptionModifier,abstractGroupID,eventID,langID)
	set documentTextPageID=##class(setup.objEventDetails).addNewPage("Abstract Document Text Pages","Abstract Submission Content"_desciptionModifier,abstractGroupID,eventID,langID)
	set documentPreviewPageID=##class(setup.objEventDetails).addNewPage("Abstract Document Preview Pages","Abstract Submission Preview"_desciptionModifier,abstractGroupID,eventID,langID)
	set topicListPageID=##class(setup.objEventDetails).addNewPage("Abstract Topic List","Abstract Submission Topics"_desciptionModifier,abstractGroupID,eventID,langID)
	set thankYouPageID=##class(setup.objEventDetails).addNewPage("More Pages","More Pages"_desciptionModifier,abstractGroupID,eventID,langID)
	set signUpPageID=##class(setup.objEventDetails).addNewPage("Abstracts Sign Up Pages","Abstract Submitter Details"_desciptionModifier,abstractGroupID,eventID,langID)
	set reviewListPageID=##class(setup.objEventDetails).addNewPage("Abstracts Review List","Abstract Reviews"_desciptionModifier,abstractGroupID,eventID,langID)
	set absSearchDocPageID=##class(setup.objEventDetails).addNewPage("Abstract Search Document Pages","Abstracts Search"_desciptionModifier,abstractGroupID,eventID,langID)
	set absSearchDocResultsPageID=##class(setup.objEventDetails).addNewPage("Abstract Search Document Results Pages","Abstracts Search Results"_desciptionModifier,abstractGroupID,eventID,langID)
	set abstractSubmitterLoginPageID=##class(setup.objEventDetails).addNewPage("Abstract Submitter Login Pages","Abstract Submission Login"_desciptionModifier,abstractGroupID,eventID,langID)
	set abstractReviewerLoginPageID=##class(setup.objEventDetails).addNewPage("Abstract Reviewer Login Pages","Abstract Reviewer Login"_desciptionModifier,abstractGroupID,eventID,langID)
	//store their IDs in objEventSettings  
	do ##class(setup.objEventSetting).setParameter("abstract management pages","documentPageID"_desciptionModifier,documentPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("abstract management pages","documentTextPageID"_desciptionModifier,documentTextPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("abstract management pages","documentPreviewPageID"_desciptionModifier,documentPreviewPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("abstract management pages","topicListPageID"_desciptionModifier,topicListPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("abstract management pages","thankYouPageID"_desciptionModifier,thankYouPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("abstract management pages","signUpPageID"_desciptionModifier,signUpPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("abstract management pages","reviewListPageID"_desciptionModifier,reviewListPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("abstract management pages","abstractSearchDocumentPageID"_desciptionModifier,absSearchDocPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("abstract management pages","abstractSearchDocumentResultsPageID"_desciptionModifier,absSearchDocResultsPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("abstract management pages","abstractSubmitterLoginPageID"_desciptionModifier,abstractSubmitterLoginPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("abstract management pages","abstractReviewerLoginPageID"_desciptionModifier,abstractReviewerLoginPageID,eventID)
	
	// create awards pages
	set awardClientPageID=##class(setup.objEventDetails).addNewPage("Award Client Pages","Award Client Page"_desciptionModifier,awardsGroupID,eventID,langID)
	set awardEntryPageID=##class(setup.objEventDetails).addNewPage("Award Entry Pages","Award Entry Page"_desciptionModifier,awardsGroupID,eventID,langID)
	set catInterestPageID=##class(setup.objEventDetails).addNewPage("Awards Category Interest Pages","Awards Category Interest Page"_desciptionModifier,awardsGroupID,eventID,langID)
	set summaryPageID=##class(setup.objEventDetails).addNewPage("Awards Summary Pages","Awards Summary Page"_desciptionModifier,awardsGroupID,eventID,langID)
	set judgeLoginPageID=##class(setup.objEventDetails).addNewPage("Awards Judge Login Pages","Awards Judge Login Page"_desciptionModifier,awardsGroupID,eventID,langID)
	set judgeEntryListPageID=##class(setup.objEventDetails).addNewPage("Awards Judge Entry List Pages","Awards Judge Entry List Page"_desciptionModifier,awardsGroupID,eventID,langID)
	set reviewEntryPageID=##class(setup.objEventDetails).addNewPage("Awards Review Entry Pages","Awards Review Entry Page"_desciptionModifier,awardsGroupID,eventID,langID)
	set judgeScoreListPageID=##class(setup.objEventDetails).addNewPage("Awards Judge Score List Pages","Awards Judge Score List Page"_desciptionModifier,awardsGroupID,eventID,langID)
	
	do ##class(setup.objEventSetting).setParameter("awards","awardClientPageID"_desciptionModifier,awardClientPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("awards","awardEntryPageID"_desciptionModifier,awardEntryPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("awards","categoryInterestPageID"_desciptionModifier,catInterestPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("awards","summaryPageID",summaryPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("awards","judgeLoginPageID"_desciptionModifier,judgeLoginPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("awards","judgeEntryListPageID"_desciptionModifier,judgeEntryListPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("awards","reviewEntryPageID"_desciptionModifier,reviewEntryPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("awards","judgeScoreListPageID"_desciptionModifier,judgeScoreListPageID,eventID)
	
	do ##class(setup.objEventSetting).setParameter("Daily Agenda","dailyAgendaGridviewPageID"_desciptionModifier,dailyAgendaGridviewPageID,eventID)
	do ##class(setup.objEventSetting).setParameter("Daily Agenda","dailyAgendaListviewPageID"_desciptionModifier,dailyAgendaListviewPageID,eventID)
	// Meeting Manager pages
	set meetManDiaryPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Diary Pages","Meeting Manager Diary Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Diary Manager PageID"_desciptionModifier,meetManDiaryPageID,eventID)
	set meetManAvailabilityPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Availability Pages","Meeting Manager Availability Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Meeting Availability PageID"_desciptionModifier,meetManAvailabilityPageID,eventID)
	set meetManDetailsPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Meeting Details Pages","Meeting Manager Meeting Details Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Meeting Details PageID"_desciptionModifier,meetManDetailsPageID,eventID)
	set meetManDetailsPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Email Pages","Meeting Manager Email Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Meeting Email PageID"_desciptionModifier,meetManDetailsPageID,eventID)
	set meetManAttendeeSearchPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Attendee Search Pages","Meeting Manager Attendee Search Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Attendee Search PageID"_desciptionModifier,meetManAttendeeSearchPageID,eventID)
	set meetManDemographicSearchPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Demographic Search Pages","Meeting Manager Demographic Search Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Demographic Search PageID"_desciptionModifier,meetManDemographicSearchPageID,eventID)
	set meetManCompanySearchPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Company Search Pages","Meeting Manager Company Search Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Company Search PageID"_desciptionModifier,meetManCompanySearchPageID,eventID)
	set meetManInvConfirmPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Invitation Confirm Pages","Meeting Manager Invitation Confirm Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Invitation Confirm PageID"_desciptionModifier,meetManInvConfirmPageID,eventID)
	set meetManAcceptMeetingPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Accept Meeting Pages","Meeting Manager Accept Meeting Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Accept Meeting PageID"_desciptionModifier,meetManAcceptMeetingPageID,eventID)
	set meetManAcceptConfirmPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Accept Meeting Confirm Pages","Meeting Manager Accept Meeting Confirm Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Accept Meeting Confirm PageID"_desciptionModifier,meetManAcceptConfirmPageID,eventID)
	set meetManDeclineMeetingPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Decline Meeting Pages","Meeting Manager Decline Meeting Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Decline Meeting PageID"_desciptionModifier,meetManDeclineMeetingPageID,eventID)
	set meetManDeclineConfirmPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Decline Meeting Confirm Pages","Meeting Manager Decline Meeting Confirm Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Decline Meeting Confirm PageID"_desciptionModifier,meetManDeclineConfirmPageID,eventID)
	set meetManCancelMeetingPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Cancel Meeting Pages","Meeting Manager Cancel Meeting Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Cancel Meeting PageID"_desciptionModifier,meetManCancelMeetingPageID,eventID)
	set meetManCancelConfirmPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Cancel Meeting Confirm Pages","Meeting Manager Cancel Meeting Confirm Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Cancel Meeting Confirm PageID"_desciptionModifier,meetManCancelConfirmPageID,eventID)
	set meetManNewTimePageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Propose New Time Pages","Meeting Manager Propose New Time Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Propose New Time PageID"_desciptionModifier,meetManNewTimePageID,eventID)
	set meetManNewTimeDetPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Propose New Time Details Pages","Meeting Manager Propose New Time Details Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Propose New Time Details PageID"_desciptionModifier,meetManNewTimeDetPageID,eventID)
	set meetManNewTimeConfirmPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Propose New Time Confirm Pages","Meeting Manager Propose New Time Confirm Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Propose New Time Confirm PageID"_desciptionModifier,meetManNewTimeConfirmPageID,eventID)
	set meetManCommsPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Communications Pages","Meeting Manager Communications Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Communications PageID"_desciptionModifier,meetManCommsPageID,eventID)
	set meetManLoginPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Login Pages","Meeting Manager Login Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Login PageID"_desciptionModifier,meetManLoginPageID,eventID)
	set meetManChangeLocationPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Change Location Pages","Meeting Manager Change Location Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Change Location PageID"_desciptionModifier,meetManChangeLocationPageID,eventID)
	set meetManAttInfoPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Attendee Information Pages","Meeting Manager Attendee Information Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Attendee Information PageID"_desciptionModifier,meetManAttInfoPageID,eventID)
	set meetSchedulePageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Schedule Pages","Meeting Manager Schedule Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Schedule PageID"_desciptionModifier,meetSchedulePageID,eventID)
	set createOpenPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Create Open Meeting Pages","Create Open Meeting Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Create Open Meeting PageID"_desciptionModifier,createOpenPageID,eventID)
	set bookOpenPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Book Open Meeting Pages","Book Open Meeting Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Book Open Meeting PageID"_desciptionModifier,bookOpenPageID,eventID)
	set openConfirmPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Open Meeting Confirm Pages","Open Meeting Confirm Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Open Meeting Confirm PageID"_desciptionModifier,openConfirmPageID,eventID)
	set createNewMeetingPageID=##class(setup.objEventDetails).addNewPage("Meeting Manager Create New Meeting Pages","Create New Meeting Page"_desciptionModifier,meetManGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("meeting manager pages","Create New Meeting PageID"_desciptionModifier,createNewMeetingPageID,eventID)
	
	// New accommodation pages
	set accomChooseDatesPageID=##class(setup.objEventDetails).addNewPage("Accom Choose Dates Pages","Accom Choose Dates Pages"_desciptionModifier,accomChooseDatesGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("accommodation pages","Accom Choose Dates PageID"_desciptionModifier,accomChooseDatesPageID,eventID)
	set accomHotelListPageID=##class(setup.objEventDetails).addNewPage("Accom Hotel List Pages","Accom Hotel List Pages"_desciptionModifier,accomHotelListGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("accommodation pages","Accom Hotel List PageID"_desciptionModifier,accomHotelListPageID,eventID)
	set accomGuestPageID=##class(setup.objEventDetails).addNewPage("Accom Guest Pages","Accom Guest Pages"_desciptionModifier,accomGuestGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("accommodation pages","Accom Guest PageID"_desciptionModifier,accomGuestPageID,eventID)
	set accomEditPageID=##class(setup.objEventDetails).addNewPage("Accom Edit Pages","Accom Edit Pages"_desciptionModifier,accomEditGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("accommodation pages","Accom Edit PageID"_desciptionModifier,accomEditPageID,eventID)
	
	//Email a friend Page
	set sendEmailPageID=##class(setup.objEventDetails).addNewPage("Send Email Pages","Send Email Pages"_desciptionModifier,sendEmailGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("Send Email","sendEmailPageID"_desciptionModifier,sendEmailPageID,eventID)
	
	//Decline Page
	set declinePageID=##class(setup.objEventDetails).addNewPage("Decline Pages","Decline Page"_desciptionModifier,declineGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("Decline Page","declinePageID"_desciptionModifier,declinePageID,eventID)
	
	//Booking Summary page
	set bookingSummaryPageID=##class(setup.objEventDetails).addNewPage("Booking Summary Pages","Booking Summary Page"_desciptionModifier,bookingSummaryGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("Booking Summary","bookingSummaryPageID"_desciptionModifier,bookingSummaryPageID,eventID)
	
	//Event Login Page
	set eventLoginPageID=##class(setup.objEventDetails).addNewPage("Event Login Pages","Event Login Page"_desciptionModifier,eventLoginPagesGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("website","eventLoginPageID"_desciptionModifier,eventLoginPageID,eventID)
	
	// AJM 18/1/2012 15186-5797 Add a new version of the event login page so that it is compatible with Eventsforce templates
	//External Event Login Page
	set externalEventLoginPageID=##class(setup.objEventDetails).addNewPage("External Event Login Pages","External Event Login Page"_desciptionModifier,externalEventLoginPagesGroupID,eventID,langID)
	do ##class(setup.objEventSetting).setParameter("website","externalEventLoginPageID"_desciptionModifier,externalEventLoginPageID,eventID)
	
	if $D(%objlasterror),'%objlasterror quit %objlasterror   // **** ERROR ****
	// Populate the registration page 
	// Must create a list object before we can add items
	if 'newLangID	{  // only for new event as other pages are created 
		for tempPageID=regPageID,bookerPageID,awardClientPageID {
			do ..addDefaultRegistrationPromptsToPage(tempPageID,"Main List","registration page")
		}
	}
	if $D(%objlasterror),'%objlasterror quit %objlasterror   // **** ERROR ****

	do ..addDefaultRegistrationPromptsToPage(signUpPageID,"Main List","abstract sign up page")
	kill %objlasterror
	
	if $D(%objlasterror),'%objlasterror quit %objlasterror   // **** ERROR ****
	
	if $D(%objlasterror),'%objlasterror quit %objlasterror   // **** ERROR ****
	set ok=objEventDetails.%Save()  // will not save objEvent and objController
	if 'ok quit ok  // **** ERROR ****
	
	quit 1
]]></Implementation>
</Method>

<Method name="activateNewLanguageForEvent">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%Integer,langID:%Integer</FormalSpec>
<Implementation><![CDATA[
	&SQL(SELECT ID FROM setup.objEventDetails WHERE (objEvent = :eventID) AND (objLanguage = :langID))
	if +SQLCODE=100 {
		// create the event details
		set objEventDetails=##class(setup.objEventDetails).%New()
		do objEventDetails.objLanguageSetObjectId(langID)
		do objEventDetails.objEventSetObjectId(eventID)
		set ok=objEventDetails.%Save()
		set eventDetailsID=objEventDetails.%Id()
		
		do ##class(mail.methods).createEmailContents(eventID,langID)

		// create the event web pages
		set ok=##class(setup.objEvent).createEventPages(eventID,langID)
	}
]]></Implementation>
</Method>

<Method name="setIsLanguageActiveForEvent">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%Integer,langID:%Integer,isLanguageOn:%Boolean</FormalSpec>
<Implementation><![CDATA[
	set langaugeDescription=##class(shared.objLanguage).getLanguageDesc(langID)
	do ##class(setup.objEventSetting).setParameter("frontend languages",langaugeDescription,isLanguageOn,eventID)
	if isLanguageOn {
		do ..activateNewLanguageForEvent(eventID,langID)	
	}
]]></Implementation>
</Method>

<Method name="canShowLanguageFlagBeSetForEvent">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<Implementation><![CDATA[
	set out=1
	set currentTheme=##class(layout.methods).getCurrentTheme(eventID)
	if ($ZCVT($P(currentTheme,"|",2),"L")["horizontal")!($ZCVT($P(currentTheme,"|",2),"L")="no menu, no sponsors, no logo") {
		set out=0
	}
	quit out
]]></Implementation>
</Method>

<Method name="addDefaultMenuItems">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID:%Integer,langID:%Integer</FormalSpec>
<Implementation><![CDATA[
	// first get the pageID to get the listID
	set xLangID = langID
	set xEventID = ##class(sc.objData).getEventID(pageID)
	
	set tmp="",listID=""
	&SQL(SELECT ID INTO :tmp FROM sc_xModules.objList WHERE (parent=:pageID) AND (active=1) )
	if +SQLCODE=0 set listID=tmp

	if listID = "" {
		set listID = ##class(sc.xModules.objList).add(pageID)
		set templateID = ##class(sc.pageMethods).getTemplateIDfromPageID(pageID)
		set componentID = ##class(sc.objComponent).add("INDEXLIST", templateID, listID)	
	}

	// now check if to see if any data items exist with the objList as their parent,
	// if not then this is first time in the page so auto create the defaults
	if listID	{
		set homePageID = ##class(setup.pageIDmethods).getEventHomePage(xEventID, langID)
		set URLbit="/"_$ZCVT(^%ZCSPAPPS($ZNSPACE),"L")   // JAW 03MAY2007 - so that it works for no framesets too - should always be absolute (without domain)
		
		// find the group name
		set groupName="",groupID=""
		&SQL(SELECT parent INTO :groupID FROM sc_xModules.objPage WHERE ID = :pageID)
		&SQL(SELECT description INTO :groupName FROM sc_xModules.objGroup WHERE ID = :groupID)
		
		if groupName="Menu Pages" {
			
			
			// get the current menu theme from the active template
			if ##class(layout.objTemplate).isUsingLegacyTemplate(xEventID) {
				set themeID=##class(layout.objTheme).getIDfromIntDesc("vertical graduated black/green menu")
			} else {
				set themeID=""	
			}
			
			// add new menu block
			set dataID=##class(sc.xModules.objMenuBlock).add(listID,0,"Auto Menu","","","","","",themeID,"")

			set ok=""
			// add the home page link
			set menuItemID=##class(layout.objMenuItem).add(dataID,"Home Page",URLbit_"/system/proweb/start.csp?pageID="_homePageID,"_self","","","","","")
			
			// add the Register link
			set menuItemID=##class(layout.objMenuItem).add(dataID,"Register",URLbit_"/frontEnd/reg/registerNew.csp","_self","","","","","")
			set menuItemID=##class(layout.objMenuItem).add(dataID,"Amend",URLbit_"/frontEnd/reg/registerAmend.csp","_self","","","","","")

			// add the Daily Agenda link
			set menuItemID=##class(layout.objMenuItem).add(dataID,"Agenda",URLbit_"/frontEnd/reg/dailyAgenda.csp","_self","","","","","")

		
		}
	}
]]></Implementation>
</Method>

<Method name="addDefaultRegistrationPromptsToPage">
<Description>
sets up the default questions for a brand new event on the registration pages (and booker's pages)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,listName,pageType</FormalSpec>
<Implementation><![CDATA[
	set listID=##class(sc.methods).getListIDfromPageIDlistName(pageID,listName)
	if 'listID {
		set listID=##class(sc.xModules.objList).add(pageID)
		&SQL(SELECT objTemplate INTO :templateID FROM sc_xModules.objPage WHERE (active=1 AND ID = :pageID))		
		do ##class(sc.objComponent).add(listName, templateID, listID, "listWithQuestionsRegistration")
	}

	if listID {
		set tmp="",create=0
		if (##class(sc.methods).anyQuestionsOnPage(pageID,listName)=0) {   // no data items exist with the listID as their parent
			if pageType="abstract sign up page" {
				do ..getDefaultQuestionsForAbstractSignUp(.questions)
			} elseif listName="Main Author List" {
				do ..getDefaultQuestionsForAbstractMainAuthor(.questions)
			} elseif listName="Co Author List" {
				do ..getDefaultQuestionsForAbstractCoAuthor(.questions)
			} elseif pageType="Awards Submitter" {
				do ..getDefaultQuestionsForAwardsSubmitter(.questions)
			} elseif pageType="Table Guests" {
				do ..getDefaultQuestionsForTableGuests(.questions)
			} elseif pageType="Room Guests" {
				do ..getDefaultQuestionsForRoomGuests(.questions)
				
			} elseif pageType="registration page" {
				do ..getDefaultQuestionsForRegistrationPages(.questions)
			}
			set key=0
			for  {
				set key=$O(questions(key))
				if key="" quit
				
				if $G(questions(key,"type"))="form divider" {
					do ##class(sc.xModules.objFormDivider).add(listID,"bottom")
							
				} else {
					set type=$G(questions(key,"type"))
					if type="" set type="text"
					set itemNameID=##class(cod.objItemName).getIDFromDescriptionNoEvent(questions(key,"codItemName"))
					set mandatory=+$G(questions(key,"isMandatory"))
					set width=$G(questions(key,"fieldWidthPx"))
					if 'width set width=$$$defaultTextFieldWidthPx
					set descr=questions(key,"label")
					set descr = ..getTranslatedQuestionLabel(pageID, descr)
			
					set ok=##class(sc.xModules.objCODitem).add(itemNameID,descr,listID,"system",0,"",type,mandatory,"horizontal",width,"",1,0,1)
				}
			}
		}
	}
	quit
]]></Implementation>
</Method>

<Method name="getTranslatedQuestionLabel">
<Description>
please note that this will translate the default reg question in old AND new version of proweb becuase the template has not been set yet.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID:%Integer,originalString:%String</FormalSpec>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set langID = ##class(sc.xModules.objPage).getLanguageIDFromPageID(pageID)
	return ##class(translations.objPhraseWebsite).translatePhrase(originalString, langID)
]]></Implementation>
</Method>

<Method name="getDefaultQuestionsForRegistrationPages">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&questions]]></FormalSpec>
<Implementation><![CDATA[
	set questions(1,"label")="First name"	
	set questions(1,"codItemName")="firstname"	
	set questions(1,"isMandatory")=1	
	
	set questions(2,"label")="Last name"	
	set questions(2,"codItemName")="lastname"	
	set questions(2,"isMandatory")=1	
	
	set questions(3,"type")="form divider"	

	set questions(4,"label")="Company"	
	set questions(4,"codItemName")="Company"	
	
	set questions(5,"label")="Address line 1"	
	set questions(5,"codItemName")="Address line 1"	
	
	set questions(6,"label")="Address line 2"	
	set questions(6,"codItemName")="Address line 2"	
	
	set questions(7,"label")="Town"	
	set questions(7,"codItemName")="Town"	
	
	set questions(8,"label")="Postcode"	
	set questions(8,"codItemName")="Postcode"	
	set questions(8,"fieldWidthPx")=$$$defaultPostcodeFieldWidthPx	
	
	
	set questions(9,"label")="Country"	
	set questions(9,"codItemName")="Country"	
	set questions(9,"type")="dropdown"	
	
	set questions(10,"label")="Phone number"	
	set questions(10,"codItemName")="Phone number"
	set questions(10,"type")="phoneNumber"
]]></Implementation>
</Method>

<Method name="getDefaultQuestionsForAbstractSignUp">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&questions]]></FormalSpec>
<Implementation><![CDATA[
	set questions(1,"label")="First name"	
	set questions(1,"codItemName")="firstname"	
	set questions(1,"isMandatory")=1	
	
	set questions(2,"label")="Last name"	
	set questions(2,"codItemName")="lastname"	
	set questions(2,"isMandatory")=1	
	
	set questions(3,"type")="form divider"	

	set questions(4,"label")="Email"
	set questions(4,"codItemName")="Email"	
	set questions(4,"isMandatory")=1	
	set questions(4,"type")="emailAddress"

	set questions(5,"label")="Company"	
	set questions(5,"codItemName")="Company"	
	
	set questions(6,"label")="Address line 1"	
	set questions(6,"codItemName")="Address line 1"	
	
	set questions(7,"label")="Address line 2"	
	set questions(7,"codItemName")="Address line 2"	
	
	set questions(8,"label")="Town"	
	set questions(8,"codItemName")="Town"	
	
	set questions(9,"label")="Postcode"	
	set questions(9,"codItemName")="Postcode"	
	set questions(9,"fieldWidthPx")=$$$defaultPostcodeFieldWidthPx	
	
	set questions(10,"label")="Phone number"	
	set questions(10,"codItemName")="Phone number"
	set questions(10,"type")="phoneNumber"
]]></Implementation>
</Method>

<Method name="getDefaultQuestionsForAbstractMainAuthor">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&questions]]></FormalSpec>
<Implementation><![CDATA[
	set questions(1,"label")="First name"	
	set questions(1,"codItemName")="firstname"	
	set questions(1,"isMandatory")=1	
	
	set questions(2,"label")="Last name"	
	set questions(2,"codItemName")="lastname"	
	set questions(2,"isMandatory")=1	

	set questions(3,"label")="Company"	
	set questions(3,"codItemName")="Company"	
	set questions(3,"isMandatory")=1

	set questions(4,"label")="Job Title"	
	set questions(4,"codItemName")="Job Title"	

	set questions(5,"label")="Email"
	set questions(5,"codItemName")="Email2"	
	set questions(5,"isMandatory")=1
	set questions(5,"type")="emailAddress"
]]></Implementation>
</Method>

<Method name="getDefaultQuestionsForAbstractCoAuthor">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&questions]]></FormalSpec>
<Implementation><![CDATA[
	set questions(1,"label")="First name"	
	set questions(1,"codItemName")="firstname"	
	set questions(1,"isMandatory")=1	
	
	set questions(2,"label")="Last name"	
	set questions(2,"codItemName")="lastname"	
	set questions(2,"isMandatory")=1	

	set questions(3,"label")="Company/Organisation"	
	set questions(3,"codItemName")="Company"	
	set questions(3,"isMandatory")=1	

	set questions(4,"label")="Email"
	set questions(4,"codItemName")="Email2"	
	set questions(4,"isMandatory")=1
	set questions(4,"type")="emailAddress"
]]></Implementation>
</Method>

<Method name="getDefaultQuestionsForTableGuests">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&questions]]></FormalSpec>
<Implementation><![CDATA[
	set questions(1,"label")="First name"	
	set questions(1,"codItemName")="firstname"	
	set questions(1,"isMandatory")=0	
	
	set questions(2,"label")="Last name"	
	set questions(2,"codItemName")="lastname"	
	set questions(2,"isMandatory")=0
]]></Implementation>
</Method>

<Method name="getDefaultQuestionsForRoomGuests">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&questions]]></FormalSpec>
<Implementation><![CDATA[
	set questions(1,"label")="First name"	
	set questions(1,"codItemName")="firstname"	
	set questions(1,"isMandatory")=0	
	
	set questions(2,"label")="Last name"	
	set questions(2,"codItemName")="lastname"	
	set questions(2,"isMandatory")=0
]]></Implementation>
</Method>

<Method name="getDefaultQuestionsForAwardsSubmitter">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&questions]]></FormalSpec>
<Implementation><![CDATA[
	//"firstname","lastname","Company","Address Line 1","Address Line 2","Town","Postcode","Work Telephone No."
	set questions(1,"label")="First name"	
	set questions(1,"codItemName")="firstname"	
	set questions(1,"isMandatory")=1	
	
	set questions(2,"label")="Last name"	
	set questions(2,"codItemName")="lastname"	
	set questions(2,"isMandatory")=1	
	
	set questions(3,"type")="form divider"	

	set questions(4,"label")="Company"	
	set questions(4,"codItemName")="Company"	
	
	set questions(5,"label")="Address line 1"	
	set questions(5,"codItemName")="Address line 1"	
	
	set questions(6,"label")="Address line 2"	
	set questions(6,"codItemName")="Address line 2"	
	
	set questions(7,"label")="Town"	
	set questions(7,"codItemName")="Town"	
	
	set questions(8,"label")="Postcode"	
	set questions(8,"codItemName")="Postcode"	
	set questions(8,"fieldWidthPx")=$$$defaultPostcodeFieldWidthPx	
	
	set questions(9,"label")="Phone number"	
	set questions(9,"codItemName")="Phone number"
	set questions(9,"type")="phoneNumber"
]]></Implementation>
</Method>

<Method name="getShortenedDescription">
<Description><![CDATA[
Automatically builds shortened description string.																			<br />
e.g. If you want to shorten "moo: one two three four five six seven (123456)" to "moo: one two...even (123456)", do this:	<br />
	desc 				= "one two three four five six seven"																<br />
	prefix				= "moo: "																							<br />
		suffix				= " (123456)"																						<br />
	separator			= "..."																								<br />
	threshold			= 10																								<br />
		minLeadingChars		= 7																									<br />
		minTrailingChars	= 4																									<br />
																																<br />
	"threshold" indicates how long the total length (prefix+desc+suffix) has to be before shortening happens					<br />]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>desc:%String,prefix:%String="",suffix:%String="",separator:%String="...",threshold:%Integer=0,minLeadingChars:%Integer=0,minTrailingChars:%Integer=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set ret=prefix_desc_suffix
	
	If threshold=0 Set threshold=$LENGTH(ret)
	
	If ($LENGTH(ret) > threshold) {
		Set maxDescLength=threshold-($LENGTH(prefix_suffix))
		
		If (minLeadingChars=0) {
			Set minLeadingChars=maxDescLength-(minTrailingChars+$LENGTH(separator))
		}
		
		If (minTrailingChars=0) {
			Set minTrailingChars=maxDescLength-(minLeadingChars+$LENGTH(separator))
		}
		
		If minLeadingChars<0 Set minLeadingChars=0
		If minTrailingChars<0 Set minTrailingChars=0
		
		If ((minLeadingChars+minTrailingChars) > maxDescLength) {
			Set minTrailingChars=maxDescLength-minLeadingChars
		}
		
		Set desc1=$EXTRACT(desc,1,minLeadingChars)
		Set desc2=$EXTRACT(desc,($LENGTH(desc)-(minTrailingChars-1)),$LENGTH(desc))
		
		Set ret=prefix_desc1_separator_desc2_suffix
	}
	
	Quit ret
]]></Implementation>
</Method>

<Method name="getEventLinks">
<Description>
get a list of all the active links for an event - used in drop-downs for nice URLs and quick links in config.csp</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[eventID,langID,&linkArray,returnFullURLs:%Boolean=0]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	kill linkArray
	set objEvent = ##class(setup.objEvent).%OpenId(eventID)
	set eventConfiguration=##class(setup.eventConfiguration).createForEventID(eventID)
	if (objEvent.gridList="grid") {
		set dailyAgendaPageID = ##class(sc.pageMethods).getDailyAgendaGridViewPageID(eventID,langID)
	} else {
		set dailyAgendaPageID = ##class(sc.pageMethods).getDailyAgendaListViewPageID(eventID,langID)
	}
	// get the full url to use instead of a relative path
	if returnFullURLs {
		set fullURL=##class(shared.pageMethods).getFullPath()
	} else {
		set fullURL="/"_$ZCVT(^%ZCSPAPPS($ZNSPACE),"L")   
	}
	
	// pages are relative to the proweb templates as this will be used from within proweb
	set eventDescription=##class(setup.objEventDetails).getDetails(eventID,langID)
	set eventDetailsID=##class(setup.objEventDetails).getDetailsID(eventID,langID)
	set eventGroupID=##class(sc.methods).getEventGroupID(eventID)
	set isAwardsEvent=+##class(setup.objEventSetting).getParameter("system","isAwardsEvent",eventID)
	set showSSOLinks=##class(setup.webSSOmethods).isWebSSOAllowedForFrontend(eventID)
	set isMeetingManagerEvent=(##class(setup.objSystemTypes).isModuleAllowed("Meeting Manager"))&&(eventConfiguration.getHasMeetingManager())
	
	set declinePageID=##class(setup.objEventSetting).getParameter("Decline Page","declinePageID",eventID)
	set allowInvitations=1

	if returnFullURLs	{
		set linkArray($I(linkArray),"Main: Registration Start")="{{EVENTPAGELINK:"_eventID_"|REGISTER}}"
		set linkArray($I(linkArray),"Main: Amendment Start")="{{EVENTPAGELINK:"_eventID_"|AMEND}}"
		if showSSOLinks {
			set linkArray($I(linkArray),"Main: Registration Start (External Login)")="{{EVENTPAGELINK:"_eventID_"|REGISTER|SSO}}"
			set linkArray($I(linkArray),"Main: Amendment Start (External Login)")="{{EVENTPAGELINK:"_eventID_"|AMEND|SSO}}"
		}
		set linkArray($I(linkArray),"Main: Password Reset Link") = "{{PasswordResetLink}}"
		set linkArray($I(linkArray),"Main: Decline Start")="{{EVENTPAGELINK:"_eventID_"|"_declinePageID_"}}"
		set linkArray($I(linkArray),"Main: Daily Agenda")="{{EVENTPAGELINK:"_eventID_"|"_dailyAgendaPageID_"}}"
		set linkArray($I(linkArray),"Main: Personal Event Link")="{{PersonalEventLink}}"
		set linkArray($I(linkArray),"Main: Personal Registration Link")="{{PersonalRegistrationLink}}"
		set linkArray($I(linkArray),"Main: Personal Amendment Link")="{{PersonalAmendmentLink}}"
		if allowInvitations {
			set linkArray($I(linkArray),"Main: Personal Decline Link")="{{PersonalDeclineLink}}"
		}
	} else {
		set linkArray($I(linkArray),"Main: Registration Start")=fullURL_"/frontend/reg/registerNew.csp"
		if showSSOLinks {
			set linkArray($I(linkArray),"Main: Registration Start (External Login)")=fullURL_"/frontend/reg/registerNew.csp?externalLogin=1"
		}
		set linkArray($I(linkArray),"Main: Amendment Start")=fullURL_"/frontend/reg/registerAmend.csp"
		if showSSOLinks {
			set linkArray($I(linkArray),"Main: Amendment Start (External Login)")=fullURL_"/frontend/reg/registerAmend.csp?externalLogin=1"
		}
		if allowInvitations {
			set linkArray($I(linkArray),"Main: Decline Start")=fullURL_"/frontend/reg/decline.csp"
		}
		set linkArray($I(linkArray),"Main: Daily Agenda")=fullURL_"/system/proweb/start.csp?pageID="_dailyAgendaPageID
	}
	
	// get auto generated proweb pages
	set objEventDetails=##class(setup.objEventDetails).%OpenId(eventDetailsID)
	
	set extraBit=""
	if langID>1 set extraBit=" - "_##class(shared.objLanguage).getLanguageDesc(langID)
	set sendEmailPageID=##class(setup.objEventSetting).getParameter("Send Email","sendEmailPageID"_extraBit,eventID)
	
	if returnFullURLs	{
		set linkArray($I(linkArray),"Main: Home Page")="{{EVENTPAGELINK:"_eventID_"}}"
		set linkArray($I(linkArray),"Main: Terms and Conditions")="{{EVENTPAGELINK:"_eventID_"|"_objEventDetails.tAndCPageID_"}}"
		set linkArray($I(linkArray),"Main: Venue Page")="{{EVENTPAGELINK:"_eventID_"|"_objEventDetails.venuePageID_"}}"
		if ##class(setup.objSystemTypes).isModuleAllowed("Email a Friend") {	
			set linkArray($I(linkArray),"Main: Email A Friend")="{{EVENTPAGELINK:"_eventID_"|"_sendEmailPageID_"}}"
		}
		// add the links to the abstracts pages
		if ((##class(setup.objSystemTypes).isModuleAllowed("Abstract Management"))&&(##class(setup.objEventSetting).getParameter("event setup","has abstracts",eventID))) {  // added Fred Aug2009
			set topicListPageID=##class(setup.objEventSetting).getParameter("abstract management pages","topicListPageID"_extraBit,eventID)
			set searchPageID=##class(setup.objEventSetting).getParameter("abstract management pages","abstractSearchDocumentPageID"_extraBit,eventID)
			set linkArray($I(linkArray),"Abstracts: Submission Login")="{{EVENTPAGELINK:"_eventID_"|"_topicListPageID_"}}"
			set linkArray($I(linkArray),"Abstracts: Personal Submission")="{{PersonalAbstractSubmissionLink}}"
			set linkArray($I(linkArray),"Abstracts: Personal Reviewer")="{{PersonalAbstractReviewerLink}}"
			set linkArray($I(linkArray),"Abstracts: Reviews")="{{EVENTPAGELINK:"_eventID_"|ABSJUDGE}}"
			set linkArray($I(linkArray),"Abstracts: Search")="{{EVENTPAGELINK:"_eventID_"|"_searchPageID_"}}"
		}
		if (##class(setup.objSystemTypes).isModuleAllowed("Awards") && isAwardsEvent) {  
			set linkArray($I(linkArray),"Awards: Judge")="{{PersonalAwardsJudgeLink}}"
		}
		if isMeetingManagerEvent {
			set linkArray($I(linkArray),"Meeting Manager: Diary")="{{PersonalDiaryLink}}"
		}
		
	} else {
		set linkArray($I(linkArray),"Main: Home Page")=fullURL_"/system/proweb/start.csp?pageID="_objEventDetails.homePageID
		set linkArray($I(linkArray),"Main: Menu Page")=fullURL_"/system/proweb/start.csp?pageID="_objEventDetails.menuPageID
		set linkArray($I(linkArray),"Main: Terms and Conditions")=fullURL_"/system/proweb/start.csp?pageID="_objEventDetails.tAndCPageID
		set linkArray($I(linkArray),"Main: Venue Page")=fullURL_"/system/proweb/start.csp?pageID="_objEventDetails.venuePageID
		if ##class(setup.objSystemTypes).isModuleAllowed("Email a Friend") {
			set linkArray($I(linkArray),"Main: Email A Friend")=fullURL_"/system/proweb/start.csp?pageID="_sendEmailPageID
		}
	}
	
	// do we need a log-out link at all?
	set (privateEvent,privateWebsite,PINEvent)=0
	
	// private event
	&SQL(SELECT privateEvent INTO :tmp FROM setup.objEvent WHERE ID=:eventID)
	if (+SQLCODE=0) {
		if (tmp=1) {
			set privateEvent=1
		}
	}
	
	// private website
	set privateWebsite=##class(setup.objEventSetting).getParameter("website","private website",eventID)
	
	//PIN event
	set PINEvent=+##class(setup.objEventSetting).getParameter("website","private website my account",eventID)
	
	if ((privateEvent)!(privateWebsite)!(PINEvent)){
		// is this an entry code event?
		&SQL(SELECT objEntryCode FROM setup.lnkEntryCodeEvent WHERE objEvent=:eventID)
		if (+SQLCODE=0) {
			set entryPage=##class(setup.objSetting).getParameter("system","xtEntryCode")
			if $L(entryPage)=0 set entryPage="xtentrycode.csp"
			set linkArray($I(linkArray),"Main: Log Out Page")=fullURL_"/frontend/xt/"_entryPage
		} else { // standard login page
			set linkArray($I(linkArray),"Main: Log Out Page")=fullURL_"/frontend/xt/xtLogout.csp?eventID="_eventID
		}
	}
	
	// get manually created proweb pages
	set parent=##class(sc.xModules.objGroup).findGroupID("More Pages",eventGroupID)
	kill pages
	do ##class(sc.objData).findChildrenPages(parent,.pages)
	set pageID=""
	for  {
		set pageID=$O(pages(pageID))
		if pageID="" quit
		&SQL(SELECT description INTO :desc FROM sc_xModules.objPage WHERE ID=:pageID)
		if +SQLCODE=0 {
			if returnFullURLs	{
				set linkArray($I(linkArray),"Additional: "_desc_" ("_pageID_")")="{{EVENTPAGELINK:"_eventID_"|"_pageID_"}}"
			} else {
				set linkArray($I(linkArray),"Additional: "_desc_" ("_pageID_")")=fullURL_"/system/proweb/start.csp?pageID="_pageID
			}
		}
	}
	if 'returnFullURLs	{
		if (eventConfiguration.areSessionsAllowed()) { // pjc, 8th July 2009, add event-specific check
			// get list of active session types
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs.Prepare("SELECT * FROM setup.objSessionType WHERE (active = 1) AND (isSystem = 0) AND (isBreak = 0) ORDER BY displayOrder")
			do rs.Execute()
			while rs.Next()	{
				set linkArray($I(linkArray),"SessionType: "_rs.Get("description"))=fullURL_"/frontend/reg/sessionsByType.csp?sessionType="_rs.Get("description")
			}
			kill rs
		
	
			// get item pages  #### CHANGE TO USE ONLY ACTIVE ITEMS PAGES ####
			set parent=##class(sc.xModules.objGroup).findGroupID("Item Pages",eventGroupID)
			kill pages
			do ##class(sc.objData).findChildrenPages(parent,.pages)
			set pageID=""
			for  {
				set pageID=$O(pages(pageID))
				if pageID="" quit
				&SQL(SELECT description INTO :desc FROM sc_xModules.objPage WHERE ID=:pageID)
				// need to shorten the description to avoid crashes where the total length exceeds > 256
				if +SQLCODE=0 {
					Set tempDesc=##class(setup.eventCreationMethods).getShortenedDescription(desc,"Session: "," ("_pageID_")","...",50,,7)
					// set linkArray($I(linkArray),"Session: "_desc_" ("_pageID_")")=fullURL_"/system/proweb/start.csp?pageID="_pageID
					set linkArray($I(linkArray),tempDesc)=fullURL_"/system/proweb/start.csp?pageID="_pageID
				}
			}
		
		
			// get presenter pages
			set rs=##class(%ResultSet).%New("setup.objPresenter:qActivePresenters")
			do rs.Execute(eventID)
			while rs.Next()	{
				Set presenterID=rs.Data("ID")
				Set presenterPersonID=rs.Data("objPerson")
				If (##class(setup.presenterMethods).canEventUseStaticPresenterPages(eventID)) {
					If (##class(setup.objPresenter).canShowStaticPresenterPage(presenterID)) {
						Set desc=##class(setup.objPresenter).getTitleAndFullName(presenterPersonID)
						Set linkArray($I(linkArray),"Presenter: "_desc_" ("_presenterPersonID_")")=fullURL_"/frontend/reg/presenterDetails.csp?presenterID="_presenterID
					}
				} else {
					set pageID=rs.Data("pageID")   //pres
					&SQL(SELECT description INTO :desc FROM sc_xModules.objPage WHERE ID=:pageID)
					if +SQLCODE=0 set linkArray($I(linkArray),"Presenter: "_desc_" ("_pageID_")")=fullURL_"/system/proweb/start.csp?pageID="_pageID
				}
			}
			// get location pages
			set rs=##class(%ResultSet).%New("setup.objLocation:qAllActive")
			do rs.Execute(langID,eventID)
			while rs.Next()	{
				set pageID=rs.Data("pageID")   //loc
				&SQL(SELECT description INTO :desc FROM sc_xModules.objPage WHERE ID=:pageID)
				if +SQLCODE=0 set linkArray($I(linkArray),"Location: "_desc_" ("_pageID_")")=fullURL_"/system/proweb/start.csp?pageID="_pageID
			}
		}
		
		// add direct link to meeting manager
		if isMeetingManagerEvent {
			set linkArray($I(linkArray),"Meeting Manager: Diary Login")=fullURL_"/frontend/reg/registerAmend.csp?meetingManOnly=1"
		}
		
		// add the links to the abstracts pages
		if ((##class(setup.objSystemTypes).isModuleAllowed("Abstract Management"))&&(##class(setup.objEventSetting).getParameter("event setup","has abstracts",eventID))) {  // added JAW 20JUN2005 // pjc, 8th July 2009, add event-specific check
			set topicListPageID=##class(setup.objEventSetting).getParameter("abstract management pages","topicListPageID"_extraBit,eventID)
			set searchPageID=##class(setup.objEventSetting).getParameter("abstract management pages","abstractSearchDocumentPageID"_extraBit,eventID)
			set linkArray($I(linkArray),"Abstracts: Submission Login")=fullURL_"/system/proweb/start.csp?userType=submitter&pageID="_topicListPageID
			set linkArray($I(linkArray),"Abstracts: Reviews")=fullURL_"/frontend/reg/absLogin.csp?isReviewer=1"
			set linkArray($I(linkArray),"Abstracts: Search")=fullURL_"/system/proweb/start.csp?pageID="_searchPageID
		}
		// add links to the award
		if ##class(setup.objSystemTypes).isModuleAllowed("Awards"),isAwardsEvent      {  // added JAW 20JUN2005
			//v2.7 set pageID=##class(setup.objEventSetting).getParameter("awards","awardClientPageID",eventID)
			set linkArray($I(linkArray),"Awards: Entry")=fullURL_"/frontend/reg/registerNew.csp?isAwards=1"
			set linkArray($I(linkArray),"Awards: Amendment")=fullURL_"/frontend/reg/registerAmend.csp?isAwards=1"
			set judgeLoginPageID=##class(setup.objEventSetting).getParameter("awards","judgeLoginPageID"_extraBit,eventID)
			set linkArray($I(linkArray),"Awards: Judges Login")=fullURL_"/system/proweb/start.csp?pageID="_judgeLoginPageID
			if showSSOLinks {
				set linkArray($I(linkArray),"Awards: Judges Login (External Login)")=fullURL_"/system/proweb/start.csp?externalLogin=1&pageID="_judgeLoginPageID
			}
		}
		// ACCOMMODATION PAGES
	
		if ((##class(setup.objSystemTypes).isModuleAllowed("Accommodation"))&&(##class(setup.objEventSetting).getParameter("bookings","allow accommodation bookings",eventID)))	{  // added JAW 20JUN2005 // pjc, 8th July 2009, add event-specific check
			// get the first venuepageID (the rest will also be displayed in this page)
			set firstVenuePageID=##class(accom.objEventHotel).getFirstVenuePageID(eventID)
			set firstVenuePageID=##class(accom.objEventHotel).getFirstVenuePageID(eventID)
			if firstVenuePageID set linkArray($I(linkArray),"Hotel: hotel list (read only)")=fullURL_"/system/proweb/start.csp?pageID="_firstVenuePageID_"&mode=preview&version=current&readonly=1"
				
			set rs=##class(%ResultSet).%New("accom.objEventHotel:qEventHotelsWithRooms")
			do rs.Execute(eventID)
			while rs.Next()	{
				set venueID=rs.Data("objVenue")
				set pageID=rs.Data("venueMainPageID")
				set desc=##class(accom.objVenueItemData).get(venueID,"description")
				set linkArray($I(linkArray),"Hotel: "_desc)=fullURL_"/system/proweb/start.csp?pageID="_pageID_"&mode=preview&version=current"
			}
			
		}
	}
	
	if returnFullURLs {
		if ##class(setup.objSystemTypes).isModuleAllowed("Email PDFs") {
			set rsPDFs=##class(%ResultSet).%New("pdf.lnkContentDefinition:qAllForEventAndNotEvent")
			do rsPDFs.Execute(eventID)
			while rsPDFs.Next() {
				set show=1
				if rsPDFs.Data("isInvoice") set show=0 // should be dealt with in the invoice-run page
				if 'rsPDFs.Data("objDefinition") set show=0
				if show {
					set lnkContentDefinitionID=rsPDFs.Data("ID")
					set linkArray($I(linkArray),"PDF: "_rsPDFs.Data("description"))="{{PDFDOWNLOAD:"_lnkContentDefinitionID_"}}"
				}
			}
		}
		if ##class(setup.objSystemTypes).isModuleAllowed("Invoice by Email") {
			if ##class(setup.objEventSetting).getParameter("event setup","has pricing",eventID) {
				if ##class(setup.objEventSetting).getParameter("invoicing","default invoice template",eventID) {
					set linkArray($I(linkArray),"Latest Invoice PDF")="{{LASTINVOICEPDF}}"
				}
			}
		}
	}
	quit ""
]]></Implementation>
</Method>

<Method name="checkEvent">
<Description>
runs the same checks as the eventStatus page (used to do)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[eventConfiguration:setup.eventConfiguration,&out]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	kill out set out=""
	set xLangID=1
	set xEventID = eventConfiguration.getEventID()
	set xControllerID=##class(setup.objEvent).getControllerID(xEventID)
	set objEvent=##class(setup.objEvent).%OpenId(xEventID)
	
	// =====================================================================================================================================
	// if multi currency, check that all priced items have all currencies
	if ##class(setup.objEventSetting).getParameter("currency","allow currency selection",xEventID) {
		// step1 - collect all prices per currency
		set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
		set ok=rs.Prepare("SELECT * FROM eCom.objBasketItem WHERE objController=?")
		do rs.Execute(xControllerID)
		while rs.Next() {
			set basketItemID=rs.Get("ID")
			
			// check if it still used, could be a deleted prompt
			set inUse=0
			&SQL(SELECT codItemID INTO :tmp FROM cod.objAlternativeExtras WHERE basketItemID = :basketItemID)
			if +SQLCODE=0 {
				&SQL(SELECT active INTO :tmp2 FROM sc_xModules.objCODitem WHERE ID = :tmp)
				if +SQLCODE=0,tmp2=1 set inUse=1
			} else {
				&SQL(SELECT active INTO :tmp FROM setup.objItem WHERE (objDelegateBasketItem = :basketItemID) OR (objGuestBasketItem = :basketItemID))
				if +SQLCODE=0,tmp=1 set inUse=1
			}
			
			&SQL(SELECT objAlternativeExtras->codItemID,objItem->active INTO :tmp,:tmp2 FROM links.lnkCategoryItemBasketItem WHERE objBasketItem=:basketItemID)
			if +SQLCODE=0 {
				if tmp2 set inUse=1
				if tmp {
					&SQL(SELECT active INTO :tmp2 FROM sc_xModules.objCODitem WHERE ID = :tmp)
					if +SQLCODE=0,tmp2=1 set inUse=1
				}
			}
			
			if inUse {
				set rs2=##class(%ResultSet).%New("eCom.objCurrency:qActiveCurrencies")
				do rs2.Execute()
				while rs2.Next() {
					set currencyID=rs2.Get("ID")
					set price=##class(eCom.objBasketItem).getPrice(xEventID,basketItemID,,currencyID)
					if price set hasPrice(basketItemID,currencyID)=price,hasCurrencies(currencyID)=""
				}
			}
		}
		// step 2 - check if any is missing
		set (basketItemID)=""
		for  {
			set basketItemID=$O(hasPrice(basketItemID))
			if basketItemID="" quit
			set currencyID=""
			
			for  {
				set currencyID=$o(hasCurrencies(currencyID))
				if currencyID="" quit
				if '$D(hasPrice(basketItemID,currencyID)) {
					set missing(basketItemID,currencyID)=""
					
					&SQL(SELECT objPriceDescriptor->description INTO :tmp from eCom.objBasketItem WHERE ID = :basketItemID)
					if +SQLCODE=0,tmp'="" {
						set name=tmp
						set out($I(out))=name_" "_##class(shared.pCSP).translateAdmin("is missing a price in the following currency")_": "_##class(eCom.objCurrency).getCode(currencyID)
					}
				}
			}	
		}
	}
	
	
	// =====================================================================================================================================
	// check to make sure there is a field called email2 on the reg page OR the bookers page
	if ##class(setup.objEventSetting).getParameter("system","do not use email",xEventID)	{
		// if awards event check the entry page
		if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID) {
			set pageID=##class(setup.objEventSetting).getParameter("awards","awardClientPageID",xEventID)
			if '..isItemInPage(pageID,"email2") set out($I(out))=##class(shared.pCSP).translateAdmin("Email2 field is not in the client details page")
			// if group bookings then check the bookers page
		} elseif ##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)	{
			set pageID=##class(setup.objEventSetting).getParameter("bookings","bookerRegPageID",xEventID)
			if '..isItemInPage(pageID,"email2") set out($I(out))=##class(shared.pCSP).translateAdmin("Email2 field is not in the registration contact's details page")
		} else {
			set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xLangID,1,,.allRegPageIDs,)
			// for each category
			set categoryID=""
			for  {
				set categoryID=$O(allRegPageIDs(categoryID))
				if categoryID="" quit
				set emailOK(categoryID)=0
				set pageID=""
				for  {
					set pageID=$O(allRegPageIDs(categoryID,pageID))
					if pageID="" quit
					if ..isItemInPage(pageID,"email2") set emailOK(categoryID)=1
				}
				if emailOK(categoryID)=0 set out($I(out))=##class(shared.pCSP).translateAdmin("Email2 field is not in the registration page for category: ")_##class(setup.objEventCategory).getDescription(categoryID)
			}
			
		}
	}
	
	// =====================================================================================================================================
	// check to make sure there is a fields called firstname and lastname on the reg page OR the bookers page
	// if group bookings then check the bookers page
	if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID) {
		// for awards events, we need to check the submitter's page instead
		set awardClientPageID=##class(setup.objEventSetting).getParameter("awards","awardClientPageID",xEventID)
		if '..isItemInPage(awardClientPageID,"firstname") set out($I(out))=##class(shared.pCSP).translateAdmin("firstname field is not in the submitter details page: ")_##class(shared.pCSP).translateAdmin(" - this is required")
		if '..isItemInPage(awardClientPageID,"lastname") set out($I(out))=##class(shared.pCSP).translateAdmin("lastname field is not in the submitter details page: ")_##class(shared.pCSP).translateAdmin(" - this is required")
	} else {
		// not an awards event
		if ##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)	{
			set pageID=##class(setup.objEventSetting).getParameter("bookings","bookerRegPageID",xEventID)
			if '..isItemInPage(pageID,"firstname") set out($I(out))=##class(shared.pCSP).translateAdmin("firstname field is not in the registration contact's details page - this is required")
			if '..isItemInPage(pageID,"lastname") set out($I(out))=##class(shared.pCSP).translateAdmin("lastname field is not in the registration contact's details page - this is required")
		} else {
			set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xLangID,1,,.allRegPageIDs,)
			// for each category
			set categoryID=""
			for  {
				set categoryID=$O(allRegPageIDs(categoryID))
				if categoryID="" quit
				set firstnameOK(categoryID)=0
				set lastnameOK(categoryID)=0
				set pageID=""
				for  {
					set pageID=$O(allRegPageIDs(categoryID,pageID))
					if pageID="" quit
					if ..isItemInPage(pageID,"firstname") set firstnameOK(categoryID)=1
					if ..isItemInPage(pageID,"lastname") set lastnameOK(categoryID)=1
				}
				if firstnameOK(categoryID)=0 set out($I(out))=##class(shared.pCSP).translateAdmin("firstname field is not in the registration page for category: ")_##class(setup.objEventCategory).getDescription(categoryID)_##class(shared.pCSP).translateAdmin(" - this is required")
				if lastnameOK(categoryID)=0 set out($I(out))=##class(shared.pCSP).translateAdmin("lastname field is not in the registration page for category: ")_##class(setup.objEventCategory).getDescription(categoryID)_##class(shared.pCSP).translateAdmin(" - this is required")
			}
		}
	}
	// =====================================================================================================================================
	
	// ticketing checks:
	if ##class(cod.objTicket).isTicketingPersonMode(xEventID)	{
		if '##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)	{
			set out($I(out))=##class(shared.pCSP).translateAdmin("Group registrations is turned off but you have questions that create attendees in the registration contact's details page:")
			set out($I(out))=##class(shared.pCSP).translateAdmin(" - please enable, remove those questions and disable.")
		}
	}
	
	// =====================================================================================================================================
	
	// Check whether there are any value basket discounts for events with overriding VAT
	&SQL(SELECT ID INTO :tmp FROM eCom.objDiscountHistory WHERE (objDiscount->whichPrice='basket') AND (objDiscount->active=1) AND (discountUnit='amount') AND (objDiscount->objController = :xControllerID))
	if +SQLCODE=0 {
		if ##class(eCom.objVatCode).isVatCodesEnabled() {
			if ##class(setup.objSetting).getParameter("basket","always itemise VAT") {
				set generalError($I(generalError))=##class(shared.pCSP).translateAdmin("A basket discount is set up with a price")
				set generalError($I(generalError))=##class(shared.pCSP).translateAdmin("Only percentage basket discounts work when using VAT codes")
			} else {
				// Do not allow values for basket if there is overriding VAT
				set defaultEventCode=##class(eCom.objVatCode).getDefaultEventVatCodeID(xEventID)
				&SQL(SELECT objVatCode INTO :tmp
					FROM eCom.objBasketItem
					WHERE (objEvent=:xEventID) OR (objController=  :xControllerID)
					AND (objVatCode <> :defaultEventCode)
					ORDER BY objVatCode desc
				)
				if +SQLCODE=0,tmp {
					set generalError($I(generalError))=##class(shared.pCSP).translateAdmin("There are overriding VAT rates as well as a basket discount set up with a price.")
					set generalError($I(generalError))=##class(shared.pCSP).translateAdmin("Only percentage basket discounts work when there is Overriding VAT")
				}
			}
		} else {
			&SQL(SELECT ID FROM setup.objItem WHERE ((overridingVAT IS NOT NULL) OR (overridingVAT <>'')) AND (objEvent = :xEventID) AND (active=1))
			if +SQLCODE=0 {
				set out($I(out))=##class(shared.pCSP).translateAdmin("There are overriding VAT rates as well as a basket discount set up with a price.")
				set out($I(out))=##class(shared.pCSP).translateAdmin("Only percentage basket discounts work when there is Overriding VAT")
			} else {
				&SQL(SELECT ID FROM cod.objAlternativeExtras 
					WHERE ((overridingVAT IS NOT NULL) OR (overridingVAT <>''))
					AND (objItemAlternative->active = 1) 
					AND (basketItemID IN (
						SELECT ID FROM eCom.objBasketItem
						WHERE objEvent = :xEventID)
					)
				)
				if +SQLCODE=0 {
					set out($I(out))=##class(shared.pCSP).translateAdmin("There are overriding VAT rates as well as a basket discount set up with a price.")
					set out($I(out))=##class(shared.pCSP).translateAdmin("Only percentage basket discounts work when there is Overriding VAT")
				}
			}
		}
	}
	// =====================================================================================================================================
	// check WorldPay is set up
	&SQL(SELECT ID INTO :tmp FROM links.lnkEventPaymentMethod where (objPaymentMethod->internalDescription='Worldpay') AND (objEvent = :xEventID))
	if +SQLCODE=0 {
		&SQL(SELECT ID INTO :tmp FROM worldpay.objAccount WHERE (eventID=:xEventID) AND (installationID <> ''))
		if +SQLCODE'=0 {
			set out($I(out))=##class(shared.pCSP).translateAdmin("WorldPay is selected for credit card processing but no details have been set up")
		}
	}
	
	// =====================================================================================================================================
	
	if ##class(cod.objTicket).isTicketingPersonMode(xEventID) {
		if ##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID) {
			set out($I(out))=##class(shared.pCSP).translateAdmin("It is not possible for table booking and QBIs creating registrations to be switched on in the same event")
		}
	}
	// =====================================================================================================================================
	
	if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID) {
		if ##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID) {
			set out($I(out))=##class(shared.pCSP).translateAdmin("Awards and Table booking are both active which is not allowed")		
		}
	}
	
	// =====================================================================================================================================
	
	&SQL(SELECT status INTO :selEventStatus FROM setup.objEvent WHERE ID = :xEventID)
	set show=0 	
	if selEventStatus="notlive" {
		set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
		do rs.Prepare("SELECT ID,minValue,maxValue,criteriaCODid,criteriaValue,freebie,internalDescription FROM eCom.objPaymentMethod WHERE (active=1)  AND (creditcardType=1)")
		do rs.Execute()
		while rs.Next() {
			set paymentMethodID=rs.Data("ID")
			set internalDescription=rs.Data("internalDescription")
			set isActive=##class(links.lnkEventPaymentMethod).isActive(xEventID,paymentMethodID)
			if isActive {							
				set activeCreditCard($ZCVT(rs.Data("internalDescription"),"U"))=1												
			}
		} 
		if $G(activeCreditCard("WORLDPAY")) {set show=1}
		elseif $G(activeCreditCard("SAGE PAY")) {set show=1}
		elseif $G(activeCreditCard("NETBANX")) {set show=1}
		else {set show=0}
	}
	if show set out($I(out))=##class(shared.pCSP).translateAdmin("Credit Card Payment Method is active but the Event is not live")		
	// =====================================================================================================================================
	 
	// check if any mandatory prompts have not been completed.
	set rsSoft=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rsSoft.Prepare("SELECT ID FROM setup.objEventPrompt WHERE (active = 1) AND (mandatory = 1)")
	do rsSoft.Execute()
	while rsSoft.Next() {
		if '$l(##class(setup.objEventData).getData(xEventID,rsSoft.Get("ID"))) {
			set out($I(out))=##class(shared.pCSP).translateAdmin("Not all mandatory event settings have been completed")
		}
	}
	
	// =====================================================================================================================================
	
	// check if multiple attendee categories are active for Award events (that causes automatic registration emails to fail).
	if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID) {
		set tmp=""
		if ##class(setup.lnkCategoryEvent).numCategories(xEventID,1,1)>1 {
			set out($I(out))=##class(shared.pCSP).translateAdmin("An Award Event cannot have multiple attendee categories active. Please deactivate the inappropriate categories.")
		}
	}
	
	// =====================================================================================================================================
	//  warn if the event is in the past but still has booking open
	if (##class(setup.eventBookingMethods).hasEventFinished(xEventID))&&(##class(setup.eventBookingMethods).areFrontendRegistrationsAllowed(xEventID)) {
		set out($I(out))=##class(shared.pCSP).translateAdmin("The event has finished but is still open for registrations.")
			
	}
	// =====================================================================================================================================
	// warn if they have emailed invoices switched on but do not have one set up
	if ##class(setup.objEventSetting).getParameter("invoicing","invoice delivery method",xEventID)="autoEmail" {
		if '##class(setup.objEventSetting).getParameter("invoicing","default invoice template",xEventID) {
			set out($I(out))=##class(shared.pCSP).translateAdmin("There is no default invoice template for this event. No invoices will be emailed until the default template is set.")
		}
		if ##class(setup.objEventSetting).getParameter("invoicing","create credit notes",xEventID) {
			if '##class(setup.objEventSetting).getParameter("invoicing","default credit note template",xEventID) {
				set out($I(out))=##class(shared.pCSP).translateAdmin("There is no default credit note template for this event. No credit notes will be sent until the default template is set")	
			}
		}
	}
	
	set mailTemplateIDs = ##class(mail.objMailTemplate).getListOfActiveMailTemplateIDsForEvent(eventConfiguration)
	for mailTemplateIndex = 1:1:mailTemplateIDs.Count() {
		set mailTemplateID = mailTemplateIDs.GetAt(mailTemplateIndex)
		set objMailTemplate = ##class(mail.objMailTemplate).%OpenId(mailTemplateID)
		set unsupportedTags =  objMailTemplate.findUnsupportedTags()
		set passwordHashVersion = ##class(EF.security.objPasswordFrontend).getCurrentHashVersion()
		if (passwordHashVersion = "v0") {
			set unsupportedTagDescription = "deprecated tag"
		} else {
			set unsupportedTagDescription = "unsupported tag"
		}
		if unsupportedTags.Count() {
			set warningMessage = "Email template, "_objMailTemplate.description_", contains "_unsupportedTagDescription
			if (unsupportedTags.Count() > 1) {
				set warningMessage = warningMessage_"s: "
			} else {
				set warningMessage = warningMessage_": "
			}	
			for badTagIndex = 1:1:unsupportedTags.Count() {
				if badTagIndex > 1 {
					set warningMessage=warningMessage_", "
				}
				set warningMessage = warningMessage_unsupportedTags.GetAt(badTagIndex)
			}
			if (passwordHashVersion = "v0") {
				if (unsupportedTags.Count() > 1) {
					set warningMessage = warningMessage_". These tags will be removed in a future release."
				} else {
					set warningMessage = warningMessage_". This tag will be removed in a future release."
				}
			}
			set out($Increment(out)) = warningMessage
		}
	}
	
	// =====================================================================================================================================
	// Warn if any of the questions on any of the payment method pages can affect the total price or payment method pages can control the available payment methods
	set rsPM=##class(%ResultSet).%New("links.lnkEventPaymentMethod:qPayMethodByEvent")
	do rsPM.Execute(xEventID)
	while rsPM.Next() {
		set paymentMethodID=rsPM.Get("payID")
		set paymentPageID=##class(links.lnkEventPaymentMethod).getPaymentPageID(xEventID,paymentMethodID,$$$efEnglishLangID) // this page is not multilingual yet
		if ##class(sc.xModules.objPage).hasAnyQuestionThatAffectsPricing(paymentPageID) {
			do ##class(sc.xModules.objPage).getArrayOfQuestionsThatAffectsPricing(paymentPageID,.problemQuestions)
			do ..addPaymentIssueToMessageArray(paymentMethodID,.problemQuestions,.out,"payment details page may change the total amount after the basket page.")
		}
		if ##class(sc.xModules.objPage).hasAnyQuestionThatAffectsPaymentMethods(paymentPageID) {
			do ##class(sc.xModules.objPage).getArrayOfQuestionsThatAffectsPaymentMethods(paymentPageID,.problemQuestions)
			do ..addPaymentIssueToMessageArray(paymentMethodID,.problemQuestions,.out,"payment details page may invalidate the payment method.")
		}	
	}
	
	// =====================================================================================================================================
	// warn if any salable item has overriding VAT
	if '##class(setup.objSetting).getParameter("basket","always itemise VAT") { 
		if objEvent.hasAnyOverridingVATCodes() {
			set out($I(out))="An additional item, quantity bookable item or a session is not using the default VAT rate for the event. This means that discounts applied to the Grand Total can only be a percentage of the grand total. Use the default VAT rate to apply a currency discount."		
		}
	}		
	quit
]]></Implementation>
</Method>

<Method name="addPaymentIssueToMessageArray">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[paymentMethodID,&problemQuestions,&out,messageText]]></FormalSpec>
<Implementation><![CDATA[
	set m=""
	for  {
		set m=$O(problemQuestions(m))
		if m="" quit
		
		set question=##class(shared.pCSP).EscapeHTML(problemQuestions(m,"questionName"))
		set paymentMethodName=##class(eCom.objPaymentMethod).getInternalDescription(paymentMethodID)
		set out($I(out))="The question """_question_""" on the """_paymentMethodName_""" "_messageText
	}
]]></Implementation>
</Method>

<Method name="checkIncompatibleModes">
<Description>
Call this method from all possible settings pages to make sure we don't have any weird combinations
make sure the objEvent is saved and killed before calling this method</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=1,xEventID=eventID
	set objEvent=##class(setup.objEvent).%OpenId(eventID)
	
	// do some checking and changing to make sure we do not allow incompatible modes of operation:
	if ##class(setup.objEventSetting).getParameter("system","do not use email",eventID)	{
		if objEvent.privateEvent {
			// show message to user
			set %session.Data("eventsforce","backend","eventSettings.csp","errmsg")=$G(%session.Data("eventsforce","backend","eventSettings.csp","errmsg"))_##class(shared.pCSP).translateAdmin("Anonymous mode does not work with private event")_". <BR>"
		}
		set objEvent.privateEvent=0   // cannot have private event - but CAN have private website event PIN (due to eventPIN uniqueness)
		if ##class(setup.objEventSetting).getParameter("bookings","allow group bookings",eventID)	{
			// if we are not using email then turn off the advanced option for delegateUID page
			if '##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",eventID) {
				// show message to user
				set %session.Data("eventsforce","backend","eventSettings.csp","errmsg")=$G(%session.Data("eventsforce","backend","eventSettings.csp","errmsg"))_##class(shared.pCSP).translateAdmin("Authenticate attendees in group registrations has been turned off to match anonymous mode")_". <BR>"
			}
			do ##class(setup.objEventSetting).setParameter("bookings","do not show delegateUID page",1,eventID)  // this is done in adv2 as well
		}
	}
	
	// don't allow username as identifier in anonymous mode
	if ##class(setup.objEventSetting).getParameter("system","identifying field",xEventID)="username" { 
		if ##class(setup.objEventSetting).getParameter("system","do not use email",xEventID) {
			set %session.Data("eventsforce","backend","eventSettings.csp","errmsg")=$G(%session.Data("eventsforce","backend","eventSettings.csp","errmsg"))_##class(shared.pCSP).translateAdmin("Anonymous mode cannot be used in combination with username as identifier")_". <BR>"	
			do ##class(setup.objEventSetting).setParameter("system","identifying field","email",xEventID)
		}	
	}
	
	// don't allow force email confirmation with username as indetifier
	if ##class(setup.objEventSetting).getParameter("system","identifying field",xEventID)="username" {
		if ##class(setup.objEventSetting).getParameter("frontend","force email confirmation",xEventID) {
			set %session.Data("eventsforce","backend","eventSettings.csp","errmsg")=$G(%session.Data("eventsforce","backend","eventSettings.csp","errmsg"))_##class(shared.pCSP).translateAdmin("Force email confirmation cannot be used in combination with username as identifier")_". <BR>"
			do ##class(setup.objEventSetting).setParameter("frontend","force email confirmation","",xEventID)
		}
	}
	// don't allow delegateUID page with username as indentifier
	if ##class(setup.objEventSetting).getParameter("system","identifying field",xEventID)="username" {
		if "EVDEV,EVTAP,EVTAPTEST"'[$ZNSPACE { // exception to the actuaries that have a single-sign on that interfecs to an external lookup web services
			if ##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID) {
				if '##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID) {
					/* pjc 05 May 2009 */
					// no need to throw errr here as we're fixing the conflict auttomatically // bollocks to that - Fred Feb 2010
					set %session.Data("eventsforce","backend","eventSettings.csp","errmsg")=$G(%session.Data("eventsforce","backend","eventSettings.csp","errmsg"))_##class(shared.pCSP).translateAdmin("Attendee identification cannot be used in combination with username as identifier")_". <BR>"
					do ##class(setup.objEventSetting).setParameter("bookings","do not show delegateUID page","1",xEventID)
				}
			}
		}
	}
	// do some addt stuff here so that we can rely on these flags always
	if ##class(setup.objEventSetting).getParameter("bookings","allow group bookings",eventID)	{
		if (($ZNSPACE="EVHAYMARKET")!($ZNSPACE="EVHAYTEST")) {
			do ##class(setup.objEventSetting).setParameter("bookings","allow multi categories per booking",0,eventID)   // ##### WILL ALWAYS TURN THIS TO ZERO
		}
		// cannot have this if we are doing group bookings
		if ##class(setup.objEventSetting).getParameter("bookings","only accommodation bookings",eventID) {
			// show message to user
			set %session.Data("eventsforce","backend","eventSettings.csp","errmsg")=$G(%session.Data("eventsforce","backend","eventSettings.csp","errmsg"))_##class(shared.pCSP).translateAdmin("Only accommodation bookings has been turned off as cannot use group registrations in this mode")_". <BR>"
		}
		do ##class(setup.objEventSetting).setParameter("bookings","only accommodation bookings",0,eventID) 
		if ##class(setup.objEventSetting).getParameter("website","private website my account",eventID) {
			// show message to user
			set %session.Data("eventsforce","backend","eventSettings.csp","errmsg")=$G(%session.Data("eventsforce","backend","eventSettings.csp","errmsg"))_##class(shared.pCSP).translateAdmin("Group registrations cannot work with private website (eventPIN)")_". <BR>"
		}
		do ##class(setup.objEventSetting).setParameter("website","private website my account",0,eventID)
		
		do ##class(setup.objEventSetting).setParameter("my registration pages","show sessions",0,xEventID)
		do ##class(setup.objEventSetting).setParameter("my registration pages","show my booking Details",0,xEventID)
	}
	// if we are only doing accommodation bookings then unset the day selection (on by default for new events)
	if ##class(setup.objEventSetting).getParameter("bookings","only accommodation bookings",eventID) {
		do ##class(setup.objEventSetting).setParameter("page order","choose days",0,eventID)
		// obviously make sure we allow accom bookings
		do ##class(setup.objEventSetting).setParameter("bookings","allow accommodation bookings",1,eventID) 
		// turn off email functionality to be consistent as the "diagramG" is not specifically checking the email flag
		do ##class(setup.objEventSetting).setParameter("system","do not use email",1,eventID)
		// turn off group bookings too
		do ##class(setup.objEventSetting).setParameter("bookings","allow group bookings",0,eventID)
		// cannot have either private event personal modes
		set objEvent.privateEvent=0
		do ##class(setup.objEventSetting).setParameter("website","private website my account",0,eventID)
		// show message to user
		set %session.Data("eventsforce","backend","eventSettings.csp","errmsg")=$G(%session.Data("eventsforce","backend","eventSettings.csp","errmsg"))
	}
		
	// check if multiple attendee categories are active for Award events and reset them to have only one category.
	if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",eventID) {
		set tmp=""
		if ##class(setup.lnkCategoryEvent).numCategories(eventID,1,1)>1 {
			do ##class(setup.lnkAttendeeCategoryDetailsEvent).deactivateAllCategoriesExceptDefault(eventID)
			// show message to user
			set %session.Data("eventsforce","backend","eventSettings.csp","errmsg")=$G(%session.Data("eventsforce","backend","eventSettings.csp","errmsg"))_##class(shared.pCSP).translateAdmin("For Award events, multiple attendee categories cannot be active. So, the non-default categories have been deactivated.")_". <BR>"
		}
	}
	// =====================================================================================================================================
	do objEvent.%Save()	
	quit out
]]></Implementation>
</Method>

<Method name="isItemInPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,itemNameDesc</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set eventID=##class(sc.methods).getEventIDfromPageID(pageID)
	// get the ID first
	set itemNameID=##class(cod.objItemName).getIDFromDescriptionAndEvent(itemNameDesc,eventID)
	
	// find the cod item in this page
	set found=0
	&SQL(SELECT ID FROM sc_xModules.objCODitem WHERE (parent->parent=:pageID) AND (active=1) AND (objItemName=:itemNameID) AND (isDelegate=1) )
	if +SQLCODE=0 set found=1
	
	quit found
]]></Implementation>
</Method>

<Method name="isPrivateEventSet">
<Description>
----------------------------------------------------------------------------------------------------------------------------
returns '1' if private events is set for this event (note that this covers both private event and private website)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set privateEventSet=0
	// check "Registration process only by personal invitation " (used to be called 'Private Event')
	&SQL(SELECT privateEvent INTO :tmp FROm setup.objEvent WHERE ID = :xEventID)
	if +SQLCODE=0,tmp=1 set privateEventSet=1
	
	// check "Website and registration process by personal invitation " (used to be called 'event PIN')
	if ##class(setup.objEventSetting).getParameter("website","private website",xEventID) set privateEventSet=1
	
	// check "Website and registration process only using a shared invitation code" (used to be called 'Private Website')
	if ##class(setup.objEventSetting).getParameter("website","private website my account",xEventID) set privateEventSet=1
		
	quit privateEventSet
]]></Implementation>
</Method>

<Method name="isPublicEventSet">
<Description>
returns '1' if public events is set for this event (note that this covers both private event and private website)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set publicEventSet='..isPrivateEventSet(xEventID)
	quit publicEventSet
]]></Implementation>
</Method>

<Method name="isPublicEventEnabled">
<Description>
returns '1' if the public events option should be available  (note that this covers both private event and private website)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set publicEventEnabled=1
	quit publicEventEnabled
]]></Implementation>
</Method>

<Method name="isGroupBookingsSet">
<Description>
----------------------------------------------------------------------------------------------------------------------------
returns '1' if group bookings is set for this event</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set groupBookingState=0
	if ##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID) set groupBookingState=1
	if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID) set groupBookingState=0				// not allwoed
	if ##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID) set groupBookingState=0  // not allowed
	if ##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID) set groupBookingState=1     //mandatory
	quit groupBookingState
]]></Implementation>
</Method>

<Method name="isGroupBookingsEnabled">
<Description>
returns '1' if the group bookings option should be available  </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set groupBookingEnabled=0
	// check the module
	if ##class(setup.objSystemTypes).isModuleAllowed("Group Bookings") set groupBookingEnabled=1

	// disable on if we are awards or meetman
	if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID) set groupBookingEnabled=0              // not allowed
	if ##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID) set groupBookingEnabled=0 // not allowed
	
	// overide modules availablity if the event has the setting so they can un-select a disabled module
	if ..isGroupBookingsSet(xEventID) set groupBookingEnabled=1 
	
	quit groupBookingEnabled
]]></Implementation>
</Method>

<Method name="isSingleBookingsSet">
<Description>
returns '1' if single bookings is set for this event </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set singleBookings='..isGroupBookingsSet(xEventID)
	quit singleBookings
]]></Implementation>
</Method>

<Method name="isSingleBookingsEnabled">
<Description>
returns '1' if the single bookings option should be available  </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set singleBookingsEnabled=1
	if ##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID) set singleBookingsEnabled=1
	if ##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID) set singleBookingsEnabled=1
	if ##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID) set singleBookingsEnabled=0
	if +##class(setup.objSystemTypes).isModuleAllowed("Group Bookings")=0 set singleBookingsEnabled=1
	quit singleBookingsEnabled
]]></Implementation>
</Method>

<Method name="isAnonymousModeSet">
<Description>
------------------------------------------------------------------------------------------------------------------------------
returns '1' if anonymous mode is set for this event</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set anonymousModeState=0
	if ##class(setup.objEventSetting).getParameter("system","do not use email",xEventID) set anonymousModeState=1
	if '##class(setup.objSystemTypes).isModuleAllowed("Anonymous mode") set anonymousModeState=0
	
	if ##class(setup.objEventSetting).getParameter("bookings","allow accommodation bookings",xEventID) {
		if ##class(setup.objEventSetting).getParameter("bookings","only accommodation bookings",xEventID) {
			set anonymousModeState=1
		}
	}
	quit anonymousModeState
]]></Implementation>
</Method>

<Method name="isAnonymousModeEnabled">
<Description>
returns '1' if the anonymous mode option should be available  </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set anonymousModEnabled=1
	if ##class(setup.objEventSetting).getParameter("system","do not use email",xEventID) set anonymousModEnabled=1
	if '##class(setup.objSystemTypes).isModuleAllowed("Anonymous mode") set anonymousModEnabled=0
	if '##class(setup.objSetting).getParameter("system","allow no email setting per event") set anonymousModEnabled=0
	quit anonymousModEnabled
]]></Implementation>
</Method>

<Method name="isIdentifiedModeSet">
<Description>
returns '1' if anonymous mode is set for this event </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set identifiedMode='..isAnonymousModeSet(xEventID)
	quit identifiedMode
]]></Implementation>
</Method>

<Method name="isIdentifiedModeEnabled">
<Description>
returns '1' if the anonymous mode option should be available  </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set identifiedModeEnabled=1
	if ##class(setup.objEventSetting).getParameter("bookings","allow accommodation bookings",xEventID) {
		if ##class(setup.objEventSetting).getParameter("bookings","only accommodation bookings",xEventID) {
			set identifiedModeEnabled=0
		}
	}
	quit identifiedModeEnabled
]]></Implementation>
</Method>

<Method name="getGroupBookingsButtonStyle">
<Description>
Returns the correct style of the button depending on what mode are available and the current setting</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set groupBookingsState=##class(setup.eventCreationMethods).isGroupBookingsSet(xEventID)
	set groupBookingsAvailable=##class(setup.eventCreationMethods).isGroupBookingsEnabled(xEventID)
	set singleBookingsState=##class(setup.eventCreationMethods).isSingleBookingsSet(xEventID)
	set singleBookingsAvailable=##class(setup.eventCreationMethods).isSingleBookingsEnabled(xEventID)
	
	set style=""
	if groupBookingsState,singleBookingsAvailable set style="active button|transparent.png"
	if singleBookingsState,groupBookingsAvailable set style="inactive button|transparent.png"
	if singleBookingsState,'groupBookingsAvailable set style="disabled button|lock_disabled.png"
	if groupBookingsState,'singleBookingsAvailable set style="pre-selected button|lock_active.png"

	// lock down the setting if we have any bookings
	if ##class(links.lnkPersonEvent).hasAnyBookings(xEventID) {
		if $P(style,"|",1)="active button" set style="pre-selected button|lock_active.png"
		if $P(style,"|",1)="inactive button" set style="disabled button|lock_disabled.png"
	}
	quit style
]]></Implementation>
</Method>

<Method name="getAnonymousModeButtonStyle">
<Description>
Returns the correct style of the button depending on what mode are available and the current setting</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set anonymousModeState=##class(setup.eventCreationMethods).isAnonymousModeSet(xEventID)
	set anonymousModeAvailable=##class(setup.eventCreationMethods).isAnonymousModeEnabled(xEventID)
	set identifiedModeState=##class(setup.eventCreationMethods).isIdentifiedModeSet(xEventID)
	set identifiedModeAvailable=##class(setup.eventCreationMethods).isIdentifiedModeEnabled(xEventID)
	
	set style=""
	if anonymousModeState,identifiedModeAvailable set style="active button|transparent.png"
	if identifiedModeState,anonymousModeAvailable set style="inactive button|transparent.png"
	if identifiedModeState,'anonymousModeAvailable set style="disabled button|lock_disabled.png"
	if anonymousModeState,'identifiedModeAvailable set style="pre-selected button|lock_active.png"

	// lock down the setting if we have any bookings
	if ##class(links.lnkPersonEvent).hasAnyBookings(xEventID) {
		if $P(style,"|",1)="active button" set style="pre-selected button|lock_active.png"
		if $P(style,"|",1)="inactive button" set style="disabled button|lock_disabled.png"
	}
	quit style
]]></Implementation>
</Method>

<Method name="getEventStatusForDisplay">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventStatusRaw</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=$CASE(eventStatusRaw
		,"live":"Live"
		,"archived":"Archived"
		,"cancelled":"Cancelled"
		,:"Not Live"
	)
	quit out
]]></Implementation>
</Method>

<Method name="createAwardsFTPpath">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<Implementation><![CDATA[
	set FTPpath=##class(setup.objSetting).getParameter("awards","FTP path")
	if $E(FTPpath,1)'="/" set FTPpath="/"_FTPpath
	if $E(FTPpath,$L(FTPpath))'="/" set FTPpath=FTPpath_"/"
	
	set clientName=^%ZCSPAPPS($ZCVT($ZNSPACE,"U"))
	set FTPpath=FTPpath_clientName_"/"_"event_"_eventID_"/"
	
	do ##class(setup.objEventSetting).setParameter("awards","file FTP path",FTPpath,eventID)
	
	quit
]]></Implementation>
</Method>

<Method name="createAwardsWebPath">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<Implementation><![CDATA[
	set path=##class(setup.objSetting).getParameter("awards","web path")
	if $E(path,1)'="/" set path="/"_path
	if $E(path,$L(path))'="/" set path=path_"/"
	
	set cspAppName=^%ZCSPAPPS($ZNSPACE)
	set path="/"_cspAppName_"/media"_path_cspAppName_"/"_"event_"_eventID_"/" // eg. 'GLA/media/awards/event_12/'
	
	do ##class(setup.objEventSetting).setParameter("awards","file web path",path,eventID)
	
	quit
]]></Implementation>
</Method>

<Method name="isEventNameValid">
<ClassMethod>1</ClassMethod>
<FormalSpec>inDesc</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set isValid=0
	
	// Don't allow the following ~|<>"
	
	if inDesc=$ZSTRIP(inDesc,"*C","~|<>""") set isValid=1
	if ##class(shared.pageMethods).hasStringBeenSanitisedForCrossSiteScripting(inDesc) {
		set isValid=0	
	}
	quit isValid
]]></Implementation>
</Method>
</Class>


<Class name="setup.objPageNav">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: setup.objPageNav.CLS/EV.121
;vc; Component: CLS.setup.objPageNav
;vc;  Location: LargeDev
;vc; Date/Time: 19-Jan-17 10:10
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>setup.objPageNav.CLS/EV.121</td><td>CLS.setup.objPageNav</td><td>LargeDev</td><td style='white-space: nowrap;'>19-Jan-17 10:10</td><td>FredG</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<ClassType/>
<ProcedureBlock>0</ProcedureBlock>
<TimeChanged>64310,37453.696686</TimeChanged>
<TimeCreated>60342,57889.659835</TimeCreated>

<Method name="goWhere">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename:%String,overrideForward:%String,tempPersonID:%String,extraPageID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	
	// THIS METHOD IS USED ON ALL REGISTRATION PAGES IN THE FRONTEND TO DETERMINE WHAT SHOULD BE ON THE BACK BUTTON AND FORWARD/PROCEED/REDIRECT BUTTONS
	
	// pagename = the current csp page or pageID - if pageID then it is converted into template filename
	// overrideForward = if we using a tabbed browsing then this will be used to jump straight to a page after saving current one
	// tempPersonID = passed in to get some optional info from temp structure. Also to put onto the end of some URLs (possibly).
	// extraPageID = if we are in codformsave then we do not know which reg pageID we were just in, so it is passed in here
	
	// page order is:
	//     registerNew
	//     registerStart
	//     (tSelectBookingMode)
	//     (tSelectPersonCategory)  - if not used below
	//     (selectCategorySave) - if not used above
	//  booker:
	//     registerEmail
	//     (tBooker)
	//     (bookerSave)
	//  delegate:
	//     (tDelegateUID)
	//     (tSelectPersonCategory) - if not used above
	//     (selectCategorySave) - if not used above
	//     tRegistration   } loop between for as many reg pages as there are for a category
	//     codFormSave     }
	//     tChooseDays
	//     chooseDays2
	//     tChooseItems
	//     chooseItems2  
	//     tVenueSummary
	//     accomSaveVenueID
	//     tHotelBooking
	//     hotelBookingSave
	//     tTableGuests
	//     tableGuestSave
	// other:
	//     tbasket
	//     payments



	
	new backpage,forwardpage,pageID,backforward,tempPurchaseID,loggedInPersonID, eventConfiguration
	
	set pagename=$G(pagename)
	if pagename="" quit ""
	set pagename=$ZCVT(pagename,"L")
	// if proweb page, extract just the pageID from the url
	if pagename["pageID=" set pagename=$P($P(pagename,"pageID=",2),"&",1)

	// this is used to force going to a certain page (for example if we have tabbed browsing)
	set overrideForward=$G(overrideForward)
	set tempPersonID=$G(tempPersonID)
	
	set sessionID=%session.SessionId
	set tempPurchaseID=##class(eCom.tempPurchase).getID(sessionID)
	
	// get the eventID
	set xEventID=$G(%session.Data("eventsforce","frontend","xEventID"))
	set xLangID=$G(%session.Data("eventsforce","frontend","xPrefLangID"))
	if xLangID="" set xLangID=$G(%session.Data("eventsforce","frontend","xLangID"))
	if 'xEventID set xEventID=$G(%session.Data("eventsforce","backend","xEventID"))
	if 'xLangID set xLangID=$G(%session.Data("eventsforce","backend","xLangID"))
	set extraBit=""
	if xLangID'=1 set extraBit=" - "_##class(shared.objLanguage).getLanguageDesc(xLangID)
	set eventConfiguration = ##class(setup.eventConfiguration).createForEventID(xEventID)
	set websiteLanguage = eventConfiguration.websiteLanguages.getWebsiteLanguage(xLangID)
	

	// is this a backend booking
	set backendBooking=+##class(eCom.tempPurchase).isBackendBooking(sessionID)
	// is this an amendment (all amendments use this flag)
	set amendMode=+$G(%session.Data("eventsforce","frontend","amend"))
	
	// this should replace the use of "amendMode". As soon as someone has seen the basket, then page nav is like amendments
	set seenBasket=0,awardsBooking=0
	&SQL(SELECT seenBasket,isAwards INTO :tmp,:tmp2 FROM eCom.tempPurchase WHERE sessionID = :sessionID)
	if +SQLCODE=0 set seenBasket=+tmp,awardsBooking=tmp2

	set (menuPageID,homePageID,bannerPageID)=""
	&SQL(SELECT menuPageID,homePageID,bannerPageID INTO :tmp,:tmp2,:tmp3 FROM setup.objEventDetails WHERE (objEvent = :xEventID) AND (objLanguage = :xLangID) )	
	if +SQLCODE=0 set menuPageID=tmp,homePageID=tmp2,bannerPageID=tmp3

	set selectBookingModePageID=##class(setup.objEventSetting).getParameter("bookings","selectBookingModePageID"_extraBit,xEventID)
	set bookersPageID=##class(setup.objEventSetting).getParameter("bookings","bookerRegPageID"_extraBit,xEventID)
	set delegateUIDPageID=##class(setup.objEventSetting).getParameter("bookings","delegateUIDPageID"_extraBit,xEventID)
	set selectCategoryPageID=##class(setup.objEventSetting).getParameter("bookings","SelectPersonCategoryPageID"_extraBit,xEventID)
	set tableBookingPageID=##class(setup.objEventSetting).getParameter("bookings","Table Guests PageID"_extraBit,xEventID)
	
	set chooseDaysPageID=##class(setup.objEventSetting).getParameter("bookings","Choose Days PageID"_extraBit,xEventID)
	
	if eventConfiguration.getAgendaViewUseInRegistrationProcess() {
		set chooseSessionsPageID = websiteLanguage.getAgendaViewRegistrationPageID()
	} else {
		set chooseSessionsPageID=##class(setup.objEventSetting).getParameter("bookings","Choose Sessions PageID"_extraBit,xEventID)
	}
	set registerEmailAmendPageID=##class(setup.objEventSetting).getParameter("bookings","Register Email Amend PageID"_extraBit,xEventID)
	set registerEmailNewPageID=##class(setup.objEventSetting).getParameter("bookings","Register Email New PageID"_extraBit,xEventID)
	set basketPageID=##class(setup.objEventSetting).getParameter("bookings","Basket PageID"_extraBit,xEventID)
	set meetManLoginPageID=##class(setup.objEventSetting).getParameter("meeting manager pages","Login PageID"_extraBit,xEventID)
	set eventHotelID=$G(%session.Data("eventsforce","frontend","hotel","eventHotelID"))   // stored in the session in accomSaveVenueID.csp
	set eventHotelPageID=""
	if eventHotelID set eventHotelPageID=##class(accom.objEventHotel).getHotelBookingPageID(eventHotelID)
	set bookingSummaryPageID=##class(setup.objEventSetting).getParameter("Booking Summary","bookingSummaryPageID"_extraBit,xEventID)
	
	
	set multiCategoryPerBooking=+##class(setup.objEventSetting).getParameter("bookings","allow multi categories per booking",xEventID)
	// get all the pages for each category
	kill allRegPages,allRegPageIDs
	set showMeetingProfilePages=0
	if ##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID) {
		if '##class(cod.objCondition).conditionMetForTempPerson("meetingOptOutIf",tempPersonID,xEventID) {
			set showMeetingProfilePages=1
		}
	}
	set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xLangID,backendBooking,.allRegPages,.allRegPageIDs,,showMeetingProfilePages,tempPersonID)
	
	// gets (or determines and sets) the booking mode  (make lowercase to avoid any issues)
	set selectBookingMode=$ZCVT(##class(eCom.tempPurchase).getBookingMode(sessionID),"L")

	// get the category (gets it from person or purchase or creates or returns blank if we will show the page to ask for it)
	set eventCategoryID=##class(eCom.tempPurchase).getEventCategory(sessionID,tempPersonID,xLangID)  // this sets it too if it can
	set preSelectedEventCategory=0
	// Set a flag if the category is invitation only as this should then skip the attendee category page
	if ##class(setup.objSystemTypes).isModuleAllowed("Attendee Categories - Invitation Only") {
		if eventCategoryID {
			if ##class(setup.lnkAttendeeCategoryDetailsEvent).isInvitationOnly(xEventID,eventCategoryID) {
				set preSelectedEventCategory=1
			}
		}
	}
	
	// is the current person the booker?
	set personIsBooker=0
	if tempPersonID	{
		&SQL(SELECT isBooker INTO :tmp FROM eCom.tempPerson WHERE ID=:tempPersonID )
		if +SQLCODE=0 set personIsBooker=+tmp
	}
	
	// are we doing hotel bookings for this event? (and do we have any venues setup for this event)
	set firstVenuePageID="",isAccom=0
	if ##class(setup.objEventSetting).getParameter("bookings","allow accommodation bookings",xEventID)	{
		// get the first venuepageID (the rest will also be displayed in this page)
		set firstVenuePageID=##class(accom.objEventHotel).getFirstVenuePageID(xEventID)
		if firstVenuePageID set isAccom=1
	}
	set accomOnlyEvent=0
	if ##class(setup.objEventSetting).getParameter("bookings","only accommodation bookings",xEventID) set accomOnlyEvent=1
	set (showAccom,newAccomEvent,hasAccom)=0
	set (accomChooseDatesPageID,accomHotelListPageID,accomGuestPageID,accomEditPageID)=""
	if isAccom {
		set newAccomEvent=##class(setup.objEventSetting).getParameter("bookings","use new accommodation page flow",xEventID)
		if newAccomEvent {
			set accomChooseDatesPageID=##class(setup.objEventSetting).getParameter("accommodation pages","Accom Choose Dates PageID"_extraBit,xEventID)
			set accomHotelListPageID=##class(setup.objEventSetting).getParameter("accommodation pages","Accom Hotel List PageID"_extraBit,xEventID)
			set accomGuestPageID=##class(setup.objEventSetting).getParameter("accommodation pages","Accom Guest PageID"_extraBit,xEventID)
			set accomEditPageID=##class(setup.objEventSetting).getParameter("accommodation pages","Accom Edit PageID"_extraBit,xEventID)
			// showAccom zero accom is switched off for delegate or booker

			// only run on delegate page
			set showAccom=##class(cod.objCondition).conditionMetForTempPerson("bookAccomIf",tempPersonID,xEventID,1)
			if ##class(setup.objEventSetting).getParameter("accommodation","only backend users can book accommodation",xEventID) {
				if '##class(eCom.tempPurchase).isBackendBooking(%session.SessionId) {
					set showAccom=0
				}
			}
			&SQL(SELECT ID INTO :tmp FROM accom.tempPersonBooking WHERE tempPerson = :tempPersonID AND active=1)
			if +SQLCODE=0,tmp set hasAccom=1
		}
	}

	set anyAccomBookingsForPerson=0
	if isAccom,tempPersonID	{
		// do we have any accom bookings for the current person?	
		&SQL(SELECT roomTypeInstanceID INTO :tmp FROM accom.tempRoomTypeBooking WHERE (tempPersonBooking->active=1) AND (tempPersonBooking->tempPerson=:tempPersonID) )
		if +SQLCODE=0 {
			// get the eventHotel and store in session and var so we know where to go to
			set roomTypeInstanceID=tmp
			set roomData=##class(accom.objRoomTypeInstance).getVenueRoomAndDateIDs(roomTypeInstanceID)
			set eventHotelID=$p(roomData,"|",4)
			set %session.Data("eventsforce","frontend","hotel","eventHotelID")=eventHotelID
			if eventHotelID {
				set eventHotelPageID=##class(accom.objEventHotel).getHotelBookingPageID(eventHotelID)
				set anyAccomBookingsForPerson=1
			}
		}
	}
	
	// are we doing table bookings?
	set isTableBooking=0
	if ##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID) set isTableBooking=1
	
	// is this a session event?
	set (sessionBookingMode,count,freebie)=0
	set sessionAmendmentMode="basket"
	set eventConfiguration=##class(setup.eventConfiguration).createForEventID(xEventID)
	if (eventConfiguration.areSessionsAllowed()) && ('backendBooking) {
		new dayNumber // dynamic scope is screwing up agenda page
		// add switch to select which page to see first during amendment
		 if ##class(setup.objEventSetting).getParameter("system","session amendment mode",xEventID)="session selection" set sessionAmendmentMode="session selection"
		
		// not reliable enough a check - need to check for system/internal/active sessions
		set sqlStatement=##class(%SQL.Statement).%New()
		kill sqlParams
		set query="SELECT ID, objItem->dayNumber FROM setup.objItemDetails"
		set query=query_" WHERE (objItem->active = '1') AND ((objItem->guestCanBook = 1) OR (objItem->delegateCanBook = 1))"
		if (xLangID) {
			set query=query_"AND (objLanguage = ?)"
			set sqlParams($I(sqlParams))=xLangID
		}
		set query=query_" AND (objItem->objEvent = ?) AND (objItem->objSessionType->isSystem = 0) "
		set sqlParams($I(sqlParams))=xEventID
		if '$G(%session.Data("eventsforce","frontend","xUserID")) set query=query_" AND (objItem->internalOnly <> 1) "
		set sc=sqlStatement.%Prepare(query)
		set rs=sqlStatement.%Execute(sqlParams...)
		while rs.%Next()	{
			set itemID=rs.%Get("ID")
			set dayNumber=rs.%Get("dayNumber")
			set allowedToSee=1
			if (allowedToSee) {
				// check the day item too (as that will override all)
				set tmpDayItemID=##class(setup.objItem).getDayItemID(xEventID,dayNumber)
				set allowedToSee=+##class(setup.lnkEventCategoryItem).allowMyAccount(xEventID,tempPersonID,tmpDayItemID)
			}
			if (allowedToSee) {
				set count=$I(count)
			
				//now check if the session has prices or discounts attached
				//this data is used in the event that the booking amendment period is closed but session amendment period is open
				set delegateBasketItemID=##class(setup.objItem).getDelegateBasketItemID(itemID,eventCategoryID)
				set currencyID=+##class(eCom.tempPurchase).getCurrencyID(sessionID)
				&SQL(SELECT * FROM ecom.lnkItemDiscount WHERE objBasketItem = :delegateBasketItemID)
				if ( (+($ZSTRIP(##class(eCom.objBasketItem).getPrice(xEventID,delegateBasketItemID,,currencyID,1,1),"*E'N")=0))!(+SQLCODE=100)){
					set freebie=$I(freebie)
				}
			}
		}
		if (count) {
			// event has sessions - can we amend them
			set sessionBookingMode=1
			
			if ($G(%session.Data("eventsforce","frontend","amend"))) {
				// amend mode - check we're allowed to amend session bookings
				// first check reg amendment
				if ('##class(setup.eventBookingMethods).areFrontendAmendmentsAllowed(xEventID)) {
					// no reg amendment - can we do limited session amendment?
					if (##class(setup.eventBookingMethods).areFrontendSessionAmendmentsAllowed(xEventID)) {
							// yes, we can!
							// but only if no prices or discounts attached...
						if (freebie=0) {
							set sessionBookingMode=0
						}
					} else {
						set sessionBookingMode=0
					}
				}
			}
		}
	}
	
	
	
	
	// ################################################################################################
	// ################################################################################################
	//            These parameters decide which of the frontend flow diagrams we are using
	set isSSOSAML2=0
	if ##class(setup.webSSOmethods).isWebSSOAllowedForFrontend(xEventID) {
		if ##class(setup.webSSOmethods).isUsingSSOForThisRegistration() {
			set isSSOSAML2=1
		}
	}

	set isTicketingPersonMode=+##class(cod.objTicket).isTicketingPersonMode(xEventID)
	set isGroupBookings=+##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)
	set isAnonymousMode=+##class(setup.objEventSetting).getParameter("system","do not use email",xEventID)
	set singleEmailPerEvent=0
	if isAnonymousMode {
		//New mode - singleEmailPerEvent - like anonymous but with unique email address per event. Page flow should include tRegisterEmailNew.csp
		set singleEmailPerEvent=##class(setup.objEventSetting).getParameter("system","anonymous - single email per event",xEventID)
	}
	// multicatregpages = do we have more than one category to ask the delegate
	//  - NOT do we have more than one reg page per category as that's always allowed
	set isMultiCategoryRegPages=+(##class(setup.lnkCategoryEvent).numCategories(xEventID,xLangID,+backendBooking)>1)
	// If we have an invitation only category then the pages should act as though in single categroy mode
	if (preSelectedEventCategory) && ('backendBooking) set isMultiCategoryRegPages=0
	
	set isAwards=+awardsBooking
	set diagram=""
	if (isGroupBookings=0)&(isMultiCategoryRegPages=0) set diagram="A"	// based on event settings
	if (isGroupBookings=1)&(isMultiCategoryRegPages=0) set diagram="B"	// based on event settings
	if (isGroupBookings=0)&(isMultiCategoryRegPages=1) set diagram="C"	// based on event settings
	if (isGroupBookings=1)&(isMultiCategoryRegPages=1) set diagram="D"	// based on event settings
	if isAwards=1 {
		set diagram="E"					// regular awards
		if ##class(setup.objEventSetting).getParameter("awards","use sections",xEventID) set diagram="H" // the US/UK awards with sections
	}
	if accomOnlyEvent=1,isAccom set diagram="G"				// based on event setting
	if isTableBooking {
		set diagram="I"
	}
	if isTicketingPersonMode,isGroupBookings set diagram="J"  // can only do this using bookers page
	if accomOnlyEvent=1,newAccomEvent set diagram="K" // new accommodation page flow
	
	set loggedInPersonID=##class(EF.security.websiteAccessHandler).getCurrentRegistrationPersonID(xEventID)
	// ################################################################################################
	// ################################################################################################
	set prowebRoot=..getProwebRoot()
	set normalRoot="../../frontend/reg/"
	// if numeric pagename, it will be a pageID, so determine which template and also change the root to jump up one more level
	set originalPageID=""
	if pagename	{
		set tmpTemplate=##class(sc.xModules.objPage).getTemplateFile(pagename)
		set originalPageID=pagename,pagename=$ZCVT($P(tmpTemplate,"/",$L(tmpTemplate,"/")),"L")
		set normalRoot="../../frontend/reg/"
	}
	
	if ##class(setup.objEvent).isEventUsingProweb2(xEventID) {
		set pagename = ..convertProceedKeyFromProweb2ToProweb1(pagename,originalPageID)	
	}
	
	// if the override is numeric then make it a proweb link
	if overrideForward set overrideForward=prowebRoot_overrideForward
	set overridePersonID=""
	set backforward=..goWhere2()
	// allow for the methods lower down to change the tempPersonID - for example if new person after bookers page
	if $L(overridePersonID) set tempPersonID=overridePersonID
	if $L(tempPersonID)	{
		// should ignore if backpage=""
		if $P(backforward,"|",1)'="" {
			set $P(backforward,"|",1)=$P(backforward,"|",1)_$S($P(backforward,"|",1)["?":"&",1:"?")_"tempPersonID="_tempPersonID
		}
		set $P(backforward,"|",2)=$P(backforward,"|",2)_$S($P(backforward,"|",2)["?":"&",1:"?")_"tempPersonID="_tempPersonID
	}
	set ^xPageNav(+$H,%session.SessionId,$I(^xPageNav(+$H,%session.SessionId)),"diagram")=diagram
	set ^xPageNav(+$H,%session.SessionId,^xPageNav(+$H,%session.SessionId),"pagename")=pagename
	set ^xPageNav(+$H,%session.SessionId,^xPageNav(+$H,%session.SessionId),"back")=$P(backforward,"|",1)
	set ^xPageNav(+$H,%session.SessionId,^xPageNav(+$H,%session.SessionId),"forward")=$P(backforward,"|",2)
	quit backforward
]]></Implementation>
</Method>

<Method name="goWhere2">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	new okToBook

	// ########################################################################
	// ########################################################################
	// #####                                                            #######
	// #####          NOW FOR THE ACTUAL PAGE NAVIGATION CODE           #######
	// #####                                                            #######
	// ########################################################################
	// ########################################################################
	if (pagename="registernew.csp")!(pagename="chooselanguage.csp") {
		set forwardpage=""
		// do all the registration allowed checks here now instead of in registerEmailNew

		set controllerID=##class(setup.objEvent).getControllerID(xEventID)
		set objEvent=##class(setup.objEvent).%OpenId(xEventID)

		// old style - can see website but cannot reg unless on pre-reg
		set isPrivateEvent=objEvent.privateEvent
		// new style - eventPIN cannot see website unless logged in; one eventPIN=one person and one event only; have to be on preReg
		set isPrivateWebsitePIN=##class(setup.objEventSetting).getParameter("website","private website my account",xEventID)
		// anonymous code entry: set up a code in event settings and enter it to see website (semi-restricted access but not personal)
		set isPrivateWebsiteCODE=##class(setup.objEventSetting).getParameter("website","private website",xEventID)
		
		// if logged in then have to do this check here as we do not go to registerEmailNew2
		if loggedInPersonID	{
			// has this person already registered for THIS EVENT?
			set purchaseID=##class(setup.objEvent).isBooked(xEventID,loggedInPersonID,sessionID)
			set isAwards=##class(eCom.tempPurchase).isAwardsBooking(sessionID)
		
			if purchaseID	{
				// we must ignore any tempPersonID created by registerNew
				set tempPersonID=""
				
				// check if we are allowed to amend today
				set allowAmend=0
				set curdate=+$H
				if ##class(setup.eventBookingMethods).areFrontendAmendmentsAllowed(xEventID) set allowAmend=1
				if ##class(setup.objEventSetting).getParameter("my registration pages","show my registration pages",xEventID) set allowAmend=1
				if allowAmend {
					// Redirect them to the amend page
					set forwardpage="registerAmend.csp"
				} else {
					set forwardpage="registrationEnded.csp?er=alreadybooked&errTextOnly=1"
				}
			}
		}
		
		// check if we are allowed to register
		if forwardpage=""	{
			if '##class(eCom.tempPurchase).isBackendBooking(sessionID) && '$Get(%session.Data("inSitePageEditing")) {
				if '##class(setup.eventBookingMethods).areFrontendRegistrationsAllowed(xEventID) {
					set forwardpage="registrationEnded.csp?er=date"
				}
			}
		}

		// is the event full or any day available for booking?
		if forwardpage=""	{
			set okToBook=##class(setup.eventBookingMethods).isOKToStartNewBooking(eventConfiguration,tempPurchaseID)
			if 'okToBook {
				set forwardpage=..getNextPageFromOKToBookStatus(okToBook)
			}
		}	

		// check if we have access to any registration pages and if not then stop now to avoid a crash later
		if forwardpage=""	{
			set noRegPages=0
			// exclude awards becuase they might not have any active categories
			if '$D(allRegPages) set noRegPages=1
			if noRegPages	{
				set forwardpage="registrationEnded.csp?er=noregpages"
			}
		}
		
		if (forwardpage="")&&(isSSOSAML2) {
			set forwardpage="registerEmailNew2.csp"
		}

		if diagram="A"	{
			set backpage=prowebRoot_homePageID
			if eventCategoryID="" quit ..quitIfNoAttCat()

			if forwardpage="",loggedInPersonID	{
				// go to the first (and only category) reg page
				set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)

				// load up the data we have into the tempPerson (also stores personID)
				set personID=loggedInPersonID
				do ##class(eCom.tempPerson).getCODdata(sessionID,xEventID,personID,tempPersonID)
				set okToBook=..isOKToStartWithPreselectedCategory(eventConfiguration,tempPersonID,xLangID)
				if 'okToBook {
					if 'okToBook {
						set forwardpage=..getNextPageFromOKToBookStatus(okToBook)
					}
				}
			}
			 
			if forwardpage="",isAnonymousMode,'singleEmailPerEvent	{
				// go to the first (and only category) reg page
				set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)
			}
			
			if forwardpage="" set forwardpage=prowebRoot_registerEmailNewPageID
		}
		if diagram="B"	{
			set backpage=prowebRoot_homePageID
			if forwardpage="" set forwardpage=prowebRoot_selectBookingModePageID
		}
		if diagram="C"	{
			set backpage=prowebRoot_homePageID

			if forwardpage="",loggedInPersonID	{
				set forwardpage=prowebRoot_selectCategoryPageID

				// load up the data we have into the tempPerson (also stores personID)
				set personID=loggedInPersonID
				do ##class(eCom.tempPerson).getCODdata(sessionID,xEventID,personID,tempPersonID)
				
				// If we are already assigned to a invitation only attendee category, we should go to the first registration page (like diagram A)
				set eventCategoryID=##class(eCom.tempPurchase).getEventCategory(sessionID,tempPersonID,xLangID)
				if eventCategoryID {
					set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)
				}
				
				set okToBook=..isOKToStartWithPreselectedCategory(eventConfiguration,tempPersonID,xLangID)
				if 'okToBook {
					set forwardpage=..getNextPageFromOKToBookStatus(okToBook)
				}
			}
	
			if forwardpage="",isAnonymousMode,'singleEmailPerEvent	{
				set forwardpage=prowebRoot_selectCategoryPageID
			}

			if forwardpage="" set forwardpage=prowebRoot_registerEmailNewPageID
		}
		if diagram="D"	{
			set backpage=prowebRoot_homePageID
			if forwardpage="" set forwardpage=prowebRoot_selectBookingModePageID
		}
		if (diagram="E")!(diagram="H")	{
			if forwardpage="",loggedInPersonID	{
				set forwardpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","awardClientPageID",xEventID)

				// load up the data we have into the tempPerson (also stores personID)
				set personID=loggedInPersonID
				do ##class(eCom.tempPerson).getCODdata(sessionID,xEventID,personID,tempPersonID)
			}
			set backpage=prowebRoot_homePageID 
			if forwardpage="",isAnonymousMode,'singleEmailPerEvent	{
				set forwardpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","awardClientPageID",xEventID)
			}
			if forwardpage="" set forwardpage=prowebRoot_registerEmailNewPageID
		}
		if diagram="G"	{
			set backpage=prowebRoot_homePageID 
			if forwardpage="" set forwardpage=prowebRoot_firstVenuePageID
		}
		if diagram="I"	{
			set backpage=prowebRoot_homePageID

			if forwardpage="",loggedInPersonID	{
				set forwardpage=prowebRoot_bookersPageID

				// load up the data we have into the tempPerson (also stores personID)
				set personID=loggedInPersonID
				do ##class(eCom.tempPerson).getCODdata(sessionID,xEventID,personID,tempPersonID)
			}
	
			if forwardpage="",isAnonymousMode,'singleEmailPerEvent	{
				set forwardpage=prowebRoot_bookersPageID
			}

			if forwardpage="" set forwardpage=prowebRoot_registerEmailNewPageID

		}
		if diagram="J"	{
			set backpage=prowebRoot_homePageID
			if forwardpage="" {
				if loggedInPersonID	{
					set forwardpage=prowebRoot_bookersPageID

					// load up the data we have into the tempPerson (also stores personID)
					set personID=loggedInPersonID
					do ##class(eCom.tempPerson).getCODdata(sessionID,xEventID,personID,tempPersonID)
				} elseif isAnonymousMode,'singleEmailPerEvent	{
					set forwardpage=prowebRoot_bookersPageID
				} else {				
					set forwardpage=prowebRoot_registerEmailNewPageID
				}
			}
		}
		if diagram="K"	{
			set backpage=prowebRoot_homePageID
			if forwardpage="" {
				if isMultiCategoryRegPages {
					set forwardpage=prowebRoot_selectCategoryPageID
				} else {
					set forwardpage=prowebRoot_accomChooseDatesPageID
				}
			}
		}
		if pagename'="chooselanguage.csp" {
				if ##class(setup.objSystemTypes).isModuleAllowed("Multi Lingual Frontend"),##class(eCom.tempPurchase).isBackendBooking(sessionID) {
				set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
				do rs.Prepare("SELECT * FROM shared.objLanguage WHERE active = 1")
				do rs.Execute()
				set count=0
				while rs.Next() {
					if ##class(setup.objEventSetting).getParameter("frontend languages",rs.Get("description"),xEventID)  {
						set count=count+1
					}
				}
				if count>1 set forwardpage="chooseLanguage.csp"
			}
		}
		
		
		quit backpage_"|"_forwardpage

	} elseif pagename="registeramend.csp"	{
		set forwardpage="",backpage=""
		
		if (forwardpage="")&&(isSSOSAML2) {
			set forwardpage="registerEmailAmend2.csp"
		}
		if forwardpage="" {
			if diagram="A"	{
				set backpage=prowebRoot_homePageID
				if ##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID),$G(%session.Data("eventsforce","frontend","meetingManOnly")) {
					set forwardpage=prowebRoot_meetManLoginPageID
				} else {
					set forwardpage=prowebRoot_registerEmailAmendPageID
				}
			}
			if diagram="B"	{
				set backpage=prowebRoot_homePageID 
				set forwardpage=prowebRoot_registerEmailAmendPageID
			}
			if diagram="C"	{
				set backpage=prowebRoot_homePageID 
				if ##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID),$G(%session.Data("eventsforce","frontend","meetingManOnly")) {
					set forwardpage=prowebRoot_meetManLoginPageID
				} else {
					set forwardpage=prowebRoot_registerEmailAmendPageID
				}
			}
			if diagram="D"	{
				set backpage=prowebRoot_homePageID 
				set forwardpage=prowebRoot_registerEmailAmendPageID
			}
			if (diagram="E")!(diagram="H")	{
				set backpage=prowebRoot_homePageID 
				set forwardpage=prowebRoot_registerEmailAmendPageID
			}
			if diagram="G"	{
				set backpage=prowebRoot_homePageID 
				set forwardpage=prowebRoot_registerEmailAmendPageID
			}
			if diagram="I" {
				set backpage=prowebRoot_homePageID 
				set forwardpage=prowebRoot_registerEmailAmendPageID
			}
			if diagram="J" {
				set backpage=prowebRoot_homePageID 
				set forwardpage=prowebRoot_registerEmailAmendPageID
			}
			if diagram="K" {
				set backpage=prowebRoot_homePageID 
				set forwardpage=prowebRoot_registerEmailAmendPageID
			}
		}
		quit backpage_"|"_forwardpage

	} elseif pagename="amendpreparesession.csp"	{ 
		set myRegDetailsPage=##class(setup.objEventSetting).getParameter("my registration pages","show my registration pages",xEventID)
		if diagram="A"	{
			set backpage=""
			if myRegDetailsPage,'backendBooking {
				set forwardpage=prowebRoot_bookingSummaryPageID
			} elseif (sessionBookingMode) {
				if sessionAmendmentMode="session selection" {
					set forwardpage=normalRoot_"tChooseItems.csp"
				} else {
					set forwardpage=prowebRoot_basketPageID
				}
			} else {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="B"	{
			set backpage=""
			if (sessionBookingMode) {
				if sessionAmendmentMode="session selection" {
					set forwardpage=normalRoot_"tChooseItems.csp"
				} else {
					set forwardpage=prowebRoot_basketPageID
				}
			} elseif myRegDetailsPage,'backendBooking {
				set forwardpage=prowebRoot_bookingSummaryPageID
			} else {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="C"	{
			set backpage=""
			if myRegDetailsPage,'backendBooking {
				set forwardpage=prowebRoot_bookingSummaryPageID
			} elseif (sessionBookingMode) {
				if sessionAmendmentMode="session selection" {
					set forwardpage=normalRoot_"tChooseItems.csp"
				} else {
					set forwardpage=prowebRoot_basketPageID
				}
			}  else {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		
		if diagram="D"	{
			set backpage=""
			if (sessionBookingMode) {
				if sessionAmendmentMode="session selection" {
					set forwardpage=normalRoot_"tChooseItems.csp"
				} else {
					set forwardpage=prowebRoot_basketPageID
				}
			} elseif myRegDetailsPage,'backendBooking {
				set forwardpage=prowebRoot_bookingSummaryPageID
			} else {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","summaryPageID",xEventID)

		}
		if diagram="G"	{
			set backpage=""
			if (sessionBookingMode) {
				if sessionAmendmentMode="session selection" {
					set forwardpage=normalRoot_"tChooseItems.csp"
				} else {
					set forwardpage=prowebRoot_basketPageID
				}
			} else {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="I"	{
			set backpage=""
			if (sessionBookingMode) {
				if sessionAmendmentMode="session selection" {
					set forwardpage=normalRoot_"tChooseItems.csp"
				} else {
					set forwardpage=prowebRoot_basketPageID
				}
			} else {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="J"	{
			set backpage=""
			if (sessionBookingMode) {
				if sessionAmendmentMode="session selection" {
					set forwardpage=normalRoot_"tChooseItems.csp"
				} else {
					set forwardpage=prowebRoot_basketPageID
				}
			} else {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="K"	{
			set backpage=""
			if (sessionBookingMode) {
				if sessionAmendmentMode="session selection" {
					set forwardpage=normalRoot_"tChooseItems.csp"
				} else {
					set forwardpage=prowebRoot_basketPageID
				}
			} else {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		quit backpage_"|"_forwardpage

	} elseif pagename="tselectbookingmode.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			set backpage=prowebRoot_homePageID
			set forwardpage=normalRoot_"bookingmodesave.csp"
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="D"	{
			set backpage=prowebRoot_homePageID
			set forwardpage=normalRoot_"bookingmodesave.csp"
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="I"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="bookingmodesave.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			set backpage=prowebRoot_selectBookingModePageID
			if loggedInPersonID	{
				set forwardpage=prowebRoot_bookersPageID

				// load up the data we have into the tempPerson (also stores personID)
				set personID=loggedInPersonID
				do ##class(eCom.tempPerson).getCODdata(sessionID,xEventID,personID,tempPersonID)
			} elseif isAnonymousMode,'singleEmailPerEvent	{
				set forwardpage=prowebRoot_bookersPageID
			} else {
				if $G(%session.Data("eventsforce","frontend","single sign on","External Person ID"))'="" {
					set forwardpage=normalRoot_"registerEmailNew2.csp"
				} else {
					set forwardpage=prowebRoot_registerEmailNewPageID
				}
			}
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="D"	{
			set backpage=prowebRoot_selectBookingModePageID
			if multiCategoryPerBooking {
				if loggedInPersonID	{
					set forwardpage=prowebRoot_bookersPageID

					// load up the data we have into the tempPerson (also stores personID)
					set personID=loggedInPersonID
					do ##class(eCom.tempPerson).getCODdata(sessionID,xEventID,personID,tempPersonID)
				} elseif isAnonymousMode,'singleEmailPerEvent	{
					set forwardpage=prowebRoot_bookersPageID
				} else {
					if $G(%session.Data("eventsforce","frontend","single sign on","External Person ID"))'="" {
						set forwardpage=normalRoot_"registerEmailNew2.csp"
					} else {
						set forwardpage=prowebRoot_registerEmailNewPageID
					}
				}
			} else {
				set forwardpage=prowebRoot_selectCategoryPageID
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="tselectpersoncategory.csp"	{

		
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="C"	{
			if isAnonymousMode,'singleEmailPerEvent	{
				set backpage=prowebRoot_homePageID 
			} else {
				set backpage=prowebRoot_registerEmailNewPageID
			}
			set forwardpage=normalRoot_"selectcategorysave.csp"
		}
		if diagram="D"	{
			set forwardpage=normalRoot_"selectcategorysave.csp"
			if multiCategoryPerBooking	{  // we are in the delegate loop 
				// is this person the booker? if so then we can go back to the bookers page
				if (personIsBooker)&((selectBookingMode="single")!(selectBookingMode="singleandothers"))	{
					set backpage=prowebRoot_bookersPageID
				} elseif ##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)	{
					set backpage=prowebRoot_bookersPageID
				} else {
					set backpage=prowebRoot_delegateUIDPageID
				}
			} else {
				set backpage=prowebRoot_selectBookingModePageID
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="K"	{
			set backpage=prowebRoot_homePageID
			set forwardpage=normalRoot_"selectcategorysave.csp"
		}
		
		quit backpage_"|"_forwardpage
		
	} elseif pagename="selectcategorysave.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="C"	{
			set backpage=prowebRoot_selectCategoryPageID
			if eventCategoryID="" {
				set forwardpage=backpage  // if they don't go back to tSelectPersonCategory they don't see the error message
			} else {
				// get first page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""))
				if displayOrder="" {
					set forwardpage=backpage
				} else {
					set pageID=allRegPages(eventCategoryID,displayOrder)
					set forwardpage=prowebRoot_pageID
				}
			}
		}
		if diagram="D"	{
			set backpage=prowebRoot_selectCategoryPageID
			if eventCategoryID="" {
				set forwardpage=backpage  // if they don't go back to tSelectPersonCategory they don't see the error message	
			} elseif multiCategoryPerBooking	{  // we are in the delegate loop 
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get first page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""))
				if displayOrder="" {
					set forwardpage=backpage
				} else {
					set pageID=allRegPages(eventCategoryID,displayOrder)
					set forwardpage=prowebRoot_pageID
				}
			} else {
				if loggedInPersonID	{
					set forwardpage=prowebRoot_bookersPageID

					// load up the data we have into the tempPerson (also stores personID)
					set personID=loggedInPersonID
					do ##class(eCom.tempPerson).getCODdata(sessionID,xEventID,personID,tempPersonID)
				} elseif isAnonymousMode,'singleEmailPerEvent	{
					set forwardpage=prowebRoot_bookersPageID
				} else {
					set forwardpage=prowebRoot_registerEmailNewPageID
				}
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="K"	{
			set backpage=prowebRoot_selectCategoryPageID
			set forwardpage=prowebRoot_accomChooseDatesPageID
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="tregisteremailnew.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=normalRoot_"registeremailnew2.csp"
		}
		if diagram="B"	{
			set backpage=prowebRoot_selectBookingModePageID
			set forwardpage=normalRoot_"registeremailnew2.csp"
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=normalRoot_"registeremailnew2.csp"
		}
		if diagram="D"	{
			set forwardpage=normalRoot_"registeremailnew2.csp"
			if multiCategoryPerBooking	{  // then the select person category page will be lower down so we will go to the select booking mode
				set backpage=prowebRoot_selectBookingModePageID
			} else {
				set backpage=prowebRoot_selectCategoryPageID
			}
		}
		if (diagram="E")!(diagram="H")!(diagram="J")	{
			set backpage=""
			set forwardpage=normalRoot_"registeremailnew2.csp"
		}
		if diagram="G"	{
			set backpage=prowebRoot_eventHotelPageID
			set forwardpage=normalRoot_"registeremailnew2.csp"
		}
		if diagram="I"	{
			set backpage=""
			set forwardpage=normalRoot_"registeremailnew2.csp"
		}
		if diagram="K"	{
			set backpage=prowebRoot_eventHotelPageID
			set forwardpage=normalRoot_"registeremailnew2.csp"
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="registeremailnew2.csp"	{
		set forwardpage=""

		if diagram="A"	{
			set backpage=prowebRoot_registerEmailNewPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// go to the first (and only category) reg page
			set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)
		}
		if diagram="B"	{
			set backpage=prowebRoot_registerEmailNewPageID
			
			if forwardpage="" set forwardpage=prowebRoot_bookersPageID
		}
		if diagram="C"	{
			set backpage=prowebRoot_registerEmailNewPageID

			if forwardpage="" set forwardpage=prowebRoot_selectCategoryPageID
		}
		if diagram="D"	{
			set backpage=prowebRoot_registerEmailNewPageID
			
			if forwardpage="" set forwardpage=prowebRoot_bookersPageID
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=prowebRoot_registerEmailNewPageID

			if forwardpage="" {
				if ##class(setup.objEventSetting).getParameter("awards","use category interest screen",xEventID) {
					set forwardpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","categoryInterestPageID",xEventID)
				} else {
					set forwardpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","awardClientPageID",xEventID)
				}
			}
		}
		if diagram="G"	{
			set backpage=prowebRoot_registerEmailNewPageID
			
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// go to the first (and only category) reg page
			set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)
		}
		if diagram="I"	{
			set backpage=prowebRoot_registerEmailNewPageID
			
			if forwardpage="" set forwardpage=prowebRoot_bookersPageID
		}
		if diagram="J"	{
			set backpage=prowebRoot_registerEmailNewPageID
			if forwardpage="" set forwardpage=prowebRoot_bookersPageID
		}
		if diagram="K"	{
			set backpage=prowebRoot_registerEmailNewPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// go to the first (and only category) reg page
			set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="fplookup.csp"	{  // sandwiched between registeremailnew and registeremailnew2
		if diagram="A"	{
			set backpage=prowebRoot_registerEmailNewPageID
			set forwardpage=normalRoot_"registeremailnew2.csp?comeFromFPLookup=1"
		}
		if diagram="B"	{
			set backpage=prowebRoot_registerEmailNewPageID
			set forwardpage=normalRoot_"registeremailnew2.csp?comeFromFPLookup=1"
		}
		if diagram="C"	{
			set backpage=prowebRoot_registerEmailNewPageID
			set forwardpage=normalRoot_"registeremailnew2.csp?comeFromFPLookup=1"
		}
		if diagram="D"	{
			set backpage=prowebRoot_registerEmailNewPageID
			set forwardpage=normalRoot_"registeremailnew2.csp?comeFromFPLookup=1"
		}
		if (diagram="E")!(diagram="H")!(diagram="J")	{
			set backpage=prowebRoot_registerEmailNewPageID
			set forwardpage=normalRoot_"registeremailnew2.csp?comeFromFPLookup=1"
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="I"	{
			set backpage=prowebRoot_registerEmailNewPageID
			set forwardpage=prowebRoot_bookersPageID
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="enterregcode.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=normalRoot_"enterregcode2.csp"
		}
		if diagram="B"	{
			set backpage=""
			set forwardpage=normalRoot_"enterregcode2.csp"
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=normalRoot_"enterregcode2.csp"
		}
		if diagram="D"	{
			set forwardpage=""
			set forwardpage=normalRoot_"enterregcode2.csp"
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=normalRoot_"enterregcode2.csp"
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage

	} elseif pagename="enterregcode2.csp"	{
		if diagram="A"	{
			set backpage=normalRoot_"enterregcode.csp"
			set forwardpage=prowebRoot_registerEmailNewPageID
		}
		if diagram="B"	{
			set backpage=normalRoot_"enterregcode.csp"
			set forwardpage=prowebRoot_registerEmailNewPageID
		}
		if diagram="C"	{
			set backpage=normalRoot_"enterregcode.csp"
			set forwardpage=prowebRoot_registerEmailNewPageID
		}
		if diagram="D"	{
			set backpage=normalRoot_"enterregcode.csp"
			set forwardpage=prowebRoot_registerEmailNewPageID
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=normalRoot_"enterregcode.csp"
			set forwardpage=prowebRoot_registerEmailNewPageID
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage

	} elseif pagename="trequestpassword.csp"	{
		if diagram="A"	{
			set backpage=normalRoot_"registernew.csp"
			set forwardpage=normalRoot_"registernew.csp" 
			if amendMode {
				set backpage=normalRoot_"registeramend.csp"
				set forwardpage=normalRoot_"registeramend.csp"
			}
		}
		if diagram="B"	{
			set backpage=normalRoot_"registernew.csp"
			set forwardpage=normalRoot_"registernew.csp" 
			if amendMode {
				set backpage=normalRoot_"registeramend.csp"
				set forwardpage=normalRoot_"registeramend.csp"
			}
		}
		if diagram="C"	{
			set backpage=normalRoot_"registernew.csp"
			set forwardpage=normalRoot_"registernew.csp" 
			if amendMode {
				set backpage=normalRoot_"registeramend.csp"
				set forwardpage=normalRoot_"registeramend.csp"
			}
		}
		if diagram="D"	{
			set backpage=normalRoot_"registernew.csp"
			set forwardpage=normalRoot_"registernew.csp" 
			if amendMode {
				set backpage=normalRoot_"registeramend.csp"
				set forwardpage=normalRoot_"registeramend.csp"
			}
		}
		if diagram="E"	{
			set backpage=normalRoot_"registernew.csp"
			set forwardpage=normalRoot_"registernew.csp" 
			if amendMode {
				set backpage=normalRoot_"registeramend.csp"
				set forwardpage=normalRoot_"registeramend.csp"
			}
		}
		if diagram="G"	{
			set backpage=prowebRoot_homePageID
			set forwardpage=prowebRoot_homePageID 
			if amendMode {
				set backpage=prowebRoot_homePageID
				set forwardpage=prowebRoot_homePageID
			}
		}
		if diagram="H"	{
			set backpage=normalRoot_"registernew.csp"
			set forwardpage=normalRoot_"registernew.csp" 
			if amendMode {
				set backpage=normalRoot_"registeramend.csp"
				set forwardpage=normalRoot_"registeramend.csp"
			}
		}
		if diagram="I"	{
			set backpage=normalRoot_"registernew.csp"
			set forwardpage=normalRoot_"registernew.csp" 
			if amendMode {
				set backpage=normalRoot_"registeramend.csp"
				set forwardpage=normalRoot_"registeramend.csp"
			}
		}
		if diagram="J"	{
			set backpage=normalRoot_"registernew.csp"
			set forwardpage=normalRoot_"registernew.csp" 
			if amendMode {
				set backpage=normalRoot_"registeramend.csp"
				set forwardpage=normalRoot_"registeramend.csp"
			}
		}
		if diagram="K"	{
			set backpage=prowebRoot_homePageID
			set forwardpage=prowebRoot_homePageID 
			if amendMode {
				set backpage=prowebRoot_homePageID
				set forwardpage=prowebRoot_homePageID
			}
		}
		quit backpage_"|"_forwardpage

	} elseif pagename="tregisteremailamend.csp"	{
		if diagram="A"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=normalRoot_"registeremailamend2.csp"
		}
		if diagram="B"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=normalRoot_"registeremailamend2.csp"
		}
		if diagram="C"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=normalRoot_"registeremailamend2.csp"
		}
		if diagram="D"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=normalRoot_"registeremailamend2.csp"
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=normalRoot_"registeremailamend2.csp"
		}
		if diagram="G"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=normalRoot_"registeremailamend2.csp"
		}
		if diagram="I"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=normalRoot_"registeremailamend2.csp"
		}
		if diagram="J"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=normalRoot_"registeremailamend2.csp"
		}
		if diagram="K"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=normalRoot_"registeremailamend2.csp"
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="registeremailamend2.csp"	{
		if diagram="A"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			set forwardpage=normalRoot_"amendpreparesession.csp"
			}
		if diagram="B"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			set forwardpage=normalRoot_"amendpreparesession.csp"
		}
		if diagram="C"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			set forwardpage=normalRoot_"amendpreparesession.csp"
		}
		if diagram="D"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			set forwardpage=normalRoot_"amendpreparesession.csp"
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=prowebRoot_registerEmailAmendPageID
			set forwardpage=normalRoot_"amendpreparesession.csp"
		}
		if diagram="G"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			set forwardpage=normalRoot_"amendpreparesession.csp"
		}
		if diagram="I"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			set forwardpage=normalRoot_"amendpreparesession.csp"
		}
		if diagram="J"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			set forwardpage=normalRoot_"amendpreparesession.csp"
		}
		if diagram="K"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			set forwardpage=normalRoot_"amendpreparesession.csp"
		}
		
		quit backpage_"|"_forwardpage
		
	} elseif pagename="tbookingsummary.csp"	{
		// this is currently only compatible with diagrams A,B,C and D
		set objEvent=##class(setup.objEvent).%OpenId(xEventID)
		set allowAmendment=##class(setup.eventBookingMethods).areFrontendAmendmentsAllowed(xEventID)
		if diagram="A"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			if allowAmendment {
				set forwardpage=prowebRoot_basketPageID
			} else {
				set forwardpage=""
			}
		}
		if diagram="B"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			if allowAmendment {
				set forwardpage=prowebRoot_basketPageID
			} else {
				set forwardpage=""
			}
		}
		if diagram="C"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			if allowAmendment {
				set forwardpage=prowebRoot_basketPageID
			} else {
				set forwardpage=""
			}
		}
		if diagram="D"	{
			set backpage=prowebRoot_registerEmailAmendPageID
			if allowAmendment {
				set forwardpage=prowebRoot_basketPageID
			} else {
				set forwardpage=""
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="I"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="J"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="tawardsclient.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="D"	{
			set backpage=""
			set forwardpage=""
		}
		if (diagram="E")!(diagram="H")	{
			if isAnonymousMode,'singleEmailPerEvent {
				set backpage=prowebRoot_homePageID 
			} else {
				if ##class(setup.objEventSetting).getParameter("awards","use category interest screen",xEventID) {
					set backpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","categoryInterestPageID",xEventID)
				} else {
					set backpage=prowebRoot_registerEmailNewPageID
				}
			}

			set forwardpage=normalRoot_"bookersave.csp"
			// override if amending
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			}
			if $G(%session.Data("eventsforce","frontend","fromAwardsSummary")) {
					set backpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","summaryPageID",xEventID)
			}
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="tawardscategoryinterest.csp" {
		set backpage=""
		set forwardpage=""
		if (diagram="E")!(diagram="H")	{
			//Not compatible with anonymous mode
			if 'isAnonymousMode,'singleEmailPerEvent {
				set backpage=prowebRoot_registerEmailNewPageID
				set forwardpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","awardClientPageID",xEventID)
			}
		}
			
		quit backpage_"|"_forwardpage
	} elseif pagename="tbooker.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			if isAnonymousMode,'singleEmailPerEvent {
				set backpage=prowebRoot_selectBookingModePageID
			} else {
				set backpage=prowebRoot_registerEmailNewPageID
			}
			set forwardpage=normalRoot_"bookersave.csp"
			// override if amending
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			}
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="D"	{
			if isAnonymousMode,'singleEmailPerEvent	{
				if multiCategoryPerBooking	{  // then the select person category page will be lower down so we will go to the select booking mode
					set backpage=prowebRoot_selectBookingModePageID
				} else {
					set backpage=prowebRoot_selectCategoryPageID
				}
			} else {
				set backpage=prowebRoot_registerEmailNewPageID
			}

			set forwardpage=normalRoot_"bookersave.csp"
			// override if amending
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="I"	{
			set forwardpage=normalRoot_"bookersave.csp"
			set backpage=prowebRoot_registerEmailNewPageID
			// override if amending
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			}
		}
		if diagram="J"	{
			if isAnonymousMode,'singleEmailPerEvent {
				set backpage=prowebRoot_homePageID 
			} else {
				set backpage=prowebRoot_registerEmailNewPageID
			}
			set forwardpage=normalRoot_"bookersave.csp"
			// override if amending
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			}
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="bookersave.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			set backpage=prowebRoot_bookersPageID
			// is this person the booker? if so then we can go back to the bookers page
			if (selectBookingMode="single")!(selectBookingMode="singleandothers")	{
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get first page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""))
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set forwardpage=prowebRoot_pageID
			} elseif ##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)	{
				// if in here then I must be in the "others" booking mode so I need to force a new delegate
				set forwardpage="addDelegate.csp?clearBookedSession=1"
				set overridePersonID="NEW"
			} else {
				// goto delegateUID page
				set forwardpage=prowebRoot_delegateUIDPageID
			}
			// override if tableBooking
			if isTableBooking {
				//only show table booking page if we have something available to book
				set (seatsAvailable,tablesAvailable,show)=0
				if ((##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID))!(##class(eCom.tempPurchase).isBackendBooking(sessionID))){
					// table bookings enabled in front-end or is a back-end booking
					set backendSQLParam = $S(##class(eCom.tempPurchase).isBackendBooking(sessionID):1,1:0)
					
					// check for available seats
					&SQL(SELECT COUNT(ID) INTO :tmp FROM setup.objSeat WHERE (objTable->objEvent = :xEventID) AND (objTable->sellIndividualSeats = 1) AND ((objTable->backendOnly BETWEEN 0 AND :backendSQLParam) OR (objTable->backendOnly IS NULL)) AND ((bookedBy='') OR (bookedBy IS NULL)))
					if ((+SQLCODE=0)&&(tmp>0)) {
						set seatsAvailable=1
					}
					
					// check for available tables
					if (##class(setup.objEventSetting).getParameter("table bookings","enable entire tables",xEventID)){
						set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
						do rs.Prepare("SELECT ID FROM setup.objTable WHERE (objEvent = ?) AND ((backendOnly BETWEEN 0 AND ?) OR (backendOnly IS NULL)) AND ((bookedBy='') OR (bookedBy IS NULL))")
						do rs.Execute(xEventID,backendSQLParam)
						while (rs.Next()&&(tablesAvailable=0)) {
							if (##class(setup.objTable).isTableAvailable(rs.Get("ID"),xEventID)) {
								set tablesAvailable=1	
							}
						}
					}	
					if ((seatsAvailable)!(tablesAvailable)) {
						set show=1
					}	
					
					if (show=0) { // check if any table bookings made in this purchase - need to add/amend table guest names if so
						&SQL(SELECT COUNT(ID) INTO :tmp FROM eCom.tempSeat WHERE tempTable->tempPurchase->sessionID = :sessionID)
						if (+SQLCODE=0 && tmp > 0) {
							set show=1	
						}
						
						&SQL(SELECT COUNT(ID) INTO :tmp FROM eCom.tempTable WHERE tempPurchase->sessionID = :sessionID)
						if (+SQLCODE=0 && tmp > 0) {
							set show=1	
						}
					}			
				}
				
				
				if (show) {
					set forwardpage=prowebRoot_tableBookingPageID
				}	
			}
			// override if amending
			if seenBasket {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="D"	{
			set backpage=prowebRoot_bookersPageID
			if (selectBookingMode="single")!(selectBookingMode="singleandothers")	{
				if multiCategoryPerBooking	{
					set forwardpage=prowebRoot_selectCategoryPageID
				} else {
					if eventCategoryID="" quit ..quitIfNoAttCat()
					// get first page of the eventcategory registration page
					set displayOrder=$O(allRegPages(eventCategoryID,""))
					set pageID=allRegPages(eventCategoryID,displayOrder)
					set forwardpage=prowebRoot_pageID
				}
			} elseif ##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)	{
				// if in here then I must be in the "others" booking mode so I need to force a new delegate
				set forwardpage="addDelegate.csp?clearBookedSession=1"
				set overridePersonID="NEW"
			} else {
				// goto delegateUID page
				set forwardpage=prowebRoot_delegateUIDPageID
			}
			// override if tableBooking
			if isTableBooking {
				// pjc 2009-12-30 only show table booking page if we have something available to book
				set (seatsAvailable,tablesAvailable,show)=0
				if ((##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID))!(##class(eCom.tempPurchase).isBackendBooking(sessionID))){
					// table bookings enabled in front-end or is a back-end booking
					set backendSQLParam = $S(##class(eCom.tempPurchase).isBackendBooking(sessionID):1,1:0)
					
					// check for available seats
					&SQL(SELECT COUNT(ID) INTO :tmp FROM setup.objSeat WHERE (objTable->objEvent = :xEventID) AND (objTable->sellIndividualSeats = 1) AND ((objTable->backendOnly BETWEEN 0 AND :backendSQLParam) OR (objTable->backendOnly IS NULL)) AND ((bookedBy='') OR (bookedBy IS NULL)))
					if ((+SQLCODE=0)&&(tmp>0)) {
						set seatsAvailable=1
					}
					
					// check for available tables
					if (##class(setup.objEventSetting).getParameter("table bookings","enable entire tables",xEventID)){
						set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
						do rs.Prepare("SELECT ID FROM setup.objTable WHERE (objEvent = ?) AND ((backendOnly BETWEEN 0 AND ?) OR (backendOnly IS NULL)) AND ((bookedBy='') OR (bookedBy IS NULL))")
						do rs.Execute(xEventID,backendSQLParam)
						while (rs.Next()&&(tablesAvailable=0)) {
							if (##class(setup.objTable).isTableAvailable(rs.Get("ID"),xEventID)) {
								set tablesAvailable=1	
							}
						}
					}	
					if ((seatsAvailable)!(tablesAvailable)) {
						set show=1
					}	
					
					if (show=0) { // check if any table bookings made in this purchase - need to add/amend table guest names if so
						&SQL(SELECT COUNT(ID) INTO :tmp FROM eCom.tempSeat WHERE tempTable->tempPurchase->sessionID = :sessionID)
						if (+SQLCODE=0 && tmp > 0) {
							set show=1	
						}
						
						&SQL(SELECT COUNT(ID) INTO :tmp FROM eCom.tempTable WHERE tempPurchase->sessionID = :sessionID)
						if (+SQLCODE=0 && tmp > 0) {
							set show=1	
						}
					}				
				}
				
				
				if (show) {
					set forwardpage=prowebRoot_tableBookingPageID
				}	
			}
			// override if amending
			if seenBasket {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if (diagram="E") ! (diagram="H")	{
			set backpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","awardClientPageID",xEventID)
			// From the awards summary page
			if $G(%session.Data("eventsforce","frontend","fromAwardsSummary")) {
				set forwardpage="awardsSummary2.csp"
			} elseif seenBasket {
				set forwardpage=prowebRoot_basketPageID	
			} else {
				set forwardpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","summaryPageID",xEventID)
			}
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}

		if diagram="I"	{
			set backpage=prowebRoot_bookersPageID
			set forwardpage=prowebRoot_basketPageID
			// override if amending
			if seenBasket {
				set forwardpage=prowebRoot_basketPageID
			}
			// override if tableBooking
			if isTableBooking {
				// only show table booking page if we have something available to book
				set (seatsAvailable,tablesAvailable,show)=0
				if ((##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID))!(##class(eCom.tempPurchase).isBackendBooking(sessionID))){
					// table bookings enabled in front-end or is a back-end booking
					set backendSQLParam = $S(##class(eCom.tempPurchase).isBackendBooking(sessionID):1,1:0)
					
					// check for available seats
					&SQL(SELECT COUNT(ID) INTO :tmp FROM setup.objSeat WHERE (objTable->objEvent = :xEventID) AND (objTable->sellIndividualSeats = 1) AND ((objTable->backendOnly BETWEEN 0 AND :backendSQLParam) OR (objTable->backendOnly IS NULL)) AND ((bookedBy='') OR (bookedBy IS NULL)))
					if ((+SQLCODE=0)&&(tmp>0)) {
						set seatsAvailable=1
					}
					
					// check for available tables
					if (##class(setup.objEventSetting).getParameter("table bookings","enable entire tables",xEventID)){
						set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
						do rs.Prepare("SELECT ID FROM setup.objTable WHERE (objEvent = ?) AND ((backendOnly BETWEEN 0 AND ?) OR (backendOnly IS NULL)) AND ((bookedBy='') OR (bookedBy IS NULL))")
						do rs.Execute(xEventID,backendSQLParam)
						while (rs.Next()&&(tablesAvailable=0)) {
							if (##class(setup.objTable).isTableAvailable(rs.Get("ID"),xEventID)) {
								set tablesAvailable=1	
							}
						}
					}	
					if ((seatsAvailable)!(tablesAvailable)) {
						set show=1
					}	
					
					if (show=0) { // check if any table bookings made in this purchase - need to add/amend table guest names if so
						&SQL(SELECT COUNT(ID) INTO :tmp FROM eCom.tempSeat WHERE tempTable->tempPurchase->sessionID = :sessionID)
						if (+SQLCODE=0 && tmp > 0) {
							set show=1	
						}
						
						&SQL(SELECT COUNT(ID) INTO :tmp FROM eCom.tempTable WHERE tempPurchase->sessionID = :sessionID)
						if (+SQLCODE=0 && tmp > 0) {
							set show=1	
						}
					}	
				}
				
				
				if (show) {
					set forwardpage=prowebRoot_tableBookingPageID
				}	
			}
		}
		if diagram="J"	{
			set backpage=prowebRoot_bookersPageID
			// get first page of the eventcategory registration page
			set eventCategoryID=$O(allRegPages(""))
			if eventCategoryID="" quit ..quitIfNoAttCat()
			set displayOrder=$O(allRegPages(eventCategoryID,""))
			set pageID=allRegPages(eventCategoryID,displayOrder)
			set forwardpage=prowebRoot_pageID
			// always creating delegates seperate to the booker in this mode so get the first delegate created
			&SQL(SELECT ID INTO :tmp FROM eCom.tempPerson WHERE (isDelegate=1) AND (active=1) AND (tempPurchase->sessionID=:sessionID) ORDER BY ID )
			set overridePersonID="NEW"
			if +SQLCODE=0 set overridePersonID=tmp
			
			if (##class(eCom.tempPurchase).getCompletedAttendeeCount(tempPurchaseID))&&(seenBasket) {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		quit backpage_"|"_forwardpage

	} elseif pagename="ttableguests.csp"	{
		if diagram="B"	{
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			} else {
				set backpage=prowebRoot_bookersPageID
			}
			set forwardpage=normalRoot_"tableGuestSave.csp"
		}
		if diagram="D"	{
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			} else {
				set backpage=prowebRoot_bookersPageID
			}
			set forwardpage=normalRoot_"tableGuestSave.csp"
		}
		if diagram="I"	{
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			} else {
				set backpage=prowebRoot_bookersPageID
			}
			set forwardpage=normalRoot_"tableGuestSave.csp"
		}

		quit backpage_"|"_forwardpage	

	} elseif pagename="tableguestsave.csp"	{
		if diagram="B"	{
			set backpage=prowebRoot_tableBookingPageID
			// is this person the booker? if so then we can go back to the bookers page
			if (selectBookingMode="single")!(selectBookingMode="singleandothers")	{
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get first page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""))
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set forwardpage=prowebRoot_pageID
			} elseif ##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)	{
				// if in here then I must be in the "others" booking mode so I need to force a new delegate
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get first page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""))
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set forwardpage=prowebRoot_pageID
				set overridePersonID="NEW"
			} else {
				// goto delegateUID page
				set forwardpage=prowebRoot_delegateUIDPageID
			}
			// override if amending
			if seenBasket {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="D"	{
			set backpage=prowebRoot_tableBookingPageID
			// is this person the booker? if so then we can go back to the bookers page
			if (selectBookingMode="single")!(selectBookingMode="singleandothers")	{
				if multiCategoryPerBooking	{
					set forwardpage=prowebRoot_selectCategoryPageID
				} else {
					if eventCategoryID="" quit ..quitIfNoAttCat()
					// get first page of the eventcategory registration page
					set displayOrder=$O(allRegPages(eventCategoryID,""))
					set pageID=allRegPages(eventCategoryID,displayOrder)
					set forwardpage=prowebRoot_pageID
				}
			} elseif ##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)	{
				// if in here then I must be in the "others" booking mode so I need to force a new delegate
				if multiCategoryPerBooking	{
					set forwardpage=prowebRoot_selectCategoryPageID
				} else {
					if eventCategoryID="" quit ..quitIfNoAttCat()
					// get first page of the eventcategory registration page
					set displayOrder=$O(allRegPages(eventCategoryID,""))
					set pageID=allRegPages(eventCategoryID,displayOrder)
					set forwardpage=prowebRoot_pageID
				}
				set overridePersonID="NEW"
			} else {
				// goto delegateUID page
				set forwardpage=prowebRoot_delegateUIDPageID
			}
			// override if amending
			if seenBasket {
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="I"	{
			set backpage=prowebRoot_tableBookingPageID
			set forwardpage=normalRoot_"gotoBasket.csp"
		}
		quit backpage_"|"_forwardpage			

	} elseif pagename="tawardsentry.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="D"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="E"	{
			set (forwardpage,backpage)=prowebRoot_##class(setup.objEventSetting).getParameter("awards","summaryPageID",xEventID)
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="H"	{
			set (forwardpage,backpage)=prowebRoot_##class(setup.objEventSetting).getParameter("awards","summaryPageID",xEventID)
		}
		quit backpage_"|"_forwardpage	

	} elseif pagename="tdelegateuid.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			set backpage=prowebRoot_bookersPageID
			set forwardpage=normalRoot_"delegateuidsave.csp"
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			}
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="D"	{
			set backpage=prowebRoot_bookersPageID
			set forwardpage=normalRoot_"delegateuidsave.csp"
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="delegateuidsave.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			set backpage=prowebRoot_delegateUIDPageID
			// go to the first (and only category) reg page
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// get first page of the eventcategory registration page
			set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="D"	{
			set backpage=prowebRoot_delegateUIDPageID
			if multiCategoryPerBooking	{
				set forwardpage=prowebRoot_selectCategoryPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get first page of the eventcategory registration page
				set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)
			}

		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
	} else {
		quit ..goWhere3()
	}
]]></Implementation>
</Method>

<Method name="goWhere3">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	

	if pagename="tregistration.csp"	{
		// if I'm in here, it could be any one of the proweb registration pages for any category
		
		do ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) // This reserves a place if show day page is not shown
		if diagram="A"	{
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,originalPageID),"|",1)
			set backpage=$O(allRegPages(eventCategoryID,currentDisplayOrder),-1)
			if backpage="" {
				if isAnonymousMode,'singleEmailPerEvent	{
					set backpage=prowebRoot_homePageID 
				} else {
					set backpage=prowebRoot_registerEmailNewPageID
				}

				// we only want to go back to the basket if we've seen the basket already
				if seenBasket set backpage=prowebRoot_basketPageID
			} else {
				// go back to the previous registration page for this category
				set backpage=prowebRoot_allRegPages(eventCategoryID,backpage)
			}
			// If they have gone directly to this page they should go straight back to the basket
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set backpage=prowebRoot_basketPageID
			}
			set forwardpage=normalRoot_"codformsave.csp"

		}
		if diagram="B"	{
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,originalPageID),"|",1)
			set backpage=$O(allRegPages(eventCategoryID,currentDisplayOrder),-1)
			if backpage="" {
				// is this person the booker? if so then we can go back to the bookers page
				if (personIsBooker)&((selectBookingMode="single")!(selectBookingMode="singleandothers"))	{
					set backpage=prowebRoot_bookersPageID
				} elseif ##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)	{
					set backpage=prowebRoot_bookersPageID
				} else {
					set backpage=prowebRoot_delegateUIDPageID
				}
				// go back to table booking
				if isTableBooking set backpage=prowebRoot_tableBookingPageID
				
				// we only want to go back to the basket if we've seen the basket already
				if seenBasket set backpage=prowebRoot_basketPageID
			} else {
				// go back to the previous registration page for this category
				set backpage=prowebRoot_allRegPages(eventCategoryID,backpage)
			}
			// If they have gone directly to this page they should go straight back to the basket
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set backpage=prowebRoot_basketPageID
			}
			set forwardpage=normalRoot_"codformsave.csp"

		}
		if diagram="C"	{
			set forwardpage=normalRoot_"codformsave.csp"
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,originalPageID),"|",1)
			set backpage=$O(allRegPages(eventCategoryID,currentDisplayOrder),-1)
			if backpage="" {
				set backpage=prowebRoot_selectCategoryPageID
				// we only want to go back to the basket if in amendmode
				if seenBasket set backpage=prowebRoot_basketPageID
			} else {
				// go back to the previous registration page for this category
				set backpage=prowebRoot_allRegPages(eventCategoryID,backpage)
			}
			// If they have gone directly to this page they should go straight back to the basket
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set backpage=prowebRoot_basketPageID
			}

		}
		if diagram="D"	{
			set forwardpage=normalRoot_"codformsave.csp"
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,originalPageID),"|",1)
			set backpage=$O(allRegPages(eventCategoryID,currentDisplayOrder),-1)
			if backpage="" {
				if multiCategoryPerBooking {
					set backpage=prowebRoot_selectCategoryPageID
				} else {
					// is this person the booker? if so then we can go back to the bookers page
					if (personIsBooker)&((selectBookingMode="single")!(selectBookingMode="singleandothers"))	{
						set backpage=prowebRoot_bookersPageID
					} elseif ##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)	{
						set backpage=prowebRoot_bookersPageID
					} else {
						set backpage=prowebRoot_delegateUIDPageID
					}
				}
				// go back to table booking
				if isTableBooking set backpage=prowebRoot_tableBookingPageID

				// we only want to go back to the basket if in amendmode
				if seenBasket set backpage=prowebRoot_basketPageID
			} else {
				// go back to the previous registration page for this category
				set backpage=prowebRoot_allRegPages(eventCategoryID,backpage)
			}
			// If they have gone directly to this page they should go straight back to the basket
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set backpage=prowebRoot_basketPageID
			}

		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			// use my pageID to determine where to go next
			if eventCategoryID="" quit ..quitIfNoAttCat()
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,originalPageID),"|",1)
			set backpage=$O(allRegPages(eventCategoryID,currentDisplayOrder),-1)
			if backpage="" {
				set backpage=prowebRoot_eventHotelPageID
			} else {
				// go back to the previous registration page for this category
				set backpage=prowebRoot_allRegPages(eventCategoryID,backpage)
			}
			set forwardpage=normalRoot_"codformsave.csp"
		}
		if diagram="J"	{
			set backpage=prowebRoot_bookersPageID
			set forwardpage=normalRoot_"codformsave.csp"
			// override if amending
			if seenBasket set backpage=prowebRoot_basketPageID
		}
		if diagram="K"	{
			set forwardpage=normalRoot_"codformsave.csp"
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,originalPageID),"|",1)
			set backpage=$O(allRegPages(eventCategoryID,currentDisplayOrder),-1)
			if backpage="" {
				set backpage=prowebRoot_selectCategoryPageID
				// we only want to go back to the basket if in amendmode
				if seenBasket {
					set backpage=prowebRoot_basketPageID
				} elseif ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
					set backpage=prowebRoot_accomGuestPageID
				} else {
					set backpage=prowebRoot_accomHotelListPageID
				}
			} else {
				// go back to the previous registration page for this category
				set backpage=prowebRoot_allRegPages(eventCategoryID,backpage)
			}

		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="codformsave.csp"	{
		// if I'm in here, it could be any one of the proweb registration pages for any category
		// the pageID I've just been in will be in the parameter extraPageID
		
		if diagram="A"	{
			// just been in this page so this is where I'm going back to
			set backpage=prowebRoot_extraPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,extraPageID),"|",1)
			set forwardpage=$O(allRegPages(eventCategoryID,currentDisplayOrder))
			if forwardpage="" {
				// then this is the last of the registration pages for this person and category
				// go to the day selection
				if ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
					set forwardpage=prowebRoot_chooseDaysPageID
				} elseif ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
					set forwardpage=prowebRoot_chooseSessionsPageID
				} elseif newAccomEvent,'hasAccom,showAccom {
					set forwardpage=prowebRoot_accomChooseDatesPageID
				} elseif isAccom,'newAccomEvent {
					set forwardpage=prowebRoot_firstVenuePageID
					if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
				} else {
					set forwardpage=normalRoot_"gotoBasket.csp"
				}
			} else {
				set forwardpage=prowebRoot_allRegPages(eventCategoryID,forwardpage)
			}
			// If they have gone directly to this page they should go straight back to the basket
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="B"	{
			// just been in this page so this is where I'm going back to
			set backpage=prowebRoot_extraPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,extraPageID),"|",1)
			set forwardpage=$O(allRegPages(eventCategoryID,currentDisplayOrder))
			if forwardpage="" {
				// then this is the last of the registration pages for this person and category
				// go to the day selection
				if ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
					set forwardpage=prowebRoot_chooseDaysPageID
				} elseif ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
					set forwardpage=prowebRoot_chooseSessionsPageID
				} elseif newAccomEvent,'hasAccom,showAccom {
					set forwardpage=prowebRoot_accomChooseDatesPageID
				} elseif isAccom,'newAccomEvent {
					set forwardpage=prowebRoot_firstVenuePageID
					if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
				} else {
					set forwardpage=normalRoot_"gotoBasket.csp"
				}
			} else {
				set forwardpage=prowebRoot_allRegPages(eventCategoryID,forwardpage)
			}
			// If they have gone directly to this page they should go straight back to the basket
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="C"	{
			// just been in this page so this is where I'm going back to
			set backpage=prowebRoot_extraPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,extraPageID),"|",1)
			set forwardpage=$O(allRegPages(eventCategoryID,currentDisplayOrder))
			if forwardpage="" {
				// then this is the last of the registration pages for this person and category
				// go to the day selection
				if ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
					set forwardpage=prowebRoot_chooseDaysPageID
				} elseif ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
					set forwardpage=prowebRoot_chooseSessionsPageID
				} elseif newAccomEvent,'hasAccom,showAccom {
					set forwardpage=prowebRoot_accomChooseDatesPageID
				} elseif isAccom,'newAccomEvent {
					set forwardpage=prowebRoot_firstVenuePageID
					if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
				} else {
					set forwardpage=normalRoot_"gotoBasket.csp"
				}

			} else {
				set forwardpage=prowebRoot_allRegPages(eventCategoryID,forwardpage)
			}
			// If they have gone directly to this page they should go straight back to the basket
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="D"	{
			// just been in this page so this is where I'm going back to
			set backpage=prowebRoot_extraPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,extraPageID),"|",1)
			set forwardpage=$O(allRegPages(eventCategoryID,currentDisplayOrder))
			if forwardpage="" {
				// then this is the last of the registration pages for this person and category
				// go to the day selection
				if ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
					set forwardpage=prowebRoot_chooseDaysPageID
				} elseif ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
					set forwardpage=prowebRoot_chooseSessionsPageID
				} elseif newAccomEvent,'hasAccom,showAccom {
					set forwardpage=prowebRoot_accomChooseDatesPageID
				} elseif isAccom,'newAccomEvent {
					set forwardpage=prowebRoot_firstVenuePageID
					if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
				} else {
					set forwardpage=normalRoot_"gotoBasket.csp"
				}
			} else {
				set forwardpage=prowebRoot_allRegPages(eventCategoryID,forwardpage)
			}
			// If they have gone directly to this page they should go straight back to the basket
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			// just been in this page so this is where I'm going back to
			set backpage=prowebRoot_extraPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,extraPageID),"|",1)
			set forwardpage=$O(allRegPages(eventCategoryID,currentDisplayOrder))
			if forwardpage="" {
				// then this is the last of the registration pages for this person and category
				// go to the day selection
				set forwardpage=normalRoot_"gotoBasket.csp"
				//if seenBasket set forwardpage=prowebRoot_firstVenuePageID
			} else {
				set forwardpage=prowebRoot_allRegPages(eventCategoryID,forwardpage)
			}
		}
		if diagram="J"	{
			set backpage=prowebRoot_extraPageID
			set forwardpage=normalRoot_"gotoBasket.csp"
		}
		if diagram="K"	{
			// just been in this page so this is where I'm going back to
			set backpage=prowebRoot_extraPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// use my pageID to determine where to go next
			set currentDisplayOrder=$P(allRegPageIDs(eventCategoryID,extraPageID),"|",1)
			set forwardpage=$O(allRegPages(eventCategoryID,currentDisplayOrder))
			if forwardpage="" {
				// then this is the last of the registration pages for this person and category
				// go to the day selection
				set forwardpage=normalRoot_"gotoBasket.csp"
			} else {
				set forwardpage=prowebRoot_allRegPages(eventCategoryID,forwardpage)
			}
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="tchoosedays.csp"	{
		if eventCategoryID="" quit ..quitIfNoAttCat()
		if diagram="A"	{
			set forwardpage=normalRoot_"choosedays2.csp"
			// get last page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
			set pageID=allRegPages(eventCategoryID,displayOrder)
			set backpage=prowebRoot_pageID
		}
		if diagram="B"	{
			set forwardpage=normalRoot_"choosedays2.csp"
			// get last page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
			set pageID=allRegPages(eventCategoryID,displayOrder)
			set backpage=prowebRoot_pageID
		}
		if diagram="C"	{
			set forwardpage=normalRoot_"choosedays2.csp"

			// get last page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
			set pageID=allRegPages(eventCategoryID,displayOrder)
			set backpage=prowebRoot_pageID

		}
		if diagram="D"	{
			set forwardpage=normalRoot_"choosedays2.csp"

			// get last page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
			set pageID=allRegPages(eventCategoryID,displayOrder)
			set backpage=prowebRoot_pageID

		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="choosedays2.csp"	{
		if diagram="A"	{
			set backpage=prowebRoot_chooseDaysPageID
			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set forwardpage=prowebRoot_chooseSessionsPageID
			} elseif newAccomEvent,'hasAccom,showAccom {
				set forwardpage=prowebRoot_accomChooseDatesPageID
			} elseif isAccom,'newAccomEvent {
				set forwardpage=prowebRoot_firstVenuePageID
				if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="B"	{
			set backpage=prowebRoot_chooseDaysPageID
			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set forwardpage=prowebRoot_chooseSessionsPageID
			} elseif newAccomEvent,'hasAccom,showAccom {
				set forwardpage=prowebRoot_accomChooseDatesPageID
			} elseif isAccom,'newAccomEvent {
				set forwardpage=prowebRoot_firstVenuePageID
				if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="C"	{
			set backpage=prowebRoot_chooseDaysPageID
			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set forwardpage=prowebRoot_chooseSessionsPageID
			} elseif newAccomEvent,'hasAccom,showAccom {
				set forwardpage=prowebRoot_accomChooseDatesPageID
			} elseif isAccom,'newAccomEvent {
				set forwardpage=prowebRoot_firstVenuePageID
				if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="D"	{
			set backpage=prowebRoot_chooseDaysPageID
			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set forwardpage=prowebRoot_chooseSessionsPageID
			} elseif newAccomEvent,'hasAccom,showAccom {
				set forwardpage=prowebRoot_accomChooseDatesPageID
			} elseif isAccom,'newAccomEvent {
				set forwardpage=prowebRoot_firstVenuePageID
				if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
		
	} elseif (pagename="tchooseitems.csp") || (pagename="tagendaregistration.csp")	{
		if eventCategoryID="" quit ..quitIfNoAttCat()
		// just amending the sessions, so back page should go to the basket
		set editSessionsOnly=$G(%session.Data("eventsforce","frontend","editSessionsOnly"))
		if diagram="A"	{
			set forwardpage=normalRoot_"chooseitems2.csp"

			if editSessionsOnly {
				set backpage=prowebRoot_basketPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
		}
		if diagram="B"	{
			set forwardpage=normalRoot_"chooseitems2.csp"

			if editSessionsOnly {
				set backpage=prowebRoot_basketPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
		}
		if diagram="C"	{
			set forwardpage=normalRoot_"chooseitems2.csp"

			if editSessionsOnly {
				set backpage=prowebRoot_basketPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
		}
		if diagram="D"	{
			set forwardpage=normalRoot_"chooseitems2.csp"

			if editSessionsOnly {
				set backpage=prowebRoot_basketPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="chooseitems2.csp"	{
		if diagram="A"	{
			set backpage=prowebRoot_chooseSessionsPageID
			if newAccomEvent,'hasAccom,showAccom {
				set forwardpage=prowebRoot_accomChooseDatesPageID
			} elseif isAccom,'newAccomEvent {
				set forwardpage=prowebRoot_firstVenuePageID
				if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="B"	{
			set backpage=prowebRoot_chooseSessionsPageID
			if newAccomEvent,'hasAccom,showAccom {
				set forwardpage=prowebRoot_accomChooseDatesPageID
			} elseif isAccom,'newAccomEvent {
				set forwardpage=prowebRoot_firstVenuePageID
				if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="C"	{
			set backpage=prowebRoot_chooseSessionsPageID
			if newAccomEvent,'hasAccom,showAccom {
				set forwardpage=prowebRoot_accomChooseDatesPageID
			} elseif isAccom,'newAccomEvent {
				set forwardpage=prowebRoot_firstVenuePageID
				if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="D"	{
			set backpage=prowebRoot_chooseSessionsPageID
			if newAccomEvent,'hasAccom,showAccom {
				set forwardpage=prowebRoot_accomChooseDatesPageID
			} elseif isAccom,'newAccomEvent {
				set forwardpage=prowebRoot_firstVenuePageID
				if anyAccomBookingsForPerson set forwardpage=prowebRoot_eventHotelPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="tvenuesummary.csp"	{
		if diagram="A"	{
			set forwardpage=normalRoot_"accomsavevenueid.csp"

			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set backpage=prowebRoot_chooseSessionsPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
		}
		if diagram="B"	{
			set forwardpage=normalRoot_"accomsavevenueid.csp"

			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set backpage=prowebRoot_chooseSessionsPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
		}
		if diagram="C"	{
			set forwardpage=normalRoot_"accomsavevenueid.csp"

			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set backpage=prowebRoot_chooseSessionsPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
		}
		if diagram="D"	{
			set forwardpage=normalRoot_"accomsavevenueid.csp"

			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set backpage=prowebRoot_chooseSessionsPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=normalRoot_"accomsavevenueid.csp"
			if seenBasket {
				set backpage=normalRoot_"gotoBasket.csp"
			}
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="accomsavevenueid.csp"	{
		if diagram="A"	{
			set backpage=prowebRoot_firstVenuePageID
			set forwardpage=prowebRoot_eventHotelPageID
		}
		if diagram="B"	{
			set backpage=prowebRoot_firstVenuePageID
			set forwardpage=prowebRoot_eventHotelPageID
		}
		if diagram="C"	{
			set backpage=prowebRoot_firstVenuePageID
			set forwardpage=prowebRoot_eventHotelPageID
		}
		if diagram="D"	{
			set backpage=prowebRoot_firstVenuePageID
			set forwardpage=prowebRoot_eventHotelPageID
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=prowebRoot_firstVenuePageID
			set forwardpage=prowebRoot_eventHotelPageID
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="thotelbooking.csp"	{
		if diagram="A"	{
			set backpage=prowebRoot_firstVenuePageID
			set forwardpage=normalRoot_"hotelbookingsave.csp"
			if anyAccomBookingsForPerson	{  // if we've got a booking for this person already, don't go back to hotel selection
				if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
					set backpage=prowebRoot_chooseSessionsPageID
				} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
					set backpage=prowebRoot_chooseDaysPageID
				} else {
					if eventCategoryID="" quit ..quitIfNoAttCat()
					// get last page of the eventcategory registration page
					set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
					set pageID=allRegPages(eventCategoryID,displayOrder)
					set backpage=prowebRoot_pageID
				}
			}
		}
		if diagram="B"	{
			set backpage=prowebRoot_firstVenuePageID
			set forwardpage=normalRoot_"hotelbookingsave.csp"
			if anyAccomBookingsForPerson	{  // if we've got a booking for this person already, don't go back to hotel selection
				if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
					set backpage=prowebRoot_chooseSessionsPageID
				} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
					set backpage=prowebRoot_chooseDaysPageID
				} else {
					if eventCategoryID="" quit ..quitIfNoAttCat()
					// get last page of the eventcategory registration page
					set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
					set pageID=allRegPages(eventCategoryID,displayOrder)
					set backpage=prowebRoot_pageID
				}
			}
		}
		if diagram="C"	{
			set backpage=prowebRoot_firstVenuePageID
			set forwardpage=normalRoot_"hotelbookingsave.csp"
			if anyAccomBookingsForPerson	{  // if we've got a booking for this person already, don't go back to hotel selection
				if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
					set backpage=prowebRoot_chooseSessionsPageID
				} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
					set backpage=prowebRoot_chooseDaysPageID
				} else {
					if eventCategoryID="" quit ..quitIfNoAttCat()
					// get last page of the eventcategory registration page
					set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
					set pageID=allRegPages(eventCategoryID,displayOrder)
					set backpage=prowebRoot_pageID
				}
			}
		}
		if diagram="D"	{
			set backpage=prowebRoot_firstVenuePageID
			set forwardpage=normalRoot_"hotelbookingsave.csp"
			if anyAccomBookingsForPerson	{  // if we've got a booking for this person already, don't go back to hotel selection
				if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
					set backpage=prowebRoot_chooseSessionsPageID
				} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
					set backpage=prowebRoot_chooseDaysPageID
				} else {
					if eventCategoryID="" quit ..quitIfNoAttCat()
					// get last page of the eventcategory registration page
					set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
					set pageID=allRegPages(eventCategoryID,displayOrder)
					set backpage=prowebRoot_pageID
				}
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=prowebRoot_firstVenuePageID
			set forwardpage=normalRoot_"hotelbookingsave.csp"
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="hotelbookingsave.csp"	{
		if diagram="A"	{
			set backpage=prowebRoot_eventHotelPageID
			set forwardpage=normalRoot_"gotoBasket.csp"
		}
		if diagram="B"	{
			set backpage=prowebRoot_eventHotelPageID
			set forwardpage=normalRoot_"gotoBasket.csp"
		}
		if diagram="C"	{
			set backpage=prowebRoot_eventHotelPageID
			set forwardpage=normalRoot_"gotoBasket.csp"
		}
		if diagram="D"	{
			set backpage=prowebRoot_eventHotelPageID
			set forwardpage=normalRoot_"gotoBasket.csp"
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=prowebRoot_eventHotelPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// go to the first (and only category) reg page
			set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="taccomchoosedates.csp" {
		if diagram="A"	{
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			} elseif ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) {
				set backpage=prowebRoot_chooseSessionsPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
			set forwardpage=normalRoot_"accomChooseDatesSave.csp"
		}
		if diagram="B"	{
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			} elseif ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) {
				set backpage=prowebRoot_chooseSessionsPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
			set forwardpage=normalRoot_"accomChooseDatesSave.csp"
		}
		if diagram="C"	{
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			} elseif ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) {
				set backpage=prowebRoot_chooseSessionsPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
			set forwardpage=normalRoot_"accomChooseDatesSave.csp"
		}
		if diagram="D"	{
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			} elseif ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) {
				set backpage=prowebRoot_chooseSessionsPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
			set forwardpage=normalRoot_"accomChooseDatesSave.csp"
		}
		if diagram="K"	{
			if seenBasket {
				set backpage=prowebRoot_basketPageID
			} else {
				set backpage=prowebRoot_homePageID
			} 
			set forwardpage=normalRoot_"accomChooseDatesSave.csp"
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="accomchoosedatessave.csp" {
		if diagram="A"	{
			set backpage=prowebRoot_accomChooseDatesPageID 
			set forwardpage=prowebRoot_accomHotelListPageID
		}
		if diagram="B"	{
			set backpage=prowebRoot_accomChooseDatesPageID 
			set forwardpage=prowebRoot_accomHotelListPageID
		}
		if diagram="C"	{
			set backpage=prowebRoot_accomChooseDatesPageID 
			set forwardpage=prowebRoot_accomHotelListPageID
		}
		if diagram="D"	{
			set backpage=prowebRoot_accomChooseDatesPageID 
			set forwardpage=prowebRoot_accomHotelListPageID
		}
		if diagram="K"	{
			set backpage=prowebRoot_accomChooseDatesPageID 
			set forwardpage=prowebRoot_accomHotelListPageID
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="taccomhotellist.csp" {
		if diagram="A"	{
			set backpage=prowebRoot_accomChooseDatesPageID
			set forwardpage=normalRoot_"accomHotelListSave.csp"
		}
		if diagram="B"	{
			set backpage=prowebRoot_accomChooseDatesPageID
			set forwardpage=normalRoot_"accomHotelListSave.csp"
		}
		if diagram="C"	{
			set backpage=prowebRoot_accomChooseDatesPageID
			set forwardpage=normalRoot_"accomHotelListSave.csp"
		}
		if diagram="D"	{
			set backpage=prowebRoot_accomChooseDatesPageID
			set forwardpage=normalRoot_"accomHotelListSave.csp"
		}
		if diagram="K"	{
			set backpage=prowebRoot_accomChooseDatesPageID
			set forwardpage=normalRoot_"accomHotelListSave.csp"
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="accomhotellistsave.csp" {
		if diagram="A"	{
			set backpage=prowebRoot_accomHotelListPageID
			if ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
				set forwardpage=prowebRoot_accomGuestPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="B"	{
			set backpage=prowebRoot_accomHotelListPageID
			if ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
				set forwardpage=prowebRoot_accomGuestPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="C"	{
			set backpage=prowebRoot_accomHotelListPageID
			if ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
				set forwardpage=prowebRoot_accomGuestPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="D"	{
			set backpage=prowebRoot_accomHotelListPageID
			if ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
				set forwardpage=prowebRoot_accomGuestPageID
			} else {
				set forwardpage=normalRoot_"gotoBasket.csp"
			}
		}
		if diagram="K"	{
			set backpage=prowebRoot_accomHotelListPageID
			if ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
				set forwardpage=prowebRoot_accomGuestPageID
			} else {
				if seenBasket {
					// adding an extra room
					set forwardpage=prowebRoot_basketPageID
				} else {
					if eventCategoryID="" quit ..quitIfNoAttCat()
					// go to the first (and only category) reg page
					set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)
				}
			}
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="taccomguest.csp" {
		if diagram="A"	{
			set backpage=prowebRoot_accomHotelListPageID
			set forwardpage=normalRoot_"accomGuestSave.csp"
		}
		if diagram="B"	{
			set backpage=prowebRoot_accomHotelListPageID
			set forwardpage=normalRoot_"accomGuestSave.csp"
		}
		if diagram="C"	{
			set backpage=prowebRoot_accomHotelListPageID
			set forwardpage=normalRoot_"accomGuestSave.csp"
		}
		if diagram="D"	{
			set backpage=prowebRoot_accomHotelListPageID
			set forwardpage=normalRoot_"accomGuestSave.csp"
		}
		if diagram="K"	{
			set backpage=prowebRoot_accomHotelListPageID
			set forwardpage=normalRoot_"accomGuestSave.csp"
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="accomguestsave.csp" {
		if diagram="A"	{
			set backpage=prowebRoot_accomGuestPageID
			// adding an extra room
			set forwardpage=normalRoot_"gotoBasket.csp"
		}
		if diagram="B"	{
			set backpage=prowebRoot_accomGuestPageID
			// adding an extra room
			set forwardpage=normalRoot_"gotoBasket.csp"
		}
		if diagram="C"	{
			set backpage=prowebRoot_accomGuestPageID
			// adding an extra room
			set forwardpage=normalRoot_"gotoBasket.csp"
		}
		if diagram="D"	{
			set backpage=prowebRoot_accomGuestPageID
			// adding an extra room
			set forwardpage=normalRoot_"gotoBasket.csp"
		}
		if diagram="K"	{
			set backpage=prowebRoot_accomGuestPageID
			
			if seenBasket {
				// adding an extra room
				set forwardpage=prowebRoot_basketPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// go to the first (and only category) reg page
				set forwardpage=..getFirstRegistrationPage(eventCategoryID,.allRegPages)
			}
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="taccomedit.csp" {
		if diagram="A"	{
			set backpage=prowebRoot_basketPageID 
			set forwardpage=normalRoot_"accomEditSave.csp"
		}
		if diagram="B"	{
			set backpage=prowebRoot_basketPageID 
			set forwardpage=normalRoot_"accomEditSave.csp"
		}
		if diagram="C"	{
			set backpage=prowebRoot_basketPageID 
			set forwardpage=normalRoot_"accomEditSave.csp"
		}
		if diagram="D"	{
			set backpage=prowebRoot_basketPageID 
			set forwardpage=normalRoot_"accomEditSave.csp"
		}
		if diagram="K"	{
			set backpage=prowebRoot_basketPageID 
			set forwardpage=normalRoot_"accomEditSave.csp"
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="accomeditsave.csp" {
		if diagram="A"	{
			set backpage=prowebRoot_accomEditPageID
			set forwardpage=prowebRoot_basketPageID
		}
		if diagram="B"	{
			set backpage=prowebRoot_accomEditPageID
			set forwardpage=prowebRoot_basketPageID
		}
		if diagram="C"	{
			set backpage=prowebRoot_accomEditPageID
			set forwardpage=prowebRoot_basketPageID
		}
		if diagram="D"	{
			set backpage=prowebRoot_accomEditPageID
			set forwardpage=prowebRoot_basketPageID
		}
		if diagram="K"	{
			set backpage=prowebRoot_accomEditPageID
			set forwardpage=prowebRoot_basketPageID
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="addroom.csp" {
		if diagram="A"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_accomChooseDatesPageID
		}
		if diagram="B"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_accomChooseDatesPageID
		}
		if diagram="C"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_accomChooseDatesPageID
		}
		if diagram="D"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_accomChooseDatesPageID
		}
		if diagram="K"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_accomChooseDatesPageID
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="editroom.csp" {
		if diagram="A"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_accomEditPageID
		}
		if diagram="B"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_accomEditPageID
		}
		if diagram="C"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_accomEditPageID
		}
		if diagram="D"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_accomEditPageID
		}
		if diagram="K"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_accomEditPageID
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="deleteroom.csp" {
		if diagram="A"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_basketPageID
		}
		if diagram="B"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_basketPageID
		}
		if diagram="C"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_basketPageID
		}
		if diagram="D"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_basketPageID
		}
		if diagram="K"	{
			set backpage=prowebRoot_homePageID 
			set forwardpage=prowebRoot_basketPageID
		}
		quit backpage_"|"_forwardpage
	} elseif pagename="tbasket.csp"	{
		if diagram="A"	{
			set forwardpage=normalRoot_"basket2.csp"

			if isAccom {
				set backpage=prowebRoot_firstVenuePageID
			} elseif ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set backpage=prowebRoot_chooseSessionsPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set backpage=prowebRoot_pageID
			}
		}
		if diagram="B"	{
			set forwardpage=normalRoot_"basket2.csp"
			// cannot have a back as we are in group bookings so they can EDIT each delegate unless table booking
			set backpage=""
			if isTableBooking {
				set backpage=prowebRoot_tableBookingPageID	
			}
		}
		if diagram="C"	{
			set forwardpage=normalRoot_"basket2.csp"

			if isAccom {
				set backpage=prowebRoot_firstVenuePageID
			} elseif ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set backpage=prowebRoot_chooseSessionsPageID
			} elseif ##class(setup.objEvent).showChooseDays(xEventID,sessionID,tempPersonID) { // if switched on in eventDetails
				set backpage=prowebRoot_chooseDaysPageID
			} else {
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get last page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""),-1)
				if displayOrder { // to avoid crash in some scenarios
					set pageID=allRegPages(eventCategoryID,displayOrder)
				} else {
					set pageID=""
				}
				set backpage=prowebRoot_pageID
			}
		}
		if diagram="D"	{
			set forwardpage=normalRoot_"basket2.csp"
			// cannot have a back as we are in group bookings so they can EDIT each delegate unless table booking
			set backpage=""
			if isTableBooking {
				set backpage=prowebRoot_tableBookingPageID	
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","summaryPageID",xEventID)
			
			set forwardpage=normalRoot_"basket2.csp"
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="I"	{
			set backpage=prowebRoot_tableBookingPageID
			set forwardpage=normalRoot_"basket2.csp"
		}
		if diagram="J"	{
			// get first page of the eventcategory registration page
			set eventCategoryID=$O(allRegPages(""))
			set displayOrder=$O(allRegPages(eventCategoryID,""))
			set pageID=allRegPages(eventCategoryID,displayOrder)
			set backpage=prowebRoot_pageID
			// always creating delegates seperate to the booker in this mode so get the first delegate created
			&SQL(SELECT ID INTO :tmp FROM eCom.tempPerson WHERE (isDelegate=1) AND (active=1) AND (tempPurchase->sessionID=:sessionID) ORDER BY ID )
			set overridePersonID="NEW"
			if +SQLCODE=0 set overridePersonID=tmp
			set forwardpage=""
		}
		if diagram="K"	{
			set backpage=""
			set forwardpage=""
		}
		// **** CURRENTLY ONLY THE BACK PAGE IS USED HERE AS FROM BASKET ONWARDS, PAGENAV IS NOT USED ****
		set forwardpage=""
		quit backpage_"|"_forwardpage
		
	} elseif pagename="basket2.csp"	{
		set backpage="asdas"
		set forwardpage="asdsa"
		quit backpage_"|"_forwardpage

	} elseif pagename="adddelegate.csp"	{
		if diagram="A"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="B"	{
			set backpage=prowebRoot_basketPageID
			if ##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)	{
				if eventCategoryID="" quit ..quitIfNoAttCat()
				// get first page of the eventcategory registration page
				set displayOrder=$O(allRegPages(eventCategoryID,""))
				set pageID=allRegPages(eventCategoryID,displayOrder)
				set forwardpage=prowebRoot_pageID
			} else {
				set forwardpage=prowebRoot_delegateUIDPageID
			}
		}
		if diagram="C"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="D"	{
			set backpage=prowebRoot_basketPageID
			if ##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)	{
				if multiCategoryPerBooking	{
					set forwardpage=prowebRoot_selectCategoryPageID
				} else {
					if eventCategoryID="" quit ..quitIfNoAttCat()
					// get first page of the eventcategory registration page
					set displayOrder=$O(allRegPages(eventCategoryID,""))
					set pageID=allRegPages(eventCategoryID,displayOrder)
					set forwardpage=prowebRoot_pageID
				}
			} else {
				// goto delegateUID page
				set forwardpage=prowebRoot_delegateUIDPageID
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="editbooker.csp"	{
		if diagram="A"	{
			set backpage=prowebRoot_basketPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// get first page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""))
			set pageID=allRegPages(eventCategoryID,displayOrder)
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set pageID=%session.Data("eventsforce","frontend","Go Directly to Page")
			}
			set forwardpage=prowebRoot_pageID
		}
		if diagram="B"	{
			set backpage=prowebRoot_basketPageID
			set forwardpage=prowebRoot_bookersPageID
		}
		if diagram="C"	{
			set backpage=prowebRoot_basketPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// get first page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""))
			set pageID=allRegPages(eventCategoryID,displayOrder)
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set pageID=%session.Data("eventsforce","frontend","Go Directly to Page")
			}
			set forwardpage=prowebRoot_pageID
		}
		if diagram="D"	{
			set backpage=prowebRoot_basketPageID
			set forwardpage=prowebRoot_bookersPageID
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=prowebRoot_basketPageID
			set forwardpage=prowebRoot_##class(setup.objEventSetting).getParameter("awards","awardClientPageID",xEventID)
		}
		if diagram="G"	{
			set backpage=prowebRoot_basketPageID
			set forwardpage=prowebRoot_firstVenuePageID
		}
		if diagram="I"	{
			set backpage=prowebRoot_basketPageID
			set forwardpage=prowebRoot_bookersPageID
		}
		if diagram="J"	{
			set backpage=prowebRoot_basketPageID
			set forwardpage=prowebRoot_bookersPageID
		}
		if diagram="K"	{
			set backpage=prowebRoot_basketPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// get first page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""))
			set pageID=allRegPages(eventCategoryID,displayOrder)
			set forwardpage=prowebRoot_pageID
		}
		quit backpage_"|"_forwardpage
		
	} elseif pagename="editdelegate.csp"	{
		if diagram="A"	{
			set backpage=prowebRoot_basketPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// get first page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""))
			set pageID=allRegPages(eventCategoryID,displayOrder)
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set pageID=%session.Data("eventsforce","frontend","Go Directly to Page")
			}
			set forwardpage=prowebRoot_pageID
		}
		if diagram="B"	{
			set backpage=prowebRoot_basketPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// get first page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""))
			set pageID=allRegPages(eventCategoryID,displayOrder)
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set pageID=%session.Data("eventsforce","frontend","Go Directly to Page")
			}
			set forwardpage=prowebRoot_pageID
		}
		if diagram="C"	{
			set backpage=prowebRoot_basketPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// get first page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""))
			set pageID=allRegPages(eventCategoryID,displayOrder)
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set pageID=%session.Data("eventsforce","frontend","Go Directly to Page")
			}
			set forwardpage=prowebRoot_pageID
		}
		if diagram="D"	{
			set backpage=prowebRoot_basketPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// get first page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""))
			set pageID=allRegPages(eventCategoryID,displayOrder)
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set pageID=%session.Data("eventsforce","frontend","Go Directly to Page")
			}
			set forwardpage=prowebRoot_pageID
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="J"	{
			set backpage=prowebRoot_basketPageID
			if eventCategoryID="" quit ..quitIfNoAttCat()
			// get first page of the eventcategory registration page
			set displayOrder=$O(allRegPages(eventCategoryID,""))
			set pageID=allRegPages(eventCategoryID,displayOrder)
			if $G(%session.Data("eventsforce","frontend","Go Directly to Page")) {
				set pageID=%session.Data("eventsforce","frontend","Go Directly to Page")
			}
			set forwardpage=prowebRoot_pageID
		}

		quit backpage_"|"_forwardpage
	} elseif pagename="editsession.csp"	{
		if diagram="A"	{
			set backpage=prowebRoot_basketPageID
			// double check we can go to the session page
			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set forwardpage=prowebRoot_chooseSessionsPageID
			} else { // otherwise back to the basket
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="B"	{
			set backpage=prowebRoot_basketPageID
			// double check we can go to the session page
			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set forwardpage=prowebRoot_chooseSessionsPageID
			} else { // otherwise back to the basket
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="C"	{
			set backpage=prowebRoot_basketPageID
			// double check we can go to the session page
			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set forwardpage=prowebRoot_chooseSessionsPageID
			} else { // otherwise back to the basket
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if diagram="D"	{
			set backpage=prowebRoot_basketPageID
			// double check we can go to the session page
			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set forwardpage=prowebRoot_chooseSessionsPageID
			} else { // otherwise back to the basket
				set forwardpage=prowebRoot_basketPageID
			}
		}
		if (diagram="E")!(diagram="H")	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="G"	{
			set backpage=""
			set forwardpage=""
		}
		if diagram="J"	{
			set backpage=prowebRoot_basketPageID
			// double check we can go to the session page
			if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID,tempPersonID) { // if sessions are defined
				set forwardpage=prowebRoot_chooseSessionsPageID
			} else { // otherwise back to the basket
				set forwardpage=prowebRoot_basketPageID
			}
		}

		quit backpage_"|"_forwardpage

	} else {
		// required for cache 2007.1 to compile but should never happen
		quit "nowhere|nowhere"	
	}
]]></Implementation>
</Method>

<Method name="getProgress">
<ClassMethod>1</ClassMethod>
<FormalSpec>page,pageID,sessionID,xEventID,xLangID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	/// First work out which diagram I am using
	
	set eventConfiguration = ##class(setup.eventConfiguration).createForEventID(xEventID)
	set isTicketingPersonMode=+##class(cod.objTicket).isTicketingPersonMode(xEventID)
	set isGroupBookings=+##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)
	set isAnonymousMode=+##class(setup.objEventSetting).getParameter("system","do not use email",xEventID)
	set singleEmailPerEvent=0
	if isAnonymousMode {
		// New mode - singleEmailPerEvent - like anonymous but with unique email address per event. Page flow should include tRegisterEmailNew.csp
		set singleEmailPerEvent=##class(setup.objEventSetting).getParameter("system","anonymous - single email per event",xEventID)
	}
	// multicatregpages = do we have more than one category to ask the delegate
	//  - NOT do we have more than one reg page per category as that's always allowed
	set backendBooking=+##class(eCom.tempPurchase).isBackendBooking(sessionID)
	set isMultiCategoryRegPages=+(##class(setup.lnkCategoryEvent).numCategories(xEventID,xLangID,+backendBooking)>1)
	
	// are we doing table bookings?
	set isTableBooking=0
	if ##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID) set isTableBooking=1
	
	set isAwards=+##class(setup.objEventSetting).getParameter("system","isAwardsEvent",xEventID)
	
	// are we doing hotel bookings for this event? (and do we have any venues setup for this event)
	set firstVenuePageID="",isAccom=0
	if ##class(setup.objEventSetting).getParameter("bookings","allow accommodation bookings",xEventID)	{
		// get the first venuepageID (the rest will also be displayed in this page)
		if ##class(accom.objEventHotel).getFirstVenuePageID(xEventID) {
			set isAccom=1
		}
	}
	set accomOnlyEvent=0
	if ##class(setup.objEventSetting).getParameter("bookings","only accommodation bookings",xEventID) set accomOnlyEvent=1
	set (showAccom,newAccomEvent,hasAccom)=0
	
	set (accomChooseDatesPageID,accomHotelListPageID,accomGuestPageID,accomEditPageID)=""
	if isAccom {
		set newAccomEvent=##class(setup.objEventSetting).getParameter("bookings","use new accommodation page flow",xEventID)
	}
	// is this a meeting manager event?

	set diagram=""
	if (isGroupBookings=0)&(isMultiCategoryRegPages=0) set diagram="A"	// based on event settings
	if (isGroupBookings=1)&(isMultiCategoryRegPages=0) set diagram="B"	// based on event settings
	if (isGroupBookings=0)&(isMultiCategoryRegPages=1) set diagram="C"	// based on event settings
	if (isGroupBookings=1)&(isMultiCategoryRegPages=1) set diagram="D"	// based on event settings
	if isAwards=1 {
		set diagram="E"					// regular awards
		if ##class(setup.objEventSetting).getParameter("awards","use sections",xEventID) set diagram="H" // the US/UK awards with sections
	}
	if accomOnlyEvent=1,isAccom set diagram="G"				// based on event setting
	if isTableBooking {
		set diagram="I"
	}
	if isTicketingPersonMode,isGroupBookings set diagram="J"  // can only do this using bookers page
	if accomOnlyEvent=1,newAccomEvent set diagram="K" // new accommodation page flow
	set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xLangID,backendBooking,.allRegPages,.allRegPageIDs) 
	
	set pageCount=0,thisPageNo="N/A"
	
	if diagram="A" {
		// registerEmailNew/Amend
		if page["registeremail" set thisPageNo=0
		
		// The registration pages (count the maximum)
		set (eventCategoryID,displayOrder)="",maxPageCount=0
		for {
			set eventCategoryID=$O(allRegPages(eventCategoryID))
			if eventCategoryID="" quit
			set tmpPageCount=0
			for {
				set displayOrder=$O(allRegPages(eventCategoryID,displayOrder))
				if displayOrder="" quit
				set tmpPageCount=tmpPageCount+1
				if pageID=allRegPages(eventCategoryID,displayOrder) set thisPageNo=pageCount+tmpPageCount
			}
			if tmpPageCount>maxPageCount set maxPageCount=tmpPageCount
		}
		set pageCount=pageCount+maxPageCount
		// Count the choose days pages
		if ##class(setup.objEvent).showChooseDays(xEventID,sessionID) { // if switched on in eventDetails
			set pageCount=pageCount+1
			if page["choosedays" set thisPageNo=pageCount
		}
		// Count the choose sessions pages
		if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID) { // if sessions are defined
			set pageCount=pageCount+1
			if page["chooseitems" set thisPageNo=pageCount
		}
		// Count the new accommodation pages
		if newAccomEvent {
			set pageCount=pageCount+1
			if page["taccomchoosedates" set thisPageNo=pageCount
			set pageCount=pageCount+1
			if page["taccomhotellist" set thisPageNo=pageCount
			if ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
				set pageCount=pageCount+1
				if page["taccomguest" set thisPageNo=pageCount
			}
		}
		// Count the old accommodation pages
		if isAccom,'newAccomEvent {
			set pageCount=pageCount+1
			if page["tvenuesummary" set thisPageNo=pageCount
			set pageCount=pageCount+1
			if page["thotelbooking" set thisPageNo=pageCount
		}
	} elseif diagram="B" {
		// select booking mode
		if page["tselectbookingmode" set thisPageNo=0
		// registerEmailNew/Amend
		set pageCount=pageCount+1
		if page["registeremail" set thisPageNo=pageCount
		// booker page
		set pageCount=pageCount+1
		if page["tbooker" set thisPageNo=pageCount
		if isTableBooking {
			set pageCount=pageCount+1
			if page["ttableguests" set thisPageNo=pageCount
		}
		// delegate UID page
		if page["tdelegateuid" set thisPageNo=pageCount
		
		// The registration pages (count the maximum)
		set (eventCategoryID,displayOrder)="",maxPageCount=0
		for {
			set eventCategoryID=$O(allRegPages(eventCategoryID))
			if eventCategoryID="" quit
			set tmpPageCount=0
			for {
				set displayOrder=$O(allRegPages(eventCategoryID,displayOrder))
				if displayOrder="" quit
				set tmpPageCount=tmpPageCount+1
				if pageID=allRegPages(eventCategoryID,displayOrder) set thisPageNo=pageCount+tmpPageCount
			}
			if tmpPageCount>maxPageCount set maxPageCount=tmpPageCount
		}
		set pageCount=pageCount+maxPageCount
		
		// Count the choose days pages
		if ##class(setup.objEvent).showChooseDays(xEventID,sessionID) { // if switched on in eventDetails
			set pageCount=pageCount+1
			if page["choosedays" set thisPageNo=pageCount
		}
		// Count the choose sessions pages
		if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID) { // if sessions are defined
			set pageCount=pageCount+1
			if page["chooseitems" set thisPageNo=pageCount
		}
		// Count the new accommodation pages
		if newAccomEvent {
			set pageCount=pageCount+1
			if page["taccomchoosedates" set thisPageNo=pageCount
			set pageCount=pageCount+1
			if page["taccomhotellist" set thisPageNo=pageCount
			if ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
				set pageCount=pageCount+1
				if page["taccomguest" set thisPageNo=pageCount
			}
		}
		// Count the old accommodation pages
		if isAccom,'newAccomEvent {
			set pageCount=pageCount+1
			if page["tvenuesummary" set thisPageNo=pageCount
			set pageCount=pageCount+1
			if page["thotelbooking" set thisPageNo=pageCount
		}
	} elseif diagram="C" {
		// registerEmailNew/Amend
		if page["registeremail" set thisPageNo=0

		// Count the select category page 
		set pageCount=pageCount+1
		if page["tselectpersoncategory" set thisPageNo=pageCount
		// The registration pages (count the maximum)
		set (eventCategoryID,displayOrder)="",maxPageCount=0
		for {
			set eventCategoryID=$O(allRegPages(eventCategoryID))
			if eventCategoryID="" quit
			set tmpPageCount=0
			for {
				set displayOrder=$O(allRegPages(eventCategoryID,displayOrder))
				if displayOrder="" quit
				set tmpPageCount=tmpPageCount+1
				if pageID=allRegPages(eventCategoryID,displayOrder) set thisPageNo=pageCount+tmpPageCount
			}
			if tmpPageCount>maxPageCount set maxPageCount=tmpPageCount
		}
		set pageCount=pageCount+maxPageCount
		// Count the choose days pages
		if ##class(setup.objEvent).showChooseDays(xEventID,sessionID) { // if switched on in eventDetails
			set pageCount=pageCount+1
			if page["choosedays" set thisPageNo=pageCount
		}
		// Count the choose sessions pages
		if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID) { // if sessions are defined
			set pageCount=pageCount+1
			if page["chooseitems" set thisPageNo=pageCount
		}
		// Count the new accommodation pages
		if newAccomEvent {
			set pageCount=pageCount+1
			if page["taccomchoosedates" set thisPageNo=pageCount
			set pageCount=pageCount+1
			if page["taccomhotellist" set thisPageNo=pageCount
			if ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
				set pageCount=pageCount+1
				if page["taccomguest" set thisPageNo=pageCount
			}
		}
		// Count the old accommodation pages
		if isAccom,'newAccomEvent {
			set pageCount=pageCount+1
			if page["taccomchoosedates" set thisPageNo=pageCount
			set pageCount=pageCount+1
			if page["thotelbooking" set thisPageNo=pageCount
		}
	} elseif diagram="D" {
		// select booking mode
		if page["tselectbookingmode" set thisPageNo=0
		// Count the select category page 
		set pageCount=pageCount+1
		if page["tselectpersoncategory" set thisPageNo=pageCount
		// registerEmailNew/Amend
		set pageCount=pageCount+1
		if page["registeremail" set thisPageNo=pageCount
		// booker page
		set pageCount=pageCount+1
		if page["tbooker" set thisPageNo=pageCount
		if isTableBooking {
			set pageCount=pageCount+1
			if page["ttableguests" set thisPageNo=pageCount
		}
		// delegate UID page
		if page["tdelegateuid" set thisPageNo=pageCount
		
		// The registration pages (count the maximum)
		set (eventCategoryID,displayOrder)="",maxPageCount=0
		for {
			set eventCategoryID=$O(allRegPages(eventCategoryID))
			if eventCategoryID="" quit
			set tmpPageCount=0
			for {
				set displayOrder=$O(allRegPages(eventCategoryID,displayOrder))
				if displayOrder="" quit
				set tmpPageCount=tmpPageCount+1
				if pageID=allRegPages(eventCategoryID,displayOrder) set thisPageNo=pageCount+tmpPageCount
			}
			if tmpPageCount>maxPageCount set maxPageCount=tmpPageCount
		}
		set pageCount=pageCount+maxPageCount
		// Count the choose days pages
		if ##class(setup.objEvent).showChooseDays(xEventID,sessionID) { // if switched on in eventDetails
			set pageCount=pageCount+1
			if page["choosedays" set thisPageNo=pageCount
		}
		// Count the choose sessions pages
		if ##class(setup.objItem).anyItemsToChoose(eventConfiguration,sessionID) { // if sessions are defined
			set pageCount=pageCount+1
			if page["chooseitems" set thisPageNo=pageCount
		}
		// Count the new accommodation pages
		if newAccomEvent {
			set pageCount=pageCount+1
			if page["taccomchoosedates" set thisPageNo=pageCount
			set pageCount=pageCount+1
			if page["taccomhotellist" set thisPageNo=pageCount
			if ##class(setup.objEventSetting).getParameter("accommodation","get guest names",xEventID) {
				set pageCount=pageCount+1
				if page["taccomguest" set thisPageNo=pageCount
			}
		}
		// Count the old accommodation pages
		if isAccom,'newAccomEvent {
			set pageCount=pageCount+1
			if page["tvenuesummary" set thisPageNo=pageCount
			set pageCount=pageCount+1
			if page["thotelbooking" set thisPageNo=pageCount
		}
	} elseif (diagram="E")!(diagram="H") { // both diagrams are same for these purposes
		// registerEmailNew/Amend
		if page["registeremail" set thisPageNo=0
		
		set pageCount=pageCount+1
		if page["tawardsclient" set thisPageNo=pageCount
		
		// Count the choose days pages
		if ##class(setup.objEvent).showChooseDays(xEventID,sessionID) { // if switched on in eventDetails
			set pageCount=pageCount+1
			if page["choosedays" set thisPageNo=pageCount
		}
		
		set pageCount=pageCount+1
		if page["tchoosesection" set thisPageNo=pageCount
		
		set pageCount=pageCount+1
		if page["tawardsentry" set thisPageNo=pageCount
		
		set pageCount=pageCount+1
		if page["awardsoverview" set thisPageNo=pageCount
		
	} elseif diagram="G" {
		// registerEmailNew/Amend
		if page["registeremail" set thisPageNo=0
		
		
		// Count the old accommodation pages
		set pageCount=pageCount+1
		if page["tvenuesummary" set thisPageNo=pageCount
		set pageCount=pageCount+1
		if page["thotelbooking" set thisPageNo=pageCount
		// Count the registration page
		set pageCount=pageCount+1
		if page["tregistration" set thisPageNo=pageCount
		
	} elseif diagram="I" {
		// registerEmailNew/Amend
		if page["registeremail" set thisPageNo=0
		// booker page
		set pageCount=pageCount+1
		if page["tbooker" set thisPageNo=pageCount
		// table guest page
		set pageCount=pageCount+1
		if page["ttableguests" set thisPageNo=pageCount
	} elseif diagram="J" {
		// registerEmailNew/Amend
		if page["registeremail" set thisPageNo=0
		// booker page
		set pageCount=pageCount+1
		if page["tbooker" set thisPageNo=pageCount
		// table guest page
		set pageCount=pageCount+1
		if page["tregistration" set thisPageNo=pageCount
	} elseif diagram="K" {
		// registerEmailNew/Amend
		if page["registeremail" set thisPageNo=0
		
		// Count the old accommodation pages
		set pageCount=pageCount+1
		if page["taccomchoosedates" set thisPageNo=pageCount
		set pageCount=pageCount+1
		if page["taccomhotellist" set thisPageNo=pageCount
		set pageCount=pageCount+1
		if page["taccomguest" set thisPageNo=pageCount
		// Count the registration page
		set pageCount=pageCount+1
		if page["tregistration" set thisPageNo=pageCount
	}
	
	// accommodation edit is always one page away from the basket
	if page["taccomedit" set thisPageNo=pageCount
	// Count the basket page
	set pageCount=pageCount+1
	if page["basket" set thisPageNo=pageCount
	
	// Are there any payment pages?
	&SQL(SELECT instructionPageID INTO :tmp 
		FROM links.lnkEventPaymentMethod
		WHERE (objEvent = :xEventID)
	)
	if +SQLCODE=0,tmp {
		set pageCount=pageCount+1
	}
	if page["paymentmethod" set thisPageNo=pageCount
	
	// Count the receipt page
	set pageCount=pageCount+1
	if page["treceipt" set thisPageNo=pageCount
	
	quit pageCount_"|"_thisPageNo
]]></Implementation>
</Method>

<Method name="quitIfNoAttCat">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	// Check that we have an attendee category or it will crash later on. Redirect to start of registration if not. Fred june 2011
	set backforward="registerNew.csp|registerNew.csp"
	set ^xPageNav(+$H,%session.SessionId,$I(^xPageNav(+$H,%session.SessionId)),"no attCat")=pagename
	quit backforward
]]></Implementation>
</Method>

<Method name="getFirstRegistrationPage">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[eventCategoryID,&allRegPages]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	if '$D(allRegPages) {
		throw ##class(shared.exceptions.generalException).%New("Must pass in regPages")	
	}
	if 'eventCategoryID {
		throw ##class(shared.exceptions.generalException).%New("No eventCategoryID passed in")	
	}
	set displayOrder=$O(allRegPages(eventCategoryID,""))
	if 'displayOrder {
		throw ##class(shared.exceptions.generalException).%New("There are no registration pages for this attendee category")	
	}
	set pageID=allRegPages(eventCategoryID,displayOrder)
	set forwardpage=..getProwebRoot()_pageID
	quit forwardpage
]]></Implementation>
</Method>

<Method name="getNextPageFromOKToBookStatus">
<ClassMethod>1</ClassMethod>
<FormalSpec>okToBook</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set forwardpage=""
	if 'okToBook {
		if $p(okToBook,"|",2)=1 {
			set forwardpage="registrationEnded.csp?er=noMoreBookings"
		} else {
			set forwardpage="registrationEnded.csp?er=capacity"
		}
	}
	quit forwardpage
]]></Implementation>
</Method>

<Method name="isOKToStartWithPreselectedCategory">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventConfiguration:setup.eventConfiguration,tempPersonID,langID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set ok=1
	set tempPurchaseID=##class(eCom.tempPerson).getTempPurchaseID(tempPersonID)
	if 'tempPurchaseID quit ok
	set eventID=##class(eCom.tempPurchase).getEventID(tempPurchaseID)
	
	// If we are already assigned to a invitation only attendee category, we should go to the first registration page (like diagram A)
	set eventCategoryID=##class(eCom.tempPurchase).getEventCategory2(tempPurchaseID,tempPersonID,langID)
	if eventCategoryID {
		set hasPreselectedCategory=0
		if ##class(setup.lnkAttendeeCategoryDetailsEvent).isInvitationOnly(eventID,eventCategoryID) set hasPreselectedCategory=1
		if ##class(setup.objEventSetting).getParameter("preRegistration","pre-select attendee type",eventID) set hasPreselectedCategory=1	
		
		set ok=eventConfiguration.getAvailabilityChecker(eventCategoryID,tempPurchaseID, tempPersonID).isOKToBook()
		
	}
	
	quit ok
]]></Implementation>
</Method>

<Method name="getProwebRoot">
<ClassMethod>1</ClassMethod>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[	quit "../../system/proweb/start.csp?pageID="
]]></Implementation>
</Method>

<Method name="convertProceedKeyFromProweb2ToProweb1">
<Description>
add a 'T' to the proweb2 proceedKey to make it use the same page nav logic as proweb1</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename:%String,originalPageID:%String</FormalSpec>
<Private>1</Private>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if (originalPageID > 0) && (##class(sc.objTemplate).isProweb2ImplementedForPageName(pagename)) {
		set pagename = "t"_pagename	
	}
	return pagename
]]></Implementation>
</Method>
</Class>


<Class name="shared.pageMethods">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: shared.pageMethods.CLS/EV.185
;vc; Component: CLS.shared.pageMethods
;vc;  Location: LargeDev
;vc; Date/Time: 19-Jan-17 11:37
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>shared.pageMethods.CLS/EV.185</td><td>CLS.shared.pageMethods</td><td>LargeDev</td><td style='white-space: nowrap;'>19-Jan-17 11:37</td><td>FredG</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<ClassType/>
<ProcedureBlock>1</ProcedureBlock>
<TimeChanged>64273,39836</TimeChanged>
<TimeCreated>60747,44410.590792</TimeCreated>

<Method name="prePartOne">
<ClassMethod>1</ClassMethod>
<FormalSpec>frontback:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set ip=%request.GetCgiEnv("REMOTE_ADDR","no ip")
	set URL=$ZCVT(%request.URL,"L")				// this is the url and path: /evdev/frontend/reg/homepage.csp
	set pagename=$ZCVT(%request.PageName,"L")	// this is just the url: homepage.csp
	set cspAppName=##class(EF.config.clientData).getCSPAppForCurrentNameSpace()
	set appFromURL=$p(URL,"/",2)
	set pageID=%request.Get("pageID")

	if ..isApplicationStopped() {
		set %response.ServerSideRedirect=##class(shared.pageMethods).getURLforMaintenancePage(cspAppName)
		quit "0|0"
	}
	
	if ..isIncludePage() quit 1
	
	do ..updateLoadMonitor()
	
	do ..manageSEOrequest()
	
	do ..injectP3Ppolicy()
	
	do ..sanitiseRequestData()
	
	if ..isCrossSiteScripting() {
		set %response.Redirect=..getRedirectURLforXSS(cspAppName)
		quit "0|0"
	}

	do ..updatePageHistory()

	if pagename="errorpage.csp" quit "0|1"  // will force quit 1 from preHTTP
	
	if ##class(EF.config.clientData).isAppRedirected(appFromURL) {
		set %response.Redirect=..getURLForRedirectedApp(URL)
		quit "0|0"
	}

	if ..isNewFrontendSession(frontback,URL,pagename) {
		set %response.Redirect=..getRedirectURLforNewSession(pagename) // need to get new session set up if we do not have it and redirect to homepage.csp (for example if you go straight to dailyAgenda.csp)
		quit "0|0"
	}

	if ..hasSwitchedLanguage(frontback,URL,pagename) {
		set %response.Redirect=..getRedirectURLforNewLanguage(pagename)
		quit "0|0"
	}				
	
	if ..isBackendPageAuthorised(frontback,pagename)=0 {
		set %response.Redirect=..getRedirectURLforUnauthorisedBackendPage(pagename)
		quit "0|0"
	}
	if ##class(cod.methods).getCurrentBackendUser() {
		if pageID {
			if '(..isPageIDAllowedForBackendSession(pageID,pagename)) {
				set %response.Redirect=..getRedirectURLforUnauthorisedProwebPage(pagename,pageID) 
				quit "0|0"
			}
		}
	}
	do ..updateDebugInfo(URL,pagename)
	
	quit 1  // continue processing
]]></Implementation>
</Method>

<Method name="prePartThree">
<ClassMethod>1</ClassMethod>
<FormalSpec>frontback:%String,bypassLicenseCheck:%Boolean=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if ..isIncludePage() quit 1
	set ip=%request.GetCgiEnv("REMOTE_ADDR","no ip")
	set URL=$ZCVT(%request.URL,"L")				// this is the url and path: /evdev/frontend/reg/homepage.csp
	set pagename=$ZCVT(%request.PageName,"L")	// this is just the url: homepage.csp
	set userID=$G(%session.Data("eventsforce","backend","xPersonID"),"")
	
	// log page hit
	do ##class(admin.objLog).logNonProwebPage(userID,URL,"eventsForce")
	
	// am I in an include page?
	set includePage=0
	if $L(%request.Get("CSPInclude")) set includePage=1

	// set menu item selected if it's just been clicked
	if %request.Get("ef_sel_menu"),'includePage set %session.Data("eventsforce","frontend","menu","selected")=%request.Get("ef_sel_menu")
	
	// log backend hits
	if userID,%request.Get("storeBack"),'includePage	{
		set category=%request.Get("category")
		set subcategory=%request.Get("subcategory")
		set subsubcategory=%request.Get("subsubcategory")
		set subsubsubcategory=%request.Get("subsubsubcategory")
		// userID == personID
		do ##class(admin.objLogBackend).logPage(userID,%session.SessionId,category,subcategory,subsubcategory,subsubsubcategory)
	}
	
	// above does not work when gateway holds the app name - replaced with below
	set sharedPath="/"_$ZCVT(^%ZCSPAPPS($ZNSPACE),"L")
	set loginPage=sharedPath_"/backend/home/login.csp"
	set accessDenied=sharedPath_"/frontend/static/accessDenied.htm"
	set invalidURLPage=sharedPath_"/frontend/static/invalidURL.htm"

	set %session.Data("eventsforce",frontback,"requestPage")=URL

	// redirect to login if not logged in
	if frontback="backend"	{
		
		// check user has not logged in on one namespace and changed the URL to get into another clients area...
		if $G(%session.Data("eventsforce","backend","NAMESPACE"))'=$ZNSPACE,(URL'["login")&(URL'["tc.csp") set userID=""

		if userID=""&(URL'["login")&(URL'["tc.csp")&(URL'["initialisenamespace.csp")&(URL'["passwordreset") {
		set %session.Data("eventsforce",frontback,"beforeLogin")=URL
			set %response.Redirect=loginPage
			quit "0|0"
		}
		// Update the selectedMenuAccessID from the request variable to allow for multiple windows, tabs, etc..
		if (URL'["login")&(URL'["tc.csp")&(URL'["tc2.csp")&(URL'["logout.csp") {
			if $l(%request.Get("selectedMenuAccessID")) {
				// selectedMenuAccessID is set when clicking on a menu item
				set %session.Data("eventsforce","backend","xSelectedMenuAccessID")=%request.Get("selectedMenuAccessID")
			} elseif $l(%request.Get("xSelectedMenuAccessID")) {
				// Otherwise use xSelectedMenuAccessID
				set %session.Data("eventsforce","backend","xSelectedMenuAccessID")=%request.Get("xSelectedMenuAccessID")
			
			}
			if $L($G(%session.Data("eventsforce","backend","xSelectedMenuAccessID"))) set %response.Context("xSelectedMenuAccessID")=$G(%session.Data("eventsforce","backend","xSelectedMenuAccessID"))
		}

		// Update the event ID from the menu, if we do not have one goto the eventAdminList
		if ..doesBackendPageRequireEventID(pagename) {
			set xEventID=..requestGetEventID() 
			// We shouldn't select an event for dynamic
			if xEventID'="NEW",'##class(access.objFunction).hasFunction(userID,"Dynamic Reports Only") {
				if 'xEventID set xEventID=..getBackendEventIDFromSession()
				if 'xEventID set xEventID=##class(cod.objItemData).get(userID,"last event selected")
				
				// make sure they have access to their previous selected event - you never know...
				if '##class(links.lnkAccessPersonEvent).hasEvent(userID,xEventID) {
					set xEventID=""
					do ##class(cod.objItemData).set(userID,"last event selected","")
				}
				
				// Set the working language if we have just changed event
				if ##class(setup.objSystemTypes).isModuleAllowed("Multi Lingual Frontend") {
					if xEventID'=..getBackendEventIDFromSession() {
						set %session.Data("eventsforce","backend","xWorkLangID")=##class(setup.objEventSetting).getParameter("backend","default creation language",xEventID)
					}
				}
				if '$G(%session.Data("eventsforce","backend","xWorkLangID")) set %session.Data("eventsforce","backend","xWorkLangID")=1
				
				set %session.Data("eventsforce","backend","xEventID")=xEventID
				// redirect to the event selection unless they are support
				if ('xEventID)&&('##class(admin.objUser).isEFuser(userID)) { 
					set %response.Redirect=sharedPath_"/backend/home/eventSelection.csp"
					quit "0|0"
				}
			}
			
		}
	}

	// make sure frontend people cannot get to any page if event not live
	if $G(%session.Data("eventsforce","frontend","xEventID"))	{
		if $G(^xDEBUG) set ^xDEBUGPAGES($I(^xDEBUGPAGES),$ZTS,"here 8")=%session.Data("eventsforce","frontend","xEventID")
		// if userID is not numeric then we are not someone with a backend session open = general public
		// allow calls from Protx and Worldpay otherwise we cannot give a response for non-live events
		if 'userID&('##class(shared.pageMethodsFrontend).isPageAnAllowedEntryPage(URL)) {
			set objEvent=##class(setup.objEvent).%OpenId(%session.Data("eventsforce","frontend","xEventID"))
			if objEvent.status'="live"	{
				if $G(^xDEBUG) set ^xDEBUGPAGES($I(^xDEBUGPAGES),$ZTS,"here 8.1")=""
				set %response.Redirect=accessDenied
				kill objEvent
				quit "0|0"
			}
			kill objEvent
		}
	}
	
	if $G(^xDEBUG) set ^xDEBUGPAGES($I(^xDEBUGPAGES),$ZTS,"end of prePartThree - redirect=")=%response.Redirect
	quit 1  // continue processing
]]></Implementation>
</Method>

<Method name="resolvePath2">
<ClassMethod>1</ClassMethod>
<FormalSpec>inPath</FormalSpec>
<Implementation><![CDATA[
	// split the path up in two pieces no matter the case with our changing the case
	set loPath=$ZCVT(inPath,"L")
	
	//  allow images that don't use the standard images
	if loPath'["/default/" quit inPath
	
	set part1Len=$L($P(loPath,"/default/",1))
	
	// get rid of the "default"
	set part1=$E(inPath,1,part1Len)
	set part1=$p(part1,"/",1,$L(part1,"/")-1)
	
	// get the filename
	set part2Start=part1Len+10
	set part2=$E(inPath,part2Start,999)
	
	// are we in the frontend or the backend?
	set frontback=##class(shared.pCSP).frontBack()
	
	// do we have a client specific subdirectory for images?
	set subDir=$G(%session.Data("eventsforce",frontback,"xClientDir"))
	if subDir="" set subDir="default"

	// find our preferred language
	if frontback="frontend",$G(%session.Data("eventsforce",frontback,"xPrefLangID")) {
		set language=##class(shared.objLanguage).getLanguageDesc(%session.Data("eventsforce",frontback,"xPrefLangID"))
	} else {
		set language=$G(%session.Data("eventsforce",frontback,"xLanguage"))
	}
	
	// fall back to english if no language found (XT page etc)
	if language="" set language="English"

	// merge it all to a path	
	set outPath=part1_"/"_language_"/"_subDir_"/"_part2
	
	quit outPath
]]></Implementation>
</Method>

<Method name="resolveStyle2">
<ClassMethod>1</ClassMethod>
<FormalSpec>inPath</FormalSpec>
<Implementation><![CDATA[
	if $ZCVT(inPath,"L")'["default" quit inPath // spare proweb from path resolving

	// try to split the path up in two pieces no matter the case with our changing the case
	set loPath=$ZCVT(inPath,"L")
	set part1Len=$L($P(loPath,"/default/",1))
	set part1=$E(inPath,1,part1Len)
	set part2Start=part1Len+10
	set part2=$E(inPath,part2Start,999)
	
	set frontback=##class(shared.pCSP).frontBack()
	set subDir=$G(%session.Data("eventsforce",frontback,"xClientStyleDir"))
	if $L(subDir)>1 {
		set outPath=part1_"/"_$G(%session.Data("eventsforce",frontback,"xClientStyleDir"))_"/"_part2
	} else {
		set outPath=inPath	
	}
	
	quit outPath
]]></Implementation>
</Method>

<Method name="frontBack2">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set frontback=""
	// try this current page's URL
	if $ZCVT(%request.URL,"L")["/frontend/" set frontback="frontend"
	if $ZCVT(%request.URL,"L")["/backend/" set frontback="backend"
	// now try the previous page's URL (although this can be blocked by lots of firewall s/w)
	if frontback="",$ZCVT($G(%request.CgiEnvs("HTTP_REFERER")),"L")["/frontend/" set frontback="frontend"
	if frontback="",$ZCVT($G(%request.CgiEnvs("HTTP_REFERER")),"L")["/backend/" set frontback="backend"
	// if in template page (dir=/templates/dd)
	if frontback="",$L(%request.Get("frontback")) set frontback=%request.Get("frontback")
	if frontback="" set frontback="frontend"   // last resort, assume frontend to stop any dodgy access going on
	quit frontback
]]></Implementation>
</Method>

<Method name="outputFrontendHeader">
<ClassMethod>1</ClassMethod>
<FormalSpec>IECompatMode=0</FormalSpec>
<Implementation><![CDATA[
	// used to create the http header and can depend on eventID (as some templates may require this)
	set header=""
	set xEventID=$G(%session.Data("eventsforce","frontend","xEventID"))
	if xEventID="" set xEventID=..getBackendEventIDFromSession()

	set layoutTemplateID="",useHTML5=""
	if $G(xEventID) {
		set layoutTemplateID=##class(layout.objTemplate).getLayoutForEvent(xEventID)
		set useHTML5=##class(layout.objTemplate).isTemplateHTML5Compatible(layoutTemplateID)
	}
	
	set xLangID=$G(%session.Data("eventsforce","frontend","xPrefLangID"))
	if xLangID {
		set ISOlang=##class(shared.objLanguage).getISOCode(xLangID)
	} else {
		set ISOlang="en"	
	}
	
	set IEEdgeStr = "<meta http-equiv=""X-UA-Compatible"" content=""IE=edge"">"
	if (IECompatMode){
		set IEEdgeStr = ""
	}
	if xEventID,##class(setup.objEventSetting).getParameter("website","useHTTPheaderHTML4",xEventID)	{
		set header=header_"<!DOCTYPE HTML PUBLIC ""-//W3C//DTD HTML 4.01 Transitional//EN"" ""http://www.w3.org/TR/html4/loose.dtd"">"_IEEdgeStr_$C(13,10)
		set header=header_"<!--[if IE 7 ]>    <html class=""ef_frontend_ie7 ef-ie7"" lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 8 ]>    <html class=""ef_frontend_ie8 ef-ie8"" lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 9 ]>    <html class=""ef_frontend_ie9 ef-ie9"" lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if (gt IE 9)|!(IE)]><!--> <html lang="""_ISOlang_"""> <!--<![endif]-->"_$C(13,10)
		
	} elseif useHTML5 {  // need the html5 doctype for bootstrap responsive designs and also to make moxie tinymce 4.1.5 appear correctly
		set header=header_"<!DOCTYPE html>"_IEEdgeStr_$C(13,10)
		set header=header_"<!--[if IE 7 ]>    <html class=""ef_frontend_ie7 ef-ie7"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 8 ]>    <html class=""ef_frontend_ie8 ef-ie8"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 9 ]>    <html class=""ef_frontend_ie9 ef-ie9"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if (gt IE 9)|!(IE)]><!--> <html xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <!--<![endif]-->"_$C(13,10)

	} else {
		set header=header_"<!DOCTYPE html PUBLIC ""-//W3C//DTD XHTML 1.0 Transitional//EN"" ""http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"">"_IEEdgeStr_$C(13,10)
		set header=header_"<!--[if IE 7 ]>    <html class=""ef_frontend_ie7 ef-ie7"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 8 ]>    <html class=""ef_frontend_ie8 ef-ie8"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 9 ]>    <html class=""ef_frontend_ie9 ef-ie9"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if (gt IE 9)|!(IE)]><!--> <html xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <!--<![endif]-->"_$C(13,10)
	}
	quit header
]]></Implementation>
</Method>

<Method name="getDownloadExpiry">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	quit 5
]]></Implementation>
</Method>

<Method name="getFullPathVCard">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<Implementation><![CDATA[
	set overridingSSLmode="" // we might want to change parameterthis in the future if IE decides to give us grief with session cookie again
	quit ..getFullPath(eventID,overridingSSLmode)
]]></Implementation>
</Method>

<Method name="getFullPath">
<Description>
use this method to get the domain and cspapp name along with http or https
returns something like this: https://www.eventsforce.net/support2</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID="",overridingSSLmode=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 
	set browserDomain=""
	if $D(%request) set browserDomain=$ZCVT(%request.GetCgiEnv("SERVER_NAME"),"L") // use this to determine which backend domain to use/return
	// if calling from a non-web page then should be event related and pick up the event setting

	set useSSL=##class(setup.objSetting).getParameter("system","requires SSL")
	if overridingSSLmode'="" set useSSL=overridingSSLmode
	set fullURL=""

	// only use the event settings if we have specifically set the system setting (to make sure all values are set up correctly at event level)
	if eventID	{
		set fullURL=##class(setup.objEventSetting).getParameter("system","domain",eventID)
	}

	// get backend URLS
	if fullURL="" {
		set dom=##class(setup.objSetting).getParameter("system","domain 1")
		if $L(dom) set domains(dom)=""
		set dom=##class(setup.objSetting).getParameter("system","domain 2")
		if $L(dom) set domains(dom)=""
		set dom=##class(setup.objSetting).getParameter("system","domain 3")
		if $L(dom) set domains(dom)=""
		set dom=##class(setup.objSetting).getParameter("system","domain 4")
		if $L(dom) set domains(dom)=""
		set dom=##class(setup.objSetting).getParameter("system","domain 5")
		if $L(dom) set domains(dom)=""
		
		// check against current
		if $L(browserDomain) {
			set fullURL=browserDomain
			if '$D(domains(browserDomain)) set fullURL=##class(setup.objSetting).getParameter("system","domain 1")
		} else {
			// if not running from browser
			set fullURL=##class(setup.objSetting).getParameter("system","domain 1")
		}
	}
	if fullURL="" set fullURL="www.eventsforce.net"

	// add on the csp app name
	set fullURL=fullURL_"/"_##class(EF.config.clientData).getCSPAppForCurrentNameSpace()

	// make sure always lower case so when cookie path is used, it picks up correct cookie
	set fullURL=$ZCVT(fullURL,"L")
	
	// SSL or not?
	if useSSL	{
		set fullURL="https://"_fullURL
	} else {
		set fullURL="http://"_fullURL
	}
	
	quit fullURL
]]></Implementation>
</Method>

<Method name="removeOpenedImage">
<Description>
removes the image that updates eventsforce to tell us that the email has been opened.
we are doing this because this is not the real mail openeing, it is just a preview or a mainatence thing
pass in mailDate in $H format</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID,tempStream:%Library.Stream,mailDate=""</FormalSpec>
<ReturnType>%Library.Stream</ReturnType>
<Implementation><![CDATA[
	set domain=$P(##class(shared.pageMethods).getFullPath(xEventID),"/",3)
	if mailDate="" set mailDate=+$H	
	
	if mailDate<62498 { // 11-Feb-2012
		// email sent before March 2012 did not have the 'ef_xtmo' class on the opening image so we have to remove all images from the preview - Fred Feb 2012
		set orgString="<img src='http"
		set newString="<img alt='http"
		do tempStream.CopyFrom(##class(shared.streamFunctions).replaceString(tempStream,orgString,newString))																			
	}
	
	// made the opened mail image more specific so that only the mail opened link gets replaced not other images on the page
	set orgString2="<img class=""ef_xtmo"" src='http"   
	set newString2="<img class=""ef_xtmo"" alt='http"   // don't load the image or we will loose the session
	do tempStream.CopyFrom(##class(shared.streamFunctions).replaceString(tempStream,orgString2,newString2))																			
	
	// also remove <HTML> and <BODY> tags from the email stream while we are at it
	for tag="<!DOCTYPE html>","<HTML>","</HTML>","<BODY>","</BODY>" {
		do tempStream.CopyFrom(##class(shared.streamFunctions).replaceString(tempStream,tag,""))																			
	}
	
	
	do tempStream.Rewind()
	quit tempStream
]]></Implementation>
</Method>

<Method name="cleanIntRedirect">
<Description>
clean the passed in URL to make sure only allow an internal redirection</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>url</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if '##class(setup.objSetting).getParameter("system","clean internal redirects") quit url

	set invalidURL=0
	
	set url=$TR(url,"\","/")
	
	// get rid of the http bit at the front
	set lowerURL=$ZCVT(url,"L")
	if $E(lowerURL,1,7)="http://"	{
		set url=$E(url,8,$L(url))
		set invalidURL=1
	} elseif $E(lowerURL,1,8)="https://"	{
		set url=$E(url,9,$L(url))
		set invalidURL=1
	} elseif $E(lowerURL,1,5)="data:"	{
		set url=$E(url,6,$L(url))
		set invalidURL=1
	} else {
		// nothing
	}
	
	// if url has a domain name at the front, reject it
	if url["/" {
		set firstBit=$P(url,"/",1)
	} else {
		set firstBit=url
	}
	
	set allowedExtensions("CSP")=1
	set allowedExtensions("HTM")=1
	set allowedExtensions("HTML")=1
	set allowedExtensions("PDF")=1
	set domA=$P(firstBit,".",1),domB=$ZCVT($P(firstBit,".",2),"U")
	if $L(domA),$L(domB) set invalidURL=1
	if $L(domA),$L(domB),$G(allowedExtensions(domB)) set invalidURL=0  // allow CSP pages and other types in redirects...
	
	set sharedPath="/"_$ZCVT(^%ZCSPAPPS($ZNSPACE),"L")
	set invalidURLPage=sharedPath_"/frontend/static/invalidURL.htm?sr=224"
	if invalidURL set url=invalidURLPage

	quit url
]]></Implementation>
</Method>

<Method name="getPageID">
<Description>
 method to be used to get pageID to make sure it's "clean"</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>fromRequest=1</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set pageID=""
	if ..doesPageHaveAProwebPageID(%request.PageName) {
		if fromRequest set pageID=+%request.Get("pageID")
		if 'pageID set pageID=%session.Get("pageID") 
	}
	quit pageID
]]></Implementation>
</Method>

<Method name="isPageIDValidForEvent">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[eventID,pageID,&redirectURL]]></FormalSpec>
<Implementation><![CDATA[
	set out=1,redirectURL=""
	set pageEventID=##class(sc.methods).getEventIDfromPageID(pageID)
	if pageEventID {
		if eventID'=pageEventID {
			set out=0
			set redirectURL=..getFullPath(eventID)_"/frontend/reg/homepage.csp?traceRedir=5&eventID="_pageEventID_"&pageID="_pageID
		}
	}
	quit out
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// retrieve parameters without caring about upper/lower case

]]></Content>
</UDLText>

<Method name="getParamCaseInsensitive">
<ClassMethod>1</ClassMethod>
<FormalSpec>parameter</FormalSpec>
<Implementation><![CDATA[
	set out=""
	set m=""
	for  {
		set m=$O(%request.Data(m))
		if m="" quit
		set array($ZCVT(m,"L"))=%request.Get(m)	
	}
	set out=$G(array($ZCVT(parameter,"L")))
	
	if (parameter="pageID")!(parameter="eventID") set out=+out  // have to make sure this is numeric otherwise vulnerable to cross site scripting attacks by changing the value in URL
	quit out
]]></Implementation>
</Method>

<Method name="recoverEventID">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set eventID=""

	// try for duplicate, case insensitive parameters
 	set m="",hit=0
 	for  {
 		set m=$O(%request.Data(m))
 		if m="" quit
 		for index=1:1:3 {
 			if $ZCVT(m,"U")="EVENTID" {
	 			set hit=hit+1
	 			set tmp=$G(%request.Data(m,index))
	 			if tmp {
		 			set eventID=tmp
	 			}
 			}
 		}
 	}
 	if hit>1 merge ^%xNoEv(1,$p($ZTS,",",2),$ZNSPACE,%request.GetCgiEnv("REMOTE_ADDR","no ip")," 00","recover eventID from duplicate param array")=%request.Data

	set eventID=+eventID   // have to make sure this is numeric otherwise vulnerable to cross site scripting attacks by changing the value in URL
	if 'eventID set eventID=""   // seems there are loads of places checking eventID=""
	quit eventID
]]></Implementation>
</Method>

<Method name="requestGetEventID">
<Description>
this method replaces intersystems %request.Get-method because that one doesn't handle duplicate parameters</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set eventID=""
	
	//try regular method first
	set eventID=+%request.Get("eventID")  //  have to make sure this is numeric (so plussed it) otherwise vulnerable to cross site scripting attacks by changing the value in URL
	if eventID quit eventID 
	
	// try recover it if it was passed infrom fHome.csp
	set eventID=$G(%session.Data("eventsforce","frontend","fHome passed in xEventID"))
	if eventID {
		set ^%xNoEv(1,$p($ZTS,",",2),$ZNSPACE,%request.GetCgiEnv("REMOTE_ADDR","no ip")," 00","recovered eventID from fHome via session")=eventID 
		quit eventID
	}
	
	// not try case insenstive serach including duplicated params
	set eventID=..recoverEventID()

	if 'eventID set eventID=""   // seems there are loads of places checking eventID=""
	quit eventID
]]></Implementation>
</Method>

<Method name="getSurveyID">
<Description>
Is the page we're in a survey page</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set surveyID=""
	if 'pageID {
		set pageID=..getPageID()
	}
	
	if pageID {
		set parent="",grandParent=""
		&SQL(SELECT parent,parent->parent INTO :parent,:grandParent FROM sc.objData WHERE ID = :pageID)
		if +SQLCODE=0 {
			&SQL(SELECT description INTO :tmp FROM sc_xModules.objGroup WHERE ID = :grandParent)
			if +SQLCODE=0,$ZCVT(tmp,"U")="SURVEYS" {
				set surveyID=parent
			}
			
		}
	}
	quit surveyID
]]></Implementation>
</Method>

<Method name="switchEvent">
<Description>
newEventID can be blank </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xPersonID,newEventID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	do ..clearDownBackendVariables()
	do ..setupBackendEventVariables(newEventID)
	if newEventID do ..addToLastEventSelected(xPersonID,newEventID)
	if newEventID do ..addToMRU(xPersonID,newEventID)
	do ..clearBackendMenuCache()
	quit
]]></Implementation>
</Method>

<Method name="addToLastEventSelected">
<ClassMethod>1</ClassMethod>
<FormalSpec>xPersonID,xEventID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	if ##class(setup.objEvent).%ExistsId(xEventID) {
		do ##class(cod.objItemData).set(xPersonID,"last event selected",xEventID)
	}
]]></Implementation>
</Method>

<Method name="addToMRU">
<ClassMethod>1</ClassMethod>
<FormalSpec>xPersonID,xEventID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	if ##class(setup.objEvent).%ExistsId(xEventID) {
		set maxLinks=##class(setup.objSetting).getParameter("homepage","Number of items on Most Recently Used Event list")
		set delim=","
		set MRUlist=##class(cod.objItemData).get(xPersonID,"Most Recently Used Events")
		set addEventToList=1
		for i=1:1:$L(MRUlist,delim) {
			set tmpEventID=$P(MRUlist,delim,i)
			set mru(i)=tmpEventID
			if xEventID=tmpEventID set addEventToList=0
		}
		if addEventToList set mru(i+1)=xEventID

		// new rebuild the string 
		set newMRUlist="",i=""
		for j=1:1:maxLinks {
			set i=$O(mru(i),-1) 
			if i="" quit
			set newMRUlist=mru(i)_$S($L(newMRUlist):delim,1:"")_newMRUlist
		}

		if newMRUlist'=MRUlist { 
			do ##class(cod.objItemData).set(xPersonID,"Most Recently Used Events",newMRUlist)
		}
	}
]]></Implementation>
</Method>

<Method name="clearDownBackendSession">
<Description>
clears the backend session from all session variables when logging out</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	kill %session.Data("eventsforce","backend")
	kill %session.Data("eventsforce","frontend")
	kill %session.Data("password validated")
	do ##class(shared.pageMethods).clearBackendMenuCache()
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// this can be called while still being logged in to the backend.

]]></Content>
</UDLText>

<Method name="clearDownBackendVariables">
<Description>
this is clearing all "backend" except the items listed here</Description>
<ClassMethod>1</ClassMethod>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	set keep("NAMESPACE")=1
	set keep("xClientDir")=1
	set keep("xClientStyleDir")=1
	set keep("xPersonID")=1
	set keep("xUserID")=1

	set keep("xLangID")=1
	set keep("xLanguage")=1
	set keep("xWorkLangID")=1  // need this for page switching to remember current language

	set keep("xDateFormat")=1
	set keep("xTimeFormat")=1
	
	set keep("xEventID")=1
	
	set keep("orgunit event caching")=1
	
	
	// Settings that only affect your current session
	set keep("proweb emergency repair mode")=1
	set keep("override test colours")=1
	set keep("showLegacyMode")=1
	
	set keep("GlobalSystemSettings")=1
	
	set var=""
	for  {
		set var=$O(%session.Data("eventsforce","backend",var))
		if var="" quit
		
		if '$D(keep(var)) kill %session.Data("eventsforce","backend",var)
	}
]]></Implementation>
</Method>

<Method name="setupBackendEventVariables">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	set %session.Data("eventsforce","backend","xEventID")=xEventID
	set %session.Data("eventsforce","backend","xWorkLangID")=##class(setup.objEventSetting).getParameter("backend","default creation language",xEventID)
	if '$G(%session.Data("eventsforce","backend","xWorkLangID")) set %session.Data("eventsforce","backend","xWorkLangID")=1
]]></Implementation>
</Method>

<Method name="createBackendVariables">
<ClassMethod>1</ClassMethod>
<ProcedureBlock>0</ProcedureBlock>
<Implementation><![CDATA[
	if '$GET(xCreatedBackendVariables) {
		set xCreatedBackendVariables = 1

		set sessionID=%session.SessionId

		set xLangID=$G(%session.Data("eventsforce","backend","xLangID"))
		set xLanguage=$G(%session.Data("eventsforce","backend","xLanguage"))
		set xEventID=..getBackendEventIDFromSession()
		set xPersonID=$G(%session.Data("eventsforce","backend","xPersonID"))
		set xUserID=xPersonID
		set xEventDescription=$G(%session.Data("eventsforce","backend","xEventDescription"))

		set xControllerID=""
		if xEventID	{
			set xControllerID=##class(setup.objEvent).getControllerID(xEventID)
		}

		set xDateFormat=##class(setup.objSetting).getParameter("system","defaultDateFormat")
		set xDateFormat=##class(shared.dateFunctions).getBackendOutputDateFormat()
		if xDateFormat="" set xDateFormat=5 // dd/mmm/yyyy
		set xUserInputDateFormat=##class(shared.dateFunctions).getBackendInputDateFormat()
		set xFrontendInputDateFormat=""
		if xEventID {
			set xFrontendInputDateFormat=##class(setup.objEvent).getDateFormat(xEventID)
		}
		set %session.Data("eventsforce","backend","xDateFormat")=xDateFormat
		// using a new var for standard reports - this will get overridden by backendTopExcel so that CSV dates outputted are in an excel friendly form (format 25)  xDateReportFormat
		set xDateFormatForReports=xDateFormat

		set xTimeFormat=##class(shared.timeFunctions).getBackendOutputTimeFormat()
		if xEventID {
			set xFrontendTimeFormat=##class(setup.objEventSetting).getParameter("system","time format",xEventID)
		}
		set %session.Data("eventsforce","backend","xTimeFormat")=xTimeFormat
		
	}
]]></Implementation>
</Method>

<Method name="getWorkLangID">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if $D(%request) set xWorkLangID=%request.Get("xWorkLangID")
	if xWorkLangID="",$D(%session) set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if xWorkLangID="" set xWorkLangID=##class(setup.objEventSetting).getParameter("backend","default creation language",eventID)
	if xWorkLangID="",$D(%session) set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if xWorkLangID="" set xWorkLangID=1

	if $D(%session) set %session.Data("eventsforce","backend","xWorkLangID")=xWorkLangID
	return xWorkLangID
]]></Implementation>
</Method>

<Method name="getBackendEventIDFromSession">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	return $G(%session.Data("eventsforce","backend","xEventID"))
]]></Implementation>
</Method>

<Method name="clearBackendMenuCache">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	kill ^CacheTempUserMenu(%session.SessionId)
]]></Implementation>
</Method>

<Method name="tempPurchaseHasValidBooker">
<Description>
This method checks if the Booker's Identification property is set correctly. This method will be used to nullify booking if the event is using 'email' or 'username' as the identification 
and somehow those values disappear from the current session just before the booking is saved in the database.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%String,sessionID:%String</FormalSpec>
<Implementation><![CDATA[
	set ok=1
	set tempBookerID=##class(eCom.tempPerson).getBookerID(sessionID)
	if 'tempBookerID set ok=0
	
	// check if the booker's email address is populated correctly otherwise, report error.
	if ((ok) && ('##class(setup.objEventSetting).getParameter("system","do not use email",eventID))) {
	    set identifyBy = $S(##class(setup.objEventSetting).getParameter("system","identifying field",eventID)="username":"username",1:"email")
	    if '$L(##class(eCom.tempCodData).get(tempBookerID,identifyBy)) {
		    set ok=0
	    }
	}
	quit ok
]]></Implementation>
</Method>

<Method name="isEditMode">
<Description>
This method checks if the 'Edit' or 'Preview' flags are set for a proweb page. If so, it returns 1.
Browser dependent %request and %session objects are used here. So, it cannot be used anywhere other than CSP pages.</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set editMode = 0
	if %request.Get("hideButtons") set editMode=1
	if %session.Get("mode")="edit",'$G(%session.Data("inSitePageEditing")) set editMode=1
	quit editMode
]]></Implementation>
</Method>

<Method name="getEditMode">
<Description>
This returns the mode of the page E.g. Edit, Preview
Checks the request and the session so that it can be used in the page before the mode is set in the session
Browser dependent %request and %session objects are used here. So, it cannot be used anywhere other than CSP pages.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	
	set mode=%request.Get("mode")
	if '$l(mode) {
		set mode=%session.Get("mode")
	}
	
	quit mode
]]></Implementation>
</Method>

<Method name="addRequestDataForCurrentPageToURL">
<ClassMethod>1</ClassMethod>
<FormalSpec>inURL:%String</FormalSpec>
<Implementation><![CDATA[
	#dim returnURL As %String = inURL
	
	// Stop new gateway param:
	//   The CSPRQN parameter is the CSP Gateway Request ID, which is sent to Caché with each HTTP request. 
	//   Where available, the request ID is always recorded in the Gateway Event Log header records as a hexadecimal number (e.g. Request-ID: 3a).
	set exclude("CSPRQN")=""
	
	// should probably create a list of allowed parameters at some point
	set paramName=""
	for  {
		set paramName=$o(%request.Data(paramName))
		if paramName="" quit
		
 		set addParam=1
 		if returnURL[(paramName_"=") set addParam=0  // stop duplicates
 		if $D(exclude(paramName)) set addParam=0

		if addParam {
	 		set value=%request.Get(paramName)
	 		set returnURL=##class(EF.htmlGenerator).addParameterToURL(returnURL,paramName,value)
		}
	}
	
	return returnURL
]]></Implementation>
</Method>

<Method name="requestDataToParams">
<Description>
go through %request.Data and create a string to add to URLs
Deprecated as does not encode parameters - use addRequestDataForCurrentPageToURL instead</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>exclusionList=""</FormalSpec>
<Implementation><![CDATA[
	if '$D(%request) quit ""
	
	// convert exclusion list into array
	for i=1:1:$L(exclusionList,",") {
		set tmpM=$P(exclusionList,",",i)
		if $L(tmpM) set exclude(tmpM)=""
	}

	// should probably create a list of allowed parameters at some point
	set params="",m=""
	for  {
		set m=$o(%request.Data(m))
		if m="" quit
		
 		set addparam=1
 		if params[m_"=" set addparam=0  // stop duplicates
 		if $D(exclude(m)) set addparam=0
 		// Stop new gateway param:
 		//   The CSPRQN parameter is the CSP Gateway Request ID, which is sent to Caché with each HTTP request. 
 		//   Where available, the request ID is always recorded in the Gateway Event Log header records as a hexadecimal number (e.g. Request-ID: 3a).
 		if m="CSPRQN" set addparam=0  

		if addparam {
	 		//implement later: set tmpData=##class(%CSP.Page).EscapeURL(%request.Get(m))
	 		set tmpData=%request.Get(m)
			set params=params_$S($L(params):"&",1:"")_m_"="_tmpData
		}
	}
	
	// returns string without leading & or ? - calling program to add as appropriate
	quit params
]]></Implementation>
</Method>

<Method name="isRequestSecure">
<Description>
method for determining if the incoming request is secure or not </Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set out=0
	
	// in cases where the certificate is terminated on the actual web server
	if %request.Secure=1 set out=1				

	// in cases where the certificate is terminated on the load balancer
	if %request.GetCgiEnv("SERVER_PORT")=8443 set out=1
	
	quit out
]]></Implementation>
</Method>

<Method name="addParamsToURL">
<Description>
Pass in a valid inURL and it will append a parameter string to it
*** Deprecated as it does not encode the parameter, should instead use ##class(EF.htmlGenerator).addParameterToURL(inURL, name, value) ***</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>inURL,params</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// Remove leading  ? or &
	if ($e(params,1)="?")!($e(params,1)="&") {
		set params=$e(params,2,$l(params))
	}
	if $l(params) {
		if inURL["?" {
			set outURL=inURL_"&"_params
		} else {
			set outURL=inURL_"?"_params
		}
	} else {
		set outURL=inURL
	}
	quit outURL
]]></Implementation>
</Method>

<Method name="buildFrontendSessionVariablesFromEventID">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set %session.Data("eventsforce","frontend","xEventID")=xEventID
	set %session.Data("eventsforce","frontend","xClientDir")=##class(setup.objSetting).getParameter("paths","clientDirectory")
	set language=##class(setup.objEventSetting).getParameter("system","language",xEventID)   // v1.1.5
	set %session.Data("eventsforce","frontend","xLanguage")=language
	set %session.Data("eventsforce","frontend","xLangID")=##class(shared.objLanguage).getLanguageID(language)
	set xLangID=%session.Data("eventsforce","frontend","xLangID")
	set %session.Data("eventsforce","frontend","xDateFormat")=##class(setup.objEvent).getDateFormat(xEventID)
]]></Implementation>
</Method>

<Method name="getDisplayDescription">
<Description>
get displayable descriptions for certain words</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>inStr:%String</FormalSpec>
<Implementation><![CDATA[
	Set ret=inStr
	
	If (inStr="bookers") {
		Set ret=##class(shared.pCSP).out("Registration contacts")
	} elseif (inStr="delegates") {
		Set ret=##class(shared.pCSP).out("Attendees")
	} elseif (inStr="cancelled delegates") {
		Set ret=##class(shared.pCSP).out("Cancelled attendees")
	} elseif (inStr="BookingRef") {
		Set ret=##class(shared.pCSP).out("Registration ref")
	} elseif (inStr="BookerName") {
		Set ret=##class(shared.pCSP).out("Registration contact's name")
	} elseif (inStr="BookingType") {
		Set ret=##class(shared.pCSP).out("Registration type")
	} elseif (inStr="AdditionalBookingStatus") {
		Set ret=##class(shared.pCSP).out("Additional registration status")
	}
	
	Quit ret
]]></Implementation>
</Method>

<Method name="doesBackendPageRequireEventID">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	if (pagename["login") return 0
	if (pagename["tc.csp") return 0
	if (pagename["tc2.csp") return 0
	if (pagename["eventselection") return 0
	if (pagename["pagecontrollergrid") return 0
	if (pagename["eventcalendarmonthly.csp") return 0
	if (pagename["eventproperties") return 0
	if (pagename["eventcopy") return 0
	if (pagename["logout.csp") return 0
	if (pagename["mydetails.csp") return 0
	if (pagename["changepassword.csp") return 0
	if (pagename["changepasswordmodal.csp") return 0
	if (pagename["pagecontrollerstandardsave.csp") return 0
	if (pagename["pagecontrollerajaxsave.csp") return 0
	if (pagename["addusermetrics.csp") return 0
	if (pagename["passwordreset") return 0
	if (pagename["backendmenuredirect.csp") return 0
	if (pagename["serverstoragesetjson.csp") return 0
	if (pagename["listapperrors.csp") return 0
	
	return 1
]]></Implementation>
</Method>

<Method name="isPageEventRelated">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set pagename=$ZCVT(pagename,"L")
	if pagename="sessiondump.csp" return 0
	if pagename="listapperrors.csp" return 0
	if pagename="sysgettotallogins.csp" return 0
	if pagename="homepage.csp" return 0
	if pagename="initsession.csp" return 0
	if pagename="fhome.csp"	return 0
	return 1
]]></Implementation>
</Method>

<Method name="endSession">
<Description><![CDATA[
Ends current session and clears down cookies
<br/>Should still have %session available in page
<br/>Must be called from preHTTP]]></Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	Set %session.EndSession=1
 	Set Expires=+$H-1
 	Set Expires=$ZD(Expires,11) _ ", " _ $ZD(Expires,2) _ " 00:00:00 GMT"
 	do %response.SetCookie("CSPSESSIONID-SP-8443-UP-","",Expires,"/",,1,1)
]]></Implementation>
</Method>

<Method name="isApplicationStopped">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// stop application access while upgrading - will unfortunately output the ugly http header underneath the message.
	if $G(^%ZStopApplication($ZNSPACE)) {
		write "<b>Site unavailable, please come back later</b><br><br><br><br>Check in ^%ZStopApplication<br><br>"
		return 1
	}
	return 0
]]></Implementation>
</Method>

<Method name="isIncludePage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// quit the whole method if were are a measly include page of little importance
	if $L(%request.Get("CSPInclude")) {
		set pages="frontendHTTPheader.csp,frontendStyles.csp,frontendJS.csp,colourScheme.csp,progress.csp,frontEndButton.csp,commonHTTPheader.csp,socialMediaButtons.csp,frontendBottom.csp,"
		if $ZCVT(pages,"U")[$ZCVT($P(%request.Get("CSPInclude"),"/",$L(%request.Get("CSPInclude"))),"U") return 1
	}	
	return 0
]]></Implementation>
</Method>

<Method name="updateLoadMonitor">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	// update the current load monitor
	set currentMinute=($P($ZT($P($H,",",2),2),":",2)+1) // 10:23 -> 24 and 13:00 -> 1
	kill ^["EVCOMMON"]qLoadMonitor($S(currentMinute=60:1,1:currentMinute+1)) // kill the next minute
 	if $ZCVT("start.csp","U")'[$ZCVT(%request.PageName,"U") {
		set ^["EVCOMMON"]qLoadMonitor(currentMinute)=$G(^["EVCOMMON"]qLoadMonitor(currentMinute))+1
	}
]]></Implementation>
</Method>

<Method name="manageSEOrequest">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set fromSEO=0
	if ##class(setup.seoFiles).isSEOrequest()	{
		set fromSEO=1  // has this request originated from the mini virtual website (SEO mode)?
		do ##class(setup.seoFiles).addSEOcodePre()
	}
	if 'fromSEO do %response.SetHeader("X-Robots-Tag","noindex")   // to stop Google from showing the page link even if it finds it as a link from another site
]]></Implementation>
</Method>

<Method name="injectP3Ppolicy">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	// fix the problem with IE and privacy when in IFRAMES/FRAMESETS - but needs to be done on all resources that are setting cookies (css/js etc.) so done in IIS instead.
	if ##class(setup.objSetting).getParameter("system","Inject P3P policy") {
		do %response.SetHeader("P3P","CP=""Internet Explorer requires this in order to set session cookies""")
	}
]]></Implementation>
</Method>

<Method name="sanitiseRequestData">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set name=""
	for  {
 		set name=$O(%request.Data(name))
 		if name="" quit
 		if $E(name,1,6)="Error:" continue  // errors contain control chars...
 		set value=%request.Get(name)
 		if '$IsObject(value) {
			set %request.Data(name,1) = ##class(EF.sanitiser).sanitise(value)
 		}
	}
]]></Implementation>
</Method>

<Method name="isCrossSiteScripting">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// check for cross scripting
 	set sharedPageM="",crossScriptingAttack=0
 	set sharedPageAllowedVars("CSPToken")=""
 	set sharedPageAllowedVars("CSPPAGE")=""
 	set sharedPageAllowedVars("Error:ErrorCode")=""
	// backend
 	set sharedPageAllowedVars("editBox")=""
 	set sharedPageAllowedVars("rawText")=""
 	set sharedPageAllowedVars("txtPrompt")=""
 	set sharedPageAllowedVars("textHTML")=""
 	set sharedPageAllowedVars("requiredAnswer")="" // contains pattern matches that are sensitive
 	set sharedPageAllowedVars("txtEmailDetailsPageRawSubject")="" 

	// exclude the style edit boxes and URL field for the menu blocks (proweb\menudetails.csp)
 	set sharedPageAllowedVars("txtULStyle")=""
  	set sharedPageAllowedVars("txtLIStyle")=""
 	set sharedPageAllowedVars("txtLISelectedStyle")=""
 	set sharedPageAllowedVars("txtAStyle")=""
 	set sharedPageAllowedVars("txtAHoverStyle")=""
 	set sharedPageAllowedVars("txtASelectedStyle")=""
 	set sharedPageAllowedVars("txtMILIStyle")=""
 	set sharedPageAllowedVars("txtMILISelectedStyle")=""
 	set sharedPageAllowedVars("txtMIAStyle")=""
 	set sharedPageAllowedVars("txtMIAHoverStyle")=""
 	set sharedPageAllowedVars("txtMIASelectedStyle")=""
 	set sharedPageAllowedVars("txtMILinkURL")=""
	set sharedPageAllowedVars("txtUserMessageBodyBE")=""
 	set sharedPageAllowedVars("moxieElement*")=""
 	set sharedPageAllowedVars("hiddenmoxieElement*")=""
 	
 	set allowedHTMLTagsVar("abstractTitle")=""
 	set allowedHTMLTagsVar("txtMailFrom")=""
 	
 	set stopExtraScripting=1
 	
 	set pagesAllowedToSubmitHTML("pagecontrollerstandardsave.csp")=""
 	set pagesAllowedToSubmitHTML("pagecontrollerajaxsave.csp")=""
 	set pagesAllowedToSubmitHTML("serverstoragesetjson.csp")=""

 	set currentPageName=$ZCVT(%request.PageName,"L")
	set pageName=""
	for	 {
		set pageName=$O(pagesAllowedToSubmitHTML(pageName))
		if pageName="" quit
		
		if $ZCVT(pageName,"U")=$ZCVT(currentPageName,"U") {
	 		set stopExtraScripting=0	
		}
 	}
 	
 	
 	for  {
 		set sharedPageM=$O(%request.Data(sharedPageM))
 		if sharedPageM="" quit
 		
 		set isExcluded=0
 		if $D(sharedPageAllowedVars(sharedPageM)) set isExcluded=1
 		if $D(sharedPageAllowedVars($P(sharedPageM,"_",1)_"*")) set isExcluded=1 // note that the field name must contain underscore for wildcards to work

 		if isExcluded=0 {
	 		// it seems that %3c gets converted to < when stored in %request but I'll leave the one above in case
	 		if $ZCVT(%request.Get(sharedPageM),"L")["%3cscript" set crossScriptingAttack=1
	 		if $ZCVT(%request.Get(sharedPageM),"L")["<script" set crossScriptingAttack=1
	 		if $ZCVT(%request.Get(sharedPageM),"L")["javascript:",%request.Get(sharedPageM)'="badgePrint()" set crossScriptingAttack=1

			if stopExtraScripting {
				// more restrictions
		 		if $ZCVT(%request.Get(sharedPageM),"L")["%3cimg" set crossScriptingAttack=1
		 		if $ZCVT(%request.Get(sharedPageM),"L")["<img" set crossScriptingAttack=1
		 		if $ZCVT(%request.Get(sharedPageM),"L")["onerror" set crossScriptingAttack=1
				// remove CRLF from var names (can't do the values as we may get posting of text areas with CRLFs
				if sharedPageM[$C(13) set crossScriptingAttack=1
				if sharedPageM[$C(10) set crossScriptingAttack=1
		
				// do a catch all for HTML code submitted in any var
				// don't stop it, just change it so that the value stored is not a real HTML character but should be displayed OK as a lt sign
				// allow the email from fields in preregister.csp as now can add names too: "Jeremy Ward" <jeremy@eventsforce.com>
				if (('$D(allowedHTMLTagsVar(sharedPageM)))
					&& (%request.Get(sharedPageM)["<")
					&& (sharedPageM'["txtEmailFrom")
					&& (sharedPageM'["txtFromAddress")
					) {
					set tmpVar=%request.Get(sharedPageM)
					set tmpVar=##class(shared.stringFunctions).hyperTranslate(tmpVar,"<","&lt;")
					set %request.Data(sharedPageM,1)=tmpVar
				}
				if (('$D(allowedHTMLTagsVar(sharedPageM)))
					&& (%request.Get(sharedPageM)[">")
					&& (sharedPageM'["txtEmailFrom")
					&& (sharedPageM'["txtFromAddress")
					) {
					set tmpVar=%request.Get(sharedPageM)
					set tmpVar=##class(shared.stringFunctions).hyperTranslate(tmpVar,">","&gt;")
					set %request.Data(sharedPageM,1)=tmpVar
				}
				if (('$D(allowedHTMLTagsVar(sharedPageM)))
					&& (%request.Get(sharedPageM)[$C(34))
					&& (sharedPageM'["txtEmailFrom")
					&& (sharedPageM'["txtFromAddress")
					) {
					set tmpVar=%request.Get(sharedPageM)
					set tmpVar=##class(shared.stringFunctions).hyperTranslate(tmpVar,$C(34),"&quot;")
					set %request.Data(sharedPageM,1)=tmpVar
				}
			}
			
			if ##class(setup.objSetting).getParameter("owasp","stop CRLF injection") {
				set querystring = %request.GetCgiEnv("QUERY_STRING")
				do ##class(EF.net.url).querystringToArray(querystring, .querystringArray)
				// CRLF injection only a problem when parameters are on the URL, can be a GET or a POST as POST URLs can have parameters too
				if $Data(querystringArray(sharedPageM))	 {
					if %request.Get(sharedPageM)[$Char(13) set crossScriptingAttack=1
					if %request.Get(sharedPageM)[$Char(10) set crossScriptingAttack=1
				}
			} else {
				if %request.Method="GET" {		
					if %request.Get(sharedPageM)[$C(13) set crossScriptingAttack=1
					if %request.Get(sharedPageM)[$C(10) set crossScriptingAttack=1
				}
			}
 		}
 		
		// exit now if cross scripting found, then store the sharedPageM var found for future reference
 		if crossScriptingAttack quit
 	}
	if crossScriptingAttack	{
		// Store this for now - in case we have issues with some fields not covered by above. 
		// Longer term we should remove this to avoid storage issues if massive requests by a hacker.
		set tmpKey=$I(^%ZCrossScripting($ZNSPACE,+$ZTS))
		set ^%ZCrossScripting($ZNSPACE,+$ZTS,tmpKey,"name")=sharedPageM
		if $L(sharedPageM) set ^%ZCrossScripting($ZNSPACE,+$ZTS,tmpKey,"value")=%request.Get(sharedPageM)
		set cspAppName=$ZCVT(^%ZCSPAPPS($ZNSPACE),"L")
		return 1
	} else {
		return 0	
	}
]]></Implementation>
</Method>

<Method name="hasStringBeenSanitisedForCrossSiteScripting">
<ClassMethod>1</ClassMethod>
<FormalSpec>inString</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set out=0
	if inString["&lt;" set out=1
	if inString["&gt;" set out=1
	if inString["&quot;" set out=1

	quit out
]]></Implementation>
</Method>

<Method name="getURLforMaintenancePage">
<ClassMethod>1</ClassMethod>
<FormalSpec>cspAppName</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "/"_cspAppName_"/system/maintenancePage.htm"
]]></Implementation>
</Method>

<Method name="getRedirectURLforXSS">
<ClassMethod>1</ClassMethod>
<FormalSpec>cspAppName</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "/"_cspAppName_"/frontend/static/invalidURL.htm?reason=csa"
]]></Implementation>
</Method>

<Method name="updatePageHistory">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	//  store page history
	set hdate=+$ZTS,htime=$P($ZTS,",",2)  
	set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)))=%session.AppTimeout_"|"_%request.URL_"|"_%request.PageName_"|"_%request.Get("CSPInclude")_"|SSL:"_..isRequestSecure()
]]></Implementation>
</Method>

<Method name="isNewFrontendSession">
<ClassMethod>1</ClassMethod>
<FormalSpec>frontback,URL,pagename</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set allowREDIRmethod=1
	if $G(^%xPAGESTOPREDIRMETHOD)=1 set allowREDIRmethod=0
	
	// need to get new session set up if we do not have it and redirect to homepage.csp (for example if you go straight to dailyAgenda.csp)
	if frontback="frontend" {
		if allowREDIRmethod {
			if (URL'["/xt/") {
				if $G(%session.Data("eventsforce","frontend","xEventID"))="" {
					if ..requestGetEventID() {
						if '$G(%session.Data("proweb","isSurvey")) { // need to ignore if survey page, since survey pages are not tied to events
							if ..isPageEventRelated(pagename) {
								return 1	 
							}
						}
					}
				}
			}
		}
	}
	return 0
]]></Implementation>
</Method>

<Method name="getRedirectURLforNewSession">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set pagename=$ZCVT(pagename,"L")
	set tmpEID=..requestGetEventID()
	set redirpage=..getFullPath(tmpEID)_"/frontend/reg/homepage.csp?traceRedir=2&eventID="_tmpEID
	
	// special treatment for these pages so that when in SEO mode, clicking on a link to them will redirect via homepage (as there will be no session set up initially)
	// don't want to do for all pages to avoid people bookmarking pages within the registration process etc.
	if (pagename="registernew.csp")!(pagename="registeramend.csp")!(pagename="dailyagenda.csp")!(pagename="dailyagendaalt.csp")	{
		set redirpage=redirpage_"&page="_pagename
	} elseif (pagename="tregisteremailnew.csp") {
		set redirpage=redirpage_"&page=registerNew.csp"
	} elseif (pagename="tregisteremailamend.csp") {
		set redirpage=redirpage_"&page=registerAmend.csp"
	} elseif (pagename="tdailyagenda.csp") {
		set redirpage=redirpage_"&page=dailyAgenda.csp"
	} elseif (pagename="tdailyagendaalt.csp") {
		set redirpage=redirpage_"&page=dailyAgendaalt.csp"
	} elseif (pagename="home")!(pagename="thome.csp")!(pagename="homepage.csp") {
		// use default redirpage
	} elseif %request.Get("pageID") {
		set redirpage=redirpage_"&pageID="_%request.Get("pageID")
	}
	if %request.Get("language") set redirpage=redirpage_"&language="_%request.Get("language")

	// log this
	set hdate=+$ZTS,htime=$P($ZTS,",",2) 
	set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)),"redirmethod")=redirpage

	return redirpage
]]></Implementation>
</Method>

<Method name="hasSwitchedLanguage">
<ClassMethod>1</ClassMethod>
<FormalSpec>frontback,URL,pagename</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set allowLANGmethod=1
	if $G(^%xPAGESTOPLANGMETHOD)=1 set allowLANGmethod=0

	// check the language - if a different language is passed as parameter then redirect to homepage
	if frontback="frontend" {
		if allowLANGmethod {
			if (URL'["/xt/"),%request.Get("language"),pagename'="homepage.csp",pagename'="fhome.csp"	{
				// if current lang is not what is on URL, redirect to home to switch it
				if %request.Get("language")'=$G(%session.Data("eventsforce","frontend","xPrefLangID"))	{
					return 1
				}
			}
		}
	}
	return 0
]]></Implementation>
</Method>

<Method name="getRedirectURLforNewLanguage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set ip=%request.GetCgiEnv("REMOTE_ADDR","no ip")
	set tmpEventID=..requestGetEventID() 
	if 'tmpEventID set tmpEventID=$G(%session.Data("eventsforce","frontend","xEventID"))
	if 'tmpEventID,%request.Get("pageID") {
		set tmpEventID=##class(sc.methods).getEventIDfromPageID(%request.Get("pageID")) 
		set ^%xNoEv(1,$p($ZTS,",",2),$ZNSPACE,ip,-16,"recover eventID from pageID")=tmpEventID
	}

	set redirpage=..getFullPath(tmpEventID)_"/frontend/reg/homepage.csp?traceRedir=3&eventID="_tmpEventID

	// special treatment for these pages so that when in SEO mode, clicking on a link to them will redirect via homepage (as there will be no session set up initially)
	// don't want to do for all pages to avoid people bookmarking pages within the registration process etc.
	if (pagename="registernew.csp")!(pagename="registeramend.csp")!(pagename="dailyagenda.csp")!(pagename="dailyagendaalt.csp")	{
		set redirpage=redirpage_"&page="_pagename
	}

	// log this
	set hdate=+$ZTS,htime=$P($ZTS,",",2) 
	set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)),"langmethod")=redirpage
	
	return redirpage
]]></Implementation>
</Method>

<Method name="isBackendPageAuthorised">
<ClassMethod>1</ClassMethod>
<FormalSpec>frontback,pagename</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// check if authorised to view the page (backend stuff)
	set allowAUTHmethod=1
	if $G(^%xPAGESTOPAUTHMETHOD)=1 set allowAUTHmethod=0
	
	set xPersonID=$G(%session.Data("eventsforce","backend","xPersonID"))
	set auth=1
	if frontback="backend" {
		if allowAUTHmethod {
			if pagename="userlist.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSUSER") set auth=0
			if pagename="userdetails.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSUSER") set auth=0
			if pagename="userdetails2.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSUSER") set auth=0
			if pagename="userrolelist.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSROLE") set auth=0
			if pagename="userroledetails.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSROLE") set auth=0
			if pagename="userroledetails2.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSROLE") set auth=0
		}	
	}
	return auth
]]></Implementation>
</Method>

<Method name="isPageIDAllowedForBackendSession">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,pageName</FormalSpec>
<Implementation><![CDATA[
	set pageName=$ZCVT(pageName,"L")
	if (..frontBack2()'="frontend")&&(pageName'="codquestiondetails.csp")&&(pageName'="codquestiondetails2.csp") {
		return 1	
	}
	if '##class(cod.methods).getCurrentBackendUser() {
		throw ##class(shared.exceptions.generalException).%New("No backend person ID for isPageIDAllowedForBackendSession")
	}
	if ##class(sc.pageMethods).isPageInFrontendRuntimeMode() {
		return 1	
	}
	if ##class(sc.xModules.objPage).%ExistsId(pageID) {
		set eventIDForPage=##class(sc.methods).getEventIDfromPageID(pageID)
		if 'eventIDForPage {
			return 1	
		}
		if eventIDForPage=..getBackendEventIDFromSession() {
			return 1
		}
	}
	return 0
]]></Implementation>
</Method>

<Method name="getRedirectURLforUnauthorisedBackendPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set xPersonID=$G(%session.Data("eventsforce","backend","xPersonID"))
	// redirect to simple unauthorised page if not allowed
	// log this
	set hdate=+$ZTS,htime=$P($ZTS,",",2)
	set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)),"authmethod")=xPersonID_"|"_pagename
	
	return "../../backend/home/unauth.csp"
]]></Implementation>
</Method>

<Method name="getRedirectURLforUnauthorisedProwebPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename,pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set xPersonID=$G(%session.Data("eventsforce","backend","xPersonID"))

	// redirect to simple unauthorised page if not allowed
	// log this
	set hdate=+$ZTS,htime=$P($ZTS,",",2)
	set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)),"authmethodpageid")=xPersonID_"|"_pagename_"|"_pageID
	
	return "../../frontend/static/invalidURL.htm"
]]></Implementation>
</Method>

<Method name="updateDebugInfo">
<ClassMethod>1</ClassMethod>
<FormalSpec>URL,pagename</FormalSpec>
<Implementation><![CDATA[
	// store a page history to aid debugging
	if $G(^xDEBUG) set ^xDEBUGPAGES($I(^xDEBUGPAGES),$ZTS,URL)=$G(%session.Data("eventsforce","frontend","xEventID"))
	if $G(^xDEBUG) set ^xDEBUGPAGES($I(^xDEBUGPAGES),$ZTS,"pagename")=pagename
]]></Implementation>
</Method>

<Method name="setHTTPHeaderForJSON">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	Set %response.ContentType="application/json"
	Set %response.CharSet="utf-8" //Required by cache, even though to the json standard specifies that CharSet should not be output in the header.
]]></Implementation>
</Method>

<Method name="getBackendWorkLangID">
<Description>
sets up the session variables based on the xWorkLangID. If that is not found, we fall back to xLangID which is the passed in default language. </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xLangID</FormalSpec>
<Implementation><![CDATA[
	set xWorkLangID=%request.Get("xWorkLangID")
	if xWorkLangID="" set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if xWorkLangID="" set xWorkLangID=xLangID
	set %session.Data("eventsforce","backend","xWorkLangID")=xWorkLangID	
	quit xWorkLangID
]]></Implementation>
</Method>

<Method name="getPageLanguageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<Implementation><![CDATA[
	set languageID=1
	&SQL(select description INTO :pageDescription FROM sc_xmodules.objpage WHERE id=:pageID)
	if +SQLCODE=0 {
		set languageName=$P(pageDescription," - ",2) // remove the language name	
		if $L(languageName) set languageID=##class(shared.objLanguage).getLanguageID(languageName)
	} else {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))	
	}
	quit languageID
]]></Implementation>
</Method>

<Method name="getURLForRedirectedApp">
<ClassMethod>1</ClassMethod>
<FormalSpec>url</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
	set eventID=..requestGetEventID()
	set path=$P(url,"/",3,$l(url,"/"))
	set extraParams=##class(shared.pageMethods).requestDataToParams("CSPToken,CSPCHD")
	set url=..getFullPath(eventID)_"/"_path
	if $l(extraParams) {
		set url=url_"?"_extraParams
	}
	return url
]]></Implementation>
</Method>

<Method name="getCurrentRelativeURLFromRequest">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	return %request.PageName_"?"_##class(shared.pageMethods).requestDataToParams("CSPPAGE,CSPToken,CSPCHD")
]]></Implementation>
</Method>

<Method name="setPageIDIntoSession">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<Implementation><![CDATA[	set %session.Data("pageID")=pageID
]]></Implementation>
</Method>

<Method name="doesPageHaveAProwebPageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageName</FormalSpec>
<Implementation><![CDATA[
	set pageName=$ZCVT(pageName,"L")
	if pageName="start.csp" {
		return 1
	} elseif ##class(sc.objTemplate).isPageNameProwebTemplate(pageName) {
		return 1
	}
	return 0
]]></Implementation>
</Method>

<Method name="getFrontendLanguageID">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	return $G(%session.Data("eventsforce","frontend","xPrefLangID"))
]]></Implementation>
</Method>

<Method name="getPathWithoutApplicationFromURL">
<Description>
E.g https://dev.efsys.net/largedevsrc/backend/dashboard/dashboard.csp returns backend/dashboard/dashboard.csp</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>url</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return $p(url,"/",3,99)
]]></Implementation>
</Method>

<Method name="getBackendKendoBaseURL">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageGeneration</FormalSpec>
<Implementation><![CDATA[
	if pageGeneration<4 {
		return "https://da7xgjtj801h2.cloudfront.net/2013.2.716/"
	} else {
		return "https://da7xgjtj801h2.cloudfront.net/2016.3.1118/"	
	}
]]></Implementation>
</Method>
</Class>
</Export>
