<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for Windows (x86-64) 2015.2 (Build 664_3_16032U)" ts="2016-10-14 11:56:44">
<Class name="EF.contextDataRegistration">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.contextDataRegistration.CLS/EV.4
;vc; Component: CLS.EF.contextDataRegistration
;vc;  Location: SmallDev
;vc; Date/Time: 02-Sep-16 14:23
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.contextDataRegistration.CLS/EV.4</td><td>CLS.EF.contextDataRegistration</td><td>SmallDev</td><td style='white-space: nowrap;'>02-Sep-16 14:23</td><td>JeremyW</td></tr></table>
]]></Description>
<Super>EF.contextData</Super>
<TimeChanged>64196,64348.208768</TimeChanged>
<TimeCreated>63755,56082.660879</TimeCreated>

<Property name="tempPurchaseID">
<Type>%Integer</Type>
</Property>

<Property name="isAmendment">
<Type>%Boolean</Type>
<InitialExpression>"0"</InitialExpression>
</Property>

<Property name="attendeeCategoryID">
<Type>%Integer</Type>
</Property>

<Property name="currencyID">
<Type>%Integer</Type>
</Property>

<Property name="tempPersonID">
<Type>%Integer</Type>
</Property>

<Property name="loggedInPersonID">
<Description>
if website is private, this will be set to the cod.objPerson.ID of that logged in person</Description>
<Type>%Integer</Type>
</Property>

<Property name="isBackendBooking">
<Type>%Boolean</Type>
<InitialExpression>"0"</InitialExpression>
</Property>

<Property name="pricingHorologUTC">
<Type>%Integer</Type>
</Property>

<Property name="isTestMode">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="context">
<Type>%String</Type>
<InitialExpression>"registration"</InitialExpression>
</Property>

<Property name="backendPersonID">
<Type>%Integer</Type>
</Property>

<Property name="pageID">
<Type>%Integer</Type>
</Property>

<Property name="prowebComponentName">
<Type>%String</Type>
<Parameter name="MAXLEN" value="255"/>
</Property>

<Property name="prowebMode">
<Type>%String</Type>
<Cardinality>one</Cardinality>
<Parameter name="VALUELIST" value=",&quot;edit&quot;,&quot;preview&quot;"/>
</Property>

<Property name="prowebFloatingMenuCounter">
<Type>%Integer</Type>
</Property>

<Property name="isBackendSuperUser">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Method name="createFromFrontendCSPSession">
<ClassMethod>1</ClassMethod>
<ReturnType>EF.contextDataRegistration</ReturnType>
<Implementation><![CDATA[
	#dim sessionID as %String = %session.SessionId
	
	set contextData = ##super()
	
	set contextData.tempPersonID=$G(%session.Data("eventsforce","frontend","currentPersonID"))
	set contextData.loggedInPersonID=$G(%session.Data("eventsforce","xtfrontend","MyAccount","personID"))
	set contextData.backendPersonID=$G(%session.Data("eventsforce","backend","xPersonID"))
	set contextData.attendeeCategoryID=##class(eCom.tempPurchase).getEventCategory(sessionID,contextData.tempPersonID)
	if contextData.attendeeCategoryID="" {
		if contextData.loggedInPersonID {
			// this will be used to restrict the categories of sessions in the daily agenda before registration
			set contextData.attendeeCategoryID=##class(links.lnkPersonEventCategory).getPreSelectedAttendeeCategoryID(contextData.eventID,contextData.loggedInPersonID)
		} else {
			set contextData.attendeeCategoryID = ##class(setup.lnkCategoryEvent).getDefault(contextData.eventID)	
		}
	}
	set contextData.currencyID=+##class(eCom.tempPurchase).getCurrencyID(sessionID)
	set contextData.isAmendment=+$G(%session.Data("eventsforce","frontend","amend"))
	set contextData.tempPurchaseID=##class(eCom.tempPerson).getTempPurchaseID(contextData.tempPersonID)
	set contextData.isBackendBooking=##class(eCom.tempPurchase).isBackendBooking(sessionID)
	set contextData.pricingHorologUTC=##class(eCom.tempPurchase).getPriceHorologUTC(contextData.tempPurchaseID)	
	set contextData.prowebMode=%session.Get("mode")
	set contextData.pageID=%session.Get("pageID")
	do contextData.setAuditPersonIDfromFrontend()
	
	set contextData.isBackendSuperUser=##class(eCom.tempPurchase).isBackendSuperUser(sessionID)
	
	return contextData
]]></Implementation>
</Method>

<Method name="createFromTempPersonID">
<ClassMethod>1</ClassMethod>
<FormalSpec>tempPersonID,langID,isAmendment:%Boolean</FormalSpec>
<ReturnType>EF.contextDataRegistration</ReturnType>
<Implementation><![CDATA[
	
	set contextData = ..%New()
	set tempPerson=##class(eCom.tempPerson).%OpenId(tempPersonID)
	do tempPerson.%Reload()
	
	set contextData.tempPurchaseID=tempPerson.tempPurchase.%Id()
	
	set controllerID=tempPerson.tempPurchase.objController.%Id()
	set contextData.eventID=##class(eCom.objController).getEventID(controllerID)
	set contextData.languageID=langID
	set contextData.tempPersonID=tempPerson.%Id()
	set contextData.sessionID=tempPerson.tempPurchase.sessionID
	set contextData.loggedInPersonID=""
	
	set contextData.attendeeCategoryID=##class(eCom.tempPurchase).getEventCategory(contextData.sessionID,contextData.tempPersonID)
	if contextData.attendeeCategoryID="" {
		if contextData.loggedInPersonID {
			// this will be used to restrict the categories of sessions in the daily agenda before registration
			set contextData.attendeeCategoryID=##class(links.lnkPersonEventCategory).getPreSelectedAttendeeCategoryID(contextData.eventID,contextData.loggedInPersonID)
		} else {
			set contextData.attendeeCategoryID = ##class(setup.lnkCategoryEvent).getDefault(contextData.eventID)	
		}
	}
	set contextData.currencyID=+##class(eCom.tempPurchase).getCurrencyID(contextData.sessionID)
	set contextData.isAmendment=isAmendment
	
	set contextData.isBackendBooking=##class(eCom.tempPurchase).isBackendBooking(contextData.sessionID)
	set contextData.pricingHorologUTC=##class(eCom.tempPurchase).getPriceHorologUTC(contextData.tempPurchaseID)	
	set contextData.prowebMode=""
	
	do contextData.setAuditPersonIDfromFrontend()
	if contextData.auditPersonID = "" {
		do contextData.setAuditPersonIDfromBackend()	
	}
	kill tempPerson
	return contextData
]]></Implementation>
</Method>

<Method name="createMock">
<ClassMethod>1</ClassMethod>
<ReturnType>EF.contextDataRegistration</ReturnType>
<Implementation><![CDATA[
	#dim mockpersonID as %Integer = 1
	
	set contextData = ..%New()
	
	set contextData.eventID=1
	set contextData.languageID=1
	set contextData.tempPersonID=mockpersonID
	set contextData.loggedInPersonID=mockpersonID
	set contextData.attendeeCategoryID=1
	set contextData.currencyID=1
	set contextData.isAmendment=0
	set contextData.tempPurchaseID=1
	set contextData.isBackendBooking=0
	set contextData.pricingHorologUTC=##class(shared.timeFunctions).getCurrentHorologUTC()
	set contextData.prowebMode="preview"
	set contextData.sessionID="mockSession"
	
	return contextData
]]></Implementation>
</Method>

<Method name="isMockSession">
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ..sessionID = "mockSession"
]]></Implementation>
</Method>

<Method name="getNewFloatingMenuCounter">
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set ..prowebFloatingMenuCounter = ..prowebFloatingMenuCounter+1
	return ..prowebFloatingMenuCounter
]]></Implementation>
</Method>
</Class>


<Class name="EF.contextDataRegistrationMock">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.contextDataRegistration.CLS/EV.4
;vc; Component: CLS.EF.contextDataRegistration
;vc;  Location: SmallDev
;vc; Date/Time: 02-Sep-16 14:23
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.contextDataRegistration.CLS/EV.4</td><td>CLS.EF.contextDataRegistration</td><td>SmallDev</td><td style='white-space: nowrap;'>02-Sep-16 14:23</td><td>JeremyW</td></tr></table>
]]></Description>
<Super>EF.contextDataRegistration</Super>
<TimeChanged>64178,51986.405601</TimeChanged>
<TimeCreated>63755,56082.660879</TimeCreated>

<Property name="tempPurchaseID">
<Type>%Integer</Type>
</Property>

<Property name="isAmendment">
<Type>%Boolean</Type>
<InitialExpression>"0"</InitialExpression>
</Property>

<Property name="attendeeCategoryID">
<Type>%Integer</Type>
</Property>

<Property name="currencyID">
<Type>%Integer</Type>
</Property>

<Property name="tempPersonID">
<Type>%Integer</Type>
</Property>

<Property name="loggedInPersonID">
<Description>
if website is private, this will be set to the cod.objPerson.ID of that logged in person</Description>
<Type>%Integer</Type>
</Property>

<Property name="isBackendBooking">
<Type>%Boolean</Type>
<InitialExpression>"0"</InitialExpression>
</Property>

<Property name="pricingHorologUTC">
<Type>%Integer</Type>
</Property>

<Property name="isTestMode">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="prowebMode">
<Type>%String</Type>
<Cardinality>one</Cardinality>
<Parameter name="VALUELIST" value=",&quot;edit&quot;,&quot;preview&quot;"/>
</Property>

<Property name="context">
<Type>%String</Type>
<InitialExpression>"registration"</InitialExpression>
</Property>

<Property name="backendPersonID">
<Type>%Integer</Type>
</Property>

<Property name="pageID">
<Type>%Integer</Type>
</Property>

<Property name="listID">
<Type>%Integer</Type>
</Property>

<Property name="isBackendSuperUser">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<ReturnType>EF.contextDataRegistration</ReturnType>
<Implementation><![CDATA[
	#dim mockTempPersonID as %Integer = 100
	#dim mockBackendUserD as %Integer = 1
	#dim mockEventID as %Integer = 15235
	#dim mockPageID as %Integer = 122589
	
	
	set contextData = ..%New()
	
	set contextData.componentName = "Main List"
	set contextData.eventID = mockEventID
	set contextData.pageID = mockPageID
	set contextData.languageID=1
	set contextData.tempPersonID = mockTempPersonID
	set contextData.loggedInPersonID = mockBackendUserD
	set contextData.attendeeCategoryID=1
	set contextData.currencyID=1
	set contextData.isAmendment=0
	set contextData.tempPurchaseID=1
	set contextData.isBackendBooking=0
	set contextData.pricingHorologUTC=##class(shared.timeFunctions).getCurrentHorologUTC()
	set contextData.prowebMode="preview"
	set contextData.sessionID="mockSession"
	
	return contextData
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.containerElement">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.pageController.containerElement.CLS/EV.17
;vc; Component: CLS.EF.pageController.containerElement
;vc;  Location: SmallDev
;vc; Date/Time: 02-Sep-16 14:23
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.pageController.containerElement.CLS/EV.17</td><td>CLS.EF.pageController.containerElement</td><td>SmallDev</td><td style='white-space: nowrap;'>02-Sep-16 14:23</td><td>JeremyW</td></tr></table>
]]></Description>
<Super>EF.pageController.element</Super>
<TimeChanged>64197,64052.57974</TimeChanged>
<TimeCreated>63372,47273.826383</TimeCreated>

<Property name="getContentsMethod">
<Type>%String</Type>
<Transient>1</Transient>
</Property>

<Method name="setAJAXMethod">
<FormalSpec>method</FormalSpec>
<Implementation><![CDATA[
	set ..getContentsMethod=method
	do ..page.allAJAXPageElements.SetAt($this,$this.identifier)
]]></Implementation>
</Method>

<Method name="processGetElement">
<Implementation><![CDATA[	do $method($this.page,..getContentsMethod)
]]></Implementation>
</Method>

<Method name="updateErrorMessage">
<FormalSpec>errorMessage</FormalSpec>
</Method>

<Method name="geGetProcessedElements">
<Description>
This is a list of all the elements that are updated by the processGetContents method </Description>
<ReturnType>%ListOfObjects</ReturnType>
<Implementation><![CDATA[
	set processedElements=##class(%ListOfObjects).%New()
	do processedElements.Insert($this)
	quit processedElements
]]></Implementation>
</Method>

<Method name="addCheckbox">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.checkbox</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.checkbox).addElementToParent($this,identifier,description,value,isReadOnly)

	quit element
]]></Implementation>
</Method>

<Method name="addRadioButtons">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.radioButtons</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.radioButtons).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addRadioGroup">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.containerElements.radioGroup</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.radioGroup).addElementToParent($this,identifier,description)
	quit element
]]></Implementation>
</Method>

<Method name="addRadio">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0,htmlName="",isSelected=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.radio</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.radio).addElementToParent($this,identifier,description,value,isReadOnly)
	if $L(htmlName) set element.uiComponent.htmlName=htmlName
	set element.uiComponent.isSelected=+value
	quit element
]]></Implementation>
</Method>

<Method name="addNumericInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.integerInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.numericInput).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addIntegerInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.integerInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.integerInput).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addTextInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.textInput).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addEmailInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.email).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addPasswordInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.password).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addTextArea">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.textArea).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addTextInputWithDisabler">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInputWithDisabler</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.textInputWithDisabler).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addHiddenInput">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElement).addElementToParent($this,identifier,description,value,isReadOnly)
	set element.uiComponent=##class(EF.ui.components.hiddenInput).%New(identifier)	
	return element
]]></Implementation>
</Method>

<Method name="addDropdown">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.dropdown</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.dropdown).addElementToParent($this,identifier,description,value,isReadOnly)
	
	quit element
]]></Implementation>
</Method>

<Method name="addSearchableDropdown">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElement</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.searchableDropdown).addElementToParent($this,identifier,description,value,isReadOnly)
	set element.uiComponent=##class(EF.ui.components.backend.searchableDropdown).%New(identifier)
	
	return element
]]></Implementation>
</Method>

<Method name="addToggle">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.radioButtons</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.radioButtons).addElementToParent($this,identifier,description,value,isReadOnly)
	do element.addAlternative(0,"Off")
	do element.addAlternative(1,"On")
	quit element
]]></Implementation>
</Method>

<Method name="addDatePicker">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.datePicker).addElementToParent($this,identifier,description,value,isReadOnly)

	quit element
]]></Implementation>
</Method>

<Method name="addDateTimePicker">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.dateTimePicker).addElementToParent($this,identifier,description,value,isReadOnly)

	quit element
]]></Implementation>
</Method>

<Method name="addTimePicker">
<FormalSpec>identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.textInput</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.inputElements.timePicker).addElementToParent($this,identifier,description,value,isReadOnly)

	quit element
]]></Implementation>
</Method>

<Method name="addCheckboxGroup">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.checkboxGroup</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.checkboxGroup).addElementToParent($this,identifier,description)
	
	quit element
]]></Implementation>
</Method>

<Method name="addResponsiveTable">
<FormalSpec>identifier:%String,description:%String=""</FormalSpec>
<ReturnType>EF.pageController.containerElements.panel</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.responsiveTable).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addPanel">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.panel</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.panel).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addPanelChart">
<FormalSpec>identifier:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.panelChart</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.panelChart).addElementToParent($this,identifier,"")
	set element.uiComponent=##class(EF.ui.components.backend.chart.panelChart).%New(identifier)
				

	quit element
]]></Implementation>
</Method>

<Method name="addList">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.list</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.list).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addOpenModalAjaxButton">
<FormalSpec>identifier:%String,description:%String,targetURL:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.button</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.button).addElementToParent($this,identifier,description)
	set element.uiComponent=##class(EF.ui.components.backend.buttonOpenModalAjax).%New(identifier)
	set element.uiComponent.targetURL=targetURL
	set element.uiComponent.label=description
	
	return element
]]></Implementation>
</Method>

<Method name="addModal">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.modal</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.modal).addElementToParent($this,identifier,description)
	
	quit element
]]></Implementation>
</Method>

<Method name="addOpenModalButton">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.openModal</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.openModal).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addCloseModalButton">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.closeModal</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.closeModal).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addOpenInFormModalButton">
<Description>
Creates a button that opens a modal defined by baseUrl and contentClass.
When submitted, the page controller will be validated and updated, but it will not run the save method.</Description>
<FormalSpec><![CDATA[identifier:%String,description:%String,baseUrl:%String,contentClass,&modalRequestData]]></FormalSpec>
<ReturnType>EF.pageController.buttons.openInFormModal</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.openInFormModal).addElementToParent($this,identifier,description)
	do element.setModalContentDefinition(contentClass,baseUrl,.modalRequestData)

	return element
]]></Implementation>
</Method>

<Method name="addTranslateButton">
<Description>
Adds a translation button with warning icon which opens an in-form modal</Description>
<FormalSpec><![CDATA[identifier:%String,description:%String,baseUrl:%String,contentClass:%String,showWarning:%Boolean,title:%String,&modalRequestData]]></FormalSpec>
<ReturnType>EF.pageController.buttons.openInFormModal</ReturnType>
<Implementation><![CDATA[
	set element=..addOpenInFormModalButton(identifier,description,baseUrl,contentClass,.modalRequestData)
	set element.uiComponent.title=title
	do element.uiComponent.addClass("ef-translate-button")
	set warningIcon=##class(EF.ui.components.backend.warningIcon).%New(identifier_"-warning-icon")
	do element.uiComponent.addChild(warningIcon)
	if showWarning {
		do element.uiComponent.addClass("ef-translate-button-show-warning")
	}
	return element
]]></Implementation>
</Method>

<Method name="addModalHeader">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.text</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.textElements.modalHeader).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addButton">
<FormalSpec>identifier:%String,description:%String,contentType:%String="text",buttonType:%String="secondary"</FormalSpec>
<ReturnType>EF.pageController.buttons.button</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.button).addElementToParent($this,identifier,description)
	set element.uiComponent.contentType=contentType
	set element.uiComponent.buttonType=buttonType

	quit element
]]></Implementation>
</Method>

<Method name="addSubmitButton">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.submit</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.submit).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addSubmitModalButton">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.submit</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.submit).addElementToParent($this,identifier,description)
	set element.uiComponent=##class(EF.ui.components.backend.buttonSubmitModal).%New(identifier)
	set element.uiComponent.label=description

	quit element
]]></Implementation>
</Method>

<Method name="addDeleteButton">
<FormalSpec>identifier:%String,description:%String,deleteMethod,objectID,confirmationMessage</FormalSpec>
<ReturnType>EF.pageController.buttons.submit</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.delete).addElementToParent($this,identifier,description)
	set element.deleteMethod=deleteMethod
	set element.objectId=objectID
	set element.uiComponent.confirmationMessage=confirmationMessage

	quit element
]]></Implementation>
</Method>

<Method name="addLinkButton">
<FormalSpec>identifier:%String,description:%String,href:%String</FormalSpec>
<ReturnType>EF.pageController.buttons.button</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.buttons.link).addElementToParent($this,identifier,description)
	set element.uiComponent.href=href

	quit element
]]></Implementation>
</Method>

<Method name="addText">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.text</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.text).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addTextAlertInfo">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.text</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.textElements.textAlertInfo).addElementToParent($this,identifier,description)

	quit element
]]></Implementation>
</Method>

<Method name="addInputGroup">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.inputGroup</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.inputGroup).addElementToParent($this,identifier,description)
	
	quit element
]]></Implementation>
</Method>

<Method name="addInputGroupNumber">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.inputGroupNumber</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.inputGroupNumber).addElementToParent($this,identifier,description)
	
	quit element
]]></Implementation>
</Method>

<Method name="addGridRemote">
<FormalSpec>identifier:%String,description=""</FormalSpec>
<ReturnType>EF.pageController.containerElements.gridRemote</ReturnType>
<Implementation><![CDATA[	return ##class(EF.pageController.containerElements.gridRemote).addElementToParent($this,identifier,description)
]]></Implementation>
</Method>

<Method name="addDiv">
<FormalSpec>identifier:%String,description=""</FormalSpec>
<ReturnType>EF.pageController.containerElements.div</ReturnType>
<Implementation><![CDATA[	return ##class(EF.pageController.containerElements.div).addElementToParent($this,identifier,description)
]]></Implementation>
</Method>

<Method name="addSpan">
<FormalSpec>identifier:%String,description=""</FormalSpec>
<ReturnType>EF.pageController.containerElements.span</ReturnType>
<Implementation><![CDATA[	return ##class(EF.pageController.containerElements.span).addElementToParent($this,identifier,description)
]]></Implementation>
</Method>

<Method name="addTranslatableTextInput">
<FormalSpec><![CDATA[identifier:%String,label:%String,translatablePhrase:translations.translatablePhrase,translationPageName,translationPageClass,&translationPageRequestData]]></FormalSpec>
<Implementation><![CDATA[
	#dim translation As translations.translation
	if translatablePhrase.hasTranslation() {
		set inputGroup=..addInputGroup(identifier_"-group",label)
		set translations=translatablePhrase.getTranslationsOrderedByLanguageName()
		set title=""
		set key=""
		set hasMissingTranslation=0
		for {
			set translation=translations.GetNext(.key)
			if key="" quit
			if title'="" {
				set title=title_$$$CRLF
			}
			set title=title_translation.languageName_": "_translation.translation
			if '$l(translation.translation) set hasMissingTranslation=1
		}
		set eventNameButton=inputGroup.addTextInput(identifier,"",translatablePhrase.getPhrase())
		set span=inputGroup.addSpan(identifier_"-translate-span")
		do span.uiComponent.addClass("input-group-btn")
		set translateButton=span.addTranslateButton(identifier_"-translate-button","Translate...",translationPageName,translationPageClass,hasMissingTranslation,title,.translationPageRequestData)	
		
	} else {
		set eventNameButton=..addTextInput(identifier,label,translatablePhrase.getPhrase())
	}
	return eventNameButton
]]></Implementation>
</Method>

<Method name="updateUIComponent">
<Implementation><![CDATA[
	
	set key=""
	for {
		set child=..elementChildren.GetNext(.key)
		if key="" quit
		do ..uiComponent.addChild(child.uiComponent)
		
 	}
 	do ##super()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>containerElementDefaultData</DefaultData>
<Data name="containerElementDefaultData">
<Subscript>"containerElement"</Subscript>
<Value name="1">
<Value>dynamicGetContentMethod</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.element">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.pageController.element.CLS/EV.8
;vc; Component: CLS.EF.pageController.element
;vc;  Location: SmallDev
;vc; Date/Time: 02-Sep-16 14:23
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.pageController.element.CLS/EV.8</td><td>CLS.EF.pageController.element</td><td>SmallDev</td><td style='white-space: nowrap;'>02-Sep-16 14:23</td><td>JeremyW</td></tr></table>
]]></Description>
<IncludeCode>EF.common.macros</IncludeCode>
<Super>%Library.Persistent,shared.timeStamp</Super>
<TimeChanged>64201,70851.405281</TimeChanged>
<TimeCreated>63350,63749.535929</TimeCreated>

<Property name="elementParent">
<Type>EF.pageController.element</Type>
</Property>

<Property name="elementChildren">
<Type>EF.pageController.element</Type>
<Collection>list</Collection>
</Property>

<Property name="page">
<Type>EF.pageController.page</Type>
</Property>

<Property name="identifier">
<Description>
The description of the property. Should be unique for each pageInstance</Description>
<Type>%String</Type>
<Required>1</Required>
<Parameter name="MAXLEN" value="250"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="description">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32767"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="isReadOnly">
<Type>%Boolean</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="uiComponent">
<Type>EF.ui.components.base</Type>
<Transient>1</Transient>
</Property>

<Property name="errorMessages">
<Type>%Library.String</Type>
<Collection>list</Collection>
<Parameter name="MAXLEN" value="32767"/>
</Property>

<Property name="objectId">
<Type>%String</Type>
</Property>

<Property name="enableDisableDependencyList">
<Type>EF.ui.components.dependencyList</Type>
<Transient>1</Transient>
</Property>

<Property name="showHideDependencyList">
<Type>EF.ui.components.dependencyList</Type>
<Transient>1</Transient>
</Property>

<Property name="displayOrder">
<Description>
needed to be able to output proweb items in the correct order until we change the 'allPageElements' proper in EF.pageController.page to be a list</Description>
<Type>%Integer</Type>
</Property>

<Property name="isModalTempData">
<Description>
Anything marked with isModalTempData set will be cleared down when a modal is re-opened</Description>
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="prowebListID">
<Type>%Integer</Type>
</Property>

<Index name="identifierIndex">
<Properties>identifier</Properties>
</Index>

<Method name="%OnNew">
<FormalSpec>identifier:%String,description:%String</FormalSpec>
<Private>1</Private>
<ReturnType>%Status</ReturnType>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
	If ($DATA(identifier)) {
		Set ..identifier=identifier
	}
	if $DATA(description) {
		set ..description=description
	}

	do ..createUIComponent()
	do ..initialiseUIComponent(..getDefaultUIComponent())
	
    Quit $$$OK
]]></Implementation>
</Method>

<Method name="delete">
<FormalSpec>removeFromParent=1</FormalSpec>
<Implementation><![CDATA[
	
	set key=""
	do {
    	set childElement=..elementChildren.GetNext(.key)
    	if ($IsObject(childElement)) {
        	do childElement.delete(0)
    	}
 	} While (key '= "")
 	set elementID=..%Id()
 	if (removeFromParent)&&($IsObject(..elementParent)) {
	 	do ..elementParent.%Reload()
		set childKey=..elementParent.elementChildren.FindObjectId(elementID,"")
		if childKey {
			do ..elementParent.elementChildren.RemoveAt(childKey)
			do ..elementParent.%Save()
		}	
 	}
    do ..%DeleteId(elementID)
    
 	quit
]]></Implementation>
</Method>

<Method name="addChild">
<FormalSpec>element:EF.pageController.element</FormalSpec>
<Implementation><![CDATA[
	if ..page.getElementByIdentifier(element.identifier) {
		throw ##class(shared.exceptions.generalException).%New("Element identifier must be unique for page")
	}
	set element.page=..page
	if ..page.isPageReadOnly {
		set element.isReadOnly=1	
	}
	do ..elementChildren.Insert(element)
	set element.elementParent=$this
	do ..page.allPageElements.SetAt(element,element.identifier)
]]></Implementation>
</Method>

<Method name="updateAllPageElements">
<Implementation><![CDATA[
	do ..page.allPageElements.SetAt($this,..identifier)
	set key=""
	for {
		set child=..elementChildren.GetNext(.key)
		if key="" quit
		do child.updateAllPageElements()	
	}
]]></Implementation>
</Method>

<Method name="reloadUIComponent">
<Implementation><![CDATA[	do ..initialiseUIComponent(..getDefaultUIComponent())
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[	do ..uiComponent.render()
]]></Implementation>
</Method>

<Method name="renderStart">
<Implementation><![CDATA[	do ..uiComponent.renderStart()
]]></Implementation>
</Method>

<Method name="renderEnd">
<Implementation><![CDATA[	do ..uiComponent.renderEnd()
]]></Implementation>
</Method>

<Method name="initialiseUIComponent">
<FormalSpec>uiComponent:EF.ui.components.base</FormalSpec>
<Implementation><![CDATA[	set ..uiComponent=uiComponent
]]></Implementation>
</Method>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.base</ReturnType>
<Implementation><![CDATA[
	set htmlIdentifier="ef_control_"_..identifier
	quit ##class(EF.ui.components.base).%New(htmlIdentifier)
]]></Implementation>
</Method>

<Method name="addElementToParent">
<ClassMethod>1</ClassMethod>
<FormalSpec>parent:EF.pageController.element,identifier:%String,description:%String</FormalSpec>
<ReturnType>EF.pageController.element</ReturnType>
<Implementation><![CDATA[
	if parent.page.isReload {
		set element=parent.page.getElementByIdentifier(identifier)
	} else {
		set element=..%New(identifier,description)
		do parent.addChild(element)
	}
	
	if $IsObject(parent.enableDisableDependencyList) {
		set element.enableDisableDependencyList=parent.enableDisableDependencyList	
	}	
	
	quit element
]]></Implementation>
</Method>

<Method name="getAuditDescription">
<Implementation><![CDATA[
	set auditDescription=..description
	if $IsObject(..elementParent) {
		set parentDescription=..elementParent.getAuditDescription()
		if $l(parentDescription) set auditDescription=parentDescription_" - "_auditDescription
	}
	quit auditDescription
]]></Implementation>
</Method>

<Method name="createUIComponent">
</Method>

<Method name="updateUIComponent">
<Implementation><![CDATA[
	if $IsObject(..enableDisableDependencyList) {
		set ..uiComponent.enableDisableDependencyList=..enableDisableDependencyList	
	}
	if $IsObject(..showHideDependencyList) {
		set ..uiComponent.showHideDependencyList=..showHideDependencyList	
	}
	if ..errorMessages.Count() {
		set ..uiComponent.hasError=1
	}
]]></Implementation>
</Method>

<Method name="validateElement">
<Implementation><![CDATA[
	do ..errorMessages.Clear()
	set key=""
	for {
		set elementChild=..elementChildren.GetNext(.key)
		if key="" quit
		do elementChild.validateElement() 
 	}
 	if ..isUpdated() {
	 	do ..validateValue()
 	}
]]></Implementation>
</Method>

<Method name="updateErrorMessages">
<Implementation><![CDATA[
	set key=""
	for {
		set elementChild=..elementChildren.GetNext(.key)
		if key="" quit
		do elementChild.updateErrorMessages()
 	}
 	if $IsObject(..elementParent) {
	 	if ..errorMessages.Count() {
		 	set key=""
		 	for {
			 	set errorMessage=..errorMessages.GetNext(.key)
			 	if key="" quit
			 	do ..elementParent.errorMessages.Insert(errorMessage)
		 	}
		}
 	}
]]></Implementation>
</Method>

<Method name="validateValue">
<Implementation><![CDATA[	quit
]]></Implementation>
</Method>

<Method name="isUpdated">
<Implementation><![CDATA[	quit 0
]]></Implementation>
</Method>

<Method name="updateValueFromRequest">
</Method>

<Method name="getEventID">
<Implementation><![CDATA[	quit ..page.objEvent.%Id()
]]></Implementation>
</Method>

<Method name="setErrorMessage">
<FormalSpec>errorMessage:%String</FormalSpec>
<Implementation><![CDATA[
	
	do ..errorMessages.Insert(..getDescriptionForError(errorMessage))
	set ..page.hasError=1
]]></Implementation>
</Method>

<Method name="getDescriptionForError">
<FormalSpec>errorMessage:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ..getBaseErrorMessage()_errorMessage_"."
]]></Implementation>
</Method>

<Method name="createContextData">
<ReturnType>EF.contextData</ReturnType>
<Implementation><![CDATA[
	set contextData = ##class(EF.contextData).%New()	
	set contextData.eventID=..getEventID()
	
	Do contextData.setControllerID()
	
	set contextData.languageID=$$$efEnglishLangID
	set contextData.auditPersonID=..xCRuserID
	
	set contextData.sessionID=..page.sessionID
	return contextData
]]></Implementation>
</Method>

<Method name="getRequestData">
<FormalSpec>name:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ..page.requestData.GetAt(name)
]]></Implementation>
</Method>

<Method name="clearAllPageControllerData">
<Description>
Should be run if any of the sub-classes are deleted</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	kill ^EF.pageController.elementD,^EF.pageController.elementI
]]></Implementation>
</Method>

<Method name="getBaseErrorMessage">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "The changes can't be saved because "
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^EF.pageController.elementD</DataLocation>
<DefaultData>elementDefaultData</DefaultData>
<IdLocation>^EF.pageController.elementD</IdLocation>
<IndexLocation>^EF.pageController.elementI</IndexLocation>
<StreamLocation>^EF.pageController.elementS</StreamLocation>
<ExtentSize>100000</ExtentSize>
<Data name="elementDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>elementParent</Value>
</Value>
<Value name="3">
<Value>elementChildren</Value>
</Value>
<Value name="4">
<Value>page</Value>
</Value>
<Value name="5">
<Value>identifier</Value>
</Value>
<Value name="6">
<Value>value</Value>
</Value>
<Value name="7">
<Value>description</Value>
</Value>
<Value name="8">
<Value>isReadOnly</Value>
</Value>
<Value name="9">
<Value>errorMessage</Value>
</Value>
<Value name="10">
<Value>errorDisplayElement</Value>
</Value>
<Value name="11">
<Value>xCRstamp</Value>
</Value>
<Value name="12">
<Value>xCRuserID</Value>
</Value>
<Value name="13">
<Value>xMOstamp</Value>
</Value>
<Value name="14">
<Value>xMOuserID</Value>
</Value>
<Value name="15">
<Value>objectID</Value>
</Value>
<Value name="16">
<Value>objectId</Value>
</Value>
<Value name="17">
<Value>dependsOnElement</Value>
</Value>
<Value name="18">
<Value>dependsOnValue</Value>
</Value>
<Value name="19">
<Value>showDependsOnElement</Value>
</Value>
<Value name="20">
<Value>showDependsOnValue</Value>
</Value>
<Value name="21">
<Value>errorMessages</Value>
</Value>
<Value name="22">
<Value>isModalTempData</Value>
</Value>
<Value name="23">
<Value>displayOrder</Value>
</Value>
<Value name="24">
<Value>prowebComponentName</Value>
</Value>
<Value name="25">
<Value>prowebListID</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.pagesFrontend.t4Registration">
<Super>EF.pageController.proweb.page</Super>
<TimeChanged>64189,56633.940879</TimeChanged>
<TimeCreated>64176,58073.730326</TimeCreated>

<Method name="loadData">
</Method>

<Method name="validate">
</Method>

<Method name="saveData">
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.checkbox">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64194,61822.238449</TimeChanged>
<TimeCreated>63372,44893.197087</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.backend.checkbox</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.checkbox).%New(..identifier)
]]></Implementation>
</Method>

<Method name="addDependentList">
<FormalSpec>identifier:%String</FormalSpec>
<ReturnType>EF.pageController.containerElements.list</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.containerElements.list).addElementToParent($this,identifier,"")
	set element.enableDisableDependencyList=##class(EF.ui.components.dependencyList).createNew(..identifier,1)
	quit element
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.checkboxGroup">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64202,50428.439222</TimeChanged>
<TimeCreated>64189,53206.554402</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.backend.checkbox</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.checkboxGroup).%New(..identifier)
]]></Implementation>
</Method>

<Method name="addAlternative">
<FormalSpec>value,description,isDefault=0</FormalSpec>
<ReturnType>EF.ui.components.alternative</ReturnType>
<Implementation><![CDATA[	return ..uiComponent.addAlternative(value,description,isDefault)
]]></Implementation>
</Method>

<Method name="isAlternativeInValueString">
<ClassMethod>1</ClassMethod>
<FormalSpec>alternative:%String,valueString:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	for i=1:1:$Length(valueString,"|") {
		if $ZCVT($ZSTRIP($Piece(valueString,"|",i),"<>W"),"U") = $ZCVT($ZSTRIP(alternative,"<>W"),"U") {
			return 1	
		}	
	}
	return 0
]]></Implementation>
</Method>

<Method name="addProwebCheckbox">
<FormalSpec>parent:EF.pageController.proweb.checkboxGroup,identifier:%String,description:%String,value:%String,isReadOnly=0</FormalSpec>
<ReturnType>EF.pageController.inputElements.checkbox</ReturnType>
<Implementation><![CDATA[
	set element=##class(EF.pageController.proweb.checkbox).addElementToParent(parent, identifier,description,value,isReadOnly)

	quit element
]]></Implementation>
</Method>

<Method name="getValueFromRequest">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim child as EF.pageController.proweb.checkbox
	#dim valueString as %String = ""
	
	for index = 1:1:..elementChildren.Count() {
		set child = ..elementChildren.GetAt(index)
		if %request.Get(child.identifier) = 1 {
			set tmpArray(index) = child.description
		}
	}
	set codItemName = ##class(sc.xModules.objCODitem).getCODItemName(..prowebID)
	set eventID = ##class(sc.objData).getEventID(..prowebID)
	
	if ##class(sc.xModules.objCODitem).getType(..prowebID) = "multibox" {
		set valueString = ##class(cod.methods).formatMultiCheckBox(eventID, codItemName, .tmpArray)
		
	} elseif ##class(sc.xModules.objCODitem).getType(..prowebID) = "checkbox" {
		set valueString = "true"	
	}
	return valueString
]]></Implementation>
</Method>

<Method name="setNameForValidationError">
<FormalSpec>name</FormalSpec>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.checkboxGroupTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52190.845512</TimeChanged>
<TimeCreated>64204,52190.845512</TimeCreated>

<Method name="TestWithMulticheckboxNoneSelected">
<Implementation><![CDATA[
	#dim element as EF.pageController.element
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set page=##class(EF.pageController.proweb.page).createNew(contextData)
	set elementIdentifier = "proweb-1"
	
	set element = ##class(EF.pageController.proweb.checkboxGroup).addElementToParent(page, elementIdentifier,"diet","")
	do page.uiComponent.addChild(element.uiComponent)	

	set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_1, "meat", 0)
	set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_2, "vegetarian", 0)
	set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_3, "vegan", 0)
	set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_4, "fish", 0)
	
	do page.uiComponent.childComponents.SetAt(element.uiComponent,1)
	set element.uiComponent.contextData = contextData
	do element.updateUIComponent()
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1"">diet</label></div><divclass='col-sm-8ef_proweb_form_prompt'><divclass=""form-group""><divclass=""inputs-listef-proweb-input-elementef-proweb-checkboxGroup""><label><inputtype=""checkbox""value=""1""id=""proweb-1-1""class=""""name=""proweb-1-1""title="""">meat</label><br/><label><inputtype=""checkbox""value=""1""id=""proweb-1-2""class=""""name=""proweb-1-2""title="""">vegetarian</label><br/><label><inputtype=""checkbox""value=""1""id=""proweb-1-3""class=""""name=""proweb-1-3""title="""">vegan</label><br/><label><inputtype=""checkbox""value=""1""id=""proweb-1-4""class=""""name=""proweb-1-4""title="""">fish</label><br/></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.datePicker">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64202,34967.838153</TimeChanged>
<TimeCreated>63384,38321.657735</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[
	set uiElement=##class(EF.ui.components.frontend.datePicker).%New(..identifier)
	quit uiElement
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.dateRange">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64202,41832.54542</TimeChanged>
<TimeCreated>63384,38321.657735</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[
	set uiElement=##class(EF.ui.components.frontend.dateRange).%New(..identifier)
	quit uiElement
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.divider">
<Super>EF.pageController.proweb.prowebBase</Super>
<TimeChanged>64203,63320.354946</TimeChanged>
<TimeCreated>64183,49747.663252</TimeCreated>

<Parameter name="canBeDependent">
<Type>%Boolean</Type>
<Default>0</Default>
</Parameter>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.base</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.divider).%New(..identifier)
]]></Implementation>
</Method>

<Method name="initialiseUIComponent">
<FormalSpec>uiComponent:EF.ui.components.base</FormalSpec>
<Implementation><![CDATA[	do ##super(uiComponent)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.dropdown">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64189,54711.498322</TimeChanged>
<TimeCreated>64189,53206.554402</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.backend.checkbox</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.dropdown).%New(..identifier)
]]></Implementation>
</Method>

<Method name="addAlternative">
<FormalSpec>value,description,isDefault=0</FormalSpec>
<ReturnType>EF.ui.components.alternative</ReturnType>
<Implementation><![CDATA[	return ..uiComponent.addAlternative(value,description,isDefault)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.emailInput">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64198,32956.969715</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.emailInput).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.emailInputMulti">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64201,44206.111927</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.emailInputMulti).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.inputElement">
<Super>EF.pageController.inputElement,EF.pageController.proweb.prowebBase</Super>
<TimeChanged>64205,30734.008767</TimeChanged>
<TimeCreated>64189,53012.909524</TimeCreated>

<Property name="isMandatory">
<Type>%Boolean</Type>
</Property>

<Property name="guestNumber">
<Type>%Integer</Type>
</Property>

<Property name="isGuest">
<Type>%Boolean</Type>
</Property>

<Method name="validateElement">
<Implementation><![CDATA[
	do ..errorMessages.Clear()
	set key=""
	for {
		set elementChild=..elementChildren.GetNext(.key)
		if key="" quit
		do elementChild.validateElement() 
 	}
 	
	do ..validateValue()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>inputElementDefaultData1</DefaultData>
<Data name="inputElementDefaultData1">
<Subscript>"inputElement1"</Subscript>
<Value name="1">
<Value>isMandatory</Value>
</Value>
<Value name="2">
<Value>prowebID</Value>
</Value>
<Value name="3">
<Value>guestNumebr</Value>
</Value>
<Value name="4">
<Value>isGuest</Value>
</Value>
<Value name="5">
<Value>guestNumber</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.integerInput">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64201,43333.133276</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.integerInput).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.numericInput">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64201,43313.656158</TimeChanged>
<TimeCreated>63939,36505.690987</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.numericInput).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.page">
<Super>EF.pageController.page</Super>
<TimeChanged>64205,42794.672137</TimeChanged>
<TimeCreated>64189,51696.559047</TimeCreated>

<Property name="contextData">
<Type>EF.contextDataRegistration</Type>
</Property>

<Property name="prowebPageID">
<Type>%Integer</Type>
</Property>

<Property name="listOfControllerIDsSorted">
<Type>%ListOfDataTypes</Type>
<Transient>1</Transient>
</Property>

<Property name="listOfGuestControllerIDs">
<Type>%ListOfDataTypes</Type>
<Transient>1</Transient>
</Property>

<Property name="positionOfNextNonGuestQuestion">
<Type>%Integer</Type>
<Private>1</Private>
</Property>

<Method name="load">
<Implementation><![CDATA[
	set ..contextData.prowebFloatingMenuCounter = 100 // offset to keep them separate from the include pages' counters
	do ..loadData()
	if ..contextData.%IsA("EF.contextDataRegistration") {
		do ..insertAllProwebItems() 
	}
	do ..updateUIComponents()
]]></Implementation>
</Method>

<Method name="renderHTMLControlFromTag">
<FormalSpec><![CDATA[&attrs]]></FormalSpec>
<Implementation><![CDATA[
	set identifier=$G(attrs("identifier"))
	set element=..getElementByIdentifier(identifier)
	if $IsObject(element) {
		do element.render()
		
	} elseif $Get(attrs("prowebcomponentname"))'="" {
		if '..contextData.pageID {
			throw ##class(shared.exceptions.generalException).%New("PageID was missing when attempting to render Proweb tag")
		}
		
		set ..objEvent = ##class(setup.objEvent).%OpenId(..contextData.eventID)
		set ..contextData.prowebComponentName = attrs("prowebcomponentname")
				
		do ..initialiseComponent()
		
		if ..hasError {
			do ..renderErrorMessages()
		}

		do ..renderProwebItemsForComponent()
	}
	quit
]]></Implementation>
</Method>

<Method name="renderErrorMessages">
<Implementation><![CDATA[
	write !,"<div class='ef-proweb-error-panel'><div class='ef-proweb-error-header'>",##class(shared.pCSP).out("Error on page"),"</div><UL>"
		for {
			set element=..allPageElements.GetNext(.key)
			if key="" quit
			if element.uiComponent.hasError {
				write !,"<LI>",element.uiComponent.validator.getErrorMessage(),"</LI>"
			}
		}
		write !,"</UL></div>"
]]></Implementation>
</Method>

<Method name="initialiseComponent">
<Implementation><![CDATA[
	if '##class(sc.xModules.objList).getListIDFromPageIDAndComponentName(..contextData.pageID,..contextData.prowebComponentName) {
		set listID = ##class(sc.xModules.objList).add(..contextData.pageID)
		if 'listID {
			throw ##class(shared.exceptions.generalException).%New("Failed to create new objList")	
		}
		set templateID = ##class(sc.pageMethods).getTemplateIDfromPageID(..contextData.pageID)
		set componentID = ##class(sc.objComponent).add(..contextData.prowebComponentName, templateID, listID)
		if 'componentID {
			throw ##class(shared.exceptions.generalException).%New("Failed to cerate new objComponent")
		}
	}
]]></Implementation>
</Method>

<Method name="insertAllProwebItems">
<Private>1</Private>
<Implementation><![CDATA[
	set rsLists = ##class(%ResultSet).%New("sc.objData:qGetChildren")
	do rsLists.Execute(..contextData.pageID)
	
	while rsLists.Next() {
		set listID = rsLists.Get("ID")
		
		set rsProwebItems = ##class(%ResultSet).%New("sc.xModules.objList:qGetChildren")
		do rsProwebItems.Execute(listID)
		while rsProwebItems.Next() {	
			set dataID = rsProwebItems.Get("ID")
			set prowebItem = ##class(sc.objData).%OpenId(dataID)
			do ..addControllerForProwebItem(prowebItem)
		}
	}
]]></Implementation>
</Method>

<Method name="addControllerForProwebItem">
<FormalSpec>prowebItem:sc.objData</FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
	#dim elementIdentifier as %String = ..getElementIdentifierForProwebItems(prowebItem)
	#dim element as EF.pageController.element
		
	if prowebItem.dataType = "objCODitem" { 
		set element = ..getNewElementForQuestion(prowebItem)
	
	} elseif prowebItem.dataType = "objText" {
		set element = ##class(EF.pageController.proweb.textBlock).addElementToParent($this, elementIdentifier, prowebItem.description)
	
	} elseif prowebItem.dataType = "objFormDivider" {
		set element = ##class(EF.pageController.proweb.divider).addElementToParent($this, elementIdentifier, "")

	} else {
		throw ##class(shared.exceptions.generalException).%New("proweb item type not implemented yet")	
	}

	set element.displayOrder = prowebItem.displayOrder
	set element.uiComponent.isProwebEditMode = (..contextData.prowebMode = "edit")
	set element.uiComponent.prowebItem = prowebItem
	set element.uiComponent.contextData = ..contextData
	set element.prowebListID = prowebItem.getParentID(prowebItem.%Id())
	set element.prowebID = prowebItem.%Id()
	
	if element.#canBeDependent {
		set dependsOnAlternativeDescription = ##class(sc.dependencyMethods).getDependsOnAlternativeDescription(prowebItem.%Id())
		if dependsOnAlternativeDescription '="" {
			set parentProwebID = ##class(sc.dependencyMethods).getDependsOnPrompt(prowebItem.%Id())
			set parentProwebItem = ##class(sc.objData).%OpenId(parentProwebID)
			set parentElementIdentifier = ..getElementIdentifierForProwebItems(parentProwebItem)
			set dependencyList = ##class(EF.ui.components.dependencyList).createNew(parentElementIdentifier, dependsOnAlternativeDescription)	
			set element.showHideDependencyList = dependencyList
		}
	}
]]></Implementation>
</Method>

<Method name="getNewElementForQuestion">
<FormalSpec>prowebItem:sc.objData,optionalGuestNumber:%Integer=""</FormalSpec>
<Private>1</Private>
<ReturnType>EF.pageController.proweb.inputElement</ReturnType>
<Implementation><![CDATA[
	#dim isReadOnly as %Boolean = 0
	#dim prowebID as %Integer = prowebItem.%Id()
	#dim itemName as %String = ##class(sc.xModules.objCODitem).getCODItemName(prowebID)
	#dim value as %String
	#dim elementIdentifier as %String 
	#dim labelText as %String = ##class(sc.objData).getQuestionPrompt(prowebID, ..contextData.languageID)

	if (prowebItem.isGuest) && (optionalGuestNumber = "") {
		set optionalGuestNumber = 1
	}
	set elementIdentifier = ..getElementIdentifierForProwebItems(prowebItem, optionalGuestNumber)
	set value = ..getValueFromEComTemp(itemName, optionalGuestNumber)
	
	set pageControllerClassName = $Case(prowebItem.type,
										"text":"textInput",
										"emailAddress":"emailInput",
										"time":"timeInput",
										"date":"datePicker",
										"textarea":"textArea",
										"phoneNumber":"phoneNumber",
										"integer":"integerInput",
										"floatingPointNumber":"numericInput",
										"webAddress":"webAddress",
										"multiEmailAddress":"emailInputMulti",
										"checkbox":"checkboxGroup",
										"dateRange":"dateRange",
										:"exception"
										)
	if pageControllerClassName '= "exception" {										
		set element = $ClassMethod("EF.pageController.proweb."_pageControllerClassName, "addElementToParent", $this, elementIdentifier, labelText, value, isReadOnly)
		
	} elseif (prowebItem.type = "dropdown") ! (prowebItem.type = "radiobutton") ! (prowebItem.type = "multibox") {
		set element = ..addProwebSelectionElement(prowebItem)
				
	} else {
		throw ##class(shared.exceptions.generalException).%New("proweb question type is not implemented yet")	
	}

	if prowebItem.type = "checkbox" {
		set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_1, labelText, value)
		set childController.prowebID = prowebItem.%Id()
	}		
	if prowebItem.type = "dateRange" {
		do ..addSecondDatePickerForDateRange(prowebItem, element)
	}
	
	if (element.%IsA("EF.pageController.proweb.checkboxGroup") = 0) && (element.uiComponent.isGuest = 0) {
		set element.isMandatory = +prowebItem.mandatory
		set element.uiComponent.isMandatory = +prowebItem.mandatory
		set element.uiComponent.validator.isMandatory = +prowebItem.mandatory
	}
	
	set element.uiComponent.isGuest = prowebItem.isGuest
	if prowebItem.isGuest {
		set element.guestNumber = 1	
		set element.uiComponent.guestNumber = 1	
	}
	set element.uiComponent.helpText = prowebItem.helpText	
	set element.prowebID = prowebItem.%Id()

	return element
]]></Implementation>
</Method>

<Method name="getValueFromEComTemp">
<FormalSpec>itemName:%String,optionalGuestNumber:%Integer</FormalSpec>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if optionalGuestNumber {
		set tempPersonID = ..getTempPersonIdForGuestNumber(optionalGuestNumber)	
	} else {
		set tempPersonID = ..contextData.tempPersonID
	}
	set value = ##class(eCom.tempCodData).get(tempPersonID, itemName)
	return value
]]></Implementation>
</Method>

<Method name="getTempPersonIdForGuestNumber">
<FormalSpec>optionalGuestNumber:%Integer</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	#dim counter as %Integer = 0
	
	set rsTemps = ##class(%ResultSet).%New()
	do rsTemps.Prepare("SELECT ID FROM eCom.tempPerson WHERE (tempPurchase = ?) AND (isGuest = 1) AND (active = 1) ORDER BY ID")
	do rsTemps.Execute(..contextData.tempPurchaseID)
	while rsTemps.Next() {
		set counter = counter + 1	
		if counter = optionalGuestNumber {
			return rsTemps.Get("ID")
		}
	}
	return ""
]]></Implementation>
</Method>

<Method name="addProwebSelectionElement">
<FormalSpec>prowebItem:sc.objData</FormalSpec>
<Private>1</Private>
<ReturnType>EF.pageController.element</ReturnType>
<Implementation><![CDATA[
	#dim isReadOnly as %Boolean = 0
	#dim prowebID as %Integer = prowebItem.%Id()
	#dim itemName as %String = ##class(sc.xModules.objCODitem).getCODItemName(prowebID)
	#dim value as %String 
	#dim elementIdentifier as %String = ..getElementIdentifierForProwebItems(prowebItem)
	#dim labelText as %String = ##class(sc.objData).getQuestionPrompt(prowebID, ..contextData.languageID)
	#dim counter as %Integer = 0
	#dim getRawData as %Boolean = 1
	
	if prowebItem.type = "dropdown" {
		set value = ##class(eCom.tempCodData).get(..contextData.tempPersonID, itemName)
		set element=##class(EF.pageController.proweb.dropdown).addElementToParent($this, elementIdentifier, labelText, value, isReadOnly)
		
	} elseif prowebItem.type = "radiobutton" {
		set value = ##class(eCom.tempCodData).get(..contextData.tempPersonID, itemName)
		set element=##class(EF.pageController.proweb.radioButtons).addElementToParent($this, elementIdentifier, labelText,value,isReadOnly)
		
	} elseif prowebItem.type = "multibox" {
		set value = ##class(eCom.tempCodData).get(..contextData.tempPersonID, itemName,"",getRawData)
		set element=##class(EF.pageController.proweb.checkboxGroup).addElementToParent($this, elementIdentifier, labelText, value)
		set element.uiComponent.columns=1
			
	} else {
		throw ##class(shared.exceptions.generalException).%New("Proweb selection type not implemented")
	}
	set element.displayOrder = prowebItem.displayOrder	
	
	set rsAlternative = ##class(cod.objItemAlternatives).getAlternativesForCodItemAsResultSet( prowebItem.objItemName.%Id() )
	while rsAlternative.Next()	{
		set alternativeValue = rsAlternative.Get("description") 
		set alternativeDescription = ##class(cod.objItemAlternativeDetails).getDescription(rsAlternative.Get("ID"), ..contextData.languageID)
		set alternativeDescription = ##class(EF.htmlGenerator).unescapeXSSFix(alternativeDescription)
		
		if prowebItem.type = "multibox" {
			set counter = counter+1
			set isChecked = ##class(EF.pageController.proweb.checkboxGroup).isAlternativeInValueString(alternativeDescription, value)
			set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_counter, alternativeDescription, isChecked)
			set childController.prowebID = prowebItem.%Id()

		} else {
			set alternative = element.addAlternative(alternativeValue,alternativeDescription)
		}
    }
	
	return element
]]></Implementation>
</Method>

<Method name="addSecondDatePickerForDateRange">
<FormalSpec>prowebItem:sc.objData,element:EF.pageController.proweb.datePicker</FormalSpec>
<Private>1</Private>
<ReturnType>EF.pageController.element</ReturnType>
<Implementation><![CDATA[
	#dim isReadOnly as %Boolean = 0
	#dim prowebID as %Integer = prowebItem.%Id()
	#dim itemName as %String = ##class(sc.xModules.objCODitem).getCODItemName(prowebID)
	#dim value as %String 
	#dim elementIdentifier as %String = ..getElementIdentifierForProwebItems(prowebItem)

	set databaseItemID  = prowebItem.objItemName.%Id()
	
	set childControllerStart = ##class(EF.pageController.proweb.datePicker).addElementToParent(element, elementIdentifier_"-startDate", "", isReadOnly)	
	set childControllerStart.prowebID = prowebItem.%Id()
	set childControllerStart.uiComponent.contextData = ..contextData
	set childControllerStart.uiComponent.prowebItem = prowebItem
	set childControllerStart.value = $Piece(##class(eCom.tempCodData).get(..contextData.tempPersonID, itemName), "|", 1)
	
	set earliestAllowedStartDate = $Piece(##class(cod.lnkItemNameEventDateRange).getMinTimeStamp(..contextData.eventID, databaseItemID), " ", 1)
	set earliestAllowedStartDate = ##class(shared.dateFunctions).multiDate(earliestAllowedStartDate, childControllerStart.uiComponent.validator.dateFormat )
	do childControllerStart.uiComponent.addAttribute("efdaterangestartmin", earliestAllowedStartDate )
	
				
	set childControllerEnd = ##class(EF.pageController.proweb.datePicker).addElementToParent(element, elementIdentifier_"-endDate", "", isReadOnly)		
	set childControllerEnd.prowebID = prowebItem.%Id()	
	set childControllerEnd.uiComponent.contextData = ..contextData
	set childControllerEnd.uiComponent.prowebItem = prowebItem
	set childControllerEnd.value = $Piece(##class(eCom.tempCodData).get(..contextData.tempPersonID, itemName), "|", 2)

	set latestAllowedEndDate = $Piece(##class(cod.lnkItemNameEventDateRange).getMinTimeStamp(..contextData.eventID, databaseItemID), " ", 1)
	set latestAllowedEndDate = ##class(shared.dateFunctions).multiDate(latestAllowedEndDate, childControllerStart.uiComponent.validator.dateFormat )
	do childControllerEnd.uiComponent.addAttribute("efdaterangeendmax", latestAllowedEndDate )	

	return element
]]></Implementation>
</Method>

<Method name="getElementIdentifierForProwebItems">
<FormalSpec>prowebItem:sc.objData,optionalGuestNumber:%Integer=""</FormalSpec>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim prowebID as %Integer = prowebItem.%Id()
	
	set identifier = "proweb-"_prowebID
	if optionalGuestNumber {
		set identifier = identifier_"-"_optionalGuestNumber		
	}
	return identifier
]]></Implementation>
</Method>

<Method name="renderProwebItemsForComponent">
<Description>
this method needs rewriting when the arrayOfUiComponents become a list instead of an array</Description>
<Implementation><![CDATA[
	do ..populatelistOfControllerIDsSorted()
	;if 'reloadingPage ( // ######################################
	do ..repeatAnyGuestQuestions()
	do ..insertPanelElementsAroundGuestQuestions()
	do ..renderElements()
]]></Implementation>
</Method>

<Method name="populatelistOfControllerIDsSorted">
<Private>1</Private>
<Implementation><![CDATA[
	#dim controller as EF.pageController.element
	#dim sparseArrayOfControllers

	for {
		set controller=..allPageElements.GetNext(.key)
		if key="" quit
		
		if controller.%Extends("EF.pageController.proweb.prowebBase") {
			
			set elementListID = controller.prowebListID
			set componentListID = ##class(sc.xModules.objList).getListIDFromPageIDAndComponentName(..contextData.pageID, ..contextData.prowebComponentName)
					
			if (elementListID = componentListID) && ('controller.%IsA("EF.pageController.proweb.page")) {
				if controller.displayOrder = "" {
					throw ##class(shared.exceptions.generalException).%New("No displayOrder defined for element: "_controller)	
				}
				set sparseArrayOfControllers(controller.displayOrder) = controller.identifier	
			}
		}
	}
	
	for counter=1:1 { 
		set key = $Order(sparseArrayOfControllers(key))
		if key="" quit
		
		set controllerID = sparseArrayOfControllers(key)
		do ..listOfControllerIDsSorted.Insert(controllerID)
	}
]]></Implementation>
</Method>

<Method name="repeatAnyGuestQuestions">
<Private>1</Private>
<Implementation><![CDATA[
	do ..findAllGuestQuestions()
	do ..insertOneSetOfQuestionsPerGuest()
]]></Implementation>
</Method>

<Method name="findAllGuestQuestions">
<Private>1</Private>
<Implementation><![CDATA[
	#dim key as %Integer = ""
	#dim lastUsedKey as %String = ""
	#dim controller as EF.pageController.element
	#dim hasFoundGuestUiComponent as %Boolean = 0
	#define isGuestElement (controller.uiComponent.isGuest = 1)
	#define isNotGuestElement (+controller.uiComponent.isGuest = 0)
	
	for  {
		set controllerID = ..listOfControllerIDsSorted.GetNext(.key)
		if key="" quit
		set lastUsedKey = key
		set controller = ..getElementByIdentifier(controllerID)

		if controller.%Extends("EF.pageController.proweb.inputElement") {
			if $$$isGuestElement  {
				do ..listOfGuestControllerIDs.Insert(controllerID)
				set hasFoundGuestUiComponent = 1
			} 
			
			if $$$isNotGuestElement && (hasFoundGuestUiComponent = 1) {
				set hasFoundGuestUiComponent = 0
				set ..positionOfNextNonGuestQuestion = key
			}			

		} else { // non-questions
			if hasFoundGuestUiComponent = 1 {
				set hasFoundGuestUiComponent = 0
				set ..positionOfNextNonGuestQuestion = lastUsedKey
			}
		}
	}
	if '..positionOfNextNonGuestQuestion {
		set ..positionOfNextNonGuestQuestion = lastUsedKey+1 // end of page
	}
]]></Implementation>
</Method>

<Method name="insertOneSetOfQuestionsPerGuest">
<Private>1</Private>
<Implementation><![CDATA[
	#dim key as %Integer = ""
	#dim controller as EF.pageController.element
	#dim eventConfiguration as setup.eventConfiguration = ##class(setup.eventConfiguration).createForEventID(..contextData.eventID)
	
	for guestNumber = 2:1:eventConfiguration.getMaxGuestsPerAttendee() {
	
		for  {
			set controllerID = ..listOfGuestControllerIDs.GetNext(.key)
			if key="" quit
			set controller = ..getElementByIdentifier(controllerID)
			
			set newController = ..getNewElementForQuestion(controller.uiComponent.prowebItem, guestNumber)
			
			set newController.guestNumber = guestNumber
			set newController.displayOrder = ..positionOfNextNonGuestQuestion
			set newController.uiComponent.isProwebEditMode = (..contextData.prowebMode = "edit")
			set newController.uiComponent.prowebItem = controller.uiComponent.prowebItem
			set newController.uiComponent.contextData = ..contextData
			set newController.prowebListID = controller.prowebListID
			set newController.prowebID = controller.prowebID
						
			do ..listOfControllerIDsSorted.InsertAt(newController.identifier, ..positionOfNextNonGuestQuestion) 
			
			set ..positionOfNextNonGuestQuestion = ..positionOfNextNonGuestQuestion + 1
			kill newController
		}
	}
]]></Implementation>
</Method>

<Method name="insertPanelElementsAroundGuestQuestions">
<Private>1</Private>
<Implementation><![CDATA[
	#dim key as %Integer = ""
	#dim lastUsedKey as %String = ""
	#dim controller as EF.pageController.element
	#dim currentGuestNumber as %Integer = 0
	#define isGuestElement (controller.uiComponent.isGuest = 1)
	#define isNotGuestElement (+controller.uiComponent.isGuest = 0)
	
	for  {
		set controllerID = ..listOfControllerIDsSorted.GetNext(.key)
		if key="" quit
		set controller = ..getElementByIdentifier(controllerID)
		set lastUsedKey = key
		
		if controller.%Extends("EF.pageController.proweb.inputElement") {

			if $$$isGuestElement && (currentGuestNumber = 0) {
				set currentGuestNumber = controller.guestNumber
				do ..insertControllerForGuestPanel(key, "opening")
			}

			if $$$isNotGuestElement && (currentGuestNumber) {
				set currentGuestNumber = 0
				do ..insertControllerForGuestPanel(key, "closing") 
			}
			
			if $$$isGuestElement && (+controller.guestNumber '= +currentGuestNumber) {
				set currentGuestNumber = 0
				do ..insertControllerForGuestPanel(key, "closing") 
			}
			
		} else { // non-questions
			if currentGuestNumber {
				set currentGuestNumber = 0
				do ..insertControllerForGuestPanel(key, "closing") 
			}			
		}
	}
	
	if currentGuestNumber {
		do ..insertControllerForGuestPanel(lastUsedKey+1, "closing") 
	}
]]></Implementation>
</Method>

<Method name="insertControllerForGuestPanel">
<FormalSpec>insertPosition:%Integer,openOrClose:%String</FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
	#dim controllerForPanel as EF.pageController.proweb.panel
	
	set controllerForPanel = ##class(panel).addElementToParent($this, "GuestPanel-"_insertPosition, "")
	set controllerForPanel.isOpeningOrClosing = openOrClose
	set controllerForPanel.uiComponent.isOpeningOrClosing = openOrClose
		
	do ..listOfControllerIDsSorted.InsertAt(controllerForPanel.identifier, insertPosition)
]]></Implementation>
</Method>

<Method name="renderElements">
<Private>1</Private>
<Implementation><![CDATA[
	for position = 1:1:..listOfControllerIDsSorted.Count() {
		set controllerID = ..listOfControllerIDsSorted.GetAt(position)
		set controller = ..getElementByIdentifier(controllerID)
		do controller.uiComponent.render()		
	}
]]></Implementation>
</Method>

<Method name="reorderProwebElements">
<FormalSpec>orderedElementIds:%String</FormalSpec>
<Implementation><![CDATA[
	#dim key as %Integer = ""
	#dim element as EF.pageController.element
	#dim prowebItemID as %Integer
	
	set displayOrder = 0
	for index = 1:1:$Length(orderedElementIds,"|") {
		
		set prowebItemID = $Piece(orderedElementIds,"|",index)
		if $Length(prowebItemID) {
			set displayOrder = displayOrder + 1
			set prowebItems(prowebItemID) = displayOrder
		}
	}
	
	for {
		set element = ..allPageElements.GetNext(.key)
		if key = "" quit
		if element.%Extends("EF.pageController.proweb.prowebBase") {
			if $Data(prowebItems(element.prowebID)) {
				set prowebElement = ##class(sc.objData).%OpenId(element.prowebID)
				set prowebElement.displayOrder = prowebItems(element.prowebID)
				do prowebElement.%Save()
			}
		}
	}
]]></Implementation>
</Method>

<Method name="copyAllDataToEComTemp">
<Implementation><![CDATA[
	#dim key as %Integer = ""
	#dim element as EF.pageController.element
	#dim prowebItemID as %Integer
	#dim prowbItemName as %String
	
	for {
		set element=..allPageElements.GetNext(.key)
		if key="" quit
		
		if element.%IsA("EF.pageController.proweb.inputElement") {
			set prowebItemID = element.prowebID
			set prowbItemName = ##class(sc.xModules.objCODitem).getCODItemName(prowebItemID)
			
			if ( element.%IsA("EF.pageController.proweb.checkbox") ) && ( element.elementParent.elementChildren.Count() > 1 ) { // multi checkboxes only
				if element.value = 1 {
					set multiCheckboxData(prowbItemName, $I(multiCheckboxData(prowbItemName))) = element.description
				}
			} elseif ( element.%IsA("EF.pageController.proweb.datePicker") ) && ( element.elementParent.elementChildren.Count() = 2 ) { // date range
				set startDate = element.elementParent.elementChildren.GetAt(1).value
				set endDate = element.elementParent.elementChildren.GetAt(2).value
				do ##class(eCom.tempCodData).set(..contextData.tempPersonID, prowbItemName, startDate_"|"_endDate )	
			
			} else {
				do ##class(eCom.tempCodData).set(..contextData.tempPersonID, prowbItemName, element.value)	
			}
		}
	}
	do ..copyAndFormatMultiCheckboxData(.multiCheckboxData)
]]></Implementation>
</Method>

<Method name="copyAndFormatMultiCheckboxData">
<FormalSpec><![CDATA[&multiCheckboxData]]></FormalSpec>
<Implementation><![CDATA[
	set prowbItemName = ""
	for {  
		set prowbItemName = $Order(multiCheckboxData(prowbItemName))
		if prowbItemName = "" quit
		kill tmpArray
		merge tmpArray=multiCheckboxData(prowbItemName)
		
		set value = ##class(cod.methods).formatMultiCheckBox(..contextData.eventID, prowbItemName, .tmpArray)
		do ##class(eCom.tempCodData).set(..contextData.tempPersonID, prowbItemName, value, ..contextData.pageID, ..contextData.eventID)
	}
]]></Implementation>
</Method>

<Method name="debugTarget">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "First Name"
	#dim value as %String = "Elvis"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page=..createNew(contextData)
	set element = page.addProwebTextInput(elementIdentifier, labelText, value)
	do page.uiComponent.childComponents.SetAt(element.uiComponent,1)
	set element.uiComponent.contextData = contextData
	do page.render()
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>pageDefaultData1</DefaultData>
<Data name="pageDefaultData1">
<Subscript>"page1"</Subscript>
<Value name="1">
<Value>floatingMenuCounter</Value>
</Value>
<Value name="2">
<Value>prowebComponentName</Value>
</Value>
<Value name="3">
<Value>contextData</Value>
</Value>
<Value name="4">
<Value>prowebPageID</Value>
</Value>
<Value name="5">
<Value>listOfControllerIDsSorted</Value>
</Value>
<Value name="6">
<Value>listOfGuestControllerIDs</Value>
</Value>
<Value name="7">
<Value>..positionOfNextNonGuestQuestion</Value>
</Value>
<Value name="8">
<Value>positionOfNextNonGuestQuestion</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.panel">
<Super>EF.pageController.containerElements.panel</Super>
<TimeChanged>64205,32081.565306</TimeChanged>
<TimeCreated>63372,47064.603748</TimeCreated>

<Property name="isOpeningOrClosing">
<Type>%String</Type>
</Property>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.container</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.panel).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>panelDefaultData</DefaultData>
<Data name="panelDefaultData">
<Subscript>"panel"</Subscript>
<Value name="1">
<Value>isOpeningOrClosing</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.phoneNumber">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64197,58652.450875</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.phoneNumber).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.prowebBase">
<Super>EF.pageController.element</Super>
<TimeChanged>64203,63285.186891</TimeChanged>
<TimeCreated>64183,49747.663252</TimeCreated>

<Parameter name="canBeDependent">
<Type>%Boolean</Type>
<Default>1</Default>
</Parameter>

<Property name="prowebID">
<Type>%Integer</Type>
</Property>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>prowebBaseDefaultData</DefaultData>
<Data name="prowebBaseDefaultData">
<Subscript>"prowebBase"</Subscript>
<Value name="1">
<Value>prowebID</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="EF.pageController.proweb.radioButtons">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64202,37012.627519</TimeChanged>
<TimeCreated>64189,53206.554402</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.backend.checkbox</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.radioButtons).%New(..identifier)
]]></Implementation>
</Method>

<Method name="addAlternative">
<FormalSpec>value,description,isDefault=0</FormalSpec>
<ReturnType>EF.ui.components.alternative</ReturnType>
<Implementation><![CDATA[	return ..uiComponent.addAlternative(value,description,isDefault)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.testCases.checkboxGroupTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52598.182886</TimeChanged>
<TimeCreated>64204,52598.182886</TimeCreated>

<Method name="TestWithMulticheckboxNoneSelected">
<Implementation><![CDATA[
	#dim element as EF.pageController.element
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set page=##class(EF.pageController.proweb.page).createNew(contextData)
	set elementIdentifier = "proweb-1"
	
	set element = ##class(EF.pageController.proweb.checkboxGroup).addElementToParent(page, elementIdentifier,"diet","")
	do page.uiComponent.addChild(element.uiComponent)	

	set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_1, "meat", 0)
	set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_2, "vegetarian", 0)
	set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_3, "vegan", 0)
	set childController = element.addProwebCheckbox(element, elementIdentifier_"-"_4, "fish", 0)
	
	do page.uiComponent.childComponents.SetAt(element.uiComponent,1)
	set element.uiComponent.contextData = contextData
	do element.updateUIComponent()
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1"">diet</label></div><divclass='col-sm-8ef_proweb_form_prompt'><divclass=""form-group""><divclass=""inputs-listef-proweb-input-elementef-proweb-checkboxGroup""><label><inputtype=""checkbox""value=""1""id=""proweb-1-1""class=""""name=""proweb-1-1""title="""">meat</label><br/><label><inputtype=""checkbox""value=""1""id=""proweb-1-2""class=""""name=""proweb-1-2""title="""">vegetarian</label><br/><label><inputtype=""checkbox""value=""1""id=""proweb-1-3""class=""""name=""proweb-1-3""title="""">vegan</label><br/><label><inputtype=""checkbox""value=""1""id=""proweb-1-4""class=""""name=""proweb-1-4""title="""">fish</label><br/></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.datePIckerTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52627.550246</TimeChanged>
<TimeCreated>64204,52627.550246</TimeCreated>

<Method name="TestDatePicker">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "date"
	#dim value as %String = "12/12/2016"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.datePicker).addElementToParent(page, elementIdentifier, labelText, value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1"">date</label></div><divclass='col-sm-8ef_proweb_form_prompt'><divclass=""ef-proweb-input-element-short""><inputtype=""date""class=""ef-kendo-form-controlefDatePicker""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""DD/MM/YYYY""efKendoDateFormat=""dd/MM/yyyy""></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.dateRangeTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52642.759507</TimeChanged>
<TimeCreated>64204,52642.759507</TimeCreated>

<Method name="TestDateRange">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "date ranger"
	#dim value as %String = ""
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	#dim isReadOnly as %Boolean = 0
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.dateRange).addElementToParent(page, elementIdentifier, labelText, value, 0)
	set element.uiComponent.contextData = contextData
	do page.uiComponent.addChild(element.uiComponent)
	
	set childControllerStart = ##class(EF.pageController.proweb.datePicker).addElementToParent(element, elementIdentifier_"-startDate", "", isReadOnly)	
	set childControllerStart.prowebID = 1
	set childControllerStart.uiComponent.validator.dateFormat = 3
	set childControllerStart.uiComponent.contextData = contextData
	do childControllerStart.uiComponent.addAttribute("efdaterangestartmin", "24/12/2001" )
	do element.uiComponent.childComponents.SetAt(childControllerStart.uiComponent,1)
	
	set childControllerEnd = ##class(EF.pageController.proweb.datePicker).addElementToParent(element, elementIdentifier_"-endDate", "", isReadOnly)	
	set childControllerEnd.prowebID = 1
	set childControllerEnd.uiComponent.validator.dateFormat = 3
	set childControllerEnd.uiComponent.contextData = contextData
	do childControllerEnd.uiComponent.addAttribute("efdaterangeendmax", "31/12/2001" )
	do element.uiComponent.childComponents.SetAt(childControllerEnd.uiComponent,2)
			
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1"">dateranger</label></div><divclass='col-sm-8ef_proweb_form_prompt'><divstyle='float:left;text-align:left;'><inputtype=""date""class=""ef-kendo-form-controlefDatePicker""title=""""id=""proweb-1-startDate""name=""proweb-1-startDate""value=""""placeholder=""DD/MM/YYYY""efdaterangestartmin=""24/12/2001""efKendoDateFormat=""dd/MM/yyyy""></div><divstyle='float:left;text-align:left;margin-left:15px;margin-right:15px;'>to</div><divstyle='float:left;text-align:left;'><inputtype=""date""class=""ef-kendo-form-controlefDatePicker""title=""""id=""proweb-1-endDate""name=""proweb-1-endDate""value=""""placeholder=""DD/MM/YYYY""efdaterangeendmax=""31/12/2001""efKendoDateFormat=""dd/MM/yyyy""></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.dropdownTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52666.398429</TimeChanged>
<TimeCreated>64204,52666.398429</TimeCreated>

<Method name="TestPageWithDropdown">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set page=##class(EF.pageController.proweb.page).createNew(contextData)
	set elementIdentifier = "proweb-1"
	set element = ##class(EF.pageController.proweb.dropdown).addElementToParent(page, elementIdentifier,"diet","")
	do page.uiComponent.addChild(element.uiComponent)	
	
	set alternative = element.addAlternative("meat","meat")
	set alternative = element.addAlternative("vegetarian","vegetarian")
	set alternative = element.addAlternative("vegan","vegan")
	do page.uiComponent.childComponents.SetAt(element.uiComponent,1)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1"">diet</label></div><divclass='col-sm-8ef_proweb_form_prompt'><selectclass=""form-controlef-proweb-input-element""name=""proweb-1""id=""proweb-1""title=""""><optionvalue=''></option><optionvalue=""meat"">meat</option><optionvalue=""vegetarian"">vegetarian</option><optionvalue=""vegan"">vegan</option></select></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestPageWithDropdownPreSelected">
<Implementation><![CDATA[
	#dim element as EF.pageController.element
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set page=##class(EF.pageController.proweb.page).createNew(contextData)
	set elementIdentifier = "proweb-1"
	set element = ##class(EF.pageController.proweb.dropdown).addElementToParent(page, elementIdentifier,"diet","vegan")
	do page.uiComponent.addChild(element.uiComponent)	
	set alternative = element.addAlternative("meat","meat")
	set alternative = element.addAlternative("vegetarian","vegetarian")
	set alternative = element.addAlternative("vegan","vegan")
	
	do page.uiComponent.childComponents.SetAt(element.uiComponent,1)
	set element.uiComponent.contextData = contextData
	do element.updateUIComponent()
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1"">diet</label></div><divclass='col-sm-8ef_proweb_form_prompt'><selectclass=""form-controlef-proweb-input-element""name=""proweb-1""id=""proweb-1""title=""""><optionvalue=''></option><optionvalue=""meat"">meat</option><optionvalue=""vegetarian"">vegetarian</option><optionselected=""""value=""vegan"">vegan</option></select></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestPageWithDropdownMandatory">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set page=##class(EF.pageController.proweb.page).createNew(contextData)
	set elementIdentifier = "proweb-1"
	set element = ##class(EF.pageController.proweb.dropdown).addElementToParent(page, elementIdentifier,"diet","vegan")
	do page.uiComponent.addChild(element.uiComponent)	
	set alternative = element.addAlternative("meat","meat")
	set alternative = element.addAlternative("vegetarian","vegetarian")
	set alternative = element.addAlternative("vegan","vegan")
	do page.uiComponent.childComponents.SetAt(element.uiComponent,1)
	set element.uiComponent.contextData = contextData
	set element.uiComponent.isMandatory = 1
	do element.updateUIComponent()
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_promptef-required-field'><labelclass=""control-label""for=""proweb-1"">diet</label></div><divclass='col-sm-8ef_proweb_form_prompt'><selectclass=""form-controlef-proweb-input-element""name=""proweb-1""id=""proweb-1""title=""""><optionvalue=''selecteddisabled>Chooseone...</option><optionvalue=""meat"">meat</option><optionvalue=""vegetarian"">vegetarian</option><optionselected=""""value=""vegan"">vegan</option></select></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.emailInputMultiTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52684.401246</TimeChanged>
<TimeCreated>64204,52684.401246</TimeCreated>

<Method name="TestMultiEmail">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "email"
	#dim value as %String = "fred@eventsforce.com"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.emailInputMulti).addElementToParent(page, elementIdentifier, labelText, value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1""pattern=""^(([a-zA-Z0-9_\-\.&#39;]+)(\+[a-zA-Z0-9_\-\.&#39;]+){0,1}@(([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,63}|[0-9]{1,3}))(\s*[;,]\s*(([a-zA-Z0-9_\-\.&#39;]+)(\+[a-zA-Z0-9_\-\.&#39;]+){0,1}@(([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,63}|[0-9]{1,3})))*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;email\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""multiple>email</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""email""class=""form-controlef-proweb-input-element""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""""pattern=""^(([a-zA-Z0-9_\-\.&#39;]+)(\+[a-zA-Z0-9_\-\.&#39;]+){0,1}@(([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,63}|[0-9]{1,3}))(\s*[;,]\s*(([a-zA-Z0-9_\-\.&#39;]+)(\+[a-zA-Z0-9_\-\.&#39;]+){0,1}@(([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,63}|[0-9]{1,3})))*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;email\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""multiplemultiple></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.emailInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52696.984856</TimeChanged>
<TimeCreated>64204,52696.984856</TimeCreated>

<Method name="TestEmail">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "email"
	#dim value as %String = "fred@eventsforce.com"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.emailInput).addElementToParent(page, elementIdentifier, labelText, value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1""pattern=""^(([a-zA-Z0-9_\-\.&#39;]+)(\+[a-zA-Z0-9_\-\.&#39;]+){0,1}@(([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,63}|[0-9]{1,3}))$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;email\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">email</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""email""class=""form-controlef-proweb-input-element""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""""pattern=""^(([a-zA-Z0-9_\-\.&#39;]+)(\+[a-zA-Z0-9_\-\.&#39;]+){0,1}@(([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,63}|[0-9]{1,3}))$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;email\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.integerInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52712.809439</TimeChanged>
<TimeCreated>64204,52712.809439</TimeCreated>

<Method name="TestInteger">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "Shoesize"
	#dim value as %String = "42"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.integerInput).addElementToParent(page, elementIdentifier, labelText, value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1""pattern=""^([\+\-]){0,1}\d+$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Shoesize\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">Shoesize</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""number""class=""form-controlef-proweb-input-element-short""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""""pattern=""^([\+\-]){0,1}\d+$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Shoesize\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.numericInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52723.013439</TimeChanged>
<TimeCreated>64204,52723.013439</TimeCreated>

<Method name="TestDecimalNumber">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "Shoesize"
	#dim value as %String = "42"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.numericInput).addElementToParent(page, elementIdentifier, labelText, value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1""pattern=""^[+-]?((0)|([1-9][0-9]*?))?(\.[0-9]{1,2})?$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Shoesize\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">Shoesize</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""text""class=""form-controlef-proweb-input-element-short""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""""pattern=""^[+-]?((0)|([1-9][0-9]*?))?(\.[0-9]{1,2})?$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;Shoesize\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.pageTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52737.158858</TimeChanged>
<TimeCreated>64189,44993.632692</TimeCreated>

<Method name="TestEditModeHTML">
<Implementation><![CDATA[
	set floatingMenu = ##class(EF.ui.components.frontend.floatingMenu).%New()
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(floatingMenu,"outputFloatingMenuHTML")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divid=""myFloater""class=""containeref-proweb-menu-handlerow""style=""display:none;""><divclass=""dropdownef-proweb-dropdown""><aid=""efProwebHeader""role=""button""data-toggle=""dropdown""class=""btnbtn-primaryef-proweb-dropdown-button""data-target=""#""href=""/page.html"">DfeaultHeaderText<spanclass=""caret""></span></a><ulclass=""dropdown-menumulti-levelef-proweb-dropdown-sub""role=""menu""aria-labelledby=""dropdownMenu""><li><aid=""efProwebEditLink""href=""#"">Edit</a></li><li><aid=""efProwebDeleteLink""href=""#"">Delete</a></li><liclass=""divider""></li><liclass=""dropdown-submenu""><atabindex=""-1""href=""#"">InsertAbove</a><ulclass=""dropdown-menu""><li><aid=""efProwebInsertQuestionAboveLink""tabindex=""-1""href=""#"">Question</a></li><li><aid=""efProwebInsertDividerAboveLink""href=""#"">Divider</a></li><li><aid=""efProwebInsertTextBlockAboveLink""href=""#"">Textblock</a></li></ul></li><liclass=""dropdown-submenu""><atabindex=""-1""href=""#"">InsertBelow</a><ulclass=""dropdown-menu""><li><aid=""efProwebInsertQuestionBelowLink""tabindex=""-1""href=""#"">Question</a></li><li><aid=""efProwebInsertDividerBelowLink""href=""#"">Divider</a></li><li><aid=""efProwebInsertTextBlockBelowLink""href=""#"">Textblock</a></li></ul></li></ul></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="debugTarget">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.textInput).addElementToParent(page,"p-1","shoe",33, 0)
	set element.uiComponent.contextData = contextData
	do page.uiComponent.addChild(element.uiComponent)
	do page.render()
]]></Implementation>
</Method>

<Method name="TestGuestPromptsPanel">
<Implementation><![CDATA[
	#dim value as %String = ""
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	
	
	set element = ##class(EF.pageController.proweb.textInput).addElementToParent(page, "proweb-1", "Attendee First name", value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	set element.displayOrder = 1
	
	set element = ##class(EF.pageController.proweb.textInput).addElementToParent(page, "proweb-2", "Attendee Last name", value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	set element.displayOrder = 2
	
	set element = ##class(EF.pageController.proweb.textInput).addElementToParent(page, "proweb-3", "Guest First name", value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	set element.uiComponent.isGuest = 1
	set element.displayOrder = 3
	
	set element = ##class(EF.pageController.proweb.textInput).addElementToParent(page, "proweb-4", "Guest Last name", value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	set element.uiComponent.isGuest = 1
	set element.displayOrder = 4
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"renderProwebItemsForComponent")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;AttendeeFirstname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">AttendeeFirstname</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""text""class=""form-controlef-proweb-input-element""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;AttendeeFirstname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div><divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-2""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;AttendeeLastname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">AttendeeLastname</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""text""class=""form-controlef-proweb-input-element""title=""""id=""proweb-2""name=""proweb-2""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;AttendeeLastname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div><divclass=""ef-proweb-guest-panelef-draggable-div""><divclass=""panel-heading"">Guest</div><divclass=""panel-body""><divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-3""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;GuestFirstname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">GuestFirstname</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""text""class=""form-controlef-proweb-input-element""title=""""id=""proweb-3""name=""proweb-3""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;GuestFirstname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div><divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-4""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;GuestLastname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">GuestLastname</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""text""class=""form-controlef-proweb-input-element""title=""""id=""proweb-4""name=""proweb-4""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;GuestLastname\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.phoneNumberTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52750.117876</TimeChanged>
<TimeCreated>64204,52750.117876</TimeCreated>

<Method name="TestPhoneNumber">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "phone number"
	#dim value as %String = "020 76 88 32 38"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.phoneNumber).addElementToParent(page, elementIdentifier, labelText, value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1""pattern=""^(?!(.*-(\s)*-.*))(?!(.*\.(\s)*\..*))(?=.*[\d\)](\s)*$)(?=.*(\d)+.*)(\+(\d){1,3}){0,1}(?=\s*([\d\(]).*)(([\d\s\-\.])|(\(([\d\-\.\s])+\)))*(\s)*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;phonenumber\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">phonenumber</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""tel""class=""form-controlef-proweb-input-element""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""""pattern=""^(?!(.*-(\s)*-.*))(?!(.*\.(\s)*\..*))(?=.*[\d\)](\s)*$)(?=.*(\d)+.*)(\+(\d){1,3}){0,1}(?=\s*([\d\(]).*)(([\d\s\-\.])|(\(([\d\-\.\s])+\)))*(\s)*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;phonenumber\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.radioButtonsTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52760.35415</TimeChanged>
<TimeCreated>64204,52760.35415</TimeCreated>

<Method name="TestWithRadioButtons">
<Implementation><![CDATA[
	#dim element as EF.pageController.element
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set page=##class(EF.pageController.proweb.page).createNew(contextData)
	set elementIdentifier = "proweb-1"
	set element = ##class(EF.pageController.proweb.radioButtons).addElementToParent(page, elementIdentifier,"diet","vegan")
	do page.uiComponent.addChild(element.uiComponent)	
	set alternative = element.addAlternative("meat","meat")
	set alternative = element.addAlternative("vegetarian","vegetarian")
	set alternative = element.addAlternative("vegan","vegan")
	
	do page.uiComponent.childComponents.SetAt(element.uiComponent,1)
	set element.uiComponent.contextData = contextData
	do element.updateUIComponent()
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1"">diet</label></div><divclass='col-sm-8ef_proweb_form_promptef-proweb-radio-group'><divclass=""btn-group""id=""proweb-1""data-toggle=""buttons""title=""""><divclass='col-sm-12ef-proweb-radio-button'><labelclass=""btnef-btn-defaultef-proweb-radio-button""id=""proweb-1_1-label""><inputtype=""radio""value=""meat""name=""proweb-1""id=""proweb-1_1"">&nbsp;meat</label></div><divclass='col-sm-12ef-proweb-radio-button'><labelclass=""btnef-btn-defaultef-proweb-radio-button""id=""proweb-1_2-label""><inputtype=""radio""value=""vegetarian""name=""proweb-1""id=""proweb-1_2"">&nbsp;vegetarian</label></div><divclass='col-sm-12ef-proweb-radio-button'><labelclass=""btnef-btn-defaultef-proweb-radio-buttonactive""id=""proweb-1_3-label""><inputtype=""radio""checkedvalue=""vegan""name=""proweb-1""id=""proweb-1_3"">&nbsp;vegan</label></div></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.textAreaTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52770.974784</TimeChanged>
<TimeCreated>64204,52770.974784</TimeCreated>

<Method name="TestTextArea">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "write an essay here"
	#dim value as %String = "lorem ipsum"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.textArea).addElementToParent(page, elementIdentifier, labelText, value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1"">writeanessayhere</label></div><divclass='col-sm-8ef_proweb_form_prompt'><textareatype=""text""class=""form-controlef-proweb-input-element""title=""""id=""proweb-1""name=""proweb-1""placeholder=""""></textArea></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.textBlockTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52784.358512</TimeChanged>
<TimeCreated>64204,52784.358512</TimeCreated>

<Method name="TestBasicPageWithTextBlock">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set page=##class(EF.pageController.proweb.page).createNew(contextData)
	set elementIdentifier = "proweb-1"
	
	set element = ##class(EF.pageController.proweb.textBlock).addElementToParent(page, elementIdentifier, "lorem ipsum")
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-12'><div>loremipsum</div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.textInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52795.592181</TimeChanged>
<TimeCreated>64204,52795.592181</TimeCreated>

<Method name="TestbasicInputField">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "First Name"
	#dim value as %String = "Elvis"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.textInput).addElementToParent(page, elementIdentifier, labelText, value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;FirstName\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">FirstName</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""text""class=""form-controlef-proweb-input-element""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;FirstName\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>

<Method name="TestBasicPageWithMandatoryTextField">
<Implementation><![CDATA[
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	set page=##class(EF.pageController.proweb.page).createNew(contextData)
	set elementIdentifier = "proweb-1"
	set element = ##class(EF.pageController.proweb.textInput).addElementToParent(page, elementIdentifier, "First Name", "Elvis", 0)

	set element.displayOrder = 1
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	set element.uiComponent.isMandatory = 1
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_promptef-required-field'><labelclass=""control-label""for=""proweb-1""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;FirstName\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">FirstName</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""text""class=""form-controlef-proweb-input-element""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""""pattern=""^[^\x00-\x1F\x7F]*$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;FirstName\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.timeInputTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52806.787409</TimeChanged>
<TimeCreated>64204,52806.787409</TimeCreated>

<Method name="TestTime">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "time"
	#dim value as %String = "14:23"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.timeInput).addElementToParent(page, elementIdentifier, labelText, value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1"">time</label></div><divclass='col-sm-8ef_proweb_form_prompt'><divclass=""ef_proweb_form_field_container_type_timeef-proweb-input-element-short""><inputtype=""text""class=""form-controlef-proweb-input-elementefTimePicker""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""HH:MM24hour""efKendoTimeFormat=""24""efKendoTimeInterval=15></div></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.testCases.webAddressTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64204,52820.48381</TimeChanged>
<TimeCreated>64204,51604.334511</TimeCreated>

<Method name="TestWebAddress">
<Implementation><![CDATA[
	#dim elementIdentifier as %String = "proweb-1"
	#dim labelText as %String = "your website"
	#dim value as %String = "http://www.bbc.com"
	#dim element as EF.pageController.element
	#dim page as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistrationMock).createMock()
	
	set page= ##class(EF.pageController.proweb.page).createNew(contextData)
	set element = ##class(EF.pageController.proweb.webAddress).addElementToParent(page, elementIdentifier, labelText, value, 0)
	do page.uiComponent.addChild(element.uiComponent)
	set element.uiComponent.contextData = contextData
	
	set returnedHTML = ##class(EF.utils.outputRedirection).redirectMethodOutputToString(page,"render")
	set returnedHTML = $ZStrip(returnedHTML,"*WC")
	set expectedHTML = "<divclass='rowef-proweb-form-row'><divclass='col-sm-4ef_proweb_form_prompt'><labelclass=""control-label""for=""proweb-1""pattern=""^(?:https?:\/\/)?(?:\S+(?::\S*)?@)?(?:(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/.*)?$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;yourwebsite\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);"">yourwebsite</label></div><divclass='col-sm-8ef_proweb_form_prompt'><inputtype=""url""class=""form-controlef-proweb-input-element""title=""""id=""proweb-1""name=""proweb-1""value=""""placeholder=""""pattern=""^(?:https?:\/\/)?(?:\S+(?::\S*)?@)?(?:(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/.*)?$""oninvalid=""ef.html5CustomMessages.setMessage(this,&quot;\&quot;yourwebsite\&quot;isincorrect&quot;);""oninput=""ef.html5CustomMessages.clearMessage(this);""></div></div>"
	do $$$AssertEquals(returnedHTML,expectedHTML)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pageController.proweb.textArea">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64201,42310.34868</TimeChanged>
<TimeCreated>63403,57168.063256</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.textArea).%New(..identifier)
]]></Implementation>
</Method>

<Method name="updateValue">
<FormalSpec>value</FormalSpec>
<Implementation><![CDATA[	set ..value=$ZSTRIP(value,"<>W")
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.textBlock">
<Super>EF.pageController.proweb.prowebBase</Super>
<TimeChanged>64197,56479.383488</TimeChanged>
<TimeCreated>64183,49747.663252</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.base</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.textBlock).%New(..identifier)
]]></Implementation>
</Method>

<Method name="initialiseUIComponent">
<FormalSpec>uiComponent:EF.ui.components.inputBase</FormalSpec>
<Implementation><![CDATA[
	do ##super(uiComponent)
	set ..uiComponent.text=..description
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.textInput">
<Super>EF.pageController.proweb.inputElement</Super>
<TimeChanged>64197,58681.00979</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.textInput).%New(..identifier)
]]></Implementation>
</Method>

<Method name="updateValue">
<FormalSpec>value</FormalSpec>
<Implementation><![CDATA[	set ..value=$ZSTRIP(value,"<>W")
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.timeInput">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64198,33582.083553</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.timeInput).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pageController.proweb.webAddress">
<Super>EF.pageController.proweb.textInput</Super>
<TimeChanged>64198,62804.621561</TimeChanged>
<TimeCreated>64189,53629.035726</TimeCreated>

<Method name="getDefaultUIComponent">
<ReturnType>EF.ui.components.inputBase</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.ui.components.frontend.webAddress).%New(..identifier)
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
</Storage>
</Class>


<Class name="EF.pages.frontend.base">
<Description><![CDATA[
Common page that all frontend pages could/should inherit from.
<!-- ;vc;
;vc;    Object: EF.pages.frontend.base.CLS/EV.9
;vc; Component: CLS.EF.pages.frontend.base
;vc;  Location: SmallDev
;vc; Date/Time: 02-Sep-16 14:23
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.pages.frontend.base.CLS/EV.9</td><td>CLS.EF.pages.frontend.base</td><td>SmallDev</td><td style='white-space: nowrap;'>02-Sep-16 14:23</td><td>JeremyW</td></tr></table>
]]></Description>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>shared.pCSPmanage</Super>
<TimeChanged>64201,41555.410872</TimeChanged>
<TimeCreated>63635,40114.778424</TimeCreated>

<Parameter name="showRegistrationProgressBar">
<Default>0</Default>
</Parameter>

<Parameter name="hasRegistrationQuestions">
<Default>0</Default>
</Parameter>

<Parameter name="efUsePageController">
<Type>%Boolean</Type>
<Default>1</Default>
</Parameter>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	
	Do ..OnPageCSPROOT()
	
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	do ..OnPagePageTop()
	do ..OnPagePageContent()
	do ..OnPagePageBottom()
]]></Implementation>
</Method>

<Method name="OnPagePageTop">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	w ##class(shared.pageMethods).outputFrontendHeader()
	Write !,"<head>"
	Write !
 	do ##class(layout.objTemplate).writeBit("","{{ef_header}}")
	Write !
	Do ..Include("frontendHTTPheader.csp")
	Write !
	Do ..Include("colourScheme.csp")
	do ..renderCommonCSS()
	do ..OnPagePageHeaderCSS()
	do ..renderCommonJavascript()
	Write !,!,"</head>"
	Write !,"<body class=""bodyBackground"">"
	Write !,!,!,!
	set app=##class(sc.objData).applicationPath()
	if ..#hasRegistrationQuestions {
		set isCOD = 1
	}
	do ##class(cspRealEV.system.proweb.templatestart).OnPageCSPROOT()
	
 	do ##class(layout.objTemplate).writeBit("{{ef_header}}","{{ef_banner}}")
 	do ##class(layout.objTemplate).writeBit("{{ef_banner}}","{{ef_main_progress}}")
 	if ..#showRegistrationProgressBar {
		if ($G(%session.Data("mode"))="preview")!($G(%session.Data("inSitePageEditing"))) {
			if '%request.Get("hideButtons") {
				Do ..Include("progress.csp")
			}
		}
 	}
 	do ##class(layout.objTemplate).writeBit("{{ef_main_progress}}","{{ef_main_header}}")
 	do ##class(layout.objTemplate).writeBit("{{ef_main_header}}", "{{ef_main_content}}")
]]></Implementation>
</Method>

<Method name="OnPagePageHeaderCSS">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="renderCommonCSS">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="renderCommonJavascript">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="OnPagePageBottom">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	do ##class(layout.objTemplate).writeBit("{{ef_main_buttons}}","{{ef_footer}}")
	do ##class(layout.objTemplate).writeBit("{{ef_footer}}","")
	Do ..Include("editingFooter.csp")
	set app=##class(sc.objData).applicationPath()
	do ##class(cspRealEV.system.proweb.templatestop).OnPageCSPROOT()
	Write !,!,"</body>"
	Write !,"</html>",!
]]></Implementation>
</Method>

<Method name="OnPagePageContent">
<ClassMethod>1</ClassMethod>
</Method>

<Method name="outputProwebListRows">
<Description>
this is for version 1 of proweb</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>componentName,pageID,isHTMLTable:%Boolean,paramIsRepeatedList:%Boolean=0</FormalSpec>
<Implementation><![CDATA[
	set beforeItem=##class(sc.xModules.objPage).getBeforeItem(pageID)
	new pageURL,app
	// Clear previously set component 
	KILL %session.Data("beforeRow")
	KILL %session.Data("afterRow")
	KILL %session.Data("beforeItem")
	KILL %session.Data("afterItem")
	KILL %session.Data("componentName")
	// retrieve the passed component name
	set %session.Data("beforeRow")=""
	set %session.Data("afterRow")=""
	if isHTMLTable {
		set %session.Data("beforeItem")=(beforeItem)
		set %session.Data("afterItem")="</TD></TR>"
	} else {
		set %session.Data("beforeItem")=""
		set %session.Data("afterItem")="" 	
	}
	set %session.Data("componentName")=componentName
	set isRepeatedList=paramIsRepeatedList
	set app=##class(sc.objData).applicationPath()
	set pageURL=app_"/system/proweb/tagFree.csp"
	do ##class(cspRealEV.system.proweb.tagfree).OnPageCSPROOT()
]]></Implementation>
</Method>

<Method name="outputProwebList">
<ClassMethod>1</ClassMethod>
<FormalSpec>componentName,pageID</FormalSpec>
<Implementation><![CDATA[
	&html<<table border=0 cellpadding=0 cellspacing=0 class="black10px" width="100%">>
	do ..outputProwebListRows(componentName,pageID,1)
	&html<</table>>
]]></Implementation>
</Method>

<Method name="isPageBeingEditedOrPreviewed">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	return ##class(shared.pageMethodsFrontend).isPageBeingEditedOrPreviewed()
]]></Implementation>
</Method>

<Method name="usePageController">
<Description>
################ these methods shuld be moved to a super class ######################</Description>
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	Quit ..#efUsePageController
]]></Implementation>
</Method>

<Method name="getPageDataClassName">
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Quit "EF.pageController.pagesFrontend."_$PIECE($PIECE(..#CSPFILE,"\",$LENGTH(..#CSPFILE,"\")),".",1)
]]></Implementation>
</Method>
</Class>


<Class name="EF.pages.frontend.baseProweb">
<ProcedureBlock>0</ProcedureBlock>
<Super>EF.pages.frontend.base</Super>
<TimeChanged>64205,34829.113358</TimeChanged>
<TimeCreated>64191,31442.531402</TimeCreated>

<Parameter name="ENCODED">
<Default>1</Default>
</Parameter>

<Parameter name="PRIVATE">
<Default>0</Default>
</Parameter>

<Parameter name="efPageGenerationNumber">
<Type>%Integer</Type>
<Default>4</Default>
</Parameter>

<Parameter name="efUsePageController">
<Type>%Boolean</Type>
<Default>1</Default>
</Parameter>

<Parameter name="efFormName">
<Type>%String</Type>
<Default>myForm</Default>
</Parameter>

<Parameter name="efFormID">
<Type>%String</Type>
<Default>EFFrontendForm</Default>
</Parameter>

<Parameter name="efServerStorageSaveLevel">
<Type>%String</Type>
<Default>event</Default>
</Parameter>

<Parameter name="efRenderMainModal">
<Type>%Boolean</Type>
<Default>1</Default>
</Parameter>

<Parameter name="efFormAction">
<Type>%String</Type>
<Default>pageControllerStandardSave.csp</Default>
</Parameter>

<Property name="pageControllerID">
<Type>%String</Type>
</Property>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	do ..OnPagePageTop()
	do ..initPageController()
	do ..outputFormBeginning()
	do ..OnPagePageContent()
	do ..outputButtons()

	do ..outputFormEnding()
	do ..OnPagePageBottom()

	if ##class(shared.pageMethods).getEditMode() = "edit" {
		kill %session.Data("insertBeforeProwebID") // ### to be improved when we refactor codQuestionDetails
		kill %session.Data("insertAfterProwebID")
		set floatingMenu = ##class(EF.ui.components.frontend.floatingMenu).%New()
		do floatingMenu.outputFloatingMenuHTML()	
		do floatingMenu.outputFloatingMenuJS()
	}
]]></Implementation>
</Method>

<Method name="initPageController">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	#dim pageController as EF.pageController.proweb.page
	
	set contextData = ##class(EF.contextDataRegistration).createFromFrontendCSPSession()
	if ..usePageController() {
		set pageControllerID=%request.Get("pageControllerID")
		merge requestData=%request.Data
		
		if pageControllerID {
			try {
				do ..beforePageControllerReload(pageControllerID)
				set pageController=##class(EF.pageController.page).open(pageControllerID,contextData)
				set contextData.pageID = pageController.prowebPageID
			
			} catch {
				// force a reload if there is a problem opening the page
				set pageControllerID=""
			}
		}
		if 'pageControllerID {
			set pageController=$CLASSMETHOD(..getPageDataClassName(),"createNew",contextData,.requestData)
			set pageController.isReadOnly = 0
			set pageController.prowebPageID = contextData.pageID
			
			set sc = pageController.%Save()
			if 'sc {
				throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(sc)
					
			}
		}
		
		set pageControllerID=pageController.%Id()
		
	}
]]></Implementation>
</Method>

<Method name="beforePageControllerReload">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageControllerID</FormalSpec>
</Method>

<Method name="renderCommonCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	w ##class(shared.pageMethods).getEditMode()
	if ##class(shared.pageMethods).getEditMode() = "edit" {
		&html<
			<link type="text/css" href="https://2bb0f132f679bac07fa4-638acaa65ecf53798e8a5faa656f2b95.ssl.cf3.rackcdn.com/libs/jQueryUI/v.1.8.21/jquery.css" rel="Stylesheet"/>
		>
	}
]]></Implementation>
</Method>

<Method name="renderCommonJavascript">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	if ##class(shared.pageMethods).getEditMode() = "edit"  {
		&html<
			<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
			<script type="text/javascript" src="../../media/javascript/distribution/ef-website-admin.min.js"></script>
		>
	}
]]></Implementation>
</Method>

<Method name="outputFormBeginning">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		<form id="#(..#efFormID)#" name="#(..getFormName())#" method="POST" action="#(..Link(..getFormAction()))#">
			<input type="hidden" name="pageControllerID" value="#(pageControllerID)#">
			<input type="hidden" name="pageID" value="#(contextData.pageID)#">
			
			<input type="hidden" id="efSubmitButtonIdentifier" name="efSubmitButtonIdentifier" value="">
			<input type="hidden" id="efDeleteButtonIdentifier" name="efDeleteButtonIdentifier" value="">
			<input type="hidden" id="efSaveAndReloadFormOnly" name="efSaveAndReloadFormOnly" value="">
	>
]]></Implementation>
</Method>

<Method name="outputFormEnding">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	write !,"</form>"
	do ##class(EF.pageController.javascriptMethods).outputMainJS(pageController)
]]></Implementation>
</Method>

<Method name="outputButtons">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
			<button id="ef_frontend_button_back" type="button" class="noPrint standardButton ef_frontend_button ef_frontend_button_back on-click-redirect" data-link-url="#(..encodeForHTMLAttribute(..Link(..getBackButtonURL())))#">
            	Back
        	</button>

        	
	>
	// ###### ugly hack ####
	set %request.Data("isSubmit",1) = 1
	set %request.Data("name",1) = "butProceed"
	set %request.Data("buttonText",1) = "Proceed"
	set %request.Data("hoverText",1) = "Submit and proceed"
	do ##class(cspRealEV.frontend.reg.frontendbutton).OnPage()
]]></Implementation>
</Method>

<Method name="getBackButtonURL">
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	new URL,backforward
	set backforward=##class(setup.objPageNav).goWhere(contextData.pageID, , contextData.tempPersonID)
	set URL = $Piece(backforward,"|",1)  // go back
	return URL
]]></Implementation>
</Method>

<Method name="verifyValidPage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Library.Boolean</ReturnType>
<Implementation><![CDATA[	return ##class(EF.pages.frontend.registrationProcess).verifyValidPage()
]]></Implementation>
</Method>

<Method name="getFormName">
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ..#efFormName
]]></Implementation>
</Method>

<Method name="getFormID">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	return ..#efFormID
]]></Implementation>
</Method>

<Method name="getFormAction">
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ..#efFormAction
]]></Implementation>
</Method>

<Method name="savePassedInDesiredPositionToSession">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	if %request.Get("insertBeforeProwebID") {
		set %session.Data("insertBeforeProwebID") = %request.Get("insertBeforeProwebID")
	}
	if %request.Get("insertAfterProwebID") {
		set %session.Data("insertAfterProwebID") = %request.Get("insertAfterProwebID")
	}
]]></Implementation>
</Method>

<Method name="moveNewElementToDesiredPosition">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	#dim targetPosition as %Integer = ""
	#dim insertBeforeProwebID as %Integer = %session.Get("insertBeforeProwebID")
	#dim insertAfterProwebID as %Integer = %session.Get("insertAfterProwebID")
	#dim basePosition as %Integer

	if insertBeforeProwebID {
		set basePosition = ##class(sc.objData).getDisplayOrder(insertBeforeProwebID)
		set targetPosition  = (basePosition - 1)
	} elseif insertAfterProwebID {
		set basePosition = ##class(sc.objData).getDisplayOrder(insertAfterProwebID)
		set targetPosition  = (basePosition + 1)
	}
	
	if targetPosition {
		do ##class(sc.xModules.objList).moveChildToPosition(dataID, targetPosition)
	}
	
	kill %session.Data("insertAfterProwebID")
	kill %session.Data("insertBeforeProwebID")
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.backend.panel">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.ui.components.backend.panel.CLS/EV.6
;vc; Component: CLS.EF.ui.components.backend.panel
;vc;  Location: LargeDev
;vc; Date/Time: 13-Oct-16 10:07
;vc;      User: FredG
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.ui.components.backend.panel.CLS/EV.6</td><td>CLS.EF.ui.components.backend.panel</td><td>LargeDev</td><td style='white-space: nowrap;'>13-Oct-16 10:07</td><td>FredG</td></tr></table>
]]></Description>
<Super>EF.ui.components.panel</Super>
<TimeChanged>64204,36476.928811</TimeChanged>
<TimeCreated>63361,62973.538498</TimeCreated>
</Class>


<Class name="EF.ui.components.frontend.checkbox">
<Super>EF.ui.components.checkbox,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64194,60882.313555</TimeChanged>
<TimeCreated>63355,62572.097775</TimeCreated>

<Method name="render">
<Implementation><![CDATA[
	// The html bit
	if $length(..label) {
		&html<
	        <label>
		        #[do ..renderCheckbox()]#
		        #(..encodeHTMLContent(..label))#
		    </label>
		    <br/>
		>
	} else {
		do ..renderCheckbox()	
	}
	do ##super()
]]></Implementation>
</Method>

<Method name="addOnDisableAction">
<FormalSpec>action</FormalSpec>
<Implementation><![CDATA[	do ..addAttribute("data-on-disable-action",action)
]]></Implementation>
</Method>

<Method name="renderCheckbox">
<Implementation><![CDATA[
	set disabledString=""
	if ..isDisabled {
		set disabledString="disabled=""disabled"""
	}
	set isCheckedString=""
	if ..value {
		set isCheckedString="checked"
	}
	&html<
		<input type="checkbox" value="1" id="#(..encodeHTMLAttribute(..htmlID))#" class="#(..encodeForHTMLAttribute(..classes))#" name="#(..encodeHTMLAttribute(..htmlName))#" title="#(..encodeHTMLAttribute(..title))#" #(..rawHTML(isCheckedString))# #(..rawHTML(disabledString))# #(..rawHTML(..getExtraAttributes()))#>
	>
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.checkboxGroup">
<Super>EF.ui.components.checkboxGroup,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64202,46838.872221</TimeChanged>
<TimeCreated>63356,56848.077942</TimeCreated>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	&html<
		
		<div class="form-group">
        	#[do ..renderCheckboxes()]#
        </div>
    >
    do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="renderCheckboxes">
<Implementation><![CDATA[
	set ind=""
	for column=1:1:..columns {
		do ..renderColumnStart()
		for row=1:1:..childComponents.Count() {
			set checkbox=..childComponents.GetAt($I(ind))
			if $IsObject(checkbox) {
				do ..renderCheckbox(checkbox)
			}
		}
		do ..renderColumnEnd()	
	}
]]></Implementation>
</Method>

<Method name="renderColumnStart">
<Implementation><![CDATA[
	if ..columns=1 {
		&html<<div class="inputs-list ef-proweb-input-element ef-proweb-checkboxGroup">>
	} elseif ..columns=2 {
		&html<<div class="inputs-list ef-proweb-input-element ef-proweb-checkboxGroup col-sm-6">>
	} else {
		throw ##class(shared.exceptions.generalException).%New("Checkbox group not implemented for "_..columns_" columns")	
	}
]]></Implementation>
</Method>

<Method name="renderColumnEnd">
<Implementation><![CDATA[	&html<</div>>
]]></Implementation>
</Method>

<Method name="renderCheckbox">
<FormalSpec>checkbox:EF.ui.components.frontend.checkbox</FormalSpec>
<Implementation><![CDATA[	do checkbox.render()
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.datePicker">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.ui.components.backend.datePicker.CLS/EV.3
;vc; Component: CLS.EF.ui.components.backend.datePicker
;vc;  Location: LargeDev
;vc; Date/Time: 02-Feb-16 12:32
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.ui.components.backend.datePicker.CLS/EV.3</td><td>CLS.EF.ui.components.backend.datePicker</td><td>LargeDev</td><td style='white-space: nowrap;'>02-Feb-16 12:32</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.ui.components.textInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64203,61940.738865</TimeChanged>
<TimeCreated>63384,38215.518113</TimeCreated>

<Parameter name="typeAttribute">
<Default>date</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Return ##super()_" ef-kendo-form-control"
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[
	set validator = ##class(EF.validator.dateInput).%New()
	set validator.dateFormat=##class(shared.dateFunctions).getFrontendInputDateFormat(..contextData.eventID)
	return validator
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	&html<<div class=" ef-proweb-input-element-short">>
	do ..renderInputElementOnly()
	&html<</div>>
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="renderInputElementOnly">
<Implementation><![CDATA[
	set ..classes = ..classes_"  efDatePicker "
	set kendoDateFormat = ##class(shared.dateFunctions).getKendoDateFormat(..validator.dateFormat)
	set ..placeHolder = ##class(shared.dateFunctions).datePattern(..validator.dateFormat)
	
	&html<
    	    <input type="#(..encodeHTMLAttribute(..#typeAttribute))#" class="#(..encodeHTMLAttribute(..classes))#" #(..rawHTML(..getDisabledString()))# 
    	    title="#(..encodeHTMLAttribute(..title))#" id="#(..encodeHTMLAttribute(..htmlID))#" name="#(..encodeHTMLAttribute(..htmlName))#" 
    	    value="#(..encodeHTMLAttribute(..value))#" placeholder="#(..encodeHTMLAttribute(..placeHolder))#"  #(..rawHTML(..getProwebExtraAttributes()))#
    	    efKendoDateFormat="#(..encodeHTMLAttribute(kendoDateFormat))#">
	>
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.dateRange">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.ui.components.backend.datePicker.CLS/EV.3
;vc; Component: CLS.EF.ui.components.backend.datePicker
;vc;  Location: LargeDev
;vc; Date/Time: 02-Feb-16 12:32
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.ui.components.backend.datePicker.CLS/EV.3</td><td>CLS.EF.ui.components.backend.datePicker</td><td>LargeDev</td><td style='white-space: nowrap;'>02-Feb-16 12:32</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.ui.components.textInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64202,51214.347117</TimeChanged>
<TimeCreated>63384,38215.518113</TimeCreated>

<Parameter name="typeAttribute">
<Default>date</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Return ##super()_" ef-kendo-form-control"
]]></Implementation>
</Method>

<Method name="renderJS">
<Implementation><![CDATA[
	&js<
		$(function() {
			$('##(..encodeJS(..htmlID))#').kendoDatePicker({
				format: getKendoDateFormat(#(..encodeJS(..validator.dateFormat))#),
			});
		});
	>
	do ##super()
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[
	set validator = ##class(EF.validator.dateInput).%New()
	set validator.dateFormat=##class(shared.dateFunctions).getFrontendInputDateFormat(..contextData.eventID)
	return validator
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	set kendoDateFormat = ##class(shared.dateFunctions).getKendoDateFormat(..validator.dateFormat)

	do ..renderColumnStart()
	set startDateComponent = ..childComponents.GetAt(1)
	set startDateComponent.placeHolder = ##class(shared.dateFunctions).datePattern(..validator.dateFormat)
	do startDateComponent.renderInputElementOnly()
	do ..renderColumnEnd()

	write !,"<div style='float: left; text-align: left; margin-left: 15px; margin-right: 15px;'>"
	write !,##class(shared.pCSP).out("to")
	do ..renderColumnEnd()

	do ..renderColumnStart()
	set endDateComponent = ..childComponents.GetAt(2) 
	set endDateComponent.placeHolder = ##class(shared.dateFunctions).datePattern(..validator.dateFormat)
	do endDateComponent.renderInputElementOnly()
	do ..renderColumnEnd()
	
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="renderColumnStart">
<Implementation><![CDATA[	write !,"<div style='float: left; text-align: left;'>"
]]></Implementation>
</Method>

<Method name="renderColumnEnd">
<Implementation><![CDATA[	write !,"</div>"
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.divider">
<Super>EF.ui.components.frontend.prowebBase</Super>
<TimeChanged>64188,60850.760112</TimeChanged>
<TimeCreated>64188,59498.911424</TimeCreated>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpening()
		do ..renderCellOpening()
			write "<hr class='ef_form_divider'>"
		do ..renderCellClosing()
	do ..renderRowClosing()
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.dropdown">
<Super>EF.ui.components.listInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64194,43219.104852</TimeChanged>
<TimeCreated>63355,56609.363142</TimeCreated>

<Property name="isPersistent">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Method name="render">
<Implementation><![CDATA[
	if ..hasError do ..addClass("has-error")
	set selectClass="form-control ef-proweb-input-element"
	if ..isPersistent {
		set selectClass=selectClass_" ef-persistent-value"	
	}
	set disabledString=""
	if ..isDisabled {
		set disabledString="disabled=""disabled"""
	}	
	do ..renderRowOpeningAndLabel()
	&html<		
		<select class="#(..encodeForHTMLAttribute(selectClass))#" name="#(..encodeHTMLAttribute(..htmlName))#" id="#(..encodeHTMLAttribute(..htmlID))#" title="#(..encodeHTMLAttribute(..title))#" #(..rawHTML(disabledString))# #(..rawHTML(..getExtraAttributes()))#>
    		#[do ..renderPlaceholder()]#
    		#[do ..renderAlternatives()]#
        </select>
    >
    do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="renderAlternative">
<FormalSpec>alternative:EF.ui.components.alternative</FormalSpec>
<Implementation><![CDATA[
	
	set selectedString=""
	if alternative.isSelected {
		set selectedString="selected="""""	
	}
	
	set disabledString=""
	if alternative.isDisabled {
		set disabledString="disabled"	
	}
	
	// The html bit
	&html<
        <option #(..rawHTML(selectedString))# #(..rawHTML(disabledString))# value="#(..encodeHTMLAttribute(alternative.value))#" #(..rawHTML(alternative.getExtraAttributes()))#>
        	#(..encodeHTMLContent(alternative.label))#
        </option>
	>
]]></Implementation>
</Method>

<Method name="renderPlaceholder">
<Private>1</Private>
<Implementation><![CDATA[
	if ..isMandatory  {
		if ..isAnyAlternativeSelected() {
			set selectString = ""
		} else {
			set selectString = "selected"	
		}
		write !,"<option value='' ",selectString," disabled>",..encodeHTMLContent(##class(shared.pCSP).out("Choose one...")),"</option>",!	
		
	} else {
		write !,"<option value=''></option>",!
	}
]]></Implementation>
</Method>

<Method name="isAnyAlternativeSelected">
<Private>1</Private>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	for position = 1:1:..alternatives.Count() {
		if ..alternatives.GetAt(position).isSelected {
			return 1
			
		}	
	}	
	return 0
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.emailInput">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64198,33019.928048</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>email</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.emailAddress).%New()
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.emailInputMulti">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64201,49815.627658</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>email</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.emailAddressMulti).%New()
]]></Implementation>
</Method>

<Method name="getExtraAttributes">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	do ..addAttribute("multiple","")
	return ##super()
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.floatingMenu">
<Super>shared.pCSPmanage</Super>
<TimeChanged>64204,51293.686856</TimeChanged>
<TimeCreated>64203,40625.329831</TimeCreated>

<Method name="outputFloatingMenuJS">
<Description>
####### move this to external file? ############</Description>
<Implementation><![CDATA[
	
	write !,"<script language='javascript'>"
	&js<
	
    $(document).ready(function() {
	    efProwebEditBaseURL = '#(..encodeForHTMLAttribute(..Link("../../backend/proweb/codQuestionDetails.csp")))#'; 
	    efProwebAddQuestionBaseURL = '#(..encodeForHTMLAttribute(..Link(..getInitalURL("codQuestionDetails.csp"))))#'; 
	    efProwebAddDividerBaseURL = '#(..encodeForHTMLAttribute(..Link("../../backend/proweb/formDivider.csp")))#'; 
		efProwebAddTextBlockBaseURL = '#(..encodeForHTMLAttribute(..Link("../../backend/proweb/textDetailsMoxie.csp")))#'; 

		var ef_hide_floater;

        $('div.ef-proweb-form-row-editable').mouseover(function(e) {
	        if (!$(this).hasClass("ef-showing-floater")) { 
		        var prowebTitle = $(this).data("proweb-title");
		        var prowebID = $(this).data("proweb-id");
		      	var prowebListID = $(this).data("proweb-list-id");
		        $(this).addClass("ef-showing-floater");
		        $('#myFloater').css('top',e.pageY);
				$('#myFloater').css('left',e.pageX);
		        console.log('prowebListID='+prowebListID);
		        $('#efProwebHeader').text( prowebTitle );
		        $('#efProwebEditLink').attr('href', efProwebEditBaseURL + '&dataID=' + prowebID);
		        $('#efProwebDeleteLink').attr('href', 'javascript: confirmDelete(' + prowebID + ');');

		        $('#efProwebInsertQuestionAboveLink').attr('href', efProwebAddQuestionBaseURL + '&insertBeforeProwebID=' + prowebID + '&parent=' + prowebListID);
		        $('#efProwebInsertQuestionBelowLink').attr('href', efProwebAddQuestionBaseURL + '&insertAfterProwebID=' + prowebID + '&parent=' + prowebListID);

		        $('#efProwebInsertDividerAboveLink').attr('href', efProwebAddDividerBaseURL + '&insertBeforeProwebID=' + prowebID + '&parent=' + prowebListID);
		        $('#efProwebInsertDividerBelowLink').attr('href', efProwebAddDividerBaseURL + '&insertAfterProwebID=' + prowebID + '&parent=' + prowebListID);

		        $('#efProwebInsertTextBlockAboveLink').attr('href', efProwebAddTextBlockBaseURL + '&dataID=NEW&insertBeforeProwebID=' + prowebID + '&parent=' + prowebListID);
		        $('#efProwebInsertTextBlockBelowLink').attr('href', efProwebAddTextBlockBaseURL + '&dataID=NEW&&insertAfterProwebID=' + prowebID + '&parent=' + prowebListID);

	            $('#myFloater').show('slow');
	            clearTimeout(ef_hide_floater);
            	ef_hide_floater = setTimeout(function() { ef_proweb_floater_fadeout(this); }, 6000);
	        }
        });

        $('div.ef-proweb-form-row-editable').click(function() { // ###### not triggering
			$('#myFloater').hide();
			$(this).removeClass("ef-showing-floater");
			console.log('hide on click');
        });
        
        
        $('div.ef-proweb-form-row-editable').mouseleave(function() {
	        console.log('setting fade timeout on mouseout');
			$(this).removeClass("ef-showing-floater");
        });
        
        
        $('#myFloater').mouseover(function() {
           if (typeof ef_hide_floater !== "undefined") {
           		console.log('clear timeout on mouseover');
           		clearTimeout(ef_hide_floater);
           }
           return true;
        });
    });
    
    function ef_proweb_floater_fadeout(div) {
	    $('#myFloater').fadeOut('slow');
	    $(div).removeClass("ef-showing-floater");
    }	
	>	
	write !,"</script>"
]]></Implementation>
</Method>

<Method name="outputFloatingMenuHTML">
<Implementation><![CDATA[
	&html<
		<div id="myFloater" class="container ef-proweb-menu-handle row" style="display: none;">
	        <div class="dropdown ef-proweb-dropdown">
	            <a id="efProwebHeader" role="button" data-toggle="dropdown" class="btn btn-primary ef-proweb-dropdown-button" data-target="#" href="/page.html">
	            	Dfeault Header Text 
	            	<span class="caret"></span>
	            </a>
	    		<ul class="dropdown-menu multi-level ef-proweb-dropdown-sub" role="menu" aria-labelledby="dropdownMenu">
	              <li><a id="efProwebEditLink" href="#">Edit</a></li>
	              <li><a id="efProwebDeleteLink" href="#">Delete</a></li>
	              <li class="divider"></li>
	              
                >
                for aboveOrBelow = "Above","Below" {
	                &html<
			              <li class="dropdown-submenu">
			                <a tabindex="-1" href="#">Insert #(aboveOrBelow)#</a>
			                <ul class="dropdown-menu">
			                  <li><a id="efProwebInsertQuestion#(aboveOrBelow)#Link" tabindex="-1" href="#">Question</a></li>
			                  <li><a id="efProwebInsertDivider#(aboveOrBelow)#Link" href="#">Divider</a></li>
			                  <li><a id="efProwebInsertTextBlock#(aboveOrBelow)#Link" href="#">Text block</a></li>
			                </ul>
			              </li>
						>
                	}
                &html<		              
	            </ul>
	        </div>
		</div>
	>
]]></Implementation>
</Method>

<Method name="getInitalURL">
<FormalSpec>targetPage:%String</FormalSpec>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim URL as %String
	#dim contextData as EF.contextDataRegistration = ##class(EF.contextDataRegistration).createFromFrontendCSPSession()
	 
	set URL = "../../backend/proweb/"_targetPage
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"dataID","NEW")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"orgDataID","ADD")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"displayOrder",0)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"addToTop","true")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"isCOD",1)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"pageID",contextData.pageID)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"itemNameID","NEW")
	
	return URL
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.floatingMenuAdd">
<Super>%RegisteredObject</Super>
<TimeChanged>64196,52998.169116</TimeChanged>
<TimeCreated>64190,37989.914109</TimeCreated>

<Property name="contextData">
<Type>EF.contextDataRegistration</Type>
</Property>

<Property name="templateFilename">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="templateID">
<Type>%Integer</Type>
<Required>1</Required>
</Property>

<Property name="pageID">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="menuID">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="parentID">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="eventHotelID">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Method name="createNew">
<ClassMethod>1</ClassMethod>
<FormalSpec>contextData:EF.contextDataRegistration</FormalSpec>
<ReturnType>sc.floatingMenu</ReturnType>
<Implementation><![CDATA[
	#dim pageID as %Integer = contextData.pageID
	#dim componentName as %String = contextData.prowebComponentName
	
	set menu = ..%New()
	set menu.contextData = contextData
	set menu.eventHotelID = ##class(accom.objEventHotel).getIDFromPageID(pageID)
	set menu.templateID =  ##class(sc.pageMethods).getTemplateIDfromPageID(pageID)
	set menu.templateFilename = ##class(sc.objTemplate).getFileName(menu.templateID)
	set menu.parentID = ##class(sc.xModules.objList).getListIDFromPageIDAndComponentName(pageID,componentName)

	return menu
]]></Implementation>
</Method>

<Method name="outputJS">
<Implementation><![CDATA[
	#dim pageID as %Integer = ..contextData.pageID
	#dim componentName as %String = ..contextData.prowebComponentName
	set ..menuID = ..contextData.getNewFloatingMenuCounter()
	
	set page = ##class(sc.xModules.objPage).%OpenId(pageID)
	set pageFileName = page.getFileNameWithoutPathLowerCase()
	
	if $Data(%session) {
		set %session.Data("eventsforce","backend","email or web page")="web page"
	}
	if $IsObject(page.objEvent) {
		set eventConfiguration=##class(setup.eventConfiguration).createForEventID(page.objEvent.%Id())
	}
	
	write !,"<sc"_"ript language='javasc"_"ript'>"
	write !,"HM_Array"_..menuID_" = [[150,,,,,,,,,,,,,,,,,,,,1],"
	
	if page.allowRegistrationQuestions(componentName){
		write !,..getMenuItemJS("Registration Question")
	
	}
	if page.allowABIs() {
		write !,..getMenuItemJS("Bookable Item")
		if eventConfiguration.areQBIsAllowed() {
			write !,..getMenuItemJS("Quantity Bookable Item")
		}
	}
	
	if page.alllowPromptCollections() {
		//write !,..getMenuItemJS("Reg Prompt Collections")	
	}
	if page.isSurvey() {
		set surveyGroupID = ##class(sc.objData).getParentID(pageID)
		&SQL(SELECT TOP 1 ID INTO :lastPageID FROM sc_xModules.objPage WHERE parent = :surveyGroupID ORDER BY displayOrder DESC)
		if lastPageID '= pageID {
			write !,..getMenuItemJS("Question")
		}
	}
	if page.isHotel() {
		write !,..getMenuItemJS("Question With Price")
		write !,..getMenuItemJS("Question With No Price")
	}
	
	write !,..getMenuItemJS("Text Block")
	
	if page.allowDivider(componentName) {
		write !,..getMenuItemJS("Divider")	
	}
	if page.allowMiscMedia() {
		write !,..getMenuItemJS("Menu Block")
		write !,..getMenuItemJS("Scrolling Image")
		write !,..getMenuItemJS("YouTube Video")
	}
	if page.allowFrontendUpload() {
		//write !,..getMenuItemJS("File Upload")
	}
	write !,"]</sc"_"ript>"
]]></Implementation>
</Method>

<Method name="getMenuItemJS">
<FormalSpec>menuItemText:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim targetPage as %String
	#dim URL as %String
	#define codQuestionDetailsPage "codQuestionDetails.csp"
	
	
	if menuItemText = "Registration Question" {
		set URL = ..getInitalURL($$$codQuestionDetailsPage)
	
	} elseif menuItemText = "Question" {		//surveys
		set URL = ..getInitalURL($$$codQuestionDetailsPage)

	} elseif menuItemText = "Bookable Item" {
		set URL = ..getInitalURL($$$codQuestionDetailsPage)
		set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"additional",1)

	} elseif menuItemText = "Quantity Bookable Item" {
		set URL = ..getInitalURL($$$codQuestionDetailsPage)
		set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"quantityItem",1)
	
	} elseif menuItemText = "Reg Prompt Collections" {
		set URL = ..getInitalURL("regPromptCollectionDetails.csp")
	
	} elseif menuItemText = "Question With Price" { //accommodation
		set URL = ..getInitalURL($$$codQuestionDetailsPage)
		set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"additional",1)
		set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"codGroup","Hotel")
		set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"eventHotelID",..eventHotelID)
	
	} elseif menuItemText = "Question With No Price" { //accommodation
		set URL = ..getInitalURL($$$codQuestionDetailsPage)
		set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"codGroup","Hotel")
		set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"eventHotelID",..eventHotelID)

	} elseif menuItemText = "Text Block" {
		set URL = ..getInitalURL("textDetailsMoxie.csp")

	} elseif menuItemText = "Divider" {
		set URL = ..getInitalURL("formDivider.csp")
		set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"position","top")

	} elseif menuItemText = "Menu Block" {
		set URL = ..getInitalURL("menuDetails.csp")

	} elseif menuItemText = "Button" {
		set URL = ..getInitalURL("createImageDetails.csp")

	} elseif menuItemText = "Scrolling Image" {
		set URL = ..getInitalURL("scrollingImageDetails.csp")

	} elseif menuItemText = "Flash" {
		set URL = ..getInitalURL("flashDetails.csp")

	} elseif menuItemText = "YouTube Video" {
		set URL = ..getInitalURL("flashDetails.csp")
		set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"isVideo",1)

	} elseif menuItemText = "File Upload" {
		set URL = ..getInitalURL("fileUploadDetails.csp")
		
	} else {
		throw ##class(shared.exceptions.generalException).%New("Invalid menuItemText: "_menuItemText)
	}
	
	return "['"_menuItemText_"','"_##class(EF.htmlGenerator).linkURL(URL)_"',1,0,0],"
]]></Implementation>
</Method>

<Method name="getInitalURL">
<FormalSpec>targetPage:%String</FormalSpec>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim URL as %String
	
	set URL = "../../backend/proweb/"_targetPage

	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"dataID","NEW")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"templateURL",..templateFilename)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"componentName",..contextData.prowebComponentName)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"templateID",..templateID)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"orgDataID","ADD")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"parent",..parentID)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"displayOrder",0)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"classNo",1)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"addToTop","true")
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"isCOD",1)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"pageID",..contextData.pageID)
	set URL = ##class(EF.htmlGenerator).addParameterToURL(URL,"itemNameID","NEW")
	
	return URL
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.inputElement">
<Super>EF.ui.components.frontend.prowebBase,EF.ui.components.inputBase</Super>
<TimeChanged>64205,30717.151496</TimeChanged>
<TimeCreated>64183,40678.260093</TimeCreated>

<Property name="alternatives">
<Type>EF.ui.components.alternative</Type>
<Collection>list</Collection>
</Property>

<Property name="isMandatory">
<Type>%Boolean</Type>
</Property>

<Property name="guestNumber">
<Type>%Integer</Type>
</Property>

<Property name="isGuest">
<Type>%Boolean</Type>
</Property>

<Property name="helpText">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.singleLineText).%New()
]]></Implementation>
</Method>

<Method name="renderRowOpeningAndLabel">
<Implementation><![CDATA[
	if ..#html5Validation {
		set regex=..validator.getRegex()
		if $length(regex) {
			do ..addAttribute("pattern",regex)
		}
		do ..addAttribute("oninvalid","ef.html5CustomMessages.setMessage(this,"""_..encodeForJavaScript(..validator.getErrorMessage())_""");")
		do ..addAttribute("oninput","ef.html5CustomMessages.clearMessage(this);")	
	}
	
	
	do ..renderRowOpening()
	if ..isMandatory {
		do ..renderLabelCellOpeningMandatory()
	} else {
		do ..renderLabelCellOpening()
	}
	do ..renderLabel()
	do ..renderCellClosing()
	do ..renderInputElementCellOpening()
]]></Implementation>
</Method>

<Method name="renderHelpAndRowClosing">
<Implementation><![CDATA[
    Do ##class(sc.codItemMethods).outputHelpTextHTML(..helpText)
	do ..renderCellClosing()
	do ..renderRowClosing()
]]></Implementation>
</Method>

<Method name="renderLabel">
<Implementation><![CDATA[
	if $length(..label) {
		&html<<label class="control-label" for="#(..encodeForHTMLAttribute(..htmlID))#" #(..rawHTML(..getProwebExtraAttributes()))#>#(..encodeForHTML(..label))#</label>>
	}
]]></Implementation>
</Method>

<Method name="getDisabledString">
<Implementation><![CDATA[
	set disabledString=""
	if ..isDisabled {
		set disabledString="disabled='disabled'"
	}
	return disabledString
]]></Implementation>
</Method>

<Method name="renderLabelCellOpeningMandatory">
<Implementation><![CDATA[	write "<div class='col-sm-4 ef_proweb_form_prompt ef-required-field'>"
]]></Implementation>
</Method>

<Method name="renderLabelCellOpening">
<Implementation><![CDATA[	write "<div class='col-sm-4 ef_proweb_form_prompt ",..encodeForHTMLAttribute(..getDependentClass()),"'>"
]]></Implementation>
</Method>

<Method name="renderInputElementCellOpening">
<Implementation><![CDATA[	write "<div class='col-sm-8 ef_proweb_form_prompt'>"
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.integerInput">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64201,43151.319515</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>number</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.integer).%New()
]]></Implementation>
</Method>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Return "form-control ef-proweb-input-element-short"
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.numericInput">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64201,70886.199963</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Description>
this cannot be set to 'number' as Chrome will then require you to define step increment as well</Description>
<Default>text</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[
	set validator = ##class(EF.validator.numeric).%New()
	set validator.precision = 2
	return validator
]]></Implementation>
</Method>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Return "form-control ef-proweb-input-element-short"
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.panel">
<Super>EF.ui.components.panel</Super>
<TimeChanged>64204,43615.45981</TimeChanged>
<TimeCreated>64204,36543.176151</TimeCreated>

<Property name="isOpeningOrClosing">
<Type>%String</Type>
<Parameter name="VALUELIST" value=",opening,closing"/>
</Property>

<Method name="render">
<Implementation><![CDATA[
	if ..isOpeningOrClosing="opening" {
		&html<
			<div class="ef-proweb-guest-panel ef-draggable-div" >
	            <div class="panel-heading">#(##class(shared.pCSP).out("Guest"))#</div>
				<div class="panel-body">
		>
	} else {
		&html<
					
				</div>
			</div>
		>	
	}
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.phoneNumber">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64197,62099.100904</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>tel</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.phoneNumber).%New()
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.prowebBase">
<Super>EF.ui.components.base</Super>
<TimeChanged>64205,40952.483624</TimeChanged>
<TimeCreated>64183,41819.123112</TimeCreated>

<Property name="isProwebEditMode">
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
<Required>1</Required>
</Property>

<Property name="prowebItem">
<Type>sc.objData</Type>
</Property>

<Property name="contextData">
<Type>EF.contextData</Type>
</Property>

<Method name="renderRowOpening">
<Implementation><![CDATA[
	#dim prowebListID as %Integer
	 
	if ..contextData.%IsA("EF.contextDataRegistrationMock") {
		set prowebID = "mock-1"	
		set prowebListID = "mock-list-1"
		
	} else {
		set prowebID=..prowebItem.%Id()
		set prowebListID = ..prowebItem.parent.%Id()
	}
	
	if ..isProwebEditMode {
		set floaterTitle = ..getFloatingMenuHeader() 
		write !,"<div class='row ef-draggable-div ef-proweb-form-row-editable' data-proweb-title='"_..encodeForHTMLAttribute(floaterTitle)_"' data-proweb-id='"_prowebID_"' data-proweb-list-id='"_prowebListID_"'>"
		
	} else {
		write !,"<div class='row ef-proweb-form-row'>"	
	}
]]></Implementation>
</Method>

<Method name="getFloatingMenuHeader">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if ..%IsA("EF.ui.components.frontend.divider") {
		return "Divider"	
		
	} elseif ..%IsA("EF.ui.components.frontend.textBlock") {
		return "Text Block"
		
	} else {
		return ##class(sc.xModules.objCODitem).getCODItemName(..prowebItem.%Id())
	}
]]></Implementation>
</Method>

<Method name="renderCellOpening">
<Implementation><![CDATA[	write "<div class='col-sm-12 ",..encodeForHTMLAttribute(..getDependentClass()),"'>"
]]></Implementation>
</Method>

<Method name="renderCellClosing">
<Implementation><![CDATA[	write "</div>"
]]></Implementation>
</Method>

<Method name="renderRowClosing">
<Implementation><![CDATA[		write "</div>"
]]></Implementation>
</Method>

<Method name="getDependentClass">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if (..showHideDependencyList '= "") && (..contextData.prowebMode = "edit") {	
		return "ef-dependent-field"
	} else {
		return ""
	}
]]></Implementation>
</Method>

<Method name="getProwebExtraAttributes">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if ..contextData.prowebMode = "edit" {
		return ""
	} else {
		return ..getExtraAttributes()	
	}
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.radioButtons">
<Super>EF.ui.components.listInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64202,37247.377273</TimeChanged>
<TimeCreated>63356,39686.205586</TimeCreated>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Return ##super()_" btn-group "
]]></Implementation>
</Method>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.singleLineText</ReturnType>
<Implementation><![CDATA[	quit ##class(EF.validator.inList).%New()
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	&html<
            <div class="#(..encodeHTMLAttribute(..classes))#" id="#(..encodeHTMLAttribute(..htmlID))#" data-toggle="buttons" title="#(..encodeHTMLAttribute(..title))#" #(..rawHTML(..getExtraAttributes()))#>
	    		#[do ..renderAlternatives()]#
	        </div>
	        
	>
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>

<Method name="renderInputElementCellOpening">
<Implementation><![CDATA[	write "<div class=' col-sm-8 ef_proweb_form_prompt ef-proweb-radio-group'>"
]]></Implementation>
</Method>

<Method name="renderCellOpening">
<Implementation><![CDATA[	write "<div class='col-sm-12  ",..encodeForHTMLAttribute(..getDependentClass())," ef-proweb-radio-button'>"
]]></Implementation>
</Method>

<Method name="renderAlternative">
<FormalSpec>alternative:EF.ui.components.alternative</FormalSpec>
<Implementation><![CDATA[
	if $IsObject(..enableDisableDependencyList) {
		set alternative.enableDisableDependencyList=..enableDisableDependencyList	
	}
	do ..renderCellOpening()
	do alternative.addClass("ef-proweb-radio-button")
	do alternative.render()
	do ..renderCellClosing()
]]></Implementation>
</Method>

<Method name="addAlternative">
<FormalSpec>value,label,isDefault=0</FormalSpec>
<ReturnType>EF.ui.components.alternative</ReturnType>
<Implementation><![CDATA[
	set htmlID=..htmlID_"_"_(..alternatives.Count()+1)
	
	set radio=##class(EF.ui.components.radio).%New(htmlID)
	set radio.label=label
	set radio.value=value
	set radio.isDefault=isDefault
	set radio.htmlName=..htmlName
	do radio.addClass("btn")
	do radio.addClass("ef-btn-default")
	do ..alternatives.Insert(radio)
	// Also add to the validator
	do ..validator.addAllowedValue(value)
	return radio
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.textArea">
<Super>EF.ui.components.textInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64201,42513.017278</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Return "form-control ef-proweb-input-element"
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	&html<
    	    <textarea type="text" class="#(..encodeHTMLAttribute(..classes))#" #(..rawHTML(..getDisabledString()))# title="#(..encodeHTMLAttribute(..title))#" 
    	    id="#(..encodeHTMLAttribute(..htmlID))#" name="#(..encodeHTMLAttribute(..htmlName))#" placeholder="#(..encodeHTMLAttribute(..placeHolder))#" 
    	    #(..rawHTML(..getExtraAttributes()))#>#(..encodeHTMLContentForTextarea(..value))#</textArea>
    	
	>
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.textBlock">
<Super>EF.ui.components.frontend.prowebBase</Super>
<TimeChanged>64190,59092.755529</TimeChanged>
<TimeCreated>64183,38661.128484</TimeCreated>

<Property name="text">
<Type>%String</Type>
<Parameter name="MAXLEN" value="1000000"/>
</Property>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpening()
		do ..renderCellOpening()
			w "<div ",..rawHTML(..getProwebExtraAttributes()),">"
			write ..rawHTML(..text)
			w "</div>"
		do ..renderCellClosing()
	do ..renderRowClosing()
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.textInput">
<Super>EF.ui.components.textInput,EF.ui.components.frontend.inputElement</Super>
<TimeChanged>64201,49944.787362</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>text</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultClasses">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Return "form-control ef-proweb-input-element"
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	&html<
    	    <input type="#(..encodeHTMLAttribute(..#typeAttribute))#" class="#(..encodeHTMLAttribute(..classes))#" #(..rawHTML(..getDisabledString()))# 
    	    title="#(..encodeHTMLAttribute(..title))#" id="#(..encodeHTMLAttribute(..htmlID))#" name="#(..encodeHTMLAttribute(..htmlName))#" 
    	    value="#(..encodeHTMLAttribute(..value))#" placeholder="#(..encodeHTMLAttribute(..placeHolder))#"  #(..rawHTML(..getProwebExtraAttributes()))#>
    	
	>
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.timeInput">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64201,62853.575239</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>text</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>0</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[
	set validator = ##class(EF.validator.timeInput).%New()
	
	set timeFormat=##class(setup.objEventSetting).getParameter("system","time format", ..contextData.eventID)	
	if 'timeFormat set timeFormat=24
	set validator.timeFormat = timeFormat
	
	return validator
]]></Implementation>
</Method>

<Method name="render">
<Implementation><![CDATA[
	do ..renderRowOpeningAndLabel()
	set ..classes = ..classes_" efTimePicker "
	set timeFormat = ..validator.timeFormat
	set ..placeHolder = ##class(shared.timeFunctions).getFrontendInputTimePattern(timeFormat)
	&html<
    	    <div class="ef_proweb_form_field_container_type_time ef-proweb-input-element-short">
	    	    <input type="#(..encodeHTMLAttribute(..#typeAttribute))#" class="#(..encodeHTMLAttribute(..classes))#" #(..rawHTML(..getDisabledString()))# 
	    	    title="#(..encodeHTMLAttribute(..title))#" id="#(..encodeHTMLAttribute(..htmlID))#" name="#(..encodeHTMLAttribute(..htmlName))#" 
	    	    value="#(..encodeHTMLAttribute(..value))#" placeholder="#(..encodeHTMLAttribute(..placeHolder))#"  #(..rawHTML(..getProwebExtraAttributes()))#
	    	    efKendoTimeFormat="#(..encodeHTMLAttribute(timeFormat))#" efKendoTimeInterval=15>
			</div>
			   	
	>
	do ..renderHelpAndRowClosing()
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.frontend.webAddress">
<Super>EF.ui.components.frontend.textInput</Super>
<TimeChanged>64198,62864.573985</TimeChanged>
<TimeCreated>63357,57620.613738</TimeCreated>

<Parameter name="typeAttribute">
<Default>url</Default>
</Parameter>

<Parameter name="html5Validation">
<Default>1</Default>
</Parameter>

<Method name="getDefaultValidator">
<ReturnType>EF.validator.base</ReturnType>
<Implementation><![CDATA[	return ##class(EF.validator.webAddress).%New()
]]></Implementation>
</Method>
</Class>


<Class name="EF.ui.components.panel">
<Super>EF.ui.components.container</Super>
<TimeChanged>64204,36438.670197</TimeChanged>
<TimeCreated>63361,62973.538498</TimeCreated>

<Property name="heading">
<Type>%String</Type>
<Parameter name="MAXLEN" value="1000"/>
</Property>

<Property name="errorMessage">
<Type>%String</Type>
<Parameter name="MAXLEN" value="10000"/>
</Property>

<Method name="renderStart">
<Implementation><![CDATA[
	set classes="ef-admin-settings-panel"
	if $l(..errorMessage) {
		set classes=classes_" ef-panel-with-error"
	}
	&HTML<
		<div class="#(classes)#" id="#(..encodeHTMLAttribute(..htmlID))#">
            <div class="panel-heading">#(..encodeHTMLContent(..heading))#</div>
            	#[do ..renderErrorMessage()]#
	>
]]></Implementation>
</Method>

<Method name="renderEnd">
<Implementation><![CDATA[
	&HTML<
        </div>
	>
]]></Implementation>
</Method>

<Method name="renderErrorMessage">
<Implementation><![CDATA[
	if $l(..errorMessage) {
		&html<
			<div class="ef-panel-message-area">
				<div class="alert alert-danger ">#(..rawHTML(..errorMessage))#
	            </div>
	        </div>
		>
	}
]]></Implementation>
</Method>

<Method name="addErrorMessage">
<FormalSpec>errorMessage</FormalSpec>
<Implementation><![CDATA[
	if $l(..errorMessage) {
		set ..errorMessage=..errorMessage_..rawHTML("<br>")	
	}
	set ..errorMessage=..errorMessage_..encodeHTMLContent(errorMessage)
]]></Implementation>
</Method>
</Class>


<Class name="EF.validator.emailAddressMulti">
<Super>EF.validator.base</Super>
<TimeChanged>64201,61804.004963</TimeChanged>
<TimeCreated>63883,60398.119435</TimeCreated>

<Property name="regex">
<Type>%String</Type>
<InitialExpression>##class(EF.utils.dataValidation).getValidationPatternForDataType("multiEmailAddress")</InitialExpression>
</Property>
</Class>


<Class name="EF.validator.phoneNumber">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.validator.integer.CLS/EV.3
;vc; Component: CLS.EF.validator.integer
;vc;  Location: LargeDev
;vc; Date/Time: 07-Mar-16 16:09
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.validator.integer.CLS/EV.3</td><td>CLS.EF.validator.integer</td><td>LargeDev</td><td style='white-space: nowrap;'>07-Mar-16 16:09</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.validator.base</Super>
<TimeChanged>64198,63518.953556</TimeChanged>
<TimeCreated>63364,34365.891052</TimeCreated>

<Method name="getRegex">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ##class(EF.utils.dataValidation).getValidationPatternForDataType("phoneNumber")
]]></Implementation>
</Method>
</Class>


<Class name="EF.validator.phoneNumberTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64197,43397.465718</TimeChanged>
<TimeCreated>63375,58376.236052</TimeCreated>

<Method name="TestisInputValid">
<Implementation><![CDATA[
	set validator=##class(phoneNumber).%New()
	do $$$AssertTrue(validator.isInputValid("02076883233"))
	do $$$AssertTrue(validator.isInputValid("+44 77 40 9444 80"))
	do $$$AssertTrue(validator.isInputValid("+44 (0) 77 40 9444 80"))
	do $$$AssertTrue(validator.isInputValid("0044 (0) 77 40 9444 80"))
	do $$$AssertTrue(validator.isInputValid("12 14 66"))
	do $$$AssertNotTrue(validator.isInputValid("a"))
	do $$$AssertNotTrue(validator.isInputValid("020 76 78 23 12 Ext 777"))
	do $$$AssertNotTrue(validator.isInputValid("020 76 78 23 12 Ext. 777"))
	do $$$AssertTrue(validator.isInputValid("020-76 78 23 12 "))
	do $$$AssertTrue(validator.isInputValid(""))
	set validator.isMandatory=1
	do $$$AssertNotTrue(validator.isInputValid(""))
]]></Implementation>
</Method>

<Method name="TestgetErrorMessage">
<Implementation><![CDATA[	do $$$AssertNotEquals(##class(phoneNumber).%New().getErrorMessage(),"")
]]></Implementation>
</Method>

<Method name="TestGetRegEx">
<Implementation><![CDATA[
	set validator=##class(phoneNumber).%New()
	do $$$AssertEquals(validator.getRegex(),"^(?!(.*-(\s)*-.*))(?!(.*\.(\s)*\..*))(?=.*[\d\)](\s)*$)(?=.*(\d)+.*)(\+(\d){1,3}){0,1}(?=\s*([\d\(]).*)(([\d\s\-\.])|(\(([\d\-\.\s])+\)))*(\s)*$")
]]></Implementation>
</Method>

<Method name="TestgetValidatorObject">
<Implementation><![CDATA[
	try {
		set validator=##class(base).getValidatorObject("phoneNumber")
	} catch {
		set validator=""
	}
	do $$$AssertTrue(($IsObject(validator))&&(validator.%IsA("EF.validator.phoneNumber")))
]]></Implementation>
</Method>
</Class>


<Class name="EF.validator.webAddress">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: EF.validator.integer.CLS/EV.3
;vc; Component: CLS.EF.validator.integer
;vc;  Location: LargeDev
;vc; Date/Time: 07-Mar-16 16:09
;vc;      User: AdrianM2
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>EF.validator.integer.CLS/EV.3</td><td>CLS.EF.validator.integer</td><td>LargeDev</td><td style='white-space: nowrap;'>07-Mar-16 16:09</td><td>AdrianM2</td></tr></table>
]]></Description>
<Super>EF.validator.base</Super>
<TimeChanged>64198,63556.464934</TimeChanged>
<TimeCreated>63364,34365.891052</TimeCreated>

<Method name="getRegex">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ##class(EF.utils.dataValidation).getValidationPatternForDataType("webAddress")
]]></Implementation>
</Method>
</Class>


<Class name="EF.validator.webAddressTestCase">
<Super>EF.ISC.UnitTest.TestCase</Super>
<TimeChanged>64198,63839.009025</TimeChanged>
<TimeCreated>63375,58376.236052</TimeCreated>

<Method name="TestisInputValid">
<Implementation><![CDATA[
	set validator=##class(webAddress).%New()

	do $$$AssertTrue(validator.isInputValid("http://www.bbc.com"))
	do $$$AssertTrue(validator.isInputValid("http://www.bbc.com/myparam=666"))
	do $$$AssertTrue(validator.isInputValid("http://www.bbc.com/myparam=666&something=else"))

	do $$$AssertTrue(validator.isInputValid("https://www.bbc.com"))
	do $$$AssertTrue(validator.isInputValid("https://www.bbc.com/myparam=666"))
	do $$$AssertTrue(validator.isInputValid("https://www.bbc.com/myparam=666&something=else"))

	do $$$AssertTrue(validator.isInputValid("www.bbc.com/myparam=666&something=else"))
	do $$$AssertTrue(validator.isInputValid("www.bbc.com/myparam=666"))
	do $$$AssertTrue(validator.isInputValid("www.bbc.com/myparam=666&something=else"))

	do $$$AssertNotTrue(validator.isInputValid("fish"))
	do $$$AssertNotTrue(validator.isInputValid("1234123"))
	do $$$AssertTrue(validator.isInputValid("www.bbc.com"))

	do $$$AssertNotTrue(validator.isInputValid("hxtp://www.bbc.com"))
	do $$$AssertNotTrue(validator.isInputValid("xhttp://www.bbc.com/myparam=666"))
	do $$$AssertNotTrue(validator.isInputValid("htxtp://www.bbc.com/myparam=666&something=else"))


	set validator.isMandatory=1
	do $$$AssertNotTrue(validator.isInputValid(""))
]]></Implementation>
</Method>

<Method name="TestgetErrorMessage">
<Implementation><![CDATA[	do $$$AssertNotEquals(##class(webAddress).%New().getErrorMessage(),"")
]]></Implementation>
</Method>

<Method name="TestGetRegEx">
<Implementation><![CDATA[
	set validator=##class(webAddress).%New()
	do $$$AssertEquals(validator.getRegex(),"^(?:https?:\/\/)?(?:\S+(?::\S*)?@)?(?:(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/.*)?$")
]]></Implementation>
</Method>

<Method name="TestgetValidatorObject">
<Implementation><![CDATA[
	try {
		set validator=##class(base).getValidatorObject("webAddress")
	} catch {
		set validator=""
	}
	do $$$AssertTrue(($IsObject(validator))&&(validator.%IsA("EF.validator.webAddress")))
]]></Implementation>
</Method>
</Class>


<CSP name="backEnd/proweb/codQuestionDetails.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<csp:include page="../../backend/home/backendTop.csp?hideBackendMenu=1&kendoweb=1">


<script language="cache" runat="server">
	set showListText=..out("See List")
	set hideListText=..out("Hide List")
</script> 

<script language="javascript">
	function toggleUsedInEventsListVisibility () {
		var divstyle = new String();
		divstyle = document.getElementById('usedInEventsList').style.display;
		if (divstyle.toLowerCase()=='block' || divstyle == '') {
			document.getElementById('usedInEventsList').style.display = 'none';
			document.getElementById('showHideText').innerHTML = '#(showListText)#';
		} else {
			document.getElementById('usedInEventsList').style.display = 'block';
			document.getElementById('showHideText').innerHTML = '#(hideListText)#';
		}
	}
</script>


<script language="cache" runat="server">
	set itemNameID=%request.Get("itemNameID")
	if itemNameID="" set itemNameID=%session.Get("itemNameID")

	set dataID=%request.Get("dataID")
	
	set pageID=##class(sc.codItemMethods).getPageID(dataID)
	if 'pageID {
		set pageID=%request.Get("pageID")
	}
	if 'pageID {
		throw ##class(shared.exceptions.generalException).%New("No pageID")	
	}
	
	do ##class(sc.methods).updateBackendVariablesFromPageID(pageID)
	
	do ##class(EF.pages.frontend.baseProweb).savePassedInDesiredPositionToSession()

	set groupID=##class(sc.objData).getParentID(pageID)
	
	// switch to the org data to enable edit when having multi-stage workflow
	// but we can't do it for single workflow because the it will stop adding new ones in EF
	if ##class(sc.objStep).getFinalLevel()>1 {
		if %request.Get("orgDataID") set dataID=%request.Get("orgDataID")
	}

	set templateURL=%request.Get("templateURL")
	if templateURL="" set templateURL=%session.Get("templateURL")
	set %session.Data("templateURL")=templateURL

	set parent=%request.Get("parent")
	if parent="" set parent=%session.Get("parent")
	set %session.Data("parent")=parent

	set isDOC=%request.Get("isDOC")
	if isDOC="" set isDOC=$G(%session.Data("proweb","isDOC"))
	set %session.Data("proweb","isDOC")=isDOC

	set isForm=%request.Get("isForm") // used for proweb only form fills
	if isForm="" set isForm=$G(%session.Data("proweb","isForm"))
	set %session.Data("proweb","isForm")=isForm

	// are we doing an eventsforce style survey
	set isSurvey=0
	set surveyID=""
	set grandParent=##class(sc.objData).getParentID(groupID)
	&SQL(SELECT description INTO :tmp FROM sc_xModules.objGroup WHERE ID = :grandParent)
	if +SQLCODE=0,$ZCVT(tmp,"U")="SURVEYS" 
	{	
		set isSurvey=1
		set surveyID = groupID
	}
 	
	set addToTop=%request.Get("addToTop")
	if addToTop="" set addToTop=%session.Get("addToTop")
	set %session.Data("addToTop")=addToTop

	kill %session.Data("eventsforce","backend","gotoPage")
	set gotoPage=%request.Get("gotoPage")
	set %session.Data("eventsforce","backend","cod question gotoPage")=gotoPage

	set additional=%request.Get("additional")
	if (additional="")&(dataID) {
		set additional=##class(sc.xModules.objCODitem).isABI(dataID)
	}
	set %session.Data("eventsforce","backend","additional")=additional

	// is this a ticketing question?
	set quantityItem=%request.Get("quantityItem")
	if (quantityItem="")&(dataID) {
		// find out if we are dealing with a ticketing type of item or not when editing a prompt
		&SQL(SELECT isQuantityItem INTO :tmp FROM sc_xModules.objCODitem WHERE ID = :dataID)
		if +SQLCODE=0 set quantityItem=tmp
	}
	set %session.Data("eventsforce","backend","quantityItem")=quantityItem
	
	set xWorkLangID=%request.Get("xWorkLangID")
	if xWorkLangID="" set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if xWorkLangID="" set xWorkLangID=$G(xLangID,1)

	set inBookersPage=##class(sc.xModules.objPage).isBookerPage(pageID)
	set isAwardsEntryPage=##class(sc.xModules.objPage).isAwardsEntryPage(pageID)
	set inAbsDocPage=##class(sc.xModules.objPage).isAbstractDocumentPage(pageID)
 	Set inAbsSignupPage=##class(sc.xModules.objPage).isAbstractSignUpPage(pageID)
 	
 	set isAbstractPage=0
 	if (inAbsDocPage||inAbsSignupPage) set isAbstractPage=1

	set eventHotelID=%request.Get("eventHotelID")
	
 	Set isAccomPage=0
 	if ($ZCVT(templateURL,"L")["taccom") set isAccomPage=1
	

 	Set isMeetManPage=0
 	if ($ZCVT(templateURL,"L")["tmeetman") set isMeetManPage=1
 	

	// display the price info?
	set hasPricing=##class(setup.objEventSetting).getParameter("event setup","has pricing",xEventID)

	kill %session.Data("proweb","codGroup")
	set codGroup=%request.Get("codGroup")
	set %session.Data("proweb","codGroup")=codGroup

	if $G(%session.Data("proweb","backend","errMsg"))'="" {
		write "<scri"_"pt language='javas"_"cript'>alert("_..QuoteJS(%session.Data("proweb","backend","errMsg"))_");</scri"_"pt>"
		kill %session.Data("proweb","backend","errMsg")
	}
	set meetingsEnabled=##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID)
	set eventAllowsGroupBookings=##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)
	
	set isAnonymousMode=+##class(setup.objEventSetting).getParameter("system","do not use email",xEventID)
	set allowSingleEventQuestions=##class(cod.methods).areSingleEventQuestionsAllowedForPageID(pageID)
	
	set baseURL="../../backend/proweb/codQuestionDetails.csp?dataID="_..encodeForURL(dataID)_"&pageID="_..encodeForURL(pageID)_"&additional="_..encodeForURL(additional)_"&quantityItem="_..encodeForURL(quantityItem)
	set linkedBaseURL=..Link(baseURL)
	set loadItemURL=baseURL_"&loadItem=true"
	set linkedLoadItemURL=..Link(loadItemURL)
</script>
<script type="text/javascript">

function ajaxFunction(inPhrase)
  {
  var xmlHttp;
  try
    {
    // Firefox, Opera 8.0+, Safari
    xmlHttp=new XMLHttpRequest();
    }
  catch (e)
    {
    // Internet Explorer
    try
      {
      xmlHttp=new ActiveXObject("Msxml2.XMLHTTP");
      }
    catch (e)
      {
      try
        {
        xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");
        }
      catch (e)
        {
        alert('#(..out("Your browser does not support this function."))#');
        return false;
        }
      }
    }
    xmlHttp.onreadystatechange=function()
      {
      if(xmlHttp.readyState==4)
        {
			res=document.getElementById('divR_all');
			res.innerHTML=xmlHttp.responseText;
			res.style.visibility="visible";
        }
      }
    xmlHttp.open("GET","#(..Link("codQuestionLookup.csp?zz=1"))#&eventID=#(xEventID)#&phrase=" + escape(inPhrase),true);
    xmlHttp.send(null);
}

function CheckAndGet(ele,languageID,mode)	{
	res=document.getElementById('divR_all');
	res.style.visibility="visible";
	res.innerHTML='<p class="blackbold10px">Searching...</p>';

	ok = ajaxFunction(ele.value,languageID,mode); // the entered phrase
}
function checkPercent() {
	var txtPromptWidth = document.getElementById('idPromptWidth');
	var txtWidthValue = txtPromptWidth.value;
	var strLength = txtWidthValue.length;
  	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = txtWidthValue.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || txtWidthValue.indexOf(' ') >= 0)		{
				alert ("#(..out("Only numeric value (0-100) is accepted for 'Prompt Width'. \nPlease try again."))#");
				txtPromptWidth.style.background = "yellow";
				return false;
			}
		}
  	}

	if ((strLength > 0) && ((parseFloat(txtWidthValue)>100.0) || (parseFloat(txtWidthValue) <0.0))) {
		alert ("#(..out("Value for the 'Prompt Width' field is limited between 0 to 100. \nPlease try again."))#");
		txtPromptWidth.value = "";
		txtPromptWidth.style.background = "yellow";
		return false;
	}
	return true;
}
function checkSubmit($form) {
	if (!checkName()) return false;
	if (!checkPercent()) return false;
	if (!ef.codQuestionDetails.checkNumericValues()) return false;
	if (!isValidRangeAvailability()) return false;
	
	var alternativesToBeDeleted = $("#txtDeletedAlternatives").val();
	if (alternativesToBeDeleted !== "") {
		$.ajax({
        	type: "POST",
			url: "#(..encodeForJavaScript(##class(shared.pCSP).Link("codItemAlternativesCheckUsageJSON.csp")))#",
			dataType: "json",
			data: {"itemAlternativeIDs" : alternativesToBeDeleted },
			success: function(obj) {
				if (obj.isUsed == 1) {
					ef.admin.confirm("One or more of the alternatives you would like to delete are in use. Are you sure you want to delete them?",
						function(ok){
							if (ok) {
								$form.get(0).submit();
							}
						}
					);

				} else {
					$form.get(0).submit();
				}
			}
		});
		return false;
	}
	return true;
}
function loadItem(itemNameID) {
	document.location = "#(..encodeForJavaScript(linkedLoadItemURL))#" + "&itemNameID=" + encodeURIComponent(itemNameID);
}
</script>
<csp:object name="objCODitem" classname="sc.xModules.objCODitem" objid="#(dataID)#">

<script language="cache" runat="server">
	// Get the itemNameID from the the proweb object if we are editing
	if dataID set itemNameID=objCODitem.objItemName.%Id()
</script>

<csp:object name="objItemName" classname="cod.objItemName" objid="#(itemNameID)#">

<script language="cache" runat="server">
	set (description,prompt,type,fieldWidth,fieldHeight,helpText,mandatory,isDelegate,isGuest,backendOnly,carryOver,requiredAnswer,validationErrorMessage,reportDescription,layout,maxCharacters,maxWords,multiCheckboxMin,multiCheckboxMax,noAmendments,defaultValue,concealed,systemItem)=""
	set reportOn=1
	set readonlyFrontend=0

	// get the data from COD
	if itemNameID {
		set description=objItemName.description
		//get the translated version of description by default when itemNameID<20
		if itemNameID<20 {
			set prompt = ##class(translations.objPhraseWebsite).translatePhrase(description,xWorkLangID,"","","","")
		} else {
			set prompt = description
		}
		
		set type=objItemName.type
		set helpText=objItemName.helpText
		set carryOver=objItemName.carryOver
		set concealed=objItemName.concealed
		set systemItem=objItemName.systemItem
	}

	if quantityItem {
		set fieldWidth=45
	}

	// get the data from proweb
	if dataID {
		set prompt=##class(sc.xModules.objCODitem).getQuestPrompt(dataID,xWorkLangID)
		set reportDescription=objCODitem.reportDescription
		set fieldWidth=objCODitem.fieldWidth
		set fieldHeight=objCODitem.fieldHeight
		set type=objCODitem.type
		set layout=objCODitem.layout
		set helpText=objCODitem.helpText
		set mandatory=objCODitem.mandatory
		set backendOnly=objCODitem.backendOnly
		set isDelegate=objCODitem.isDelegate
		set isGuest=objCODitem.isGuest
		set reportOn=objCODitem.reportOn
		set readonlyFrontend=+objCODitem.readonlyFrontend
		set courseID=objCODitem.courseID
		set requiredAnswer=objCODitem.requiredAnswer
		set validationErrorMessage=objCODitem.validationErrorMessage
		set maxCharacters=objCODitem.maxCharacters
		set maxWords=objCODitem.maxWords
		set multiCheckboxMin=objCODitem.minAltsChecked
		set multiCheckboxMax=objCODitem.maxAltsChecked
		set noAmendments=objCODitem.noAmendments
		set defaultValue=objCODitem.defaultValue
		do objCODitem.%Close()
	}
	set showGuest=0
	set notShowGuestExplanation=""
	if ##class(setup.objSetting).getParameter("bookings","use guests") {
		if ##class(sc.xModules.objPage).isRegistrationPage(pageID) {
			set showGuest=1
		}
	}
	// if other pages (within same category) have guest prompts, don't allow a guest prompt to be added to this page
	// (unless the item being edited is a guest prompt already
	if (showGuest && ('##class(sc.methods).canPageHaveGuestCODItems(pageID)) && '(isGuest)) {
		set showGuest=0
		set notShowGuestExplanation=..out("Guest prompts may not be used on multiple pages for this attendee category")
	}
	
	set hasAnyDependencies=0
	if $l(##class(sc.xModules.objCODitem).findDependentQuestions(dataID)) set hasAnyDependencies=1
	if $l(##class(sc.xModules.objCODitem).findDependentTextBlocks(dataID)) set hasAnyDependencies=1
	if hasAnyDependencies {
		set showGuest=0
		set notShowGuestExplanation=..out("You cannot change attendee or guest as there are items dependent on this question")
	}
	
	kill allRegPages,allRegPageIDs,allReg
	set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xWorkLangID,1,.allRegPages,.allRegPageIDs,.allReg)
	
	// Check whether there is any data associated with this cod item (for any event)
	set hasDataForAnyEvent=0
	&SQL(SELECT ID
		FROM cod.objItemData
		WHERE objItemName=:itemNameID
		AND (result IS NOT NULL) AND (result <> '')
	)
	if +SQLCODE=0 {
		set hasDataForAnyEvent=1
	}
	
	set canChangeAnswerAppliesTo=0
	
</script>



<form name="myform" method="post" action="codQuestionDetails2.csp" onSubmit="selectAll(); return checkSubmit($(this));">
<div class="topsave_in_popup">
	<script language="cache" runat="server">
		set backPage="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))
		if gotoPage'="" set backPage=gotoPage
		set backPage=backPage_$S(backPage["?":"&",1:"?")_"mode=edit"
	</script>
	<a href="#(backPage)#"><img src="../../media/images/English/Default/backend/cancel.gif" alt="#" width="65" height="17" border="0"></a></td>
	<input type="image" src="../../media/images/English/Default/backend/save.gif" border="0" alt="Save" width="65" height="17">
</div>
<br><br>

<table width="800" border="0" cellspacing="0" cellpadding="0" >
<tr>
         <td>
             <table width="800" border="0" cellspacing="0" cellpadding="0">
                 <tr>
                     <td colspan="3" class="gen1_panel_border" height="1"><img src="../../media/images/english/default/backend/buffer.gif" width="1" height="1"></td>
                 </tr>
                 <tr>
                     <td class="gen1_panel_border" width="1"><img src="../../media/images/english/default/backend/buffer.gif" width="1" height="1"></td>
                     <td>
                         <table width="800" border="0" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" align="left">
                             <tr >
                             	<td class="gen1_panel_header">
								 	<csp:if condition=(additional)>
										<tx>Bookable Item Details</tx>
									<csp:elseif condition=(quantityItem)>
										<tx>Quantity Bookable Item Details</tx>
									<csp:else>
										<tx>Registration Question Details</tx>
									</csp:if>
                             </tr>
							<tr class="gen1_panel_subheader">
								<td height=16></td>
							</tr>	
                             <tr>
                                 <td valign="top" align="left">
					<table width="100%" border="0" cellspacing="0" cellpadding="0">
	 		            <tr>
						<td align="left" valign="top" >
						<csp:if condition=(+itemNameID=0)>
							<table border="0" width="100%" cellspacing="0" cellpadding="0">
								<tr class="gen1_panel_subheader">
									<td width="200" height="30" align="right" nowrap class="black10px" valign="top" style="padding-top: 4px; padding-bottom: 8px;"><tx>Search database items</tx>:&nbsp;&nbsp;</td>
									<td height="30">
										<table width="100%" border="0" cellspacing="0" cellpadding="0">
											<tr>
												<td valign="top" width="45%">
													<systemType:if module="Search existing items">
														<input type="text" id="lookup_phrase" name="lookup_phrase" value=" ---#(..out("Type to Search"))#---" class="black10px" style="width:282px;" onFocus="this.value=''" onkeyup="CheckAndGet(this);">
													</systemType:if>
													<script language="cache" runat="server">
														kill alreadyUsedQuestions
														do ##class(cod.methods).loadUsedQuestions(pageID,surveyID,%session.Get("eventCategoryID"),.alreadyUsedQuestions,.allRegPageIDs)
													</script>
													<ef-select id="selCODitem" name="selCODitem" class="black10px ef-select-on-change-redirect" style="width: 300px;" data-link-url="#(loadItemURL)#" data-redirect-param-name="itemNameID">
														<option selected>---<tx>Select from list</tx>---</option>
														<csp:query name="rs" classname="cod.objItemName" queryname="qItemsRegPages" P1="#(xEventID)#">
														<csp:while condition="rs.Next()">
															<script language="cache" runat="server">
																 set showItem=1
																 set tmpItemID=rs.Get("ID")
																 
																 set highlightItem=0,highlightDesc=""   // so that we show prompts that have been used by highlight what it's used for (so guest prompts can be added)
																 
																 if (isForm)!(isDOC),'isSurvey { // regular page types
																 
																 	// hide prompts already used in this page or in any other pages within the same page
																	if $Data(alreadyUsedQuestions(tmpItemID)) {
																		set showItem=0
																	}
																	
																 } elseif eventHotelID	{  
																 	// alway show if we are in a hotel page
																 	set showItem=0
																	if eventHotelID=rs.Get("eventHotelID") set showItem=1
																	
																 } else { // surveys, abstracts and such peripheral page types
																 	
																 	// exclude all hotel prompts
																 	if rs.Get("eventHotelID") set showItem=0

																	if showItem	{
																		// check all pages if attendee category
																		if 'isSurvey,##class(setup.objSetting).getParameter("system","isEventsForce"),%session.Get("eventCategoryID")	{ // if we have come from regPages.csp
																			if $Data(alreadyUsedQuestions(tmpItemID)) {
																					set showItem=1
																					set highlightItem=1,highlightDesc="Already Used: "
																			}
																			
																		} else {
																			if isSurvey {
																				// surveys
																				if $Data(alreadyUsedQuestions(tmpItemID)) {
																					set showItem=1
																					set highlightItem=1,highlightDesc="Already Used: "
																				}
																				if '##class(cod.methods).isCodTypeAllowedForRegPageType("surveys",rs.Get("type")) set showItem=0
																			} else {
																				// all other types
																				if $Data(alreadyUsedQuestions(tmpItemID)) {
																			 		// we need to allow same item to be added for authors/co-authors
																					// abstracts allowed																					
																					if 'inAbsDocPage {
																						set showItem=0
																					} else {
																						set highlightItem=1,highlightDesc="Already Used: "
																					}
																				}
																			}
																			
																		}
																	}
																	
																	// only show radios and dropdowns when doing ABIs //that are not event spanning. Shahadat 31Dec09
																	if additional {
																		if ("radiobutton,dropdown,multibox"'[rs.Get("type"))!(rs.Get("carryOver")'=0) set showItem=0 // also multicheck - fred ja 2010
																	}

																	// only show text field when doing Quantity booking items //that are not event spanning. Shahadat 31Dec09
																	if quantityItem {
																		if (rs.Get("type")'="text") ! (+rs.Get("carryOver")'=0) set showItem=0
																	}

																}
																
																if 'allowSingleEventQuestions {
																	if rs.Get("isQuestionForSingleEvent") set showItem=0
																}

																if isAwardsEntryPage {
																	if '##class(cod.methods).isCodTypeAllowedForRegPageType("awards",rs.Get("type")) set showItem=0
																}
																if isAbstractPage {
																	if '##class(cod.methods).isCodTypeAllowedForRegPageType("abstracts",rs.Get("type")) set showItem=0
																}
																if isMeetManPage {
																	if '##class(cod.methods).isCodTypeAllowedForRegPageType("meetman",rs.Get("type")) set showItem=0
																}
																if isAccomPage {
																	if '##class(cod.methods).isCodTypeAllowedForRegPageType("accommodation",rs.Get("type")) set showItem=0
																}																
																// exclude the email field IN EF
																if $ZCVT(rs.Data("description"),"L")="email" set showItem=0

																// abstracts signup page needs to have the real email address on there
																if $ZCVT(rs.Data("description"),"L")="email",inAbsSignupPage set showItem=1

																 set tmpDescription=rs.Data("description")

																 if $G(%session.Data("templateURL"))["tAdditionalRegistration.csp" {
																 	 &SQL(SELECT description INTO :pageName FROM sc_xModules.objPage WHERE ID = :pageID)

																	 // filter out the normal prompts  if we are doing additional registration pages
																	 if tmpDescription'[pageName_"|" set showItem=0
																	 
																	 // remove page name if we are doing additional registration pages
																	 if tmpDescription["|" set tmpDescription=$p(tmpDescription,"|",2)
																}
																// v2.7 - highlight already used items rather than hide them so guest prompts can be added and so it's clearer what's going on
																set optionClass=""
																if highlightItem	{
																	set optionClass="redbold10px"
																	set tmpDescription=highlightDesc_tmpDescription
																}

																// v.2.7 hide non-spanning items if we are doing eventsforce style surveys
																if isSurvey {
																	set tmpItemNameID=rs.Data("ID")
																	&SQL(SELECT carryOver INTO :tmp FROM cod.objItemName WHERE ID = :tmpItemNameID)
																	if +SQLCODE=0,+tmp'=1 set showItem=0
																}

																// only show meeting manager items in meeting manager pages
																if codGroup="meetMan" {
																	if rs.Get("codGroup")'="meetMan" {
																		set showItem=0
																	}
																} else {
																	if rs.Get("codGroup")="meetMan" set showItem=0
																}

															</script>
															<csp:if condition=(showItem=1)>
																<option value='#(rs.Data("ID"))#' class="#(optionClass)#">#(tmpDescription)#</option>
															</csp:if>
														</csp:while>
													</ef-select>



	                                               </td>
													<td align="left">&nbsp;<a href="javascript: gotoNewItem();"><img name="butCreateNew" id="butCreateNew" src="../../media/images/English/Default/backend/add.gif" border="0" alt="" width="65" height="17"></a></td>
											</tr>
											<script language="cache" runat="server">
													set newItemLinkURL=..Link(baseURL_"&itemNameID=CREATE"_"&eventHotelID="_..encodeForURL(eventHotelID)_"&codGroup="_..encodeForURL(codGroup))
											</script>
											<script language="javascript">
											function gotoNewItem() {
												var newName= document.forms[0].lookup_phrase.value;
												var nameLength = newName.length;
												if(ef.codQuestionDetails.anyInvalidCharactersInName(newName) && (nameLength>0)){
													alert('Only letters, numbers, underscores and spaces are allowed for the database name. Please try again.');
													document.forms[0].lookup_phrase.focus();
												} else {
													document.location= ef.addParameterToURL("#(..encodeForJavaScript(newItemLinkURL))#","typedText",$("#lookup_phrase").val());
												}
											}
											</script>
										</table>
									</td>
								</tr>
					             <tr>
								 	<td colspan=99>
										<div id="divR_all" class="UnderTextField"></div>
									</td>
								 </tr>
								<tr>
									<td colspan="3" height="30"><img src="../../media/images/English/Default/backend/line.gif" width="600" height="21"></td>
								</tr>
							</table>
						</csp:if>
						<table width="100%" border="0" cellspacing="0" cellpadding="0">
							<tr>
								<td width="13">&nbsp;</td>
								<td class="black10px" align="right" height="15" width="184"><tx>Database name</tx>:&nbsp;*&nbsp;</td>
								<td class="black10px" valign="top">
									<table border=0 cellpadding=0>
										<tr>
											<td class="black10px">
												<input type="text" name="txtDescription" maxlength="44" class="black10px" value="#(description)#" onchange="if (document.forms[0].txtPrompt.value.length <2) {document.forms[0].txtPrompt.value=this.value;}" disabled style="background-color: #eeeeee; width: 285px; padding-left: 4px;">
											</td>
											<script language="cache" runat="server">
												set show=1
												if isAwardsEntryPage set show=0 // Awards entry scree
												if '##class(setup.objSystemTypes).isModuleAllowed("Concealed Data Items - TFI") set show=0
											</script>
											<csp:if condition=(show)>
												<td>&nbsp;&nbsp;
													<script language="cache" runat="server">
														set show=1
														if hasDataForAnyEvent {
															set show=0
															set reason=..out("You cannot change the concealed setting because this item has data")
														}
														if systemItem {
															set show=0
															set reason=..out("You cannot change a system item to have concealed data")
														}
													</script>
													<csp:if condition=(show)>
														<input id="chkConcealed" type="checkbox" name="chkConcealed" value="1" class="black10px" #($S(concealed=1:"checked",1:0))#>
													<csp:else>
														<csp:if condition=(concealed)>
															<img src="../../media/images/English/Default/backend/tick.gif" alt="YES" title="#(reason)#" width="14" height="12" border="0">
														<csp:else>
															<img src="../../media/images/English/Default/backend/cross.gif" alt="NO" title="#(reason)#" width="14" height="12" border="0">
														</csp:if>
														<input type="hidden" name="chkConcealed" value="#(+concealed)#">
													</csp:if>
												</td>
												<td class="black10px">
													<tx>Concealed database item</tx>
												</td>
											<csp:else>
												<csp:comment><!--Keep the setting so that concealed data doesn't show when switched off --></csp:comment>
												<input type="hidden" name="chkConcealed" value="#(+concealed)#">
											</csp:if>
										</tr>
									</table>
                                </td>
                                <td class="black10px" valign="top" colspan="3" width="120" align="left">
                                	<script language="cache" runat="server">
										set show=0
										if ##class(setup.objSystemTypes).isModuleAllowed("Registration prompt collections") set show=1
										set codCollectionDetailsURL="codQuestionCollectionDetails.csp?codID="_..encodeForURL(itemNameID)_"&returnURL="_..encodeForURL(baseURL)
									</script>
									 <csp:if condition=(show)>
										<csp:if condition=(dataID)>
											<ef-a href="#(codCollectionDetailsURL)#"><img src="../../media/images/English/Default/backend/collections.gif" border="0" alt="Registration question collections" width="85" height="17"></ef-a>
										<csp:else>
											<img src="../../media/images/English/Default/backend/collections.gif" border="0" alt="Registration question collections" style="filter: alpha(opacity=35); opacity: 0.35;"   width="85" height="17" title="Registration question collections is only available after you have saved the question prompt">
										</csp:if>
									 </csp:if>
                                </td>
							</tr>
							<tr>
								<td width="13" height="33">&nbsp;</td>
								<td class="black10px" align="right" valign="top"><tx>Question text</tx>:&nbsp;</td>
								<td class="black10px" colspan="3" style="padding-left: 2px;">
									<textarea name="txtPrompt" class="black10px" style="width: 292px; height: 40px; padding-left: 4px; padding-top: 4px;">#(..encodeHTMLContentForTinyMCETextarea(prompt))#</textarea>
								</td><td valign="top">
									<csp:if condition=((itemNameID="NEW")!(itemNameID="CREATE"))>
										<img src="../../media/images/English/Default/backend/advanced.gif" alt="advanced"  border="0" style="filter: alpha(opacity=35); opacity: 0.35;" title="You must save the database item before you can edit the question text.">
									<csp:else>
										<a href="javascript: popup('question');"><img src="../../media/images/English/Default/backend/advanced.gif" alt="advanced" border="0"></a>
									</csp:if>
								</td>
							</tr>

							<csp:if condition=('isSurvey)>
								<tr>
									<td colspan=1></td>
									<td class="black10px" align="right" style="padding-top: 8px;">
										<tx>Question</tx>:&nbsp;
									</td>
									<script language="cache" runat="server">
										set canChangeQuestionAvailability=1
										set questionAvailability="singleEvent"
										if itemNameID {
											set canChangeQuestionAvailability=0
											if '##class(cod.objItemName).isSingleEventQuestion(itemNameID) set questionAvailability="allEvents"
										} else {
											if 'allowSingleEventQuestions {
												set canChangeQuestionAvailability=0
												set questionAvailability="allEvents"
											}
										}
									</script>
									<td class="black10px" style="padding-top: 8px;">
										<script language="cache" runat="server">
											set isRadioChecked=(questionAvailability="singleEvent")
											
											set isRadioEnabled=0
											if canChangeQuestionAvailability set isRadioEnabled=1
											if isRadioChecked set isRadioEnabled=1
										</script>
										<input type="radio" name="radQuestionAvailability" id="radQuestionAvailabilitySingleEvent" value="singleEvent" #($S(isRadioChecked:"checked",1:""))# #($S(isRadioEnabled:"",1:"disabled"))#>
										<tx>Available to this event only</tx>
									</td>
								</tr>
								<tr>
									<td colspan=2></td>				
									<td class="black10px">
										<script language="cache" runat="server">
											set isRadioChecked=(questionAvailability="allEvents")
											
											set isRadioEnabled=0
											if canChangeQuestionAvailability set isRadioEnabled=1
											if isRadioChecked set isRadioEnabled=1
										</script>
										<input type="radio" name="radQuestionAvailability" id="radQuestionAvailabilityAllEvents" value="allEvents" #($S(isRadioChecked:"checked",1:""))# #($S(isRadioEnabled:"",1:"disabled"))#>
										<tx>Available to all events</tx>
									</td>
								</tr>
								<script language="cache" runat="server">
									set canChangeAnswerAppliesTo=1
									set answerAppliesTo="singleEvent"
									if itemNameID {
										if carryOver set answerAppliesTo="allEvents"
										set canChangeAnswerAppliesTo=0
									} else {
										if isAnonymousMode set canChangeAnswerAppliesTo=0
										if quantityItem set canChangeAnswerAppliesTo=0
										if additional set canChangeAnswerAppliesTo=0
									}
								</script>
								<tr >
									<td colspan=1></td>
									<td class="black10px" align="right" style="padding-top: 8px;">
										<tx>Answers</tx>:&nbsp;
									</td>
									<script language="cache" runat="server">
										set isRadioChecked=(answerAppliesTo="singleEvent")
										
										set isRadioEnabled=0
										if canChangeAnswerAppliesTo set isRadioEnabled=1
										if isRadioChecked set isRadioEnabled=1
									</script>
									<td class="black10px"  style="padding-top: 8px;">
										<input type="radio" name="radAnswerAppliesTo" id="radAnswerAppliesToSingleEvent" value="singleEvent" #($S(isRadioChecked:"checked",1:""))# #($S(isRadioEnabled:"",1:"disabled"))#>
										<tx>Apply to this event only</tx>
									</td>
								</tr>
								<tr>
									<td colspan=2></td>	
									<script language="cache" runat="server">
										set isRadioChecked=(answerAppliesTo="allEvents")
										
										set isRadioEnabled=0
										if canChangeAnswerAppliesTo set isRadioEnabled=1
										if questionAvailability="singleEvent" set isRadioEnabled=0
										if isRadioChecked set isRadioEnabled=1
									</script>			
									<td class="black10px"style="padding-bottom: 8px;">
										<input type="radio" name="radAnswerAppliesTo"  id="radAnswerAppliesToAllEvents" value="allEvents" #($S(isRadioChecked:"checked",1:""))# #($S(isRadioEnabled:"",1:"disabled"))#>
										<tx>Apply to all events</tx>
									</td>
								</tr>							
							</csp:if> 
							<tr>
								<td width="13" height="30">&nbsp;</td>
								<td class="black10px" align="right" height="30" width="184"><tx>Type</tx>:&nbsp;&nbsp;</td>
								<td class="black10px" valign="middle" height="30" colspan="4">

									<select name="selType" id="selDataType" class="black10px" size=1 style="width: 300px;" onChange="disabling(this.value);">
									<script language="cache" runat="server">
										// enforce strict control of the prompt type, must be roughly the same as the cod type
										kill alts
										set altIndex=0
										if itemNameID="CREATE" {
											if 'additional {
												set alts($i(altIndex))="text|"_..out(##class(cod.objItemName).getDataTypeDescription("text"))
												if 'quantityItem	{
													set alts($i(altIndex))="textarea|"_..out(##class(cod.objItemName).getDataTypeDescription("textarea"))
												}
											}
											if 'quantityItem {
												set alts($i(altIndex))="radiobutton|"_..out(##class(cod.objItemName).getDataTypeDescription("radiobutton"))
												set alts($i(altIndex))="dropdown|"_..out(##class(cod.objItemName).getDataTypeDescription("dropdown"))
												set alts($i(altIndex))="multibox|"_..out(##class(cod.objItemName).getDataTypeDescription("multibox")) // add multibox - fred jan 2010
												set multiboxIndex=altIndex //used for ordering checkbox before multibox.
											}
											if 'additional,'quantityItem {
												set alts($i(altIndex))= alts(multiboxIndex)
												set alts(multiboxIndex)="checkbox|"_..out(##class(cod.objItemName).getDataTypeDescription("checkbox"))
												set alts($i(altIndex))="integer|"_..out(##class(cod.objItemName).getDataTypeDescription("integer"))
												set alts($i(altIndex))="floatingPointNumber|"_..out(##class(cod.objItemName).getDataTypeDescription("floatingPointNumber"))
												set alts($i(altIndex))="time|"_..out(##class(cod.objItemName).getDataTypeDescription("time"))
												set alts($i(altIndex))="date|"_..out(##class(cod.objItemName).getDataTypeDescription("date"))
												set alts($i(altIndex))="dateRange|"_..out(##class(cod.objItemName).getDataTypeDescription("dateRange"))
												set alts($i(altIndex))="emailAddress|"_..out(##class(cod.objItemName).getDataTypeDescription("emailAddress"))
												set alts($i(altIndex))="multiEmailAddress|"_..out(##class(cod.objItemName).getDataTypeDescription("multiEmailAddress"))
												set alts($i(altIndex))="phoneNumber|"_..out(##class(cod.objItemName).getDataTypeDescription("phoneNumber"))
												set alts($i(altIndex))="webAddress|"_..out(##class(cod.objItemName).getDataTypeDescription("webAddress"))
												set alts($i(altIndex))="1-5 scale|"_..out(##class(cod.objItemName).getDataTypeDescription("1-5 scale")) // will be converted to radio when saved
											}
										} else {
											// restrict types if it already exists in COD
											if "text,textarea"[type {
												set alts($i(altIndex))="text|"_..out(##class(cod.objItemName).getDataTypeDescription("text"))
												if 'quantityItem {
													set alts($i(altIndex))="textarea|"_..out(##class(cod.objItemName).getDataTypeDescription("textarea"))
												}
											}
											if "radiobutton,dropdown"[type {
												set alts($i(altIndex))="radiobutton|"_..out(##class(cod.objItemName).getDataTypeDescription("radiobutton"))
												set alts($i(altIndex))="dropdown|"_..out(##class(cod.objItemName).getDataTypeDescription("dropdown"))
											}
											if type="checkbox" {
												set alts($i(altIndex))="checkbox|"_..out(##class(cod.objItemName).getDataTypeDescription(type))
											}											
											// Don't allow multi-boxes to be switchable with radios/dropdowns
											if type="multibox" {
												set alts($i(altIndex))="multibox|"_..out(##class(cod.objItemName).getDataTypeDescription(type)) 
											}
											if type="integer" {
												set alts($i(altIndex))="integer|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="floatingPointNumber" {
												set alts($i(altIndex))="floatingPointNumber|"_##class(cod.objItemName).getDataTypeDescription(type)
											}											
											if type="time" {
												set alts($i(altIndex))="time|"_..out(##class(cod.objItemName).getDataTypeDescription(type))
											}
											if type="date" {
												set alts($i(altIndex))="date|"_..out(##class(cod.objItemName).getDataTypeDescription(type))
											}
											if type="dateRange" {
												set alts($i(altIndex))="dateRange|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="emailAddress" {
												set alts($i(altIndex))="emailAddress|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="multiEmailAddress" {
												set alts($i(altIndex))="multiEmailAddress|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="phoneNumber" {
												set alts($i(altIndex))="phoneNumber|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="webAddress" {
												set alts($i(altIndex))="webAddress|"_##class(cod.objItemName).getDataTypeDescription(type)
											}
											if type="password" {
												set alts($i(altIndex))="password|"_..out(##class(cod.objItemName).getDataTypeDescription(type))
											}

										}
										set m=""
										for  {
											set m=$O(alts(m))
											if m="" quit
											set show=1
											if isSurvey {
												set show=##class(cod.methods).isCodTypeAllowedForRegPageType("surveys",$P(alts(m),"|",1))	
											} 
											if (isAwardsEntryPage) {
												set show=##class(cod.methods).isCodTypeAllowedForRegPageType("awards",$P(alts(m),"|",1))	
											}
											if (isAbstractPage) {
												set show=##class(cod.methods).isCodTypeAllowedForRegPageType("abstracts",$P(alts(m),"|",1))	
											}
											if isMeetManPage {
												set show=##class(cod.methods).isCodTypeAllowedForRegPageType("meetman",$P(alts(m),"|",1))
											}
											if isAccomPage {
												set show=##class(cod.methods).isCodTypeAllowedForRegPageType("accommodation",$P(alts(m),"|",1))
											}
											
											
											if show {
												write !,"<option value='",$P(alts(m),"|",1),"' "
												if type=$P(alts(m),"|",1) write "SELECTED"
												write ">",$P(alts(m),"|",2),"</option>"
											}
										}
									</script>
									</select>
									<span style="padding-left: 20px;" id="spanSearchAsYouType">
										<script language="cache" runat="server">
											set isChecked=0
											if $IsObject(objCODitem) {
												set isChecked=objCODitem.searchAsYouType
											}
										</script>
										<input type="checkbox" name="chkSearchAsYouType" value=1 #($Select(isChecked:"CHECKED",1:""))# style="vertical-align: sub;">
										Search-as-you-type
									</span>
									<script language="cache" runat="server">
										if '##class(sc.xModules.objPage).isSearchAsYouTypeAllowed(pageID) {
											write !,"<script language='javascript'>$('#spanSearchAsYouType').hide();</scri"_"pt>"	
										}
									</script>
								</td>
							</tr>
							<script language="cache" runat="server">
								set show=0
								if ##class(setup.objSystemTypes).isModuleAllowed("Mandatory Questions") set show=1
								if ##class(setup.objSystemTypes).isModuleAllowed("Backend Only Questions") set show=1
								if ##class(setup.objSystemTypes).isModuleAllowed("Read Only Questions") set show=1
								if ##class(setup.objSystemTypes).isModuleAllowed("Stop Amendments for Questions") set show=1

								set alwaysMandatory=0
								if $ZCVT(description,"L")="firstname" set alwaysMandatory=1
								if $ZCVT(description,"L")="lastname" set alwaysMandatory=1
								set templateName = $ZCVT(%request.Get("templateURL"),"U")
 								if templateName [ "TTABLEGUESTS.CSP" set alwaysMandatory = 0
							</script>
							<csp:if condition=(show)>
								<tr>
									<td width="13" height="30">&nbsp;</td>
									<td class="black10px" align="right" height="30" width="184"></td>
									<td class="black10px" height="30" colspan="4">
										<table border=0 cellpadding=0 cellspacing=0>
											<tr>
												<systemType:if module="Mandatory Questions">
													<td align="left">
														<csp:if condition=(alwaysMandatory)>
															<img src="../../media/images/English/Default/backend/tick.gif" alt="" width="14" height="12" border="0">
														<csp:else>
															<input type="checkbox" name='chkMandatory' value="1" #($S(mandatory=1:"checked",1:0))# style="margin-left:0px;">
														</csp:if>
													</td>
													<td class="black10px">
														<tx>Mandatory</tx>
													</td>
													<td width=20></td>
												</systemType:if>
												<systemType:if module="Backend Only Questions">
													<td>
														<input type="checkbox" name='chkBackendOnly' value="1" class="black10px" #($S(backendOnly=1:"checked",1:0))#>
													</td>
													<td class="black10px">
														<tx>Admin portal only</tx>
													</td>
													<td width=20></td>
												</systemType:if>
												<input type="hidden" name='chkReportOn' value="1">
												<systemType:if module="Read Only Questions">
													<td>
														<input type="checkbox" name='chkReadonlyFrontend' value="1" class="black10px" #($S(readonlyFrontend=1:"checked",1:0))#>
													</td>
													<td class="black10px">
														<tx>Read only</tx>
													</td>
													<td width=20></td>
												</systemType:if>
												<systemType:if module="Stop Amendments for Questions">
													<td>
														<input type="checkbox" name='chkNoAmendments' value="1" class="black10px" #($S(noAmendments=1:"checked",1:0))# title='#(..out("If checked, event website users will not be able to change the value when amending their registration"))#'>
													</td>
													<td class="black10px">
														<tx>Stop amendments</tx>
													</td>
												</systemType:if>
											</tr>
										</table>
									</td>
								</tr>
							</csp:if>
							<csp:if condition=(alwaysMandatory)>
								<input type="hidden" name='chkMandatory' value="1">
							</csp:if>
							<systemType:if module="Min and Max alts on multi checkboxes">
								<tr>
									<td width="13" height="30">&nbsp;</td>
									<td class="black10px" align="right" height="30" width="184"><tx>Multi checkbox options</tx>:</td>
									<td class="black10px" height="30" colspan="4">
										<table border=0 cellpadding=2>
											<tr>
												<td class="black10px" width=133 align="right">
													<tx>Min no. of alternatives:</tx>
												</td>
												<td>
													<input type="text" name="multiCheckboxMin" size=2 class="black10px" value="#(multiCheckboxMin)#">
												</td>
												<td class="black10px" width=133 align="right">
													<tx>Max no. of alternatives:</tx>
												</td>
												<td>
													<input type="text" name="multiCheckboxMax" size=2 class="black10px" value="#(multiCheckboxMax)#">
												</td>
											</tr>
										</table>
									</td>
								</tr>
							</systemType:if>
							<systemType:if module="Alternative Question Name in reports">
								<tr>
									<td width="13" height="33">&nbsp;</td>
									<td class="black10px" align="right" height="33" width="184" >
										<csp:if condition=(isAwardsEntryPage)>
											<tx>Alt. name in search/judges page</tx>:&nbsp;&nbsp;
										<csp:elseif condition=(meetingsEnabled)>
											<tx>Alt. name in search/meeting pages</tx>:&nbsp;&nbsp;
										<csp:else>
											<tx>Alt. name in search</tx>:&nbsp;&nbsp;
										</csp:if>
									</td>
									<td class="black10px" valign="middle" height="33" colspan="3">
										<input type="text" name="reportDescription" value="#(reportDescription)#" style="width: 285px;" class="black10px">
									</td>
								</tr>
							</systemType:if>
							<tr>
								<td width="13">&nbsp;</td>
								<td class="black10px" align="right"><tx>Field width</tx>:&nbsp;</td>
								<td colspan=99>
									<table cellpadding=0 cellspacing=0 border=0>
										<tr>
											<td class="black10px" valign="middle">
												<input type="text" name="txtFieldWidth" size="3" class="black9px" value="#(fieldWidth)#" title="Enter width in pixels">&nbsp;pixels
											</td>
											<td class="black10px" width="65" align="right">
												<tx>Height</tx>:&nbsp;
											</td>
											<td class="black10px" valign="middle">
												<input type="text" name="txtFieldHeight" size="3" class="black9px" value="#(fieldHeight)#" title="Enter the height in number of text rows">&nbsp;lines
											</td>
											<script language="cache" runat="server">
												// phased out for new and copied events as of Feb 2015
												if ##class(setup.objEventSetting).getParameter("legacy","hide 'place on same line' for registration questions",xEventID) {
													set showPlaceOnSameLine=0
												} else {
													set showPlaceOnSameLine=1	
												}
												set checked=""
												if dataID,objCODitem.supressNewLine set checked="CHECKED"

											</script>
											<csp:if condition="showPlaceOnSameLine">
												<td width=40 align="right">
													<input type="checkbox" name="suppressNewLine" value=1 #(checked)#  title="Places this item on the same line as the one next to it (requires that the other item also has this checked).">
												</td>
												<td class="black10px" width=120 >
													<tx>Place on same line</tx>
												</td>
											<csp:else>
													<td width=30>
														<input type="hidden" name="suppressNewLine" value="#($S(checked="CHECKED":1,1:0))#">
													</td>
											</csp:if>
											
											<systemType:if module="Prompt Width">
												<td class="black10px" align="right">
													<tx>Prompt width</tx>:&nbsp;
												</td>
												<td class="black10px" nowrap>
													<script language="cache" runat="server">
														set promptWidth=""
														if dataID set promptWidth=objCODitem.promptWidth
													</script>
													<input type="text" name="promptWidth" id="idPromptWidth" value="#(promptWidth)#" size=3 class="black9px"  title="Controls the width of the text"> %
												</td>
											</systemType:if>
										</tr>
									</table>
								</td>
							</tr>
							<csp:if condition=(('isDOC)&('isForm)&('additional))>

								<tr>
									<td></td>
									<td colspan=2>
										<table border=0 cellpadding=0 cellspacing=0 width="88%">
											<csp:if condition=(showGuest)>
												<tr>
													<td width="120px"></td>
													<td class="black10px" nowrap><tx>Applies to</tx>:&nbsp;</td>
													<td class="black10px">
														<input type="radio" name="radDelegateOrGuest" value="delegate" #($S((isDelegate)!(('isDelegate)&('isGuest)):"checked",1:""))#>
													</td>
													<td class="black10px" align="left">
														<tx>Attendees</tx>
													</td>
													<td rowspan=2 width="320px" valign="top" class="black10px" align="left">
													</td>
												</tr>
												<tr>
													<td colspan=2></td>
													<td class="black10px">
														<input type="radio" name="radDelegateOrGuest" value="guest" #($S(isGuest:"checked",1:""))# #($S(type="multibox":"DISABLED",1:""))#>
													<td class="black10px">
														<tx>Guests</tx>	
													</td>
												</tr>
											<csp:else>
												<script language="cache" runat="server">
													set tmpdelegateOrGuest="delegate"
													if hasAnyDependencies {
														if isGuest set tmpdelegateOrGuest="guest"
													}
												</script>
												<input type="hidden" name="radDelegateOrGuest" value="#(tmpdelegateOrGuest)#">
												<csp:if condition="$L(notShowGuestExplanation)">
													<tr>
														<td width="120px"></td>
														<td class="black10px" nowrap><tx>Applies to</tx>:&nbsp;</td>
														<td class="black10px">
															<input type="radio" name="dummy1" value="" #($S(tmpdelegateOrGuest="delegate":"CHECKED",1:""))# DISABLED>
														</td>
														<td class="black10px" align="left">
															<tx>Attendees</tx>
														</td>
														<td width=50></td>
														<td rowspan=2 valign="top" class="black10px" style="padding-top: 5px; padding-right: 3px;  padding-left: 8px; padding-bottom: 5px;color: 505050; background-color: #fff8dc;" align="left">
															#(notShowGuestExplanation)#
														</td>
													</tr>
													<tr>
														<td colspan=2></td>
														<td class="black10px">
															<input type="radio" name="dummy2" value="" #($S(tmpdelegateOrGuest="guest":"CHECKED",1:""))# DISABLED>
														</td>
														<td class="black10px">
															<tx>Guests</tx>
														</td>
													</tr>
												</csp:if>
											</csp:if>
										</table>
									</td>
								</tr>	
								<tr><td height=10></td></tr>

							<csp:elseif condition=(additional)>
								<input type="radio" name="radDelegateOrGuest" value="delegate" checked style="visibility: hidden;">
								<input type="radio" name="radDelegateOrGuest" value="guest" style="visibility: hidden;">

							<csp:else>
								<input type="radio" name="radDelegateOrGuest" value="delegate" checked style="visibility: hidden;">
								<input type="radio" name="radDelegateOrGuest" value="guest" style="visibility: hidden;">
							</csp:if>

							<csp:include page="dependancyOptionsInclude.csp">

							<tr><td height=10></td></tr>
							<script language="cache" runat="server">
								set isCallout=0
								set tmpTitle=..out("Enter an answer or pattern that must be matched, or a custom validation method starting with '#'")
								if $e(requiredAnswer,1,2)="##" {
									// Validate bespoke callouts
									set callOutMethod=$e(requiredAnswer,3,$l(requiredAnswer))
									if callOutMethod?1A.AN {
										set callOutMethod="customCode.codAnswerValidation."_##class(shared.callOuts).classNameForBespokeCode()_"."_callOutMethod
										if ##class(%MethodDefinition).%OpenId(callOutMethod).ClassMethod {
											set tmpTitle=$TR(##class(%MethodDefinition).%OpenId(callOutMethod).Description,$C(13)," ")
											set isCallout=1
										}
									}
									if 'isCallout {
										set requiredAnswer=""
									}
								}
							</script>
							<tr>
								<td width="13"></td>
								<td class="black10px" align="right"><tx>Custom validation</tx>:&nbsp;</td>
								<td colspan=4>
									<input type="Text" name="requiredAnswer" class="black10px" style="width: 283px;" value="#(..encodeForHTMLAttribute(requiredAnswer))#" title="#(..encodeForHTMLAttribute(tmpTitle))#">
									&nbsp;<csp:if condition=(isCallout)><span class="redbold10px"><tx>Warning: Custom validation is using bespoke validation</tx></span></csp:if>
								</td>
							<tr>
							<tr><td height=10></td></tr>
							<tr>
								<td width="13"></td>
								<td class="black10px" align="right"><tx>Validation error message</tx>:&nbsp;</td>
								<td colspan=4>
									<input type="Text" name="validationErrorMessage" class="black10px" style="width: 283px;" value="#(..encodeForHTMLAttribute(validationErrorMessage))#" >
								</td>
							<tr>
							<tr><td height=10></td></tr>
							<tr>
								<td width="13">&nbsp;</td>
								<td class="black10px" align="right"><tx>Default answer</tx>:&nbsp;</td>
								<td colspan=4>
									<table cellpadding=0 cellspacing=0 border=0>
										<tr>
											<td width=300>
												<script language="cache" runat="server">
												set show=##class(sc.xModules.objPage).isRegistrationPage(pageID)
												if +##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)=0 set show=0
												set isChecked=0
												if $g(objCODitem) set isChecked=+##class(sc.xModules.objCODitem).getCopyValueFromBooker(dataID)
												
											   </script>
													<input type="Text" name="defaultValueText" id="defaultValueText" style="width: 283px;" value="#(..EscapeHTML(defaultValue))#" title="Will be used as the initial value for this question." class="black10px">
													<select name="defaultValueAlt" id="defaultValueAlt" size="1" style="width: 300px;" title="Will be used as the initial value for this question" class="black10px">
														<option value='' #($S(defaultValue="":"SELECTED",1:""))#></option>
														<script language="cache" runat="server">
															set rs=##class(cod.objItemAlternatives).getAlternativesForCodItemAsResultSet(itemNameID)
														</script>
														<csp:while condition="rs.Next()">
															<script language="cache" runat="server">
																set tmpDesc=rs.Get("description")
																set selected=""
																if tmpDesc=defaultValue set selected="SELECTED"
															</script>
															<option value='#(tmpDesc)#' #(selected)#>#(tmpDesc)#</option>
														</csp:while>
													</select>
											</td>
											<csp:if condition=(show)>
												<td>&nbsp;
													<input type="checkbox" name="chkCopyFromBooker" id="chkCopyFromBooker" #($S(isChecked=1:"CHECKED",1:""))# value=1 onClick="ef.codQuestionDetails.updateDefaultField(this.checked);">
												</td>
												<td class="black10px">
													Copy from registration contact
												</td>
											</csp:if>
										</tr>
									</table>
								</td>
							<tr>
							<script language="cache" runat="server">
								set minDateRange=""
								set maxDateRange=""
								if (type="dateRange") {
									set minDateRange=$P(##class(cod.lnkItemNameEventDateRange).getMinTimeStamp(xEventID, itemNameID)," ",1)
									set minDateRange=##class(shared.dateFunctions).multiDate(minDateRange,xUserInputDateFormat,,25)
									set maxDateRange=$P(##class(cod.lnkItemNameEventDateRange).getMaxTimeStamp(xEventID, itemNameID)," ",1)
									set maxDateRange=##class(shared.dateFunctions).multiDate(maxDateRange,xUserInputDateFormat,,25)
								}
								
							</script>
							<csp:if condition=(1)>
								<tr><td height=10></td></tr>
					    		<tr id="dateRangeContainerRow" style="visibility:collapse;">
									<td class="black10px">&nbsp;</td>
									<td class="black10px" align="right"><tx>Available dates</tx>&nbsp;:&nbsp;*&nbsp;</td>
									<td class="black10px">
										<input type="text" class="black10px efDateRangePicker efDateRangeStart" id="dateRangeStart" efDateRangeEndID="dateRangeEnd" name="dateRangeStart" value="#(minDateRange)#" inputDateFormat="#(+$GET(xUserInputDateFormat))#">
										&nbsp;-&nbsp;
										<input type="text" class="black10px efDateRangePicker efDateRangeEnd" id="dateRangeEnd" efDateRangeStartID="dateRangeStart" name="dateRangeEnd" value="#(maxDateRange)#" inputDateFormat="#(+$GET(xUserInputDateFormat))#" title="A date range cannot be longer than 30 days">
										<span class="black9px" id="spanDate1">(#(##class(shared.dateFunctions).getBackendInputDatePattern())#)</span>
									</td>
									 
								</tr>
								<tr id="afterDateRangeContainerRow" style="visibility:collapse;"><td height=10></td></tr>
						</csp:if>
							<systemType:if module="Max Length of Answer">
								<script language="cache" runat="server">
									set show=0
									if (type="text")!(type="textarea")!(type="password") set show=1
								</script>
								<csp:if condition=(show)>
									</tr>
										<td width="13">&nbsp;</td>
										<td class="black10px" align="right"><tx>Max length of answer</tx>:&nbsp;</td>
										<td colspan=99>
											<table border=0 cellpadding=0 cellspacing=0>
												<tr>
													<script language="cache" runat="server">
														set useCharacters=1
														if maxWords set useCharacters=0
													</script>

													<td class="black10px">
														<input type="Text" name="maxCharacters" class="black10px" size="5" value="#(..EscapeHTML($S(useCharacters:maxCharacters,1:maxWords)))#" title="The page cannot be saved if the answer is longer than this number of characters.">&nbsp;&nbsp;
													</td>
													<td class="black10px">
														<input type="radio" name="radCharsOrWords" value="chars" #($S(useCharacters:"CHECKED",1:""))#>&nbsp;<tx>Characters</tx>
														<input type="radio" name="radCharsOrWords" value="words"  #($S('useCharacters:"CHECKED",1:""))#>&nbsp;<tx>Words</tx>
													</td>
												</tr>
											</table>
										</td>
									</tr>
								</csp:if>
							</systemType:if>
						</table>
						<table width="100%" border="0" cellspacing="0" cellpadding="2">
							<script language="cache" runat="server">
								// display a warning if these alternatives are currently being used in another live event
								kill tmpEventsUsing
								set show=0,eventList="--- "_..out("The following events are already using this database item")_" ---"
								if ('##class(cod.objItemName).isSingleEventQuestion(itemNameID))&&(##class(cod.objItemAlternatives).getAlternativesCountForCodItem(itemNameID)) {
									set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")

									do rs.Prepare("SELECT parent->parent AS pageID from sc_xModules.objCODItem WHERE objItemName=:itemNameID AND active=1")
									do rs.Execute()
									while (rs.Next()) {
										Set tmpPageID = rs.Get("pageID")
										set tmpEventID = ##class(sc.methods).getEventIDfromPageID(tmpPageID)
										If ((tmpEventID '= "") && (tmpEventID '= xEventID)) {
											// just use the english language description for event
											&SQL(SELECT description, objEvent->status INTO :tmp, :tmp2 FROM setup.objEventDetails WHERE objEvent = :tmpEventID AND objLanguage=1)
											If +SQLCODE=0 {
												set eventDescr=tmp
												set eventStatus=tmp2
												set show=1
												set tmpEventsUsing(eventStatus,tmpEventID)=eventDescr
											}
										}
									}
								}								
							</script>
							<csp:if condition=(show)>
								<tr>
									<td></td>
									<td colspan=99 align="center" height=30 class="black10px">
										<span class="blackbold10px"><tx>Warning</tx>:&nbsp;</span>
										<tx>Any changes you make to these alternatives will also be reflected in the following events</tx>:
										<a href="javascript: toggleUsedInEventsListVisibility();"><span id="showHideText">#(showListText)#</span></a>
										<br />
										<br />
										<div align="left">
										<div align="left" id="usedInEventsList" class="black10px" style="display:none; width:400px; height:200px; overflow:auto; overflow-x:hidden; border: 1px solid; padding: 5px; background-color: #e0e2d2;">
											<script language="cache" runat="server">
												set statusDisplayOrder(1)="live"
												set statusDisplayOrder(2)="notlive"
												set statusDisplayOrder(3)="archived"
												set statusDisplayOrder(4)="cancelled"
												set statusIndex=""
											</script>
											<csp:while condition=($ORDER(statusDisplayOrder(statusIndex))'="")>
												<script language="cache" runat="server">
												set statusIndex=$ORDER(statusDisplayOrder(statusIndex))
												set eventStatus=$GET(statusDisplayOrder(statusIndex))
												set tmpEventID=""
												</script>
												<csp:if condition="$DATA(tmpEventsUsing(eventStatus)) > 0">
													<span class="whitebold10px" style="display:block; background-color: #CC0033; padding:2px;">#(..out(eventStatus))# <tx>events</tx>:</span>
													<script language="cache" runat="server">
														set rowColor="#e0e2d2"
													</script>
													<csp:while condition=($ORDER(tmpEventsUsing(eventStatus,tmpEventID))'="")>
														<script language="cache" runat="server">
															set tmpEventID=$ORDER(tmpEventsUsing(eventStatus,tmpEventID))
															set rowColor=$SELECT(rowColor="#ffffff":"e0e2d2",1:"#ffffff")
														</script>
														<span style="padding:2px; display:block; background-color: #(rowColor)#;">#(tmpEventID)# - #($GET(tmpEventsUsing(eventStatus,tmpEventID)))#</span>
													</csp:while>
													<br />
													<br />
												</csp:if>
											</csp:while>
										</div>
										</div>
									</td>
								</tr>
							</csp:if>
							<tr>
								<td width="1">&nbsp;</td>
								<td class="black10px" align="right" width="184" valign="top"><tx>Answer alternatives</tx>:&nbsp;</td>
								<td class="black10px" valign="top" colspan="2">
									<table width="100%" border="0" cellspacing="0" cellpadding="0">
										<tr>
											<td valign="top" width="45%">
												<script language="cache" runat="server">
													k hasDependencies
													set rs=##class(cod.objItemAlternatives).getAlternativesForCodItemAsResultSet(itemNameID)
												</script>
												<select name="selAlternative" id="selAlternative"  multiple class="black10px" style="width: 302px; height: 100px;">
													<csp:while condition="rs.Next()">
														<script language="cache" runat="server">
															// Do not allow them to delete questions that have dependent children
															
															set altDesc=rs.Get("description")
															
															set code=rs.Get("code")
															set labelDesc=altDesc
															if $l(code) set altDesc=altDesc_" ("_..out("Code")_": "_code_")"
															set altID=rs.Get("ID")
															
															&SQL(SELECT ID FROM sc_xModules.objCODitem WHERE (dependsOnPrompt = :dataID) AND (dependsOnAlternative = :altID) AND (active=1))
															if +SQLCODE=0 set hasDependencies(altID)="dependent question"
															// Do not allow them to delete questions that have dependent children
															&SQL(SELECT ID FROM sc_xModules.objText WHERE (dependsOnPrompt = :dataID) AND (dependsOnAlternative = :altID) AND (active=1))
															if +SQLCODE=0 set hasDependencies(altID)="dependent text block"
															&SQL(SELECT ID FROM setup.lnkCategoryEvent WHERE (dependsOnPromptPageID = :pageID) AND (%SQLUPPER(dependsOnObjItemName->description) = %SQLUPPER(:description)) AND (dependsOnAlternative = :altDesc) AND (active=1))
															if +SQLCODE=0 set hasDependencies(altID)="dependent page"
														</script>
														<option value='#(altID_"|"_code)#'>#(altDesc)#</option>
													</csp:while>
												</select>
												<script language="cache" runat="server">
													set altID=""
												</script>
												<csp:while condition="$O(hasDependencies(altID))">
													<script language="cache" runat="server">
														set altID=$O(hasDependencies(altID))
													</script>
													<input type="hidden" name="hasDependencies_#(altID)#" value="#(hasDependencies(altID))#">
												</csp:while>
                                              </td>
											<td width="2%" valign="top">&nbsp;</td>
											<td width="53%" valign="top">
                                               <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                   <tr>
                                                     	<td width="20%" height="30">
													   		<img src="../../media/images/English/Default/backend/up.gif" alt="up" title="Move up one step" width="15" height="12" border="0" onClick="move('up');">
													   		<img src="../../media/images/English/Default/backend/top.gif" alt="top" title="Move to top" width="15" height="12" border="0" onClick="move('top');">
														</td>
														<td width="30%" height="30">
															<img src="../../media/images/English/Default/backend/delete.gif" name="butDelete" id="butDelete" alt="Delete selected alternative" width="50" height="17" border="0" onClick="deleteAlternative();">
														</td>
														<td width="50%"></td>
													</tr>
													<tr>
														<td  height="30">
															<img src="../../media/images/English/Default/backend/down.gif" alt="down" title="Move down one step" width="15" height="12" border="0" onClick="move('down');">
															<img src="../../media/images/English/Default/backend/bottom.gif" alt="bottom" title="Move to bottom" width="15" height="12" border="0" onClick="move('bottom');">
														</td>
														<td  height="30">
															<csp:if condition=(additional)>
																<script language="cache" runat="server">
																	set showAdvPage=0
																	if dataID set showAdvPage=1
																</script>
																<csp:if condition=(showAdvPage)>
																	<a href="javascript: editAlt();"><img src="../../media/images/English/Default/backend/advanced.gif" alt="Advanced"  name="butEdit" id="butEdit" height="17" border="0" title="Adds price and capacity to the selected alternative"></a>
																<csp:else>
																	<img src="../../media/images/English/Default/backend/advanced.gif" style="filter: alpha(opacity=35); opacity: 0.35;"  alt="Advanced" height="17" border="0" name="butEdit" id="butEdit" title="Advanced details is only available after you have saved the question.">
																</csp:if>
															<csp:else>
																<a href="javascript: editAlt();"><img src="../../media/images/English/Default/backend/edit.gif" alt="Edit" width="45" height="17" name="butEdit" id="butEdit" border="0"></a>
															</csp:if>
														</td>
														<systemType:if module="alternative codes">
															<td>
																<a href="javascript: editCode();"><img src="../../media/images/English/Default/backend/code.gif" alt="Code" name="butCode" id="butCode" border="0" title="#(..out("Click to add/amend a code"))#"></a>
															</td>
														</systemType:if>
													</tr>
													<tr><td height=5></td></tr>
													<script language="cache" runat="server">
														if layout="" set layout="vertical"
													</script>
													<tr>
														<td></td>
														<td class="black10px" colspan=3>
															<input type="radio" name="radLayout" value="horizontal" #($S(layout="horizontal":"CHECKED",1:""))#>&nbsp;
															<tx>Horizontal</tx></td>
													</tr>
													<tr>
														<td></td>
														<td class="black10px" colspan=3>
															<input type="radio" name="radLayout" value="vertical"  #($S(layout="vertical":"CHECKED",1:""))#>&nbsp;
															<tx>Vertical</tx></td>
													</tr>
                                                 </table>
											</td>
										</tr>
									</table>
								</td>
							</tr>
							<tr>
								<td width="1">&nbsp;</td>
								<td class="black10px" align="right">&nbsp;</td>
								<td class="black10px" valign="top">
									<img src="../../media/images/English/Default/backend/add.gif" alt="" width="65" height="17" name="butAddAlt" id="butAddAlt" border="0" onClick="addAlternative();">
									<script language="cache" runat="server">
										set %session.Data("afterUpload")=baseURL
									</script>
									<csp:if condition=(dataID)>
										<img src="../../media/images/English/Default/backend/import.gif" alt="" width="65" height="17" name="butImport" id="butImport" border="0" title="Import alternatives from CSV file">
									<csp:else>
										<img src="../../media/images/English/Default/backend/import.gif" style="filter: alpha(opacity=35); opacity: 0.35;"  alt="Advanced" height="17" border="0" name="butImport" id="butImport" title="Import is only available after you have saved the question.">
									</csp:if>
								</td>
							</tr>
						</table>
						<systemType:if module="Ticketing">
							<csp:if condition=(quantityItem)>
								<img src="../../media/images/English/Default/backend/line.gif" width="600" height="21">
								<script language="cache" runat="server">
									// retrieve the existing data (if there is any)
									set ticketID="",qCapacity="",qNoMoreBookings="",qNotification="",qNotificationLevel="",createsAttendees=""
									set qShowBookingLevel="",qShowCapacity="",qAttendeeCategoryID="",qMin="",qMax=""
									set (directPrice,priceDescriptorID,currencyID,basketItemID,priceByAttendeeCategory,vatCodeID)=""
									kill arrayPrices
									set useVatCodes=##class(eCom.objVatCode).isVatCodesEnabled()
									set arrayPrices(1)=""
									if $ISOBJECT(objCODitem)	{
										set scID=objCODitem.%Id()
										&SQL(SELECT ID,capacity,noMoreBookings,notification,notificationLevel,createsAttendees,showCapacity,showBookingLevel,categoryToCreate,minimum,maximum,priceByAttendeeCategory INTO :tmp,:tmp2,:tmp3,:tmp4,:tmp5,:tmp6,:tmp7,:tmp8,:tmp9,:tmp10,:tmp11,:tmp12 FROM cod.objTicket WHERE scCodItemID=:scID)
										if +SQLCODE=0 set ticketID=tmp,qCapacity=tmp2,qNoMoreBookings=tmp3,qNotification=tmp4,qNotificationLevel=tmp5,createsAttendees=tmp6,qShowCapacity=tmp7,qShowBookingLevel=tmp8,qAttendeeCategoryID=tmp9,qMin=tmp10,qMax=tmp11,priceByAttendeeCategory=tmp12

										if 'priceByAttendeeCategory {
											set basketItemID=##class(cod.objTicket).getBasketItemID(ticketID)
											if basketItemID {
												set objBasketItem=##class(eCom.objBasketItem).%OpenId(basketItemID)
												if objBasketItem.objPriceDescriptor'=""	{
													set priceDescriptorID=objBasketItem.objPriceDescriptor.%Id()
												} else {
													// get direct price without knowing the currrency of it
													set directPrice=##class(eCom.objBasketItem).getPrice(xEventID,basketItemID,,"",2,0)
													// get the found currency
													set currencyID=$p(directPrice,"|",1)
													set directPrice=$p(directPrice,"|",2)
													set directPrice=$FN(directPrice,",",2)
												}
												if objBasketItem.objVatCode'="" {
													set vatCodeID=objBasketItem.objVatCode.%Id()
												}
											}
											set arrayPrices(1)=basketItemID_"|"_priceDescriptorID_"|"_currencyID_"|"_directPrice
											set $p(arrayPrices(1),"|",8)=vatCodeID
										} else {
											set counter=0
											set rs=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
											do rs.Execute(xEventID)
											while rs.Next() {
												set counter=counter+1
												set (priceDescriptorID,currencyID,directPrice,sameAsCategoryID,vatCodeID)=""
												set eventCategoryID=rs.Get("objEventCategory")
												set categoryDescription=rs.Get("description")
												&SQL(SELECT objBasketItem,sameAs->objEventCategory INTO :tmp,:tmp2 FROM links.lnkCategoryItemBasketItem WHERE (objTicket=:ticketID) and (objEventCategory=:eventCategoryID))
												if +SQLCODE=0 {
													set basketItemID=tmp
													set sameAsCategoryID=tmp2
													set objBasketItem=##class(eCom.objBasketItem).%OpenId(basketItemID)
													if objBasketItem.objPriceDescriptor'=""	{
														set priceDescriptorID=objBasketItem.objPriceDescriptor.%Id()
													} else {
														// get direct price without knowing the currrency of it
														set directPrice=##class(eCom.objBasketItem).getPrice(xEventID,basketItemID,,"",2,0)
														// get the found currency
														set currencyID=$p(directPrice,"|",1)
														set directPrice=$p(directPrice,"|",2)
														set directPrice=$FN(directPrice,",",2)
													}
													if objBasketItem.objVatCode'="" {
														set vatCodeID=objBasketItem.objVatCode.%Id()
													}
												}
												set arrayPrices(counter)=basketItemID_"|"_priceDescriptorID_"|"_currencyID_"|"_directPrice_"|"_eventCategoryID_"|"_categoryDescription_"|"_sameAsCategoryID_"|"_vatCodeID
											}
										}
									}
								</script>

								<table width="100%" border="0" cellspacing="0" cellpadding="2">
								  <tr>
								    <td align="right" class="black10px">&nbsp;</td>
								    <td class="blackbold10px" valign="top"><tx>Quantity bookable item details</tx></td>
								  </tr>
								  <tr>
								    <td align="right" class="black10px" colspan="2">&nbsp;</td>
								  </tr>
								  <tr>
								    <td width="50" >&nbsp;</td>
								    <td class="black10px" valign="top">
										<table border=0 cellpadding=0 cellspacing=0>
								        <tr>
								          <td width="290"></td>
								          <td width="70" height="1"></td>
								          <td width="80"></td>
								          <td width="170"></td>
								        </tr>
										<tr>
 											<td class="black10px" align="right" height="25"><tx>Optional booking levels - minimum</tx>:&nbsp;&nbsp;</td>
											<td class="black10px">
												<input type="text" name="txtqMin" value="#(qMin)#" size="5" class="black10px">
											</td>
											<td class="black10px" align="right" valign="middle">  <tx>maximum</tx>:&nbsp;&nbsp;</td>
											<td class="black10px"><input type="text" name="txtqMax" value="#(qMax)#" size="5" class="black10px">
											</td>
										</tr>
										<script language="cache" runat="server">
											set show=inBookersPage
											if ##class(setup.objEventSetting).getParameter("basket","basket links to registration pages",xEventID) set show=0
											//if the event has Accommodation ON, disable the ticketing that creates real attendees. 
											if (##class(setup.objEventSetting).getParameter("bookings","allow accommodation bookings",xEventID)) set show=0
											if ##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID) {
												set show=0	
											}
										</script>
										<csp:if condition=(show)>
									        <tr>
									          <td align="right" class="black10px" >
											  	<tx>Should this question create real attendees?</tx>&nbsp;&nbsp;
											  </td>
									          <td height="25">
											  	<input type="checkbox" name="chkqCreatesAttendees" value="1" onChange="updateAttendeeCategory()" #($S(createsAttendees=1:"checked",1:""))# class="black10px">
									          </td>
									          <td colspan="2">
											  </td>
									        </tr>
										<csp:else>
										  	<input type="hidden" name="chkqCreatesAttendees" value="0">
										</csp:if>
										</table>
									<div id="divTicketingCreateAttendees" style="display:none;">
										<table border=0 cellpadding=0 cellspacing=0>
								        <tr>
								          <td width="290"></td>
								          <td width="60" height="1"></td>
								          <td width="70"></td>
								          <td width="190"></td>
								        </tr>
								        <tr>
								          <td align="right" class="black10px"><tx>Create attendees of this category</tx>:</td>
								          <td height="25">&nbsp;</td>
								          <td colspan="2">
											<csp:if condition=(xEventID)>
												<script language="cache" runat="server">
													// get all the active categories for this event
													set rs=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
													do rs.Execute(xEventID)
												</script>
											  	<select name="selqAttendeeCategory" size="1" class="black10px" style="width:200px;">
												<csp:while condition="rs.Next()">
													<script language="cache" runat="server">
														set eventCategoryID=rs.Data("objEventCategory")
														set selected=""
														if eventCategoryID=qAttendeeCategoryID set selected="SELECTED"
														// set default for new
														if 'qAttendeeCategoryID {
															set defaultCategoryID=##class(setup.lnkCategoryEvent).getDefault(xEventID)
															if 'defaultCategoryID set defaultCategoryID=##class(setup.objEventCategory).getDefaultCategoryID()
															
															if eventCategoryID=defaultCategoryID set selected="SELECTED"
														}
													</script>
													<option value="#(eventCategoryID)#" #(selected)#>#(rs.Data("description"))#</option>
												</csp:while>
									          	</select>
											</csp:if>
										  </td>
								        </tr>
										</table>
										<csp:if condition=(hasPricing)>
											<tx>As this question creates real attendees, pricing is set up in the prices section for the relevent attendee</tx>
										</csp:if>
									</div>
									<div id="divTicketingPricingCapacity" style="display:none;">
										<table border=0 cellpadding=0 cellspacing=0>
										<tr>
											<td width="290"></td>
											<td width="60" height="1"></td>
											<td width="70"></td>
											<td width="190"></td>
										</tr>
										<tr>
											<td class="black10px" align="right"><tx>Capacity</tx>:&nbsp;&nbsp;</td>
											<td class="black10px">
											<input type="text" name="txtqCapacity" value="#(qCapacity)#" size="5" class="black10px">
											</td>
											<td colspan="2" class="black10px" >&nbsp;</td>
										</tr>
										<csp:comment><!-- Show booking level for QBI's --></csp:comment>
										<tr>
											<td class="black10px" align="right"><tx>Current booking level</tx>:&nbsp;&nbsp;</td>
											<td class="black10px" height="25">
												<script language="cache" runat="server">
													set dataID=%request.Get("dataID")
													if dataID="" set dataID=%session.Get("dataID")
													
													set ticketID=##class(cod.objTicket).getTicketIDfromDataID(dataID)
													if ticketID'="" {
														write $P(##class(cod.objTicket).currentBookingLevel(ticketID,"",pageID),"|",1)
													} else {
														write "0"
													}
												</script>
											</td>
											<td colspan="2" class="black10px" >&nbsp;</td>
										</tr>
										<tr>
											<td class="black10px" align="right"><tx>Stop booking now</tx>:&nbsp;&nbsp;</td>
											<td height="25">
											<input type="checkbox" name="chkqNoMoreBookings" value="1" #($S(qNoMoreBookings=1:"checked",1:""))# class="black10px">
											</td>
											<td colspan="2">&nbsp;</td>
										</tr>
										<systemType:if module="EMAIL">
											<tr>
												<td class="black10px" align="right" height="25"><tx>Send notification</tx>:&nbsp;&nbsp;</td>
												<td class="black10px">
													<input type="checkbox" name="chkqNotification" value="1" #($S(qNotification=1:"checked",1:""))# class="black10px">
												</td>
												<td class="black10px" align="right"><tx>Level</tx>:&nbsp;&nbsp;</td>
												<td class="black10px">
													<input type="text" name="txtqNotificationLevel" value="#(qNotificationLevel)#" size="4" class="black10px"> %
												</td>
											</tr>
										</systemType:if>
										<tr>
											<td class="black10px" align="right" height="25"><tx>Show number remaining</tx>:&nbsp;&nbsp;</td>
											<td class="black10px">
												<input type="checkbox" id="chkqShowBookingLevel" name="chkqShowBookingLevel" value="1" #($S(qShowBookingLevel=1:"checked",1:""))# class="black10px">
											</td>
										</tr>
										<systemType:if module="Attendee Categories">
											<csp:if condition=(hasPricing)>
												<td class="black10px" align="right" height="25"><tx>Price by attendee category</tx>:&nbsp;&nbsp;</td>
													<td>
														<input type="Checkbox" name="chkPriceByAttendeeCategory" value=1  onclick="toggleAttendeeCategory()" #($S(priceByAttendeeCategory:"CHECKED",1:""))#>
													</td>
												</td>
											</csp:if>
										</systemType:if>
										<tr>
											<td class="black10px" align="right">&nbsp;</td>
											<td class="black10px" >&nbsp; </td>
											<td colspan="2" class="black10px" >&nbsp;</td>
										</tr>
										</table>
										<script language="cache" runat="server">
											set categoryCounter=1
										</script>
										<csp:if condition=(hasPricing)>
										<csp:while condition=($d(arrayPrices(categoryCounter)))>
											<script language="cache" runat="server">
												kill selection
												set data=arrayPrices(categoryCounter)
												set basketItemID=$p(data,"|",1)
												set priceDescriptorID=$p(data,"|",2)
												set currencyID=$p(data,"|",3)
												set directPrice=$p(data,"|",4)
												set eventCategoryID=$p(data,"|",5)
												set eventCategoryDescription=$p(data,"|",6)
												set sameAs=$p(data,"|",7)
												set vatCodeID=$p(data,"|",8)
												if priceByAttendeeCategory {
													set tmp="",allowRelink=1
													for {
														set tmp=$o(arrayPrices(tmp))
														if tmp="" quit
														if tmp'=categoryCounter {
															set selCategoryID=$p(arrayPrices(tmp),"|",5)
															if $p(arrayPrices(tmp),"|",7)=eventCategoryID {
																set allowRelink=0
																quit
															}
															// use tmp to index to preserve order
															if $p(arrayPrices(tmp),"|",7)="" {
																set selection(tmp)=arrayPrices(tmp)
															}
														}
													}
													if 'allowRelink kill selection
												}
												set header="Price and Discount Information"
												if eventCategoryID set header=header_" for "_eventCategoryDescription
												set categoryCounter=categoryCounter+1
												set selIndex=""
											</script>
											<table width="100%" border="0" cellspacing="0" cellpadding="0">
												<tr>
													<td width="106">&nbsp;</td>
													<td class="red" height="15" colspan="2">
														<span class="whitebold10px">&nbsp;&nbsp;&nbsp;
														#(header)#</span>
													</td>
												</tr>
												<tr>
													<td height=10 colspan=3></td>
												</tr>
												<csp:if condition=$d(selection)>
													<tr>
														<td >&nbsp;</td>
														<td class="black10px" width="100"  bgcolor="#efefef" height=25><tx>Use same prices as...</tx></td>
														<td class="black10px" width="130"  bgcolor="#efefef" height=25>
															<select name="selSameAs_#(eventCategoryID)#" onchange="saveSameAs(#(eventCategoryID)#);" class="black10px" style="width:150px;">
																<option value=""> - <tx>not linked</tx> - </option>
																<csp:while condition="$o(selection(selIndex))">
																	<script language="cache" runat="server">
																		set selIndex=$o(selection(selIndex))
																		set selID=$p(selection(selIndex),"|",5)
																		set selDescription=$p(selection(selIndex),"|",6)
																	</script>
																	<option value="#(selID)#" #($S(selID=sameAs:"SELECTED",1:""))#>#(selDescription)#</option>
																</csp:while>
															</select>
														</td>
													</tr>
												</csp:if>
												<csp:if condition=('sameAs)>
													<tr>
														<td >&nbsp;</td>
														<td class="black10px" width="199"  bgcolor="#efefef" height=25>
															<script language="cache" runat="server">
																set priceType="noPrice"
																if directPrice set priceType="direct"
																if priceDescriptorID set priceType="descriptor"
															</script>
															<input type="radio" value="noPrice" name="radPriceType_#(eventCategoryID)#" onClick="updatePricing_#(eventCategoryID)#();" #($S(priceType="noPrice":"CHECKED",1:""))#>
															<span style="vertical-align: 50%;"><tx>No Price</tx></span>
														</td>
														<td width="395" height=25 bgcolor="#efefef" class="black10px"> </td>
													</tr>
													<tr>
														<td>&nbsp;</td>
														<td class="black10px"  width="199"  bgcolor="#efefef" height=25>
															<script language="cache" runat="server">
																set directActive=1
																if ##class(setup.objEventSetting).getParameter("currency","allow currency selection",xEventID) set directActive=0
															</script>
															<input type="radio" value="direct" name="radPriceType_#(eventCategoryID)#" onClick="updatePricing_#(eventCategoryID)#();" #($S(priceType="direct":"CHECKED",1:""))#  #($S(directActive=0:"disabled title='Not available in multi currency mode'",1:""))#>
															<span style="vertical-align: 50%;"><tx>Basic price</tx></span>
														</td>
														<td class="black10px" bgcolor="#efefef" height=25>
															<input type="text" name="txtDirectPrice_#(eventCategoryID)#" value="#(directPrice)#" size="10" class="black9px" style="text-align: right;">
															&nbsp;<span style="vertical-align: 30%;"><tx>Currency</tx>:</span>
															<select name="selCurrency_#(eventCategoryID)#" class="black9px" size=1 style="width: 50px">
																<script language="cache" runat="server">
																	&SQL(SELECT objBaseCurrency,objBaseCurrency->code INTO :currencyID,:currencyCode FROM setup.objEvent WHERE ID=:xEventID)
																</script>
																<option value='#(currencyID)#'>#(currencyCode)#</option>
															</select> &nbsp;<span style="vertical-align: 30%;"><tx>or</tx></span>
														</td>
													</tr>
													<tr>
														<td>&nbsp;</td>
														<td class="black10px" width="199"  bgcolor="#efefef" height=25> <input type="radio" value="descriptor" name="radPriceType_#(eventCategoryID)#" onClick="updatePricing_#(eventCategoryID)#();" #($S(priceType="descriptor":"CHECKED",1:""))#>
															<span style="vertical-align: 50%;"><tx>Price descriptor</tx></span>
														</td>
														<td class="black10px" bgcolor="#efefef">
															<table width="93%" border="0" cellspacing="0" cellpadding="0">
																<tr>
																	<td width="415">
																		<select size="1" name="selPriceDescriptor_#(eventCategoryID)#" class="black10px" style="width: 250px;">
																			<csp:query name="rs" classname="eCom.objPriceDescriptor" queryname="qAllActivePricesDelegate" P1=#(xControllerID)#>
																			<option value=""></option>
																			<csp:while condition="rs.Next()">
																				<script language="cache" runat="server">
																					set descDescription=rs.Get("description")
																					set priceType=rs.Data("priceType")
																					set show=1
																					if (priceType="event")!(priceType="day") set show=0
																					set priceDescriptorID2=rs.Get("ID")
																					set show=1

																					// removed SQL to make it compile outside EF
																					set objPriceDescriptor=##class(eCom.objPriceDescriptor).%OpenId(priceDescriptorID2)
																					if (objPriceDescriptor.priceType="event")!(objPriceDescriptor.priceType="day") set show=0
																					kill objPriceDescriptor

																					// get latest price of price descriptor
																					set descCurrencyID=##class(setup.objEvent).getBaseCurrency(xEventID)
																					set descPrice=##class(eCom.objPriceCurrency).getAmountForDescriptor(priceDescriptorID2,descCurrencyID)
																					if 'descPrice {
																						// Loop thru all currencies if we didn't pass one in, necessary for a multi currency environment
																						set rs2=##class(%ResultSet).%New("eCom.objCurrency:qActiveCurrencies")
																						do rs2.Execute()
																						while (rs2.Next())&('descPrice) {
																							set descPrice=##class(eCom.objPriceCurrency).getAmountForDescriptor(priceDescriptorID2,rs2.Data("ID"))
																							if descPrice set descCurrencyID=rs2.Data("ID")
																						}
																					}
																					set descDescription=descDescription_"  ("_##class(eCom.objPrice).formatAmount(descPrice,descCurrencyID)_")"
																				</script>
																				<csp:if condition=(show)>
																					<option value='#(priceDescriptorID2)#' #($S(priceDescriptorID2=priceDescriptorID:"selected",1:""))#>
																						#(descDescription)#
																					</option>
																				</csp:if>
																			</csp:while>
																		</select>
																	</td>
																	<td width="10" align="right">&nbsp;</td>
																</tr>
															</table>
														</td>
													</tr>
													<tr>
														<td height="10" colspan="2">&nbsp;</td>
													</tr>
													<csp:query name="rs" classname="eCom.objDiscount" queryname="qActiveDiscountsByWhichPrice" P1=#(xLangID)# P2=#(xControllerID)# P3="additionalItem">
													<script language="cache" runat="server">
														new count,descs,IDs,data
														set count=0
														while rs.Next() {
															set count=count+1
															set descs(count)=rs.Get("description")
															set IDs(count)=rs.Get("objDiscount")
															set data(count)=##class(eCom.lnkItemDiscount).exists(basketItemID,rs.Get("objDiscount"))
														}
													</script>
													<tr>
														<td>&nbsp;</td>
														<td class="black10px" align="right" height="25" width="120"><tx>Available discounts</tx>:&nbsp;&nbsp;</td>
														<td height="25" class="black10px">
															<table width="100%" border="0" cellspacing="0" cellpadding="0">
																<tr>
																	<td class="black10px">
																		<csp:if condition="count">
																			<table cellpadding="0" cellspacing="0" border="0" width="250" bgcolor="#efefef">
																				<csp:LOOP COUNTER="x" FROM="1" TO="#(count)#">
																					<tr class="black10px">
																						<td width="25" height="25" align="right">
																							<input type="checkbox" name="chkDiscount_#(IDs(x))#_#(eventCategoryID)#" class="black10px" #($S(data(x):"checked",1:""))#>
																						</td>
																						<td width="100" class="black10px">
																							#(descs(x))#
																						</td>
																						<csp:if condition="x<count">
																							<script language="cache" runat="server">
																								set x=x+1
																							</script>
																							<td width="25" height="25" align="right">
																								<input type="checkbox" name="chkDiscount_#(IDs(x))#_#(eventCategoryID)#" class="black10px" #($S(data(x):"checked",1:""))#>
																							</td>
																							<td width="100">
																								#(descs(x))#
																							</td>
																						<csp:else>
																							<td width="25" height="25" align="right">
																								&nbsp;
																							</td>
																							<td width="100">
																								&nbsp;
																							</td>
																						</csp:if>
																					</tr>
																				</csp:LOOP>
																			</table>
																		<csp:else>
																			<tx>None available</tx>
																		</csp:if>
																	</td>
																	<td width="30" align="right">&nbsp;</td>
																</tr>
															</table>
														</td>
													</tr>
													<csp:if condition=(useVatCodes)>
														<tr>
															<td width="20">&nbsp;</td>
															<td class="black10px" width="100" align="right"><tx>Overriding VAT code</tx>:&nbsp;&nbsp;</td>
															<td class="black10px" colSpan=3 height=35>
																<select name="selVatCode_#(eventCategoryID)#" class="black10px" style="width:250px">
																	<option #($s(vatCodeID="":"selected",1:""))# value="">--<tx>Same as event</tx>--</option>
																	<csp:query name="rs" classname="eCom.objVatCode" queryname="qActiveVatCodes">
																	<csp:while condition="rs.Next()">
																		<script language="cache" runat="server">
																			set tmpVatCodeID=rs.Get("ID")
																			set vatCodeDescription=rs.Get("description")
																			set vatCode=rs.Get("code")
																			set selected=$s(vatCodeID=tmpVatCodeID:"selected",1:"")
																		</script>
																		<option value="#(tmpVatCodeID)#" #(selected)#>#(vatCodeDescription)# (#(vatCode)#)</option>
																	</csp:while>
																</select>
															</td>
														</tr>
													</csp:if>
												</csp:if><csp:comment><!-- not sameAs --></csp:comment>
											</table>
										</csp:while>
										</csp:if>
										<systemType:if module="Profit & Loss">
											<tr>
												<td class="black10px" colspan=99>
													<table border="0" cellspacing="0" cellpadding="0">
														<script language="cache" runat="server">
															set initialCost=""
															set unitCost=""
															set currencyCode=""
															if ticketID {
																&SQL(SELECT basketItemID INTO :basketItemID FROM cod.objTicket WHERE ID=:ticketID)
																if +SQLCODE=0 {
																	&SQL(SELECT initialCost,unitCost INTO :tmp1,:tmp2 FROM eCom.objBasketItem WHERE ID = :basketItemID)
																	if +SQLCODE=0 set initialCost=tmp1,unitCost=tmp2
																}

																set currencyCode=##class(eCom.objCurrency).getCode(##class(setup.objEvent).getBaseCurrency(xEventID))
															}
														</script>
														<tr>
															<td class="black10px" align="right" height="15" width="280" title="The startup cost, e.g. venue booking fee">
																<tx>Initial cost</tx>:&nbsp;&nbsp;
															</td>
															<td width=100 class="black10px" title="The startup cost, e.g. venue booking fee">
																<input type="text" name="initialCost" value="#(initialCost)#" class="black10px" style="width: 50px;">&nbsp;#(currencyCode)#
															</td>
															<td height="25" width="10">&nbsp;</td>
															<td class="black10px" width=75  title="Cost per sold item, e.g. meal cost">
																<tx>Unit cost</tx>:
															</td>
															<td width=100 class="black10px" title="Cost per sold item, e.g. meal cost">
																<input type="text" name="unitCost" value="#(unitCost)#"  class="black10px" style="width: 50px;">&nbsp;#(currencyCode)#
															</td>
														</tr>
													</table>
												</td>
												<td></td>
											</tr>
										</systemType:if>
										</div>
									</td>
								</tr>
								</table>
								<systemType:if module="External Item Codes">
									<script language="cache" runat="server">
										set extItemCodeDesc=##class(setup.objSetting).getParameter("basketItem","extItemCode")
										set extItemCode2Desc=##class(setup.objSetting).getParameter("basketItem","extItemCode2")
										set show=($l(extItemCodeDesc))!($l(extItemCode2Desc))
									</script>
									<csp:if condition=(show)>
										<script language="cache" runat="server">
											set (extItemCode,extItemCode2,basketItemID)=""
											&SQL(SELECT basketItemID INTO :basketItemID FROM cod.objTicket WHERE ID=:ticketID)
											if +SQLCODE=0 {
												&SQL(SELECT extItemCode,extItemCode2 INTO :tmp,:tmp2
													FROM eCom.objBasketItem
													WHERE ID=:basketItemID
												)
												if +SQLCODE=0 set extItemCode=tmp,extItemCode2=tmp2
											}
										</script>
										<img src="../../media/images/English/Default/backend/line.gif" width="600" height="21">
										<table border="0" cellspacing="0" cellpadding="0">
											<csp:if condition=($l(extItemCodeDesc))>
												<tr>
													<td class="black10px" align="right" height="15" width="315">#(extItemCodeDesc)#</td>
													<td height="25" width="10">&nbsp;</td>
			                                   		<td class="black10px" height="30" width="100">
														<input type="text" name="txtExtItemCode" value="#(extItemCode)#" size="30" width="20" class="black10px">
													</td>
												</tr>
											</csp:if>
											<csp:if condition=($l(extItemCode2Desc))>
												<tr>
													<td class="black10px" align="right" height="15" width="315">#(extItemCode2Desc)#</td>
													<td height="25" width="10">&nbsp;</td>
			                                   		<td class="black10px" height="30" width="100">
														<input type="text" name="txtExtItemCode2" value="#(extItemCode2)#" size="30" width="20" class="black10px">
													</td>
												</tr>
											</csp:if>
										</table>
									</csp:if>
								</systemType:if>
							</csp:if>
						</systemType:if>
					</systemType:if>
					<table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-top:8px;">
						<tr>
							<td width="20">&nbsp;</td>
							<td class="black10px" align="right" height="15" width="177" valign="top"><tx>Help text</tx>:&nbsp;&nbsp;</td>
							<td class="black10px" valign="top">
								<textarea name="txtHelpText" style="width: 298px; height: 75px;" class="black10px">#(helpText)#</textarea>
							</td>
						</tr>
					</table>
					<script language="cache" runat="server">
						set show=1
						if $G(xEventID) {
							set eventConfiguration=##class(setup.eventConfiguration).createForEventID(xEventID)
							if 'eventConfiguration.areAttendeeCategoriesAllowed() {
								set show=0
							}
						}
					</script>
					<csp:if condition=(show)>
                        <img src="../../media/images/English/Default/backend/line.gif" width="600" height="21">
							<systemType:if module="Attendee Categories">
								<script language="cache" runat="server">
									set eventID=$G(%session.Data("eventsforce","backend","xEventID"))
									set langID=$G(%session.Data("eventsforce","backend","xLangID"))
								</script>
								<csp:if condition=(eventID)>
								<table width="100%" border="0" cellspacing="0" cellpadding="0">
								<script language="cache" runat="server">
									// get all the active categories for this event
									set rs=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
									do rs.Execute(xEventID)
								</script>
									<csp:while counter="x" condition="rs.Next()">
										<csp:if condition=(x=1)>
											<tr>
												<td width="50">&nbsp;</td>
												<td class="black10px" colspan="4" align="left" nowrap>&nbsp;&nbsp;<tx>Restrict access to these attendee categories</tx>:</td>
												<td width="50">&nbsp;</td>
											</tr>
										</csp:if>
										<csp:if condition=(x#2'=0)>
											<tr>
												<td width="50">&nbsp;</td>
										</csp:if>
										<script language="cache" runat="server">
											set eventCategoryID=rs.Data("objEventCategory")
											set CHECKED=""
											if ##class(links.lnkEventCategoryData).isSet(eventCategoryID,dataID) set CHECKED="CHECKED"
										</script>
										<td align="right" class="black10px">#(##class(shared.stringFunctions).sentenceCase(rs.Data("description")))#</td>
										<td align="left"><input type="checkbox" name="chkEventCategory_#(eventCategoryID)#" #(CHECKED)#></td>
										<csp:if condition=(x#2=0)>
											<td width="50">&nbsp;</td>
											</tr>
										</csp:if>
									</csp:while>
									<csp:if condition=(x#2'=0)>
										<td align="right" class="black10px">&nbsp;</td>
										<td align="left">&nbsp;</td>
									</tr>
									</csp:if>
								</table>
								</csp:if>
							</systemType:if>
                    	</csp:if>
				   </td>
           		</tr>
				<script language="cache" runat="server">
					if (##class(sc.xModules.objPage).isAbstractDocumentPage(pageID)) && (##class(sc.objComponent).getComponentName(parent) = "Document List") {
						set show=1
					} else {
						set show=0
					}
				</script>
				<csp:if condition="show">
					<tr>
	           			<td >
							<table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-top: 10px;">
								<tr>
									<td class="black10px" align="right" width="192">
										Abstracts:&nbsp;&nbsp;
									</td>
				           			<td width="25">
				           				<script language="cache" runat="server">
				           					if ##class(cod.lnkItemNameEvent).getShowToReviewers(itemNameID,xEventID) = 1 {
					           					set isChecked="CHECKED"
				           					} else {
					           					set isChecked=""	
				           					}
				           				</script>
				           				<input type="checkbox" name="chkAbsShowToReviewers" value=1 #(isChecked)#>
				           			</td>
				           			<td class="black10px">
				           				Show to reviewers
				           			</td>
				           		</tr>
							</table>
						</td>
					</tr>
				</csp:if>
			<input type="Hidden" name="gotoPage" value="#(gotoPage)#">
			<input type="hidden" id="txtDeletedAlternatives" name="txtDeletedAlternatives" value="">
			<input type="hidden" name="txtAlternatives" value="">
			<input type="hidden" name="templateURL" value='#(templateURL)#'>
			<input type="hidden" name="addToTop" value='#(addToTop)#'>
			<input type="hidden" name="parent" value='#(parent)#'>
			<input type="hidden" name="itemNameID" value='#(..encodeForHTMLAttribute(itemNameID))#'>
			<script language="cache" runat="server">
				//Put the itemNameID in session. Otherwise alternative import fails.
				set %session.Data("itemNameID")=itemNameID
			</script>
			<input type="hidden" name="dataID" value='#(..encodeForHTMLAttribute(dataID))#'>
			<input type="hidden" name="pageID" value="#(..encodeForHTMLAttribute(pageID))#">
			<input type="hidden" name="additional" value='#(additional)#'>
			<input type="hidden" name="eventHotelID" value='#(eventHotelID)#'>
			<input type="hidden" name="quantityItem" value='#(quantityItem)#'>
			<input type="hidden" name="codGroup" value='#(codGroup)#'>
			
			<input type="hidden" name="gotoCodQuestionCSV" id="gotoCodQuestionCSV" value="0">
			<input type="Hidden" name="updateSameAs" value='nada'>
			<input type="Hidden" name="togglePriceByAttendeeCategory" value='0'>
                                 </td>
                             </tr>
                             <tr><td style="height: 16px;"></td></tr>
                         </table>
                     </td>
                     <td class="gen1_panel_border" width="1"><img src="../../media/images/english/default/backend/buffer.gif" width="1" height="1"></td>
                 </tr>
                 <tr class="gen1_panel_border">
                     <td colspan="3" height="1"><img src="../../media/images/english/default/backend/buffer.gif" width="1" height="1"></td>
                 </tr>
             </table>
         </td>
     </tr>
 </table>

   </form>


<script language='javascript'>
	attendeeCategories=0
</script>
<systemType:if module="Ticketing">
	<systemType:if module="Attendee Categories">
		<csp:if condition=(quantityItem)>
			<script language='javascript'>
				attendeeCategories=1
			</script>
		</csp:if>
	</systemType:if>
</systemType:if>

<script language='javascript'>
var ef = ef|| {};
ef.codQuestionDetails = ef.codQuestionDetails || {};
ef.codQuestionDetails.anyInvalidCharactersInName = function(inName) {
	//check name for any not allowed characters. See #127633311 for details.
	if((inName.match(/[^A-Za-z0-9_\s]/)) && (!(inName.match(/^.*XED:.*$/)))){
		return true;
	}
	return false;
};
ef.codQuestionDetails.checkNumericValues = function() {
	var fieldWidth = document.forms[0].txtFieldWidth.value;
	var strLength = fieldWidth.length;
	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = fieldWidth.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || fieldWidth.indexOf(' ') >= 0 ) {
				alert ('The changes can\'t be saved because "Field width" must be a number.');
				document.forms[0].txtFieldWidth.style.background = "yellow";
				return false;
			}
		}
 	}
	
	var fieldHeight = document.forms[0].txtFieldHeight.value;
	var strLength = fieldHeight.length;
	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = fieldHeight.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || fieldHeight.indexOf(' ') >= 0 ) {
				alert ('The changes can\'t be saved because "Height" must be a number.');
				document.forms[0].txtFieldHeight.style.background = "yellow";
				return false;
			}
		}
 	}
	
	if (typeof document.forms[0].maxCharacters !== 'undefined') {
		var maxCharacters = document.forms[0].maxCharacters.value;
		var strLength = maxCharacters.length;
		if (strLength >0) 	{
			for (i=0;i<strLength; i++)		{
				candidateCharCode = maxCharacters.charCodeAt(i);
				if ( candidateCharCode < 48 || candidateCharCode > 57 || maxCharacters.indexOf(' ') >= 0 ) {
					alert ('The changes can\'t be saved because "Max length of answer" must be a number.');
					document.forms[0].maxCharacters.style.background = "yellow";
					return false;
				}
			}
	 	}
	}
	
	var qMin = document.forms[0].txtqMin.value;
	var strLength = qMin.length;
	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = qMin.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || qMin.indexOf(' ') >= 0 ) {
				alert ('The changes can\'t be saved because "Optional booking levels - minimum" must be a number.');
				document.forms[0].txtqMin.style.background = "yellow";
				return false;
			}
		}
 	}
	
	var qMax = document.forms[0].txtqMax.value;
	var strLength = qMax.length;
	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = qMax.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || qMax.indexOf(' ') >= 0 ) {
				alert ('The changes can\'t be saved because "Optional booking levels - maximum" must be a number.');
				document.forms[0].txtqMax.style.background = "yellow";
				return false;
			}
		}
 	}
	
	var qCapacity = document.forms[0].txtqCapacity.value;
	var strLength = qCapacity.length;
 	if (strLength >0) 	{
		for (i=0;i<strLength; i++)		{
			candidateCharCode = qCapacity.charCodeAt(i);
			if ( candidateCharCode < 48 || candidateCharCode > 57 || qCapacity.indexOf(' ') >= 0 ) {
				alert ('The changes can\'t be saved because "Capacity" must be a number.');
				document.forms[0].txtqCapacity.style.background = "yellow";
				return false;
			}
		}
 	}
	
	var qNotificationLevel = document.forms[0].txtqNotificationLevel.value;
	if(isNaN(qNotificationLevel) || qNotificationLevel.indexOf(' ') >= 0) {
		alert('The changes can\'t be saved because "Level" must be a number.');
		document.forms[0].txtqNotificationLevel.style.background = "yellow";
		return false;
	}
	
	var strLength = qNotificationLevel.length;
	if ((strLength > 0) && ((parseFloat(qNotificationLevel)>100.0) || (parseFloat(qNotificationLevel) <0.0))) {
		alert ('The changes can\'t be saved because "Level" must be a number between 0 and 100.');
		document.forms[0].txtqNotificationLevel.style.background = "yellow";
		return false;
	}
	
	return true;
};

function checkName() {
	var dataID = document.forms[0].dataID.value;
	var itemNameID = document.forms[0].itemNameID.value;
	var name= document.forms[0].txtDescription.value;
	
	// conflate all consecutive white spaces (prevents database/tag inconsistency 
	if((itemNameID == 'CREATE')&&(name.match(/ {2,}/))) {
		document.forms[0].txtDescription.value = name.replace(/ {2,}/g,' ');	
		name = document.forms[0].txtDescription.value;
	}

	if (name=='') {
		alert('#(..out("Please enter a Database Name for this Question Prompt"))#');
		return false;
	}

	// Stop people from entering special characters for databasename.
	if((itemNameID == 'CREATE') && (ef.codQuestionDetails.anyInvalidCharactersInName(name))){
			alert('Only letters, numbers, underscores and spaces are allowed for the database name. Please try again.');
			document.forms[0].txtDescription.focus();
			return false;
	}

	if ((dataID == 'NEW') && (itemNameID == 'CREATE')) {
		var found=0;
		for (var i = 0 ; i<document.forms[0].selCODitem.options.length; i++) {
			if (document.forms[0].selCODitem.options[i].text.toUpperCase() == name.toUpperCase()) {
				alert('The question you are trying to add is already in the database. Please re-use the existing one.');
				return false;
			}
		}
	}
	return true;
}

function popup(type) {
	// save first
	document.forms[0].gotoPage.value = '#(..encodeForJavaScript(linkedBaseURL))#';
	document.forms[0].submit();

	var theURL="#(..Link("codQuestionHTML.csp?dataID="_dataID))#"

	// calculate where to open popup window
	var width = 750;
	var height = 450;
	var myLeft = (screen.width) ? (screen.width-width)/2 : 0;
	var myTop = (screen.height) ? (screen.height-height)/2 : 0;
	var left = myLeft;
	var top = myTop;

	myWindow = window.open(theURL,"LekOchLars",'location=no,screenX=' + left + ',screenY=' + top + ',top=' + top + ',left=' + left + ',directories=no,status=no,menubar=no,scrollbars=no,resizable=yes,hotkeys=no,toolbar=no,width=750,height=450');
	myWindow.focus();
}


function selectAll() {
	// build a string of all just before save to make sure all alts are submitted
	var rowCount = document.forms[0].selAlternative.options.length;
	var tmp = '';
	for (var i = 0 ; i<rowCount; i++) {
		tmpAlt = document.forms[0].selAlternative.options[i].value;
		tmpAltID = tmpAlt.split('|')[0];
		tmpAltCode = tmpAlt.split('|')[1];
		tmpValue = document.forms[0].selAlternative.options[i].text;
		
		if (tmpAltCode != '') {
			// remove the code text before saving it
			codeText = ' (#(..out("Code"))#: ' + tmpAltCode + ')';
			tmpValue = tmpValue.split(codeText)[0];
		}
		
		tmp = tmp + tmpAltID + "~" + tmpValue + "~" + tmpAltCode + "|"
	}
	document.forms[0].txtAlternatives.value=tmp;
}


function addAlternative(text) {
	// add alternative
	if (document.forms[0].selAlternative.disabled == false ) {
		var text = prompt('Please enter the new alternative:','');
		if (text != null ) {
			//get rid of all the extra spaces and consequtive multispaces.
			text = text.replace(/^\s*|\s*$/g,'');
			text = text.replace(/\s+/g,' ');

			if ((text.replace(/\s/ig,"")!="")&&(text.toUpperCase()!="&NBSP;")) {
				if (text.indexOf('|')>0) {
					alert(#(..QuoteJS(..out("Your alternative cannot contain a '|'")))#);
					return;
				}
				if (text.indexOf('~')>0) {
					alert(#(..QuoteJS(..out("Your alternative cannot contain a '~'")))#);
					return;
				}
				var itemCount = document.forms[0].selAlternative.options.length;
				document.forms[0].selAlternative.options[itemCount] = new Option(text,'NEW|')
				if (typeof document.forms[0].defaultValueAlt != "undefined") {
					// Add alternative to Pre-select list
					var itemCount = document.forms[0].defaultValueAlt.options.length;
					document.forms[0].defaultValueAlt.options[itemCount] = new Option(text,'NEW|')
				}
			} else {
				alert('#(..out("Invalid Alternative name. Operation cancelled. Please try again!"))#');
			}
		}
	}
}

function deleteAlternative() {
	// can handle multiple deletes
	var rowsToDelete = new Array();
	var counter = 0;
	var error = 0
	for (var j = 0 ; j < document.forms[0].selAlternative.length; j++ ) {
		if (document.forms[0].selAlternative.options[j].selected == true ) {
			counter = counter + 1;
			rowsToDelete[counter] = j;
			altID = document.forms[0].selAlternative.options[j].value.split('|')[0];
			depends='document.forms[0].hasDependencies_' + altID
			if (eval('typeof ' + depends) != "undefined") {
				error = 1;
				errorDesc = 'option cannot be deleted as it has a ' + eval(depends + '.value')
			}
		}
	}
	
	if (error == 1) {
		alert(errorDesc);
	} else {
		for (var j = counter ; j>0 ; j=j-1) {
			var tmp=rowsToDelete[j];
			deleteOne(tmp);
		}
		if (typeof document.forms[0].defaultValueAlt != "undefined") {
			// Copy the alternatives to the default value
			selInd = document.forms[0].defaultValueAlt.selectedIndex;
			selValue = document.forms[0].defaultValueAlt.options[selInd].text;
			document.forms[0].defaultValueAlt.selectedIndex=0;
			for (var i = 0 ; i<document.forms[0].selAlternative.length; i++) {
				alt = document.forms[0].selAlternative.options[i].text;
				document.forms[0].defaultValueAlt.options[i+1].value = alt;
				document.forms[0].defaultValueAlt.options[i+1].text = alt;
				if (alt == selValue) {
					document.forms[0].defaultValueAlt.selectedIndex = i+1;
				}
			}
			// then truncate the options where it was clicked
			document.forms[0].defaultValueAlt.length = document.forms[0].selAlternative.length + 1;
		}
	}
}

function deleteOne(selRow) {
	if (selRow != -1) {

		// store the fact that we have deleted a real alt
		var tmpValue = document.forms[0].selAlternative.options[selRow].value;
		if (tmpValue != 'NEW') {
			tmpValue = tmpValue.split("|")[0];
			if ($.isNumeric(tmpValue)) {
				document.forms[0].txtDeletedAlternatives.value = document.forms[0].txtDeletedAlternatives.value + tmpValue + '|';
			}
		}

		// remove item from the array
		var tmpArrID = new Array();
		var tmpArrText = new Array();

		// first save the lower part
		var itemCount =0;
		for (var i = selRow+1 ; i<document.forms[0].selAlternative.length; i++) {
			itemCount++;
			tmpArrID[itemCount] = document.forms[0].selAlternative.options[i].value;
			tmpArrText[itemCount] = document.forms[0].selAlternative.options[i].text;
		}

		// then truncate the options where it was clicked
		document.forms[0].selAlternative.length=selRow;

		// and then copy back the lower part
		for (var i = 1 ; i<itemCount+1; i++) {
			document.forms[0].selAlternative.length=document.forms[0].selAlternative.length+1;
			var lastItem =document.forms[0].selAlternative.length-1;
			document.forms[0].selAlternative.options[lastItem].value = tmpArrID[i];
			document.forms[0].selAlternative.options[lastItem].text = tmpArrText[i];
		}
	}
}

function moveUp(selRow) {
	if (selRow >0 ) {
		var tmpValue = 	document.forms[0].selAlternative.options[selRow-1].value;
		var tmpName = 	document.forms[0].selAlternative.options[selRow-1].text;
		document.forms[0].selAlternative.options[selRow-1].value = document.forms[0].selAlternative.options[selRow].value
		document.forms[0].selAlternative.options[selRow-1].text = document.forms[0].selAlternative.options[selRow].text
		document.forms[0].selAlternative.options[selRow].value = tmpValue
		document.forms[0].selAlternative.options[selRow].text = tmpName
		document.forms[0].selAlternative.selectedIndex=selRow-1
	}
}

function moveDown(selRow) {
	var rowCount = document.forms[0].selAlternative.options.length;
	if (selRow < (rowCount-1) ) {
		var tmpValue = 	document.forms[0].selAlternative.options[selRow+1].value;
		var tmpName = 	document.forms[0].selAlternative.options[selRow+1].text;
		document.forms[0].selAlternative.options[selRow+1].value = document.forms[0].selAlternative.options[selRow].value
		document.forms[0].selAlternative.options[selRow+1].text = document.forms[0].selAlternative.options[selRow].text
		document.forms[0].selAlternative.options[selRow].value = tmpValue
		document.forms[0].selAlternative.options[selRow].text = tmpName
		document.forms[0].selAlternative.selectedIndex=selRow+1
	}

}

function editCode() {
	if (document.forms[0].selAlternative.disabled == false ) {
		if (document.forms[0].selAlternative.selectedIndex != -1 ) {
			
			altID = document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].value
			altCode = altID.split('|')[1]
			altID = altID.split('|')[0]
			
			var altText = 	document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].text;
			var codeText = '';
			if (altCode != '') {
				// remove the code text before they edit it
				codeText = ' (#(..out("Code"))#: ' + altCode + ')';
				altText = altText.split(codeText)[0];
			}
			var text = prompt('#(..out("Please edit the code for "))#' + altText,altCode);
	
			//get rid of all the extra spaces and consequtive multispaces.
			text = text.replace(/^\s*|\s*$/g,'');  //leading and trailing spaces..delete them all.
			text = text.replace(/\s+/g,' '); //multiple consecutive space in the value. Replace the group with one space.
			
			if (text != '') {
				document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].text = altText + ' (#(..out("Code"))#: ' + text + ')';
				document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].value = altID + '|' + text;
			} else {
				document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].text = altText;
				document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].value = altID + '|';
			}
		} else {
			alert('#(..out("You must select one of the alternatives before editing the code"))#')
		}
	}
}

function editAlt() {
	if (document.forms[0].selAlternative.selectedIndex != -1 ) {
		var tmpValue = 	document.forms[0].selAlternative.options[document.forms[0].selAlternative.selectedIndex].value.split('|')[0];
		if (parseInt(tmpValue)>0) {
			document.forms[0].gotoPage.value="codAlternativeDetails.csp?dataID=#(dataID)#&itemAlternativeID=" + tmpValue;
			document.forms[0].submit();
		} else {
			alert('#(..out("This alternative is not saved yet. Please save all alternatives before modifying prices"))#');

		}
	} else {
		alert('#(..out("You must select one of the alternatives before selecting Advanced mode"))#')
	}
}


function move (direction) {
	var selRow = document.forms[0].selAlternative.selectedIndex
	if (direction == 'up') {
		moveUp(selRow)
	}
	if (direction == 'top') {
		for (var i = selRow ; i>0 ; i=i-1) {
			moveUp(i);
		}
	}
	if (direction == 'bottom') {
		var rowCount = document.forms[0].selAlternative.options.length;
		for (var i = selRow + 1 ; i<rowCount ; i=i+1) {
			moveUp(i);
		}
	}
	if (direction == 'down') {
	 moveDown(selRow);
	}
	if (typeof document.forms[0].defaultValueAlt != "undefined") {
		// Copy the alternatives to the default value dropdown
		selInd = document.forms[0].defaultValueAlt.selectedIndex;
		selValue = document.forms[0].defaultValueAlt.options[selInd].text;
		document.forms[0].defaultValueAlt.selectedIndex=0;
		for (var i = 0 ; i<document.forms[0].selAlternative.length; i++) {
			alt = document.forms[0].selAlternative.options[i].text;
			document.forms[0].defaultValueAlt.options[i+1].value = alt;
			document.forms[0].defaultValueAlt.options[i+1].text = alt;
			if (alt == selValue) {
				document.forms[0].defaultValueAlt.selectedIndex = i+1;
			}
		}
		// then truncate the options where it was clicked
		document.forms[0].defaultValueAlt.length = document.forms[0].selAlternative.length + 1;
	}
}

function disableMe(formElem){
	// generic function to check for existence of form element and disable it
	if (typeof document.myform[formElem] != "undefined") {
		// it exists, but is it a set of radio buttons
		if (typeof document.myform[formElem].length != "undefined") {
			// either radio or select
			if ((typeof document.myform[formElem].type != "undefined")&&(document.myform[formElem].type.indexOf('select')!=-1)) {
				// select
				document.myform[formElem].disabled=true;
				document.myform[formElem].style.background="#EEEEEE";
			} else {
				// radio - iterate over the whole array or just one?
				if (arguments.length > 1) { // if specific, the index will be passed as a second argument to the function
					document.myform[formElem][arguments[1]].disabled=true;
				} else {
					for (var i=0;i<document.myform[formElem].length;i++) {
						document.myform[formElem][i].disabled=true;
					}
				}
			}
		} else {
			document.myform[formElem].disabled=true;
			// is it a text field, textarea or password?
			if ((typeof document.myform[formElem].type != "undefined")&&((document.myform[formElem].type.indexOf('text')!=-1)||(document.myform[formElem].type.indexOf('password')!=-1))) {
				document.myform[formElem].style.background="#EEEEEE";
			}
		}

	}
}

ef.codQuestionDetails.toggleDefaultField =  function(mode) {
	if (mode=='none') {
		$('#defaultValueText').show();
		$('#defaultValueText').attr("disabled", "disabled");
		$('#defaultValueAlt').hide();	
	
	} else if (mode=='text')	{
		$('#chkCopyFromBooker').removeAttr("disabled"); 
		$('#defaultValueText').show();
		if ($('#chkCopyFromBooker').is(':checked') == true) {
			$('#defaultValueText').attr("disabled", "disabled"); 
		} else {
			$('#defaultValueText').removeAttr("disabled");
		}
		$('#defaultValueAlt').hide();	
		
	} else if (mode=='alternative') {
		$('#chkCopyFromBooker').removeAttr("disabled"); 
		$('#defaultValueText').hide();
		$('#defaultValueAlt').show();
		if ($('#chkCopyFromBooker').is(':checked') == true) {
			$('#defaultValueAlt').attr("disabled", "disabled"); 
		} else {
			$('#defaultValueAlt').removeAttr("disabled");
		}
	}	
}

ef.codQuestionDetails.updateDefaultField =  function(checkboxValue) {
	if (checkboxValue==true) {
		ef.codQuestionDetails.toggleDefaultField('none');
	} else {
		var fieldType = $('#selDataType').val()
		disabling(fieldType); 
	}
}
function enableMe(formElem){
	// generic function to check for existence of form element and enable it
	if (typeof document.myform[formElem] != "undefined") {
		// it exists, but is it a set of radio buttons
		if (typeof document.myform[formElem].length != "undefined") {
			// either radio or select
			if ((typeof document.myform[formElem].type != "undefined")&&(document.myform[formElem].type.indexOf('select')!=-1)) {
				// select
				document.myform[formElem].disabled=false;
				document.myform[formElem].style.background="#FFFFFF";
			} else {
				// radio - iterate over the whole array or just one?
				if (arguments.length > 1) { // if specific, the index will be passed as a second argument to the function
					document.myform[formElem][arguments[1]].disabled=false;
				} else {
					for (var i=0;i<document.myform[formElem].length;i++) {
						document.myform[formElem][i].disabled=false;
					}
				}
			}
		} else {
			document.myform[formElem].disabled=false;
			// is it a text field, textarea or password?
			if ((typeof document.myform[formElem].type != "undefined")&&((document.myform[formElem].type.indexOf('text')!=-1)||(document.myform[formElem].type.indexOf('password')!=-1))) {
				document.myform[formElem].style.background="#FFFFFF";
			}
		}

	}
}

function applyOpacityStyle(elem) {
	// generic function to apply opacity filter to a passed in DOM element
	var myElem=document.getElementById(elem)

	if (myElem) {
		myElem.style.opacity="0.35";
		myElem.style.filter="alpha(opacity=35)";
	}
}

function removeOpacityStyle(elem) {
	// generic function to apply opacity filter to a passed in DOM element
	var myElem=document.getElementById(elem)

	if (myElem) {
		myElem.style.opacity="1";
		myElem.style.filter="alpha(opacity=100)";
	}
}
function hideDateRangeAvailability() {
    $('#dateRangeContainerRow').css('visibility','collapse');
    $('#afterDateRangeContainerRow').css('visibility','collapse');
    if ('#(dataID)#' == 'NEW') {
		$('#radQuestionAvailabilityAllEvents').attr('disabled',false);
	}
   }
function showDateRangeAvailability() {
   $('#dateRangeContainerRow').css('visibility','visible');	
   $('#afterDateRangeContainerRow').css('visibility','visible');
   $('#radQuestionAvailabilitySingleEvent').attr('checked',true);
   updateAnswerSpanningRadios();
   $('#radQuestionAvailabilityAllEvents').attr('disabled',true);
}

$('#chkConcealed').click(function() {
	if($('#radQuestionAvailabilitySingleEvent').is(':checked')) { 
		$('#radQuestionAvailabilityAllEvents').attr('checked',true);
		$('#radQuestionAvailabilitySingleEvent').attr('disabled',true);
	} else {
		$('#radQuestionAvailabilitySingleEvent').attr('disabled',false);	
	}
});

$('input[name=radQuestionAvailability]').click(function() {
	updateAnswerSpanningRadios();
});

function updateAnswerSpanningRadios() {
   if($('#radQuestionAvailabilitySingleEvent').is(':checked')) { 
   		$("#radAnswerAppliesToSingleEvent").attr('checked',true);
   		$('#radAnswerAppliesToAllEvents').attr('disabled',true);
   } else {
   		if (#(+canChangeAnswerAppliesTo)# == 1) {
   			$('#radAnswerAppliesToAllEvents').attr('disabled',false);
   		}
   }
}

$(document).ready(function () {
	$('.efDateRangePicker').each(function () {
		$(this).kendoDatePicker({
			format: getKendoDateFormat($(this).attr('inputDateFormat'))
		});
		var picker=$(this).data('kendoDatePicker');

		if ($(this).hasClass('efDateRangeStart')) {
			var endEle=$('#'+$(this).attr('efDateRangeEndID'));
			picker.bind('change', function() {
				var temp=new Date(picker.value());
				if (temp.toString()!="Invalid Date") {
					tempMin=new Date(temp.getFullYear(),temp.getMonth(),temp.getDate()+1);
					tempMax=new Date(temp.getFullYear(),temp.getMonth(),temp.getDate()+#(##class(cod.objItemName).#maxDateRangeLength-1)#);
					endElePicker=endEle.data('kendoDatePicker');
					endElePicker.min(tempMin);
					endElePicker.max(tempMax);
				}
			});
		}
	});
});


function isValidRangeAvailability() {
	var maxDateRangeLength=#(##class(cod.objItemName).#maxDateRangeLength)#;
	type=$('#selDataType option:selected').val();
	if (type == "dateRange") {
		var dateRangeStart = new Date($('#dateRangeStart').data('kendoDatePicker').value());
		var dateRangeEnd = new Date($('#dateRangeEnd').data('kendoDatePicker').value());
		if ($('#dateRangeStart').data('kendoDatePicker').value()==null) {
			alert('#(..out("Date range start date is not valid"))#')
			return 0;
		} else if ($('#dateRangeEnd').data('kendoDatePicker').value()==null)
		{
			alert('#(..out("Date range end date is not valid"))#')
			return 0;
		} else if ((dateRangeEnd-dateRangeStart)<0) {
			alert('#(..out("Date range end date must be after the start date"))#')
			return 0;
		} else {
			differenceInDays = Math.floor((dateRangeEnd-dateRangeStart)/(1000*3600*24))+1;
			if ((differenceInDays<1) || (differenceInDays>maxDateRangeLength)) {
				alert('#(..out("Date range must be between 1 and {{{VAR01}}} days.",,##class(cod.objItemName).#maxDateRangeLength))#')
				return 0;
			}
			return 1;	
		}
		
	} else {
		return 1;
	}
}

function disabling(type) {
	var grey = "#EEEEEE"
	if ((type == 'text' ) 
		|| (type =='password') 
		|| (type =='date') 
		|| (type =='dateRange') 
		|| (type =='time') 
		|| (type =='emailAddress') 
		|| (type =='multiEmailAddress') 
		|| (type =='phoneNumber') 
		|| (type =='integer') 
		|| (type =='floatingPointNumber') 
		|| (type =='webAddress')
		) {
		disableMe('txtFieldHeight');
		disableMe('selAlternative');
		disableMe('chkSearchAsYouType');
		enableMe('chkMandatory');
		enableMe('chkConcealed');
		disableMe('multiCheckboxMin');
		disableMe('multiCheckboxMax');
		hideDateRangeAvailability();
		enableMe('txtFieldWidth');
		applyOpacityStyle('butDelete');
		applyOpacityStyle('butEdit');
		applyOpacityStyle('butCode');
		applyOpacityStyle('butAddAlt');
		applyOpacityStyle('butImport');
		if (#(showGuest)# == 1) {
			enableMe('radDelegateOrGuest',1);
		}
		disableMe('radLayout');
		var defaultType='none';
		if (type=='dateRange') {
			showDateRangeAvailability();
		}
		if ((type == 'text' ) || (type =='emailAddress') || (type =='multiEmailAddress')) {
			defaultType='text';
		}
		ef.codQuestionDetails.toggleDefaultField(defaultType);
	}
	if (type == 'dropdown' ) {
		enableMe('txtFieldHeight');
		enableMe('selAlternative');
		enableMe('chkSearchAsYouType');
		enableMe('chkMandatory');
		disableMe('chkConcealed');
		disableMe('multiCheckboxMin');
		disableMe('multiCheckboxMax');
		hideDateRangeAvailability();		
		enableMe('txtFieldWidth');
		removeOpacityStyle('butDelete');
		if ('#(dataID)#' != 'NEW') {
			removeOpacityStyle("butEdit");
			removeOpacityStyle("butCode");
			removeOpacityStyle('butImport');
		} else {
			applyOpacityStyle("butEdit");
			applyOpacityStyle("butCode");
			applyOpacityStyle('butImport');
		}
		removeOpacityStyle('butAddAlt');
		
		if (#(showGuest)# == 1) {
			enableMe('radDelegateOrGuest',1);
		}
		disableMe('radLayout');
		ef.codQuestionDetails.toggleDefaultField('alternative');
	}
	if (type == 'textarea' ) {
		enableMe('txtFieldHeight');
		disableMe('selAlternative');
		disableMe('chkSearchAsYouType');
		enableMe('txtFieldWidth');
		enableMe('chkMandatory');
		enableMe('chkConcealed');
		disableMe('multiCheckboxMin');
		disableMe('multiCheckboxMax');

		applyOpacityStyle('butDelete');
		applyOpacityStyle("butEdit")
		applyOpacityStyle("butCode")

		applyOpacityStyle('butAddAlt');
		applyOpacityStyle('butImport');
		if (#(showGuest)# == 1) {
			enableMe('radDelegateOrGuest',1);
		}
		disableMe('radLayout');
		ef.codQuestionDetails.toggleDefaultField('none');
		hideDateRangeAvailability();		
	}
	if ((type == 'radiobutton' ) || (type == '1-5 scale')) {
		disableMe('txtFieldHeight');
		enableMe('selAlternative');
		disableMe('chkSearchAsYouType');
		disableMe('txtFieldWidth');
		enableMe('chkMandatory');
		disableMe('chkConcealed');
		disableMe('multiCheckboxMin');
		disableMe('multiCheckboxMax');

		removeOpacityStyle('butDelete');

		if ('#(dataID)#' != 'NEW') {
			removeOpacityStyle('butEdit');
			removeOpacityStyle('butCode');
			removeOpacityStyle('butImport');
		} else {
			applyOpacityStyle('butEdit');
			applyOpacityStyle('butCode');
			applyOpacityStyle('butImport');
		}
		removeOpacityStyle('butAddAlt');
		
		if (#(showGuest)# == 1) {
			enableMe('radDelegateOrGuest',1);
		}
		enableMe('radLayout');
		ef.codQuestionDetails.toggleDefaultField('alternative');
		hideDateRangeAvailability();		
	}
	if (type == 'checkbox' ) {
		disableMe('txtFieldHeight');
		disableMe('selAlternative');
		disableMe('chkSearchAsYouType');
		disableMe('txtFieldWidth');
		enableMe('chkMandatory');
		disableMe('multiCheckboxMin');
		disableMe('multiCheckboxMax');
		disableMe('chkConcealed');

		applyOpacityStyle('butDelete');
		applyOpacityStyle('butEdit');
		applyOpacityStyle('butCode');
		applyOpacityStyle('butAddAlt');
		applyOpacityStyle('butImport');
		if (#(showGuest)# == 1) {
			enableMe('radDelegateOrGuest',1);
		}
		disableMe('radLayout');
		ef.codQuestionDetails.toggleDefaultField('none');
		hideDateRangeAvailability();		
	}
	if (type == 'multibox' ) {
		disableMe('txtFieldHeight');
		enableMe('selAlternative');
		disableMe('chkSearchAsYouType');
		disableMe('txtFieldWidth');
		disableMe('chkMandatory');
		enableMe('multiCheckboxMin');
		enableMe('multiCheckboxMax');
		disableMe('chkConcealed');

		removeOpacityStyle('butDelete');
		if ('#(dataID)#' != 'NEW') {
			removeOpacityStyle('butEdit');
			removeOpacityStyle('butCode');
		} else {
			applyOpacityStyle('butEdit');
			applyOpacityStyle('butCode');
		}
		removeOpacityStyle('butAddAlt');
		removeOpacityStyle('butImport');
		if (#(showGuest)# == 1) {
			if (typeof document.myform['radDelegateOrGuest'] != "undefined") {
				document.myform['radDelegateOrGuest'][0].checked=true;
				disableMe('radDelegateOrGuest',1)
			}
		}
		enableMe('radLayout');
		ef.codQuestionDetails.toggleDefaultField('none');
		hideDateRangeAvailability();	
	}
}

function disableOnLoad() {

	var grey = "#EEEEEE"
	if ('#(itemNameID)#' == 'NEW') {
		disableMe('chkMandatory');
		disableMe('chkCarryOver');
		if (#(showGuest)# == 1) {
			disableMe('radDelegateOrGuest');
		}
		disableMe('selType');
		disableMe('chkSearchAsYouType');
		disableMe('txtPrompt');
		disableMe('selDependsOnDataID');
		disableMe('selDependsOnCodAltID');
		disableMe('txtFieldHeight');
		disableMe('txtFieldWidth');
		disableMe('selAlternative');
		ef.codQuestionDetails.toggleDefaultField('none');
		hideDateRangeAvailability();

		if (attendeeCategories==1) {
			disableMe('chkPriceByAttendeeCategory');
		}

		disableMe('txtHelpText');

		removeOpacityStyle('butCreateNew');
		applyOpacityStyle('butDelete');
		applyOpacityStyle('butEdit');
		applyOpacityStyle('butCode');
		applyOpacityStyle('butAddAlt');
		applyOpacityStyle('butImport');

		disableMe('radLayout');
		if (typeof document.myform['lookup_phrase'] != "undefined") {
			document.myform['lookup_phrase'].focus();
		}
	} else if ('#(itemNameID)#' == 'CREATE') {
		disableMe('lookup_phrase');
		disableMe('selCODitem');
		hideDateRangeAvailability();		
		applyOpacityStyle('butCreateNew');
		enableMe('txtDescription');
		applyOpacityStyle('butEdit');
		applyOpacityStyle('butCode');
		if (attendeeCategories==1) {
			disableMe('chkPriceByAttendeeCategory');
		}
		if (typeof document.myform['txtDescription'] != "undefined") {
			document.myform['txtDescription'].value='#(%request.Get("typedText"))#';
			document.myform['txtDescription'].focus();
		}
		if (typeof document.myform['txtPrompt'] != "undefined") {
			document.myform['txtPrompt'].value='#(%request.Get("typedText"))#';
		}
	} else {
		hideDateRangeAvailability();			
		enableMe('chkMandatory');
		enableMe('chkCarryOver');
		if (#(showGuest)# == 1) {
			if (#(type'="multibox")# == 1) {
				enableMe('radDelegateOrGuest');
			}
		}
		if (#(type="dateRange")# == 1) {
			showDateRangeAvailability();
		}
				
		enableMe('selType');
		enableMe('chkSearchAsYouType');
		enableMe('txtPrompt');
		enableMe('selLayout');
		enableMe('selDependsOnDataID');
		enableMe('selDependsOnCodAltID');
		enableMe('txtFieldHeight');
		enableMe('txtFieldWidth');
		enableMe('selAlternative');
		enableMe('txtAddAlternative');
		enableMe('txtHelpText');

		removeOpacityStyle('butDelete');

		if ('#(dataID)#' != 'NEW') {
			removeOpacityStyle('butEdit');
			removeOpacityStyle('butCode');
		} else {
			applyOpacityStyle('butEdit');
			applyOpacityStyle('butCode');
		}
		removeOpacityStyle('butAddAlt');

		if ('#(%request.Get("loadItem"))#' == 'true') {
			if (attendeeCategories==1) {
				disableMe('chkPriceByAttendeeCategory');
			}
		}
		removeOpacityStyle('butImport');
	}
}

function updateAlts(codPromptID,itemAlternativeID) {
	document.forms[0].selDependsOnCodAltID.options.length=0;
	if (codPromptID != '') {
		// populate the alternatives list box from the javascript array

		for (var i = 0; i < (alts[codPromptID].length); i++) {
			var tmp = alts[codPromptID][i].split('|');
			document.forms[0].selDependsOnCodAltID.options[i] = new Option(tmp[1],tmp[0])
		}
	}
}
$(function() {
	$("#butImport").click( function() {
		if ($("#selAlternative").prop('disabled') == false ) {
			$("#gotoCodQuestionCSV").val("1");
			selectAll();
			document.forms[0].submit();
		}
	});
});

function toggleAttendeeCategory() {
	document.forms[0].togglePriceByAttendeeCategory.value='1';
	document.forms[0].submit();
}

function saveSameAs(categoryID) {
	document.forms[0].updateSameAs.value=categoryID;
	document.forms[0].submit();
}

</script>
<csp:if condition=(%request.Get("gotoCodQuestionCSV"))>
	<script language="cache" runat="server">
		set popupURL=..Link("codQuestionCSV.csp?additional="_..encodeForURL(additional)_"&dataID="_..encodeForURL(dataID))
		kill %session.Data("eventsforce","backend","popupURL")
	</script>
	<script language='javascript'>
	// Open a popup if we just pass thru the save after clicking a Import button
	$(function() {
		ef.admin.openPopupWindow("#(..encodeForJavaScript(popupURL))#");
	});
	</script>
</csp:if>
<systemType:if module="Ticketing">
<csp:if condition=(quantityItem)>
	<csp:if condition=(hasPricing)>
	<script language="cache" runat="server">
		// output javascript for enabled and disabling the price controls
		write !,"<SCR"_"IPT LANGUAGE='javasc"_"ript'>"
		for i=1:1 {
			if '$d(arrayPrices(i)) quit
			set eventCategoryID=$p(arrayPrices(i),"|",5)
			write !,"function updatePricing_",eventCategoryID,"() {"
			write !,"if (document.forms[0].radPriceType_",eventCategoryID,"[2].checked == true) {"
			write !,"	if (typeof document.forms[0].txtDirectPrice_",eventCategoryID," != 'undefined') {"
			write !," document.forms[0].txtDirectPrice_",eventCategoryID,".value='';"
			write !," }"
			write !,"	disableMe('txtDirectPrice_",eventCategoryID,"');"
			write !,"	disableMe('selCurrency_",eventCategoryID,"');"
			write !,"	enableMe('selPriceDescriptor_",eventCategoryID,"');"
			write !,"} else if (document.forms[0].radPriceType_",eventCategoryID,"[1].checked == true) {	"
			write !,"	enableMe('txtDirectPrice_",eventCategoryID,"');"
			write !,"	enableMe('selCurrency_",eventCategoryID,"');"
			write !,"	disableMe('selPriceDescriptor_",eventCategoryID,"');"
			write !,"} else if (document.forms[0].radPriceType_",eventCategoryID,"[0].checked == true) {	"
			write !,"	if (typeof document.forms[0].txtDirectPrice_",eventCategoryID," != 'undefined') {"
			write !," document.forms[0].txtDirectPrice_",eventCategoryID,".value='';"
			write !," }"
			write !,"	disableMe('txtDirectPrice_",eventCategoryID,"');"
			write !,"	disableMe('selCurrency_",eventCategoryID,"');"
			write !,"	disableMe('selPriceDescriptor_",eventCategoryID,"');"
			write !,"}	"
			write !,"}"
			write !,"updatePricing_",eventCategoryID,"();"
		}
		write !,"</scri"_"pt>"
	</script>
	</csp:if>
	<script language='javascript'>
		function updateAttendeeCategory()	{
			var createsAttendees=0
			// special as this field can be a hidden field
			if (document.forms[0].chkqCreatesAttendees.type=='checkbox')	{
				if (document.forms[0].chkqCreatesAttendees.checked == true) createsAttendees=1;
			} else {
				if (document.forms[0].chkqCreatesAttendees.value == 1) createsAttendees=1;
			}

			if (createsAttendees)	{
				enableMe('selqAttendeeCategory');
				ob=document.getElementById("divTicketingPricingCapacity");
				ob.style.display='none';
				ob=document.getElementById("divTicketingCreateAttendees");
				ob.style.display='block';
			} else {
				disableMe('selqAttendeeCategory');
				ob=document.getElementById("divTicketingPricingCapacity");
				ob.style.display='block';
				ob=document.getElementById("divTicketingCreateAttendees");
				ob.style.display='none';
			}
		}
		updateAttendeeCategory();
	</script>
</csp:if>
</systemType:if>

<script language='javascript'>

	// disable all field on load new
	disableOnLoad();

	// disable some field depending on type
	if ('#(itemNameID)#' != 'NEW') {
		disabling(document.forms[0].selType.options[document.forms[0].selType.selectedIndex].value);
	}

</script>
<csp:include page="../../backend/home/backendBottom.csp">
]]></CSP>


<CSP name="backEnd/proweb/codQuestionDetails2.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	do ##class(shared.pageMethods).createBackendVariables()

	set dataID=%request.Get("dataID")
	set itemNameID=%request.Get("itemNameID")
	set parent=%request.Get("parent")
	set xWorkLangID = $Get(%session.Data("eventsforce","backend","xWorkLangID"))
	set pageID=%request.Get("pageID")
	
	set isQuantityItem=%request.Get("quantityItem")
	set isAdditionalItem=%request.Get("additional")
	
	do ##class(sc.methods).updateBackendVariablesFromPageID(pageID)
	
	set newCodQuestionDetailsURL="codQuestionDetails.csp?pageID="_..encodeForURL(pageID)_"&dataID="_..encodeForURL(dataID)_"&quantityItem="_..encodeForURL(isQuantityItem)_"&additional="_..encodeForURL(isAdditionalItem)
	set codQuestionDetailsURL=newCodQuestionDetailsURL_"&itemNameID="_..encodeForURL(itemNameID)
	set errorURL=codQuestionDetailsURL

	// get the current values, used to compare against for audit trail purposes
	set (dependsOnPromptExisting,dependsOnAlternativeExisting,backendOnlyExisting,requiredAnswerExisting,validationErrorMessageExisting,noAmendmentsExisting,readonlyFrontendExisting)=""
	if dataID	{
		&SQL(SELECT 
			dependsOnPrompt,
			dependsOnAlternative,
			backendOnly,
			requiredAnswer,
			validationErrorMessage,
			noAmendments,
			readonlyFrontend
			INTO 
			:dependsOnPromptExisting,
			:dependsOnAlternativeExisting,
			:backendOnlyExisting,
			:requiredAnswerExisting,
			:validationErrorMessageExisting,
			:noAmendmentsExisting,
			:readonlyFrontendExisting
			FROM sc_xModules.objCODitem WHERE ID = :dataID)
	}
	set mandatory=%request.Get("chkMandatory")
	set concealed=+%request.Get("chkConcealed")	
	
	set questionText=%request.Get("txtPrompt")


	// make any custom created firstname & lastname prompts mandatory, fix the twisted workflow of Organizers (SF CASE #00020967)
	set alwaysMandatory=0
	if $ZCVT(%request.Get("txtDescription"),"L")="firstname" set alwaysMandatory=1
	if $ZCVT(%request.Get("txtDescription"),"L")="lastname" set alwaysMandatory=1
	if (alwaysMandatory) {
		set mandatory=1
	}
								
	set (pageName,languageID)=""
	&SQL(SELECT description,objLanguage INTO :tmp,:tmp2 FROM sc_xModules.objPage WHERE ID = :pageID)
	if +SQLCODE=0 set pageName=tmp,languageID=tmp2

	if isQuantityItem {
		set createsAttendees=+%request.Get("chkqCreatesAttendees"),attendeeCategoryID=%request.Get("selqAttendeeCategory")
		if createsAttendees {
			//check if accommodation is ON, then, do not allow real attendees to be created.
			if (##class(setup.objEventSetting).getParameter("bookings","allow accommodation bookings",xEventID)) {
				set %session.Data("proweb","backend","errMsg")=..out("Real attendees in QBIs cannot be created if the Accommodation module has been activated.")
				set %response.Redirect=errorURL_"&isCOD="_..encodeForURL(%request.Get("isCOD"))_"&quantityItem=1"
				quit 0
			}			

			if ##class(cod.objTicket).anyOtherCreateAttendeeQuestions(xEventID,attendeeCategoryID,dataID,languageID) {
				set %session.Data("proweb","backend","errMsg")="There is already a question that creates attendees for this attendee category."
				set %response.Redirect=errorURL_"&isCOD="_..encodeForURL(%request.Get("isCOD"))_"&quantityItem=1"
				quit 0
			}
			if ##class(setup.objEventSetting).getParameter("table bookings","enable frontend",xEventID) {
				set %session.Data("proweb","backend","errMsg")="Attendees cannot be created for an event with table bookings."
				set %response.Redirect=errorURL_"&isCOD="_..encodeForURL(%request.Get("isCOD"))_"&quantityItem=1"
				quit 0
			}
		}
	}
	
	set addToTop=%request.Get("addToTop")
	set addToTop=$S(addToTop="true":1,1:0)
	set codGroup=%request.Get("codGroup")   
	set eventHotelID=%request.Get("eventHotelID")     
	set (isDelegate,isGuest)=""
	if %request.Get("radDelegateOrGuest")="delegate" set isDelegate=1
	if %request.Get("radDelegateOrGuest")="guest" set isGuest=1
	if %request.Get("radDelegateOrGuest")="both" set isDelegate=1,isGuest=1
	if 'isDelegate,'isGuest {
		// This should never happen, but has. Set isDelegate=1 and log the details
		set isDelegate=1
	}

	// stop them entering only one alternative, can never be right but only if radio (as sometimes needed for drop downs)
	 if %request.Get("selType")="radiobutton",$L(%request.Get("txtAlternatives"),"|")=2 { 
		set %session.Data("proweb","backend","errMsg")=..out("You have only entered one alternative, please add more or consider a different question type")
		set %response.Redirect=errorURL
		quit 0
	}
	
	// check that any deleted alternatives have not been purchased in this event or any other
	set hasBeenPurchased=0
	set delAlts=%request.Get("txtDeletedAlternatives")
	for i=1:1:$L(delAlts,"|") {
		set id=$p(delAlts,"|",i)
		if '##class(cod.objItemAlternatives).canAlternativeBeDeleted(id,.reason) {
			set %session.Data("proweb","backend","errMsg")=reason
			set %response.Redirect=errorURL
			return 0	
		}
	}
	
	// verify the min and max number of checkboxes
	if %request.Get("multiCheckboxMax"),%request.Get("multiCheckboxMin"),%request.Get("multiCheckboxMax")<%request.Get("multiCheckboxMin") {
		set %session.Data("proweb","backend","errMsg")=..out("Maximum number of checked alternatives must be more or the same as the minimum number.")
		set %response.Redirect=errorURL
		quit 0
	}
	
	// if dateRange type, make sure we have both end of Range and the range is no longer than 30 days.
	set minDateRange=""
	set maxDateRange=""
	if (%request.Get("selType")="dateRange") {
		set minDateRange=##class(shared.dateFunctions).multiDate(%request.Get("dateRangeStart"),25,,xUserInputDateFormat)
		set maxDateRange=##class(shared.dateFunctions).multiDate(%request.Get("dateRangeEnd"),25,,xUserInputDateFormat)
		if ('$L(minDateRange)) {
			set %session.Data("proweb","backend","errMsg")=..out("Date range start date is not valid.")
			set %response.Redirect=errorURL
			quit 0			
		} elseif ('$L(maxDateRange)) {
			set %session.Data("proweb","backend","errMsg")=..out("Date range end date is not valid.")
			set %response.Redirect=errorURL
			quit 0				
		} elseif ($SYSTEM.SQL.DATEDIFF("day",minDateRange,maxDateRange)<0) {
			set %session.Data("proweb","backend","errMsg")=..out("Date range end date must be after the start date.")
			set %response.Redirect=errorURL
			quit 0
		} elseif ($SYSTEM.SQL.DATEDIFF("day",minDateRange,maxDateRange)>##class(cod.objItemName).#maxDateRangeLength) {
			set %session.Data("proweb","backend","errMsg")=..out("Date range must be between 1 and {{{VAR01}}} days.",,##class(cod.objItemName).#maxDateRangeLength)
			set %response.Redirect=errorURL
			quit 0
	
		}
	}
	
	
	set requiredAnswer=##class(EF.sanitiser).removeRepeatedWhiteSpace(%request.Get("requiredAnswer"))
	set validationErrorMessage=%request.Get("validationErrorMessage")
	set okToSave=1
	if $e(requiredAnswer,1,2)="##" {
		set okToSave=0
		// Validate bespoke callouts
		set callOutMethod=$e(requiredAnswer,3,$l(requiredAnswer))
		if callOutMethod?1A.AN {
			set callOutMethod="customCode.codAnswerValidation."_##class(shared.callOuts).classNameForBespokeCode()_"."_callOutMethod
			if ##class(%MethodDefinition).%OpenId(callOutMethod).ClassMethod {
				set okToSave=1
			}
		}
		if 'okToSave {
			set %session.Data("proweb","backend","errMsg")=..out("The custom validation specifies an invalid call out method.")
		}	
	}
	if requiredAnswer?1"#"1.AN {
		if requiredAnswer="#personRegisteredWithSameAnswer" {
			if (%request.Get("selType")="multibox") ! (%request.Get("selType")="dateRange") ! (%request.Get("selType")="checkbox") ! (%request.Get("selType")="radiobutton") {
				set %session.Data("proweb","backend","errMsg")="Custom validation #personRegisteredWithSameAnswer has been removed as it cannot be used with this question type"
				set okToSave=0	
			}
		} else {
			set %session.Data("proweb","backend","errMsg")=..out("Invalid custom validation, please enter an answer or pattern that must be matched, or a valid custom validation method starting with '#'")
			set okToSave=0	
		}
	}
	if 'okToSave {
		set %response.Redirect=errorURL
		quit 0
	}	
	set dependsOnPrompt=%request.Get("selDependsOnDataID")
	if dependsOnPrompt {
		if isDelegate {
			set isDependentParentForGuests=##class(sc.methods).isGuestItem(dependsOnPrompt)
			if isDependentParentForGuests {
				set %session.Data("proweb","backend","errMsg")=..out("You cannot make an attendee prompt dependent on a guest prompt")
				set %response.Redirect=errorURL
				quit 0
			}
		}
	}
	set defaultValue=""
	if $Length(%request.Get("txtAlternatives")) {
		set defaultValue=%request.Get("defaultValueAlt")	
	} else {
		set defaultValue=%request.Get("defaultValueText")
	}
	set copyValueFromBooker=%request.Get("chkCopyFromBooker")
	if copyValueFromBooker set defaultValue=""
	
	if $l(defaultValue) {
		set isDefaultValid=$CASE($ZCVT(%request.Get("selType"),"L"),
			"emailaddress":##class(EF.utils.dataValidation).isValidEmailAddress(defaultValue),
			"multiemailaddress":##class(EF.utils.dataValidation).isValidMultiEmailAddress(defaultValue),
			:1
		)
		if 'isDefaultValid {
			set %session.Data("proweb","backend","errMsg")=..out("Please enter a valid default value.")
			set %response.Redirect=errorURL
			quit 0
		}
	}
		
	// create new proweb item
	set carryOver=$S(%request.Get("radAnswerAppliesTo")="allEvents":1,1:0)
			
	set isQuestionForSingleEvent=$S(%request.Get("radQuestionAvailability")="singleEvent":1,1:0)
	
	if carryOver&&isQuestionForSingleEvent {
		set %session.Data("proweb","backend","errMsg")=..out("You cannot have a single event question with answers that apply to all events")
		set %response.Redirect=errorURL
		quit 0
	}
	
	// if %session.Data("proweb","isSurvey") is set, we are entering a survey question. So, just change the codGroup to 'Survey';
	if $G(%session.Data("proweb","isSurvey"))=1 set codGroup = "Survey"
	
	set reportDescription=%request.Get("reportDescription")		
	
	set email=##class(cod.objItemData).get($G(%session.Data("eventsforce","backend","xPersonID")),"email")
	if dataID="NEW" {
		if isAdditionalItem {
			kill allRegPageIDs
			kill alreadyUsedQuestions
			set ok = ##class(setup.lnkCategoryEvent).getAllRegPages(xEventID, xWorkLangID, 1,, .allRegPageIDs)
			if ok {
				do ##class(cod.methods).loadUsedQuestions(pageID,,, .alreadyUsedQuestions, .allRegPageIDs)
				if $Data(alreadyUsedQuestions(itemNameID)) {
					set %session.Data("proweb", "backend", "errMsg") = "The changes can't be saved because the additional bookable item already exists on this registration page."
					kill %session.Data("itemNameID")
		 			set %response.Redirect = newCodQuestionDetailsURL
		 			return 0
				}
			}
	 	}
		if itemNameID="CREATE" {
			// new data and new cod
			// create new cod item
			if codGroup="" set codGroup="Additional"   // optional pass in value now. 
			set description=%request.Get("txtDescription")
			
			if $G(%session.Data("templateURL"))["tAdditionalRegistration.csp"  {
				// add the page name to the cod prompt if we are doing additional registration pages
				 &SQL(SELECT description INTO :pageName FROM sc_xModules.objPage WHERE ID = :pageID)				
				 set description=pageName_"|"_description
			}
			if codGroup'="Hotel" set eventHotelID=""  //  only allow the eventHotel link to be created if we're creating a hotel prompt
			if eventHotelID set description="HOTEL_"_eventHotelID_"_"_description
			
			// password field should be stored as a text field in the COD, it's only a display issue. 
			set tmpType=%request.Get("selType")
			if tmpType="password" set tmpType="text"
			if tmpType="1-5 scale" set tmpType="radiobutton"
			
			set errMsg=""
			// ensure that the database name is free from invalid characters.
			if ##class(cod.objItemName).anyInvalidCharactersInName(description) {
				set errMsg="Only letters, numbers, underscores and spaces are allowed for the database name. Please try again."
			}
			if '$L(errMsg) {
				// make sure it doesn't exist already
				if isQuestionForSingleEvent {
					if '##class(cod.objItemName).isNameValidForNewSingleEventQuestion(description,xEventID,.tmpMsg) {
						set errMsg=tmpMsg
					}
				} else {
					if '##class(cod.objItemName).isNameValidForNewCrossEventQuestion(description,.tmpMsg) {
						set errMsg=tmpMsg
					}	
				}
			}
			
			if '$L(errMsg) && (tmpType="dateRange")&&('isQuestionForSingleEvent) {
				set errMsg="Date range questions must only apply to a single event."
			}
			if $l(errMsg) {
				set %session.Data("proweb","backend","errMsg")=errMsg
				set %response.Redirect=errorURL
				quit 0		
			}
			
			try {
				if isQuestionForSingleEvent {
					set itemNameID=##class(cod.objItemName).addSingleEventQuestion(description,tmpType,codGroup,xEventID)
				} else {
					set itemNameID=##class(cod.objItemName).add(description,mandatory,tmpType,codGroup,,,carryOver,eventHotelID)
				}
			} catch error {
				set %session.Data("proweb","backend","errMsg")=error.DisplayString()	
				set %response.Redirect=errorURL
				return 0
			}
			
			// log it to the event audit trail
			if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Added new database item: "_description_", "_tmpType)
		}	
			
		// new data and existing cod item
		set layout=%request.Get("radLayout")
		if layout="" set layout="horizontal"
		
		
		// make multiple checkboxes that have a minimum number of checks mandatory
		if %request.Get("multiCheckboxMin") set mandatory=1
		
		if (%request.Get("txtFieldWidth")'?.N) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Field width"" must be a number"
			set %response.Redirect = errorURL
			return 0
		}
		
		if (%request.Get("txtFieldHeight")'?.N) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Height"" must be a number"
			set %response.Redirect = errorURL
			return 0
		}

		set dataID=##class(sc.xModules.objCODitem).add(itemNameID,questionText,parent,email,addToTop,%request.Get("txtHelpText"),%request.Get("selType"),mandatory,layout,%request.Get("txtFieldWidth"),%request.Get("txtFieldHeight"),isDelegate,isGuest,"",isAdditionalItem,,isQuantityItem,reportDescription)

		// log it to the event audit trail
		set codItemNameDescription=##class(cod.objItemName).getDescFromID(itemNameID)
		if isAdditionalItem {
			if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Added new Additional Booking Item: "_questionText_" ("_codItemNameDescription_"), "_%request.Get("selType")_", "_$S(mandatory:"Mandatory",1:"Not Mandatory"))
		} else {	
			if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Added new Registration Question: "_questionText_" ("_codItemNameDescription_"), "_%request.Get("selType")_", "_$S(mandatory:"Mandatory",1:"Not Mandatory"))
		}

		// Add new, dependend children right underneath their parent
		set dependsOnAlternative=%request.Get("selDependsOnCodAltID")
		if (dependsOnPrompt&&dependsOnAlternative) { //  only save as dependent if we have both a dependent question and a required answer
			&SQL(SELECT displayOrder,parent INTO :parentDisplayOrder,:depParentID FROM sc_xModules.objCODitem WHERE ID = :dependsOnPrompt)
			if +SQLCODE=0,dataID,depParentID'=parent { // Don't update display order if the dependent question list is different from this one.
				set lastPos=parentDisplayOrder
				
				// find the last dependend child
				&SQL(SELECT displayorder INTO :lastChild FROM sc_xModules.objCODitem WHERE (dependsOnPrompt = :dependsOnPrompt) AND (parent=:parent) ORDER BY displayOrder DESC)
				if +SQLCODE=0,lastChild set lastPos=lastChild
				// Also check text blocks
				&SQL(SELECT displayorder INTO :lastChild FROM sc_xModules.objText WHERE (dependsOnPrompt = :dependsOnPrompt) AND (parent=:parent) ORDER BY displayOrder DESC)
				if +SQLCODE=0,lastChild>lastPos {
					set lastPos=lastChild
				}
				
				// move all the subsequent items one step down
				&SQL(UPDATE sc.objData SET displayOrder = displayOrder+1 WHERE (parent = :parent) AND (displayOrder > :lastPos))
				
				// move the new item to right after the parent	
				&SQL(UPDATE sc_xModules.objCODitem SET displayOrder = :lastPos + 1 WHERE ID = :dataID)
			}
		} else {
			do ##class(EF.pages.frontend.baseProweb).moveNewElementToDesiredPosition()				
		}
		


	} else {  
		// existing objData
		if itemNameID="NEW" {
			// don't allow this
					
		} else {
			// existing cod item
			set layout=%request.Get("radLayout")
			if layout="" set layout="horizontal"
			set mandatory=%request.Get("chkMandatory")
			// make multiple checkboxes that have a minimum number of checks mandatory
			if %request.Get("multiCheckboxMin") set mandatory=1	

			do ##class(sc.xModules.objCODitem).update(dataID,questionText,email,%request.Get("txtHelpText"),%request.Get("selType"),mandatory,layout,%request.Get("txtFieldWidth"),%request.Get("txtFieldHeight"),isDelegate,isGuest,"",reportDescription)
			// log to event audit trail
			if xEventID do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Saved Registration Question: "_questionText_", "_%request.Get("selType")_", "_$S(mandatory:"Mandatory",1:"Not Mandatory"))
		}
	
	}
	
	set question=##class(sc.xModules.objCODitem).%OpenId(dataID)
	if $IsObject(question) {
		do question.%Reload()
		set question.searchAsYouType = %request.Get("chkSearchAsYouType")
		do question.%Save()
		kill question
	}
	
	set codItemNameDescription=##class(cod.objItemName).getDescFromID(itemNameID)
	&SQL(UPDATE cod.objItemName SET concealed = :concealed WHERE ID = :itemNameID)
	
	set itemNameType=##class(cod.objItemName).getTypeById(itemNameID)
	if itemNameType="dateRange" {
		set lnkItemNameEvent=##class(cod.lnkItemNameEventDateRange).getLnkItemNameEvent(itemNameID,xEventID)
		if '$ISOBJECT(lnkItemNameEvent) {
			set lnkItemNameEvent=##class(cod.lnkItemNameEventDateRange).%New()
			do lnkItemNameEvent.objEventSetObjectId(xEventID)
			do lnkItemNameEvent.objItemNameSetObjectId(itemNameID)
		}
		set lnkItemNameEvent.minTimeStamp=minDateRange
		set lnkItemNameEvent.maxTimeStamp=maxDateRange
		do lnkItemNameEvent.%Save()
	}
	
	// add ticketing
	if isQuantityItem {
		set useVatCodes=##class(eCom.objVatCode).isVatCodesEnabled()
		set priceByAttendeeCategory=+%request.Get("chkPriceByAttendeeCategory")
		set togglePriceByAttendeeCategory=%request.Get("togglePriceByAttendeeCategory")
		set createsAttendees=+%request.Get("chkqCreatesAttendees"),attendeeCategoryID=%request.Get("selqAttendeeCategory")
		set qCapacity=%request.Get("txtqCapacity"),qNoMoreBookings=+%request.Get("chkqNoMoreBookings")
		set qNotification=+%request.Get("chkqNotification"),qNotificationLevel=%request.Get("txtqNotificationLevel")
		set directPrice=%request.Get("txtDirectPrice")
		set directPrice=$TR(directPrice,",","")
		set currencyID=%request.Get("selCurrency")
		set priceDescriptorID=%request.Get("selPriceDescriptor")
		set showBookingLevel=+%request.Get("chkqShowBookingLevel")
		set qMin=+%request.Get("txtqMin"),qMax=+%request.Get("txtqMax")
		
		if (qMin'?.N) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Optional booking levels - minimum"" must be a number"
			set %response.Redirect = errorURL
			return 0
		}
		if (qMax'?.N) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Optional booking levels - maximum"" must be a number"
			set %response.Redirect = errorURL
			return 0
		}
		if (qCapacity'?.N) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Capacity"" must be a number"
			set %response.Redirect = errorURL
			return 0
		}
		if (($Length(qNotificationLevel)) && ('$ISVALIDNUM(qNotificationLevel))) {
			set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Level"" must be a number"
			set %response.Redirect = errorURL
			return 0
		}
		
		set ticketID=##class(cod.objTicket).getTicketIDfromDataID(dataID)
		if ticketID	{
			do ##class(cod.objTicket).update(ticketID,xEventID,xControllerID,createsAttendees,attendeeCategoryID,qCapacity,qNoMoreBookings,qNotification,qNotificationLevel,showBookingLevel,qMin,qMax,priceByAttendeeCategory)
		} else {
			set ticketID=##class(cod.objTicket).add(dataID,xEventID,xControllerID,createsAttendees,attendeeCategoryID,qCapacity,qNoMoreBookings,qNotification,qNotificationLevel,showBookingLevel,qMin,qMax,priceByAttendeeCategory)
		}
		
		// create array of selected discounts
		set item="chkDiscount"
		kill checked
		// get all the checked ones
		for  {
			set item=$o(%request.Data(item)) q:item=""!(item'["chkDiscount")
			set checked($P(item,"_",2),+$P(item,"_",3))=""
		}
		
		// update the price
		set count=0
		if priceByAttendeeCategory {
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs.Prepare("SELECT objEventCategory->description,objEventCategory FROM setup.lnkCategoryEvent WHERE (objEvent=?) AND (active=1) AND (langID=?) GROUP BY objEventCategory ORDER BY isDefault DESC,objEventCategory->description")
			do rs.Execute(xEventID,xLangID)
			while rs.Next() {
				set count=count+1
				set eventCategoryID=rs.Get("objEventCategory")
				if count=1 set defaultID=eventCategoryID
				set directPrice=%request.Get("txtDirectPrice_"_eventCategoryID)
				set directPrice=$TR(directPrice,",","")
				set currencyID=%request.Get("selCurrency_"_eventCategoryID)
				set priceDescriptorID=%request.Get("selPriceDescriptor_"_eventCategoryID)
				set sameAs=%request.Get("selSameAs_"_eventCategoryID)
				set vatCodeID=%request.Get("selVatCode_"_eventCategoryID)				
				set basketItemID=##class(links.lnkCategoryItemBasketItem).getTicketLinkedBasketItem(ticketID,eventCategoryID)
				if basketItemID="",eventCategoryID'=defaultID set sameAs=defaultID
				// use any existing basketItem if we had one from before or create new one
				if basketItemID="" {
					// create new
					//  Add Property to link objBasketItem to the related object
					set basketItemID=##class(eCom.objBasketItem).add(priceDescriptorID,xControllerID,"quantityitem",,,ticketID)
					do ##class(cod.objTicket).updateBasketItem(ticketID,basketItemID,eventCategoryID)
					set ok=##class(links.lnkCategoryItemBasketItem).updateTicketLink(ticketID,eventCategoryID,sameAs)
				}
				if 'togglePriceByAttendeeCategory {
					set ok=##class(links.lnkCategoryItemBasketItem).updateTicketLink(ticketID,eventCategoryID,sameAs)
					if eventCategoryID'=%request.Get("updateSameAs") {
						do ##class(eCom.objBasketItem).updatePrices(.basketItemID,directPrice,priceDescriptorID,currencyID)
	
						set rs1=##class(%ResultSet).%New("eCom.objDiscount:qAllDiscounts")
						do rs1.Execute(xLangID,xControllerID)
						while rs1.Next() {
							set discID=rs1.Get("objDiscount")
							
							if $D(checked(discID,+eventCategoryID)) { //it's checked
								if '##class(eCom.lnkItemDiscount).exists(basketItemID,discID) { // it doesn't exist, create it
									set objLink=##class(eCom.lnkItemDiscount).%New()
									do objLink.objBasketItemSetObjectId(basketItemID)
									do objLink.objDiscountSetObjectId(discID)
									set ok=objLink.%Save()
								}
								
							} else { // it's not checked 
								if ##class(eCom.lnkItemDiscount).exists(basketItemID,discID) { // it exists, remove it
									set linkID=##class(eCom.lnkItemDiscount).returnLinkID(basketItemID,discID)
									do ##class(eCom.lnkItemDiscount).%DeleteId(linkID)
								}
							}
						}
					}
					if useVatCodes {
						&SQL(UPDATE eCom.objBasketItem set objVatCode=:vatCodeID WHERE ID=:basketItemID)
					}
				}
				// update costs
				set initialCost=%request.Get("initialCost_"_eventCategoryID)
				set unitCost=%request.Get("unitCost_"_eventCategoryID)
				&SQL(UPDATE eCom.objBasketItem set unitCost=:unitCost,initialCost=:initialCost WHERE ID=:basketItemID)			
			}
		} else {
			set basketItemID=##class(cod.objTicket).getBasketItemID(ticketID)
			set directPrice=%request.Get("txtDirectPrice_")
			set directPrice=$TR(directPrice,",","")
			set currencyID=%request.Get("selCurrency_")
			set priceDescriptorID=%request.Get("selPriceDescriptor_")
			set vatCodeID=%request.Get("selVatCode_")
			if basketItemID="" {
				// create new
				//  Add Property to link objBasketItem to the related object
				set basketItemID=##class(eCom.objBasketItem).add(priceDescriptorID,xControllerID,"quantityitem",,,ticketID)
				do ##class(cod.objTicket).updateBasketItem(ticketID,basketItemID,"")
			}
			if 'togglePriceByAttendeeCategory {
				do ##class(eCom.objBasketItem).updatePrices(basketItemID,directPrice,priceDescriptorID,currencyID)
				set rs1=##class(%ResultSet).%New("eCom.objDiscount:qAllDiscounts")
				do rs1.Execute(xLangID,xControllerID)
				while rs1.Next() {
					set discID=rs1.Get("objDiscount")
					
					if $D(checked(discID,0)) { //it's checked
						if '##class(eCom.lnkItemDiscount).exists(basketItemID,discID) { // it doesn't exist, create it
							set objLink=##class(eCom.lnkItemDiscount).%New()
							do objLink.objBasketItemSetObjectId(basketItemID)
							do objLink.objDiscountSetObjectId(discID)
							set ok=objLink.%Save()
						}
						
					} else { // it's not checked 
						if ##class(eCom.lnkItemDiscount).exists(basketItemID,discID) { // it exists, remove it
							set linkID=##class(eCom.lnkItemDiscount).returnLinkID(basketItemID,discID)
							do ##class(eCom.lnkItemDiscount).%DeleteId(linkID)
						}
					}
				}
				// update VAT Code
				if useVatCodes {
					&SQL(UPDATE eCom.objBasketItem set objVatCode=:vatCodeID WHERE ID=:basketItemID)
				}
			}
			// update costs
			set initialCost=%request.Get("initialCost_")
			set unitCost=%request.Get("unitCost_")
			&SQL(UPDATE eCom.objBasketItem set unitCost=:unitCost,initialCost=:initialCost WHERE ID=:basketItemID)		
		}
		
		// save the ecternal item codes
		if ##class(setup.objSystemTypes).isModuleAllowed("External Item Codes") {
			// save the account codes in all basketItems
			set extItemCode=%request.Get("txtExtItemCode")
			set extItemCode2=%request.Get("txtExtItemCode2")
	
			// update the main delegate basketItem
			set basketItemID=""
			&SQL(SELECT basketItemID INTO :tmp FROM cod.objTicket WHERE ID=:ticketID)
			if +SQLCODE=0 set basketItemID=tmp
			&SQL(UPDATE eCom.objBasketItem SET extItemCode=:extItemCode,extItemCode2=:extItemCode2
				WHERE ID=:basketItemID
			)
			// update for attendee categories
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs.Prepare("SELECT * FROM links.lnkCategoryItemBasketItem WHERE (objTicket=?)")
			do rs.Execute(ticketID)
			while rs.Next() {
				set basketItemID=rs.Get("objBasketItem")
				&SQL(UPDATE eCom.objBasketItem
					SET extItemCode=:extItemCode,extItemCode2=:extItemCode2
					WHERE ID=:basketItemID
				)
			}
		}
		
		// save the ecternal item codes
		if ##class(setup.objSystemTypes).isModuleAllowed("Profit & Loss") {
			// save the account codes in all basketItems
			set initialCost=%request.Get("initialCost")
			set unitCost=%request.Get("unitCost")
	
			// update the main delegate basketItem
			set basketItemID=""
			&SQL(SELECT basketItemID INTO :tmp FROM cod.objTicket WHERE ID=:ticketID)
			if +SQLCODE=0 set basketItemID=tmp
			&SQL(UPDATE eCom.objBasketItem SET initialCost=:initialCost,unitCost=:unitCost
				WHERE ID=:basketItemID
			)
			// update for attendee categories
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs.Prepare("SELECT * FROM links.lnkCategoryItemBasketItem WHERE (objTicket=?)")
			do rs.Execute(ticketID)
			while rs.Next() {
				set basketItemID=rs.Get("objBasketItem")
				&SQL(UPDATE eCom.objBasketItem
					SET initialCost=:initialCost,unitCost=:unitCost
					WHERE ID=:basketItemID
				)
			}
		}
	}

	// store the depencies
	set dependsOnPrompt=%request.Get("selDependsOnDataID")
	set dependsOnAlternative=%request.Get("selDependsOnCodAltID")
	
	//  only save as dependent if we have both a dependent question and a required answer
	if ('dependsOnAlternative || 'dependsOnPrompt) {
		set (dependsOnAlternative,dependsOnPrompt)=""
	}
	&SQL(UPDATE sc_xModules.objCODitem SET dependsOnPrompt = :dependsOnPrompt,dependsOnAlternative = :dependsOnAlternative WHERE ID = :dataID)
	if ((xEventID)&&((dependsOnPrompt'=dependsOnPromptExisting)!(dependsOnAlternative'=dependsOnAlternativeExisting))) {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). Dependency changed for question: "_questionText_" ("_codItemNameDescription_"),"
		if dependsOnAlternative	{
			set auditText=auditText_" now depends on:"_##class(sc.xModules.objCODitem).getCODItemName(dependsOnPrompt)_" ("_dependsOnPrompt_")"_", alternative:"_##class(cod.objItemAlternatives).getDescriptionByID(dependsOnAlternative)_" ("_dependsOnAlternative_")"
		} else {
			set auditText=auditText_" dependency cleared."
		}
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}

	// store the suppressNewLine
	set suppressNewLine=%request.Get("suppressNewLine")
	set promptWidth=+%request.Get("promptWidth")
	&SQL(UPDATE sc_xModules.objCODitem SET promptWidth = :promptWidth,supressNewLine = :suppressNewLine WHERE ID = :dataID)
	
	//store the backendOnly flag
	set backendOnly=+%request.Get("chkBackendOnly")
	set reportOn=%request.Get("chkReportOn")
	set readonlyFrontend=+%request.Get("chkReadonlyFrontend")
	&SQL(UPDATE sc_xModules.objCODitem SET backendOnly = :backendOnly,reportOn = :reportOn,readonlyFrontend = :readonlyFrontend WHERE ID = :dataID)
	if ((xEventID)&&(backendOnly'=+backendOnlyExisting)) {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). Backend only flag changed for question: "_questionText_" ("_codItemNameDescription_"),"
		set auditText=auditText_" from:"_$S(backendOnlyExisting:"on",1:"off")_" to:"_$S(backendOnly:"on",1:"off")
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}
	if ((xEventID)&&(readonlyFrontend'=+readonlyFrontendExisting)) {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). Read only flag changed for question: "_questionText_" ("_codItemNameDescription_"),"
		set auditText=auditText_" from:"_$S(readonlyFrontendExisting:"on",1:"off")_" to:"_$S(readonlyFrontend:"on",1:"off")
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}
	
	if ##class(setup.objSystemTypes).isModuleAllowed("Attendee Categories")	{
		// kill all category links and save
		// - do this in method so it can compile without class
		do ##class(links.lnkEventCategoryData).deleteAllForOne(dataID)
		set item=""
		set errorOnCategories=""
		for  {
			set item=$o(%request.Data(item))
			if item="" quit
			if item["chkEventCategory" {
				set eventCategoryID=$P(item,"_",2)
				set okToUpdate=1
				if ((dependsOnPrompt)&&(dependsOnAlternative)) {
					if '(##class(links.lnkEventCategoryData).allow(eventCategoryID,dependsOnPrompt)) {
						set errorOnCategories=errorOnCategories_$LISTBUILD(##class(setup.objEventCategory).getDescription(eventCategoryID))
						set okToUpdate=0
					}
				}
				if okToUpdate {
					do ##class(links.lnkEventCategoryData).updateAttendeeCategoryRestrictionsRecursive(eventCategoryID,dataID)
				}
			}
		}
		if ($LISTLENGTH(errorOnCategories)>1) {
			set tempListStr=$LISTTOSTRING($LIST(errorOnCategories,1,*-1),"', '")_"' and '"_$LIST(errorOnCategories,*)
			set %session.Data("proweb","backend","errMsg")="The question cannot be restricted to the categories '"_tempListStr_"' because it is linked to another question where it is not allowed"
		} elseif($LISTLENGTH(errorOnCategories)>0) {
			set %session.Data("proweb","backend","errMsg")="The question cannot be restricted to the category '"_$LISTTOSTRING(errorOnCategories,",")_"' because it is linked to another question where it is not allowed"
		}
		if $G(%session.Data("proweb","backend","errMsg"))'="" {
			set %response.Redirect=errorURL
			quit 0
		}
	}
	
	// store the required answer and maxCharacters
	if (%request.Get("maxCharacters")'?.N) {
		set %session.Data("proweb","backend","errMsg") = "The changes can't be saved because ""Max length of answer"" must be a number"
		set %response.Redirect = errorURL
		return 0
	}
	set maxCharacters=%request.Get("maxCharacters")
	set maxWords=""
	if %request.Get("radCharsOrWords")="words" {
		set maxWords=maxCharacters
		set maxCharacters=""
	}
	set noAmendments=+%request.Get("chkNoAmendments")

	do ##class(sc.xModules.objCODitem).updateRequiredAnswer(dataID,requiredAnswer)
	do ##class(sc.xModules.objCODitem).updateValidationErrorMessage(dataID,validationErrorMessage)
	do ##class(sc.xModules.objCODitem).updateMaxCharacters(dataID,maxCharacters)
	do ##class(sc.xModules.objCODitem).updateMaxWords(dataID,maxWords)
	do ##class(sc.xModules.objCODitem).updateMultiCheckboxMin(dataID,%request.Get("multiCheckboxMin"))
	do ##class(sc.xModules.objCODitem).updateMultiCheckboxMax(dataID,%request.Get("multiCheckboxMax"))
	do ##class(sc.xModules.objCODitem).updateDefaultValue(dataID,defaultValue)
	do ##class(sc.xModules.objCODitem).updateCopyValueFromBooker(dataID,copyValueFromBooker)
	do ##class(sc.xModules.objCODitem).updateNoAmendments(dataID,+%request.Get("chkNoAmendments"))
	
	if ((xEventID)&&(requiredAnswer'=requiredAnswerExisting)) {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). Custom validation changed for question: "_questionText_" ("_codItemNameDescription_"),"
		set auditText=auditText_" from:"_requiredAnswerExisting_" to:"_requiredAnswer
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}
	if validationErrorMessage'=validationErrorMessageExisting {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). Validation error message changed for question: "_questionText_" ("_codItemNameDescription_"),"
		set auditText=auditText_" from:"_validationErrorMessageExisting_" to:"_validationErrorMessage
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}
	if ((xEventID)&&(noAmendments'=+noAmendmentsExisting)) {
		set auditText="Reg Page '"_pageName_"' ("_pageID_"). No amendments changed for question: "_questionText_" ("_codItemNameDescription_"),"
		set auditText=auditText_" from:"_$S(noAmendmentsExisting:"on",1:"off")_" to:"_$S(noAmendments:"on",1:"off")
		do ##class(setup.objEventAudit).add(xUserID,xEventID,auditText)
	}
	
	// always make it published if we are doing document manamenmt
	if %session.Data("proweb","isDOC") {
		set step=##class(sc.objStep).getFinalLevel()
		do ##class(sc.objData).approve(dataID,step)
	}
	
	// count the list of alternatives
	set alts=%request.Get("txtAlternatives")
	if $IsObject(alts) {
		set alts=%request.Get("txtAlternatives").Read($$$maxStringLength)	
	}
	
	set oldCount=##class(cod.objItemAlternatives).getAlternativesCountForCodItem(itemNameID)
	set oldString=""
	if oldCount<15 {
		set oldString=""
		set rsOC=##class(cod.objItemAlternatives).getAlternativesForCodItemAsResultSet(itemNameID)
		while rsOC.Next() {
			set oldString=oldString_$S($L(oldString):" | ",1:"")_rsOC.Get("description")
		}
	}
	// update the list of alternatives
	kill questArr
	for altCount=1:1:($L(alts,"|")-1) {
		set itemAlternativeID=$p($p(alts,"|",altCount),"~",1)
		set desc=##class(cod.objItemAlternatives).sanitiseDescription($p($p(alts,"|",altCount),"~",2))
		set code=$p($p(alts,"|",altCount),"~",3)
		if itemAlternativeID["NEW" {
			set itemAlternativeID=##class(cod.objItemAlternatives).create(itemNameID,desc,code,altCount)
			if (defaultValue="NEW|") {
				do ##class(sc.xModules.objCODitem).updateDefaultValue(dataID,desc)
			}
		} else {
			do ##class(cod.objItemAlternatives).update(itemAlternativeID,desc,code,altCount)
		}
		if %request.Get("additional") {
			//  Setup the ABI
			set extrasID=##class(cod.objAlternativeExtras).findExtra(itemAlternativeID,dataID)
			if 'extrasID {
				set extrasID=##class(cod.objAlternativeExtras).add(itemAlternativeID,dataID)
				//  Add Property to link objBasketItem to the related object
				set basketItemID=##class(eCom.objBasketItem).add(,xControllerID,"additional",extrasID)
				// And assign the basket Item
				do ##class(cod.objAlternativeExtras).updateBasketItem(extrasID,basketItemID,"")
			}
		}
		// Update any for any other events which may be using this as an ABI (even if this event is not uising it as an ABI, others might)
		do ##class(cod.objAlternativeExtras).updateAlternatives(itemAlternativeID, .questArr)
	}
	// log to event audit trail
	if xEventID {
		if altCount<15 {
			set newString=""			
			for altCount=1:1:($L(alts,"|")-1) {
				set desc=$p($p(alts,"|",altCount),"~",2)
				set newString=newString_$S($L(newString):" | ",1:"")_desc
			}
			if newString'=oldString,$L(newString) {
				do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Changed List of Alternatives from: "_oldString_"  to:  "_newString)
			}
		} else {
			if oldCount'=altCount {
				do ##class(setup.objEventAudit).add(xUserID,xEventID,"Reg Page '"_pageName_"' ("_pageID_"), Changed Number of Alternatives from: "_oldCount_"  to:  "_altCount)
			}
		}
	}
	
	if (##class(sc.xModules.objPage).isAbstractDocumentPage(pageID)) && (##class(sc.objComponent).getComponentName(parent) = "Document List") {
		set value =  +%request.Get("chkAbsShowToReviewers")
		
		if ##class(cod.lnkItemNameEvent).getShowToReviewers(itemNameID,xEventID) '= value {
			do ##class(setup.objEventAudit).add(xUserID,xEventID,"updated 'showToReviewers' for '"_##class(cod.objItemName).getDescFromID(itemNameID)_"' - new value: "_value)	
		}
		do ##class(cod.lnkItemNameEvent).setShowToReviewers(itemNameID,value,xEventID)	
	}
	
	
	// delete alternatives
	set delAlts=%request.Get("txtDeletedAlternatives")
	for i=1:1:$L(delAlts,"|") {
		set id=$p(delAlts,"|",i)
		do ##class(cod.objItemAlternatives).deleteAlternative(id,xUserID)
	}
	
	set %response.Redirect=%request.Get("templateURL")
	 set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))
	
	if %request.Get("gotoCodQuestionCSV") {
		set %response.Redirect=codQuestionDetailsURL_"&gotoCodQuestionCSV=1"
		quit 0
	}
	
	if %request.Get("gotoPage")'="" {
		set %response.Redirect=%request.Get("gotoPage") // used from codQuestionDetails.csp
	}
	if %request.Get("backPage")'="" set %response.Redirect=%request.Get("backPage") // used from eventsForce/registraionDetails.csp
	
	if %request.Get("updateSameAs")!%request.Get("togglePriceByAttendeeCategory") {
		set %response.Redirect=codQuestionDetailsURL
	}
	
	set %response.Redirect=%response.Redirect_$S(%response.Redirect["?":"&",1:"?")_"mode=edit"
	
	quit 0
</script>
]]></CSP>


<CSP name="backEnd/proweb/formDivider.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	
	do ##class(sc.xModules.objFormDivider).add(%request.Get("parent"),%request.Get("position"))
	do ##class(EF.pages.frontend.baseProweb).moveNewElementToDesiredPosition()				
	set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))			
				
	quit 0
</script>
]]></CSP>


<CSP name="backEnd/proweb/textDetailsMoxie.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<csp:include page="../../backend/home/backendTop.csp?hideBackendMenu=1&useHtml5=1&kendoweb=1&useTinyMce=1">

<script src="../../media/javascript/ef/ef-admin-tinyMceTextBlock.js?v=12"></script>

<script language="cache" runat="server">
	set %session.Data("eventsforce","backend","email or web page")="web page"
	set pageID=%request.Get("pageID")
	// following session items are set in textDetailsMoxie2.csp if redirecting to fonts and colours page
	kill %session.Data("parent")
	kill %session.Data("moxieDataID")
	kill %session.Data("isCOD")
	
	do ##class(EF.pages.frontend.baseProweb).savePassedInDesiredPositionToSession()
	
	&SQL(SELECT layoutObjTemplate->styleSource INTO :styleSource FROM setup.objEvent WHERE ID = :xEventID)
	
	set dataID=%request.Get("dataID")
	if dataID="" set dataID=%session.Get("dataID")
	set %session.Data("dataID")=dataID
	
	set orgDataID=%request.Get("orgDataID") // used when creating a new version of a data item
	if orgDataID="" set orgDataID=%session.Get("orgDataID")
	set %session.Data("orgDataID")=orgDataID

	set parent=""
	if dataID="NEW" set tmp=orgDataID
	else  set tmp=dataID
	&SQL(SELECT parent INTO :parent FROM sc.objData WHERE ID = :tmp)

	set classNo=%request.Get("classNo")
	if classNo="" set classNo=%session.Get("classNo")
	set %session.Data("classNo")=classNo
	

	set templateURL=%request.Get("templateURL")
	if templateURL="" set templateURL=%session.Get("templateURL")
	set %session.Data("templateURL")=templateURL

	set templateID=%request.Get("templateID")
	if templateID="" set templateID=%session.Get("templateID")
	set %session.Data("templateID")=templateID
	
	set displayOrder=%request.Get("displayOrder")
	if displayOrder="" set displayOrder=%session.Get("displayOrder")
	set %session.Data("displayOrder")=displayOrder

	set addToTop=%request.Get("addToTop")
	if addToTop="" set addToTop=%session.Get("addToTop")
	set %session.Data("addToTop")=addToTop

	// make sure we don't get the taglist from the email details
	kill %session.Data("eventsforce","backend","show taglist")	

	// check if the event is using a template that is AA complient, if so, disable the legacy mode
	&SQL(SELECT layoutObjTemplate->accessibilityLevel INTO :tmp FROM setup.objEvent WHERE ID = :xEventID)
	set accessibilityLevel=tmp
	set toolBar2="formatselect | fontselect | fontsizeselect | table | template"
	if accessibilityLevel="AA" {
		set toolBar2="formatselect | table | template"	
	}

	set surveyID=%request.Get("surveyID")
	
	if surveyID {
		set tmpTemplateID=##class(layout.objTemplate).getLayoutForSurvey(surveyID)
	} else {
		set tmpTemplateID=##class(layout.objTemplate).getLayoutForEvent(xEventID)
	}
	
	// get the name of the component
	set componentName=%request.Get("componentName")
	if componentName="" set componentName=%session.Get("componentName")
	set %session.Data("componentName")=componentName
	if (componentName="")&(dataID'="") {
		&SQL(SELECT description INTO :componentName FROM sc.objComponent WHERE objData = :dataID)
	}
	 
	// load the page in raw mode if it was saved in raw mode - to enable javascript, flash etc.
	set allowScripts=0,allowFontSelection=0
	if dataID {
		if ##class(sc.xModules.objText).isTextBlockRawMode(dataID) set allowScripts=1
		if ##class(sc.xModules.objText).isFontSelectionOn(dataID) set allowFontSelection=1
	}
	
	set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if 'xWorkLangID set xWorkLangID=xLangID
	// are we in the bookers page?
	set inBookersPage=0
	if xEventID	{
		set extraBit=""
		if xWorkLangID,xWorkLangID'=xLangID set extraBit=" - "_##class(shared.objLanguage).getLanguageDesc(xWorkLangID)
		set bookerPageID=##class(setup.objEventSetting).getParameter("bookings","bookerRegPageID"_extraBit,xEventID)
		if bookerPageID=pageID set inBookersPage=1
	}
	
	set eventAllowsGroupBookings=##class(setup.objEventSetting).getParameter("bookings","allow group bookings",xEventID)
	set editWithoutColours=0
</script>

<csp:object name="objData" classname="sc.objData" objid="#(dataID)#">

<script language="cache" runat="server">
	//SHAHADAT: 11 Dec 09
	// Had to take out the componentName resetting from the line below as this messes things up when we try to add a new header CASE00012071.
	//Also, as we made a few decisions above based on this componentName, we could not find a good reason why we have to reset it here.
	//set (description,currentPath,componentName,parent,componentName,pageName)="" 
	set (description,currentPath,parent,pageName)="" 

	if +dataID {
		set parent=objData.parent.%Id()
	} else {
		set parent=%request.Get("parent")
		if parent="" set parent=%session.Get("parent")
		set %session.Data("parent")=parent
	}	
	
	set currentPath=##class(sc.objData).getPath(parent,0)
	set textStream=##class(%GlobalCharacterStream).%New()

	// get the data if we are editing
	if ##class(sc.objData).%ExistsId(dataID) {
		set description=objData.description
		set textStream=objData.textStream
		&SQL(SELECT description INTO :componentName FROM sc.objComponent WHERE (objData = :dataID) )
	} else {
		if orgDataID'="" {
			if ##class(sc.objData).%ExistsId(orgDataID) {
				// default data to the previous version if we are creting a new version
				set orgObjData=##class(sc.objData).%OpenId(orgDataID)
				set description=orgObjData.description
				set textStream=orgObjData.textStream
				do orgObjData.%Close()
			}
		}
	}

	set encodedTextStream=""
	try {
		set encodedTextStream=..encodeHTMLContentForTinyMCETextarea(textStream.Read($$$maxStringLength))	
	} catch {
		set %session.Get("errorMessage")="Cannot open text block because it is too long"
	}
	// get the name of the page
	&SQL(SELECT description INTO :pageName FROM sc_xModules.objPage WHERE ID = :pageID)

	set width=610 // default
	if dataID {
		if objData.parent.dataType="objList" {
			&SQL(SELECT width INTO :width FROM sc.objComponent WHERE objData = :parent)
		} else {
			&SQL(SELECT width INTO :width FROM sc.objComponent WHERE objData = :dataID)
		}
	}

	set temp="siblings"_displayOrder
	
	kill allRegPages,allRegPageIDs,allReg
	set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xWorkLangID,1,.allRegPages,.allRegPageIDs,.allReg)

</script>

<csp:if condition=($l($G(%session.Data("errorMessage"))))>
	<script language='javascript'>
		alert("#(..encodeForJavaScript(%session.Data("errorMessage")))#");
	</script>
	<script language="cache" runat="server">
		kill %session.Data("errorMessage")
	</script>
</csp:if>

<script language="cache" runat="server">
	set textDetailsMoxieShowDependentSection=0
	if (%request.Get("isCOD")) set textDetailsMoxieShowDependentSection=1
	if ##class(sc.pageMethods).isAwardsEntryPage(pageID) {
		set textDetailsMoxieShowDependentSection=1
	}
	set showCategoryRestrictions = 0
	if xEventID {
		if ##class(setup.lnkCategoryEvent).numCategories(xEventID,1,1)>1 {
			set showCategoryRestrictions=1	
		}
	}
	if ($zcvt(templateURL,"l") [ $zcvt("treceipt.csp","l")) set showCategoryRestrictions = 0
	if ($zcvt(templateURL,"l") [ $zcvt("xtTsurveyPage.csp","l")) set showCategoryRestrictions = 0
	set showAttendeeOptions=0
	if textDetailsMoxieShowDependentSection!showCategoryRestrictions {
		set showAttendeeOptions=1
	}
	set dependsOnPrompt=##class(sc.dependencyMethods).getDependsOnPrompt(dataID)
	set dependsOnAlternative=##class(sc.dependencyMethods).getDependsOnAlternative(dataID)
</script>


<script language="javascript" type="text/javascript">
	$(function() {
		ef.tinyMceTextBlock.properties.allowFontSelection = #(..rawJS(+allowFontSelection))#;
		ef.tinyMceTextBlock.properties.allowScripts = #(..rawJS(+allowScripts))#;
		ef.tinyMceTextBlock.properties.editWithoutColours = #(..rawJS(+editWithoutColours))#;
		ef.tinyMceTextBlock.properties.showAttendeeOptions = #(..rawJS(showAttendeeOptions))#;
		ef.tinyMceTextBlock.urls.content_css = '#(..encodeJS(##class(EF.ui.pageSections.textDetailsMoxieStyles).outputStylesForMoxie(xEventID)))#';
	    ef.tinyMceTextBlock.urls.link_list = '#(..encodeJS(..Link("../../backend/home/moxieLinksJSON.csp")))#';
	    ef.tinyMceTextBlock.urls.file_picker_callback = '#(..encodeJS(..Link("../../backend/home/moxieFileUpload.csp?zzz=1")))#';
	    ef.tinyMceTextBlock.properties.table_class_list = #(..rawJS(##class(setup.systemSettingsMethods).getMoxieTableClasses()))#; 
	    ef.tinyMceTextBlock.initialise();
	});
</script>

<div style="margin-top: 33px;"></div>
 <form method="post" action="textDetailsMoxie2.csp"  name="composeform" ID="composeform">
 
 <div class="topsave_in_popup">
 	<a href="../../proweb/frontend/start.csp?mode=edit&version=current&pageID=#(pageID)#"><img name="butQuit" src="../../media/images/english/default/backend/cancel.gif" alt="Quit" border="0"></a>
	
	<script language="cache" runat="server">
		set show=0
		if ##class(layout.objTemplate).isEventIFrame(xEventID) set show=1
		if ##class(layout.objTemplate).isUsingLegacyTemplate(xEventID) set show=1
		
		if ('show) {
			set fontsAndColoursTooltip=..out("You do not have access to Fonts & Colours if you are using an Eventsforce or Custom Made design. You have access if you are using the Blank Design or iFrame template")
		} else {
			set fontsAndColoursTooltip=..out("Click here to amend your font, colour and size for your chosen format")
		}
	</script>
	<csp:if condition=(show=0)>
		<img src="../../media/images/english/default/backend/fonts_and_colours_disabled.gif" alt="#(fontsAndColoursTooltip)#" title="#(fontsAndColoursTooltip)#" />
	<csp:else>
		<input type="image" name="butEdit" id="butEdit" src="../../media/images/english/default/backend/fonts_and_colours.gif" alt="#(fontsAndColoursTooltip)#" title="#(fontsAndColoursTooltip)#" border="0">
	</csp:if>
	<input type="image" id="butSave" name="butSave" onclick="ef.tinyMceTextBlock.resetColors(0);" src="../../media/images/english/default/backend/save.gif" alt="Save" border="0" >
 </div>

<table style="with: 1024px;" border="0" cellspacing="0" cellpadding="0">
    <tr>
        <td>
            <table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF">
                <tr  class="gen1_panel_header">
	                <td>Edit Text Item</td>
                </tr>
				<tr>
		            <td valign="top">
					   <table width="100%" style="max-width:1100px;" border="0" cellspacing="0" cellpadding="0">
							<tr>
								<td colspan="4">
									<input type="hidden" id="rawText" name="rawText" value="">
									<textarea id="editBox" class="ef-admin-tinyMceTextBlock-edit-box" name="editBox">#(..rawHTML(encodedTextStream))#</textarea>
									<input type="hidden" name="displayOrder" value="#(%request.Get("displayOrder"))#">
					               <input type="hidden" name="templateID" value="#(templateID)#">
						           <input type="hidden" name="parent" value="#(parent)#">
						           <input type="hidden" name="componentName" value="#(componentName)#">
						           <input type="hidden" name="templateURL" value="#(templateURL)#">
						           <input type="hidden" name="dataID" value="#(dataID)#">
						           <input type="hidden" name="txtGotoPage" value="">
						           <input type="hidden" name="addToTop" value="#(addToTop)#">										
						           <input type="hidden" name="publish" value="no">
						           <input type="hidden" name="orgDataID" value="#(orgDataID)#">
								   <input type="hidden" name="isCOD" value="#(%request.Get("isCOD"))#">
								   <input type="hidden" id="dependsOnPrompt" name="dependsOnPrompt" value="#(dependsOnPrompt)#">
								   <input type="hidden" id="dependsOnAlternative" name="dependsOnAlternative" value="#(dependsOnAlternative)#">								   
								   <input type="hidden" id="allowFontSelection" name="allowFontSelection" value=#(allowFontSelection)#>
								   <input type="hidden" id="allowScripts" name="allowScripts" value=#(allowScripts)#>
								   <input type="hidden" id="editWithoutColours" name="editWithoutColours" value=#(editWithoutColours)#>
								   <input type="hidden" id="okToSaveEmpty" name="okToSaveEmpty" value=0>
								   <script language="cache" runat="server">
										// get all the active categories for this event
										set rs2=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
										do rs2.Execute(xEventID)
									</script>
									<csp:while condition="rs2.Next()">
										<input type="hidden" id="restrictByEventCategory_#(rs2.Data("objEventCategory"))#" class="hiddenRestrictByEventCategory" name="restrictByEventCategory_#(rs2.Data("objEventCategory"))#" value="#($S(##class(links.lnkEventCategoryData).isSet(rs2.Data("objEventCategory"),dataID):1,1:0))#">
									</csp:while>
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
		</td>
    </tr>
</table>
<script language="cache" runat="server">
	Set lightBox=##class(EF.ui.backend.controls.lightBox).%New("attendee-options-lightbox")
	set lightBox.boxTitle="Options"
	set lightBox.showBoxTitle=1
	set lightBox.width="700px"
	set lightBox.cancelButtonID="attendeeOptionsCloseButton"
	set lightBox.actionButtonID="attendeeOptionsSaveButton"
</script>
<script language="javascript" type="text/javascript">
	ef.textDetailsMoxie = ef.textDetailsMoxie || {};
	ef.textDetailsMoxie.showAttendeeDetails = function() {
		#[do lightBox.show()]#
	}
	$(function() {
		$('##(lightBox.cancelButtonID)#').click( function () {
			#[do lightBox.hide()]#
			if (($("#dependsOnPrompt").val()) != '') {
				$("#selDependsOnDataID").val($("#dependsOnPrompt").val());
			} else {
				$("#selDependsOnDataID").prop("selectedIndex", 0);
			}
			updateAlts($("#dependsOnPrompt").val());
			$("#selDependsOnCodAltID").val($("#dependsOnAlternative").val());
			$(".hiddenRestrictByEventCategory").each(function() {
				var thisID=$(this).attr('id');
				var categoryID = thisID.split('_')[1];
				var checkbox= $('#chkEventCategory_' + categoryID);
				if ($(this).val() == 1) {
					checkbox.prop('checked',true);
				} else {
					checkbox.prop('checked',false);
				}
			});
		});
		$('##(lightBox.actionButtonID)#').click( function () {
			#[do lightBox.hide()]#
			$("#dependsOnPrompt").val($("#selDependsOnDataID").val());
			$("#dependsOnAlternative").val($("#selDependsOnCodAltID").val());
			$(".hiddenRestrictByEventCategory").each(function() {
				var thisID=$(this).attr('id');
				var categoryID = thisID.split('_')[1];
				var checkbox= $('#chkEventCategory_' + categoryID);
				if (checkbox.prop('checked')) {
					$(this).val(1);
				} else {
					$(this).val(0);
				}
			});
		});
	});
</script>
	<div id="attendee-options-lightbox" style="display:none; width: #(lightBox.width)#;">
		<div class='ef_settings_group'>
			<table width="100%" border=0 cellpadding=0 style="margin-left: 0px; margin-right: 0px; margin-bottom: 12px;">
				<csp:if condition=(textDetailsMoxieShowDependentSection)>
					<csp:include page="dependancyOptionsInclude.csp">
				</csp:if>
			</table>
			<csp:if condition=(showCategoryRestrictions)>	
				<table width="100%" border=0 cellpadding=0 style="margin: 0px;">
					<tr>
						<td class="black10px" colspan="4">
							<script language="cache" runat="server">
								set eventID=$G(%session.Data("eventsforce","backend","xEventID"))
								set langID=$G(%session.Data("eventsforce","backend","xLangID"))	
							</script>
							<csp:if condition=(eventID)>
								<script language="cache" runat="server">
									// get all the active categories for this event
									set rs2=##class(%ResultSet).%New("setup.lnkAttendeeCategoryDetailsEvent:qAllActiveCategories")
									do rs2.Execute(eventID)
								</script>
								<tr>
									<td colspan="3">
										<table  border=0 cellpadding=0 cellspacing=0>
											<csp:while counter="x" condition="rs2.Next()">
												<csp:if condition=(x=1)>
													<tr>
														<td class="black10px" colspan="99" align="left" nowrap><tx>Restrict access to these attendee categories</tx>:</td>
						
													</tr>
												</csp:if>
												<csp:if condition=(x#2'=0)>
													<tr>
														<td width=103></td>
												</csp:if>
														<script language="cache" runat="server">
															set eventCategoryID=rs2.Data("objEventCategory")
															set CHECKED=""
															if ##class(links.lnkEventCategoryData).isSet(eventCategoryID,dataID) set CHECKED="CHECKED"
														</script>
														<td align="left" width=35>
															<input type="checkbox" id="chkEventCategory_#(eventCategoryID)#" name="chkEventCategory_#(eventCategoryID)#" #(CHECKED)#>
														</td>
														<td align="left"  width=100 class="black10px">
															#(##class(shared.stringFunctions).sentenceCase(rs2.Data("description")))#
														</td>
														<td>&nbsp;</td>
												<csp:if condition=(x#2=0)>
													</tr>
												</csp:if>
											</csp:while>
												<csp:if condition=(x#2'=0)>
														<td align="right" ></td>
														<td align="left"></td>
													</tr>
												</csp:if>
										</table>
									</td>
								</tr>
							</csp:if>
						</td>
					</tr>
				</csp:if>
			</table>						
		</div>
		<div class="ef_backend_button_section">
			<input type="image" id="#(lightBox.cancelButtonID)#" src="../../media/images/English/Default/backend/cancel.gif" border="0" alt="cancel" name="Cancel">
			<input type="image" id="#(lightBox.actionButtonID)#" src="../../media/images/English/Default/backend/ok.gif" border="0" alt="Save" name="Submit">
		</div>
	</div>
 </form>


<script language="javascript" >
$(function() {
	$("#composeform").submit(function() {
		stripHTML(); 
		return ef.tinyMceFunctions.checkForEmptySave(tinyMCE.activeEditor);
	}
)});
	
function stripHTML() {
	var oldString = tinyMCE.activeEditor.getContent();
	$("#rawText").val($("<div/>").html(oldString).text());
}

function updateAlts(codPromptID) {
	if ($("#selDependsOnCodAltID").length !=0) {
		document.getElementById("selDependsOnCodAltID").options.length=0;
		if (codPromptID != '') {
			// populate the alternatives list box from the javascript array
			
			for (var i = 0; i < (alts[codPromptID].length); i++) {
				var tmp = alts[codPromptID][i].split('|');
				document.getElementById("selDependsOnCodAltID").options[i] = new Option(tmp[1],tmp[0])
			}	
		}
	}
}


</script>
<csp:include page="../../backend/home/backendBottom.csp">                                                                                                                              
]]></CSP>


<CSP name="backEnd/proweb/textDetailsMoxie2.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	// check if we have lost the userID due to a session switch in flash, if so get it back from the cookie created in login2.csp
	if %session.Get("xUserID")="" set %session.Data("xUserID")=%request.GetCookie("xUserID")
	set userID=%session.Get("xUserID")
	if %request.Get("isHeader") {
		set redirectOnErrorURL="textHeaderMoxie.csp"
	} else {
		set redirectOnErrorURL="textDetailsMoxie.csp"
	}
	// abort if we cant find a user, just to ensure database integrity
	if %session.Get("xUserID")="" {
		set %session.Data("errorMessage")="Error. Data cannot be saved. User Id cannot be found.\nPlease try again after a new logon"
		set %response.Redirect=redirectOnErrorURL
		quit 0
	}
	
	// try to remove any XML from pasted Word
	set text=%request.Get("editBox")

	// abort if text block contains javascript from proWeb
	if $IsObject(text) {
		if text.FindAt(-1,"HM_Array")'=-1 {
			set %session.Data("errorMessage")="Error. Text cannot be saved. It has seems to have been copied from a proWeb page in edit mode. \nPlease switch to Preview mode before copying any data."
			set %response.Redirect=redirectOnErrorURL
			quit 0
		}
		set validator=##class(EF.validator.htmlText).%New()
		if 'validator.isInputValidStream(text) {
			set %session.Data("errorMessage")="Your text is too long. Please amend and re-save."
			set %response.Redirect=redirectOnErrorURL
			quit 0
		}
	} else {
		
		if text["HM_Array" {
			set %session.Data("errorMessage")="Error. Text cannot be saved. It has seems to have been copied from a proWeb page in edit mode. \nPlease switch to Preview mode before copying any data."
			set %response.Redirect=redirectOnErrorURL
			quit 0
		}	
	
		if (($LENGTH(text)<1)&&(%request.Get("mode")="")) { //  don't save empty text blocks...unless we're just switching mode. 
			if %request.Get("okToSaveEmpty")'=1 {
				set %session.Data("errorMessage")="Error. Empty text block cannot be saved. \nTo remove a text block, click Cancel and then select Delete from the menu next to the specific text block."
				set %response.Redirect=redirectOnErrorURL
				quit 0
			}
		}
		set validator=##class(EF.validator.htmlText).%New()
		if 'validator.isInputValid(text) {
			set %session.Data("errorMessage")="Your text is too long. Please amend and re-save."
			set %response.Redirect=redirectOnErrorURL
			quit 0
		}	
	}
	new objData,objComponent

	set dataID=%request.Get("dataID")
	set %session.Data("dataID")=dataID
	set orgDataID=%request.Get("orgDataID")
	set parent=%request.Get("parent")
	set templateID=%request.Get("templateID")
	set componentName=%request.Get("componentName")

	set displayOrder=%request.Get("displayOrder")
	if displayOrder="" set displayOrder=%session.Get("displayOrder")
	
	// Need to initialize the variables otherwise they cause crashes. 
	set dependsOnPrompt=%request.Get("dependsOnPrompt")
	set dependsOnAlternative=%request.Get("dependsOnAlternative")
	
	if dataID="NEW" {
		// create new text object
		set objData=##class(sc.xModules.objText).%New()
		
		// parent
		do objData.parentSetObjectId(parent)
		
		set objData.active=1

		set user="unknown"
		if %session.Get("xUserID")'="" {
			set objUser=##class(admin.objUser).%OpenId(%session.Get("xUserID"))
			set user=objUser.email
			do objUser.%Close()
		}
		set objData.creator=user
		
		do objData.%Save()
		set dataID=objData.%Id()
		set %session.Data("dataID")=dataID

		// link to the previous version
		if (orgDataID'="")&(orgDataID'="NEW")&(orgDataID'="ADD") {

			if ##class(sc.objData).%ExistsId(orgDataID) {

				set ok=objData.previousVersionSetObjectId(orgDataID)
				if 'ok {
					set ^xErrors(%request.PageName,"not able to link back new text object",dataID)=orgDataID_"|"_ok
					quit 0
				} else {
					// and link the previous to me
					set tempObj=##class(sc.objData).%OpenId(orgDataID)
					do tempObj.nextVersionSetObjectId(dataID)
					do tempObj.%Save()
					do tempObj.%Close()
				}
			}
		}

			
		// create new component object if we didn't have an predecessor
		if (orgDataID="")!(orgDataID="NEW")!(orgDataID="ADD") {
			if objData.parent.dataType'="objList" {
				set objComponent=##class(sc.objComponent).%New()
				set objComponent.description=componentName
				do objComponent.objTemplateSetObjectId(templateID)
				do objComponent.objDataSetObjectId(dataID)
				do objComponent.%Save()
				do objComponent.%Close()

			}
		}

		// set a displayOrder if my parent is a List
		if objData.parent.dataType="objList" {
			if +displayOrder=0 {
				if orgDataID="ADD" { // meaning that we are adding an item to the list
					if %session.Get("addToTop")="false" { // add to the top of the list
						set tmp=""
						&SQL(SELECT displayOrder INTO :tmp FROM sc.objData WHERE parent = :parent ORDER BY displayOrder DESC)
						set objData.displayOrder=(tmp+1)
						set %session.Data("displayOrder")=(tmp+1)
					} else { // add to the bottom of the list
						// increment everybodys displayorder with one before adding this one as number one
						&SQL(UPDATE sc.objData SET displayOrder = (displayOrder+1) WHERE parent = :parent)
						set objData.displayOrder=(1)
						set %session.Data("displayOrder")=(1)
					}
					
					// kill the addToTop not to confuse later saves
					kill %session.Data("addToTop")
					
				} else {  // meaning that we are adding a version to one of the list items
					set objData.displayOrder=objData.previousVersion.displayOrder  // use the same as previous version
				}
			} else { // set the passed in displayOrder if we are adding a column to an existing row
				set objData.displayOrder=displayOrder
			}
			
			// Add new, dependent children right underneath their parent
			set dependsOnPrompt=%request.Get("dependsOnPrompt")
			set dependsOnAlternative=%request.Get("dependsOnAlternative")
			if dependsOnPrompt {
				&SQL(SELECT displayOrder,parent INTO :parentDisplayOrder,:parentID FROM sc_xModules.objCODitem WHERE ID = :dependsOnPrompt)
				if +SQLCODE=0,dataID {
					set lastPos=parentDisplayOrder
				
					// find the last dependent child
					&SQL(SELECT displayorder INTO :lastChild FROM sc_xModules.objCODitem WHERE (dependsOnPrompt = :dependsOnPrompt)  AND (parent = :parent) ORDER BY displayOrder DESC)
					if +SQLCODE=0 set lastPos=lastChild
				
					&SQL(SELECT displayorder INTO :lastChild FROM sc_xModules.objText WHERE (dependsOnPrompt = :dependsOnPrompt)  AND (parent = :parent) ORDER BY displayOrder DESC)
					if ((+SQLCODE=0)&&(lastChild > lastPos)) {
						set lastPos=lastChild
					}
					
					// move all the subsequent items one step down
					&SQL(UPDATE sc.objData SET displayOrder = displayOrder+1 WHERE (parent = :parent) AND (displayOrder > :lastPos))
				
					// move the new item to right after the parent	
					&SQL(UPDATE sc_xModules.objText SET displayOrder = :lastPos + 1 WHERE ID = :dataID)
				}
			}
		}
		if '$IsObject(objData) {
			throw ##class(shared.exceptions.generalException).%New("objData is not defined 1")
		}
		// add my new ID to the list of sibling if my dad was a list
		if objData.parent.dataType="objList" {
			if displayOrder>0 {
				new orgSibling
				set orgSibling=%session.Get("siblings"_displayOrder)
				set classNo=%session.Get("classNo")
				set pis=$p(orgSibling,"|",classNo)
				set $p(pis,"=",2)=dataID
				set $p(orgSibling,"|",classNo)=pis
				set %session.Data("siblings"_displayOrder)=orgSibling
			}
		}	
		if '$IsObject(objData) {
			throw ##class(shared.exceptions.generalException).%New("objData is not defined 2")
		}

		 // audit trail
		 set comments="created"
		 &SQL(INSERT INTO sc.objAuditTrail (description,objData,objUser) VALUES (:comments,:dataID,:userID))
		 
	} else {
		// open existing
		set objData=##class(sc.objData).%OpenId(dataID)

		// dependencies
		set dependsOnPrompt=%request.Get("dependsOnPrompt")
		set dependsOnAlternative=%request.Get("dependsOnAlternative")
			
		 // audit trail
		 set comments="amended"
		 &SQL(INSERT INTO sc.objAuditTrail (description,objData,objUser) VALUES (:comments,:dataID,:userID))
	}

	if '$IsObject(objData) {
		throw ##class(shared.exceptions.generalException).%New("objData is not defined 3")
	}
	
	// set the approval level to START for both new and existing items
	set step=""
	&SQL(SELECT ID INTO :step FROM sc.objStep WHERE stepOrder=1)
	do objData.objStepSetObjectId(step)
	
	set targetLevel=1
	
	set scTextBlockAudit=##class(EF.audit.scTextBlock).%New()
	do scTextBlockAudit.oldHtmlStream.CopyFrom(objData.textStream)
	do scTextBlockAudit.oldTextStream.CopyFrom(objData.rawTextStream)

	if $IsObject(text) { // if more than 32K
		do objData.textStream.CopyFrom(text)
	} else { // if less than 32K
		do objData.textStream.Write(text)
		//  Restrict to 1000 chars to avoid MAXSTRING errors, as sometimes 32k may not be the limit (UTF-8 encoded text)
		// set objData.description=text // this prop is not used for anything important but still used by the layout.method.applyBannersToTemplate()
		set objData.description=$E(text,1,1000) // this prop is not used for anything important but still used by the layout.method.applyBannersToTemplate()
	}
	// save the rawText, used by emails and such
	set rawText=%request.Get("rawText")
	set objData.suppressTextEditor=+%request.Get("allowScripts")
	set objData.isFontSelectionOn=+%request.Get("allowFontSelection")
	
	if $IsObject(rawText) {
		do objData.rawTextStream.CopyFrom(rawText)
	} else {
		do objData.rawTextStream.Write(rawText)
	}
	
	//update dependencies. 
	if (dependsOnPrompt && dependsOnAlternative) { //Save if both are defined. Otherwise, remove dependency altogether. 
		set objData.dependsOnPrompt=dependsOnPrompt
		set objData.dependsOnAlternative=dependsOnAlternative
	} else {
		set objData.dependsOnPrompt=""
		set objData.dependsOnAlternative=""
	}
	
	set scTextBlockAudit.objText=objData
	do scTextBlockAudit.htmlStream.CopyFrom(objData.textStream)
	do scTextBlockAudit.textStream.CopyFrom(objData.rawTextStream)
	set ok=objData.%Save()
	
	set scTextBlockAudit.savingStatus=ok
	do scTextBlockAudit.%Save()

	// update the width of the component
	set width=%request.Get("txtWidth"),compoID=""
	if objData.parent.dataType="objList" {
		&SQL(SELECT ID INTO :compoID FROM sc.objComponent WHERE objData = :parent)
	} else {
		&SQL(SELECT ID INTO :compoID FROM sc.objComponent WHERE objData = :dataID)
	}
	if compoID {
		set objComponent=##class(sc.objComponent).%OpenId(compoID)
		set objComponent.width=width
		do objComponent.%Save()
		do objComponent.%Close()
	}

	do objData.%Close()	
	do ##class(EF.pages.frontend.baseProweb).moveNewElementToDesiredPosition()
		
	// kill all category links and save
	// - do this in method so it can compile without class
	do ##class(links.lnkEventCategoryData).deleteAllForOne(dataID)
	set item=""
	for  {
		set item=$o(%request.Data(item))
		if item="" quit
		if (item["restrictByEventCategory")&&(%request.Get(item)) {
			set eventCategoryID=$P(item,"_",2)
			set ok=##class(links.lnkEventCategoryData).add(eventCategoryID,dataID)
		}
	}
	
	if (dependsOnPrompt) {
 		// Apply att cat restrictions for dependent text blocks
		// update restrictions of text block based on parent prompt
		set rsDep=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
		do rsDep.Prepare("SELECT objEventCategory FROM links.lnkEventCategoryData WHERE objData=?")
		do rsDep.Execute(dependsOnPrompt)
		while rsDep.Next() {
			// apply current restriction to child prompt if not already set
			set currentEventCategory = rsDep.Get("objEventCategory")
			&SQL(SELECT COUNT(objEventCategory) INTO :tmp FROM links.lnkEventCategoryData WHERE objEventCategory=:currentEventCategory AND objData=:dataID)
			if ((+SQLCODE=0)&&(tmp=0)){
				do ##class(links.lnkEventCategoryData).add(currentEventCategory,dataID)
			}
		}
	}

	
	// should we go on and publish direct? Always autopublish if we are writing an email
	if %request.Get("publish")="yes"!(##class(sc.objData).inMail(dataID)) {
		set %response.Redirect="publish.csp"
	} else {
		if %request.Get("txtGotoPage")="" {
			 set %response.Redirect="../../proweb/frontend/start.csp?mode=edit&version=current&pageID="_$G(%session.Data("pageID"))
		} else {
			set %session.Data("reuse created object")=dataID
			set %session.Data("reuse dataType")="objText"
			set %response.Redirect=%request.Get("txtGotoPage") // after goto re-use
		}
	}

	// go back to editor if we switched mode
	if %request.Get("mode")'="" {
		set %response.Redirect="textDetailsMoxie.csp?dataID="_dataID_"&mode="_%request.Get("mode")_"&displayOrder="_displayOrder_"&templateID="_templateID_"&parent="_parent //_"&templateURL="_%request.Get("templateURL")
	}
	
	// switching to CSSMainPage.csp
	if %request.Get("butEdit.x") {
		set %response.Redirect="../home/CSSMainPage.csp"
		// store some needed session data first
		set %session.Data("parent")=parent
		set %session.Data("moxieDataID")=dataID
		set %session.Data("isCOD")=%request.Get("isCOD")
	}
	
	quit 0
</script>
<html>
<body>
<script language="cache" runat="server">
	if %session.Data("errMessage")'="" {
		write "<scr"_"ipt language='javasc"_"ript'>alert("_%session.Data("errMessage")_");</sc"_"ript>"
		kill %session.Data("errMeassage")
	}
	
</script>
<script language='javascript'>
	document.location = "blank.csp";
</script>
</body>
</html>
]]></CSP>


<CSP name="frontEnd/reg/pageControllerStandardSave.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">

<script language="cache" method="OnPreHTTPafter" arguments="" returntype="%Library.Boolean"> 
	set contextData = ##class(EF.contextDataRegistration).createFromFrontendCSPSession()
	set pageControllerID=%request.Get("pageControllerID")
	
	set ok=1
	try {
		set pageController=##class(EF.pageController.page).open(pageControllerID,contextData)
	} catch {
		throw ##class(shared.exceptions.generalException).%New("Failed to open the frontend page controller when saving page")
	}
	
	set backforward=##class(setup.objPageNav).goWhere("codFormSave.csp", , contextData.tempPersonID, %request.Get("pageID")) // #########
	set redirectURL = $Piece(backforward,"|",2)
	

	set pageController.submitButtonClickedIdentifier=%request.Get("efSubmitButtonIdentifier")
	
	if %request.Get("efSaveAndReloadFormOnly") {
		// copy submitted fields into the pageController
		do pageController.updateFromRequest()
		do pageController.%Save()
		

	} else {
		// copy submitted fields into the pageController
		do pageController.updateFromRequest()
		
		// validate all data
		do pageController.validatePage() 
		if pageController.errorMessages.Count() {
			set pageController.hasError=1
		}
		
		// save the temp structure to database
		if pageController.hasError {
			set redirectURL = ##class(shared.pageMethods).addParamsToURL("t4registration.csp", "pageControllerID="_pageControllerID) // #############
			

		} else {
			// save temp structure to database
			Try {
				// the save has the validation and THROWS exceptions if any validations fail
				do pageController.save()

			} Catch exObj {
				set ok=0
				If exObj.%IsA("shared.exceptions.generalException") {
					set error=exObj.DisplayString()
				} else {
					// don't know what this error was (like a sub method throwing an error)
					set error="There was an error saving this page"
					throw exObj
				}
				do pageController.setErrorMessage(error)
			}
		}
		do pageController.%Save()
	}
	do pageController.copyAllDataToEComTemp()
	set %response.Redirect=redirectURL
	quit 0
</script>

]]></CSP>


<CSP name="frontEnd/reg/reorderProwebElements.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class encoded="1" private="1">
<script language="cache" runat="server">
	set contextData=##class(EF.contextDataRegistration).createFromFrontendCSPSession()
	set pageControllerID=%request.Get("pageControllerID")
	set orderedElementIds=%request.Get("orderedElementIds")
	set pageController=##class(EF.pageController.proweb.page).open(pageControllerID,contextData)
	
	do pageController.reorderProwebElements(orderedElementIds)
</script>
]]></CSP>


<CSP name="frontEnd/reg/t4Registration.csp" application="/largedevsrc/" default="1"><![CDATA[
<csp:class super="EF.pages.frontend.baseProweb">
<csp:parameter name="efPageName" value="tregistration.csp">

<script language="cache" runat="server">
	Do ##super() 
</script>


<csp:section name="PageContent">
	<ef-pc-container type="panel-body">
	   	<div class="row ef-proweb-reorderable" data-ef-reorderable-save-url="#(..encodeForHTMLAttribute(..Link("../../frontend/reg/reorderProwebElements.csp")))#" >
				<ef-pc-element prowebcomponentname="Main List">
			
				
		</div>
			
	</ef-pc-container>			
	
</csp:section>



<!-- ########### MOVE THIS TO EXTERNAL FILE ######## -->
<style>
.row {
	margin: 20px;	
}
.dropdown-submenu {
    position: relative;
}

.dropdown-submenu>.dropdown-menu {
    top: 0;
    left: 100%;
    margin-top: -6px;
    margin-left: -1px;
    -webkit-border-radius: 0 6px 6px 6px;
    -moz-border-radius: 0 6px 6px;
    border-radius: 0 6px 6px 6px;
}

.dropdown-submenu:hover>.dropdown-menu {
    display: block;
}

.dropdown-submenu>a:after {
    display: block;
    content: " ";
    float: right;
    width: 0;
    height: 0;
    border-color: transparent;
    border-style: solid;
    border-width: 5px 0 5px 5px;
    border-left-color: #ccc;
    margin-top: 5px;
    margin-right: -10px;
}

.dropdown-submenu:hover>a:after {
    border-left-color: #fff;
}

.dropdown-submenu.pull-left {
    float: none;
}

.dropdown-submenu.pull-left>.dropdown-menu {
    left: -100%;
    margin-left: 10px;
    -webkit-border-radius: 6px 0 6px 6px;
    -moz-border-radius: 6px 0 6px 6px;
    border-radius: 6px 0 6px 6px;
}
.ef-proweb-dropdown-button {
	background-color: #3e3e3e !important;
	color: rgb(220, 220, 220) !important;
	border: 0px;	
}
.ef-proweb-dropdown-button:hover{
	background-color: rgb(255,160,49) !important;
	color: WHITE !important;	
}
.ef-proweb-dropdown a {
	text-decoration: none;
	background-color: #3e3e3e !important;
	color: rgb(220, 220, 220) !important;	
}
.ef-proweb-dropdown a:hover {
	text-decoration: none;
	background-color: rgb(255,160,49) !important;
	color: WHITE !important;	
}
.dropdown-menu {
	background-color: #3e3e3e ;
}
.ef-proweb-dropdown-sub {
	margin-top: 0px;
	border: 0px;	
}
.ef-proweb-menu-handle {
	position: absolute;
	left: 0px;
	top: 0px;	
}
</style>]]></CSP>


<CSP name="frontEnd/reg/tRegistration.csp" application="/largedevsrc/" default="1"><![CDATA[
<script language="cache" runat="server">w ##class(shared.pageMethods).outputFrontendHeader()</script>
<head>
<layout:section from="" to="{{ef_header}}">
<csp:include page="frontendHTTPheader.csp">
<csp:include page="colourScheme.csp">
</head>
<body class="bodyBackground">
<script language="CACHE" method="OnPreHTTPafter" arguments="" returntype="%Boolean">
	if $G(%session.Data("useExperimentalCMS")) {
		set %response.ServerSideRedirect="t4Registration.csp?pageID="_$G(%session.Data("pageID")) quit 0
	}
	set sessionID=%session.SessionId
	set mode=%request.Get("mode")
	if mode="" set mode=%session.Get("mode")

	quit 1
</script>
<script language="cache" runat="server">
	// flag for making proweb display COD related things
	set isCOD=1
</script>

<sc:templatestart>

<script language="cache" runat="server">
	// v2.7 - need these as we lookup the page description now from the link table
	if '$G(xEventID) set xEventID=$G(%session.Data("eventsforce","backend","xEventID"))
	if '$G(xLangID) set xLangID=$G(%session.Data("eventsforce","backend","xLangID"))
	if '$G(pageID) set pageID=$G(%session.Data("pageID"))
	
	// are we in an accessible layout?
	set isAccessible=##class(layout.methods).isAccessible(xEventID)

	// tell the codQuestionDetails page to go back here after edit/add
	set gotoPage="../../frontend/reg/"_%request.PageName_"?pageID="_pageID
	if %request.Get("hideButtons") set gotoPage=gotoPage_"&hideButtons=1"
	set %session.Data("eventsforce","backend","cod question gotoPage")=gotoPage
 

	if (%session.Get("mode")="preview")!($G(%session.Data("inSitePageEditing")))	{
		set tempPersonID=%request.Get("tempPersonID")
		if $L(tempPersonID)=0 set tempPersonID=$G(%session.Data("eventsforce","frontend","currentPersonID"))
		// find out where to go
		if $L(tempPersonID),'%request.Get("hideButtons"){
			set backforward=##class(setup.objPageNav).goWhere(pageID,,tempPersonID)
			set backpage=$P(backforward,"|",1)  // go back
			set forwardpage=$P(backforward,"|",2)  // go forward
			// get the category (gets it from person or purchase or creates or returns blank if we will show the page to ask for it)
			set eventCategoryID=##class(eCom.tempPurchase).getEventCategory(sessionID,tempPersonID)
		} else { // allow for preview in the backend
			set backforward=""
			set backpage=""
			set forwardpage=""
			set eventCategoryID=%request.Get("eventCategoryID")
		}
	} else {  // edit mode backend
		set backforward=""
		set backpage=""
		set forwardpage=""
		set eventCategoryID=%request.Get("eventCategoryID")
	}
	
	if 'eventCategoryID	{
		set eventCategoryID=%session.Get("eventCategoryID")
	}
	
	if $L(%request.Get("eventCategoryID"))	set %session.Data("eventCategoryID")=%request.Get("eventCategoryID")
	
	// determine whether this is a meeting manager event, this will be used by tagfree
	set isMeetMan=0
	if ##class(setup.objEventSetting).getParameter("event setup","allow meeting manager",xEventID) {
		set isMeetMan=(##class(meetMan.objDiary).getProfilePageID(eventCategoryID,xEventID,xLangID)=pageID)
	}

	/// Are we in a meeting manager page? - initialise this variable here in global scope, do the actual check in a later if block
	set meetManFileUpload=0

	set checkMerge=$G(%session.Data("eventsforce","frontend","checkMerge"))
	if ($E(forwardpage)="?"){ 
		//forward page such as ?tempPersonID=xxx, ie, no page name.
		set forwardpage="../../frontend/reg/codFormSave.csp?pageID="_pageID_"&tempPersonID="_tempPersonID
	}
	
	// don't do JS validation if accessible layout.
	set onsub="this.butProceed.disabled=true;"  
	if 'isAccessible set onsub=onsub_" return validateMandatory();"
</script>

<form name="prowebCODForm" method="post" action="#(forwardpage)#" onsubmit="#(onsub)#" AUTOCOMPLETE="off">
<layout:section from="{{ef_header}}" to="{{ef_banner}}">
<layout:section from="{{ef_banner}}" to="{{ef_main_progress}}">
	<csp:if condition=(($G(%session.Data("mode"))="preview")!($G(%session.Data("inSitePageEditing"))))>
		<csp:if condition=('%request.Get("hideButtons"))>
			<csp:include page="progress.csp">
		</csp:if>
	</csp:if>
<layout:section from="{{ef_main_progress}}" to="{{ef_main_header}}">
<script language="cache" runat="server">
	set pageHeading=..out("Attendee Details")
	if ##class(cod.objTicket).isTicketingPersonMode(xEventID)	{
		set pageHeading=..out("Attendee Details")   // make generic if we're adding people using ticketing as we may show more than one attendee category on this page
	} else {
		set pageHeading=##class(setup.lnkCategoryEvent).getPageDescription(xEventID,eventCategoryID,pageID)
	}
</script>
#(pageHeading)#
<layout:section from="{{ef_main_header}}" to="{{ef_main_content}}">
<script language="cache" runat="server">
	if isAccessible	{
		if $G(%session.Data("eventsforce","frontend","errString"))'="" {
			write !,"<h2 class=""errormessage"">",..out("Error saving data:"),"</h2>"
			set errString=%session.Data("eventsforce","frontend","errString")
			write !,"<ul class=""errormessage"">"
			for i=1:1:$L(errString,"|") w "<li class=""redbold10px errormessage"">"_$p(errString,"|",i)_"</li>"
			write !,"</ul>"
			kill %session.Data("eventsforce","frontend","errString")
		}
	
		// do we have any warnings to show
		if $G(%session.Data("eventsforce","frontend","warning string"))'="" {
			write !,"<h2 class=""warningmessage"">",..out("Warning:"),"</h2>"
			write !,"<ul class=""warningmessage"">"
			write "<li class=""redbold10px warningmessage"">"_%session.Data("eventsforce","frontend","warning string")_"</li>"
			write !,"</ul>"
			kill %session.Data("eventsforce","frontend","warning string")
		}
	}	
</script>
		<table width="100%" border="0" cellspacing="3" cellpadding="0" class="black12px ef-registration-section" id="mainTable">
			<tr>
				<td colspan="2"><sc:text name="header"></td>
			</tr>
				<script language="cache" runat="server">
					if ##class(setup.objEventSetting).getParameter("registration pages","supress hardcoded email field for new and copied events - May 2016",xEventID) {
						set showEmail=0
					} else {
						set showEmail=1	
					}
				</script>
				<csp:if condition="showEmail">
					<script language="cache" runat="server">
						set doNotShowEmail=##class(setup.objEventSetting).getParameter("bookings","do not show delegateUID page",xEventID)
						if ##class(setup.objEventSetting).getParameter("system","do not use email",xEventID) set doNotShowEmail=1
						
						if ##class(cod.objTicket).isTicketingPersonMode(xEventID) set doNotShowEmail=1
						set emailOrUsername=##class(setup.objEventSetting).getParameter("system","identifying field",xEventID)
						
						// Fred Sep 2010 - add an override to hide the email field if required
						if ##class(setup.objEventSetting).getParameter("system","hide email field in tRegistration",xEventID) set doNotShowEmail=1
					</script>
					<csp:if condition=(doNotShowEmail)>
					<csp:else>
						<tr>
							<td class="black12px ef_proweb_form_prompt"><tx>Email</tx></td>
							<td class="black12px ef_proweb_form_field_container ef_proweb_form_field_container_type_text">
								<csp:if condition=(emailOrUsername="username")>
									<script language="cache" runat="server">
										set codID=##class(cod.objItemName).getIDFromDescriptionNoEvent("EMAIL2")
										set tempPersonID=$G(tempPersonID)
									</script>
									<input type="text" name="txtQuestion_#(codID)#__0__#(tempPersonID)#" id="txtQuestion_#(codID)#__0__#(tempPersonID)#" size=50 class="EF_inputBox" value="#(##class(eCom.tempCodData).get(tempPersonID,"email2"))#">
								<csp:else>
									#(##class(eCom.tempCodData).get(%request.Get("tempPersonID"),"email"))#
								</csp:if>
								
							</td>
						</tr>
					</csp:if>
				</csp:if>
			
				<script language="cache" runat="server">
					set ticketingPersonMode=0
					if (%session.Get("mode")="preview")&(##class(cod.objTicket).isTicketingPersonMode(xEventID)),'%request.Get("hideButtons") set ticketingPersonMode=1
				</script>
				<csp:if condition=(ticketingPersonMode)>
						<script language="cache" runat="server">
						// store current pageid before we insert another one
						set curPageID=%request.Get("pageID")
						if curPageID="" set curPageID=$G(%session.Data("pageID"))
						
						// get all the pages for each category
						kill allRegPages,allRegPageIDs
						set ok=##class(setup.lnkCategoryEvent).getAllRegPages(xEventID,xLangID,backendBooking,.allRegPages,.allRegPageIDs)
					</script>
					<script name="rs77" language="SQL" P1="#(sessionID)#">
						SELECT ID
						FROM eCom.tempPerson 
						WHERE (tempPurchase->sessionID = ?) AND (isDelegate=1) AND (active=1) 
						ORDER BY ID
					</script>
					<csp:while condition="rs77.Next()">
						<script language="cache" runat="server">
							set tmpTempPersonID=rs77.Data("ID")
							set tmpEventCategoryID=##class(eCom.tempPurchase).getEventCategory(sessionID,tmpTempPersonID)
							set tmpDesc=" ",tmpDisplayOrder=""
							if tmpEventCategoryID	{
								set tmpDesc=$E(##class(setup.objEventCategory).getDescription(tmpEventCategoryID),1,150)_tmpEventCategoryID
								// go to the first (and only category) reg page
								set tmpDisplayOrder=$O(allRegPages(tmpEventCategoryID,""))
								set tmpPageID=allRegPages(tmpEventCategoryID,tmpDisplayOrder)
								set tmpDisplayOrder=##class(setup.lnkAttendeeCategoryDetailsEvent).getDisplayOrder(xEventID,tmpEventCategoryID)
							}
							set personList(+tmpDisplayOrder,+tmpEventCategoryID)=tmpPageID
							set personList(+tmpDisplayOrder,+tmpEventCategoryID,tmpTempPersonID)=""
						</script>
					</csp:while>
					<script language="cache" runat="server">
						//Save the current tempPersonID from session.
						set oldTempPersonID = $G(%session.Data("eventsforce","frontend","currentPersonID"))
						// repeat the tagfree for each attendee
						set (tmpDisplayOrder,tmpEventCategoryID)=""
						for  {
							set tmpDisplayOrder=$O(personList(tmpDisplayOrder))
							if tmpDisplayOrder="" quit
							for  {
								set tmpEventCategoryID=$O(personList(tmpDisplayOrder,tmpEventCategoryID))
								if tmpEventCategoryID="" quit
								set pageID=personList(tmpDisplayOrder,tmpEventCategoryID)													
								set %session.Data("pageID")=pageID

								// get the page description
								set pageHeading=##class(setup.lnkCategoryEvent).getPageDescription(xEventID,tmpEventCategoryID,pageID)
								do ..OnPageHeadingSection()
								set tempPersonOverride=""
								for  {
									set tempPersonOverride=$O(personList(tmpDisplayOrder,tmpEventCategoryID,tempPersonOverride))
									if tempPersonOverride="" quit
									s tempPersonCountByCat(tmpEventCategoryID) = $G(tempPersonCountByCat(tmpEventCategoryID)) + 1
						
									//save the current personID before going to tagfree.
									s %session.Data("eventsforce","frontend","currentPersonID") =  tempPersonOverride //so that the system can pick up this person's attendee category in tagfree.csp.
									do ..OnPageProwebSection()
								}
							}
						}

						//set the current person to the original personID here. SHAHADAT 18-02-10
						set %session.Data("eventsforce","frontend","currentPersonID") = oldTempPersonID
						// reset the pageID
						if curPageID {
							set pageID=curPageID
							set %session.Data("pageID")=pageID
						}
					</script>
				<csp:else>
					<script language="cache" runat="server">
						// if in edit mode just show one persons fields
						do ..OnPageProwebSection()
					</script>
				</csp:if>
				<script language="cache" runat="server">
					/// Are we in a meeting manager page?
					if isMeetMan {
						if ##class(setup.objEventSetting).getParameter("meetMan","file Upload",xEventID) {
							set meetManFileUpload=1
							do ..OnPageMeetFileSection()
						}
					}
				</script>
				<csp:section name="HeadingSection">
					<tr><td colspan="2" height="10"><hr></td></tr>
					<tr><td colspan="2" height="20">#(pageHeading)#</td></tr>
					<tr><td colspan="2" height="10">&nbsp;</td></tr>
				</csp:section>
				<csp:section name="ProwebSection">
					<script language="cache" runat="server">
						if ($G(isCOD)=1) {
							set beforeItem=##class(sc.xModules.objPage).getBeforeItem(pageID,,1)
						} else {
							set beforeItem=##class(sc.xModules.objPage).getBeforeItem(pageID)
						}
					</script>
					<SC:FREE NAME="Main List" BEFOREROW="" AFTERROW="" BEFOREITEM="#(beforeItem)#" AFTERITEM="</td></tr>">
					<tr><td colspan="2" height="30"></td></tr>
				</csp:section>
				
				<csp:section name="MeetFileSection">
					<tr>
						<td></td>
						<td class="blackbold10px">
							<table border=0 cellpadding=0 cellspacing=0 width=100%>
								<tr>
									<td class="blackbold10px">
										<tx>Uploaded Files</tx>
									</td>
									<td width=70>
										<csp:if condition=(%session.Get("mode")="preview")>
											<csp:if condition=('%request.Get("hideButtons"))>
												<input class="standardButton" type="button"  value="#(..out("Upload"))#" name="butUpload" onClick="SaveAndUploadProfile('#($G(tempPersonID))#');"  title="Upload a file from your computer">
											</csp:if>
										</csp:if>
									</td>
								</tr>
							</table>
						</td>
					</tr>
					<script name="rsMeetMan" language="SQL" P1="#($G(tempPersonID))#">
						SELECT * FROM  meetMan.tempFile
						WHERE tempDiary->tempPerson = ?
						ORDER BY xCRstamp
					</script>
					<tr>
						<td class="black10px" colspan=2>
							<table border=0 cellpadding=2 >
								<script language="cache" runat="server">
									set fileCount=0
									set webPath=##class(meetMan.objFile).getWebPath(xEventID)
									set FTPpath=##class(meetMan.objFile).getFTPpath(xEventID)
								</script>
								<csp:while condition="rsMeetMan.Next()">
									<script language="cache" runat="server">
										set tempEntryFileID=rsMeetMan.Get("ID")
										set filename=rsMeetMan.Get("fileName")
										set hasUploaded=1
										set fileCount=fileCount+1
										
										set date=##class(shared.dateFunctions).multiDate(rs.Get("xCRstamp"),xDateFormat)
										set time=$p($p(rsMeetMan.Get("xCRstamp")," ",2),":",1,2)
										set show=1
										if filename="" set show=0
										
										// if new entry, suppress the ones that was defaulted but we have clicked Remove on
										if $D(%session.Data("eventsforce","frontend","meetMan files to suppress",tempEntryFileID)) set show=0
									</script>		
									<csp:if condition=(show)>
										<tr>
											<td width=100></td>
											<td class="black10px" >
												<script language="cache" runat="server">
													set size=##class(shared.ftpMethods).getFileSize(FTPpath,filename)
												</script>
												<a target="_blank" href="#(webPath_..EscapeURL(filename))#">#($P(filename,"_",3,99))#</a>
												#(size\1024)#&nbsp;Kb															
											</td>
											<td width=40></td>
											<td class="black9px">
												#(date)#&nbsp;&nbsp;#(time)#
											</td>
											<td width=15></td>
											<td class="black9px">
												<a href="javascript: removeProfileFile(#(tempEntryFileID)#);"><tx>remove</tx></a>
											</td>
										</tr>
									</csp:if>
								</csp:while>
							</table>
						</td>
					</tr>
				</csp:section>							
		</table>

<layout:section from="{{ef_main_content}}" to="{{ef_main_buttons}}">
<script language="cache" runat="server">
	set show=1
	if %request.Get("hideButtons") set show=0
	if %session.Get("mode")="edit",'$G(%session.Data("inSitePageEditing")) set show=0
</script>

<csp:if condition=(show)>
	<input type="hidden" name="tempPersonID" value="#(%request.Get("tempPersonID"))#">
	<table width="100%" border="0" cellspacing="0" cellpadding="5">
		<tr>
			<csp:comment><!-- NOTE. The submit button will be placed here in runtime as a proweb item --></csp:comment>
			<td width="33%" align="left">
				<csp:include page="frontEndButton.csp?buttonText=Back&URL=#(..EscapeURL(backpage))#&hoverText=Go Back">
			</td>
			<td width="33%" align="center" style="vertical-align: bottom;">
				<script language="cache" runat="server">
					set show=##class(setup.objEventSetting).getParameter("bookings","Temp Save Max Hours",xEventID)
					if ##class(eCom.tempPurchase).isBackendBooking(sessionID) set show=0
				</script>
				<csp:if condition=(show)>
					<csp:include page="frontEndButton.csp?buttonText=#(..EscapeURL("Save & Return"))#&hoverText=Save your registration for later completion&isSubmit=0&isJS=1&URL=#(..EscapeURL("tempSaveFunc()"))#">
				&nbsp;&nbsp;&nbsp;
				</csp:if>
				<script language="cache" runat="server">
					set ticketingPersonMode=0
					if (%session.Get("mode")="preview")&(##class(cod.objTicket).isTicketingPersonMode(xEventID)),'%request.Get("hideButtons") set ticketingPersonMode=1
					
					set show=1
					
					//only show "add another delegate" option if they've come from the Add Another Attendee link on the basket page, in which case seenBasket will be set
					&SQL(SELECT seenBasket INTO :tmp FROM eCom.tempPurchase WHERE sessionID = :sessionID)
					if ((+SQLCODE=0) && (tmp'=1)){
						set show=0
					}
					
					if ('ticketingPersonMode) { set show=0 }
				</script>
				<csp:if condition=(show)>
					<script language="cache" runat="server">
						//add option to add new delegate 
						set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
						set qry="SELECT ID,categoryToCreate FROM cod.objTicket WHERE (eventID=?) AND (noMoreBookings=0) AND (scCodItemID->active=1)"
						if ('(##class(eCom.tempPurchase).isBackendBooking(sessionID))) {
							set qry=qry_" AND (scCodItemID->backendOnly=0)"
						}
						do rs.Prepare(qry)
						do rs.Execute(xEventID)
					</script>
					<csp:while condition="rs.Next()">
						<script language="cache" runat="server">
							set tmpEventCategoryID=rs.Get("categoryToCreate")
							set show='##class(cod.objTicket).isItemFullAttendees(rs.Get("ID"),sessionID,1) // don't show option to add tix if capacity has been reached
							if '$L(rs.Get("categoryToCreate")) {
								set show=0
							}
							
							if (show) {
								if $D(tempPersonCountByCat(tmpEventCategoryID)) {
									set totalBooked = tempPersonCountByCat(tmpEventCategoryID)
										set maximum=$P(##class(cod.objTicket).getMinMax(rs.Get("ID")),"|",2)
										if maximum,totalBooked>=maximum set show=0										
								}
							}
							if (show){
								set tmpDisplayOrder=+##class(setup.lnkAttendeeCategoryDetailsEvent).getDisplayOrder(tmpEventCategoryID,xEventID)
								set ticketArray(tmpDisplayOrder,tmpEventCategoryID)=rs.Get("ID")
							}
						</script>
					</csp:while>
					<script language="cache" runat="server">
						set tmpDisplayOrder=""
					</script>
					<csp:if condition=($l($o(ticketArray(tmpDisplayOrder))))>
						Add another <select name="selAddTicketCategory" class="ef_element ef_element_dropdown EF_inputBox">
						<option value=""></option>
							<csp:while condition=($l($o(ticketArray(tmpDisplayOrder))))>
							<script language="cache" runat="server">
									set tmpDisplayOrder=$O(ticketArray(tmpDisplayOrder))
									set tmpEventCategoryID=""
							</script>
								<csp:while condition=($l($o(ticketArray(tmpDisplayOrder,tmpEventCategoryID))))>
									<script language="cache" runat="server">
										set tmpEventCategoryID=$O(ticketArray(tmpDisplayOrder,tmpEventCategoryID))
										set tmpTicketID=ticketArray(tmpDisplayOrder,tmpEventCategoryID)
									</script>
									<option value="#(tmpTicketID)#">#(##class(setup.objEventCategory).getDescription(tmpEventCategoryID))#</option>
								</csp:while>
						</csp:while>
						</select>	
					</csp:if>
				</csp:if>									
			
			</td>
			<td width="34%" align="right">
				
				<csp:if condition=((%session.Get("mode")="preview")!($G(%session.Data("inSitePageEditing"))))>
					<input type="hidden" name="tempSave" value=0>
					<input type="hidden" name="pageID" value="#($G(pageID))#">
					<input type="hidden" name="uploadMeetManFile" value=0>
					<input type="hidden" name="mergeWithBooker" value=0>
					<input type="hidden" name="tempFileID" value=0>
					<input type="hidden" name="deleteMeetManFile" value=''>
					<csp:include page="frontEndButton.csp?isSubmit=1&name=butProceed&buttonText=Proceed&hoverText=Submit and proceed">
					<input type="hidden" name="uploadFile" value=''>
					<input type="hidden" name="deleteFile" value=''>
					<input type="hidden" name="uploadItemNameID" value=''>
					<input type="hidden" name="uploadTempPersonID" value=''>
					<input type="hidden" name="uploadGuestNumber" value=''>
					<input type="hidden" name="uploadDataID" value=''>
				<csp:else>
					<img src="../../media/images/english/default/frontend/proceed.gif" alt="Proceed" border="0">
				</csp:if>
				
			</td>
		</tr>
	</table>
</csp:if>
<layout:section from="{{ef_main_buttons}}" to="{{ef_footer}}">

<script language="javascript">
function tempSaveFunc() {
	document.forms[0].tempSave.value=#(pageID)#;
	document.forms[0].submit();
}
</script>

<csp:if condition=(checkMerge)>
	<script language="javascript">
		$(function() {
			if (confirm(#(..QuoteJS(..out("This attendee has the same first and last name as the registration contact, would you like to merge the details?")))#) == true) {
				document.forms[0].mergeWithBooker.value = 1;
				document.forms[0].submit();
			} else {
				document.forms[0].submit();
			}
		})
	</script>
</csp:if>

<csp:if condition=(meetManFileUpload)>
	<script language="javascript">
		function SaveAndUploadProfile(tempPersonID) {
			document.forms[0].uploadMeetManFile.value = 1;
		
			document.prowebCODForm.submit();
		}
		function removeProfileFile(tempFileID) {
			document.forms[0].deleteMeetManFile.value = tempFileID;
			document.prowebCODForm.submit();
		}
	</script>
</csp:if>

<script language="javascript">
	function SaveAndUpload(tempPersonID,dataID,guestNumber) {
		document.forms[0].uploadFile.value = 1;
		document.forms[0].uploadTempPersonID.value=tempPersonID;
		document.forms[0].uploadGuestNumber.value=guestNumber;
		document.forms[0].uploadDataID.value=dataID;
	
		document.prowebCODForm.submit();
	}
	function removeFile(tempPersonID,codItemNameID) {
		document.forms[0].deleteFile.value = codItemNameID;
		document.forms[0].uploadTempPersonID.value=tempPersonID;
		document.forms[0].uploadItemNameID.value=codItemNameID;
		
		document.prowebCODForm.submit();
	}
</script>
	
<layout:section from="{{ef_footer}}" to="">
#[ do ##class(sc.methods).outputFormCompleteMarker() ]#
</form>  

<csp:include page="editingFooter.csp"> 

<sc:templatestop>

<script language="cache" runat="server">
	set amendMode=+$G(%session.Data("eventsforce","frontend","amend"))

	// Do we have any error message from a previous save to show
	if 'isAccessible	{
		if $G(%session.Data("eventsforce","frontend","errString"))'="" {
			write !,"<sc"_"ript language='javas"_"cript'>"
			set errString=%session.Data("eventsforce","frontend","errString")
			set temp=""
			for i=1:1:$L(errString,"|") set temp=temp_$p(errString,"|",i)_$c(10)
			write !,"alert("_..QuoteJS(temp)_");"
			write !,"</sc"_"ript>"
			// allow for messages to non-javascript browsers
			write !,"<nosc"_"ript>"
			write !,##class(shared.stringFunctions).hyperTranslate(temp,$C(10),"<br>")
			write !,"</nosc"_"ript>"
			kill %session.Data("eventsforce","frontend","errString")
		}
	
		// do we have any warnings to show
		if $G(%session.Data("eventsforce","frontend","warning string"))'="" {
			write !,"<sc"_"ript language='javas"_"cript'>"
			write !,"alert("_..QuoteJS(%session.Data("eventsforce","frontend","warning string"))_");"
			write !,"</sc"_"ript>"
			// allow for messages to non-javascript browsers
			write !,"<nosc"_"ript>"
			write !,##class(shared.stringFunctions).hyperTranslate(%session.Data("eventsforce","frontend","warning string"),$C(10),"<br>")
			write !,"</nosc"_"ript>"
			kill %session.Data("eventsforce","frontend","warning string")
		}
	}	
</script>
</body>
</html>
]]></CSP>


<CSP name="system/eventsForceRules.csr" application="/largedevsrc/" default="1"><![CDATA[
	// please note that the NEW command dannot be used in rules! (nor the: <CSP:if>)


// This little beuty replaces the given path in compile time with a call to an inherited page method in runtime!
// It also translates the 'Alt' and the 'Title' attributes
<csr:RULE name="PathExpander" match="IMG[SRC]" empty>
<csr:ACTION>
<script language="cache" runat="compiler">
	set inPath=%this.GetAttribute("SRC")
	if inPath'["StreamServer" { // leave streamed images
		if inPath["#(" {
			// do nothing if dynamic
		} else {
			set inPath="#(..resolvePath("""_inPath_"""))#" 
			do %this.SetAttribute("SRC",inPath)
		}
	}
		
	set titleText=%this.GetAttribute("TITLE")
	//if (titleText'="")&(titleText'["#(") set titleText="#(##class(shared.translation).translateSingle(%request.PageName,%session.Get(""xLanguage""),"""_titleText_"""))#" 
	if (titleText'="")&(titleText'["#(") set titleText="#(..out("""_$TR(titleText,"""","'")_"""))#" 
	do %this.SetAttribute("TITLE",titleText)

	set altText=%this.GetAttribute("ALT")
	//if (altText'="")&(altText'["#(") set altText="#(##class(shared.translation).translateSingle(%request.PageName,%session.Get(""xLanguage""),"""_altText_"""))#" 
	if (altText'="")&(altText'["#(") set altText="#(..out("""_$TR(altText,"""","'")_"""))#" 
	do %this.SetAttribute("ALT",altText)
	
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>


//Same as above but for input tags with images (submit button to you and me)
<csr:RULE name="PathExpander2" match="INPUT[SRC]" empty>
<csr:ACTION>
<script language="cache" runat="compiler">
	set inPath=%this.GetAttribute("SRC")
	if inPath'["StreamServer" { // leave streamed images
		if inPath["#(" {
			// do nothing if dynamic
		} else {
			set inPath="#(..resolvePath("""_inPath_"""))#" 
			do %this.SetAttribute("SRC",inPath)
		}

	}

	set titleText=%this.GetAttribute("TITLE")
	//if (titleText'="")&(titleText'["#(") set titleText="#(##class(shared.translation).translateSingle(%request.PageName,%session.Get(""xLanguage""),"""_titleText_"""))#" 
	if (titleText'="")&(titleText'["#(") set titleText="#(..out("""_$TR(titleText,"""","'")_"""))#" 
	do %this.SetAttribute("TITLE",titleText)
	
	set altText=%this.GetAttribute("ALT")
	//if (altText'="")&(altText'["#(") set altText="#(##class(shared.translation).translateSingle(%request.PageName,%session.Get(""xLanguage""),"""_altText_"""))#" 
	if (altText'="")&(altText'["#(") set altText="#(..out("""_$TR(altText,"""","'")_"""))#" 
	do %this.SetAttribute("ALT",altText)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efA" match="ef-a" myData>
<csr:ACTION>
<script language="cache" runat="compiler">
	set %this.TagName="a"
	do ##class(EF.ui.cspRuleMethods).linkStandatdURLAttributes(%this)
	do ##class(EF.ui.cspRuleMethods).htmlEncodeAllAttributes(%this)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efSelect" match="ef-select" myData>
<csr:ACTION>
<script language="cache" runat="compiler">
	set %this.TagName="select"
	do ##class(EF.ui.cspRuleMethods).linkStandatdURLAttributes(%this)
	do ##class(EF.ui.cspRuleMethods).htmlEncodeAllAttributes(%this)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efInput" match="ef-input" myData>
<csr:ACTION>
<script language="cache" runat="compiler">
	set %this.TagName="input"
	do ##class(EF.ui.cspRuleMethods).linkStandatdURLAttributes(%this)
	do ##class(EF.ui.cspRuleMethods).htmlEncodeAllAttributes(%this)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

// language thing for href tags with titles
<csr:RULE name="titleAHREF" match="A[TITLE]" myData>
<csr:ACTION>
<script language="cache" runat="compiler">
	set titleText=%this.GetAttribute("TITLE")
	if (titleText'="")&(titleText'["#(") set titleText="#(..out("""_$TR(titleText,"""","'")_"""))#" 
	do %this.SetAttribute("TITLE",titleText)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

// language thing for span tags with titles
<csr:RULE name="titleSPAN" match="SPAN[TITLE]" myData>
<csr:ACTION>
<script language="cache" runat="compiler">
	set titleText=%this.GetAttribute("TITLE")
	if (titleText'="")&(titleText'["#(") set titleText="#(..out("""_$TR(titleText,"""","'")_"""))#" 
	do %this.SetAttribute("TITLE",titleText)
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>

// Replace the path to the stylesheet
// No longer needed, but you can't just delete a csp rule
<csr:RULE name="StyleSheetFinder" match="LINK[HREF]" empty>
<csr:ACTION>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>


// Translate the breadtext
<csr:RULE name="breadText" match="tx" myData>
<csr:attribute name=cl description="The classname to use in the span" type="expression:STRING">
<csr:attribute name=nospan description="If 1 then do not surround the text with a span" type="expression:STRING">
<csr:ACTION>
<script language="cache" runat="compiler">
	// Replace the innertext with a call to ..out()
	set txText=%this.InnerText()   // GET THE CONTENTS OF THE TX TAGS
	set txText=$TR(txText,"""","'")
	set (v1plus,v2plus,v3plus)=0
	
	// extract the variables
	set var1=$P($p(txText,"#(",2),")#",1)
	if var1?1"+".E set var1=$e(var1,2,99),v1plus=1
	if var1'="" set txText=$p(txText,"#(",1)_"{{{VAR01}}}"_$p(txText,")#",2,99)

	set var2=$P($p(txText,"#(",2),")#",1)
	if var2?1"+".E set var2=$e(var2,2,99),v2plus=1
	if var2'="" set txText=$p(txText,"#(",1)_"{{{VAR02}}}"_$p(txText,")#",2,99)

	set var3=$P($p(txText,"#(",2),")#",1)
	if var3?1"+".E set var3=$e(var3,2,99),v3plus=1
	if var3'="" set txText=$p(txText,"#(",1)_"{{{VAR03}}}"_$p(txText,")#",2,99)
	  
	set routine=classname // classname is intersystems variable. it might change in the next version
	
	set string="..out("""_txText_""""
	set string=string_","""_routine_""""
	if var1'="" {
		if var1="BR" {
			set string=string_","_$S(v1plus:"+",1:"")_"<BR>"
		} else {
			set string=string_","_$S(v1plus:"+",1:"")_"$G("_var1_")"
 		}
	}
	if var2'="" set string=string_","_$S(v2plus:"+",1:"")_"$G("_var2_")"
	if var3'="" set string=string_","_$S(v3plus:"+",1:"")_"$G("_var3_")"
	set string=string_")"
	
	//set CSSclassname="ef_tx_normal" // fred june 2009 - removed becuase it is creating mixed font sizes when data is mixed with text
	set CSSclassname=""
	if $L(..GetAttribute("cl")) set CSSclassname=..GetAttribute("cl")
	
	// do not write out the span if we specifically say so or if backend page
	set doSpan=1
	if CSSclassname="" set doSpan=0
	
	if ..GetAttribute("nospan")=1 set doSpan=0
	if $L($G(%pageName)),$ZCVT(%pageName,"L")["/backend/" set doSpan=0

	if doSpan do ..WriteText("<span class="""_CSSclassname_""">")
	Do ..WriteExpressionText(string) 
	if doSpan do ..WriteText("</span>")

	//Do ..WriteExpressionText("..out("_txText_")   // csp rule:breadText")     
	//
</script>
</csr:ACTION>
</csr:RULE>


<!-- SYSTEMTYPE IF --------------------------------------------- -->
// create if statements around a section of code based on the systemType (setup.objSystemType)
<csr:rule name="systemTypeIF" match="SYSTEMTYPE:IF">
<csr:attribute name=module required description="A run-time expression to be evaluated." type="expression:STRING">
<csr:attribute name=autoelse description="should this write the standard page not allowed msg" type="expression:STRING">

<csr:description>
	The autoelse=1 causes an ELSE to be written automatically containing the "This is only available in the following editions..." message
	If autoelse is used then you CANNOT use ELSE.
	<EXAMPLE>
		<systemType:if module="EMAIL" autoelse="1">
			do email stuff
		</systemType:if>
	</EXAMPLE>
</csr:description>

<csr:class super=%CSP.RuleBlock>

<csr:action>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>
		Do ..NewBlock()
		Set ..NextLabel=..GetNewLabel()
		Do ..WriteServer(" If '(##class(setup.objSystemTypes).isModuleAllowed("""_..GetAttribute("MODULE")_""")) Goto "_..NextLabel_" ;{")
	</SCRIPT>
	<csr:children>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>
		New ifblock
		if ..GetAttribute("AUTOELSE")=1	{   // if this is used then cannot use an ELSE tag - otherwise it will not work.
			Set ifblock=..GetCurrentBlock()
			If ifblock.EndLabel="" Set ifblock.EndLabel=..GetNewLabel()
			Do ..WriteServer(" Goto "_ifblock.EndLabel_" ;} END IF")
			Do ..WriteServer(ifblock.NextLabel_" ;{ START ELSE")
			// do the standard msg stuff
			Set ifblock.NextLabel=""
		}

		New comment Set comment=" ;} END ELSE"
		If ..EndLabel'="" Do ..WriteServer(..EndLabel_comment) Set comment=""
		If ..NextLabel'="" Do ..WriteServer(..NextLabel_comment)
		Do ..RemoveBlock()
	</SCRIPT>
</csr:action>

</csr:rule>

<!-- SYSTEMTYPE ELSE --------------------------------------------- -->
<csr:rule name="systemTypeELSE" match="SYSTEMTYPE:IF/SYSTEMTYPE:ELSE" empty>

<csr:description>
	see description for systemTypeIF
</csr:description>

<csr:class super=%CSP.RuleBlock>

<csr:action>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>
		New ifblock
		Set ifblock=..GetCurrentBlock()
		If ifblock'="" {
			If ifblock.EndLabel="" Set ifblock.EndLabel=..GetNewLabel()
			Do ..WriteServer(" Goto "_ifblock.EndLabel_" ;} END IF")
			Do ..WriteServer(ifblock.NextLabel_" ;{ START ELSE")
			Set ifblock.NextLabel=""
		}
	</SCRIPT>
</csr:action>
</csr:rule>

<csr:rule name="layoutSection0" match="LAYOUT:SECTION" empty>
<csr:attribute name=from required description="the tag to start writing from" type="expression:STRING">
<csr:attribute name=to required description="the tag to end at" type="expression:STRING">
<csr:action>
<script language="cache" runat="compiler">
	//Do ..WriteExpressionText(string) 
	//do ..WriteText("</span>")
    Do ..WriteServer(" do ##class(layout.objTemplate).writeBit("""_..GetAttribute("FROM")_""","""_..GetAttribute("TO")_""")")
</script>
</csr:action>
</csr:rule>

// =============================================================================================================================
<csp:comment><!-- PROWEB RULES--></csp:comment>
	// please note that the NEW command cannot be used in rules! (nor the: <CSP:if>)
// =============================================================================================================================



<csr:rule name="TEMPLATESTART" match="SC:TEMPLATESTART" empty dwenabled>
<csr:description>
	The <B>CS:TEXT</B> tag is the proWeb's initialising a template page.
</csr:description>
<csr:action>
<script language="cache" runat="server">
	set app=##class(sc.objData).applicationPath()
	do ##class(cspRealEV.system.proweb.templatestart).OnPageCSPROOT()
	
	// put the pageID int the session
	// JAW - done in template start (security hole) if %request.Get("pageID")'="" set %session.Data("pageID")=%request.Get("pageID")
</script>

</csr:action>
</csr:rule>

// =============================================================================================================================
<csr:rule name="TEMPLATESTOP" match="SC:TEMPLATESTOP" empty dwenabled>
<csr:description>
	The <B>CS:TEXT</B> tag is the proWeb's ending a template page.
</csr:description>
<csr:action>
<script language="cache" runat="server">
	set app=##class(sc.objData).applicationPath()
	do ##class(cspRealEV.system.proweb.templatestop).OnPageCSPROOT()
</script>
<script language="javascript">
// open popup window
function proWebNewWin(mypage,myname,w,h,scroll){
	leftPos = (screen.width) ? (screen.width-w)/2 : 0;
	topPos = (screen.height) ? (screen.height-h)/2 : 0;
	settings = 'height='+h+',width='+w+',top='+topPos+',left='+leftPos+',scrollbars=' + scroll + ',resizable=yes'
	win = window.open(mypage,myname,settings)
	win.focus();
}
</script>
</csr:action>
</csr:rule>

// =============================================================================================================================
<csr:rule name="TEXT" match="SC:TEXT" empty dwenabled>
<csr:description>
	The <B>CS:TEXT</B> tag is the proWeb's way of outputting a block of text. It will include an external page that only handles texts. Texts may include html formatting.
</csr:description>
<csr:attribute name="NAME" description="Specifies the component name of the template page" type="accessType:STRING">
<csr:action>
 <script language="CACHE" runat="SERVER">
	new pageURL,app
  
	// retrieve the passed component name
	set %session.Data("componentName")=##'%this.GetAttribute("NAME")'##

	set app=##class(sc.objData).applicationPath()
	set pageURL=app_"/system/proWeb/tagText.csp"
	do ##class(cspRealEV.system.proweb.tagtext).OnPageCSPROOT()
 </script>
</csr:action>
</csr:rule>


// =============================================================================================================================
<csr:rule name="FREE" match="SC:FREE" empty dwenabled>
FRRE RULE
<csr:description>
	The <B>SC:FREE</B> tag is the proWeb's way of outputting a list of freely chosed items. It will include an external page that only handles lists.
</csr:description>
<csr:attribute name="NAME" description="Specifies the component name of the template page" type="accessType:STRING">
<csr:action>
<script language="CACHE" runat="SERVER">
	do ##class(EF.pages.frontend.base).outputProwebListRows(##'%this.GetAttribute("NAME")'##, %session.Get("pageID"),1)
	s a="test"
</script>
</csr:action>
</csr:rule>

// =============================================================================================================================
<csr:rule name="IMAGE" match="SC:IMAGE" empty dwenabled>
<csr:description>
	The <B>CS:IMAGE</B> tag is the proWeb's way of outputting an image. It will include an external page that only handles images.
</csr:description>
<csr:attribute name="NAME" description="Specifies the component name of the template page" type="accessType:STRING">
<csr:action>
 <script language="CACHE" runat="SERVER">
  new pageURL,app
  
  // retrieve the passed component name
  set %session.Data("componentName")=##'%this.GetAttribute("NAME")'##
  set app=##class(sc.objData).applicationPath()
  set pageURL=app_"/system/proweb/tagImage.csp"
	if +$system.Version.GetNumber()<5 {		
	  	do DisplayPage^%customCSP(pageURL)
	} else {
		do ##class(cspRealEV.system.proweb.tagimage).OnPageCSPROOT()
	}

 </script>
</csr:action>
</csr:rule>



<csr:RULE name="HTMLLANG" match="HTML" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
    // set the lang attribute for the HTML tag
    Do ..SetAttribute("lang","en")
</script>
<csr:DEFAULT>
</csr:ACTION>
</csr:RULE>



<csr:RULE name="efBackendToggle" match="EF:BACKEND:TOGGLE" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendToggleAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendToggleAttr"_"("""_attr_""")="_value)
	}
</script>
<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderEfBackendToggle(.efRulesVarBackendToggleAttr)
</script>
</csr:ACTION>
</csr:RULE>



<csr:RULE name="efBackendTextField" match="EF:BACKEND:TEXTFIELD" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendTextFieldAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendTextFieldAttr"_"("""_attr_""")="_value)
	}
</script>
<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendTextField(.efRulesVarBackendTextFieldAttr)
</script>
</csr:ACTION>
</csr:RULE>



<csr:RULE name="efBackendTextArea" match="EF:BACKEND:TEXTAREA" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendTextAreaAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendTextAreaAttr"_"("""_attr_""")="_value)
	}
</script>
<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendTextArea(.efRulesVarBackendTextAreaAttr)
</script>
</csr:ACTION>
</csr:RULE>



<csr:RULE name="efBackendURLField" match="EF:BACKEND:URLFIELD" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendURLFieldAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendURLFieldAttr"_"("""_attr_""")="_value)
	}
</script>
<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendURLField(.efRulesVarBackendURLFieldAttr)
</script>
</csr:ACTION>
</csr:RULE>


<csr:RULE name="efBackendImageUploader" match="EF:BACKEND:IMAGEUPLOADER" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarImageUploaderAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarImageUploaderAttr"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderImageUploader(.efRulesVarImageUploaderAttr)
</script>
</csr:ACTION>
</csr:RULE>


<csr:RULE name="efBackendSaveButton" match="EF:BACKEND:SAVEBUTTON" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendSaveButtonAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendSaveButtonAttr"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendSaveButton(.efRulesVarBackendSaveButtonAttr)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efBackendButton" match="EF:BACKEND:BUTTON" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendButtonAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendButtonAttr"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendButton(.efRulesVarBackendButtonAttr)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efBackendColorPicker" match="EF:BACKEND:COLORPICKER" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendColorPickerAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendColorPickerAttr"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendColorPicker(.efRulesVarBackendColorPickerAttr)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efBackendInlineColorPicker" match="EF:BACKEND:INLINECOLORPICKER" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendInlineColorPickerAttr")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendInlineColorPickerAttr"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendInlineColorPicker(.efRulesVarBackendInlineColorPickerAttr)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efBackendErrorMessage" match="EF:BACKEND:ERRORMESSAGE:START" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesVarBackendErrorMessage")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesVarBackendErrorMessage"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendErrorMessageStart(.efRulesVarBackendErrorMessage)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efBackendErrorMessageEnd" match="EF:BACKEND:ERRORMESSAGE:STOP" empty>
<csr:ACTION>
<script language="CACHE" runat="SERVER">
   Do ##class(pageClasses.backendComponentMethods).renderBackendErrorMessageEnd(.efRulesVarBackendErrorMessage)
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efPageControllerElement" match="ef-pc-element" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesTempParams")
   kill paramsordered
   
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesTempParams"_"("""_attr_""")="_value)
	}
	
</script>
<script language="CACHE" runat="SERVER">
    set pageID = ##class(shared.pageMethods).getPageID()
    if pageID {
		set efRulesTempParams("pageid")=pageID
    }
   Do pageController.renderHTMLControlFromTag(.efRulesTempParams)
   kill efRulesTempParams
</script>
</csr:ACTION>
</csr:RULE>


<csr:rule name="efPageControllerContainer" match="ef-pc-container">

<csr:class super=%CSP.RuleBlock>

<csr:action>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>
		Do ..NewBlock()
		Set ..NextLabel=..GetNewLabel()
		Do ..WriteServer(" kill efRulesTempParams")
		kill paramsordered
		do ..GetAttributesOrdered(.paramsordered)
		set index=""
		for {
			set index=$o(paramsordered(index))
			if index="" quit
			set attr=$ZCVT($LIST(paramsordered(index),1),"L")
			set value=..QuoteAttribute(attr)
			Do ..WriteServer(" set efRulesTempParams"_"("""_attr_""")="_value)
		}
		Do ..WriteServer(" if 'pageController.showElementFromTag(.efRulesTempParams) Goto "_..NextLabel_" ;{")
	</SCRIPT>
	<script language="CACHE" runat="SERVER">
	   Do pageController.renderContainerStartFromTag(.efRulesTempParams)
	   kill efRulesTempParams
	</script>
	<csr:children>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>
		Do ..WriteServer(" kill efRulesTempParams")
		kill paramsordered
		do ..GetAttributesOrdered(.paramsordered)
		set index=""
		for {
			set index=$o(paramsordered(index))
			if index="" quit
			set attr=$ZCVT($LIST(paramsordered(index),1),"L")
			set value=..QuoteAttribute(attr)
			Do ..WriteServer(" set efRulesTempParams"_"("""_attr_""")="_value)
		}
		Do ..WriteServer(" if 'pageController.showElementFromTag(.efRulesTempParams) Goto "_..NextLabel_" ;{")
	</SCRIPT>
	<script language="CACHE" runat="SERVER">
	   Do pageController.renderContainerEndFromTag(.efRulesTempParams)
	</script>
	<SCRIPT LANGUAGE=CACHE RUNAT=COMPILER>

		New comment Set comment=" ;} END Container"
		If ..NextLabel'="" Do ..WriteServer(..NextLabel_comment)
		Do ..RemoveBlock()
	</SCRIPT>
</csr:action>
</csr:rule>

<csr:RULE name="efFrontendlabel" match="ef-label" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesTempParams")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesTempParams"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   do ##class(EF.ui.components.frontend.label).renderFromEfLabelRule(.efRulesTempParams)
   kill efRulesTempParams
</script>
</csr:ACTION>
</csr:RULE>

<csr:RULE name="efAwardsCategoryDropdown" match="ef-awards-category-dropdown" empty>
<csr:ACTION>
<script language="CACHE" runat="COMPILER">
   Do ..WriteServer(" kill efRulesTempParams")
   kill paramsordered
   do ..GetAttributesOrdered(.paramsordered)
   set index=""
   for {
		set index=$o(paramsordered(index))
		if index="" quit
		set attr=$ZCVT($LIST(paramsordered(index),1),"L")
		set value=..QuoteAttribute(attr)
		Do ..WriteServer(" set efRulesTempParams"_"("""_attr_""")="_value)
	}
</script>

<script language="CACHE" runat="SERVER">
   do ##class(EF.ui.backend.controls.awardsCategoryDropdown).renderFromEfLabelRule(.efRulesTempParams)
   kill efRulesTempParams
</script>
</csr:ACTION>
</csr:RULE>
]]></CSP>


<Class name="layout.cssDefaultMethods">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: layout.cssDefaultMethods.CLS/EV.78
;vc; Component: CLS.layout.cssDefaultMethods
;vc;  Location: SmallDev
;vc; Date/Time: 02-Sep-16 14:26
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>layout.cssDefaultMethods.CLS/EV.78</td><td>CLS.layout.cssDefaultMethods</td><td>SmallDev</td><td style='white-space: nowrap;'>02-Sep-16 14:26</td><td>JeremyW</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<ClassType/>
<ProcedureBlock>1</ProcedureBlock>
<TimeChanged>64204,41926.682357</TimeChanged>
<TimeCreated>63046,56232.897117</TimeCreated>

<Method name="outputDefaultCSS">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID,layoutTemplateID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	do ..outputComponentCSS()
	w "<style>",!
	
	do ..outputFonts()
	do ..outputGeneralCSS()
	do ..outputGeneralProgressBarCSS()
	do ..outputGeneralKendoCSS()
	if '##class(layout.objTemplate).isTemplateGen3(layoutTemplateID)	{
		do ..outputLegacyClasses()	
	}
	do ..outputSegmentedButtonCSS()
	do ..outputAgendaGridListSwitchCSS()
	do ..outputAgendaGeneralCSS()
	do ..outputAgendaPopoverCSS()
	
	if ##class(layout.objTemplate).isTemplateGen3(layoutTemplateID)	{
		do ..outputGen2and3Defaults()
		do ..outputGen3Defaults()
		do ##class(layout.cssOverrideMethods).outputDynamicCSS(xEventID)
	}
	w !,"</style>",!
]]></Implementation>
</Method>

<Method name="outputLegacyClasses">
<Description>
yellow red grey etc. Used for ALL templates below gen3</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputLegacyClasses() ======= */
		a {
			color: #111111; 
		}
		a:hover { 
			color: #666666;
		}
		.yellow {background-color: #F4F4F4;}
		.grey {background-color: #e6e6e6;}
		.red, .k-calendar td.ef-date-picker-event-day {
			background-color : SILVER;
		}
		.k-calendar td.ef-date-picker-event-day {
			border-radius: 0;
		}
		.ef-time-span {
			white-space: nowrap;	
		}
		
		div.ef-button-area .ef_frontend_button_proceed,div.ef-button-area .ef-logout-button {
			float : right;
			margin-right: 0px;
			margin-left: 12px;
		}
		.k-picker-wrap .k-select {
			padding-top: 1px;	
		}
		
		input.efDatePicker, input.efTimePicker { 
			/* input box */
			margin: 0px;
			border-width: 0px;

			color: inherit;
		}

		.efDatePicker .k-picker-wrap, .efTimePicker .k-picker-wrap {
			/* inner span */
			padding: 0px;
			margin: 0px;
		}

		.efDatePicker, .efTimePicker {
			/* out span */
			padding: 0px;
			margin:0px;
		}
		
			
		
	>
]]></Implementation>
</Method>

<Method name="outputGen2and3Defaults">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputGen2and3Defaults() ======= */
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section input[type=email],
		.ef-registration-section textarea, 
		.ef-registration-section select,
		.EF_inputBox,ef-table-booking-footer,
		.select2-dropdown {
			font-family: Verdana, Arial, Helvetica, sans-serif; 
			font-size: 14px; 
			font-style: normal; 
			line-height: normal; 
			font-weight: normal; 
			text-decoration: none;			
		}
		.select2-container .select2-selection--single .select2-selection__rendered {
			padding-left: 5px;
		}
		.ef-registration-section input[type=text]:not(.efDatePicker):not(.efTimePicker) ,
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section input[type=email],
		.ef-registration-section textarea, 
		.ef-registration-section select,
		.EF_inputBox:not(.efDatePicker):not(.efTimePicker) {
			padding: 5px;
			margin-top: 2px;
			margin-bottom: 2px;
			border-width: 1px;
			border-style: solid; 
		}

		.ef-registration-section .select2-container {
			padding: 2px 0 2px 0;
		}
		.ef-registration-section .select2-container--default .select2-selection--single {
			background: none;
			border: none;
		}
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section input[type=email],
		.ef-registration-section textarea, 
		.ef-registration-section select {
			max-width: 481px;
			width: 89%;
		}
	
		
		@font-face {
		  font-family: 'Roboto Slab';
		  font-style: normal;
		  font-weight: 300;
		  src: local('Roboto Slab Light'), local('RobotoSlab-Light'), url(https://themes.googleusercontent.com/static/fonts/robotoslab/v1/dazS1PrQQuCxC3iOAJFEJR_xHqYgAV9Bl_ZQbYUxnQU.woff) format('woff');
		}
		@font-face {
		  font-family: 'Roboto Slab';
		  font-style: normal;
		  font-weight: 400;
		  src: local('Roboto Slab Regular'), local('RobotoSlab-Regular'), url(https://themes.googleusercontent.com/static/fonts/robotoslab/v1/y7lebkjgREBJK96VQi37ZobN6UDyHWBl620a-IRfuBk.woff) format('woff');
		}
		@font-face {
		  font-family: 'Roboto Slab';
		  font-style: normal;
		  font-weight: 700;
		  src: local('Roboto Slab Bold'), local('RobotoSlab-Bold'), url(https://themes.googleusercontent.com/static/fonts/robotoslab/v1/dazS1PrQQuCxC3iOAJFEJTqR_3kx9_hJXbbyU8S6IN0.woff) format('woff');
		}
 		
		.k-datepicker, .k-timepicker {
			border-radius: 0;
		}
		
		.k-picker-wrap {
			border-radius: 0;
			border:none;
		}
		.k-picker-wrap .k-input {
			border-radius: 0;
		}
		
		.ef_frontend_button, .standardButton, .strongButton, .hyperlinkButton, .ef_frontend_file_uploader .k-upload-button {
			margin-top:15px;
			
		}
		
		.ef-table .ef_frontend_button,
		.ef-table .standardButton,
		.ef-table .strongButton,
		.ef-table .hyperlinkButton,
		.ef-registration-section .ef_frontend_button,
		.ef-registration-section .standardButton,
		.ef-registration-section .strongButton,
		.ef-registration-section .hyperlinkButton,
		.ef-registration-section .ef_frontend_file_uploader .k-upload-button {
			margin-top:0px;
			
		}
		.ef_frontend_button, .ef_frontend_file_uploader .k-upload-button {
			cursor: pointer;
			font-family: Verdana, Arial, Helvetica, sans-serif;
			font-weight: normal;
			padding: 6px 15px;
			cursor: pointer;
			font-size: 12px;
			width: auto;
			-moz-border-radius: 5px;
			border-radius: 5px;
			line-height: 18px;
		}
		.ef_frontend_button:hover, .ef_frontend_file_uploader .k-upload-button {
			text-decoration: none;
			background-image:inherit;
			background-position:inherit;
			box-shadow: none;
		}
		.ef_frontend_button_proceed:hover {
			text-decoration: none;
		}
		.ef_proweb_form_prompt {
			text-align: right;
		}
		.ef-required-field::after {
		    content: " *";
		    color: red;			
		}
		.ef-dependent-field::after {
		    content: "";
		}
		/*  begin new classes for Proweb2 */
		.ef-proweb-form-row-editable, .ef-proweb-form-row {
			padding-top: 4px;
			padding-bottom:4px;	
		}
		.ef-proweb-input-element-short {
			width: 30%;
			text-align: left; 	
		}

		.ef-proweb-radio-group {
			text-align: left;
			padding-bottom: 0px;
			padding-top: 0px;	
		}
		.ef-proweb-radio-button {
			padding-left: 0px;	
			padding-top: 0px;
			padding-bottom: 0px;
			font-weight: 700;
		}
		.ef-proweb-input-element {
			width: 90%;
			float: left;	
		}
		.ef-proweb-checkboxGroup {
			text-align: left;	
		}
		.ef-proweb-error-panel { /* ################## */
			margin-left: 10%;
			margin-right: 10%;
			padding: 0px;
			background-color: RED;
			color: WHITE;	
		}
		.panel, .ef-proweb-guest-panel {
			  border: 1px solid #c8c8c8;
  			  margin-bottom: 18px;
			  background-color: #eeeeee;
			  border: 1px solid transparent;
			  border-radius: 4px;
			  -webkit-box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
			  box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
		}
		 
		.ef-proweb-guest-panel .panel-heading {
		  font-family: MuseoSlab500Regular, Verdana, Geneva, Arial, Helvetica, sans-serif;
		  font-size: 14px;
		  font-weight: normal;
		  color: white;
		  background: #0091aa;
		  padding: 5px;
		}
		.ef-proweb-guest-panel .panel-body {
			padding: 0px;	
		}
		
		/* end new classes for Proweb2 */
		
		.ef-registration-section td label {
			display: inline-block;
		    font-weight: normal;
		    margin-bottom: 0;
		    width: 100%;
		}		

		.ef-registration-section td.ef_proweb_form_prompt label {
		    text-align: right;
		}
		.ef-registration-section label.ef-radio {
			display: inline;
		   
		}
		
		
		body, p, h2, h3, td, div, .black10px, .blackbold10px, .black12px, .blackbold12px, .red9px, .whitebold12px,
		.ef_proweb_menu_ul, .ef_proweb_menu_ul a, .dropdown .btn, .EF_inputBox, .ef_frontend_button,
		.ef_frontend_file_uploader .k-upload-button, .ef_frontend_button:hover, .ef_frontend_file_uploader .k-upload-button:hover,
		.ef_frontend_button_proceed, .ef_frontend_button_proceed:hover, td.ef_proweb_form_prompt,
		.whitebold10px, a.whitebold10px:hover, .yellow, td.yellow, .grey, td.grey,
		.ef_progress_bar_text, .ef-table th,
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section textarea, 
		.ef-registration-section select {
			font-family: Verdana, Geneva, Kalimati, sans-serif;
		}
		body {
			background-color: #96C3C8;
		}
		h1 {
			color: #17b3c4;
			font-family: 'Roboto Slab',Verdana,Arial,Helvetica,sans-serif	
		}
		.ef_proweb_menu_ul, .ef_proweb_menu_ul a, .dropdown .btn,
		.select2-container--default .select2-results__option--highlighted[aria-selected]  {
			background-color: #17b3c4;	
			color: #FFFFFF;
		}
	>
	w ".ef_proweb_menu_ul li:hover, .ef_proweb_menu_ul a:hover, .dropdown .btn:hover, .dropdown .btn:focus, .open>.dropdown-toggle.btn-primary"
	w "	  {"
	w "		background-color: #128996;"
	w "		color: #FFFFFF;"
	w "	}"
	&html<
		.EF_inputBox, 
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section textarea, 
		.ef-registration-section select,
		.select2-dropdown,
		.select2-container--default .select2-selection--single .select2-selection__rendered {
			background-color: #D8ECEE; 
			color: #111111;
			border-color: #AAAAAA;
		}
		.select2-container--default .select2-selection--single .select2-selection__placeholder {
			color: inherit;
		}
		.ef-registration-section input[type=text]:disabled,
		.ef-registration-section input[type=password]:disabled,
		.ef-registration-section input[type=number]:disabled,
		.ef-registration-section input[type=url]:disabled,
		.ef-registration-section input[type=tel]:disabled,
		.ef-registration-section textarea:disabled, 
		.ef-registration-section select:disabled {
			background-color: #EEEEEE; 
		}
		.ef_form_divider {
			color: #17b3c4;
			border-color:#17b3c4;
			background-color: #17b3c4;
		}
		.ef_progress_bar_progress_div {	
			background-color:#17b3c4;
		}
		.ef_progress_bar_border_div {	
			border: 1px solid  #AAAAAA;
		}
		.ef_frontend_button, .ef_frontend_file_uploader .k-upload-button {
			color: #111111;
			background-color: #96C3C8;
			border: 1px solid #AAAAAA;
		}
		.ef_frontend_button:hover, .ef_frontend_file_uploader .k-upload-button:hover {
			color: #111111;
			background-color: #D8ECEE;
		}
		.ef_frontend_button_proceed {
			color: #FFFFFF;
			background-color: #17b3c4;
			border: 1px solid #FFFFFF;
		}
		
		.ef_frontend_button_proceed:hover {
			color: #FFFFFF;
			background-color: #128996;
		}
		.ef_frontend_file_uploader .k-file-progress .k-progress {
		    background-color:#17b3c4
		}

		.ef_frontend_help_text_icon {
			background-color: #17b3c4;
			color: #FFFFFF;
			border-color: #128996;
			float: left;
		}
		.ef_frontend_help_text_popover {
			background-color: #17b3c4;
			border-color: #128996;
		}
		.ef_frontend_help_text_popover .ui-tooltip-tip, .ef_frontend_help_text_popover .qtip-tip {
			border-color: #128996;
			background-color: #17b3c4;
		}
		.ef-table-header td, 
		.ef-table-header th,
		.ef-table th {
			background-color:  #128996;
			color: #FFFFFF;
		}
		.ef-table-header a {
			color: inherit;
		}
		.ef-info-table td:first-child {
		    color: #888888;
		}
		.select2-container--default .select2-results__option[aria-selected=true] {
		    background: none;
		}
		
		.k-calendar td.ef-date-picker-event-day {
			background-color: silver;
			border-radius: 0;
		}
		input[type=checkbox].ef-multicheckbox  {
			margin-left: 0px;
			margin-right: 10px;	
		}
		.ef-multicheckbox-checkbox-label  {
			margin-left: 0px;
			margin-right: 10px;	
		}		
	>
	w " .ef_frontend_help_text_content>pre { color: #FFFFFF}"
]]></Implementation>
</Method>

<Method name="outputGen2Defaults">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		.ef-logo {padding-bottom:16px;}
		.red, .k-calendar td.ef-date-picker-event-day {
			background-color: #128996;
		}
		.whitebold10px, a.whitebold10px:hover {
			color: #FFFFFF;
		}
		/* changed box-sizing for Gen2 to make the selects the same widths as the inputs */
		.ef-registration-section select {
			-ms-box-sizing:content-box;
    		-moz-box-sizing:content-box;
    		box-sizing:content-box;
    		-webkit-box-sizing:content-box; 
		}
		.EF_inputBox.efDatePicker {
			padding: 0px;
		}
		
		.EF_inputBox.efTimePicker {
			padding: 0px;	
		}
		input.k-input, .ef-registration-section input.k-input {
			height: 28px;
		}
		.k-picker-wrap .k-select {
			border-left: 0;
		}
		
		.efDatePicker .k-picker-wrap,.efTimePicker .k-picker-wrap{
			/* inner span */
			padding-right: 26px;
		}
		.k-picker-wrap .k-select {
			padding-top: 6px;	
		}

	>
]]></Implementation>
</Method>

<Method name="outputGen3Defaults">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputGen3Defaults() ======= */
		.ef-custom-content-section img {
		  display: block;
		  max-width: 100%;
		  height: auto;
		}		
		
		a {
			color: #111111; 
			text-decoration:underline;
		}
		a:hover {
			color: #666666;
			text-decoration:underline;
		}
		/* THIS BIT IF FOR THE NEW TABLE CLASSESS */
		.ef-table td {
			color: BLACK;
			border-collapse: collapse;	
		}
		.ef-table-header
		 {
			background-color: SILVER;	
		}
		.ef-table-header td, 
		.ef-table-header th
		 {
			font-weight: bold;
			font-size: 12px;
			vertical-align: bottom;
		}
		.ef-instructionText {
			color: BLACK !important;	/* '!important' to override element style in markup */
			margin-left: 0px !important;	
		}

		.ef-table tr:nth-child(odd) {
		    background-color: #e6e6e6;
		}
		.ef-table tr:nth-child(even) {
		    background-color: #F4F4F4;
		}
		.ef-table tr.ef-row-odd, tr.ef-row-odd {
			background-color: #E6E6E6; 
		}
		.ef-table tr.ef-row-even, tr.ef-row-even {
			background-color: #F4F4F4; 
		}
		.ef-table table tr:nth-child(n) { /* used to stop the striping where each line is a table within a table */
			background-color: inherit;
			padding: 0px;
		}
		.ef-image-table	{
			table-layout: fixed;	/* needed for responsive images*/ 
		}
		.ef-logo { 
			padding-top:16px;
		}
		@media only screen and (min-width: 768px) {
			div.ef-button-area .ef_frontend_button_proceed,div.ef-button-area .ef-logout-button {
				float : right;
				margin-right: 0px;
				margin-left: 12px;
			}
		}
		.ef-table-booking-footer {
			margin-left: 20px;	
		}
		/* THIS BIT IS FOR OOVERRIDING BOOTSTRAP */
		input[type=radio], input[type=checkbox] {
		    margin: 3px 3px 3px 3px;
		}

		.ef-ie6 .container, .ef-ie7 .container, .ef-ie8 .container  {
	            width: 970px; 
	        }
	        #timeoutbox {
				font-size: 12px;
				padding: 12px;
				font-weight: normal;

	        }	
		.ef-table h4 {
			font-size: 12px;
			font-weight: bold;	
		}
		
		[class*="col-"] .select2-container {
		    width:89%!important;
		    max-width: 481px;
		}
		

	>
	write ".dropdown .btn, .btn-primary:hover, .btn-primary:focus, .btn-primary:active, .btn-primary.active, .open > .dropdown-toggle.btn-primary {",!
	write "	border-color: #FFFFFF;",!	
	write "}",!
]]></Implementation>
</Method>

<Method name="outputComponentCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set eventID=$G(%session.Data("eventsforce","frontend","xEventID"))
	if eventID {
		set layoutTemplateID=##class(layout.objTemplate).getLayoutForEvent(eventID)
		if ##class(layout.objTemplate).isTemplateUsingBootstrap(layoutTemplateID) {
			&html<
				<!-- ======= outputComponentCSS() ======= -->
				<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" type="text/css" />
			>
		}
	}
	&html<

		<link type="text/css" href="#(##class(EF.htmlGenerator).rawHTML(##class(shared.pageMethodsFrontend).getKendoBaseURL()))#/styles/kendo.common.min.css" rel="Stylesheet" />
		<link type="text/css" href="#(##class(EF.htmlGenerator).rawHTML(##class(shared.pageMethodsFrontend).getKendoBaseURL()))#/styles/kendo.silver.min.css" rel="Stylesheet" />

		<link rel="stylesheet" type="text/css" media="screen" href="//cdn.jsdelivr.net/qtip2/2.2.1/jquery.qtip.min.css" />
		
		<link rel="stylesheet" type="text/css" media="screen" href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/css/select2.min.css" />
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">	
	>
]]></Implementation>
</Method>

<Method name="outputFonts">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	
	&html<
	/* ======= outputFonts() ======= */
	@font-face { 
		font-family: 'CasinoHandRegular';
		src: url('../../media/components/frontend/fonts/Casino_Hand-webfont.eot');
		src: url('../../media/components/frontend/fonts/Casino_Hand-webfont.eot?#iefix') format('embedded-opentype'),
    	url('../../media/components/frontend/fonts/Casino_Hand-webfont.woff') format('woff'),
    	url('../../media/components/frontend/fonts/Casino_Hand-webfont.ttf') format('truetype'),
    	url('../../media/components/frontend/fonts/Casino_Hand-webfont.svg#CasinoHandRegular') format('svg');
    	font-weight: normal;
    	font-style: normal;
	}
	>
	/* end @font-face declarations */
]]></Implementation>
</Method>

<Method name="outputGeneralProgressBarCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputGeneralProgressBarCSS() ======= */
		.ef_progress_bar_border_div {
			width: 100%;
			max-width: 300px;
			border: 1px solid #AAAAAA;
			height: 12px;
			text-align: center;
			box-sizing: content-box;
			margin: 4px auto 4px auto;
			display:block;
		}
		.ef_progress_bar_progress_div {
			height: 100%;
			border: none;
			background-color: rgb(220, 220, 220);
			text-align: left;
			float: left;
		}
		.ef_progress_bar_text {
			color: #666666;
			font-size: 12px;
			font-style: normal;
			line-height: normal;
			padding:4px;
			text-align: center;
			display:block;
		}
		#ef_progressbar {
			margin-bottom: 12px;	
		}	
	>
]]></Implementation>
</Method>

<Method name="outputGeneralKendoCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputGeneralKendoCSS() ======= */ 
		
		/* date picker tweaking */

		

		.efDatePicker .k-picker-wrap, .efTimePicker .k-picker-wrap {
			border-width: 1px;
			border-style: solid;
			border-color: inherit;
			color: inherit;
		}
		.efDatePicker, .efTimePicker {
			border-width: 0px;
		}
		
		.k-picker-wrap {
			border-radius: 0;
		}
		.k-picker-wrap .k-input {
			border-radius: 0;
		}
		
		.ef_frontend_file_uploader .k-upload-status {
			display: none;	
		}
		.ef-ie8 .ef_frontend_file_uploader .k-upload-status,
		.ef-ie9 .ef_frontend_file_uploader .k-upload-status {
			display: block;
			position: inherit;
			margin-top: 16px;
			font-weight: normal;
		}
		.ef_frontend_file_uploader .k-upload {
 			position: inherit;
 			border-width:0px;
 			background: none;
		}
		.ef_frontend_file_uploader {
			background-color: inherit;
		}
		.ef_frontend_file_uploader .k-upload-button {
			margin-top:16px;
 			margin-bottom: 16px;
			margin-left: 0px;
			margin-right: 0px;
			line-height: 12px;
			float: left;
			clear: left;
		}
		
	    .ef_frontend_file_uploader .k-upload-files {
	     	border: 0px;   
	    }
	    .ef_frontend_file_uploader .k-file {
	     	border: 0px;
	     	background-color: inherit;
	    }
	    .ef_file_wrapper {
		    color: #000000;
		    text-align: left;
		    width: 100%
	    }
	    .ef_frontend_file_uploader .k-file-progress .k-progress {
		    background-color: #777777;
		}
		.ef_frontend_file_upload_progress_container {
			width:100%;
			position: relative;
			float: left;
			clear: left;
		}
	    li.k-file div.ef_file_wrapper
	    {
	        position: relative;
	    }
	    .ef_file_wrapper {
		 	margin-left:12px;
		 	margin-right:12px;
		 	margin-bottom:6px;  
		 	margin-top:6px;
	    }
	    .ef_frontend_file_uploader.k-content {
		    min-height: 84px;
		    width: 100%;
		    text-align: right;
	    }
	    
	    .ef_frontend_file_uploader .k-upload-files {
		 	line-height: 18px; 
	    }
	    
	>
]]></Implementation>
</Method>

<Method name="outputGeneralCSS">
<Description>
The basic frontend default stuff</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputGeneralCSS() ======= */ 
		.ef-registration-section input[type=text],
		.ef-registration-section input[type=password],
		.ef-registration-section input[type=number],
		.ef-registration-section input[type=url],
		.ef-registration-section input[type=tel],
		.ef-registration-section input[type=email],
		.ef-registration-section textarea, 
		.ef-registration-section select {
			width: 360px;
		}
		.ef-table {
		    width: 100%;
	    	margin-top: 10px;
	    	margin-bottom: 10px;
		}
		
		.ef-table td {
			padding-top: 7px;
			padding-bottom: 7px;
			padding-left: 8px;
			padding-right: 8px;
		}
		
		/* For embedded tables */
		.ef-table table td {
			padding-top: 0;
			padding-bottom: 0;
			padding-left: 0;
			padding-right: 0;
		}
		
		table.ef-registration-section {
			border-collapse: collapse;
			border-spacing: 0;
			border:0;
		}
		table.ef-registration-section td {
			padding-top: 4px;
			padding-bottom: 4px;
			padding-left: 4px;
			padding-right: 4px;
		}
		
		/* For embedded tables */
		.ef-registration-section table td {
			padding-top: 0;
			padding-bottom: 0;
			padding-left: 0;
			padding-right: 0;
		}

		.ef-registration-section label.ef-radio {
		    margin-right: 12px;
		}
		
		.ef-table .ef-item-discount {
			padding-left: 24px;	
		}
		.noPrint { 
		
		}
		@media print {
			.noPrint { 
				display:none; 
			}
			 a[href]:after {
   				 content: none !important;
  			}
  			a:link {
	  			text-decoration: none;	
  			}
		}
		.ef_form_divider {
			height: 2px;
			border: 0px;
			border-top: 0px solid;
			border-bottom: 0px solid;
			margin-top: 12px;
			margin-bottom: 12px;	
		}
		td.ef_proweb_form_prompt {
			width:31%;
		}
		.ef-registration-section table td.ef_proweb_form_prompt_dependent {
			padding-right: 6px;	
		}
		.ef-registration-section table td.ef_proweb_form_input_dependent {
			padding-left: 3px;	
		}
		.ef_element {
			margin-left: 0px;	
		}
		.ef_element_dependent_disabled_but_visible,
		.select2-container.ef_element_dependent_disabled_but_visible {
			background-color: #DDDDDD;
		}
			
		/* mandatory prompt asterisk */
		.mandatory {
			color: red;	
		}
		
		.ef_frontend_text_limit_exceeded {
			color: red;		
		}
		
		img.helpIcon {
			vertical-align: middle;
		}
		
		/* highlighted mandatory form fields */
		.EF_inputBox.mandatoryIgnored,
		.mandatoryIgnored,
		.ef-registration-section .EF_inputBox.mandatoryIgnored,
		.ef-registration-section .mandatoryIgnored,
		.ef-registration-section .select2-container--default.mandatoryIgnored .select2-selection--single .select2-selection__rendered {
			background-color: #fc9d9d;	
		}
		/* remove spacing on hidden dep prompts + text blocks */
		.hiddenDep { display: none; } 
		/* general instructions text style */
		.ef_frontend_instructions_text {
			font-family: CasinoHandRegular, Verdana, Arial, Helvetica, sans-serif;
			font-size: 16px;
		}
		
		.ef_frontend_overflow_ellipsis {
			white-space: nowrap;
	   		overflow: hidden;
			text-overflow: ellipsis;
			-o-text-overflow: ellipsis;
			-ms-text-overflow: ellipsis;
		}
		
		.ef_frontend_button, .ef_frontend_file_uploader .k-upload-button {
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
			font-weight: bold;
			font-size: 9px;
			text-decoration: none;
			color: black;
		}
		.standardButton {
		}
		.strongButton {
		}
		.hyperlinkButton {
		}
		.ef_frontend_button_proceed {
			min-width:85px;
		}
		.ef_frontend_button_back {
			min-width:85px;
		}
		.ef_frontend_help_text_icon {
			background-color: rgb(220,220,220);
			color: rgb(0,0,0);
			font: 12px Helvetica, Verdana, Arial, sans-serif;
			font-weight: 800;
			height: 16px;
			width: 16px;
			-moz-border-radius: 12px;
			-webkit-border-radius: 12px;
			border-radius: 12px;
			cursor: default;
			display: inline-block;
			text-align: center;
			margin-left: 12px;
			border-width: 1px;
			border-style: solid;
			border-color: #AAAAAA;
			line-height: 17px;
			text-indent: 0;
		}
		.ef_frontend_help_text_popover {
			background-color: rgb(220,220,220);
			border-color: #AAAAAA;
			-moz-border-radius: 6px;
			-webkit-border-radius: 6px;
			border-radius: 6px;
			-webkit-box-shadow: 0px 0px 10px 0px rgb(100,100,100);
			-moz-box-shadow: 0px 0px 10px 0px rgb(100,100,100);
			box-shadow: 0px 0px 10px 0px rgb(100,100,100);
		}
		.ef_frontend_help_text_popover div {
			margin: 0;
		}
		.ef_frontend_help_text_popover .ui-tooltip-tip, .ef_frontend_help_text_popover .qtip-tip {
			border-color: #AAAAAA;
			background-color: rgb(220,220,220);
		}
		
		
		.ef-awards-review hr {
			margin-top: 24px;	
			margin-bottom: 12px;	
		}
		.ef-awards-review h2 {
			margin-bottom:20px;
		}
		.ef-awards-criteria-header {
			padding-bottom:12px;	
		}
		
		.ef-awards-review label {
			font-weight: normal;
		}
		.ef-awards-review .ef-info-label {
			font-weight: bold;
		}
		.ef-primary-field {
			font-weight: bold;	
		}
		.ef-awards-review .reviewDivs {
			padding-top:12px;	
		}
		div.ef-button-area {
			margin-top: 6px;
			margin-bottom: 6px;	
		}
		.ef-button-area .ef_frontend_button, .ef-button-area a {
			margin-top: 6px;
			margin-bottom: 6px;
			margin-right:12px;
		}
		.ef-button-area a {
			white-space:nowrap;		
		}
		
		.ef-meeting-manager-contentbox {
			margin: 12px 0px 12px 0px;
			font-size: 10pt;
			background-color: #F2F2F2;
			border: 1px solid black;
			padding-left: 4px;
			padding-right: 4px;
			padding-top: 4px;
			padding-bottom: 4px;

		}
		
	>
	w " .ef_frontend_help_text_content>pre {",!
	&html<
			color: rgb(0,0,0);
			background-color: transparent;
			border: none;
			padding: 0px;
			font:  12px Helvetica, Verdana, Arial, sans-serif;
			margin: 0px;
			overflow: hidden;
			white-space: pre-wrap;       /* css-3 */
			white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
			white-space: -pre-wrap;      /* Opera 4-6 */
			white-space: -o-pre-wrap;    /* Opera 7 */
			word-wrap: normal;
			word-break: normal;
		}

		.ef_proweb_form_field_container textarea {
		    resize: vertical;
		}

		#top {position: absolute; top: -8em; display: none} /*Opera*/
		* html #top {display: block; position: absolute; top: -8em; left: 0; z-index: 0} /*Seen by IE*/
		html:not([dummy]) #top {display: block; position: absolute; top: -8em; left: 0; z-index: 0} /*Seen by Moz and FF*/
		/* class for reg prompt table rows while being dragged in edit mode */
		.tDnD_whileDrag {
			background-color:#F0F0F0;
		}
		/*  transparent BG for new templates which add a bg image/color to Moxie */
		.transparentMoxieBG {
			background: transparent none;
		}
		.ef_frontend_presenter_details_biography {
			max-width: 600px;
		}
		.ef_frontend_presenter_details_picture img {
			max-width: 200px;
		}
		.ef_frontend_presenter_details_title_and_name h1 {
			margin-bottom: 8px;
		}
		.ef_frontend_presenter_details_job_title h4 {
			font-weight: 700;
			margin: 0;
		}
		.ef_frontend_presenter_details_company h4 {
			font-weight: 400;
			margin: 0 0 1rem 0;
		}
		.ef-menu-block {
	    	margin-bottom: 20px;
		}
		.ef-menu-block .dropdown-menu {
		    top: auto;
		}

		#timeoutbox {
			position: absolute;
			top: 40%;
			left: 50%;
			width:300px;
			margin-left: -150px;
			z-index: 9999;
			background-color:#ffffff;
			padding:5px;
			border:1px;
			solid #666;
			text-align:center;
			font-weight:bold;
			visibility:hidden;
			-moz-border-radius: 11px;
			-webkit-border-radius: 11px;
			border-radius: 11px;	
		}
		#socialMediaModule{
			width:100%;
			height:100%;
			margin:10px 0px 20px 0px;
			z-index:999;
		}
    	#smShareButtons{
	    	height: 30px; }
    	.addthis_toolbox {
	    	height: 30px;
	    }
    	#smFollowButtons{
	    	margin:20px 0px;
	    }
    	#smFollowButtons img{
	    	vertical-align:bottom;
	    	*vertical-align:middle;
	    	border:0px;
	    	margin:0px 5px;
	    }
    	#smShareButtons .a{
	    	margin:2px 4px 0px;
	    }
    	#socialMediaModuleMenu{
	    	width:100px;
	    	height:40px;
	    	display:block;
	    }		    
    	#smFollowButtonsMenu{
	    	float:left;
	    	padding:0px 20px;
	    }
    	#smFollowButtonsMenu img{
	    	vertical-align:bottom;
	    	margin:5px 10px;
	    	border:0px;
	    }
		.ef-table-sub-heading {
			background-color: #CCCCCC;
			font-weight: bold;
		}
	
		.ef_proweb_form_field_container_type_textarea .ef_frontend_help_text_icon {
			vertical-align: top;
		}
		.ef-info-table td:first-child {
		    text-align: right;
		    padding-right: 5px;
		    min-width: 120px;
		}

		.ef-session-time {
			vertical-align: top;	
			text-align: right;
			width: 150px;
		}
		
		.ef-date-time,
		.ef-session-price,
		.ef-no-wrap {
			white-space: nowrap;
		}
		.ef-table .ef-author-name {
			padding-top: 0px;
		}
		.ef-table .ef-abstract-description {
			padding-bottom: 0px;
		}
		.ef-table .ef-abstract-time,
		.ef-table .ef-abstract-description{
			padding-top: 0px;
		}
		.ef-table .ef-abstract-time {
			padding-bottom: 0px;
			text-align: right;	
		}
		.ef_session_details_panel_session_property_description .ef-author-name {
			margin-bottom:7px;	
		}

		.ef-author-affiliation {
		    font-style: italic;
		}
		.ef-author-country {
			font-style: italic;				
		}

		.ef-info-table td {
		    vertical-align: top;
		}

		.ef-table .ef-table-sub-row td {
		    padding-top: 0px;
		    vertical-align: top;
		}

		.ef-table .ef-table-sub-header {
		    font-weight:bold;
		}

		.ef-session-details-sub-row {
		    margin-bottom: 4px;
		}

		.ef-primary-field {
		    font-weight: bold;
		}


		.ef-info-table pre {
			text-align: left;	
		}
		.ef-table .ef-session-name-with-abstracts,
		.ef-table .ef-session-name-with-abstracts .ef-session-price label
		 {
			font-weight: bold;	
			
		}
		.ef-table .ef-session-name-with-abstracts,
		.ef-table .ef-session-name,
		.ef-table .ef-session-location,
		.ef-table .ef-session-book, 
		.ef-table .ef-session-price,
		.ef-table .ef-session-abstract-price,
		.ef-table .ef-session-boookingLevel-capacity,
		.ef-table .ef-session-abstract-boookingLevel-capacity,
		.ef-table .ef-session-type {
			vertical-align: top;
		}
		.ef-table .ef-session-boookingLevel-capacity,
		.ef-table .ef-session-abstract-boookingLevel-capacity {
			text-align: center;	
		} 
		
		.ef-session-collision {
			background-color: red;	
		}
		.ef-session-price label {
			font-weight: normal;
		}
		.ef-session-booking-checkbox-disabled {
			background-image: url(../../media/images/english/default/frontend/cross_trans.gif);
			width: 13px;
			height: 13px;	
			border: 0px;
			margin-top: 5px;
			margin-bottom: 0px;
		}
		.ef-session-booking-checkbox-ticked {
			background-image: url(../../media/images/english/default/frontend/tick.gif);
			width: 13px;
			height: 13px;	
			border: 0px;
			margin-top: 5px;
			margin-bottom: 0px;
		}		
		.ef-session-list-abstract-row {
			font-weight: normal;	
		}
		.ef-table .ef-presenter {
			padding-top: 0px;	
		}
		.ef-inline-filter-row {
			float: left;
			margin-top: 12px;
			margin-bottom: 12px;
		}
		.ef-inline-filter-dropdown {
			float: left;
		}
		.ef-inline-filter-row .ef-inline-filter-dropdown:not(:first-child) {
			margin-left: 16px;
		}
		.ef-inline-filter-dropdown select {
			min-width: 150px;
			max-width: 300px;
		}
		#ef-absReviewList-review-button-column {
			width: 100px;
		}
		
		.ef-registration-section .select2-container--default .select2-selection--single {
			border-radius: 0;
		}
		.select2-container--default .select2-results__option--highlighted[aria-selected] {
			color: inherit;
		}
		
		.select2-container--default .select2-results__option.loading-results[aria-disabled="true"],
		.select2-container--default .select2-results__options .option.load-more {
			color: inherit;
			opacity: 0.5;
			font-style: italic;
		}
		.select2-container--default .select2-results__options .option.load-more {
			padding: 6px;
		}

		/* bug workaround: https://github.com/select2/select2/issues/3306 */		
		.select2-selection__clear {
		    position: absolute !important;
		    right: 20px !important;
		}
		
		.select2-container--default .select2-selection--single .select2-selection__rendered .ef-select2-templated-selection {
			overflow: hidden;
			text-overflow: ellipsis;
			padding-right: 16px;
			line-height: inherit;
		}
		
		.ef-highlight-warning {
			color: #cc0000;
			font-weight: bold;
		}
	>
]]></Implementation>
</Method>

<Method name="outputAgendaPopoverCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputAgendaPopoverCSS() ======= */
		/* sesstion details popover panel styles */
		.ef_qtip_session_details_popover {
			min-width: 350px;
			background: none;
			border: 0;
		}
		.ef_qtip_session_details_popover .ui-tooltip-content, .ef_qtip_session_details_popover .qtip-content {
			padding: 0;
			-moz-border-radius: 6px;
			-webkit-border-radius: 6px;
			border-radius: 6px;
			border: 0;
			-webkit-box-shadow: 0px 0px 10px 0px rgb(100,100,100);
			-moz-box-shadow: 0px 0px 10px 0px rgb(100,100,100);
			box-shadow: 0px 0px 10px 0px rgb(100,100,100);
			-ms-filter: "progid:DXImageTransform.Microsoft.Shadow(Strength=4, Direction=135, Color='#646464')";
			filter: progid:DXImageTransform.Microsoft.Shadow(Strength=4, Direction=135, Color='#646464');
		}
		.ef_qtip_session_details_popover .ui-tooltip-tip, .ef_qtip_session_details_popover .qtip-tip {
			border: 1px solid rgb(100,100,100);
			background: rgb(100,100,100);
		}
		/* this is the outermost container */
		.ef_session_details_panel_container {
			background: rgb(255,255,255);
			width: 350px;
			display: none;
			z-index: 999999999;
			overflow: hidden;
			-moz-border-radius: 6px;
			-webkit-border-radius: 6px;
			border-radius: 6px;
			margin: 0;
		}
		
		/* main sub containers */
		.ef_session_details_panel_session_properties_container {
			padding: 10px 10px 10px 10px;
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_session_info_container {
			padding: 12px 12px 12px 12px;
			display: block;
			margin: 0;
		}
	>
	
	w " .ef_session_details_panel_session_info {",!
	w "		_height: expression( this.scrollHeight > 300 ? ""300px"" : ""auto"" );",!
	w "		max-height: 300px;"
	w "		_width: expression( this.scrollWidth > 350 ? ""350px"" : ""auto"" );"
	w "		max-width: 350px;"
	w "		overflow-y: auto;"
	w "		display: block;"
	w "		margin: 0;"
	w "		background: #ffffff;"
	w "	}",!
	&html<
		.ef_session_details_panel_session_info p {
			color: rgb(160,160,160);
		}
		.ef_session_details_panel_action_button_container {
			height: 42px;
			width: 348px;
			text-align: center;
			display: inline-block;
			margin: 0;
		}
		/* each row of ef_session_details_panel_session_properties_container */
		.ef_session_details_panel_session_property_row {
			overflow: hidden;
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_session_property_row_top_spacing {
			margin-top: 10px;
		}
		/* general icon/description styling */
		.ef_session_details_panel_session_property_icon {
			height: 24px;
			width: 24px;
			float: left;
			display: inline;
			background-repeat: no-repeat;
			background-position: left center;
			display: inline-block;
			margin: 0;
			text-align: center;
			vertical-align: middle;
		}
		.ef_session_details_panel_session_property_description {
			float: left;
			display: inline;
			width: 298px;
			padding: 2px 4px 2px 4px;
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_session_property_description p {
			margin-top: 0;
			margin-bottom: 0;
		}
		/* session title / description */
		.ef_session_details_panel_title_icon {
			background-image: url("../../media/images/english/default/frontend/popover_info.png");
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_title_description {
			display: inline-block;
			margin: 0;
		}
		/* time/location */
		.ef_session_details_panel_time_location_icon {
			background-image: url("../../media/images/english/default/frontend/popover_clock.png");
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_time_location_description {
			display: inline-block;
			margin: 0;
		}
		/* presenter */
		.ef_session_details_panel_presenter_icon {
			background-image: url("../../media/images/english/default/frontend/popover_person.png");
			display: inline-block;
			margin: 0;
		}
		/*abstract presentation*/
		.ef_session_details_panel_abstract_icon {
			background-image: url("../../media/images/english/default/frontend/presentation-icon-16x16.png");
			display: inline-block;
			margin: 0;
		}
		
		
		.ef_session_details_panel_presenter_description,
		.ef_session_details_panel_presenter_description	 {
			display: inline-block;
			margin: 0;
		}
		.ef_session_details_panel_abstract_description {
			font-size: 10.5px;
		}
		
				
		
		/* the action button */
		.ef_session_details_panel_action_button {
			width: 326px;
			margin-left: auto;
			margin-right: auto;
			height: 30px;
			display: inline-block;
			text-align: center;
			font-size: 18px;
			font-family: 'Verdana';
			line-height: 30px;
			-webkit-border-radius: 4px; 
			-moz-border-radius: 4px;
			border-radius: 4px; 
			-moz-user-select: none;
		  	-khtml-user-select: none;
		  	-webkit-user-select: none;
		  	user-select: none;
		}
		
		.ef_session_details_panel_action_button_no_info_spacing {
			margin-top: 12px;
		}
		
	    .ef_frontend_ie7 .ef_qtip_session_details_popover .qtip-content,
	    .ef_frontend_ie8 .ef_qtip_session_details_popover .qtip-content {
			filter: none;
	    }
		
	    .ef_frontend_ie9 .ef_session_details_panel_action_button_add,
	    .ef_frontend_ie9 .ef_session_details_panel_action_button_remove {
			filter: none;
	    }
	    
		.ef_session_details_panel_action_button_add {
			border: 1px solid rgb(115,229,255);
			-webkit-border-radius: 4px; 
			-moz-border-radius: 4px;
			border-radius: 4px; 
			-webkit-box-shadow: 0 -1px 1px 0 rgb(48,116,168);
			-moz-box-shadow: 0 -1px 1px 0 rgb(48,116,168);
			box-shadow: 0 -1px 1px 0 rgb(48,116,168);
			color: #FFFFFF;
		 	cursor: pointer;
			background-color: rgb(73,193,242); /* Old browsers */
			background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzQ5YzFmMiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMzMDc0YTgiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
			background-image: -moz-linear-gradient(top,  rgb(73,193,242) 0%, rgb(48,116,168) 100%); /* FF3.6+ */
			background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgb(73,193,242)), color-stop(100%,rgb(48,116,168))); /* Chrome,Safari4+ */
			background-image: -webkit-linear-gradient(top,  rgb(73,193,242) 0%,rgb(48,116,168) 100%); /* Chrome10+,Safari5.1+ */
			background-image: -o-linear-gradient(top,  rgb(73,193,242) 0%,rgb(48,116,168) 100%); /* Opera 11.10+ */
			background-image: -ms-linear-gradient(top,  rgb(73,193,242) 0%,rgb(48,116,168) 100%); /* IE10+ */
			background-image: linear-gradient(to bottom,  rgb(73,193,242) 0%,rgb(48,116,168) 100%); /* W3C */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#49c1f2', endColorstr='#3074a8',GradientType=0 ); /* IE6-8 */
		}
		.ef_session_details_panel_action_button_remove {
			border: 1px solid rgb(204,125,125); 
			-webkit-border-radius: 4px; 
			-moz-border-radius: 4px;
			border-radius: 4px; 
			-webkit-box-shadow: 0 -1px 0 0 rgb(179,49,36);
			-moz-box-shadow: 0 -1px 0 0 rgb(179,49,36);
			box-shadow: 0 -1px 0 0 rgb(179,49,36);
			color: #FFFFFF;
		 	cursor: pointer;
			background-color: rgb(193,107,93); /* Old browsers */
			background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2MxNmI1ZCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNiMzMxMjQiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
			background-image: -moz-linear-gradient(top,  rgb(193,107,93) 0%, rgb(179,49,36) 100%); /* FF3.6+ */
			background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgb(193,107,93)), color-stop(100%,rgb(179,49,36))); /* Chrome,Safari4+ */
			background-image: -webkit-linear-gradient(top,  rgb(193,107,93) 0%,rgb(179,49,36) 100%); /* Chrome10+,Safari5.1+ */
			background-image: -o-linear-gradient(top,  rgb(193,107,93) 0%,rgb(179,49,36) 100%); /* Opera 11.10+ */
			background-image: -ms-linear-gradient(top,  rgb(193,107,93) 0%,rgb(179,49,36) 100%); /* IE10+ */
			background-image: linear-gradient(to bottom,  rgb(193,107,93) 0%,rgb(179,49,36) 100%); /* W3C */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#c16b5d', endColorstr='#b33124',GradientType=0 ); /* IE6-8 */
		}
		
		.ef_session_details_panel_action_button_disabled {
			background-image: none;
			cursor: default;
			background: rgb(245,245,245);
			border: 1px solid rgb(220,220,220);
			color: rgb(200,200,200);
		}
		
		.ef_session_details_panel_action_button_conflict_code {
			background-image: none;
			cursor: default;
			background: rgb(245,245,245);
			border: 1px solid rgb(220,220,220);
			color: rgb(200,200,200);
		}
		
		.ef_session_details_panel_action_button_conflict_time {
			background-image: none;
			cursor: default;
			background: rgb(245,245,245);
			border: 1px solid rgb(220,220,220);
			color: rgb(200,200,200);
		}
		.ef_session_details_panel_before_booking_button_icon {
			background-image: url("../../media/images/english/default/frontend/popover_info.png");
			display: inline-block;
			margin: 0;
			height: 24px;
			width: 24px;
			float: left;
			display: inline;
			background-repeat: no-repeat;
			background-position: left center;
			text-align: center;
			vertical-align: top;
			color: rgb(200,200,200);
		}
		
		.ef_session_details_panel_before_booking_button_container {
			padding: 12px;
		}
		
		.ef_session_details_panel_before_booking_button_text {
			padding: 2px 4px 2px 4px;
			color: rgb(130,130,130);
		}
		
		div.qtip-content { margin: 0; }
	>
]]></Implementation>
</Method>

<Method name="outputSegmentedButtonCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputSegmentedButtonCSS() ======= */
		.ef_segmented_button_container {
			border: 1px solid rgb(255,255,255);
			display: inline-block; /* For modern browsers */
			*display:inline; /* Hack for IE 7 and less */
			 zoom:1; /* Hack for IE */
			_height:1%; /* Hack for IE6 */
			vertical-align:top; /* Just makes sure everything is at the top */
			font-family: "Trebuchet MS", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", Tahoma, sans-serif;
			font-size: 14px;
			height: 22px;
			overflow: hidden;
			
			-moz-border-radius: 6px;
			-webkit-border-radius: 6px;
			border-radius: 6px;
			
			-webkit-box-shadow: 0px 1px 2px rgba(0,0,0,0.3);
			-moz-box-shadow: 0px 1px 2px rgba(0,0,0,0.3);
			box-shadow: 0px 1px 2px rgba(0,0,0,0.3);
			
			-moz-user-select: none;
		  	-khtml-user-select: none;
		  	-webkit-user-select: none;
		  	user-select: none;
		  	box-sizing: content-box;
		}
		.ef_segmented_button_container div {
			float: left;
		}
		.ef_segmented_button {
			cursor: pointer;
			height: 22px;
			line-height: 22px;
		}
		.ef_segmented_button_text {
			padding: 0 16px;
		}
		.ef_segmented_button_previous {
			background-image: url("../../media/images/english/default/frontend/left-arrow.png");
		    background-repeat: no-repeat;
		    height: 19px;
		    margin: 2px 4px 1px 8px;
		    width: 12px;
		}
		.ef_segmented_button_next {
			background-image: url("../../media/images/english/default/frontend/right-arrow.png");
		    background-repeat: no-repeat;
		    height: 19px;
		    margin: 2px 8px 1px 4px;
		    width: 12px;
		}
		.ef_segmented_button_disabled_outer_off {
			cursor: default;
		}
		.ef_segmented_button_disabled_off {
			cursor: default;
			background-image: none;
		}
		.ef_segmented_button_icon {
			padding: 0 8px;
		}
		.ef_segmented_button_icon_inner {
			vertical-align: middle;
			background-position: center;
			background-repeat: no-repeat;
			border: 0;
		}
		.ef_segmented_button_off, .ef_segmented_button_main_buttons_container {
			color: rgb(130,130,130);
			text-shadow: 0 1px #FFFFFF;
			background: #ffffff; /* Old browsers */
			/* IE9 SVG, needs conditional override of 'filter' to 'none' */
			background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjcwJSIgc3RvcC1jb2xvcj0iI2UzZTNlNCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNlM2UzZTQiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
			background: -moz-linear-gradient(top,  #ffffff 0%, #e3e3e4 70%, #e3e3e4 100%); /* FF3.6+ */
			background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(70%,#e3e3e4), color-stop(100%,#e3e3e4)); /* Chrome,Safari4+ */
			background: -webkit-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* Chrome10+,Safari5.1+ */
			background: -o-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* Opera 11.10+ */
			background: -ms-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* IE10+ */
			background: linear-gradient(to bottom,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* W3C */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#e3e3e4',GradientType=0 ); /* IE6-8 */
		}
		.ef_segmented_button_on {
			color: rgb(255,255,255);
			background: #3074a8; /* Old browsers */
			background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzMwNzRhOCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjMwJSIgc3RvcC1jb2xvcj0iIzI5ODlkOCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM0OWMxZjIiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
			background: -moz-linear-gradient(top,  #3074a8 0%, #2989d8 30%, #49c1f2 100%); /* FF3.6+ */
			background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#3074a8), color-stop(30%,#2989d8), color-stop(100%,#49c1f2)); /* Chrome,Safari4+ */
			background: -webkit-linear-gradient(top,  #3074a8 0%,#2989d8 30%,#49c1f2 100%); /* Chrome10+,Safari5.1+ */
			background: -o-linear-gradient(top,  #3074a8 0%,#2989d8 30%,#49c1f2 100%); /* Opera 11.10+ */
			background: -ms-linear-gradient(top,  #3074a8 0%,#2989d8 30%,#49c1f2 100%); /* IE10+ */
			background: linear-gradient(to bottom,  #3074a8 0%,#2989d8 30%,#49c1f2 100%); /* W3C */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#3074a8', endColorstr='#49c1f2',GradientType=0 ); /* IE6-8 */
		}
		.ef_segmented_button_caption {
			line-height: 22px;
			padding: 0 4px 0 8px;
			
			color: rgb(130,130,130);
			text-shadow: 0 1px #FFFFFF;
			background: #ffffff; /* Old browsers */
			/* IE9 SVG, needs conditional override of 'filter' to 'none' */
			background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjcwJSIgc3RvcC1jb2xvcj0iI2UzZTNlNCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNlM2UzZTQiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
			background: -moz-linear-gradient(top,  #ffffff 0%, #e3e3e4 70%, #e3e3e4 100%); /* FF3.6+ */
			background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(70%,#e3e3e4), color-stop(100%,#e3e3e4)); /* Chrome,Safari4+ */
			background: -webkit-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* Chrome10+,Safari5.1+ */
			background: -o-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* Opera 11.10+ */
			background: -ms-linear-gradient(top,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* IE10+ */
			background: linear-gradient(to bottom,  #ffffff 0%,#e3e3e4 70%,#e3e3e4 100%); /* W3C */
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#e3e3e4',GradientType=0 ); /* IE6-8 */
		}
		
		.ef_segmented_button_main_buttons_container {
			overflow: hidden;
		}
		
		.ef-ie7 .ef_segmented_button_main_buttons_container {
			position: relative;
		}
	>
]]></Implementation>
</Method>

<Method name="outputAgendaGridListSwitchCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputAgendaGridListSwitchCSS() ======= */
		.ef_agenda_view_switch_grid_icon_on {
			background-image: url('../../media/images/english/default/frontend/viewswitch_grid_on_icon.png');
			background-repeat: no-repeat;
			width: 15px;
			height: 15px;
			margin: 4px 0 3px;
		}
		.ef_agenda_view_switch_grid_icon_off {
			background-image: url('../../media/images/english/default/frontend/viewswitch_grid_off_icon.png');
			background-repeat: no-repeat;
			width: 15px;
			height: 15px;
			margin: 4px 0 3px;
		}
		.ef_agenda_view_switch_list_icon_on {
			background-image: url('../../media/images/english/default/frontend/viewswitch_list_on_icon.png');
			background-repeat: no-repeat;
			width: 15px;
			height: 15px;
			margin: 4px 0 3px;
		}
		.ef_agenda_view_switch_list_icon_off {
			background-image: url('../../media/images/english/default/frontend/viewswitch_list_off_icon.png');
			background-repeat: no-repeat;
			width: 15px;
			height: 15px;
			margin: 4px 0 3px;
		}
	>
]]></Implementation>
</Method>

<Method name="outputAgendaGeneralCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputAgendaGeneralCSS() ======= */
		/* agenda calendar main grid styles */
		
		.ef-reset-box-sizing, .ef-reset-box-sizing *, .ef-reset-box-sizing *:before, .ef-reset-box-sizing *:after {
			-webkit-box-sizing: content-box;
			-moz-box-sizing: content-box;
			box-sizing: content-box;
		}
		
		.ef_agenda_calendar_container {
			table-layout: fixed;
			/* position: relative; pjc - needed for css3pie */
			border-collapse: separate;
			border-spacing: 6px 7px;
		}
		
		.ef_agenda_calendar_header {
			background: rgb(100,100,100);
			color: rgb(255,255,255);
			font-size: 13px;
			padding: 4px 8px 4px 8px;
			height: 20px;
		}
		
		.ef_agenda_calendar_header_time {
			padding-left: 0;
			width: 50px;
			visibility: hidden;
		}
		
		.ef_agenda_calendar_header_loc {
			width: 130px;
		}
		
		.ef_frontend_agenda_grid_time_container {
			float: right;
			padding: 0 2px 0 0;
			margin: 0;
		}
		
		.ef_gridline_horizontal_container {
			position: relative;
			vertical-align: top;
			width: 4px;
		}
		
		.ef_frontend_agenda_grid_gridline_horizontal {
			position: relative;
			z-index: 10;
			display: inline-block;
			height: 0px;
			border-top: 1px solid rgb(220,220,220);
		}
		
		.ef_frontend_agenda_grid_gridline_vertical {
			position: absolute;
			float: left;
			z-index: 10;
			display: inline-block;
			width: 0px;
			border-left: 1px solid rgb(220,220,220);
		}
		
		.ef_agenda_calendar_item {
			-moz-border-radius: 5px;
			-webkit-border-radius: 5px;
			border-radius: 5px;
			width: 100%;
			padding: 0;
			overflow: hidden;
			position: relative;
			z-index: 30;
			vertical-align: top;
		}
		
		/* css attributes added to this will not take effect without change of relevant code */
		.ef_agenda_calendar_item_conflict_time {
			background: rgb(245,245,245);
			border: 1px solid rgb(220,220,220);
			color: rgb(200,200,200);
			opacity: 0.2;
		}
		/* css attributes added to this will not take effect without change of relevant code */
		.ef_agenda_calendar_item_conflict_code {
			background: rgb(245,245,245);
			border: 1px solid rgb(220,220,220);
			color: rgb(200,200,200);
			opacity: 0.2;
		}
		
		.ef_agenda_calendar_item div {
			vertical-align: top;
		}
		
		.ef_agenda_calendar_item div {
			margin: 0;
		}
		
		.ef_agenda_calendar_item_title {
			display: inline-block;
			min-height: 23px;
			padding: 0;
			float: left;
			width: 100%;
		}
		.ef_agenda_calendar_item_time_from {
			display: inline-block;
			float: left;
			padding: 6px;
			vertical-align: top;
			font-size: 12px;
			line-height: 12px;
		}
		.ef_agenda_calendar_item_time_from_single_row {
			display: inline-block;
			float: left;
			padding: 4px 6px 4px 6px;
			
			vertical-align: top;
			font-size: 12px;
		}
		
		.ef_agenda_calendar_item_session_icon {
			display: inline-block;
			background-position: right top;
			background-repeat: no-repeat;
			width: 17px;
			height: 17px;
			float: right;
		}
		
		div.ef_agenda_calendar_item_session_icon {
			margin-top: 4px;
			margin-right: 4px;
		}
		.ef_agenda_calendar_item_session_icon_faded {
			-khtml-opacity:0.2; 
			-moz-opacity:0.2; 
			opacity:0.2; 
		}
		.ef_agenda_calendar_item_selected_icon {
			display: inline-block;
			background-image: url('../../media/images/english/default/frontend/icon_attending_tick.png');
			background-repeat: no-repeat;		
			background-position: right top;
			width: 17px;
			height: 17px;
			float: right;
		}
		div.ef_agenda_calendar_item_selected_icon {
			margin-top: 4px;
			margin-right: 4px;
		}
		.ef_agenda_calendar_item_info {
			display: inline-block;
			float: left;
			width: 100%;
		}
		.ef_agenda_calendar_item_info_inner {
			display: inline-block;
			float: left;
			width: 100%;
		}
		div.ef_agenda_calendar_item_info_single_row {
			float: left;
			padding-top: 4px;
			padding-bottom: 4px;
		}
		
		div.ef_agenda_calendar_item_info_inner_single_row {
			float: left;
			width: 100%;
			font-size: 12px;
		}
		
		.ef_frontend_ie7 div.ef_agenda_calendar_item_info_inner_single_row {
			padding-bottom: 4px;
		}
		
		.ef_agenda_calendar_item_info_inner span {
			display: block;
			padding: 6px;
		}
		.ef_frontend_agenda_time_ampm {
			font-size: smaller;	
		}
		/* agenda calendar filter styles */	
		.ef_agenda_calendar_filters_container {
			text-align: left;
			padding: 0px 0px 0px 0px;
			margin: 0;
			background: #ffffff;
		}
		.ef_agenda_calendar_filters_container p {
			margin-top: 0;
			margin-bottom: 0;
			color: #000000;
		}
		.ef_agenda_calendar_filters_session_types_container {
			margin: 0;
			padding-bottom: 12px;
		}
		
		.ef_agenda_calendar_filters_instructions_text_session_type {
			padding: 16px 10px 16px 10px;
			margin: 0;
		}
		
		.ef_agenda_calendar_filters_filter {
			border: solid 1px rgb(200,200,200);
			margin: 0px 4px 4px 4px;
			cursor: pointer;
			padding: 4px 4px 4px 4px;
			text-align: center;
			-moz-border-radius: 6px;
		    -webkit-border-radius: 6px;
		    -khtml-border-radius: 6px;
		    border-radius: 6px;
		    display: block;
		    position: relative;
		    -moz-user-select: none;
		  	-khtml-user-select: none;
		  	-webkit-user-select: none;
		  	user-select: none;
		}
		
		.ef_agenda_calendar_filters_filter a {
			text-decoration: none;
			display: block;
		}
		.ef_agenda_calendar_filters_my_agenda_container {
			margin: 0;
			padding-top: 16px;
		}
		.ef_agenda_calendar_filters_instructions_text_my_agenda {
			padding: 0px 10px 4px 10px;
			margin: 0;
		}
		
		/* the colors will be overridden by session type color settings 
		for session filters, but will apply for other filters */
		.ef_agenda_calendar_filters_filter_on {
			color: rgb(255,255,255);
			border:1px solid rgb(44,151,204); 
			background-color: rgb(69,176,229);
		}
		.ef_agenda_calendar_filters_filter_on p {
			color: rgb(255,255,255);
		}
		.ef_agenda_calendar_filters_filter_off {
			color: rgb(160,160,160);
			background: rgb(255,255,255);
		}
		
		.ef_agenda_calendar_filters_filter_off p {
			color: rgb(160,160,160);
			background: rgb(255,255,255);
		}
		
		.ef_agenda_filter_my_itinerary {
			background-image: url('../../media/images/english/default/frontend/icon_attending_tick.png');
			background-repeat: no-repeat;		
			background-position: 6px center;
			text-align: left;
			padding-left: 32px;
		}
		
		.ef_agenda_filter_my_itinerary_on {
			background-image: url('../../media/images/english/default/frontend/icon_attending_tick_white.png');
		}
		
		#DayAndViewSelectorAndInstructionTextAndButtons #[w ">"]# #instructionText {
			margin-top: 18px;
			margin-bottom:12px;
		}
		
		#daySwitcher {
			height: 24px;
			float: left;
			text-align: left;
		}
		
		#daySwitcher, #viewSwitcher, #buttonDiv {
			margin-top: 8px;
			margin-bottom: 8px;
			display: block;
			clear: left;
		}
		.ef_agenda_view_switch_container {
			float:left;
			margin-bottom: 12px;
		}
		.ef_agenda_day_selector_day {
			position: relative;
			float: left;
		}
		.ef_frontend_ie6 #DayAndViewSelectorAndInstructionTextAndButtons,
		.ef_frontend_ie7 #DayAndViewSelectorAndInstructionTextAndButtons {
			margin-top: 0;
		}
	>
]]></Implementation>
</Method>

<Method name="outputLegacyDefaultCSS">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	&html<
		/* ======= outputLegacyDefaultCSS() ======= */
		h1 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 24px; font-weight: bold; color: #000000; 	}
		h2 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 20px; font-weight: bold; color: #000000; 	}
		h3 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 16px; font-weight: bold; color: #000000; 	}
		h4 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-weight: bold; color: #000000; 	}
		h5 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-weight: bold; color: #000000; 	}
		h6 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-weight: bold; color: #000000; 	}
		body
		{
			font-size:12px;
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
		}
		
		.default_text { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; 	}
		.alt_text_1 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-weight: bold; color: #000000; 	}
		.alt_text_2 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: italic; color: #000000; 	}
		.alt_text_3 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; 	}
		.alt_text_4 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; 	}
		.alt_text_5 { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; 	}
		
		td {font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; 	}
		p, li, div
		{
			margin:0in;
			margin-bottom: 10pt;
			font-size:12px;
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
		}
		li.k-item {
			margin-bottom: 0;
		}
		
		a:link, a:visited, a:hover, a:active {
		}
		
		ul.menuUL	{
			margin:0;
			margin-bottom: 0;
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
		}
		li.menuLI	{
			margin:0;
			margin-bottom: 0;
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
			list-style : none;
			xxborder-bottom: 1px solid red;
		}
		li.menuLI a	{
			margin:0;
			margin-bottom: 0;
			font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
			list-style : none;
			xxborder-bottom: 1px solid red;
		}
		
		.black8px {  font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 8px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none}
		.black9px {  font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none}
		.black10px {  font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none}
		.EF_inputBox {  font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none}
		.blackbold10px {  font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #000000}
		.white9px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: normal; color: #ffffff}
		.white10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: normal; color: #ffffff}
		.white12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: normal; color: #ffffff; text-decoration: none}
		.white14px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-style: normal; line-height: normal; font-weight: normal; color: #ffffff; text-decoration: none}
		.whitebold9px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: bold; color: #ffffff; text-decoration: none}
		.whitebold10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #ffffff; text-decoration: none}
		.whitebold12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: bold; color: #ffffff; text-decoration: none}
		.whitebold14px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-style: normal; line-height: normal; font-weight: bold; color: #ffffff; text-decoration: none}
		.whiteOnGrey10px { margin: 0; padding: 0; vertical-align: middle; line-height: 18px; text-indent: 7px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-weight: bold; font-style: normal; color: white; background: #959595; }
		.black10pxUL { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: underline}
		.blackbold10pxUL { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #000000 ; text-decoration: underline}
		.redbold12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: bold; color: #cc0000; text-decoration: none }
		.redbold10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #cc0000; text-decoration: none }
		.greybold10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #666666}
		.blackbold12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: bold; color: #000000 }
		.bluebold12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: bold; color: #1F4757}
		.black12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none }
		.blue12px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 12px; font-style: normal; line-height: normal; font-weight: normal; color: #6699CC }
		.blue10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: normal; color: #6699CC }
		.blue9px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: normal; color: #6699CC }
		.bluebold9px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: bold; color: #6699CC }
		.yellowbold10px {
			font-family: Verdana, Arial, Helvetica, sans-serif;
			font-size: 10px;
			font-style: normal;
			line-height: normal;
			font-weight: bold;
			color: #FFFF80;
			text-decoration: none;
		}
		.yellow {  background-color: #FFFFCC;}
		.grey {  background-color: #e6e6e6}
		.red, .k-calendar td.ef-date-picker-event-day { 	background-color : #CC0033;}
		.k-calendar td.ef-date-picker-event-day .k-link {
			color: #FFFFFF
		}
		.notSoRed { 	background-color : #FFD1A0;}
		.bluebold10px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font-style: normal; line-height: normal; font-weight: bold; color: #1F4757 }
		.bluebold14px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-style: normal; line-height: normal; font-weight: bold; color: #1F4757 }
		.activeButton {background-color: #FFDEAD}
		.orangeSelect {
			background-color: #FFDEAD;
			cursor : hand;
		}
		.red9px { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: normal; color: #cc0000; text-decoration: none }
		.black9px_UL { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 9px; font-style: normal; line-height: normal; font-weight: normal; color: #000000; text-decoration: none }
		.grey2 { background-color: #CC0000}
		.butBlueWhite8px {
			font-family : Arial, Helvetica, Verdana;
			font-size: 8pt;
			color: White;
			font-weight: normal;
			background:#6699CC;
			text-align : center;
			font-weight: Bold;
			text-decoration : none;
			padding : 0px;
			cursor:hand;
		}
		.butGreyBlue8px {
			color: #185496;
			background: #B3C4CE;
			text-align : center;
			text-decoration : none;
			padding : 0px;
			cursor:hand;
			font : bold 8pt Arial, Helvetica, sans-serif;
			width: 95px;
			max-width: 95px;
			height: 20px;
			margin: 0px;
		}
		.hiddenDiv	{
			position:absolute;
			visibility:hidden;
			background-color: #FFFFE1;
			border: 1px double;
			width:0px;
			height:0px;
			left:200px;
		}
		td.black10pxBorder {
			border-style: solid none solid none;
			border-width:1px;
			border-color: #FFFFFF #FFFFFF #000000 #000000;
			border-collapse: collapse;
		}
		.mainPageBorderTop	{
			background-color: black;
		}
		.mainPageBorderLeft	{
			background-color: black;
		}
		.mainPageBorderRight	{
			background-color: black;
		}
		.mainPageBorderBottom	{
			background-color: black;
		}
		.mainPageLine	{
		/* need both color (for IE) and background-color (for Mozilla + Opera) */;
			width: 100%;
			color: black;
			background-color: black;
			height: 1px;
		}
	>
]]></Implementation>
</Method>
</Class>


<Project name="proweb 2" LastModified="2016-10-13 14:43:04.277082" Target="dev.efsys.net/LARGEDEVSRC/backend/home/efSupportLogin.htm" TargetType="3">
  <Items>
    <ProjectItem name="EF.contextDataRegistration" type="CLS"></ProjectItem>
    <ProjectItem name="EF.contextDataRegistrationMock" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.containerElement" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.element" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.pagesFrontend.t4Registration" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.checkbox" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.checkboxGroup" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.datePicker" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.dateRange" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.divider" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.dropdown" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.emailInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.emailInputMulti" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.inputElement" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.integerInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.numericInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.page" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.phoneNumber" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.prowebBase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.radioButtons" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.textArea" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.textBlock" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.textInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.timeInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.webAddress" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pages.frontend.base" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pages.frontend.baseProweb" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.checkbox" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.checkboxGroup" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.datePicker" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.dateRange" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.divider" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.dropdown" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.emailInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.emailInputMulti" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.floatingMenuAdd" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.inputElement" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.integerInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.numericInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.phoneNumber" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.prowebBase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.radioButtons" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.textArea" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.textBlock" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.textInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.timeInput" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.webAddress" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.wholeNumber" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.emailAddressMulti" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.phoneNumber" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.phoneNumberTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.webAddress" type="CLS"></ProjectItem>
    <ProjectItem name="EF.validator.webAddressTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/pageControllerStandardSave.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/t4Registration.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/tRegistration.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/system/eventsForceRules.csr" type="CSP"></ProjectItem>
    <ProjectItem name="layout.cssDefaultMethods" type="CLS"></ProjectItem>
    <ProjectItem name="sc.objData" type="CLS"></ProjectItem>
    <ProjectItem name="sc.xModules.objList" type="CLS"></ProjectItem>
    <ProjectItem name="shared.pageMethods" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.floatingMenu" type="CLS"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/codQuestionDetails2.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/formDivider.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/textDetailsMoxie2.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/codQuestionDetails.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/backEnd/proweb/textDetailsMoxie.csp" type="CSP"></ProjectItem>
    <ProjectItem name="largedevsrc/frontEnd/reg/reorderProwebElements.csp" type="CSP"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.panel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.panel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.backend.panel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.ui.components.frontend.panel" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.checkboxGroupTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.checkboxGroupTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.datePIckerTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.dateRangeTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.dropdownTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.emailInputMultiTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.emailInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.integerInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.numericInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.pageTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.phoneNumberTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.radioButtonsTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.textAreaTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.textBlockTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.textInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.timeInputTestCase" type="CLS"></ProjectItem>
    <ProjectItem name="EF.pageController.proweb.testCases.webAddressTestCase" type="CLS"></ProjectItem>
  </Items>
  <BreakPoints>
    <BreakPoint Routine="cspRealEV.frontend.reg.pagecontrollerstandardsave.CLS" Offset="OnPreHTTPafter+28"></BreakPoint>
  </BreakPoints>
</Project>


<Class name="sc.objData">
<Description><![CDATA[
Please note that this class will be the super class of all underlying data items.
<!-- ;vc;
;vc;    Object: sc.objData.CLS/EV.35
;vc; Component: CLS.sc.objData
;vc;  Location: SmallDev
;vc; Date/Time: 02-Sep-16 14:27
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>sc.objData.CLS/EV.35</td><td>CLS.sc.objData</td><td>SmallDev</td><td style='white-space: nowrap;'>02-Sep-16 14:27</td><td>JeremyW</td></tr></table>
]]></Description>
<ClassType>persistent</ClassType>
<IncludeCode>EF.common.macros</IncludeCode>
<ProcedureBlock>1</ProcedureBlock>
<Super>%Library.Persistent,shared.timeStamp</Super>
<TimeChanged>64196,63027.777429</TimeChanged>
<TimeCreated>59148,67793</TimeCreated>
<Inheritance>right</Inheritance>

<Property name="objAuditTrails">
<Type>sc.objAuditTrail</Type>
<Cardinality>many</Cardinality>
<Inverse>objData</Inverse>
<Relationship>1</Relationship>
</Property>

<Parameter name="EXTENTSIZE">
<Description>
for cutin and padsting in the navigation tree</Description>
<Default>5000</Default>
</Parameter>

<Property name="active">
<Type>%Library.Boolean</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="creator">
<Description>
Who created this version of the data item.</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="200"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="dataType">
<Description>
Used for identifying the class of the object withour having to call
cache mysterious APIs.</Description>
<Type>%Library.String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="displayOrder">
<Description>
A display order number has to be set at creation time. It can then be
swapped for the displayorder number of adjacent data item.
This controls the order which the data is displayed in the backend data tree.</Description>
<Type>%Library.Integer</Type>
</Property>

<Property name="nextVersion">
<Description>
Pointer to the next version of this data item. Not mandatory.</Description>
<Type>sc.objData</Type>
</Property>

<Property name="objComponents">
<Type>sc.objComponent</Type>
<Cardinality>many</Cardinality>
<Inverse>objData</Inverse>
<Relationship>1</Relationship>
</Property>

<Property name="objStep">
<Type>sc.objStep</Type>
<Cardinality>one</Cardinality>
<Inverse>objDatas</Inverse>
<Relationship>1</Relationship>
</Property>

<Property name="parent">
<Description>
Points to the parent of this data item. This makes up the hiarachy.
It has to be read by a recursive method to build up the tree structure.</Description>
<Type>sc.objData</Type>
</Property>

<Property name="previousVersion">
<Description>
Poiter to the previous version of this data item.
Note that this can be chain of many versions linked together.</Description>
<Type>sc.objData</Type>
</Property>

<Property name="publishAt">
<Description>
If the object is to be published at a future point of time, use this prop.</Description>
<Type>%Library.TimeStamp</Type>
</Property>

<Property name="sourceID">
<Description>
if the object is a re-use of another object, indicate the ID of the orginal object here</Description>
<Type>sc.objData</Type>
</Property>

<Property name="beforeItem">
<Description>
to override the template value - blank = nothing</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="100"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="afterItem">
<Description>
to override the template value - blank = nothing</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="100"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="beforeRow">
<Description>
not used at present</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="100"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="afterRow">
<Description>
not used at present</Description>
<Type>%Library.String</Type>
<Parameter name="MAXLEN" value="100"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="objEvent">
<Type>setup.objEvent</Type>
<SqlComputeCode>set {objEvent} = ..getEventID({parent})</SqlComputeCode>
<SqlComputed>1</SqlComputed>
<SqlComputeOnChange>parent</SqlComputeOnChange>
</Property>

<Index name="objEventIndex">
<Properties>objEvent</Properties>
</Index>

<Index name="sourceIDIndex">
<Properties>sourceID</Properties>
</Index>

<Index name="dataTypeIndex">
<Description>
Index for property dataType</Description>
<Properties>dataType</Properties>
</Index>

<Index name="displayOrderIndex">
<Description>
Index for property displayOrder</Description>
<Properties>displayOrder</Properties>
</Index>

<Index name="nextVersionIndex">
<Description>
Index for property nextVersion</Description>
<Properties>nextVersion</Properties>
</Index>

<Index name="parentIndex">
<Description>
Index for property parent</Description>
<Properties>parent</Properties>
</Index>

<Index name="previousVersionIndex">
<Description>
Index for property previousVersion</Description>
<Properties>previousVersion</Properties>
</Index>

<Index name="publishAtIndex">
<Description>
Index for property publishAt</Description>
<Properties>publishAt</Properties>
</Index>

<Method name="getEventID">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set eventID=""
	&SQL(SELECT objEvent,parent->objEvent,parent->parent->objEvent INTO :thisEvent,:parentEvent,:grandParentEvent FROM sc.objData WHERE ID = :dataID)
	if +SQLCODE=0 {
		set eventID=$Select(thisEvent:thisEvent,parentEvent:parentEvent,grandParentEvent:grandParentEvent,1:"")	
	}
	return eventID
]]></Implementation>
</Method>

<Method name="getDataType">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 set ok=""
 
 &SQL(SELECT dataType INTO :tmp FROM sc.objData WHERE ID = :dataID)
 if +SQLCODE=0 set ok=tmp
 
 quit ok
]]></Implementation>
</Method>

<Method name="findLastVersion">
<Description>
pass in a objectID of any age and this will return the ID of the latest version, future or current</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String="",version:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set lastStep=##class(sc.objStep).getFinalLevel()
	set out="",parent="",myDisplayOrder="",dataType=""
	for  {
		&SQL(SELECT nextVersion,objStep->stepOrder INTO :tmp1,:tmp2 FROM sc.objData WHERE ID = :dataID)
		if +SQLCODE=0 {
			set nextVersion=tmp1,stepOrder=tmp2
		} else {
			quit
		}
		
		// quit if there isn't a future version
		if nextVersion="" quit
		
		if (version="current") {
			// quit if the next item is unpublished (this is the last published one)
			set nextStepOrder=""
			&SQL(SELECT objStep->stepOrder INTO :tmp1 FROM sc.objData WHERE ID = :nextVersion)	
			if +SQLCODE=0 set nextStepOrder=tmp1
			if nextStepOrder'=lastStep quit
		}
		
		// jump to next one in chain
		set dataID=nextVersion		
	}
	
	quit dataID
]]></Implementation>
</Method>

<Method name="applicationPath">
<Description>
Returns the part of the URL which is the CSP application path</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 // this method is called by all the tags. It's put here because this page compiles before the tag pages.
 if $Data(%request) {
 	return $piece(%request.URL,"/",1,$G(^pathDepth,2))
 } else {
	return "dummyCSPAppPath"
 }
]]></Implementation>
</Method>

<Method name="deleteRecursively">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",reallyDelete=0</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 set ok=""
 //  find all its children
 set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 do rs.Prepare("SELECT ID FROM sc.objData WHERE parent=?")
 do rs.Execute(dataID)
 while rs.Next() {
 	// exterminate the entire family, top down
 	set ok=##class(sc.objData).deleteRecursively(rs.Get("ID"),reallyDelete)		
 }
 if reallyDelete {
	set ok=..%DeleteId(dataID)
 } else {
	 set objData=##class(sc.objData).%OpenId(dataID)
 	set objData.active=0
 	set ok=objData.%Save()
 	kill objData
 }
 
 quit ok
]]></Implementation>
</Method>

<Method name="updateObjEventRecursively">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,eventID</FormalSpec>
<Implementation><![CDATA[
	 do ..updateObjEvent(dataID,eventID)
	 set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	 do rs.Prepare("SELECT ID FROM sc.objData WHERE parent=?")
	 do rs.Execute(dataID)
	 while rs.Next() {
	 	do ..updateObjEventRecursively(rs.Get("ID"),eventID)		
	 }
]]></Implementation>
</Method>

<Method name="updateObjEvent">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,eventID</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc.objData SET objEvent = :eventID WHERE ID = :dataID)
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalException).%New("updating sc.ObjData with objEvent failed")
]]></Implementation>
</Method>

<Method name="updateParent">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,parentID</FormalSpec>
<Implementation><![CDATA[
	&SQL(UPDATE sc.objData SET parent = :parentID WHERE ID = :dataID)
	if +SQLCODE'=0 throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$G(%msg))
]]></Implementation>
</Method>

<Method name="copyRecursively">
<Description>
this will copy a tree of data items. parentID initially send in as NULL as it is only used internally
do NOT pass in a parentID, it's only for internal use!</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",parentID:%Library.String="",newEventID="",userID=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
	set ok=""
	// get the type of object	
	set objData=##class(sc.objData).%OpenId(dataID)
	set objDataNew=objData.%ConstructClone(0)
	// if we have a parentID then it is a new parent otherwise it's the top level data item so same parent
	if parentID do objDataNew.parentSetObjectId(parentID)
	do objDataNew.nextVersionSetObjectId("")
	do objDataNew.previousVersionSetObjectId("")
	do objDataNew.sourceIDSetObjectId("")
	if newEventID {
		if (objData.dataType="objGroup") ! (objData.dataType="objPage") {
			do objDataNew.objEventSetObjectId(newEventID)
		}
	}
	set objDataNew.creator="autocopy"
	// if this is the top level starting group or page then increment the displayorder
	if 'parentID,(objData.dataType="objGroup")!(objData.dataType="objPage") {
		set tmpParentID=objDataNew.parent.%Id()
		// set the displayOrder to last
		set displayOrder=""
		&SQL(SELECT displayOrder INTO :displayOrder FROM sc.objData WHERE (parent=:tmpParentID) ORDER BY displayOrder DESC)
		set objDataNew.displayOrder=(displayOrder+1)
	}
	set ok=objDataNew.%Save()
	
	if 'ok quit ok
	set dataNewID=objDataNew.%Id()
	
	// store old and new dataID's - needed in eventCopy.csp to re-link location and item pages after copy
	if $d(%session) {
		set ^xCOPYAUDIT(%session.SessionId,dataID)=dataNewID
	} elseif $G(userID) {
		set ^xCOPYAUDIT(userID,dataID)=dataNewID
	} else {
		set ^xCOPYAUDIT("unknown",dataID)=dataNewID
	}
	// the objects with relationships would've also been cloned so that new components are auto created
	// but have to remove some of the objects pointing to me that were auto created
	&SQL(DELETE FROM sc.objAuditTrail WHERE objData = :dataNewID)
	kill objDataNew
	kill objData
	
	//  find all its children
	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	do rs.Prepare("SELECT ID FROM sc.objData WHERE (parent=?) AND (active=1)")
	do rs.Execute(dataID)
	while rs.Next() {
		// copy the entire family
		// first check to see if this is the most recent version as we only want to copy
		// the latest one not all the old ones
		set latestVersionID=##class(sc.objData).findLastVersion(rs.Data("ID"),"current")
		if latestVersionID=rs.Data("ID") set ok=##class(sc.objData).copyRecursively(rs.Data("ID"),dataNewID,newEventID)
	}
	
	quit dataNewID
]]></Implementation>
</Method>

<Method name="getDependsOnPrompt">
<Description>
Implemented in some of the sub classes. </Description>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return ""
]]></Implementation>
</Method>

<Method name="findChildren">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[dataID:%Library.String="",&array:%Library.String=""]]></FormalSpec>
<Implementation><![CDATA[
 set ok=""
 //  find all its children
 set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 do rs.Prepare("SELECT ID FROM sc.objData WHERE (parent=?) AND (active=1)")
 do rs.Execute(dataID)
 while rs.Next() {
 	set array(rs.Get("ID"))=""
 	do ..findChildren(rs.Get("ID"),.array)		
 }
]]></Implementation>
</Method>

<Method name="findChildrenPages">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[dataID:%Library.String="",&array:%Library.String=""]]></FormalSpec>
<Implementation><![CDATA[
 set ok=""
 //  find all its children
 set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 do rs.Prepare("SELECT ID,dataType FROM sc.objData WHERE (parent=?) AND (active=1)")
 do rs.Execute(dataID)
 while rs.Next() {
 	if (rs.Get("dataType")="objGroup")!(rs.Get("dataType")="objPage") {
 		if rs.Get("dataType")="objPage" set array(rs.Get("ID"))=rs.Get("dataType")
 			do ##class(sc.objData).findChildrenPages(rs.Get("ID"),.array)		
 	}
 }
]]></Implementation>
</Method>

<Method name="getPageID">
<Description>
Returns the ID of the page where the passed in data object resides.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 set pageID=""
 set parentID="",tmpID=dataID
 
 for  {
 	set dataType=""
 	// get my class
 	&SQL(SELECT dataType INTO :tmp FROM sc.objData WHERE ID = :tmpID)
 	if +SQLCODE=0 set dataType=tmp
 	
 	set pageID=tmpID 
 	if (dataType="objPage")!(dataType="objSurveyPage") quit
 	// get my parent for next loop
 	&SQL(SELECT parent INTO :tmpID FROM sc.objData WHERE ID = :tmpID) 
 	if +SQLCODE'=0 quit
 	
 }
 
 quit pageID
]]></Implementation>
</Method>

<Method name="getPath">
<Description>
returns a string of the texctual path to the item passed in</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",hideLast:%Library.Boolean=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 set (out,last)=""
 if '##class(sc.objData).%ExistsId(dataID) quit ""
 // get the last name
 if 'hideLast {
 	set objData=..%OpenId(dataID)
 	if (objData.dataType="objImage") {
	 	set last=objData.fileName
	 } elseif objData.dataType="objList" {
	 	set last=""
	 } else {
	 	set last=objData.description
	 }
	 do objData.%Close()
 }
 // find the tree in from the bottom up
 while dataID'="" {
 	&SQL(SELECT parent INTO :dataID FROM sc.objData WHERE ID = :dataID)
 	if ..%ExistsId(dataID) {
 		set objData=..%OpenId(dataID)
 		if objData.dataType="objImage" {
 			set out=out_"/"_objData.fileName
 		} elseif objData.dataType="objList" {
 			//
 		} else {
 			set out=out_"/"_objData.description
 		}
	
		 do objData.%Close()
 	} else {
	 	set dataID=""	
 	}
 }
 // and now reverse the string
 set tmp=""
 for i=$l(out,"/"):-1:1 {
 	set tmp=tmp_"/"_$p(out,"/",i)
 }
 set out=tmp_last
 quit out
]]></Implementation>
</Method>

<Method name="getPathInTree">
<Description>
Same as get path but specialised for the tree redrawing
retusn the items like description1|ID1~description2|id2~...</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",hideLast:%Library.Boolean=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 set (out,last)=""
 if '##class(sc.objData).%ExistsId(dataID) quit ""
 // get the last name
 if 'hideLast {
 set objData=..%OpenId(dataID)
 if objData.dataType="objImage" {
	 set last=objData.fileName
 } elseif objData.dataType="objList" {
	 set last=""
 } else {
	 set last=objData.description
 }
	 do objData.%Close()
 }
 // find the tree in from the bottom up
 while dataID'="" {
 	&SQL(SELECT parent INTO :dataID FROM sc.objData WHERE ID = :dataID)
 	if ..%ExistsId(dataID) {
 		set objData=..%OpenId(dataID)
 			if objData.dataType="objImage" {
 				set out=out_"/"_objData.fileName
 			} elseif objData.dataType="objList" {
 				//
 			} else {
 				set out=out_"~"_objData.description_"|"_dataID
 		}
 		do objData.%Close()
	 }
 }
 // and now reverse the string
 set tmp=""
 for i=$l(out,"~"):-1:1 {
 	set tmp=tmp_"~"_$p(out,"~",i)
 }
 set out=tmp_last
 // remove the first delimiter
 set out=$E(out,2,9999)
 quit out
]]></Implementation>
</Method>

<Method name="inMail">
<Description>
Returns true if the passed in object is used in a template that has the "isMail" flag set.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String=""</FormalSpec>
<ReturnType>%Library.Boolean</ReturnType>
<Implementation><![CDATA[
 set pageID="",isMail="NOT FOUND"
 // first, check if the passed in item is a page
 if ##class(sc.objData).%ExistsId(dataID) {
	 set objData=##class(sc.objData).%OpenId(dataID)
	 if objData.%ClassName(0)["objPage" set pageID=dataID
	 do objData.%Close()
 } 	
 if pageID="" {
	 // walk up the tree and look for my parent page
	 while (pageID="")&(dataID'="") {
		 set tmp=""
		 &SQL(SELECT parent INTO :tmp FROM sc.objData WHERE ID = :dataID)
		 if SQLCODE=0 {
			 set dataID=tmp
			 if ##class(sc.objData).%ExistsId(dataID) {
				 set objData=##class(sc.objData).%OpenId(dataID)
				 if objData.%ClassName(0)["objPage" set pageID=dataID
				 do objData.%Close()
			 }
		 } else {
			 set dataID=""
		 }
	 }
 }
 // ok, we found the parent page, is it using a mail template or not
 if pageID'="" {
	 set tmp=""
	 &SQL(SELECT objTemplate->isMail INTO :tmp FROM sc_xModules.objPage WHERE ID = :pageID)
	 if SQLCODE=0 set isMail=+tmp
 }
 quit isMail
]]></Implementation>
</Method>

<Method name="inStatic">
<Description>
Returns true if the passed in object is used in a template that has the "isStatic" (for static html pages) flag set.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String=""</FormalSpec>
<ReturnType>%Library.Boolean</ReturnType>
<Implementation><![CDATA[
 set pageID="",isStatic="NOT FOUND"
 // first, check if the passed in item is a page
 if ##class(sc.objData).%ExistsId(dataID) {
	 set objData=##class(sc.objData).%OpenId(dataID)
	 if objData.%ClassName(0)["objPage" set pageID=dataID
	 do objData.%Close()
 } 	
 if pageID="" {
	 // walk up the tree and look for my parent page
	 while (pageID="")&(dataID'="") {
		 set tmp=""
		 &SQL(SELECT parent INTO :tmp FROM sc.objData WHERE ID = :dataID)
		 if SQLCODE=0 {
			 set dataID=tmp
			 if ##class(sc.objData).%ExistsId(dataID) {
				 set objData=##class(sc.objData).%OpenId(dataID)
				 if objData.%ClassName(0)["objPage" set pageID=dataID
				 do objData.%Close()
			 }
		 } else {
			 set dataID=""
		 }
	 }
 }
 // ok, we found the parent page, is it using a static template or not
 if pageID'="" {
	 set tmp=""
	 &SQL(SELECT objTemplate->isStatic INTO :tmp FROM sc_xModules.objPage WHERE ID = :pageID)
	 if SQLCODE=0 set isStatic=+tmp
 }
 quit isStatic
]]></Implementation>
</Method>

<Method name="moveChain">
<Description>
Moves an object upwards or downwards in the displayOrder. Pass in "up" or "down".
This is the same as the normal move but this version takes all the items that share a displayorder and swaps them 
with all the adjacent items. This is to make sure that all previous and future version have the same 
displayOrder.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ID:%Library.String="",dir:%Library.String=""</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
 Set adjacent=""
 // tests
 If '..%ExistsId(ID) Quit 0
 set dir=$ZCVT(dir,"L")
 if "up,down,top,bottom"'[dir quit 0
 if dir="" quit 0
 // Who is my parent
 Set dataID=""
 &SQL(SELECT parent INTO :parentID FROM sc.objData WHERE ID = :ID)
 // First, what's my own display order?
 &SQL(SELECT displayOrder INTO :myPos FROM sc.objData WHERE ID = :ID)
 
 // handle tops and bottoms first 
 if "top,bottom"[dir {
 	// find all object before (or after) me
 	set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 	if (dir="top") {
	 	set query="SELECT ID,displayOrder FROM sc.objData WHERE (parent=?) AND (displayOrder < ?) "
 	} else {
	 	set query="SELECT ID,displayOrder FROM sc.objData WHERE (parent=?) AND (displayOrder > ?) "
 	}
 	do rs.Prepare(query)
 	do rs.Execute(parentID,myPos)
 	while rs.Next() {
 		// increment (or decrement) them

 		set myID=rs.Get("ID")
 		set tmpDisplayOrder=rs.Get("displayOrder")
 		if dir="top" set tmpDisplayOrder=tmpDisplayOrder+1
 		if dir="bottom" set tmpDisplayOrder=tmpDisplayOrder-1 		
 		&SQL(UPDATE sc.objData SET displayOrder=:tmpDisplayOrder WHERE ID = :myID)
 		if SQLCODE'=0 w 1/0 // could not move item
 	}
 	// and now move myself 
 	set tmpDisplayOrder=""
 	if dir="top" set tmpDisplayOrder=1
 	if dir="bottom" {
 		&SQL(SELECT TOP 1 displayOrder INTO :tmpDisplayOrder FROM sc.objData WHERE  (parent = :parentID ) ORDER BY displayOrder DESC)
 		set tmpDisplayOrder=tmpDisplayOrder+1
 	}
 	&SQL(UPDATE sc.objData SET displayOrder=:tmpDisplayOrder WHERE ID = :ID)
 	quit 1
 }
 // Find previous displayOrder if we moving up
 If dir="up" {
 	&SQL(	SELECT displayOrder INTO :adjacent 
 	FROM sc.objData
 	WHERE 	(displayOrder < :myPos) AND
 	(parent = :parentID) AND (active=1)
 	ORDER BY displayOrder DESC)
 }
 // find next displayOrder if we are moving down
 If dir="down" {
 	&SQL(	SELECT displayOrder INTO :adjacent 
 	FROM sc.objData
 	WHERE 	(displayOrder > :myPos) AND
 	(parent = :parentID) AND (active=1)
 	ORDER BY displayOrder)
 }
 If adjacent'="" {
 	// Swap the displayOrder betwixt the two lines of objects
 	// first the adjacent ones and then my own blood line
 	for type="adjacent","myPos" {
 		set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
 		set query="SELECT ID,parent FROM sc.objData WHERE (parent=?) AND (displayOrder=?)"
 		do rs.Prepare(query)
 		do rs.Execute(parentID,@type)
 		while rs.Next() { // put all ID into two arrays
 			if type="adjacent" set adjacent(rs.Get("ID"))=""
 			if type="myPos" set myPos(rs.Get("ID"))=""
 		}
 	do rs.%Close()
 }
 set m=""
 for  {
 	set m=$O(adjacent(m))	
 	if m="" quit

 	&SQL(UPDATE sc.objData SET displayOrder=:myPos WHERE ID = :m)
 }
 set m=""
 for  {
 	set m=$O(myPos(m))	
 	if m="" quit

 	&SQL(UPDATE sc.objData SET displayOrder=:adjacent WHERE ID = :m)
 }
 Quit 1
 } else {
 	quit 0
 }
]]></Implementation>
</Method>

<Method name="approve">
<Description>
Use this to approve an object.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%Library.String="",targetLevel:%Integer=""</FormalSpec>
<ReturnType>%Library.Boolean</ReturnType>
<Implementation><![CDATA[
 set ok=1
 set finalLevel=##class(sc.objStep).getFinalLevel()
 
 // make the component point to me if I'm a final level (published)
 if targetLevel=finalLevel {
 	// find the previous version ID
 	set previousID=""
 	&SQL(SELECT previousVersion INTO :previousID FROM sc.objData WHERE ID = :dataID)
 	if +SQLCODE=0 { // opposite of cache status, 0=ok
 		// Find all components that point to the current version object and make it point to this version object
 		&SQL(UPDATE sc.objComponent SET objData = :dataID WHERE objData = :previousID)
 	}
 }
 set stepID=""
 &SQL(SELECT ID INTO :stepID FROM sc.objStep WHERE stepOrder = :targetLevel )
 if +SQLCODE=0 { 
 	set objData=##class(sc.objData).%OpenId(dataID)
 	do objData.objStepSetObjectId(stepID)
 	do objData.%Save()
 	do objData.%Close()
 }
 // compile page into static HTML if applicable
 if targetLevel=finalLevel {
	 if ##class(setup.objSetting).getParameter("system","static html")=1 {
	 	set pageID=##class(sc.xModules.objPage).getPageID(dataID)
		set app=##class(sc.objData).applicationPath()
	 }
 }	
 // audit trail
 set levelDesc=""
 &SQL(SELECT description INTO :tmp FROM sc.objStep WHERE stepOrder = :targetLevel)
 if +SQLCODE=0 set levelDesc=tmp
 
 set comments="approved to level: "_targetLevel_" - "_levelDesc
 if targetLevel=finalLevel set comments=comments_" (published to live)"
 &SQL(INSERT INTO sc.objAuditTrail (description,objData,objUser) VALUES (:comments,:dataID,:userID))
 
 // make sure we remove any auto publishing flag or it will looop - May2006
 &SQL(SELECT publishAt INTO :tmp FROM sc.objData WHERE ID = :dataID) 
 if +SQLCODE=0,tmp'="" {
	&SQL(UPDATE sc.objData SET publishAt = NULL WHERE ID = :dataID)	 
 } 
  
 quit ok
]]></Implementation>
</Method>

<Method name="sendApprovalEmail">
<Description>
Send notification emails to the corresponding email addresses associated with the current approval level</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String="",targetLevel:%String=""</FormalSpec>
<Implementation><![CDATA[	// disused
]]></Implementation>
</Method>

<Method name="deleteItem">
<Description>
Method for deleting an item in a list</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String=""</FormalSpec>
<Implementation><![CDATA[
	set ok = ""
	if (dataID '="") {
		set previousVersion=""
		set codItemName=""
		&SQL(SELECT objItemName->description INTO :tmp FROM sc_xModules.objCODitem WHERE ID = :dataID)
		if +SQLCODE=0 { 
			set codItemName=tmp
			//clean up category dependent pricing if exist.
			set rs=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
			do rs.Prepare("SELECT ID FROM cod.objAlternativeExtras WHERE codItemID=?")
			do rs.Execute(dataID)
			while rs.Next() {
				set alternativeExtrasID = rs.Get("ID")
				//delete all items in links.lnkCategoryItemBasketItem.CLS reated to the found alternative extras.
				&SQL(DELETE FROM links.lnkCategoryItemBasketItem WHERE objAlternativeExtras=:alternativeExtrasID)
				&SQL(UPDATE cod.objAlternativeExtras SET priceByAttendeeCategory=0 WHERE ID=:alternativeExtrasID)
			}
			
			set pageID=##class(sc.objData).getPageID(dataID)
			&SQL(UPDATE sc_xModules.objCODitem SET dependsOnAlternative='', dependsOnPrompt='' WHERE (dependsOnPrompt = :dataID)) //Clear all the dependency on this item. SHAHADAT 23rd Sep 2008
			&SQL(UPDATE sc_xModules.objText SET dependsOnAlternative='', dependsOnPrompt='' WHERE (dependsOnPrompt = :dataID)) //Clear all the text block dependencies on this item. pjc 10 November 2009
			&SQL(UPDATE setup.lnkCategoryEvent
				SET dependsOnAlternative = NULL ,dependsOnPrompt = NULL ,dependsOnPromptPageID = NULL, dependsOnObjItemName = NULL
				WHERE dependsOnPromptPageID = :pageID AND %SQLUPPER(dependsOnPrompt) = %SQLUPPER(:codItemName)
			)
		}

		set ok=1
		// loop on all version of this item
		while dataID'="" {
			set previousVersion=""
			&SQL(SELECT previousVersion INTO :previousVersion FROM sc.objData WHERE ID = :dataID)
			if +SQLCODE=0 {

				// Fred July 2004 - deactivate rather than delete stuff.
				&SQL(UPDATE sc.objData SET active = 0 WHERE ID = :dataID)
				
				if dataID'=previousVersion set dataID=previousVersion		
			}
		}
	}
	quit ok
]]></Implementation>
</Method>

<Method name="reuseLogic">
<Description>
this method replaces and consolidates the onPreHttp scripts on textDetails.csp, imageDetails.csp and fileDetails.csp</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dataType:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set dataID=%request.Get("dataID")
	set orgDataID=%request.Get("orgDataID")
	if dataID="NEW" set dataID=orgDataID
	
	// is this object linked to another?
	set sourceID=""
	&SQL(SELECT sourceID INTO :tmp FROM sc.objData WHERE ID = :dataID)
	if +SQLCODE=0 set sourceID=tmp
	// find the latest version
	set latestSourceID=##class(sc.objData).findLastVersion(sourceID,"future")
	
	
	// unlink an item
	if %request.Get("unlink")="true" {
		set sourceID=""
		
		// open new item	
		set tmpID=$S(dataID:dataID,orgDataID:orgDataID,1:"")
		set objData=##class(sc.objData).%OpenId(tmpID)
		do objData.sourceIDSetObjectId("")
		
		// open old item
		set orgObj=##class(sc.objData).%OpenId(latestSourceID)
				
		// find latest data and copy it to new item
		if dataType="objText" {
			set objData.description=orgObj.description
			set objData.rawText=orgObj.rawText
		
		} elseif dataType="objImage" {
			
			set objData.fileName=orgObj.fileName
			set objData.mouseOverFileName=orgObj.mouseOverFileName
			do objData.fileStream.CopyFrom(orgObj.fileStream)
			do objData.mouseOverFileStream.CopyFrom(orgObj.mouseOverFileStream)
			set objData.altText=orgObj.altText
			set objData.titleText=orgObj.titleText
			set objData.border=orgObj.border
			set objData.width=orgObj.width
			set objData.height=orgObj.height
			set objData.popupWidth=orgObj.popupWidth
			set objData.popupHeight=orgObj.popupHeight
			set objData.popupScrollbars=orgObj.popupScrollbars
			set objData.URL=orgObj.URL
			set objData.target=orgObj.target
		
		}
		kill orgObj	
		do objData.%Save()
		kill objData
	}
	// are any other objects linked to this?
	if (dataID="")!(dataID="NEW") if orgDataID'="" set dataID=orgDataID
	set objectIsReused=0
	&SQL(SELECT ID INTO :tmp FROM sc.objData WHERE (sourceID = :dataID)  AND (active=1))
	if +SQLCODE=0 set objectIsReused=1
	set %session.Data("objectIsReused")=objectIsReused
	// show warning if we are redirecting to a original object
	if ((sourceID)!(objectIsReused))&(%request.Get("skipWarning")'=1) {
		set %session.Data("returnPage")=%request.PageName
		set %response.ServerSideRedirect="reUseWarning.csp"
		quit 0
	} else {
	
		quit 1
	}
]]></Implementation>
</Method>

<Method name="getParentID">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set out=""
	&SQL(SELECT parent INTO :tmp FROM sc.objData WHERE ID = :dataID)	
	if +SQLCODE=0 set out=tmp
	quit out
]]></Implementation>
</Method>

<Method name="hasChildren">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set out=0
	&SQL(SELECT ID INTO :tmp FROM sc.objData WHERE (active=1 AND parent = :dataID))
	if +SQLCODE=0 set out=1
	
	quit out
]]></Implementation>
</Method>

<Method name="getDisplayOrder">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set data=""
	&SQL(SELECT displayOrder INTO :tmp FROM sc.objData	WHERE (active=1 AND ID = :dataID))
	if +SQLCODE=0 set data=tmp
	quit data
]]></Implementation>
</Method>

<Method name="getQuestionPrompt">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataID,languageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if ##class(sc.objData).getDataType(dataID)="objFileUpload" {
		set questionPrompt=##class(sc.xModules.objFileUpload).getQuestionPrompt(dataID)
	
	} elseif ##class(sc.objData).getDataType(dataID)="objCODitem" {
		set questionPrompt=##class(sc.xModules.objCODitem).getQuestPrompt(dataID,languageID)
	
	} else {
		throw ##class(shared.exceptions.generalException).%New("Data item has no question prompt")	
	}
	return questionPrompt
]]></Implementation>
</Method>

<Method name="getEditorPageNameForDataType">
<ClassMethod>1</ClassMethod>
<FormalSpec>dataType:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	return $Case(dataType,
					"objText":"textDetailsMoxie.csp",
					"objImage":"imageDetails.csp",
					"objSurveyQuestion":"disused",
					"objCODitem":"codQuestionDetails.csp",
					"objMenuBlock":"menuDetails.csp",
					"objScrollingImage":"scrollingImageDetails.csp",
					"objFlash":"flashDetails.csp",
					"objFileUpload":"fileUploadDetails.csp",
					:"")
]]></Implementation>
</Method>

<Method name="getEditMenuArray">
<FormalSpec><![CDATA[context:%ZEN.proxyObject,&editMenuStr]]></FormalSpec>
<Implementation><![CDATA[
	#dim className as %String = ..getDataType(..%Id())
	#dim dataID as %Integer = ..%Id()
	#dim pageID as %Integer = context.pageID
	#dim xEventID as %Integer = ..objEventGetObjectId()
	#dim idx as %Integer = $Order(editMenuStr(""),-1)+1
	
	set editPage = ..getEditorPageNameForDataType(className)
	
	// Set up the URLs
	set editURL=##class(shared.pCSP).Link(context.app_"/backend/proweb/"_editPage_"?dataID="_##class(EF.htmlGenerator).encodeForURL(context.editID)_"&templateURL="_##class(EF.htmlGenerator).encodeForURL(context.templateFilename)_"&componentName="_##class(EF.htmlGenerator).encodeForURL(context.componentName)_"&templateID="_##class(EF.htmlGenerator).encodeForURL(context.templateID)_"&warning="_##class(EF.htmlGenerator).encodeForURL(context.warning)_"&orgDataID="_##class(EF.htmlGenerator).encodeForURL(context.orgDataID)_"&parent="_##class(EF.htmlGenerator).encodeForURL(context.listID)_"&classNo=1&displayOrder="_##class(EF.htmlGenerator).encodeForURL(context.displayOrder)_"&isCOD="_##class(EF.htmlGenerator).encodeForURL(context.isCOD)_"&pageID="_##class(EF.htmlGenerator).encodeForURL(context.pageID))
	set delURL="javasc"_"ript: confirmDelete("_context.deleteID_");"

	// output javascript for the edit version of the floater
	set editMenuStr($I(idx)) = "<sc"_"ript language='javasc"_"ript'>"
	set editMenuStr($I(idx)) = "HM_Array"_context.menuID_" = [[150,,,,,,,,,,,,,,,,,,,,1],"

	// make a title bar in the floater
	set titleText=$S(className="objFormDivider":"Form Divider",className="objScrollingImage":"Scolling Image",className="objText":"Text",className="objImage":"Image",1:className)
	set title="----- "_titleText_" ------"
	if className="objCODitem" {
		set obj=##class(sc.objData).%OpenId(context.viewID)
		// display coditemname rather than desc because html formatted desc upsets JS 
		set title="----- "_$S(obj.isGuest:"GUEST_",1:"")_##class(shared.pCSP).EscapeHTML(obj.objItemName.description)
		kill obj
	}

	if className="objFileUpload" {
		set obj=##class(sc.objData).%OpenId(context.viewID)
		// display coditemname rather than desc because html formatted desc upsets JS // Fred v 1.1.5
		set title="----"_##class(shared.pCSP).EscapeHTML($ZCVT(obj.objItemName.description,"U"))_"---"
		kill obj
	}

	set editMenuStr($I(idx)) = "['"_title_"','',0,0,0],"
	
	if className'="objFormDivider" {
		if (context.isCOD)!(context.isDOC)!(context.isForm) {
			set editMenuStr($I(idx))= "['Edit','"_editURL_"',1,0,0],"
		} else {
			set editMenuStr($I(idx)) = "['Edit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;("_dataID_")','"_editURL_"',1,0,0],"
		}
	}
	
	// Do not allow them to delete questions that have dependent children
	set rsChildPrompts=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set query="SELECT ID,parent->parent As pageID FROM sc_xModules.objCODitem WHERE (dependsOnPrompt = ?) AND (active=1) AND (parent->parent->active = 1)"
	do rsChildPrompts.Prepare(query)
	do rsChildPrompts.Execute(dataID)
	while rsChildPrompts.Next() {
		set tmpPageID=rsChildPrompts.Get("pageID")
		if (tmpPageID=context.pageID)!(##class(setup.lnkCategoryEvent).isPageActive(xEventID,tmpPageID,context.langID)) {
			set delURL="javasc"_"ript: alert("""_##class(shared.pCSP).translateAdmin("Can not be deleted because it has dependent questions")_""");"
		}
	}
	
	// Do not allow them to delete questions that have dependent children
	set rsChildText=##class(%ResultSet).%New("%Library.DynamicQuery:SQL")
	set query="SELECT ID,parent->parent As pageID FROM sc_xModules.objText WHERE (dependsOnPrompt = ?) AND (active=1) AND (parent->parent->active = 1)"
	do rsChildText.Prepare(query)
	do rsChildText.Execute(dataID)
	while rsChildText.Next() {
		set tmpPageID=rsChildText.Get("pageID")
		if (tmpPageID=context.pageID)!(##class(setup.lnkCategoryEvent).isPageActive(dataID,tmpPageID,context.langID)) {
			set delURL="javasc"_"ript: alert("""_##class(shared.pCSP).translateAdmin("Can not be deleted because it has dependent text blocks")_""");"
		}
	}
	
	if className="objCODitem" {
		&SQL(SELECT objItemName->description INTO :tmp FROM sc_xModules.objCODitem WHERE (ID = :dataID) AND (active=1))
		if +SQLCODE=0 {
			&SQL(SELECT ID FROM setup.lnkCategoryEvent 
				WHERE (dependsOnPromptPageID = :pageID) AND (%SQLUPPER(dependsOnObjItemName->description) = %SQLUPPER(:tmp)) AND (active=1)
				AND objEventCategory IN (
					SELECT objEventCategory
					FROM setup.lnkAttendeeCategoryDetailsEvent 
					WHERE (objEvent=:xEventID)
				)
			)
			if +SQLCODE=0 set delURL="javasc"_"ript: alert("""_##class(shared.pCSP).translateAdmin("Can not be deleted because it has a dependent page")_""");"
		}
	}

	// do not allow them to delete firstname and lastname on tablebooking or abstract signup page
	if className="objCODitem" {
		if ($ZCVT(context.pageName,"L")="ttableguests.csp") ! ($ZCVT(context.pageName,"L")="tabssignup.csp") {
			set obj=##class(sc.objData).%OpenId(context.viewID)
			if ($ZCVT(obj.objItemName.description,"U")="FIRSTNAME")!($ZCVT(obj.objItemName.description,"U")="LASTNAME") set context.suppressDelete=1
			kill obj
		}
	}

	if 'context.suppressDelete {
		set editMenuStr($I(idx)) = "['Delete','"_delURL_"',1,0,0],"
	}

	set up="up",down="down"
	set top="top",bottom="bottom"
	;set editMenuStr($I(idx)) = "['Move Up',""javasc"_"ript: moveItem("_dataID_",'"_up_"');"",1,0,0],['Move Down',""javasc"_"ript: moveItem("_dataID_",'"_down_"');"",1,0,0]"
	set editMenuStr($I(idx)) = "['Add item here',""javasc"_"ript: HM_f_PopUp('HM_Menu101',event);"",1,0,0]"
	;set editMenuStr($I(idx)) = ",['Move to Top',""javasc"_"ript: moveItem("_dataID_",'"_top_"');"",1,0,0],['Move to Bottom',""javasc"_"ript: moveItem("_dataID_",'"_bottom_"');"",1,0,0],['Move to Position',""javasc"_"ript: moveItemToPosition("_dataID_");"",1,0,0]"
	set editMenuStr($I(idx)) = "];</sc"_"ript>"
]]></Implementation>
</Method>

<Method name="getDependsOnAlternativeID">
<Description>
note that this must be a classmethod or you will a compile error as the property only exists on some of the child classes</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>listItem:sc.objData</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	try {
		return listItem.dependsOnAlternative
	} catch { // this will happen for images, dividers etc.
		return ""	
	}
]]></Implementation>
</Method>

<Method name="getDependsOnQuestionID">
<ClassMethod>1</ClassMethod>
<FormalSpec>listItem:sc.objData</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	try {
		return listItem.dependsOnPrompt
	} catch { // this will happen for images, dividers etc.
		return ""	
	}
]]></Implementation>
</Method>

<Method name="getDependsOnItemName">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set dependsOnAltID = ..getDependsOnAlternativeID($this)
	if dependsOnAltID {
		set alternative = ##class(cod.objItemAlternatives).%OpenId(dependsOnAltID)
		if $IsObject(alternative) {
			return alternative.objItemName.description
		}
	}
	return ""
]]></Implementation>
</Method>

<Method name="getDependsOnAlternativeName">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set dependsOnAltID = ..getDependsOnAlternativeID($this)
	if dependsOnAltID {
		set alternative = ##class(cod.objItemAlternatives).%OpenId(dependsOnAltID)
		if $IsObject(alternative) {
			return alternative.description
		}
	}
	return ""
]]></Implementation>
</Method>

<Method name="getDependencyHoverText">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim dependsOnPromptDesc as %String  = ..getDependsOnItemName()
	#dim dependsOnAlternativeDesc as %String = ..getDependsOnAlternativeName()
	#dim hoverText as %String = ""
	
	if $Length(dependsOnPromptDesc) {
		set hoverText = " title='Display when: "_dependsOnPromptDesc_" = "_dependsOnAlternativeDesc
		
		set dependsOnPageID = ..getPageID(..getDependsOnQuestionID($this))
		set myPageID = ..getPageID(..%Id())
		
		if myPageID '= dependsOnPageID {
			set hoverText = hoverText_" (on page &quot;"_##class(sc.xModules.objPage).getDescription(dependsOnPageID)_"&quot;)"	
		}
		set hoverText = hoverText_"'"
	}	
	return hoverText
]]></Implementation>
</Method>

<Query name="qGetChildren">
<Type>%SQLQuery</Type>
<FormalSpec>parentID:%String=""</FormalSpec>
<SqlQuery>SELECT ID FROM objData
 WHERE (parent = :parentID AND active = 1)
 ORDER BY ID</SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^sc.objDataD</DataLocation>
<DefaultData>objDataDefaultData</DefaultData>
<IdLocation>^sc.objDataD</IdLocation>
<IndexLocation>^sc.objDataI</IndexLocation>
<StreamLocation>^sc.objDataS</StreamLocation>
<ExtentSize>5000</ExtentSize>
<Data name="objDataClassName">
<Attribute>%%CLASSNAME</Attribute>
<Structure>node</Structure>
<Subscript>0</Subscript>
</Data>
<Data name="objDataDefaultData">
<Value name="1">
<Value>xCRstamp</Value>
</Value>
<Value name="2">
<Value>xMOstamp</Value>
</Value>
<Value name="3">
<Value>creator</Value>
</Value>
<Value name="4">
<Value>displayOrder</Value>
</Value>
<Value name="5">
<Value>nextVersion</Value>
</Value>
<Value name="6">
<Value>parent</Value>
</Value>
<Value name="7">
<Value>previousVersion</Value>
</Value>
<Value name="8">
<Value>objTemplate</Value>
</Value>
<Value name="9">
<Value>objStep</Value>
</Value>
<Value name="10">
<Value>dataType</Value>
</Value>
<Value name="11">
<Value>active</Value>
</Value>
<Value name="12">
<Value>publishAt</Value>
</Value>
<Value name="13">
<Value>sourceID</Value>
</Value>
<Value name="14">
<Value>xCRuserID</Value>
</Value>
<Value name="15">
<Value>xMOuserID</Value>
</Value>
<Value name="16">
<Value>afterItem</Value>
</Value>
<Value name="17">
<Value>afterRow</Value>
</Value>
<Value name="18">
<Value>beforeItem</Value>
</Value>
<Value name="19">
<Value>beforeRow</Value>
</Value>
<Value name="20">
<Value>deleteMe</Value>
</Value>
<Value name="21">
<Value>objEvent</Value>
</Value>
</Data>
<Property name="active">
<Selectivity>100.0000%</Selectivity>
</Property>
<Property name="creator">
<Selectivity>16.6667%</Selectivity>
</Property>
<Property name="dataType">
<Selectivity>14.2857%</Selectivity>
</Property>
<Property name="displayOrder">
<Selectivity>7.6923%</Selectivity>
</Property>
<Property name="nextVersion">
<Selectivity>2.4390%</Selectivity>
</Property>
<Property name="objStep">
<Selectivity>50.0000%</Selectivity>
</Property>
<Property name="parent">
<Selectivity>0.01%</Selectivity>
</Property>
<Property name="previousVersion">
<Selectivity>2.5000%</Selectivity>
</Property>
<Property name="publishAt">
<Selectivity>33.3333%</Selectivity>
</Property>
<Property name="sourceID">
<Selectivity>24.9999%</Selectivity>
</Property>
<Property name="xCRstamp">
<Selectivity>0.3831%</Selectivity>
</Property>
<Property name="xCRuserID">
<Selectivity>6.2500%</Selectivity>
</Property>
<Property name="xMOstamp">
<Selectivity>0.5076%</Selectivity>
</Property>
<Property name="xMOuserID">
<Selectivity>4.7619%</Selectivity>
</Property>
</Storage>
</Class>


<Class name="sc.xModules.objList">
<Description><![CDATA[
Holds a list of other objects as children.
<!-- ;vc;
;vc;    Object: sc.xModules.objList.CLS/EV.3
;vc; Component: CLS.sc.xModules.objList
;vc;  Location: SmallDev
;vc; Date/Time: 25-Apr-16 14:50
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>sc.xModules.objList.CLS/EV.3</td><td>CLS.sc.xModules.objList</td><td>SmallDev</td><td style='white-space: nowrap;'>25-Apr-16 14:50</td><td>JeremyW</td></tr></table>
]]></Description>
<ClassType>persistent</ClassType>
<ProcedureBlock>1</ProcedureBlock>
<Super>sc.objData</Super>
<TimeChanged>64203,55727.052985</TimeChanged>
<TimeCreated>58926,57261</TimeCreated>

<Parameter name="EXTENTSIZE">
<Default>3492</Default>
</Parameter>

<Property name="dataType">
<Description>
Used for identifying the class of the object withour having to call
cache mysterious APIs.</Description>
<Type>%Library.String</Type>
<InitialExpression>"objList"</InitialExpression>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="subClass">
<Type>%Library.String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Method name="add">
<Description>
Creates new list object. Should be done the first time the page is loaded</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set pageID=+pageID
	if pageID=0 quit "0|no page ID passed in to add.objList"
	set stepID=##class(sc.objStep).getFinalLevelID()
	&SQL(INSERT INTO sc_xModules.objList (parent,creator,active,objStep) VALUES (:pageID,'system',1,:stepID))
	
	quit %ROWID
]]></Implementation>
</Method>

<Method name="getListIDFromPageIDAndComponentName">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,componentName</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	set rsLists = ##class(%ResultSet).%New("sc.objData:qGetChildren")
	do rsLists.Execute(pageID)
	while rsLists.Next() {
		set listID = rsLists.Get("ID")		
		if $ZCVT(##class(sc.objComponent).getComponentName(listID),"L") = $ZCVT(componentName,"L") {
			return listID
		}
	}
	return ""
]]></Implementation>
</Method>

<Method name="moveChildToPosition">
<ClassMethod>1</ClassMethod>
<FormalSpec>childProwebID:%Integer,targetPosition:%Integer</FormalSpec>
<Implementation><![CDATA[
	set child = ##class(sc.objData).%OpenId(childProwebID)
	
	if '$IsObject(child)   {
		throw ##class(shared.exceptions.generalException).%New("Could not open child object ID: "_childProwebID)
	}
	if 'child.parent.%IsA("sc.xModules.objList") {
		throw ##class(shared.exceptions.generalException).%New("Passsed in childID is not a a child of an objList")
	}

	set currentDisplayOrder = child.displayOrder
	set listID = child.parent.%Id()
	
	set difference = $Select(targetPosition < currentDisplayOrder:+1, 1:-1)

	&SQL(UPDATE sc.objData 
		 SET displayOrder = (displayOrder + :difference) 
		 WHERE (parent = :listID) 
		 AND (displayOrder >= :targetPosition) 
		 AND (ID <> :childProwebID)
	 )
	
	set child.displayOrder = targetPosition
	set status = child.%Save()
	if 'status {
		throw ##class(shared.exceptions.generalStatusException).CreateFromStatus(status)
	}
]]></Implementation>
</Method>

<Query name="qGetQuestions">
<Type>%SQLQuery</Type>
<FormalSpec>listID:%String=""</FormalSpec>
<SqlQuery>SELECT ID FROM sc_xModules.objCODitem
 WHERE (parent = :listID) 
 AND (active = 1)
 ORDER BY displayOrder</SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Query name="qGetChildren">
<Type>%SQLQuery</Type>
<FormalSpec>listID:%String=""</FormalSpec>
<SqlQuery>SELECT * FROM sc.objData
 WHERE (parent = :listID) AND (active = 1)
 ORDER BY displayOrder</SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>objListDefaultData</DefaultData>
<Data name="objListDefaultData">
<Subscript>"objList"</Subscript>
<Value name="1">
<Value>subClass</Value>
</Value>
</Data>
<Property name="active">
<Selectivity>49.9999%</Selectivity>
</Property>
<Property name="creator">
<Selectivity>49.9999%</Selectivity>
</Property>
<Property name="dataType">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="displayOrder">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="nextVersion">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="objStep">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="parent">
<Selectivity>0.0320%</Selectivity>
</Property>
<Property name="previousVersion">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="publishAt">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="sourceID">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="subClass">
<Selectivity>99.9995%</Selectivity>
</Property>
<Property name="xCRstamp">
<Selectivity>0.6952%</Selectivity>
</Property>
<Property name="xCRuserID">
<Selectivity>9.0909%</Selectivity>
</Property>
<Property name="xMOstamp">
<Selectivity>0.1257%</Selectivity>
</Property>
<Property name="xMOuserID">
<Selectivity>6.2499%</Selectivity>
</Property>
</Storage>
</Class>


<Class name="shared.pageMethods">
<Description><![CDATA[
<!-- ;vc;-
;vc;    Object: shared.pageMethods.CLS/EV.174
;vc; Component: CLS.shared.pageMethods
;vc;  Location: SmallDev
;vc; Date/Time: 02-Sep-16 14:28
;vc;      User: JeremyW
;vc; --><p>VC/m status:<table id='vcm' border='1'><tr><th>Object</th><th>Component</th><th>Location</th><th>Date/Time</th><th>User</th></tr><tr><td>shared.pageMethods.CLS/EV.174</td><td>CLS.shared.pageMethods</td><td>SmallDev</td><td style='white-space: nowrap;'>02-Sep-16 14:28</td><td>JeremyW</td></tr></table>
]]></Description>
<Abstract>1</Abstract>
<ClassType/>
<ProcedureBlock>1</ProcedureBlock>
<TimeChanged>64204,53132.183324</TimeChanged>
<TimeCreated>60747,44410.590792</TimeCreated>

<Method name="prePartOne">
<ClassMethod>1</ClassMethod>
<FormalSpec>frontback:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set ip=%request.GetCgiEnv("REMOTE_ADDR","no ip")
	set URL=$ZCVT(%request.URL,"L")				// this is the url and path: /evdev/frontend/reg/homepage.csp
	set pagename=$ZCVT(%request.PageName,"L")	// this is just the url: homepage.csp
	set cspAppName=##class(EF.config.clientData).getCSPAppForCurrentNameSpace()
	set appFromURL=$p(URL,"/",2)
	set pageID=%request.Get("pageID")

	if ..isApplicationStopped() {
		set %response.ServerSideRedirect=##class(shared.pageMethods).getURLforMaintenancePage(cspAppName)
		quit "0|0"
	}
	
	if ..isIncludePage() quit 1
	
	do ..updateLoadMonitor()
	
	do ..manageSEOrequest()
	
	do ..injectP3Ppolicy()
	
	do ..sanitiseRequestData()
	
	if ..isCrossSiteScripting() {
		set %response.Redirect=..getRedirectURLforXSS(cspAppName)
		quit "0|0"
	}

	do ..updatePageHistory()

	if pagename="errorpage.csp" quit "0|1"  // will force quit 1 from preHTTP
	
	if ##class(EF.config.clientData).isAppRedirected(appFromURL) {
		set %response.Redirect=..getURLForRedirectedApp(URL)
		quit "0|0"
	}

	if ..isNewFrontendSession(frontback,URL,pagename) {
		set %response.Redirect=..getRedirectURLforNewSession(pagename) // need to get new session set up if we do not have it and redirect to homepage.csp (for example if you go straight to dailyAgenda.csp)
		quit "0|0"
	}

	if ..hasSwitchedLanguage(frontback,URL,pagename) {
		set %response.Redirect=..getRedirectURLforNewLanguage(pagename)
		quit "0|0"
	}				
	
	if ..isBackendPageAuthorised(frontback,pagename)=0 {
		set %response.Redirect=..getRedirectURLforUnauthorisedBackendPage(pagename)
		quit "0|0"
	}
	if ##class(cod.methods).getCurrentBackendUser() {
		if pageID {
			if '(..isPageIDAllowedForBackendSession(pageID,pagename)) {
				set %response.Redirect=..getRedirectURLforUnauthorisedProwebPage(pagename,pageID) 
				quit "0|0"
			}
		}
	}
	do ..updateDebugInfo(URL,pagename)
	
	quit 1  // continue processing
]]></Implementation>
</Method>

<Method name="prePartThree">
<ClassMethod>1</ClassMethod>
<FormalSpec>frontback:%String,bypassLicenseCheck:%Boolean=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if ..isIncludePage() quit 1
	set ip=%request.GetCgiEnv("REMOTE_ADDR","no ip")
	set URL=$ZCVT(%request.URL,"L")				// this is the url and path: /evdev/frontend/reg/homepage.csp
	set pagename=$ZCVT(%request.PageName,"L")	// this is just the url: homepage.csp
	set userID=$G(%session.Data("eventsforce","backend","xPersonID"),"")
	
	// log page hit
	do ##class(admin.objLog).logNonProwebPage(userID,URL,"eventsForce")
	
	// am I in an include page?
	set includePage=0
	if $L(%request.Get("CSPInclude")) set includePage=1

	// set menu item selected if it's just been clicked
	if %request.Get("ef_sel_menu"),'includePage set %session.Data("eventsforce","frontend","menu","selected")=%request.Get("ef_sel_menu")
	
	// log backend hits
	if userID,%request.Get("storeBack"),'includePage	{
		set category=%request.Get("category")
		set subcategory=%request.Get("subcategory")
		set subsubcategory=%request.Get("subsubcategory")
		set subsubsubcategory=%request.Get("subsubsubcategory")
		// userID == personID
		do ##class(admin.objLogBackend).logPage(userID,%session.SessionId,category,subcategory,subsubcategory,subsubsubcategory)
	}
	
	// above does not work when gateway holds the app name - replaced with below
	set sharedPath="/"_$ZCVT(^%ZCSPAPPS($ZNSPACE),"L")
	set loginPage=sharedPath_"/backend/home/login.csp"
	set accessDenied=sharedPath_"/frontend/static/accessDenied.htm"
	set invalidURLPage=sharedPath_"/frontend/static/invalidURL.htm"

	set %session.Data("eventsforce",frontback,"requestPage")=URL

	// redirect to login if not logged in
	if frontback="backend"	{
		
		// check user has not logged in on one namespace and changed the URL to get into another clients area...
		if $G(%session.Data("eventsforce","backend","NAMESPACE"))'=$ZNSPACE,(URL'["login")&(URL'["tc.csp") set userID=""

		if userID=""&(URL'["login")&(URL'["tc.csp")&(URL'["initialisenamespace.csp")&(URL'["passwordreset") {
		set %session.Data("eventsforce",frontback,"beforeLogin")=URL
			set %response.Redirect=loginPage
			quit "0|0"
		}
		// Update the selectedMenuAccessID from the request variable to allow for multiple windows, tabs, etc..
		if (URL'["login")&(URL'["tc.csp")&(URL'["tc2.csp")&(URL'["logout.csp") {
			if $l(%request.Get("selectedMenuAccessID")) {
				// selectedMenuAccessID is set when clicking on a menu item
				set %session.Data("eventsforce","backend","xSelectedMenuAccessID")=%request.Get("selectedMenuAccessID")
			} elseif $l(%request.Get("xSelectedMenuAccessID")) {
				// Otherwise use xSelectedMenuAccessID
				set %session.Data("eventsforce","backend","xSelectedMenuAccessID")=%request.Get("xSelectedMenuAccessID")
			
			}
			if $L($G(%session.Data("eventsforce","backend","xSelectedMenuAccessID"))) set %response.Context("xSelectedMenuAccessID")=$G(%session.Data("eventsforce","backend","xSelectedMenuAccessID"))
		}

		// Update the event ID from the menu, if we do not have one goto the eventAdminList
		if ..doesBackendPageRequireEventID(pagename) {
			set xEventID=..requestGetEventID() 
			// We shouldn't select an event for dynamic
			if xEventID'="NEW",'##class(access.objFunction).hasFunction(userID,"Dynamic Reports Only") {
				if 'xEventID set xEventID=..getBackendEventIDFromSession()
				if 'xEventID set xEventID=##class(cod.objItemData).get(userID,"last event selected")
				
				// make sure they have access to their previous selected event - you never know...
				if '##class(links.lnkAccessPersonEvent).hasEvent(userID,xEventID) {
					set xEventID=""
					do ##class(cod.objItemData).set(userID,"last event selected","")
				}
				
				// Set the working language if we have just changed event
				if ##class(setup.objSystemTypes).isModuleAllowed("Multi Lingual Frontend") {
					if xEventID'=..getBackendEventIDFromSession() {
						set %session.Data("eventsforce","backend","xWorkLangID")=##class(setup.objEventSetting).getParameter("backend","default creation language",xEventID)
					}
				}
				if '$G(%session.Data("eventsforce","backend","xWorkLangID")) set %session.Data("eventsforce","backend","xWorkLangID")=1
				
				set %session.Data("eventsforce","backend","xEventID")=xEventID
				// redirect to the event selection unless they are support
				if ('xEventID)&&('##class(admin.objUser).isEFuser(userID)) { 
					set %response.Redirect=sharedPath_"/backend/home/eventSelection.csp"
					quit "0|0"
				}
			}
			
		}
		if ##class(setup.objSetting).getParameter("system","backend menu security") {
			// If pagename is a menu item check that they have access to it
			set ok=0
			// Special cases for pages that can be called from elsewhere
			if pagename="gotoonlinereports.csp" {
				if ##class(access.objRole).hasRole(userID,"Single Report") set ok=1
				if ##class(access.objFunction).hasFunctionByAccessID(userID,"ADVSEARCH") set ok=1
			} elseif pagename="delegatesearchsimple.csp" {
				set ok=1
				if ##class(access.objFunction).hasFunction(userID,"Dynamic Reports Only") set ok=0
				// Just about anyone can get to this page
			} elseif pagename="dynarepstart.csp" {
				if (##class(access.objRole).hasRole(userID,"Reports Only")) set ok=1
				if ##class(access.objFunction).hasFunctionByAccessID(userID,"REPS") set ok=1
				if ##class(access.objFunction).hasFunction(userID,"Dynamic Reports Only") set ok=1
			} elseif pagename="eventemails2.csp" {
				for accessID="EMAIL","MAILCAMP" {
					if ##class(access.objFunction).hasFunctionByAccessID(userID,accessID) set ok=1
				}
			} else {
				set ok=1
			}
			if 'ok {
				set %response.Redirect=##class(access.backendPageNav).whichHomepage(userID)
				quit "0|0"
			}
		}
	}

	// make sure frontend people cannot get to any page if event not live
	if $G(%session.Data("eventsforce","frontend","xEventID"))	{
		if $G(^xDEBUG) set ^xDEBUGPAGES($I(^xDEBUGPAGES),$ZTS,"here 8")=%session.Data("eventsforce","frontend","xEventID")
		// if userID is not numeric then we are not someone with a backend session open = general public
		// allow calls from Protx and Worldpay otherwise we cannot give a response for non-live events
		if 'userID&('##class(shared.pageMethodsFrontend).isPageAnAllowedEntryPage(URL)) {
			set objEvent=##class(setup.objEvent).%OpenId(%session.Data("eventsforce","frontend","xEventID"))
			if objEvent.status'="live"	{
				if $G(^xDEBUG) set ^xDEBUGPAGES($I(^xDEBUGPAGES),$ZTS,"here 8.1")=""
				set %response.Redirect=accessDenied
				kill objEvent
				quit "0|0"
			}
			kill objEvent
		}
	}
	
	quit 1  // continue processing
]]></Implementation>
</Method>

<Method name="resolvePath2">
<ClassMethod>1</ClassMethod>
<FormalSpec>inPath</FormalSpec>
<Implementation><![CDATA[
	// split the path up in two pieces no matter the case with our changing the case
	set loPath=$ZCVT(inPath,"L")
	
	//  allow images that don't use the standard images
	if loPath'["/default/" quit inPath
	
	set part1Len=$L($P(loPath,"/default/",1))
	
	// get rid of the "default"
	set part1=$E(inPath,1,part1Len)
	set part1=$p(part1,"/",1,$L(part1,"/")-1)
	
	// get the filename
	set part2Start=part1Len+10
	set part2=$E(inPath,part2Start,999)
	
	// are we in the frontend or the backend?
	set frontback=##class(shared.pCSP).frontBack()
	
	// do we have a client specific subdirectory for images?
	set subDir=$G(%session.Data("eventsforce",frontback,"xClientDir"))
	if subDir="" set subDir="default"

	// find our preferred language
	if frontback="frontend",$G(%session.Data("eventsforce",frontback,"xPrefLangID")) {
		set language=##class(shared.objLanguage).getLanguageDesc(%session.Data("eventsforce",frontback,"xPrefLangID"))
	} else {
		set language=$G(%session.Data("eventsforce",frontback,"xLanguage"))
	}
	
	// fall back to english if no language found (XT page etc)
	if language="" set language="English"

	// merge it all to a path	
	set outPath=part1_"/"_language_"/"_subDir_"/"_part2
	
	quit outPath
]]></Implementation>
</Method>

<Method name="resolveStyle2">
<ClassMethod>1</ClassMethod>
<FormalSpec>inPath</FormalSpec>
<Implementation><![CDATA[
	if $ZCVT(inPath,"L")'["default" quit inPath // spare proweb from path resolving

	// try to split the path up in two pieces no matter the case with our changing the case
	set loPath=$ZCVT(inPath,"L")
	set part1Len=$L($P(loPath,"/default/",1))
	set part1=$E(inPath,1,part1Len)
	set part2Start=part1Len+10
	set part2=$E(inPath,part2Start,999)
	
	set frontback=##class(shared.pCSP).frontBack()
	set subDir=$G(%session.Data("eventsforce",frontback,"xClientStyleDir"))
	if $L(subDir)>1 {
		set outPath=part1_"/"_$G(%session.Data("eventsforce",frontback,"xClientStyleDir"))_"/"_part2
	} else {
		set outPath=inPath	
	}
	
	quit outPath
]]></Implementation>
</Method>

<Method name="frontBack2">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set frontback=""
	// try this current page's URL
	if $ZCVT(%request.URL,"L")["/frontend/" set frontback="frontend"
	if $ZCVT(%request.URL,"L")["/backend/" set frontback="backend"
	// now try the previous page's URL (although this can be blocked by lots of firewall s/w)
	if frontback="",$ZCVT($G(%request.CgiEnvs("HTTP_REFERER")),"L")["/frontend/" set frontback="frontend"
	if frontback="",$ZCVT($G(%request.CgiEnvs("HTTP_REFERER")),"L")["/backend/" set frontback="backend"
	// if in template page (dir=/templates/dd)
	if frontback="",$L(%request.Get("frontback")) set frontback=%request.Get("frontback")
	if frontback="" set frontback="frontend"   // last resort, assume frontend to stop any dodgy access going on
	quit frontback
]]></Implementation>
</Method>

<Method name="outputFrontendHeader">
<ClassMethod>1</ClassMethod>
<FormalSpec>IECompatMode=0</FormalSpec>
<Implementation><![CDATA[
	// used to create the http header and can depend on eventID (as some templates may require this)
	set header=""
	set xEventID=$G(%session.Data("eventsforce","frontend","xEventID"))
	if xEventID="" set xEventID=..getBackendEventIDFromSession()

	set layoutTemplateID="",useHTML5=""
	if $G(xEventID) {
		set layoutTemplateID=##class(layout.objTemplate).getLayoutForEvent(xEventID)
		set useHTML5=##class(layout.objTemplate).isTemplateHTML5Compatible(layoutTemplateID)
	}
	
	set xLangID=$G(%session.Data("eventsforce","frontend","xPrefLangID"))
	if xLangID {
		set ISOlang=##class(shared.objLanguage).getISOCode(xLangID)
	} else {
		set ISOlang="en"	
	}
	
	set IEEdgeStr = "<meta http-equiv=""X-UA-Compatible"" content=""IE=edge"">"
	if (IECompatMode){
		set IEEdgeStr = ""
	}
	if xEventID,##class(setup.objEventSetting).getParameter("website","useHTTPheaderHTML4",xEventID)	{
		set header=header_"<!DOCTYPE HTML PUBLIC ""-//W3C//DTD HTML 4.01 Transitional//EN"" ""http://www.w3.org/TR/html4/loose.dtd"">"_IEEdgeStr_$C(13,10)
		set header=header_"<!--[if IE 7 ]>    <html class=""ef_frontend_ie7 ef-ie7"" lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 8 ]>    <html class=""ef_frontend_ie8 ef-ie8"" lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 9 ]>    <html class=""ef_frontend_ie9 ef-ie9"" lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if (gt IE 9)|!(IE)]><!--> <html lang="""_ISOlang_"""> <!--<![endif]-->"_$C(13,10)
		
	} elseif useHTML5 {  // need the html5 doctype for bootstrap responsive designs and also to make moxie tinymce 4.1.5 appear correctly
		set header=header_"<!DOCTYPE html>"_IEEdgeStr_$C(13,10)
		set header=header_"<!--[if IE 7 ]>    <html class=""ef_frontend_ie7 ef-ie7"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 8 ]>    <html class=""ef_frontend_ie8 ef-ie8"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 9 ]>    <html class=""ef_frontend_ie9 ef-ie9"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if (gt IE 9)|!(IE)]><!--> <html xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <!--<![endif]-->"_$C(13,10)

	} else {
		set header=header_"<!DOCTYPE html PUBLIC ""-//W3C//DTD XHTML 1.0 Transitional//EN"" ""http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"">"_IEEdgeStr_$C(13,10)
		set header=header_"<!--[if IE 7 ]>    <html class=""ef_frontend_ie7 ef-ie7"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 8 ]>    <html class=""ef_frontend_ie8 ef-ie8"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if IE 9 ]>    <html class=""ef_frontend_ie9 ef-ie9"" xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <![endif]-->"_$C(13,10)
		set header=header_"<!--[if (gt IE 9)|!(IE)]><!--> <html xmlns=""http://www.w3.org/1999/xhtml"" lang="""_ISOlang_""" xml:lang="""_ISOlang_"""> <!--<![endif]-->"_$C(13,10)
	}
	quit header
]]></Implementation>
</Method>

<Method name="getDownloadExpiry">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	quit 5
]]></Implementation>
</Method>

<Method name="getFullPathVCard">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<Implementation><![CDATA[
	set overridingSSLmode="" // we might want to change parameterthis in the future if IE decides to give us grief with session cookie again
	quit ..getFullPath(eventID,overridingSSLmode)
]]></Implementation>
</Method>

<Method name="getFullPath">
<Description>
use this method to get the domain and cspapp name along with http or https
returns something like this: https://www.eventsforce.net/support2</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID="",overridingSSLmode=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 
	set browserDomain=""
	if $D(%request) set browserDomain=$ZCVT(%request.GetCgiEnv("SERVER_NAME"),"L") // use this to determine which backend domain to use/return
	// if calling from a non-web page then should be event related and pick up the event setting

	set useSSL=##class(setup.objSetting).getParameter("system","requires SSL")
	if overridingSSLmode'="" set useSSL=overridingSSLmode
	set fullURL=""

	// only use the event settings if we have specifically set the system setting (to make sure all values are set up correctly at event level)
	if eventID	{
		set fullURL=##class(setup.objEventSetting).getParameter("system","domain",eventID)
	}

	// get backend URLS
	if fullURL="" {
		set dom=##class(setup.objSetting).getParameter("system","domain 1")
		if $L(dom) set domains(dom)=""
		set dom=##class(setup.objSetting).getParameter("system","domain 2")
		if $L(dom) set domains(dom)=""
		set dom=##class(setup.objSetting).getParameter("system","domain 3")
		if $L(dom) set domains(dom)=""
		set dom=##class(setup.objSetting).getParameter("system","domain 4")
		if $L(dom) set domains(dom)=""
		set dom=##class(setup.objSetting).getParameter("system","domain 5")
		if $L(dom) set domains(dom)=""
		
		// check against current
		if $L(browserDomain) {
			set fullURL=browserDomain
			if '$D(domains(browserDomain)) set fullURL=##class(setup.objSetting).getParameter("system","domain 1")
		} else {
			// if not running from browser
			set fullURL=##class(setup.objSetting).getParameter("system","domain 1")
		}
	}
	if fullURL="" set fullURL="www.eventsforce.net"

	// add on the csp app name
	set fullURL=fullURL_"/"_##class(EF.config.clientData).getCSPAppForCurrentNameSpace()

	// make sure always lower case so when cookie path is used, it picks up correct cookie
	set fullURL=$ZCVT(fullURL,"L")
	
	// SSL or not?
	if useSSL	{
		set fullURL="https://"_fullURL
	} else {
		set fullURL="http://"_fullURL
	}
	
	quit fullURL
]]></Implementation>
</Method>

<Method name="removeOpenedImage">
<Description>
removes the image that updates eventsforce to tell us that the email has been opened.
we are doing this because this is not the real mail openeing, it is just a preview or a mainatence thing
pass in mailDate in $H format</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID,tempStream:%Library.Stream,mailDate=""</FormalSpec>
<ReturnType>%Library.Stream</ReturnType>
<Implementation><![CDATA[
	set domain=$P(##class(shared.pageMethods).getFullPath(xEventID),"/",3)
	if mailDate="" set mailDate=+$H	
	
	if mailDate<62498 { // 11-Feb-2012
		// email sent before March 2012 did not have the 'ef_xtmo' class on the opening image so we have to remove all images from the preview - Fred Feb 2012
		set orgString="<img src='http"
		set newString="<img alt='http"
		do tempStream.CopyFrom(##class(shared.streamFunctions).replaceString(tempStream,orgString,newString))																			
	}
	
	// made the opened mail image more specific so that only the mail opened link gets replaced not other images on the page
	set orgString2="<img class=""ef_xtmo"" src='http"   
	set newString2="<img class=""ef_xtmo"" alt='http"   // don't load the image or we will loose the session
	do tempStream.CopyFrom(##class(shared.streamFunctions).replaceString(tempStream,orgString2,newString2))																			
	
	// also remove <HTML> and <BODY> tags from the email stream while we are at it
	for tag="<!DOCTYPE html>","<HTML>","</HTML>","<BODY>","</BODY>" {
		do tempStream.CopyFrom(##class(shared.streamFunctions).replaceString(tempStream,tag,""))																			
	}
	
	
	do tempStream.Rewind()
	quit tempStream
]]></Implementation>
</Method>

<Method name="cleanIntRedirect">
<Description>
clean the passed in URL to make sure only allow an internal redirection</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>url</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if '##class(setup.objSetting).getParameter("system","clean internal redirects") quit url

	set invalidURL=0
	
	set url=$TR(url,"\","/")
	
	// get rid of the http bit at the front
	set lowerURL=$ZCVT(url,"L")
	if $E(lowerURL,1,7)="http://"	{
		set url=$E(url,8,$L(url))
		set invalidURL=1
	} elseif $E(lowerURL,1,8)="https://"	{
		set url=$E(url,9,$L(url))
		set invalidURL=1
	} elseif $E(lowerURL,1,5)="data:"	{
		set url=$E(url,6,$L(url))
		set invalidURL=1
	} else {
		// nothing
	}
	
	// if url has a domain name at the front, reject it
	if url["/" {
		set firstBit=$P(url,"/",1)
	} else {
		set firstBit=url
	}
	
	set allowedExtensions("CSP")=1
	set allowedExtensions("HTM")=1
	set allowedExtensions("HTML")=1
	set allowedExtensions("PDF")=1
	set domA=$P(firstBit,".",1),domB=$ZCVT($P(firstBit,".",2),"U")
	if $L(domA),$L(domB) set invalidURL=1
	if $L(domA),$L(domB),$G(allowedExtensions(domB)) set invalidURL=0  // allow CSP pages and other types in redirects...
	
	set sharedPath="/"_$ZCVT(^%ZCSPAPPS($ZNSPACE),"L")
	set invalidURLPage=sharedPath_"/frontend/static/invalidURL.htm?sr=224"
	if invalidURL set url=invalidURLPage

	quit url
]]></Implementation>
</Method>

<Method name="getPageID">
<Description>
 method to be used to get pageID to make sure it's "clean"</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>fromRequest=1,setIntoSession=1</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set pageID=""
	if ..doesPageHaveAProwebPageID(%request.PageName) {
		if fromRequest set pageID=+%request.Get("pageID")
		if 'pageID set pageID=%session.Get("pageID") 
	}
	if 'pageID {
		set pageID = %request.Get("pageID")
	}
	quit pageID
]]></Implementation>
</Method>

<Method name="isPageIDValidForEvent">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[eventID,pageID,&redirectURL]]></FormalSpec>
<Implementation><![CDATA[
	set out=1,redirectURL=""
	set pageEventID=##class(sc.methods).getEventIDfromPageID(pageID)
	if pageEventID {
		if eventID'=pageEventID {
			set out=0
			set redirectURL=..getFullPath(eventID)_"/frontend/reg/homepage.csp?traceRedir=5&eventID="_pageEventID_"&pageID="_pageID
		}
	}
	quit out
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// retrieve parameters without caring about upper/lower case

]]></Content>
</UDLText>

<Method name="getParamCaseInsensitive">
<ClassMethod>1</ClassMethod>
<FormalSpec>parameter</FormalSpec>
<Implementation><![CDATA[
	set out=""
	set m=""
	for  {
		set m=$O(%request.Data(m))
		if m="" quit
		set array($ZCVT(m,"L"))=%request.Get(m)	
	}
	set out=$G(array($ZCVT(parameter,"L")))
	
	if (parameter="pageID")!(parameter="eventID") set out=+out  // have to make sure this is numeric otherwise vulnerable to cross site scripting attacks by changing the value in URL
	quit out
]]></Implementation>
</Method>

<Method name="recoverEventID">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set eventID=""

	// try for duplicate, case insensitive parameters
 	set m="",hit=0
 	for  {
 		set m=$O(%request.Data(m))
 		if m="" quit
 		for index=1:1:3 {
 			if $ZCVT(m,"U")="EVENTID" {
	 			set hit=hit+1
	 			set tmp=$G(%request.Data(m,index))
	 			if tmp {
		 			set eventID=tmp
	 			}
 			}
 		}
 	}
 	if hit>1 merge ^%xNoEv(1,$p($ZTS,",",2),$ZNSPACE,%request.GetCgiEnv("REMOTE_ADDR","no ip")," 00","recover eventID from duplicate param array")=%request.Data

	set eventID=+eventID   // have to make sure this is numeric otherwise vulnerable to cross site scripting attacks by changing the value in URL
	if 'eventID set eventID=""   // seems there are loads of places checking eventID=""
	quit eventID
]]></Implementation>
</Method>

<Method name="requestGetEventID">
<Description>
this method replaces intersystems %request.Get-method because that one doesn't handle duplicate parameters</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set eventID=""
	
	//try regular method first
	set eventID=+%request.Get("eventID")  //  have to make sure this is numeric (so plussed it) otherwise vulnerable to cross site scripting attacks by changing the value in URL
	if eventID quit eventID 
	
	// try recover it if it was passed infrom fHome.csp
	set eventID=$G(%session.Data("eventsforce","frontend","fHome passed in xEventID"))
	if eventID {
		set ^%xNoEv(1,$p($ZTS,",",2),$ZNSPACE,%request.GetCgiEnv("REMOTE_ADDR","no ip")," 00","recovered eventID from fHome via session")=eventID 
		quit eventID
	}
	
	// not try case insenstive serach including duplicated params
	set eventID=..recoverEventID()

	if 'eventID set eventID=""   // seems there are loads of places checking eventID=""
	quit eventID
]]></Implementation>
</Method>

<Method name="getSurveyID">
<Description>
Is the page we're in a survey page</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set surveyID=""
	if 'pageID {
		set pageID=..getPageID()
	}
	
	if pageID {
		set parent="",grandParent=""
		&SQL(SELECT parent,parent->parent INTO :parent,:grandParent FROM sc.objData WHERE ID = :pageID)
		if +SQLCODE=0 {
			&SQL(SELECT description INTO :tmp FROM sc_xModules.objGroup WHERE ID = :grandParent)
			if +SQLCODE=0,$ZCVT(tmp,"U")="SURVEYS" {
				set surveyID=parent
			}
			
		}
	}
	quit surveyID
]]></Implementation>
</Method>

<Method name="switchEvent">
<Description>
newEventID can be blank </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xPersonID,newEventID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	do ..clearDownBackendVariables()
	do ..setupBackendEventVariables(newEventID)
	if newEventID do ..addToLastEventSelected(xPersonID,newEventID)
	if newEventID do ..addToMRU(xPersonID,newEventID)
	do ..clearBackendMenuCache()
	quit
]]></Implementation>
</Method>

<Method name="addToLastEventSelected">
<ClassMethod>1</ClassMethod>
<FormalSpec>xPersonID,xEventID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	if ##class(setup.objEvent).%ExistsId(xEventID) {
		do ##class(cod.objItemData).set(xPersonID,"last event selected",xEventID)
	}
]]></Implementation>
</Method>

<Method name="addToMRU">
<ClassMethod>1</ClassMethod>
<FormalSpec>xPersonID,xEventID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	if ##class(setup.objEvent).%ExistsId(xEventID) {
		set maxLinks=##class(setup.objSetting).getParameter("homepage","Number of items on Most Recently Used Event list")
		set delim=","
		set MRUlist=##class(cod.objItemData).get(xPersonID,"Most Recently Used Events")
		set addEventToList=1
		for i=1:1:$L(MRUlist,delim) {
			set tmpEventID=$P(MRUlist,delim,i)
			set mru(i)=tmpEventID
			if xEventID=tmpEventID set addEventToList=0
		}
		if addEventToList set mru(i+1)=xEventID

		// new rebuild the string 
		set newMRUlist="",i=""
		for j=1:1:maxLinks {
			set i=$O(mru(i),-1) 
			if i="" quit
			set newMRUlist=mru(i)_$S($L(newMRUlist):delim,1:"")_newMRUlist
		}

		if newMRUlist'=MRUlist { 
			do ##class(cod.objItemData).set(xPersonID,"Most Recently Used Events",newMRUlist)
		}
	}
]]></Implementation>
</Method>

<Method name="clearDownBackendSession">
<Description>
clears the backend session from all session variables when logging out</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	kill %session.Data("eventsforce","backend")
	kill %session.Data("eventsforce","frontend")
	kill %session.Data("password validated")
	do ##class(shared.pageMethods).clearBackendMenuCache()
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// this can be called while still being logged in to the backend.

]]></Content>
</UDLText>

<Method name="clearDownBackendVariables">
<Description>
this is clearing all "backend" except the items listed here</Description>
<ClassMethod>1</ClassMethod>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	set keep("NAMESPACE")=1
	set keep("xClientDir")=1
	set keep("xClientStyleDir")=1
	set keep("xPersonID")=1
	set keep("xUserID")=1

	set keep("xLangID")=1
	set keep("xLanguage")=1
	set keep("xWorkLangID")=1  // need this for page switching to remember current language

	set keep("xDateFormat")=1
	set keep("xTimeFormat")=1
	
	set keep("xEventID")=1
	
	set keep("orgunit event caching")=1
	
	
	// Settings that only affect your current session
	set keep("proweb emergency repair mode")=1
	set keep("override test colours")=1
	set keep("showLegacyMode")=1
	
	set keep("GlobalSystemSettings")=1
	
	set var=""
	for  {
		set var=$O(%session.Data("eventsforce","backend",var))
		if var="" quit
		
		if '$D(keep(var)) kill %session.Data("eventsforce","backend",var)
	}
]]></Implementation>
</Method>

<Method name="setupBackendEventVariables">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
	set %session.Data("eventsforce","backend","xEventID")=xEventID
	set %session.Data("eventsforce","backend","xWorkLangID")=##class(setup.objEventSetting).getParameter("backend","default creation language",xEventID)
	if '$G(%session.Data("eventsforce","backend","xWorkLangID")) set %session.Data("eventsforce","backend","xWorkLangID")=1
]]></Implementation>
</Method>

<Method name="createBackendVariables">
<ClassMethod>1</ClassMethod>
<ProcedureBlock>0</ProcedureBlock>
<Implementation><![CDATA[
	if '$GET(xCreatedBackendVariables) {
		set xCreatedBackendVariables = 1

		set sessionID=%session.SessionId

		set xLangID=$G(%session.Data("eventsforce","backend","xLangID"))
		set xLanguage=$G(%session.Data("eventsforce","backend","xLanguage"))
		set xEventID=..getBackendEventIDFromSession()
		set xPersonID=$G(%session.Data("eventsforce","backend","xPersonID"))
		set xUserID=xPersonID
		set xEventDescription=$G(%session.Data("eventsforce","backend","xEventDescription"))

		set xControllerID=""
		if xEventID	{
			set xControllerID=##class(setup.objEvent).getControllerID(xEventID)
		}

		set xDateFormat=##class(setup.objSetting).getParameter("system","defaultDateFormat")
		set xDateFormat=##class(shared.dateFunctions).getBackendOutputDateFormat()
		if xDateFormat="" set xDateFormat=5 // dd/mmm/yyyy
		set xUserInputDateFormat=##class(shared.dateFunctions).getBackendInputDateFormat()
		set xFrontendInputDateFormat=""
		if xEventID {
			set xFrontendInputDateFormat=##class(setup.objEvent).getDateFormat(xEventID)
		}
		set %session.Data("eventsforce","backend","xDateFormat")=xDateFormat
		// using a new var for standard reports - this will get overridden by backendTopExcel so that CSV dates outputted are in an excel friendly form (format 25)  xDateReportFormat
		set xDateFormatForReports=xDateFormat

		set xTimeFormat=##class(shared.timeFunctions).getBackendOutputTimeFormat()
		if xEventID {
			set xFrontendTimeFormat=##class(setup.objEventSetting).getParameter("system","time format",xEventID)
		}
		set %session.Data("eventsforce","backend","xTimeFormat")=xTimeFormat
		
	}
]]></Implementation>
</Method>

<Method name="getWorkLangID">
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if $D(%request) set xWorkLangID=%request.Get("xWorkLangID")
	if xWorkLangID="",$D(%session) set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if xWorkLangID="" set xWorkLangID=##class(setup.objEventSetting).getParameter("backend","default creation language",eventID)
	if xWorkLangID="",$D(%session) set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if xWorkLangID="" set xWorkLangID=1

	if $D(%session) set %session.Data("eventsforce","backend","xWorkLangID")=xWorkLangID
	return xWorkLangID
]]></Implementation>
</Method>

<Method name="getBackendEventIDFromSession">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	return $G(%session.Data("eventsforce","backend","xEventID"))
]]></Implementation>
</Method>

<Method name="clearBackendMenuCache">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	kill ^CacheTempUserMenu(%session.SessionId)
]]></Implementation>
</Method>

<Method name="tempPurchaseHasValidBooker">
<Description>
This method checks if the Booker's Identification property is set correctly. This method will be used to nullify booking if the event is using 'email' or 'username' as the identification 
and somehow those values disappear from the current session just before the booking is saved in the database.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>eventID:%String,sessionID:%String</FormalSpec>
<Implementation><![CDATA[
	set ok=1
	set tempBookerID=##class(eCom.tempPerson).getBookerID(sessionID)
	if 'tempBookerID set ok=0
	
	// check if the booker's email address is populated correctly otherwise, report error.
	if ((ok) && ('##class(setup.objEventSetting).getParameter("system","do not use email",eventID))) {
	    set identifyBy = $S(##class(setup.objEventSetting).getParameter("system","identifying field",eventID)="username":"username",1:"email")
	    if '$L(##class(eCom.tempCodData).get(tempBookerID,identifyBy)) {
		    set ok=0
	    }
	}
	quit ok
]]></Implementation>
</Method>

<Method name="isEditMode">
<Description>
This method checks if the 'Edit' or 'Preview' flags are set for a proweb page. If so, it returns 1.
Browser dependent %request and %session objects are used here. So, it cannot be used anywhere other than CSP pages.</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set editMode = 0
	if %request.Get("hideButtons") set editMode=1
	if %session.Get("mode")="edit",'$G(%session.Data("inSitePageEditing")) set editMode=1
	quit editMode
]]></Implementation>
</Method>

<Method name="getEditMode">
<Description>
This returns the mode of the page E.g. Edit, Preview
Checks the request and the session so that it can be used in the page before the mode is set in the session
Browser dependent %request and %session objects are used here. So, it cannot be used anywhere other than CSP pages.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	
	set mode=%request.Get("mode")
	if '$l(mode) {
		set mode=%session.Get("mode")
	}
	
	quit mode
]]></Implementation>
</Method>

<Method name="addRequestDataForCurrentPageToURL">
<ClassMethod>1</ClassMethod>
<FormalSpec>inURL:%String</FormalSpec>
<Implementation><![CDATA[
	#dim returnURL As %String = inURL
	
	// Stop new gateway param:
	//   The CSPRQN parameter is the CSP Gateway Request ID, which is sent to Cach with each HTTP request. 
	//   Where available, the request ID is always recorded in the Gateway Event Log header records as a hexadecimal number (e.g. Request-ID: 3a).
	set exclude("CSPRQN")=""
	
	// should probably create a list of allowed parameters at some point
	set paramName=""
	for  {
		set paramName=$o(%request.Data(paramName))
		if paramName="" quit
		
 		set addParam=1
 		if returnURL[(paramName_"=") set addParam=0  // stop duplicates
 		if $D(exclude(paramName)) set addParam=0

		if addParam {
	 		set value=%request.Get(paramName)
	 		set returnURL=##class(EF.htmlGenerator).addParameterToURL(returnURL,paramName,value)
		}
	}
	
	return returnURL
]]></Implementation>
</Method>

<Method name="requestDataToParams">
<Description>
go through %request.Data and create a string to add to URLs
Deprecated as does not encode parameters - use addRequestDataForCurrentPageToURL instead</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>exclusionList=""</FormalSpec>
<Implementation><![CDATA[
	if '$D(%request) quit ""
	
	// convert exclusion list into array
	for i=1:1:$L(exclusionList,",") {
		set tmpM=$P(exclusionList,",",i)
		if $L(tmpM) set exclude(tmpM)=""
	}

	// should probably create a list of allowed parameters at some point
	set params="",m=""
	for  {
		set m=$o(%request.Data(m))
		if m="" quit
		
 		set addparam=1
 		if params[m_"=" set addparam=0  // stop duplicates
 		if $D(exclude(m)) set addparam=0
 		// Stop new gateway param:
 		//   The CSPRQN parameter is the CSP Gateway Request ID, which is sent to Cach with each HTTP request. 
 		//   Where available, the request ID is always recorded in the Gateway Event Log header records as a hexadecimal number (e.g. Request-ID: 3a).
 		if m="CSPRQN" set addparam=0  

		if addparam {
	 		//implement later: set tmpData=##class(%CSP.Page).EscapeURL(%request.Get(m))
	 		set tmpData=%request.Get(m)
			set params=params_$S($L(params):"&",1:"")_m_"="_tmpData
		}
	}
	
	// returns string without leading & or ? - calling program to add as appropriate
	quit params
]]></Implementation>
</Method>

<Method name="isRequestSecure">
<Description>
method for determining if the incoming request is secure or not </Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set out=0
	
	// in cases where the certificate is terminated on the actual web server
	if %request.Secure=1 set out=1				

	// in cases where the certificate is terminated on the load balancer
	if %request.GetCgiEnv("SERVER_PORT")=8443 set out=1
	
	quit out
]]></Implementation>
</Method>

<Method name="addParamsToURL">
<Description>
Pass in a valid inURL and it will append a parameter string to it
*** Deprecated as it does not encode the parameter, should instead use ##class(EF.htmlGenerator).addParameterToURL(inURL, name, value) ***</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>inURL,params</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	// Remove leading  ? or &
	if ($e(params,1)="?")!($e(params,1)="&") {
		set params=$e(params,2,$l(params))
	}
	if $l(params) {
		if inURL["?" {
			set outURL=inURL_"&"_params
		} else {
			set outURL=inURL_"?"_params
		}
	} else {
		set outURL=inURL
	}
	quit outURL
]]></Implementation>
</Method>

<Method name="buildFrontendSessionVariablesFromEventID">
<ClassMethod>1</ClassMethod>
<FormalSpec>xEventID</FormalSpec>
<Implementation><![CDATA[
	set %session.Data("eventsforce","frontend","xEventID")=xEventID
	set %session.Data("eventsforce","frontend","xClientDir")=##class(setup.objSetting).getParameter("paths","clientDirectory")
	set language=##class(setup.objEventSetting).getParameter("system","language",xEventID)   // v1.1.5
	set %session.Data("eventsforce","frontend","xLanguage")=language
	set %session.Data("eventsforce","frontend","xLangID")=##class(shared.objLanguage).getLanguageID(language)
	set xLangID=%session.Data("eventsforce","frontend","xLangID")
	set %session.Data("eventsforce","frontend","xDateFormat")=##class(setup.objEvent).getDateFormat(xEventID)
]]></Implementation>
</Method>

<Method name="getDisplayDescription">
<Description>
get displayable descriptions for certain words</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>inStr:%String</FormalSpec>
<Implementation><![CDATA[
	Set ret=inStr
	
	If (inStr="bookers") {
		Set ret=##class(shared.pCSP).out("Registration contacts")
	} elseif (inStr="delegates") {
		Set ret=##class(shared.pCSP).out("Attendees")
	} elseif (inStr="cancelled delegates") {
		Set ret=##class(shared.pCSP).out("Cancelled attendees")
	} elseif (inStr="BookingRef") {
		Set ret=##class(shared.pCSP).out("Registration ref")
	} elseif (inStr="BookerName") {
		Set ret=##class(shared.pCSP).out("Registration contact's name")
	} elseif (inStr="BookingType") {
		Set ret=##class(shared.pCSP).out("Registration type")
	} elseif (inStr="AdditionalBookingStatus") {
		Set ret=##class(shared.pCSP).out("Additional registration status")
	}
	
	Quit ret
]]></Implementation>
</Method>

<Method name="doesBackendPageRequireEventID">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	if (pagename["login") return 0
	if (pagename["tc.csp") return 0
	if (pagename["tc2.csp") return 0
	if (pagename["eventselection") return 0
	if (pagename["pagecontrollergrid") return 0
	if (pagename["eventcalendarmonthly.csp") return 0
	if (pagename["eventproperties") return 0
	if (pagename["eventcopy") return 0
	if (pagename["logout.csp") return 0
	if (pagename["mydetails.csp") return 0
	if (pagename["changepassword.csp") return 0
	if (pagename["changepasswordmodal.csp") return 0
	if (pagename["pagecontrollerstandardsave.csp") return 0
	if (pagename["pagecontrollerajaxsave.csp") return 0
	if (pagename["addusermetrics.csp") return 0
	if (pagename["passwordreset") return 0
	if (pagename["backendmenuredirect.csp") return 0
	if (pagename["serverstoragesetjson.csp") return 0
	
	return 1
]]></Implementation>
</Method>

<Method name="isPageEventRelated">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set pagename=$ZCVT(pagename,"L")
	if pagename="sessiondump.csp" return 0
	if pagename="sysgettotallogins.csp" return 0
	if pagename="homepage.csp" return 0
	if pagename="initsession.csp" return 0
	if pagename="fhome.csp"	return 0
	return 1
]]></Implementation>
</Method>

<Method name="endSession">
<Description><![CDATA[
Ends current session and clears down cookies
<br/>Should still have %session available in page
<br/>Must be called from preHTTP]]></Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	Set %session.EndSession=1
 	Set Expires=+$H-1
 	Set Expires=$ZD(Expires,11) _ ", " _ $ZD(Expires,2) _ " 00:00:00 GMT"
 	do %response.SetCookie("CSPSESSIONID-SP-8443-UP-","",Expires,"/",,1,1)
]]></Implementation>
</Method>

<Method name="isApplicationStopped">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// stop application access while upgrading - will unfortunately output the ugly http header underneath the message.
	if $G(^%ZStopApplication($ZNSPACE)) {
		write "<b>Site unavailable, please come back later</b><br><br><br><br>Check in ^%ZStopApplication<br><br>"
		return 1
	}
	return 0
]]></Implementation>
</Method>

<Method name="isIncludePage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// quit the whole method if were are a measly include page of little importance
	if $L(%request.Get("CSPInclude")) {
		set pages="frontendHTTPheader.csp,frontendStyles.csp,frontendJS.csp,colourScheme.csp,progress.csp,frontEndButton.csp,commonHTTPheader.csp,socialMediaButtons.csp,frontendBottom.csp,"
		if $ZCVT(pages,"U")[$ZCVT($P(%request.Get("CSPInclude"),"/",$L(%request.Get("CSPInclude"))),"U") return 1
	}	
	return 0
]]></Implementation>
</Method>

<Method name="updateLoadMonitor">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	// update the current load monitor
	set currentMinute=($P($ZT($P($H,",",2),2),":",2)+1) // 10:23 -> 24 and 13:00 -> 1
	kill ^["EVCOMMON"]qLoadMonitor($S(currentMinute=60:1,1:currentMinute+1)) // kill the next minute
 	if $ZCVT("start.csp","U")'[$ZCVT(%request.PageName,"U") {
		set ^["EVCOMMON"]qLoadMonitor(currentMinute)=$G(^["EVCOMMON"]qLoadMonitor(currentMinute))+1
	}
]]></Implementation>
</Method>

<Method name="manageSEOrequest">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set fromSEO=0
	if ##class(setup.seoFiles).isSEOrequest()	{
		set fromSEO=1  // has this request originated from the mini virtual website (SEO mode)?
		do ##class(setup.seoFiles).addSEOcodePre()
	}
	if 'fromSEO do %response.SetHeader("X-Robots-Tag","noindex")   // to stop Google from showing the page link even if it finds it as a link from another site
]]></Implementation>
</Method>

<Method name="injectP3Ppolicy">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	// fix the problem with IE and privacy when in IFRAMES/FRAMESETS - but needs to be done on all resources that are setting cookies (css/js etc.) so done in IIS instead.
	if ##class(setup.objSetting).getParameter("system","Inject P3P policy") {
		do %response.SetHeader("P3P","CP=""Internet Explorer requires this in order to set session cookies""")
	}
]]></Implementation>
</Method>

<Method name="sanitiseRequestData">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set name=""
	for  {
 		set name=$O(%request.Data(name))
 		if name="" quit
 		if $E(name,1,6)="Error:" continue  // errors contain control chars...
 		set value=%request.Get(name)
 		if '$IsObject(value) {
			set %request.Data(name,1) = ##class(EF.sanitiser).sanitise(value)
 		}
	}
]]></Implementation>
</Method>

<Method name="isCrossSiteScripting">
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// check for cross scripting
 	set sharedPageM="",crossScriptingAttack=0
 	set sharedPageAllowedVars("CSPToken")=""
 	set sharedPageAllowedVars("CSPPAGE")=""
 	set sharedPageAllowedVars("Error:ErrorCode")=""
	// backend
 	set sharedPageAllowedVars("editBox")=""
 	set sharedPageAllowedVars("rawText")=""
 	set sharedPageAllowedVars("txtPrompt")=""
 	set sharedPageAllowedVars("textHTML")=""
 	set sharedPageAllowedVars("requiredAnswer")="" // contains pattern matches that are sensitive
 	set sharedPageAllowedVars("txtEmailDetailsPageRawSubject")="" 

	// exclude the style edit boxes and URL field for the menu blocks (proweb\menudetails.csp)
 	set sharedPageAllowedVars("txtULStyle")=""
  	set sharedPageAllowedVars("txtLIStyle")=""
 	set sharedPageAllowedVars("txtLISelectedStyle")=""
 	set sharedPageAllowedVars("txtAStyle")=""
 	set sharedPageAllowedVars("txtAHoverStyle")=""
 	set sharedPageAllowedVars("txtASelectedStyle")=""
 	set sharedPageAllowedVars("txtMILIStyle")=""
 	set sharedPageAllowedVars("txtMILISelectedStyle")=""
 	set sharedPageAllowedVars("txtMIAStyle")=""
 	set sharedPageAllowedVars("txtMIAHoverStyle")=""
 	set sharedPageAllowedVars("txtMIASelectedStyle")=""
 	set sharedPageAllowedVars("txtMILinkURL")=""
	set sharedPageAllowedVars("txtUserMessageBodyBE")=""
 	set sharedPageAllowedVars("moxieElement*")=""
 	set sharedPageAllowedVars("hiddenmoxieElement*")=""
 	
 	set allowedHTMLTagsVar("abstractTitle")=""
 	set allowedHTMLTagsVar("txtMailFrom")=""
 	
 	set stopExtraScripting=1
 	
 	set pagesAllowedToSubmitHTML("pagecontrollerstandardsave.csp")=""
 	set pagesAllowedToSubmitHTML("pagecontrollerajaxsave.csp")=""
 	set pagesAllowedToSubmitHTML("serverstoragesetjson.csp")=""

 	set currentPageName=$ZCVT(%request.PageName,"L")
	set pageName=""
	for	 {
		set pageName=$O(pagesAllowedToSubmitHTML(pageName))
		if pageName="" quit
		
		if $ZCVT(pageName,"U")=$ZCVT(currentPageName,"U") {
	 		set stopExtraScripting=0	
		}
 	}
 	
 	
 	for  {
 		set sharedPageM=$O(%request.Data(sharedPageM))
 		if sharedPageM="" quit
 		
 		set isExcluded=0
 		if $D(sharedPageAllowedVars(sharedPageM)) set isExcluded=1
 		if $D(sharedPageAllowedVars($P(sharedPageM,"_",1)_"*")) set isExcluded=1 // note that the field name must contain underscore for wildcards to work

 		if isExcluded=0 {
	 		// it seems that %3c gets converted to < when stored in %request but I'll leave the one above in case
	 		if $ZCVT(%request.Get(sharedPageM),"L")["%3cscript" set crossScriptingAttack=1
	 		if $ZCVT(%request.Get(sharedPageM),"L")["<script" set crossScriptingAttack=1
	 		if $ZCVT(%request.Get(sharedPageM),"L")["javascript:",%request.Get(sharedPageM)'="badgePrint()" set crossScriptingAttack=1

			if stopExtraScripting {
				// more restrictions
		 		if $ZCVT(%request.Get(sharedPageM),"L")["%3cimg" set crossScriptingAttack=1
		 		if $ZCVT(%request.Get(sharedPageM),"L")["<img" set crossScriptingAttack=1
		 		if $ZCVT(%request.Get(sharedPageM),"L")["onerror" set crossScriptingAttack=1
				// remove CRLF from var names (can't do the values as we may get posting of text areas with CRLFs
				if sharedPageM[$C(13) set crossScriptingAttack=1
				if sharedPageM[$C(10) set crossScriptingAttack=1
		
				// do a catch all for HTML code submitted in any var
				// don't stop it, just change it so that the value stored is not a real HTML character but should be displayed OK as a lt sign
				// allow the email from fields in preregister.csp as now can add names too: "Jeremy Ward" <jeremy@eventsforce.com>
				if (('$D(allowedHTMLTagsVar(sharedPageM)))
					&& (%request.Get(sharedPageM)["<")
					&& (sharedPageM'["txtEmailFrom")
					&& (sharedPageM'["txtFromAddress")
					) {
					set tmpVar=%request.Get(sharedPageM)
					set tmpVar=##class(shared.stringFunctions).hyperTranslate(tmpVar,"<","&lt;")
					set %request.Data(sharedPageM,1)=tmpVar
				}
				if (('$D(allowedHTMLTagsVar(sharedPageM)))
					&& (%request.Get(sharedPageM)[">")
					&& (sharedPageM'["txtEmailFrom")
					&& (sharedPageM'["txtFromAddress")
					) {
					set tmpVar=%request.Get(sharedPageM)
					set tmpVar=##class(shared.stringFunctions).hyperTranslate(tmpVar,">","&gt;")
					set %request.Data(sharedPageM,1)=tmpVar
				}
				if (('$D(allowedHTMLTagsVar(sharedPageM)))
					&& (%request.Get(sharedPageM)[$C(34))
					&& (sharedPageM'["txtEmailFrom")
					&& (sharedPageM'["txtFromAddress")
					) {
					set tmpVar=%request.Get(sharedPageM)
					set tmpVar=##class(shared.stringFunctions).hyperTranslate(tmpVar,$C(34),"&quot;")
					set %request.Data(sharedPageM,1)=tmpVar
				}
			}
			
			if %request.Method="GET" {		
				if %request.Get(sharedPageM)[$C(13) set crossScriptingAttack=1
				if %request.Get(sharedPageM)[$C(10) set crossScriptingAttack=1
			}
 		}
 		
		// exit now if cross scripting found, then store the sharedPageM var found for future reference
 		if crossScriptingAttack quit
 	}
	if crossScriptingAttack	{
		// Store this for now - in case we have issues with some fields not covered by above. 
		// Longer term we should remove this to avoid storage issues if massive requests by a hacker.
		set tmpKey=$I(^%ZCrossScripting($ZNSPACE,+$ZTS))
		set ^%ZCrossScripting($ZNSPACE,+$ZTS,tmpKey,"name")=sharedPageM
		if $L(sharedPageM) set ^%ZCrossScripting($ZNSPACE,+$ZTS,tmpKey,"value")=%request.Get(sharedPageM)
		set cspAppName=$ZCVT(^%ZCSPAPPS($ZNSPACE),"L")
		return 1
	} else {
		return 0	
	}
]]></Implementation>
</Method>

<Method name="hasStringBeenSanitisedForCrossSiteScripting">
<ClassMethod>1</ClassMethod>
<FormalSpec>inString</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set out=0
	if inString["&lt;" set out=1
	if inString["&gt;" set out=1
	if inString["&quot;" set out=1

	quit out
]]></Implementation>
</Method>

<Method name="getURLforMaintenancePage">
<ClassMethod>1</ClassMethod>
<FormalSpec>cspAppName</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "/"_cspAppName_"/system/maintenancePage.htm"
]]></Implementation>
</Method>

<Method name="getRedirectURLforXSS">
<ClassMethod>1</ClassMethod>
<FormalSpec>cspAppName</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return "/"_cspAppName_"/frontend/static/invalidURL.htm?reason=csa"
]]></Implementation>
</Method>

<Method name="updatePageHistory">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	//  store page history
	set hdate=+$ZTS,htime=$P($ZTS,",",2)  
	set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)))=%session.AppTimeout_"|"_%request.URL_"|"_%request.PageName_"|"_%request.Get("CSPInclude")_"|SSL:"_..isRequestSecure()
]]></Implementation>
</Method>

<Method name="isNewFrontendSession">
<ClassMethod>1</ClassMethod>
<FormalSpec>frontback,URL,pagename</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set allowREDIRmethod=1
	if $G(^%xPAGESTOPREDIRMETHOD)=1 set allowREDIRmethod=0
	
	// need to get new session set up if we do not have it and redirect to homepage.csp (for example if you go straight to dailyAgenda.csp)
	if frontback="frontend" {
		if allowREDIRmethod {
			if (URL'["/xt/") {
				if $G(%session.Data("eventsforce","frontend","xEventID"))="" {
					if ..requestGetEventID() {
						if '$G(%session.Data("proweb","isSurvey")) { // need to ignore if survey page, since survey pages are not tied to events
							if ..isPageEventRelated(pagename) {
								return 1	 
							}
						}
					}
				}
			}
		}
	}
	return 0
]]></Implementation>
</Method>

<Method name="getRedirectURLforNewSession">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set pagename=$ZCVT(pagename,"L")
	set tmpEID=..requestGetEventID()
	set redirpage=..getFullPath(tmpEID)_"/frontend/reg/homepage.csp?traceRedir=2&eventID="_tmpEID
	
	// special treatment for these pages so that when in SEO mode, clicking on a link to them will redirect via homepage (as there will be no session set up initially)
	// don't want to do for all pages to avoid people bookmarking pages within the registration process etc.
	if (pagename="registernew.csp")!(pagename="registeramend.csp")!(pagename="dailyagenda.csp")!(pagename="dailyagendaalt.csp")	{
		set redirpage=redirpage_"&page="_pagename
	} elseif (pagename="tregisteremailnew.csp") {
		set redirpage=redirpage_"&page=registerNew.csp"
	} elseif (pagename="tregisteremailamend.csp") {
		set redirpage=redirpage_"&page=registerAmend.csp"
	} elseif (pagename="tdailyagenda.csp") {
		set redirpage=redirpage_"&page=dailyAgenda.csp"
	} elseif (pagename="tdailyagendaalt.csp") {
		set redirpage=redirpage_"&page=dailyAgendaalt.csp"
	} elseif (pagename="home")!(pagename="thome.csp")!(pagename="homepage.csp") {
		// use default redirpage
	} elseif %request.Get("pageID") {
		set redirpage=redirpage_"&pageID="_%request.Get("pageID")
	}
	if %request.Get("language") set redirpage=redirpage_"&language="_%request.Get("language")

	// log this
	set hdate=+$ZTS,htime=$P($ZTS,",",2) 
	set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)),"redirmethod")=redirpage

	return redirpage
]]></Implementation>
</Method>

<Method name="hasSwitchedLanguage">
<ClassMethod>1</ClassMethod>
<FormalSpec>frontback,URL,pagename</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set allowLANGmethod=1
	if $G(^%xPAGESTOPLANGMETHOD)=1 set allowLANGmethod=0

	// check the language - if a different language is passed as parameter then redirect to homepage
	if frontback="frontend" {
		if allowLANGmethod {
			if (URL'["/xt/"),%request.Get("language"),pagename'="homepage.csp",pagename'="fhome.csp"	{
				// if current lang is not what is on URL, redirect to home to switch it
				if %request.Get("language")'=$G(%session.Data("eventsforce","frontend","xPrefLangID"))	{
					return 1
				}
			}
		}
	}
	return 0
]]></Implementation>
</Method>

<Method name="getRedirectURLforNewLanguage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set ip=%request.GetCgiEnv("REMOTE_ADDR","no ip")
	set tmpEventID=..requestGetEventID() 
	if 'tmpEventID set tmpEventID=$G(%session.Data("eventsforce","frontend","xEventID"))
	if 'tmpEventID,%request.Get("pageID") {
		set tmpEventID=##class(sc.methods).getEventIDfromPageID(%request.Get("pageID")) 
		set ^%xNoEv(1,$p($ZTS,",",2),$ZNSPACE,ip,-16,"recover eventID from pageID")=tmpEventID
	}

	set redirpage=..getFullPath(tmpEventID)_"/frontend/reg/homepage.csp?traceRedir=3&eventID="_tmpEventID

	// special treatment for these pages so that when in SEO mode, clicking on a link to them will redirect via homepage (as there will be no session set up initially)
	// don't want to do for all pages to avoid people bookmarking pages within the registration process etc.
	if (pagename="registernew.csp")!(pagename="registeramend.csp")!(pagename="dailyagenda.csp")!(pagename="dailyagendaalt.csp")	{
		set redirpage=redirpage_"&page="_pagename
	}

	// log this
	set hdate=+$ZTS,htime=$P($ZTS,",",2) 
	set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)),"langmethod")=redirpage
	
	return redirpage
]]></Implementation>
</Method>

<Method name="isBackendPageAuthorised">
<ClassMethod>1</ClassMethod>
<FormalSpec>frontback,pagename</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	// check if authorised to view the page (backend stuff)
	set allowAUTHmethod=1
	if $G(^%xPAGESTOPAUTHMETHOD)=1 set allowAUTHmethod=0
	
	set xPersonID=$G(%session.Data("eventsforce","backend","xPersonID"))
	set auth=1
	if frontback="backend" {
		if allowAUTHmethod {
			if pagename="userlist.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSUSER") set auth=0
			if pagename="userdetails.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSUSER") set auth=0
			if pagename="userdetails2.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSUSER") set auth=0
			if pagename="userrolelist.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSROLE") set auth=0
			if pagename="userroledetails.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSROLE") set auth=0
			if pagename="userroledetails2.csp",'##class(access.objFunction).hasFunctionByAccessID(xPersonID,"SYSROLE") set auth=0
		}	
	}
	return auth
]]></Implementation>
</Method>

<Method name="isPageIDAllowedForBackendSession">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID,pageName</FormalSpec>
<Implementation><![CDATA[
	set pageName=$ZCVT(pageName,"L")
	if (..frontBack2()'="frontend")&&(pageName'="codquestiondetails.csp")&&(pageName'="codquestiondetails2.csp") {
		return 1	
	}
	if '##class(cod.methods).getCurrentBackendUser() {
		throw ##class(shared.exceptions.generalException).%New("No backend person ID for isPageIDAllowedForBackendSession")
	}
	if ##class(sc.pageMethods).isPageInFrontendRuntimeMode() {
		return 1	
	}
	if ##class(sc.xModules.objPage).%ExistsId(pageID) {
		set eventIDForPage=##class(sc.methods).getEventIDfromPageID(pageID)
		if 'eventIDForPage {
			return 1	
		}
		if eventIDForPage=..getBackendEventIDFromSession() {
			return 1
		}
	}
	return 0
]]></Implementation>
</Method>

<Method name="getRedirectURLforUnauthorisedBackendPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set xPersonID=$G(%session.Data("eventsforce","backend","xPersonID"))
	// redirect to simple unauthorised page if not allowed
	// log this
	set hdate=+$ZTS,htime=$P($ZTS,",",2)
	set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)),"authmethod")=xPersonID_"|"_pagename
	
	return "../../backend/home/unauth.csp"
]]></Implementation>
</Method>

<Method name="getRedirectURLforUnauthorisedProwebPage">
<ClassMethod>1</ClassMethod>
<FormalSpec>pagename,pageID</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set xPersonID=$G(%session.Data("eventsforce","backend","xPersonID"))

	// redirect to simple unauthorised page if not allowed
	// log this
	set hdate=+$ZTS,htime=$P($ZTS,",",2)
	set ^xPage(hdate,%session.SessionId,htime,$I(^xPage(hdate,%session.SessionId,htime)),"authmethodpageid")=xPersonID_"|"_pagename_"|"_pageID
	
	return "../../frontend/static/invalidURL.htm"
]]></Implementation>
</Method>

<Method name="updateDebugInfo">
<ClassMethod>1</ClassMethod>
<FormalSpec>URL,pagename</FormalSpec>
<Implementation><![CDATA[
	// store a page history to aid debugging
	if $G(^xDEBUG) set ^xDEBUGPAGES($I(^xDEBUGPAGES),$ZTS,URL)=$G(%session.Data("eventsforce","frontend","xEventID"))
	if $G(^xDEBUG) set ^xDEBUGPAGES($I(^xDEBUGPAGES),$ZTS,"pagename")=pagename
]]></Implementation>
</Method>

<Method name="setHTTPHeaderForJSON">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	Set %response.ContentType="application/json"
	Set %response.CharSet="utf-8" //Required by cache, even though to the json standard specifies that CharSet should not be output in the header.
]]></Implementation>
</Method>

<Method name="getBackendWorkLangID">
<Description>
sets up the session variables based on the xWorkLangID. If that is not found, we fall back to xLangID which is the passed in default language. </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xLangID</FormalSpec>
<Implementation><![CDATA[
	set xWorkLangID=%request.Get("xWorkLangID")
	if xWorkLangID="" set xWorkLangID=$G(%session.Data("eventsforce","backend","xWorkLangID"))
	if xWorkLangID="" set xWorkLangID=xLangID
	set %session.Data("eventsforce","backend","xWorkLangID")=xWorkLangID	
	quit xWorkLangID
]]></Implementation>
</Method>

<Method name="getPageLanguageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<Implementation><![CDATA[
	set languageID=1
	&SQL(select description INTO :pageDescription FROM sc_xmodules.objpage WHERE id=:pageID)
	if +SQLCODE=0 {
		set languageName=$P(pageDescription," - ",2) // remove the language name	
		if $L(languageName) set languageID=##class(shared.objLanguage).getLanguageID(languageName)
	} else {
		throw ##class(shared.exceptions.generalSQLException).CreateFromSQLCODE(SQLCODE,$GET(%msg))	
	}
	quit languageID
]]></Implementation>
</Method>

<Method name="getURLForRedirectedApp">
<ClassMethod>1</ClassMethod>
<FormalSpec>url</FormalSpec>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
	set eventID=..requestGetEventID()
	set path=$P(url,"/",3,$l(url,"/"))
	set extraParams=##class(shared.pageMethods).requestDataToParams("CSPToken,CSPCHD")
	set url=..getFullPath(eventID)_"/"_path
	if $l(extraParams) {
		set url=url_"?"_extraParams
	}
	return url
]]></Implementation>
</Method>

<Method name="getCurrentRelativeURLFromRequest">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	return %request.PageName_"?"_##class(shared.pageMethods).requestDataToParams("CSPPAGE,CSPToken,CSPCHD")
]]></Implementation>
</Method>

<Method name="setPageIDIntoSession">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageID</FormalSpec>
<Implementation><![CDATA[	set %session.Data("pageID")=pageID
]]></Implementation>
</Method>

<Method name="doesPageHaveAProwebPageID">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageName</FormalSpec>
<Implementation><![CDATA[
	set pageName=$ZCVT(pageName,"L")
	if pageName="start.csp" {
		return 1
	} elseif ##class(sc.objTemplate).isPageNameProwebTemplate(pageName) {
		return 1
	}
	return 0
]]></Implementation>
</Method>

<Method name="getFrontendLanguageID">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	return $G(%session.Data("eventsforce","frontend","xPrefLangID"))
]]></Implementation>
</Method>

<Method name="getPathWithoutApplicationFromURL">
<Description>
E.g https://dev.efsys.net/largedevsrc/backend/dashboard/dashboard.csp returns backend/dashboard/dashboard.csp</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>url</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	return $p(url,"/",3,99)
]]></Implementation>
</Method>

<Method name="getBackendKendoBaseURL">
<ClassMethod>1</ClassMethod>
<FormalSpec>pageGeneration</FormalSpec>
<Implementation><![CDATA[
	if pageGeneration<4 {
		return "https://da7xgjtj801h2.cloudfront.net/2013.2.716/"
		
	} else {
		return "https://da7xgjtj801h2.cloudfront.net/2015.2.624/"	
	}
]]></Implementation>
</Method>
</Class>
</Export>
